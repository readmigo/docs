# 用户年度阅读报告功能设计

> 状态：已规划 | 创建日期：2024-12-24 | 版本：v1.0

## 概述

实现一个用户年度阅读报告功能，聚合用户全年阅读数据，生成个性化的年度盘点报告，支持分享。

## 功能模块

### 1. 阅读总览
- 今年阅读的书籍数量和列表
- 总阅读时长、总页数
- 完读率（已完成/已开始）

### 2. 高光时刻
- 阅读时间最长的一天
- 深夜阅读最晚的一天（22:00-05:00）
- 划线/笔记最多的一天
- 城邦评论最多的一天
- 城邦发帖最多的一天
- 客服反馈最多的一天
- 首次付费订阅的一天

### 3. 社交对比
- 阅读时长超过 X% 的用户
- 读书量超过 X% 的用户
- 词汇量超过 X% 的用户

### 4. 行为偏好
- 阅读时段偏好（早起型/夜猫子型/灵活型）
- 阅读类型偏好（最常读的书籍分类）
- AI 使用偏好（最常用的 AI 功能）
- 平均阅读时长
- 偏好阅读日期（周末/工作日）

### 5. 个性化输出
- 个性化称号/徽章
- AI 生成的年度总结文案
- 可分享的报告卡片

---

## 数据库设计

### 新增表

#### 1. AnnualReport（年度报告主表）


#### 2. UserRankingSnapshot（排名快照）


#### 3. UserHighlight（划线/笔记）


#### 4. ShareLog（分享日志）


#### 5. AnnualReportShare（年度报告分享页面）


---

## API 设计

### 端点列表

| 方法 | 路径 | 说明 | 认证 |
|-----|------|-----|------|
| GET | `/api/v1/annual-report/:year` | 获取年度报告（无则触发生成） | 需要 |
| GET | `/api/v1/annual-report/:year/status` | 查询生成状态 | 需要 |
| GET | `/api/v1/annual-report/history` | 获取历史年份列表 | 需要 |
| POST | `/api/v1/annual-report/:year/regenerate` | 触发重新生成 | 需要 |
| POST | `/api/v1/annual-report/:year/share-page` | 生成分享页面 | 需要 |
| POST | `/api/v1/annual-report/:year/share` | 记录分享行为 | 需要 |
| GET | `/share/annual-report/:shareId` | 公开分享页面 | 不需要 |

### 响应结构


---

## 缓存策略


---

## iOS 客户端架构

### 目录结构


### 入口设计（Me 页面）


### 交互设计

- TabView 横向滑动切换页面（7页）
- 页面指示器显示当前位置
- 分享按钮生成 Web 分享页面 URL
- 使用 iOS 原生 ShareLink/UIActivityViewController 分享链接
- 支持年份选择器查看历史报告

---

## Web 分享页面

### 技术方案

- 前端：React 单页面（apps/admin 或独立项目）
- 路由：`/share/annual-report/:shareId`
- 数据：从 `AnnualReportShare.snapshotData` 读取
- 部署：与主站同域，便于 SEO

### 特性

- 无需登录即可访问
- 移动端优先设计
- 支持 OG 标签（Open Graph）用于社交媒体预览
- 访问量统计
- 可选过期时间

### OG 标签示例


---

## 实现步骤

### Phase 1: 基础设施

| 任务 | 优先级 | 状态 |
|-----|-------|------|
| 数据库迁移：新增 AnnualReport、UserRankingSnapshot 表 | P0 | 待开发 |
| 后端：创建 annual-report module | P0 | 待开发 |
| 后端：实现基础 API 端点 | P0 | 待开发 |
| 后端：实现数据聚合服务 | P0 | 待开发 |
| Redis 缓存策略 | P1 | 待开发 |

### Phase 2: 核心功能

| 任务 | 优先级 | 状态 |
|-----|-------|------|
| 阅读总览计算 | P0 | 待开发 |
| 高光时刻计算 | P0 | 待开发 |
| 社交排名计算（百分位） | P0 | 待开发 |
| 行为偏好分析 | P1 | 待开发 |
| 个性化标签生成 | P1 | 待开发 |
| Bull Queue 异步生成 | P1 | 待开发 |

### Phase 3: iOS 客户端

| 任务 | 优先级 | 状态 |
|-----|-------|------|
| 数据模型 + Manager | P0 | 待开发 |
| 主视图框架 + 页面导航 | P0 | 待开发 |
| 封面页 + 阅读总览页 | P0 | 待开发 |
| 高光时刻页 | P1 | 待开发 |
| 社交排名页 | P1 | 待开发 |
| 行为偏好页 | P1 | 待开发 |
| 个性化总结页 | P1 | 待开发 |
| Me 页面入口卡片 | P0 | 待开发 |
| 历史年份选择器 | P1 | 待开发 |

### Phase 4: Web 分享页面

| 任务 | 优先级 | 状态 |
|-----|-------|------|
| Web 分享页面路由 + 组件 | P1 | 待开发 |
| OG 标签（社交预览卡片） | P1 | 待开发 |
| 移动端适配 | P1 | 待开发 |
| 访问统计 | P2 | 待开发 |

### Phase 5: 增强功能

| 任务 | 优先级 | 状态 |
|-----|-------|------|
| 新增 UserHighlight 表 | P2 | 待开发 |
| 新增 ShareLog 表 | P2 | 待开发 |
| 国际化支持 | P2 | 待开发 |
| 报告预生成定时任务（12月20日开始） | P3 | 待开发 |

---

## 技术决策说明

### 1. JSONB 存储报告数据

**选择原因**：
- 报告结构可能随版本迭代变化，JSONB 允许向后兼容
- 单次查询获取完整报告，避免多表 JOIN
- PostgreSQL JSONB 支持索引和复杂查询

### 2. Bull Queue 异步生成

**选择原因**：
- 报告生成涉及大量聚合计算，可能耗时较长
- 自动处理生成失败的情况（重试机制）
- 支持前端显示生成进度

### 3. 百分位排名而非具体排名

**选择原因**：
- 保护用户隐私，只展示"超过 X% 的用户"
- 不提供排行榜功能，避免隐私泄露
- 更友好的用户体验

### 4. 分享页面数据快照

**选择原因**：
- 分享链接永久有效，即使原报告删除或更新
- 避免分享链接依赖用户登录状态
- 便于访问统计和分析

---

## 个性化标签/称号设计

### 基于阅读量

| 条件 | 徽章 | 称号 |
|-----|------|------|
| 阅读 >= 50 本 | READING_CHAMPION | 阅读冠军 |
| 阅读 >= 30 本 | BOOK_LOVER | 书籍爱好者 |
| 阅读 >= 10 本 | EAGER_READER | 热心读者 |
| 阅读 < 10 本 | READING_STARTER | 阅读新手 |

### 基于时间偏好

| 条件 | 徽章 | 称号 |
|-----|------|------|
| 主要 22:00-05:00 阅读 | NIGHT_OWL | 深夜书虫 |
| 主要 05:00-09:00 阅读 | EARLY_BIRD | 晨读达人 |
| 阅读时间均匀分布 | TIME_FLEXIBLE | 随时阅读者 |

### 基于完成率

| 条件 | 徽章 |
|-----|------|
| 完成率 >= 80% | PERFECTIONIST |
| 完成率 >= 50% | STEADY_READER |

### 基于 AI 使用

| 条件 | 徽章 |
|-----|------|
| AI 交互 >= 100 次 | AI_EXPLORER |
| 使用过所有 AI 功能 | AI_MASTER |

---

## 已确认事项

1. **入口位置**：Me 页面顶部，添加年度报告入口卡片
2. **历史报告**：支持查看往年年度报告
3. **分享方式**：
   - 生成 Web 页面，分享时分享页面 URL
   - 支持 iOS 原生分享组件
   - Web 页面可被任何人访问（无需登录）

## 待确认事项

1. **划线/笔记功能**：当前系统是否已有类似功能？如无需新增 UserHighlight 表
2. **推送策略**：是否需要在报告生成后推送通知用户？

# EPUB 阅读器架构决策评估

## 决策问题

**方案 A**：Pipeline 处理 Gutenberg 源文件，转换为标准 EPUB 格式
**方案 B**：阅读器迁移到 CSS Multi-Column 分页

**额外约束**：需支持 TTS + 文本进度显示 + 双击翻译

---

## 〇、已记录问题概览

基于三份问题文档的完整统计，当前系统已发现 **26 个问题**（排除 Dropcap 相关问题）：

> **设计决策：不支持 Dropcap（首字下沉）布局**
>
> 原因：Dropcap 布局引入了 7 个复杂问题，增加了大量分页算法复杂度。
> 简化方案：Pipeline 直接移除 Dropcap 图片，使用普通段落首字母显示。

### 问题分类统计

| 问题来源 | 数量 | 已修复 | 待处理 |
|---------|------|-------|-------|
| 阅读器 JS 分页算法 | 15 | 13 | 2 |
| 后端 EPUB 解析 | 6 | 6 | 0 |
| CSS 样式缺失 | 5 | 3 | 2 |

### 问题严重程度分布

| 严重程度 | 数量 | 示例 |
|---------|------|------|
| 🔴 严重 | 6 | 内容截断、文字被削、章节丢失 |
| 🟠 中等 | 15 | 标题重复、空白页、样式丢失 |
| 🟡 轻微 | 5 | 图片尺寸、边距不适配 |

### 问题根因分析

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        问题根因分类                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  JS 手动分页算法 Bug (15个问题)                                              │
│  ├─ 内容截断/丢失: 分页边界处理不当                                          │
│  ├─ 空白页问题: 空元素、HR、孤立文本处理                                     │
│  ├─ 超大元素: 表格/图片/长段落分割失败                                       │
│  ├─ 文字被削: overflow:hidden + 高度计算错误                                │
│  └─ 单词断裂: 分割点选择不当                                                │
│                                                                             │
│  后端 EPUB 解析 Bug (6个问题)                                                │
│  ├─ 章节丢失: Flow-based 解析无法处理同文件多章节                           │
│  ├─ Cover 处理: 封面章节的添加/过滤逻辑                                     │
│  └─ Boilerplate 残留: Gutenberg 版权信息未清理                              │
│                                                                             │
│  CSS 样式问题 (5个问题)                                                      │
│  ├─ 样式类丢失: EPUB 原始 CSS 被删除                                        │
│  ├─ 选择器不匹配: figcenter, caption 等类未定义                             │
│  └─ 图片居中: 内联 style 覆盖问题                                           │
│                                                                             │
│  ❌ 已排除：Dropcap 相关问题 (7个) - 不再支持此功能                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 关键发现

> **15/26 (58%) 的问题直接由 JS 手动分页算法引起**
>
> 这些问题具有以下特点：
> - 持续性：每本新书都可能触发新 bug
> - 复杂性：修复一个问题可能引入新问题
> - 脆弱性：算法逻辑复杂，难以覆盖所有边界情况

---

## 一、方案对比矩阵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           方案对比总览                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  维度              方案 A (Pipeline)      方案 B (CSS Column)    结论       │
│  ─────────────────────────────────────────────────────────────────────────  │
│  排版质量           中（依赖源文件）        高（浏览器原生）      B 胜      │
│  孤行寡行控制       需手动算法              CSS 原生支持          B 胜      │
│  断字处理           需手动处理              CSS hyphens           B 胜      │
│  TTS 实现           简单（DOM 清晰）        中等（需 Range API）  A 略优    │
│  进度显示           简单                    中等                  A 略优    │
│  双击翻译           简单                    中等                  A 略优    │
│  维护成本           高（处理各种格式）      低（标准方案）        B 胜      │
│  行业采用           无                      Apple/Kindle/Readium  B 胜      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、关键发现：两种方案不互斥

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        核心结论                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  方案 A 和 方案 B 解决的是不同层面的问题：                                   │
│                                                                             │
│  方案 A (Pipeline)                    方案 B (CSS Column)                   │
│  ┌─────────────────────────┐         ┌─────────────────────────┐           │
│  │ 解决：源文件质量问题     │         │ 解决：渲染引擎问题       │           │
│  │ • 移除 boilerplate      │         │ • 分页算法               │           │
│  │ • 标准化 HTML 结构      │         │ • 孤行寡行控制           │           │
│  │ • 统一 CSS 类名         │         │ • 断字处理               │           │
│  │ • 图片优化              │         │ • 排版质量               │           │
│  └─────────────────────────┘         └─────────────────────────┘           │
│                                                                             │
│  ✅ 最佳方案：两者结合                                                       │
│  • Pipeline 负责清洗源文件（解决输入问题）                                   │
│  • CSS Column 负责渲染显示（解决输出问题）                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、TTS + 进度 + 翻译 在 CSS Column 下的可行性

### 3.1 行业验证

| 产品 | 分页方案 | TTS 支持 | 进度显示 | 翻译功能 |
|------|----------|---------|---------|---------|
| **Apple Books** | CSS Column | ✅ 朗读+高亮 | ✅ | ✅ 长按查词 |
| **Kindle** | CSS Column | ✅ Whispersync | ✅ | ✅ 内置词典 |
| **Readium** | CSS Column | ✅ Web Speech API | ✅ | 需自行实现 |
| **epub.js** | CSS Column | ✅ 可集成 | ✅ | 需自行实现 |
| **Thorium** | CSS Column | ✅ 句+词高亮 | ✅ | ✅ |

**结论**：CSS Column 方案完全可以支持这些功能，行业已有成熟实现。

### 3.2 技术实现原理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CSS Column 下的交互功能实现                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【TTS + 高亮】                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. Web Speech API 朗读文本                                           │   │
│  │ 2. 监听 boundary 事件获取当前朗读位置                                │   │
│  │ 3. 使用 Range API 定位 DOM 节点                                      │   │
│  │ 4. getBoundingClientRect() 获取坐标（需调整 column offset）          │   │
│  │ 5. 绘制高亮覆盖层或使用 CSS ::highlight                              │   │
│  │ 6. 检测是否需要翻页（元素在可视区外则自动翻页）                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【进度显示】                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 方法 1: 基于 scrollLeft / totalScrollWidth 计算                      │   │
│  │ 方法 2: 基于 CFI (Canonical Fragment Identifier) 定位                │   │
│  │ 方法 3: 基于字符/单词计数                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【双击翻译】                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 监听 dblclick/touchend 事件                                       │   │
│  │ 2. window.getSelection() 获取选中文本                                │   │
│  │ 3. Range.getBoundingClientRect() 获取位置                            │   │
│  │ 4. 在该位置显示翻译弹窗                                              │   │
│  │ 注意: 需处理 iframe + column offset 的坐标转换                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Readium 的 TTS 实现参考

```typescript
// Readium Navigator TTS 核心流程（简化）
class TTSNavigator {
    // 1. 获取当前可视区域文本
    getCurrentText(): string {
        const visibleRange = this.getVisibleRange();
        return visibleRange.toString();
    }

    // 2. 朗读并高亮
    async speak(text: string) {
        const utterance = new SpeechSynthesisUtterance(text);

        utterance.onboundary = (event) => {
            // 获取当前朗读的单词位置
            const charIndex = event.charIndex;
            const word = this.getWordAtIndex(charIndex);

            // 高亮当前单词
            this.highlightWord(word);

            // 检查是否需要翻页
            if (this.isElementOutOfView(word.element)) {
                this.turnPage();
            }
        };

        speechSynthesis.speak(utterance);
    }

    // 3. 高亮实现
    highlightWord(word: Word) {
        const range = document.createRange();
        range.setStart(word.node, word.start);
        range.setEnd(word.node, word.end);

        // 方法 A: CSS Highlight API (现代浏览器)
        CSS.highlights.set('tts-current', new Highlight(range));

        // 方法 B: 插入 span 包裹
        // const span = document.createElement('span');
        // span.className = 'tts-highlight';
        // range.surroundContents(span);
    }
}
```

---

## 四、复杂度对比

### 4.1 JS 手动分页 + TTS

```
复杂度分布：
┌────────────────────────────────────────────────────┐
│ 分页算法     ████████████████████ 高（当前问题所在） │
│ TTS 实现     ████████ 中                           │
│ 进度显示     ████ 低                               │
│ 双击翻译     ████ 低                               │
│ 总体维护     ████████████████████ 高               │
└────────────────────────────────────────────────────┘
```

### 4.2 CSS Column + TTS

```
复杂度分布：
┌────────────────────────────────────────────────────┐
│ 分页算法     ████ 低（CSS 原生）                   │
│ TTS 实现     ████████████ 中高                     │
│ 进度显示     ████████ 中                           │
│ 双击翻译     ████████ 中                           │
│ 总体维护     ████████ 中                           │
└────────────────────────────────────────────────────┘
```

**分析**：
- JS 手动分页的复杂度集中在分页算法，而且是持续性问题（每个新书都可能暴露新 bug）
- CSS Column 的复杂度集中在交互功能，但这是一次性投入（实现后对所有书通用）

---

## 五、风险评估

### 5.1 继续使用 JS 手动分页的风险

| 风险 | 概率 | 影响 |
|------|------|------|
| 分页算法持续出 bug | 高 | 高 - 用户体验差 |
| 新书格式触发新问题 | 高 | 中 - 需要持续修复 |
| 排版质量无法媲美竞品 | 确定 | 高 - 竞争力不足 |
| 孤行寡行问题难以完美解决 | 高 | 中 - 阅读体验差 |

### 5.2 迁移到 CSS Column 的风险

| 风险 | 概率 | 影响 |
|------|------|------|
| 迁移工作量 | 确定 | 中 - 一次性投入 |
| TTS/翻译实现复杂 | 中 | 中 - 有行业参考 |
| 旧版浏览器兼容 | 低 | 低 - 目标是移动端 |

---

## 六、推荐方案

### 6.1 最终建议

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           推荐方案                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ✅ 同时采用方案 A + 方案 B                                                  │
│                                                                             │
│  【Phase 1: Pipeline 优化】                                                  │
│  • 移除 Gutenberg boilerplate                                               │
│  • 移除 Dropcap 图片（简化排版）                                             │
│  • 统一图片命名和尺寸                                                        │
│  • 添加封面章节                                                              │
│  时间预估: 1-2 周                                                            │
│                                                                             │
│  【Phase 2: 阅读器迁移到 CSS Column】                                        │
│  • 替换 JS 分页算法为 CSS multi-column                                       │
│  • 实现翻页动画 (transform/scrollLeft)                                       │
│  • 保留用户设置（字号、行高、主题）                                          │
│  时间预估: 2-3 周                                                            │
│                                                                             │
│  【Phase 3: 交互功能实现】                                                   │
│  • TTS + 高亮（基于 Range API + Web Speech API）                             │
│  • 进度显示（基于 scrollLeft 百分比）                                        │
│  • 双击翻译（Selection API + 弹窗）                                          │
│  时间预估: 2-3 周                                                            │
│                                                                             │
│  总投入: 5-8 周                                                              │
│  预期收益:                                                                   │
│  • 排版质量提升到行业水平                                                    │
│  • 分页 bug 彻底消除                                                         │
│  • 代码可维护性大幅提高                                                      │
│  • 支持 TTS/翻译等高级功能                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 为什么不只做 Pipeline？

```
即使 Pipeline 输出完美的 EPUB：
┌──────────────────────────────────────────────────────┐
│ 完美 EPUB ──────→ JS 手动分页 ──────→ 仍然有 bug     │
│                        ↑                              │
│                   问题根源在这里                       │
└──────────────────────────────────────────────────────┘

Pipeline 解决的是输入问题，但渲染问题还在。
```

### 6.3 为什么不只做 CSS Column？

```
即使阅读器完美：
┌──────────────────────────────────────────────────────┐
│ 脏数据 EPUB ────→ CSS Column ────→ 显示 boilerplate  │
│      ↑                                                │
│  问题在这里                                           │
└──────────────────────────────────────────────────────┘

CSS Column 解决的是渲染问题，但源文件问题还在。
```

---

## 七、实施路线图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           实施路线图                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Week 1-2: Pipeline 清洗                                                     │
│  ├─ [ ] Gutenberg boilerplate 移除规则                                      │
│  ├─ [ ] 移除 Dropcap 图片（简化排版逻辑）                                   │
│  ├─ [ ] 测试 5 本 Gutenberg 书                                              │
│  └─ [ ] 验证 Content Studio 预览效果                                        │
│                                                                             │
│  Week 3-4: CSS Column 分页                                                   │
│  ├─ [ ] 新建 reader-template-v2.ts                                          │
│  ├─ [ ] 实现 CSS multi-column 分页                                          │
│  ├─ [ ] 翻页交互 (手势/按钮)                                                │
│  ├─ [ ] 保留用户设置功能                                                    │
│  └─ [ ] A/B 对比测试（旧 vs 新）                                            │
│                                                                             │
│  Week 5: 进度显示                                                            │
│  ├─ [ ] 页码计算 (总页数/当前页)                                            │
│  ├─ [ ] 阅读百分比                                                          │
│  └─ [ ] 位置保存/恢复                                                       │
│                                                                             │
│  Week 6-7: TTS 功能                                                          │
│  ├─ [ ] Web Speech API 集成                                                 │
│  ├─ [ ] 句子级高亮                                                          │
│  ├─ [ ] 单词级高亮 (可选)                                                   │
│  └─ [ ] 自动翻页                                                            │
│                                                                             │
│  Week 8: 翻译功能                                                            │
│  ├─ [ ] 双击/长按选词                                                       │
│  ├─ [ ] 翻译 API 集成                                                       │
│  └─ [ ] 弹窗定位（处理 column offset）                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、技术参考

### 8.1 CSS Column 核心代码

```css
/* Content Studio reader-template.ts 核心改动 */
.reader-container {
    column-width: 100vw;
    column-gap: 0;
    height: calc(100vh - var(--header-height) - var(--footer-height));
    overflow: hidden;

    /* 孤行寡行控制 */
    orphans: 2;
    widows: 2;
}

/* 翻页通过 transform 实现 */
.reader-content {
    transform: translateX(calc(-100vw * var(--current-page)));
    transition: transform 0.3s ease;
}
```

### 8.2 TTS 高亮核心代码

```typescript
// 基于 Readium 实现思路
function highlightCurrentUtterance(range: Range) {
    // 1. 获取 range 在 column 中的位置
    const rect = range.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // 2. 计算实际位置（考虑 column offset）
    const columnWidth = containerRect.width;
    const scrollOffset = container.scrollLeft;
    const pageIndex = Math.floor(scrollOffset / columnWidth);

    const adjustedLeft = rect.left - containerRect.left + (pageIndex * columnWidth);

    // 3. 绘制高亮
    highlightOverlay.style.left = `${adjustedLeft}px`;
    highlightOverlay.style.top = `${rect.top - containerRect.top}px`;
    highlightOverlay.style.width = `${rect.width}px`;
    highlightOverlay.style.height = `${rect.height}px`;

    // 4. 检查是否需要翻页
    if (rect.right > containerRect.right) {
        turnToNextPage();
    }
}
```

### 8.3 开源参考

| 项目 | 说明 | 链接 |
|------|------|------|
| Readium CSS | 行业标准样式表 | [GitHub](https://github.com/readium/readium-css) |
| epub.js | JS EPUB 渲染库 | [GitHub](https://github.com/futurepress/epub.js) |
| Foliate-js | 浏览器 EPUB 渲染 | [GitHub](https://github.com/johnfactotum/foliate-js) |
| Thorium Reader | 完整阅读器实现 | [GitHub](https://github.com/edrlab/thorium-reader) |

---

## 九、问题解决方案映射

### 9.1 各问题的解决路径

基于 26 个已记录问题（排除 Dropcap 相关），分析各问题在不同方案下的解决情况：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     问题 → 方案映射                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  问题类型              Pipeline    CSS Column    两者结合    需要处理        │
│  ─────────────────────────────────────────────────────────────────────────  │
│  JS 分页算法 Bug (15个)                                                      │
│  ├─ 内容截断/丢失        ❌           ✅            ✅        CSS Column     │
│  ├─ 空白页问题           ❌           ✅            ✅        CSS Column     │
│  ├─ 超大元素分割         ❌           ✅            ✅        CSS Column     │
│  ├─ 文字被削             ❌           ✅            ✅        CSS Column     │
│  └─ 单词断裂             ❌           ✅            ✅        CSS Column     │
│                                                                             │
│  后端 EPUB 解析 Bug (6个)                                                    │
│  ├─ 章节丢失             ✅           ❌            ✅        Pipeline       │
│  ├─ Cover 处理           ✅           ❌            ✅        Pipeline       │
│  └─ Boilerplate 残留     ✅           ❌            ✅        Pipeline       │
│                                                                             │
│  CSS 样式问题 (5个)                                                          │
│  ├─ 样式类丢失           ✅           △             ✅        Pipeline       │
│  ├─ 选择器不匹配         △            ✅            ✅        CSS Column     │
│  └─ 图片居中             ✅           ✅            ✅        任一方案       │
│                                                                             │
│  ✅ = 完全解决    △ = 部分解决    ❌ = 无法解决                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 CSS Multi-Column 如何解决 JS 分页问题

| JS 分页问题 | CSS Column 解决机制 |
|------------|-------------------|
| 内容截断/丢失 | 浏览器原生分栏，不存在手动计算错误 |
| 空白页问题 | CSS 自动填充，无需手动处理空元素 |
| 超大元素分割 | `break-inside: avoid` + 自动溢出处理 |
| 文字被削 | 无 overflow:hidden，内容自然流入下一栏 |
| 单词断裂 | CSS `hyphens: auto` + `word-break` 原生控制 |
| 孤行寡行 | CSS `orphans: 2; widows: 2` 原生支持 |

### 9.3 Pipeline 如何解决源文件问题

| 源文件问题 | Pipeline 解决机制 |
|-----------|------------------|
| 章节丢失 | TOC-based 解析，处理同文件多章节 |
| Cover 缺失 | 自动检测并添加封面章节 |
| Boilerplate 残留 | 正则清理 Gutenberg 特定元素 |
| CSS 样式丢失 | 保留 `<style>` 标签，上传外部 CSS |
| Dropcap 图片 | 直接移除，简化排版逻辑 |

### 9.4 仅单一方案的局限性

**仅 Pipeline（不改分页算法）：**
```
完美 EPUB ────→ JS 手动分页 ────→ 仍有 15 个 bug
                     ↑
              问题根源未解决
```
- 即使源文件完美，分页算法的边界情况仍会导致问题
- 每本新书格式都可能触发新的分页 bug

**仅 CSS Column（不清洗源文件）：**
```
脏数据 EPUB ────→ CSS Column ────→ 显示 boilerplate
      ↑
  源文件问题未解决
```
- Gutenberg 版权信息会显示在阅读内容中
- 章节结构混乱，用户体验差

---

## 十、最终结论

### 10.1 数据驱动的决策

| 指标 | 数值 | 结论 |
|------|------|------|
| JS 分页 bug 占比 | 58% (15/26) | 必须迁移到 CSS Column |
| Pipeline 能解决的问题 | 23% (6/26) | 必须保留 Pipeline 清洗 |
| 两者结合能解决的问题 | 100% (26/26) | 必须两者结合 |

### 10.2 推荐方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           最终推荐方案                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ✅ 同时采用 Pipeline + CSS Column                                           │
│                                                                             │
│  Pipeline (解决 23% 源文件问题)           CSS Column (解决 58% 分页问题)      │
│  ┌─────────────────────────┐              ┌─────────────────────────┐       │
│  │ • 清理 Gutenberg 版权    │              │ • 浏览器原生分页         │       │
│  │ • 标准化章节结构         │   ────→     │ • 孤行寡行自动控制       │       │
│  │ • 添加封面章节           │   清洗后    │ • 断字处理               │       │
│  │ • 保留/转换 CSS 样式     │   的 EPUB   │ • 无内容截断/丢失        │       │
│  └─────────────────────────┘              └─────────────────────────┘       │
│                                                                             │
│  预期收益:                                                                   │
│  • 26 个已知问题全部解决                                                     │
│  • 未来新书不再触发分页 bug                                                  │
│  • 排版质量达到 Apple Books / Kindle 水平                                   │
│  • 代码维护成本大幅降低                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 总结

| 问题 | 答案 |
|------|------|
| **只做 Pipeline 是否足够？** | ❌ 不够，15 个分页 bug 仍在 |
| **只做 CSS Column 是否足够？** | ❌ 不够，6 个源文件问题仍在 |
| **最佳方案？** | ✅ 两者结合，解决 100% 问题 |
| **TTS/翻译与 CSS Column 兼容？** | ✅ 兼容，行业已验证 |
| **迁移成本值得？** | ✅ 值得，一次性投入换取长期收益 |

---

## 附录：问题文档索引

| 文档 | 问题数量 | 主要内容 |
|------|---------|---------|
| [epub-reader-mobile-issues.md](./epub-reader-mobile-issues.md) | 15 | 第一批问题：图片溢出、Drop Cap、CSS丢失等 |
| [epub-reader-mobile-issues2.md](./epub-reader-mobile-issues2.md) | 16 | 第二批问题：分页算法、ORPHAN PREVENTION、后端解析等 |
| [epub-reader-mobile-issues3.md](./epub-reader-mobile-issues3.md) | 2 | 第三批问题：Cover章节、分页截断 |

---

*文档更新日期: 2026-01-26*

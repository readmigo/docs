# EPUB 阅读器手机屏幕适配问题清单

## 概述

基于书籍 `61280.epub` (The Young Pilgrim) 和 V1 处理方案的分析，梳理阅读器需要解决的手机屏幕适配重点问题。

---

## 问题总览

| 问题类型 | 严重程度 | V1 状态 | V2 需处理 |
|----------|----------|---------|-----------|
| 图片高度溢出/被削 | 🔴 严重 | 未处理 | ✅ |
| Drop Cap 首字下沉失效 | 🟠 中等 | 未处理 | ✅ |
| 跨章节链接失效 | 🟠 中等 | 未处理 | ✅ |
| CSS 样式类丢失 | 🟠 中等 | 未处理 | ✅ |
| 表格高度溢出/被削 | 🟠 中等 | 未处理 | ✅ |
| 边距百分比不适配 | 🟡 轻微 | 未处理 | ✅ |
| 字体样式丢失 | 🟡 轻微 | 未处理 | ✅ |
| **分页文字被削** | 🔴 严重 | 阅读器Bug | ✅ |
| **章节未新页起始** | 🟠 中等 | 阅读器Bug | ✅ |
| **封面页留白过多** | 🟠 中等 | V1 + 阅读器 | ✅ |
| **封面图片未独占一页** | 🔴 严重 | BE解析Bug | ✅ |
| **Project Gutenberg 协议重复** | 🟠 中等 | BE解析Bug | ✅ |
| **Dropcap 导致第一页稀疏** | 🟠 中等 | 阅读器Bug | ✅ |
| **章节标题重复显示** | 🟠 中等 | 阅读器Bug | ✅ |
| **Dropcap 图片尺寸过大** | 🟡 轻微 | 阅读器Bug | ✅ |

---

### 图片高度溢出/被削

在分页阅读模式下，图片高度超出页面可视区域，底部被裁切显示不全。

**根本原因**：

1. **图片原始尺寸过大**：EPUB 中的插图可能是高分辨率图片
2. **分页容器 overflow:hidden**：超出页面高度的内容直接被裁切
3. **图片未设置最大高度**：阅读器注入的 CSS 只限制了 `max-width: 100%`，未限制高度

---

### Drop Cap 首字下沉失效

原书每章开头有精美的首字母图片装饰，V1 处理后完全失效。

---

### 跨章节链接失效

目录页和正文中的章节跳转链接点击无响应。

| 链接类型 | 示例 | 处理方式 |
|----------|------|----------|
| 同章节锚点 | `#footnote1` | 保留，WebView 内跳转 |
| 跨章节链接 | `chapter2.html#section` | 转换为 APP 导航协议 |
| 外部链接 | `https://...` | 保留，系统浏览器打开 |

---

### CSS 样式类丢失

出版商定义的排版样式全部丢失，页面显示为无格式纯文本。

| 样式类 | 原始效果 | V1 效果 |
|--------|----------|---------|
| `.titlepage` | 标题页居中、大字体、上边距 | 左对齐普通段落 |
| `.chapter` | 章节引言缩进、小字体 | 普通段落 |
| `.figcenter` | 图片居中、自动边距 | 左对齐 |
| `.caption` | 图片说明居中、小字体 | 普通段落 |
| `.smcap` | 小型大写字母 | 普通文本 |
| `.poetry` | 诗歌缩进、行距 | 普通段落 |
| `.epitaph` | 墓志铭居中、行距1.8 | 普通段落 |

---

### 表格高度溢出/被削

在分页阅读模式下，目录表格或其他表格高度超出页面，底部行被裁切显示不全。

**根本原因**：

1. **表格作为单一元素处理**：分页算法将整个表格视为一个不可分割的元素
2. **表格高度超出页面**：长目录表格无法放入单页
3. **overflow:hidden 裁切**：超出部分直接被隐藏

---

### 边距百分比不适配

CSS 中使用百分比边距，在手机上可能过大或过小。

| 屏幕宽度 | 10% 边距 | 实际内容区 |
|----------|----------|------------|
| 桌面 1024px | 102px | 820px |
| 平板 768px | 77px | 614px |
| 手机 375px | 37px | 301px |

---

### 字体样式丢失

字体大小变化、字体变体等样式丢失。

---

## V2 处理优先级

| 优先级 | 问题 | 处理方式 |
|--------|------|----------|
| P0 | 图片固定宽度溢出 | 优化内联样式 |
| P0 | CSS 样式类丢失 | 保留 style 标签，上传外部 CSS |
| P1 | Drop Cap 失效 | 依赖 CSS 保留 |
| P1 | 跨章节链接失效 | 转换为 APP 导航协议 |
| P2 | 表格布局溢出 | 注入保护样式 |
| P3 | 边距百分比 | 观察，必要时调整 |
| P3 | 字体样式丢失 | 依赖 CSS 保留 |

---

## 阅读器注入的基础 CSS

建议在 V2 中阅读器注入以下基础保护样式（图片最大尺寸限制、表格溢出保护等）。

---

### 分页文字被削

在分页阅读模式下，页面底部的文字被水平裁切，只显示上半部分。

**根本原因**：分页模式的 CSS 设置了双重 `overflow: hidden`，分页算法计算页面可用高度存在误差。

| 原因 | 说明 |
|------|------|
| 行高误差 | `offsetHeight` 不含行高溢出部分 |
| 子像素渲染 | 浏览器实际渲染高度可能有 0.5-1px 差异 |
| margin collapse | 相邻元素的 margin 合并计算不准确 |
| 字体 metrics | 不同字体的 ascender/descender 高度不同 |

---

### 章节未新页起始

新章节的内容显示在上一章最后一页的下方，而不是从新的一页开始。

**根本原因**：

1. **章节预加载合并显示** - 预加载的下一章内容被错误地追加到当前章节
2. **章节边界检测问题** - 到达章节末尾时，没有正确触发章节切换
3. **WebView 复用问题** - 新章节加载时，旧内容未完全清除

---

## 阅读器问题总结

| 问题 | 严重程度 | 来源 | 修复难度 |
|------|----------|------|----------|
| 分页文字被削 | 🔴 严重 | CSS overflow:hidden + 高度计算误差 | 中 |
| 章节未新页起始 | 🟠 中等 | 章节切换/预加载逻辑 | 中 |
| 封面页留白过多 | 🟠 中等 | CSS 样式丢失 + 阅读器 padding | 中 |
| 封面图片未独占一页 | 🔴 严重 | BE解析未分离封面章节 | 中 |

---

### 封面页留白过多

书籍封面图片没有全屏显示，上下左右留白过多，视觉效果差。

**根本原因**：阅读器 body padding 导致封面无法全屏。

**修复方案对比**：

| 方案 | 描述 | 推荐 |
|------|------|------|
| 方案 A | 封面页特殊处理：检测封面页，移除 padding，全屏显示 | ✅ 推荐 |
| 方案 B | CSS 覆盖：注入封面专用样式 | - |
| 方案 C | V2 保留原始样式：保留 EPUB 中的 style 和 link 标签 | - |

---

### 封面图片未独占一页

封面图片和第一章内容混在一起显示。

**修复方案对比**：

| 方案 | 描述 | 推荐 |
|------|------|------|
| 方案 A | 后端解析修复：解析 EPUB 时识别封面标记，将封面作为独立章节存储 | ✅ 推荐 |
| 方案 B | 客户端补救：检测封面图片，强制作为单独一页（已实现） | - |

**封面标记识别方式**：OPF guide 中的 `type="cover"`、OPF metadata 中的 `cover-image`、HTML 中的 `class="x-ebookmaker-cover"`。

---

### Project Gutenberg 协议重复

每个章节都包含 Project Gutenberg 协议文本，导致内容冗余。

**修复方案**：后端解析时识别协议文本特征（"The Project Gutenberg" 开头的段落、`www.gutenberg.org` 链接、License/Terms of Use 相关内容），在章节内容提取时过滤。

---

### Dropcap 导致第一页稀疏

Dropcap 首字母图片导致第一页看起来很空，文字从第二页才开始密集显示。

**修复方案**：将 dropcap div + p.dropcap 作为组合处理，使用估算高度替代实际测量，通过 skipIndices 跳过已处理的元素。

---

### 章节标题重复显示

阅读器模板注入 H1 章节标题后，EPUB 原始内容中的 H2 标题造成重复。

**修复方案**：标题去重逻辑 - 标准化章节标题（转小写、移除非字母数字字符），匹配 HTML 中的 H2 标签，若文本一致则移除重复的 H2。

---

### Dropcap 图片尺寸过大

Dropcap 首字母图片在手机上显示过大，占据过多空间。

**修复方案**：缩小 dropcap 图片尺寸（max-width/max-height 从 3em 调整为 2em，margin 等比缩小）。

| 概念 | 说明 |
|------|------|
| CSS `max-height` | 控制 dropcap 图片的**实际视觉高度** |
| JS `estimatedHeight` | 控制分页算法中的**高度估算**（何时换页） |
| 两者独立 | 修改 estimatedHeight 不会改变视觉显示 |

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 图片视觉过大 | CSS max-height 设置过大 | 缩小 max-height/max-width |
| 修改 JS 无效果 | 混淆了分页参数与 CSS 样式 | 区分两者职责 |
| 尺寸选择 | 主观美观判断 | 测试多个值，选择平衡点 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

## 相关文档

- [EPUB内容版本方案对比](./epub-content-versions-comparison.md)

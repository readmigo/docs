## 概述

基于 Content Studio 调试过程中新发现的阅读器问题，持续补充的问题清单。

---

## 问题总览

| 问题类型 | 严重程度 | 状态 |
|----------|----------|------|
| 章节标题重复显示 | 🟠 中等 | ✅ |
| Dropcap 图片尺寸过大 | 🟡 轻微 | ✅ |
| 空段落导致空白页 | 🟠 中等 | ✅ |
| 超大元素处理（标题单独占页 + 内容截断） | 🔴 严重 | ✅ |
| HR 单独成页 | 🟡 轻微 | ✅ |
| 图片未居中显示 | 🟠 中等 | ✅ |
| Dropcap 分页导致空白页 | 🟠 中等 | ✅ |
| 单词中断分页 | 🟠 中等 | ✅ |
| Dropcap 段落拆分后的孤立文本 | 🟠 中等 | ✅ |
| 孤立文本被 overflow:hidden 裁切 | 🔴 严重 | ⚠️ 被问题11取代 |
| MERGE 方案死循环 → ORPHAN PREVENTION | 🔴 严重 | ✅ |
| Dropcap 首字符重复显示 | 🟠 中等 | ✅ |
| EPUB 章节解析丢失 | 🔴 严重 | ✅ |
| Cover 章节自动添加问题 | 🟠 中等 | ✅ |
| Project Gutenberg 版权信息残留 | 🟠 中等 | ✅ |
| 图片标题 (caption) 字体过大且未居中 | 🟡 轻微 | ✅ |

---

### 问题表现

某些章节页面顶部出现两个相同或相似的标题，例如：
- H1 显示 "Preface"（阅读器模板注入的章节标题）
- H2 显示 "Preface."（EPUB 原始内容中的标题）

### 根本原因

EPUB 原始内容结构：

阅读器模板生成：

### 问题分析

| 来源 | 标签 | 内容 | 说明 |
|------|------|------|------|
| 模板 | H1 | Preface | 从章节元数据获取 |
| EPUB | H2 | Preface. | 原始内容中的标题 |

两者文本内容相同（忽略标点），导致视觉上重复。

### 正则表达式说明

| 模式 | 说明 |
|------|------|
| `.*?` | 匹配任意字符（不含换行符），非贪婪 |
| `[\s\S]*?` | 匹配任意字符（含换行符），非贪婪 |

H2 内容可能包含 `<br/>` 或换行符：

使用 `[\s\S]*?` 可正确匹配跨行内容。

### 标准化处理说明

| 原始文本 | 标准化后 | 说明 |
|----------|----------|------|
| "Preface" | "preface" | H1 章节标题 |
| "Preface." | "preface" | H2 原始标题，移除标点 |
| "CHAPTER I." | "chapteri" | 大小写 + 标点统一 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 标题重复 | 模板 H1 + EPUB H2 | 检测并移除重复的 H2 |
| 文本差异 | 标点、大小写不同 | 标准化后比较 |
| H2 嵌套标签 | H2 内可能有 span 等 | 先移除 HTML 标签再比较 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

Dropcap（首字下沉装饰图片）在手机屏幕上显示过大，占用过多空间，影响阅读体验。

### 根本原因

CSS 中 dropcap 图片尺寸设置过大：

在手机小屏幕上，3em 的首字母图片占用空间过大。

### 问题分析

| 尺寸 | 像素值 (18px字号) | 占用行数 | 视觉效果 |
|------|-------------------|----------|----------|
| 3em | ~54px | 3行 | 过大，影响阅读 |
| 2em | ~36px | 2行 | 适中，平衡装饰与阅读 |
| 1.5em | ~27px | 1.5行 | 较小，装饰效果减弱 |

### 关键理解

| 概念 | 说明 |
|------|------|
| CSS `max-height` | 控制 dropcap 图片的**实际视觉高度** |
| JS `estimatedHeight` | 控制分页算法中的**高度估算**（何时换页） |
| 两者独立 | 修改 estimatedHeight 不会改变视觉显示 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 图片视觉过大 | CSS max-height 设置过大 | 缩小 max-height/max-width |
| 修改 JS 无效果 | 混淆了分页参数与 CSS 样式 | 区分两者职责 |
| 尺寸选择 | 主观美观判断 | 测试多个值，选择平衡点 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

分页后某些页面完全空白，无任何内容显示。

### 根本原因

EPUB 原始内容中存在空段落（可能是格式化用途）：

### 问题分析

| 元素 | 高度 | 累计 | 结果 |
|------|------|------|------|
| [3] 长段落 | 473 | 0→473 | 超过页高，强制换页 |
| [4] 空段落 | 0-12 | 0→12 | 添加到新页，但无视觉内容 |
| [5] 下一段 | 876 | 0→876 | 又换页，第3页只有空段落 |

### 判断条件说明

| 条件 | 用途 |
|------|------|
| `el.tagName === 'P'` | 仅处理段落元素 |
| `!textContent.trim()` | 文本内容为空或仅空白 |
| `el.offsetHeight < 20` | 高度极小（排除有样式的空段落） |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 空白页 | 空段落单独占据一页 | 完全跳过空段落 |
| 之前方案无效 | 仅不计算高度但仍添加 HTML | 改为完全不添加 |
| 条件过严/过宽 | 误删有用元素或漏删空元素 | 三重条件判断 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

1. **标题单独占页**：某些章节（如 Contents、List of Illustrations）第一页只显示标题，内容区域空白
2. **内容被截断**：超大元素（如 TABLE 2170px）超过页高（460px），内容丢失

### 修复代码

**CSS 新增：**

**JavaScript 分页逻辑：**

### 测试结果

| 章节 | 修复前 | 修复后 | 内容 |
|------|--------|--------|------|
| Contents | 2页（截断） | 8页 | 28章目录完整 |
| List of Illustrations | 2页（截断） | 8页 | 27条插图完整 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 标题单独占页 | 超大元素触发换页 | 检测并合并标题 |
| 内容被截断 | overflow: hidden | 按类型分割/缩放 |
| 表格断裂 | 整体超过页高 | 按行分割，保留表头 |
| 图片过大 | 高度超过页高 | CSS 缩放适应 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

分页后某些页面只显示一条水平分隔线（HR），无其他内容。

### 根本原因

EPUB 原始内容中，HR 通常用于章节内的分隔：

当上一个段落正好填满页面时，HR 被推到下一页，形成近空白页。

### 问题分析

| 场景 | HR 位置 | 结果 |
|------|---------|------|
| 上段未满 | 同页 | 正常 |
| 上段刚满 | 新页 | 只有 HR 的空白页 |
| 章节末尾 | 新页 | 更明显的空白页 |

### 正则表达式说明

| 模式 | 说明 |
|------|------|
| `^` | 字符串开头 |
| `<hr` | 匹配 hr 标签开始 |
| `[^>]*` | 匹配任意属性 |
| `\/?>` | 匹配自闭合或普通闭合 |
| `\s*$` | 允许尾部空白 |

可匹配：`<hr>`, `<hr/>`, `<hr class="separator"/>` 等。

### 测试结果

| 章节 | 修复前 | 修复后 |
|------|--------|--------|
| List of Illustrations | 3页（第3页只有HR） | 2页（HR 在第2页末尾） |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| HR 单独占页 | 分页边界刚好在 HR 前 | 检测并合并到上一页 |
| 检测条件 | 需精确匹配仅 HR 情况 | 正则表达式判断 |
| 合并时机 | 分页循环结束后 | 在 push 前检测 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-23) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

EPUB 内容中的图片没有居中显示，偏向左侧或超出视口。

### 根本原因

EPUB 原始内容结构（含内联样式）：

视口宽度仅 240px，但 figcenter 被设为 400px，导致溢出。

### 问题分析

| 检查项 | 修复前 | 修复后 |
|--------|--------|--------|
| `.figcenter` CSS | ❌ 未定义 | ✅ 已定义 |
| `computedWidth` | 400px (溢出) | 240px (适应) |
| `max-width` | none | 100% |
| 图片位置 | 偏左 | 居中 |

### CSS 属性说明

| 属性 | 用途 |
|------|------|
| `margin: 1.5em 0` | 上下间距，与其他内容分隔 |
| `text-align: center` | 使内部行内/行内块元素（如 img）居中 |
| `break-inside: avoid` | 避免在此元素内部分页（现代浏览器） |
| `page-break-inside: avoid` | 避免分页（兼容旧浏览器） |
| `max-width: 100% !important` | 强制覆盖内联 width，限制最大宽度 |
| `width: auto !important` | 强制覆盖内联 width，自动计算宽度 |

### 调试过程

| 步骤 | 操作 | 发现 |
|------|------|------|
| 1 | 添加红色边框到 img | 图片有边框，但容器不明 |
| 2 | 添加蓝色边框到 figure | 无边框显示 |
| 3 | 添加绿色边框到 .figcenter | 边框显示，确认使用 figcenter |
| 4 | 检查 CSS | 缺少 .figcenter 类定义 |
| 5 | 添加 .figcenter 样式 | 问题依然存在 |
| 6 | 检查计算样式 | 发现内联 width: 400px 溢出 |
| 7 | 添加 !important 覆盖 | 问题修复 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 图片不居中 | EPUB 使用 figcenter 类而非 figure 元素 | 添加 .figcenter CSS 类 |
| 样式不生效 | CSS 选择器不匹配 HTML 结构 | 调试边框定位问题 |
| 内联样式覆盖 | EPUB 内联 style 优先级高于 CSS | 使用 !important |
| 容器溢出 | 内联 width: 400px > 视口 240px | max-width: 100% 限制 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-24) |
| iOS 阅读器 | ✅ 已同步 (2026-01-24) |

---

### 问题表现

Preface 章节第一页只显示标题 "Preface"，下方大段空白。Dropcap 内容被推到第二页，且第二页只显示少量剩余文本。

### 问题分析

| 阶段 | currentPageContent | currentHeight | 问题 |
|------|-------------------|---------------|------|
| Dropcap 分割后 | 剩余文本 | 0 | 高度未测量 |
| Tall element 检测 | 剩余文本 | 0 | 被识别为独立内容 |
| Tall element 处理 | - | - | 单独推入新页 |

核心问题：Dropcap 分割后设置 `currentHeight = 0`，但实际剩余文本有高度。当下一个元素是 Tall element 时，原有内容被单独推入新页，而非与 Tall element 合并。

### 核心修改点

**1. Dropcap 分割算法：**
- 将 dropcap 段落按 token 分割
- 逐个添加 token 直到超过可用高度
- 将前半部分与标题合并成第一页
- 剩余部分传递到下一轮

**2. Tall element 合并逻辑：**
- 检测 currentHeight = 0 但有内容的情况
- 动态测量内容实际高度
- 若内容高度 < 页高 25%，与 tall element 首页合并
- 否则单独成页

### 测试结果

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| Preface 总页数 | 11 | 10 |
| 第一页内容 | 仅标题 | 标题 + dropcap + 文本 |
| 第二页内容 | 仅剩余文本 | 剩余文本 + 后续段落 |
| 空白浪费 | 高 | 无 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 标题单独占页 | Dropcap 分割后剩余文本被单独处理 | 合并到 tall element 第一页 |
| currentHeight = 0 | 分割后未测量剩余高度 | 在 tall element 处理时补测 |
| 页面利用率低 | 小内容被推入独立页 | 检测并合并小内容 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-24) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

单词在页面边界被截断成两部分，例如 "solemn" 被分为 "s" 和 "olemn"，段落间出现异常空白间隙，导致文字流动不连续。

### 问题分析

| 场景 | Token 宽度 | 可用空间 | 结果 |
|------|-----------|---------|------|
| 单词完整 | 120px | 150px | 正常，单词在同页 |
| 单词完整 | 120px | 80px | 移到下一页（正确） |
| 单词截断 | 120px | 80px | 仅部分移动，导致截断 |

根本原因是分页算法在高度超限时，没有考虑文本单词的完整性。

### V2 解决方案

关键步骤：
1. 识别导致超高的 token
2. 在原始 HTML 段落中定位该 token 位置
3. 查找前面最后一个空白字符（正则 `/\s/` 的最后一次出现）
4. 从空白处分割，保留前半部分在当前页
5. 将后半部分及后续内容移到下一页

### 关键理解

| 概念 | 说明 |
|------|------|
| Token | 按空白字符分割的文本单位，如 "solemn" 是一个 token |
| 单词边界 | 单词前后的空白字符（空格、换行等） |
| 回溯 | 当 token 超高时，回到前一个单词边界，保留完整单词 |
| 文本分割 | 在空白处分割，而非在 token 中间分割 |

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | 页面剩余高度不足以容纳完整单词时 |
| 影响范围 | 所有 EPUB 文本分页，尤其是长词汇或小屏幕 |
| 修复原理 | Token 回溯到单词边界而非直接移动 |
| 性能影响 | 略有增加（需额外字符扫描），但可忽略 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

当 dropcap 段落需要拆分时，如果第一页使用了约 91.5% 的空间（如 428.4/468px），剩余约 39.6px。如果第二部分只有 58px（如"perused as an amusing tale."），理论上应该回填到第一页，但因为 safetyMargin 被重复扣除，导致 remainingSpace 只有约 19.6px，无法容纳第二部分。结果：第一页底部出现明显空白，而第二页只显示一小段孤立的文本。

### 根本原因

关键缺陷：
- 重复扣除 safetyMargin：在计算 availableForDropcap 和 remainingSpace 时分别扣除
- 缺乏容忍度：即使只差几个像素（如 39.6 > 19.6），也不允许回填小文本

### 问题分析

| 指标 | 值 | 说明 |
|------|-----|------|
| 页面总高度 | 468px | iPhone 视口高度 |
| 第一页已用 | 428.4px | 91.5% 页面高度 |
| 第一页剩余 | 39.6px | 理论可用空间 |
| 第二部分高度 | 58px | 孤立文本高度 |
| safetyMargin | 20px | 安全边距 |
| availableForDropcap | 448px | 468 - 20（第一次扣除） |
| 错误的 remainingSpace | 19.6px | 448 - 428.4（第二次扣除）|
| 正确的 remainingSpace | 39.6px | 468 - 428.4（不重复扣除） |

结果判断：
- 错误逻辑：58 > 19.6，无法回填，part2 单独成页
- 正确逻辑：58 > 39.6，仍无法精确回填，但可引入容忍度机制

### V2 解决方案

原理：
- 孤立文本（orphan text）是指仅占据很小空间的文本片段
- 将这些小文本强行推到下一页会造成页面利用率低、视觉割裂
- 允许小文本略微溢出第一页能改善整体阅读体验
- 容忍度值选择基于视觉测试：25px 略微紧凑但不影响可读性

### 参数选择说明

| 参数 | 值 | 调整空间 | 说明 |
|------|-----|---------|------|
| orphanThreshold | 80px | 60-100px | 判断孤立文本的阈值，越大越容易触发容忍度 |
| overflowTolerance | 25px | 15-35px | 容忍度大小，越大越容易回填，但页面越紧凑 |

测试建议：
- 若孤立文本仍频繁单独成页，增加 overflowTolerance（如 35px）
- 若页面显示过于紧凑，减少 overflowTolerance（如 15px）
- orphanThreshold 一般无需调整，除非内容类型特殊

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | Dropcap 段落拆分时第二部分很小但刚好超出剩余空间 |
| 影响范围 | 所有带 dropcap 的长段落，尤其是多段分割情况 |
| 修复原理 | 移除重复扣除 safetyMargin + 对小文本块增加容忍度 |
| 关键洞察 | 不同于硬性换页，某些情况下允许略微超限能改善用户体验 |
| 后续应用 | 可用于其他孤立内容场景，如单行标题、短列表等 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

问题 9 的修复方案（overflow tolerance）引入了新问题：当孤立文本通过 `+=` 追加到第一页时，由于页面容器设置了 `overflow: hidden`，超出部分被裁切，导致文本消失不见。

### 根本原因

关键缺陷：
- 追加独立 `<p>` 元素会导致总高度超出页面高度
- CSS `overflow: hidden` 会裁切超出部分
- 用户看到的效果是文本"消失"

### V2 解决方案

原理：
- 将文本插入现有段落而非创建新段落
- 浏览器会自动重新计算行内文本布局
- 文本可以在段落内自然换行，不受 overflow:hidden 影响

### 对比：APPEND vs MERGE

| 方式 | 操作 | DOM 结构 | 高度影响 | 视觉效果 |
|------|------|---------|---------|---------|
| APPEND | `+=secondPartP.outerHTML` | 新增 `<p>` 元素 | 增加元素高度 | 可能被裁切 |
| MERGE | 插入到现有 `</p>` 前 | 文本合并到段落 | 文本自然回流 | 完整显示 |

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | 孤立文本通过 APPEND 方式追加导致总高度超出页面 |
| 影响范围 | 所有使用 overflow tolerance 回填的孤立文本 |
| 修复原理 | 将文本 MERGE 到现有段落而非 APPEND 新元素 |
| 关键洞察 | DOM 结构影响布局计算，合并文本比追加元素更安全 |
| CSS 注意 | overflow:hidden 会裁切溢出内容，需要避免元素级溢出 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ⚠️ 已被问题 11 的方案取代 |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

问题 10 的 MERGE 修复方案仍然存在问题：将孤立文本合并到段落内部后，文本自然回流导致段落高度增加，最后一行仍然被 `overflow: hidden` 裁切。

两种方案都无法解决问题，形成死循环：
- APPEND：增加独立元素 → 元素级溢出 → 被裁切
- MERGE：合并到段落 → 段落高度增加 → 文本级溢出 → 被裁切

### V2 解决方案：ORPHAN PREVENTION

对比：

| 指标 | 事后补救 | 源头预防 |
|------|----------|----------|
| 第一页利用率 | ~91.5% (428.4px) | ~79% (370.4px) |
| 第二页高度 | 58px (孤立) | 115px (正常) |
| 裁切风险 | 高 | 无 |

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | 贪婪分页导致孤立文本，事后补救均失败 |
| 影响范围 | 所有 Dropcap 段落拆分场景 |
| 修复原理 | 预防优于补救，在分割时调整分割点 |
| 关键洞察 | 牺牲页面利用率换取内容完整性是正确权衡 |
| 设计思想 | 从源头解决问题，而非事后打补丁 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-24) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

当段落有 dropcap 装饰图片时，首字母同时出现在 dropcap 图片和段落文本中，导致视觉重复。

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | 任何包含 dropcap 图片的段落 |
| 影响范围 | 所有带 dropcap 的章节开头 |
| 修复原理 | CSS 隐藏首字符，避免与 dropcap 图片重复 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-24) |
| iOS 阅读器 | 🔴 待同步 |

---

### 问题表现

书籍应有 31 章节，但解析后只有 23-30 章节。部分章节丢失，包括：
- 封面页 (Cover)
- Frontispiece 插图页 (如 "MR. EWART AND MARK.")
- 同一 XHTML 文件中的多个章节

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | Gutenberg 等复杂 EPUB，同一文件含多章节 |
| 影响范围 | 所有使用 Flow-based 解析的书籍 |
| 修复原理 | TOC 是 EPUB 官方章节列表，比物理文件更可靠 |
| 关键洞察 | epub.toc (逻辑) 优于 epub.flow (物理) |
| 额外处理 | Cover 和 Frontispiece 需单独检测添加 |

### 修复状态

| 组件 | 状态 |
|------|------|
| epub-parser.service.ts | ✅ 已修复 (2026-01-24) |
| restore-chapters-from-toc.ts | ✅ 新增脚本 |

---

### 问题表现

书籍章节列表中出现 "Cover" 章节，但该章节内容通常只有一张封面图片，不是实际阅读内容。用户在阅读时需要手动跳过。

### 数据修复脚本

脚本功能：
- 查找所有标题为 "Cover" 的章节
- 删除这些章节
- 重新编号剩余章节 (order 字段)
- 更新书籍的 chapterCount

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | EPUB 文件包含封面页 (wrap*.xhtml) |
| 影响范围 | 所有 Gutenberg 和类似来源的 EPUB |
| 修复原理 | 过滤而非自动添加封面章节 |
| 关键洞察 | 封面图片应在书籍元数据中展示，不应作为章节 |

### 修复状态

| 组件 | 状态 |
|------|------|
| epub-parser.service.ts | ✅ 已修复 (2026-01-24) |
| remove-cover-chapters.ts | ✅ 新增脚本 |

---

### 问题表现

书籍章节开头和结尾包含 Project Gutenberg 的版权声明和法律信息，干扰正常阅读。

### 正则表达式说明

| 模式 | 匹配目标 |
|------|---------|
| `<section[^>]*class="[^"]*pg-boilerplate[^"]*"[^>]*>` | 带 pg-boilerplate class 的 section |
| `[\s\S]*?` | 任意字符（含换行），非贪婪匹配 |
| `<\/section>` | 闭合标签 |

### 数据修复脚本

脚本功能：
- 查找包含 Gutenberg 标记的章节
- 清理 htmlContent 字段
- 仅更新实际变化的记录

### 经验总结

| 类型 | 内容 |
|------|------|
| 触发条件 | 导入 Project Gutenberg 来源的 EPUB |
| 影响范围 | 所有 Gutenberg EPUB 的章节内容 |
| 修复原理 | 在存储前清理 HTML 中的版权元素 |
| 关键洞察 | EPUB 原始内容需要清洗，不能直接存储 |

### 修复状态

| 组件 | 状态 |
|------|------|
| epub-parser.service.ts | ✅ 已修复 (2026-01-24) |
| clean-gutenberg-boilerplate.ts | ✅ 新增脚本 |

---

### 问题表现

EPUB 内容中的图片标题（caption）显示字体过大，与正文相同，且没有居中对齐，影响视觉效果。

### 根本原因

EPUB 原始内容结构：

### 问题分析

| 检查项 | 修复前 | 修复后 |
|--------|--------|--------|
| `p.caption` CSS | ❌ 未定义 | ✅ 已定义 |
| `font-size` | 1em (正文) | 0.875em (小字) |
| `text-align` | left | center |
| `font-style` | normal | italic |
| `color` | 正文色 | 次要文字色 |

### CSS 属性说明

| 属性 | 用途 |
|------|------|
| `margin-top: 0.5em` | 与图片保持适当间距 |
| `font-size: 0.875em` | 比正文小（约14px @ 16px基准） |
| `color: var(--text-secondary)` | 使用次要文字颜色，视觉层次分明 |
| `font-style: italic` | 斜体显示，区别于正文 |
| `font-weight: normal` | 正常粗细 |
| `text-indent: 0` | 取消首行缩进 |
| `text-align: center` | 居中对齐 |
| `line-height: 1.4` | 适当行高 |

### 调试过程

| 步骤 | 操作 | 发现 |
|------|------|------|
| 1 | 查看图片标题样式 | 字体过大，未居中 |
| 2 | 检查 HTML 结构 | 使用 `<p class="caption">` |
| 3 | 检查现有 CSS | 有 figcaption 样式，无 .caption |
| 4 | 查询数据库验证 | 确认 EPUB 使用 `p.caption` 结构 |
| 5 | 添加 .caption CSS | 问题修复 |

### 经验总结

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 标题字体大 | CSS 选择器不匹配 | 添加 p.caption 选择器 |
| 标题未居中 | 无对应样式规则 | text-align: center |
| EPUB 结构多样 | 不同来源使用不同标签 | 覆盖常见结构 |

### 修复状态

| 组件 | 状态 |
|------|------|
| Content Studio | ✅ 已修复 (2026-01-24) |
| iOS 阅读器 | 🔴 待同步 |

---

## 相关文档

- [EPUB阅读器问题清单(第一批)](./epub-reader-mobile-issues.md)
- [EPUB内容版本方案对比](./epub-content-versions-comparison.md)

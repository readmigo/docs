# 系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户端                                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │   iOS   │  │ Android │  │   Web   │  │   RN    │                     │
│  │  App    │  │   App   │  │   App   │  │  (未来) │                     │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                     │
│       │            │            │            │                          │
│       └────────────┴─────┬──────┴────────────┘                          │
│                          │                                              │
└──────────────────────────┼──────────────────────────────────────────────┘
                           │ HTTPS / WSS
                           ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           API Gateway                                    │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │  • 负载均衡          • 速率限制          • 认证验证                │  │
│  │  • SSL终止           • 请求路由          • 日志记录                │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────┬───────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      后端服务 (NestJS) - 17个模块                        │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Auth       │  │   Content    │  │   Learning   │  │   AI         │  │
│  │   Module     │  │   Module     │  │   Module     │  │   Gateway    │  │
│  │              │  │              │  │              │  │   (22+端点)  │  │
│  │ • 登录注册   │  │ • 书籍管理   │  │ • 进度追踪   │  │ • 模型路由   │  │
│  │ • OAuth      │  │ • 章节管理   │  │ • 词汇管理   │  │ • 缓存控制   │  │
│  │ • JWT管理    │  │ • 书单排行   │  │ • 复习系统   │  │ • 深度分析   │  │
│  │ • 权限控制   │  │ • 搜索推荐   │  │ • 统计分析   │  │ • 对话AI     │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                 │                 │          │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐  │
│  │  Tracking    │  │  Booklists   │  │   Badges     │  │    Logs      │  │
│  │   (新增)     │  │   (新增)     │  │   (新增)     │  │   (新增)     │  │
│  │ • 事件追踪   │  │ • 书单列表   │  │ • 徽章定义   │  │ • 客户端日志 │  │
│  │ • 进度统计   │  │ • 排行榜     │  │ • 成就进度   │  │ • 崩溃报告   │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                 │                 │          │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐  │
│  │   Quotes     │  │  Postcards   │  │  Authors     │  │  AI Chat     │  │
│  │   (新增)     │  │   (新增)     │  │  (核心)      │  │  (核心)      │  │
│  │ • 书中金句   │  │ • 模板管理   │  │ • 作者管理   │  │ • 文字对话   │  │
│  │ • 作者名言   │  │ • 生成分享   │  │ • 时间线     │  │ • 语音对话   │  │
│  │ • 收藏点赞   │  │ • 公开浏览   │  │ • AI人格     │  │ • 视频对话   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                    │                                     │
│         └─────────────────┴────────┬────────┴─────────────────┘          │
│                                    │                                     │
└────────────────────────────────────┼─────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────┐ ┌──────────────────┐ ┌──────────────────────────┐
│    PostgreSQL        │ │     Redis        │ │     Object Storage       │
│                      │ │                  │ │                          │
│ • 用户数据           │ │ • Session        │ │ • EPUB文件               │
│ • 书籍元数据         │ │ • AI响应缓存     │ │ • 封面图片               │
│ • 学习进度           │ │ • 热门书籍缓存   │ │ • 用户上传               │
│ • 词汇数据           │ │ • 速率限制       │ │ • 静态资源               │
│ • 订阅信息           │ │ • 排行榜         │ │                          │
└──────────────────────┘ └──────────────────┘ └──────────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                          AI 服务层                                       │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐    │
│  │                      AI Router (智能路由)                         │    │
│  │  • 根据任务类型选择模型                                          │    │
│  │  • 成本/质量平衡                                                 │    │
│  │  • 自动降级和重试                                                │    │
│  └──────────────────────────────────────────────────────────────────┘    │
│                                     │                                    │
│         ┌───────────────────────────┼───────────────────────┐            │
│         │                           │                       │            │
│         ▼                           ▼                       ▼            │
│  ┌──────────────┐          ┌──────────────┐         ┌──────────────┐     │
│  │  DeepSeek    │          │  GPT-4o mini │         │  Claude      │     │
│  │  (主力)      │          │  (备选)      │         │  (高级)      │     │
│  │              │          │              │         │              │     │
│  │  • 词汇解释  │          │  • 词汇解释  │         │  • 深度分析  │     │
│  │  • 句子简化  │          │  • 句子简化  │         │  • 文学鉴赏  │     │
│  │  • 基础问答  │          │  • 基础问答  │         │  • 复杂问答  │     │
│  └──────────────┘          └──────────────┘         └──────────────┘     │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```
用户阅读流程：
═══════════════════════════════════════════════════════════════════════════

用户点击单词
      │
      ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  客户端     │────▶│  本地词典   │────▶│  命中？     │
│  请求解释   │     │  查询       │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                         ┌─────────────────────┴─────────────────────┐
                         │ Yes                                       │ No
                         ▼                                           ▼
                  ┌─────────────┐                             ┌─────────────┐
                  │  返回本地   │                             │  请求后端   │
                  │  释义       │                             │  API        │
                  └─────────────┘                             └──────┬──────┘
                                                                     │
                                                                     ▼
                                                              ┌─────────────┐
                                                              │  Redis缓存  │
                                                              │  检查       │
                                                              └──────┬──────┘
                                                                     │
                                         ┌───────────────────────────┴───────┐
                                         │ 命中                              │ 未命中
                                         ▼                                   ▼
                                  ┌─────────────┐                     ┌─────────────┐
                                  │  返回缓存   │                     │  AI Router  │
                                  │  结果       │                     │  调用AI     │
                                  └─────────────┘                     └──────┬──────┘
                                                                             │
                                                                             ▼
                                                                      ┌─────────────┐
                                                                      │  保存缓存   │
                                                                      │  返回结果   │
                                                                      └─────────────┘
```

---


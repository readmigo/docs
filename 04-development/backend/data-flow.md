# 后端数据流详解

> Backend Internal Data Flow - 请求处理与数据流转

---

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    后端服务架构总览                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                        ┌─────────────┐                          │
│                        │   iOS App   │                          │
│                        └──────┬──────┘                          │
│                               │                                  │
│                               │ HTTPS                           │
│                               ▼                                  │
│                    ┌──────────────────┐                         │
│                    │   Fly.io Edge    │                         │
│                    │   (负载均衡)      │                         │
│                    └────────┬─────────┘                         │
│                             │                                    │
│           ┌─────────────────┼─────────────────┐                 │
│           │                 │                 │                 │
│           ▼                 ▼                 ▼                 │
│    ┌──────────┐      ┌──────────┐      ┌──────────┐            │
│    │ API Pod  │      │ API Pod  │      │ Workers  │            │
│    │  (NestJS)│      │  (NestJS)│      │ (BullMQ) │            │
│    └────┬─────┘      └────┬─────┘      └────┬─────┘            │
│         │                 │                 │                   │
│         └────────┬────────┴────────┬────────┘                  │
│                  │                 │                            │
│         ┌────────┴───────┐ ┌──────┴──────┐                     │
│         │                │ │             │                      │
│         ▼                ▼ ▼             ▼                      │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                 │
│   │   Neon   │    │  Redis   │    │    R2    │                 │
│   │PostgreSQL│    │ (Upstash)│    │(Cloudflare│                 │
│   │          │    │          │    │          │                 │
│   │ 主数据库  │    │ 缓存/队列 │    │ 文件存储  │                 │
│   └──────────┘    └──────────┘    └──────────┘                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 请求生命周期

### 2.1 完整请求流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    API 请求生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 请求入口                                                    │
│  ┌─────────────┐                                                │
│  │ HTTP Request│                                                │
│  │ POST /api/v1/books/:id/progress                             │
│  │ Headers: Authorization: Bearer {jwt}                         │
│  │ Body: { position, progress }                                 │
│  └──────┬──────┘                                                │
│         │                                                        │
│  2. 中间件处理                                                  │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Middleware Chain                         ││
│  │                                                              ││
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           ││
│  │  │ Logger  │→│ CORS    │→│ Helmet  │→│ Rate    │           ││
│  │  │         │ │         │ │         │ │ Limit   │           ││
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  3. 认证守卫                                                    │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Auth Guard                               ││
│  │                                                              ││
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐                   ││
│  │  │ JWT     │ → │ Verify  │ → │ Attach  │                   ││
│  │  │ Extract │   │ Token   │   │ User    │                   ││
│  │  └─────────┘   └─────────┘   └─────────┘                   ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  4. 管道验证                                                    │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Validation Pipe                          ││
│  │                                                              ││
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐                   ││
│  │  │ Parse   │ → │ DTO     │ → │ Class   │                   ││
│  │  │ Params  │   │ Transform│   │ Validate│                   ││
│  │  └─────────┘   └─────────┘   └─────────┘                   ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  5. 控制器处理                                                  │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Controller                               ││
│  │                                                              ││
│  │  @Post(':id/progress')                                      ││
│  │  async updateProgress(@Param('id') id, @Body() dto)         ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  6. 服务层业务逻辑                                              │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Service Layer                            ││
│  │                                                              ││
│  │  ┌─────────────────────────────────────────────────────┐   ││
│  │  │  readingService.updateProgress(userId, bookId, dto) │   ││
│  │  │                                                      │   ││
│  │  │  1. 验证用户书籍关系                                 │   ││
│  │  │  2. 更新阅读进度                                     │   ││
│  │  │  3. 记录阅读会话                                     │   ││
│  │  │  4. 更新每日统计                                     │   ││
│  │  │  5. 检查成就解锁                                     │   ││
│  │  └─────────────────────────────────────────────────────┘   ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  7. 数据访问层                                                  │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Prisma ORM                               ││
│  │                                                              ││
│  │  prisma.userBook.update({                                   ││
│  │    where: { userId_bookId: { userId, bookId } },            ││
│  │    data: { progress, position, updatedAt }                  ││
│  │  })                                                         ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                                        │
│  8. 响应拦截器                                                  │
│         ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Response Interceptor                     ││
│  │                                                              ││
│  │  {                                                          ││
│  │    success: true,                                           ││
│  │    data: { ... },                                           ││
│  │    timestamp: "2025-12-31T..."                              ││
│  │  }                                                          ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心数据流

### 3.1 用户认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    用户认证数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Apple Sign In                                                  │
│       │                                                          │
│       │  identityToken                                          │
│       ▼                                                          │
│  ┌─────────────────┐                                            │
│  │  Auth Service   │                                            │
│  │                 │                                            │
│  │  1. 验证 Apple Token                                         │
│  │  2. 提取 Apple User ID                                       │
│  │  3. 查找/创建用户                                            │
│  │  4. 生成 JWT Token                                           │
│  └────────┬────────┘                                            │
│           │                                                      │
│    ┌──────┴──────┐                                              │
│    │             │                                              │
│    ▼             ▼                                              │
│  ┌──────┐   ┌──────────┐                                       │
│  │ Neon │   │  Redis   │                                       │
│  │      │   │          │                                       │
│  │ User │   │ Session  │                                       │
│  │ Data │   │ Cache    │                                       │
│  └──────┘   └──────────┘                                       │
│    │             │                                              │
│    └──────┬──────┘                                              │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │  Response       │                                            │
│  │                 │                                            │
│  │  { accessToken, │                                            │
│  │    refreshToken,│                                            │
│  │    user }       │                                            │
│  └─────────────────┘                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 书籍阅读数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                    书籍阅读数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  开始阅读                                                       │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  1. 获取书籍详情                                            ││
│  │     GET /books/:id                                          ││
│  │                                                              ││
│  │     ┌──────┐    ┌──────┐    ┌──────┐                       ││
│  │     │ Neon │───▶│Service│───▶│ R2   │                       ││
│  │     │      │    │      │    │      │                       ││
│  │     │ Book │    │ Build │    │ EPUB │                       ││
│  │     │ Data │    │ URLs  │    │ URL  │                       ││
│  │     └──────┘    └──────┘    └──────┘                       ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  2. 获取阅读进度                                            ││
│  │     GET /books/:id/progress                                 ││
│  │                                                              ││
│  │     ┌──────┐         ┌──────────┐                          ││
│  │     │ Neon │────────▶│ UserBook │                          ││
│  │     │      │         │          │                          ││
│  │     │      │         │ position │                          ││
│  │     │      │         │ progress │                          ││
│  │     └──────┘         └──────────┘                          ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  3. 下载 EPUB                                               ││
│  │     (iOS App 直接从 R2 下载)                                ││
│  │                                                              ││
│  │     ┌──────────┐              ┌──────────┐                 ││
│  │     │ iOS App  │─────────────▶│    R2    │                 ││
│  │     │          │  Signed URL  │          │                 ││
│  │     └──────────┘              └──────────┘                 ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  4. 阅读中持续同步                                          ││
│  │                                                              ││
│  │     ┌──────────┐    ┌──────────┐    ┌──────────┐           ││
│  │     │ 进度同步  │    │ 查词记录  │    │ 划线批注  │           ││
│  │     │          │    │          │    │          │           ││
│  │     │ 每5分钟  │    │ 实时      │    │ 实时      │           ││
│  │     └────┬─────┘    └────┬─────┘    └────┬─────┘           ││
│  │          │               │               │                  ││
│  │          └───────────────┼───────────────┘                  ││
│  │                          │                                   ││
│  │                          ▼                                   ││
│  │                    ┌──────────┐                             ││
│  │                    │   Neon   │                             ││
│  │                    │          │                             ││
│  │                    │UserBook  │                             ││
│  │                    │Vocabulary│                             ││
│  │                    │Highlight │                             ││
│  │                    └──────────┘                             ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  5. 结束阅读                                                ││
│  │     POST /reading-sessions                                  ││
│  │                                                              ││
│  │     ┌──────────────────────────────────────────────────────┐││
│  │     │  创建阅读会话记录                                     │││
│  │     │  ├── 计算阅读时长                                     │││
│  │     │  ├── 更新每日统计                                     │││
│  │     │  ├── 检查连续阅读天数                                 │││
│  │     │  └── 触发成就检查                                     │││
│  │     └──────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 AI 交互数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 服务数据流                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户查询单词/句子                                              │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────┐                                            │
│  │  AI Controller  │                                            │
│  │                 │                                            │
│  │  POST /ai/explain                                            │
│  │  { word, context, taskType }                                 │
│  └────────┬────────┘                                            │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    AI Router Service                        ││
│  │                                                              ││
│  │  1. 检查缓存                                                ││
│  │     ┌──────────┐                                            ││
│  │     │  Redis   │  Key: hash(word+context+taskType)          ││
│  │     │  Cache   │                                            ││
│  │     └────┬─────┘                                            ││
│  │          │                                                   ││
│  │          │  缓存命中?                                        ││
│  │          │                                                   ││
│  │     ┌────┴────┐                                             ││
│  │     │         │                                             ││
│  │    Yes       No                                             ││
│  │     │         │                                             ││
│  │     ▼         ▼                                             ││
│  │  返回缓存   继续处理                                        ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  2. 选择 AI 模型                                            ││
│  │                                                              ││
│  │     ┌─────────────────────────────────────────────────────┐ ││
│  │     │  Task Type         │  Model Selection              │ ││
│  │     ├─────────────────────────────────────────────────────┤ ││
│  │     │  WORD_EXPLAIN      │  DeepSeek (低成本)            │ ││
│  │     │  SENTENCE_SIMPLIFY │  DeepSeek                     │ ││
│  │     │  LITERARY_ANALYSIS │  Claude Sonnet (付费专属)     │ ││
│  │     │  CHAT              │  GPT-4o-mini                  │ ││
│  │     └─────────────────────────────────────────────────────┘ ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  3. 调用 AI Provider                                        ││
│  │                                                              ││
│  │     ┌─────────┐    ┌─────────┐    ┌─────────┐              ││
│  │     │DeepSeek │    │ OpenAI  │    │Anthropic│              ││
│  │     │         │    │         │    │         │              ││
│  │     │ Primary │───▶│Fallback │───▶│Fallback │              ││
│  │     └─────────┘    └─────────┘    └─────────┘              ││
│  │                                                              ││
│  │     降级策略: DeepSeek → GPT-4o-mini → Claude Haiku        ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  4. 后处理与记录                                            ││
│  │                                                              ││
│  │     ┌─────────────────────────────────────────────────────┐ ││
│  │     │  ├── 缓存结果到 Redis (TTL: 7天)                    │ ││
│  │     │  ├── 记录 AI 交互到 Neon                            │ ││
│  │     │  │   - input_tokens                                 │ ││
│  │     │  │   - output_tokens                                │ ││
│  │     │  │   - cost_usd                                     │ ││
│  │     │  │   - latency_ms                                   │ ││
│  │     │  └── 更新用户每日 AI 使用统计                       │ ││
│  │     └─────────────────────────────────────────────────────┘ ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │  Response       │                                            │
│  │                 │                                            │
│  │  { explanation, │                                            │
│  │    examples,    │                                            │
│  │    cached }     │                                            │
│  └─────────────────┘                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 后台任务数据流

### 4.1 BullMQ 任务队列

```
┌─────────────────────────────────────────────────────────────────┐
│                    后台任务处理流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  任务生产者 (API Pod)                                           │
│       │                                                          │
│       │  添加任务到队列                                         │
│       ▼                                                          │
│  ┌─────────────────┐                                            │
│  │     Redis       │                                            │
│  │   (BullMQ)      │                                            │
│  │                 │                                            │
│  │  ┌───────────┐  │                                            │
│  │  │ book-import│ │  书籍导入队列                              │
│  │  └───────────┘  │                                            │
│  │  ┌───────────┐  │                                            │
│  │  │ ai-batch  │  │  AI 批处理队列                             │
│  │  └───────────┘  │                                            │
│  │  ┌───────────┐  │                                            │
│  │  │ email     │  │  邮件发送队列                              │
│  │  └───────────┘  │                                            │
│  │  ┌───────────┐  │                                            │
│  │  │ analytics │  │  数据分析队列                              │
│  │  └───────────┘  │                                            │
│  │                 │                                            │
│  └────────┬────────┘                                            │
│           │                                                      │
│           │  消费任务                                           │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │  Workers Pod    │                                            │
│  │                 │                                            │
│  │  ┌───────────────────────────────────────────────────────┐  │
│  │  │  Job Processor                                        │  │
│  │  │                                                        │  │
│  │  │  1. 获取任务数据                                       │  │
│  │  │  2. 执行业务逻辑                                       │  │
│  │  │  3. 更新任务状态                                       │  │
│  │  │  4. 处理失败重试                                       │  │
│  │  └───────────────────────────────────────────────────────┘  │
│  │                 │                                            │
│  └─────────────────┘                                            │
│           │                                                      │
│    ┌──────┴──────┐                                              │
│    │             │                                              │
│    ▼             ▼                                              │
│  ┌──────┐   ┌──────────┐                                       │
│  │ Neon │   │    R2    │                                       │
│  │      │   │          │                                       │
│  │更新DB │   │ 上传文件 │                                       │
│  └──────┘   └──────────┘                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 定时任务数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                    定时任务数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Digital Ocean Droplet (Job Server)                             │
│       │                                                          │
│       │  Cron 触发                                              │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  书籍导入任务                                               ││
│  │                                                              ││
│  │  ┌───────────┐    ┌───────────┐    ┌───────────┐           ││
│  │  │ Standard  │───▶│  Parse    │───▶│  Upload   │           ││
│  │  │ Ebooks    │    │  EPUB     │    │  to R2    │           ││
│  │  └───────────┘    └───────────┘    └───────────┘           ││
│  │                         │               │                   ││
│  │                         ▼               ▼                   ││
│  │                   ┌───────────┐   ┌───────────┐            ││
│  │                   │ Analyze   │   │   Save    │            ││
│  │                   │ Difficulty│   │  to Neon  │            ││
│  │                   └───────────┘   └───────────┘            ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                                                          │
│       │  同步状态                                               │
│       ▼                                                          │
│  ┌─────────────────┐                                            │
│  │     Neon        │                                            │
│  │                 │                                            │
│  │  ImportBatch    │  记录导入批次                              │
│  │  Book           │  书籍数据                                  │
│  │  Chapter        │  章节数据                                  │
│  └─────────────────┘                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 缓存数据流

### 5.1 Redis 缓存策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    缓存层级设计                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L1: 内存缓存 (NestJS 进程内)                               ││
│  │                                                              ││
│  │  ├── 配置数据          TTL: 5分钟                           ││
│  │  ├── 功能开关          TTL: 1分钟                           ││
│  │  └── 热点书籍列表      TTL: 5分钟                           ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L2: Redis 缓存 (Upstash)                                   ││
│  │                                                              ││
│  │  Session 相关                                               ││
│  │  ├── session:{userId}           TTL: 7天                    ││
│  │  ├── refresh:{tokenId}          TTL: 30天                   ││
│  │  └── device:{deviceId}          TTL: 永久                   ││
│  │                                                              ││
│  │  AI 缓存                                                    ││
│  │  ├── ai:explain:{hash}          TTL: 7天                    ││
│  │  └── ai:analysis:{hash}         TTL: 30天                   ││
│  │                                                              ││
│  │  业务缓存                                                   ││
│  │  ├── book:detail:{id}           TTL: 1小时                  ││
│  │  ├── book:list:popular          TTL: 5分钟                  ││
│  │  ├── user:stats:{id}            TTL: 5分钟                  ││
│  │  └── leaderboard:{type}         TTL: 1分钟                  ││
│  │                                                              ││
│  │  限流计数                                                   ││
│  │  ├── rate:{userId}:{endpoint}   TTL: 1分钟                  ││
│  │  └── ai:daily:{userId}          TTL: 24小时                 ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L3: PostgreSQL (Neon)                                      ││
│  │                                                              ││
│  │  持久化数据存储                                             ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 缓存失效策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    缓存失效模式                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. TTL 过期                                                    │
│     └── 自动失效，无需主动清理                                  │
│                                                                  │
│  2. 主动失效 (Write-Through)                                    │
│     ┌──────────┐    ┌──────────┐    ┌──────────┐               │
│     │  Update  │───▶│  Delete  │───▶│  Write   │               │
│     │   DB     │    │  Cache   │    │   DB     │               │
│     └──────────┘    └──────────┘    └──────────┘               │
│                                                                  │
│  3. 延迟双删                                                    │
│     ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌────────┐│
│     │  Delete  │───▶│  Update  │───▶│  Sleep   │───▶│ Delete ││
│     │  Cache   │    │   DB     │    │  100ms   │    │ Cache  ││
│     └──────────┘    └──────────┘    └──────────┘    └────────┘│
│                                                                  │
│  4. 事件驱动失效                                                │
│     ┌──────────┐    ┌──────────┐    ┌──────────┐               │
│     │  Event   │───▶│  Queue   │───▶│ Invalidate│               │
│     │  Emit    │    │ (Redis)  │    │  Cache   │               │
│     └──────────┘    └──────────┘    └──────────┘               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 数据同步机制

### 6.1 跨设备数据同步

```
┌─────────────────────────────────────────────────────────────────┐
│                    跨设备同步流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  设备 A (iPhone)                   设备 B (iPad)                │
│       │                                  │                      │
│       │  更新阅读进度                     │                      │
│       ▼                                  │                      │
│  ┌─────────────┐                         │                      │
│  │ POST /sync  │                         │                      │
│  │             │                         │                      │
│  │ { changes:  │                         │                      │
│  │   [...],    │                         │                      │
│  │   lastSync  │                         │                      │
│  │ }           │                         │                      │
│  └──────┬──────┘                         │                      │
│         │                                │                      │
│         ▼                                │                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Sync Service                             ││
│  │                                                              ││
│  │  1. 接收设备 A 的变更                                       ││
│  │  2. 冲突检测 (基于时间戳)                                   ││
│  │  3. 合并变更到数据库                                        ││
│  │  4. 标记数据版本                                            ││
│  │                                                              ││
│  └─────────────────────────────────────────────────────────────┘│
│         │                                │                      │
│         │  同步完成通知                   │  定期拉取            │
│         │  (WebSocket/Push)              ▼                      │
│         │                         ┌─────────────┐               │
│         │                         │  GET /sync  │               │
│         │                         │             │               │
│         │                         │  { since:   │               │
│         │                         │    lastSync │               │
│         │                         │  }          │               │
│         │                         └──────┬──────┘               │
│         │                                │                      │
│         │                                ▼                      │
│         │                         ┌─────────────────┐           │
│         │                         │  Response       │           │
│         │                         │                 │           │
│         │                         │  { changes: [], │           │
│         │                         │    serverTime } │           │
│         │                         └─────────────────┘           │
│         │                                │                      │
│         ▼                                ▼                      │
│  设备 A 同步完成                  设备 B 应用变更               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 错误处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误处理数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  异常发生                                                       │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Exception Filter                         ││
│  │                                                              ││
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐       ││
│  │  │ HTTP Error  │   │ Validation  │   │ Business    │       ││
│  │  │ (4xx, 5xx)  │   │ Error       │   │ Error       │       ││
│  │  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘       ││
│  │         │                 │                 │               ││
│  │         └────────────────┬┴─────────────────┘               ││
│  │                          │                                   ││
│  │                          ▼                                   ││
│  │                 ┌─────────────────┐                         ││
│  │                 │  Error Handler  │                         ││
│  │                 │                 │                         ││
│  │                 │  1. 格式化错误   │                         ││
│  │                 │  2. 添加 requestId                        ││
│  │                 │  3. 脱敏处理     │                         ││
│  │                 └────────┬────────┘                         ││
│  │                          │                                   ││
│  └─────────────────────────────────────────────────────────────┘│
│           │                 │                                    │
│    ┌──────┴──────┐    ┌────┴────┐                              │
│    │             │    │         │                              │
│    ▼             ▼    ▼         ▼                              │
│ ┌──────┐    ┌──────┐  ┌──────┐  ┌──────────┐                  │
│ │Sentry│    │ Logs │  │Client│  │   Neon   │                  │
│ │      │    │      │  │      │  │          │                  │
│ │上报  │    │记录  │  │响应  │  │ErrorLog  │                  │
│ └──────┘    └──────┘  └──────┘  └──────────┘                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 监控数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控与可观测性                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  应用层                                                     ││
│  │                                                              ││
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                  ││
│  │  │ Metrics  │  │  Traces  │  │   Logs   │                  ││
│  │  │          │  │          │  │          │                  ││
│  │  │ 请求延迟 │  │ 调用链   │  │ 结构化   │                  ││
│  │  │ 错误率   │  │ 追踪     │  │ 日志     │                  ││
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘                  ││
│  │       │             │             │                         ││
│  └───────┼─────────────┼─────────────┼─────────────────────────┘│
│          │             │             │                          │
│          ▼             ▼             ▼                          │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐                    │
│  │ Fly.io   │   │  Sentry  │   │ Fly.io   │                    │
│  │ Metrics  │   │          │   │ Logs     │                    │
│  │          │   │ 错误追踪 │   │          │                    │
│  │ 系统指标 │   │ 性能监控 │   │ 日志聚合 │                    │
│  └────┬─────┘   └────┬─────┘   └────┬─────┘                    │
│       │              │              │                           │
│       └──────────────┼──────────────┘                           │
│                      │                                          │
│                      ▼                                          │
│              ┌──────────────┐                                   │
│              │  Dashboard   │                                   │
│              │              │                                   │
│              │  ├── 实时监控                                    │
│              │  ├── 告警通知                                    │
│              │  └── 历史分析                                    │
│              └──────────────┘                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [database.md](./database.md) | 数据库架构详解 |
| [cloudflare-r2.md](./cloudflare-r2.md) | R2 存储详解 |
| [backend-architecture.md](../api/backend-architecture.md) | 后端模块架构 |
| [jobs.md](./modules/jobs.md) | 后台任务模块 |
| [sync.md](./modules/sync.md) | 数据同步模块 |

---

*最后更新: 2025-12-31*

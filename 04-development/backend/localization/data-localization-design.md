# 数据本地化设计方案 (Data Localization)

> 版本：v1.3
> 创建日期：2025-12-28
> 最后更新：2026-01-01
> 状态：设计中

---

## 一、概述

### 1.1 背景与目标

根据用户手机系统语言，自动显示对应语言的内容。不仅是软件 UI 的国际化（i18n），更重要的是**数据层的本地化**——即发现 Tab、听书 Tab、城邦 Tab 等所有内容数据都能根据用户语言显示对应版本。

### 1.2 核心需求

| 需求             | 说明                                         |
| ---------------- | -------------------------------------------- |
| 系统语言感知     | 根据手机系统语言自动展示对应内容             |
| 数据多语言       | 书籍、作者、分类、推荐语等内容支持多语言版本 |
| 后端支持         | API 根据 Accept-Language 返回对应语言数据    |
| 数据库设计       | 支持存储和查询多语言内容                     |
| 回退机制         | 缺失某语言时优雅降级到默认语言               |
| 可扩展性         | 支持动态添加新语言，无需大幅修改表结构       |

### 1.3 内容范围

**重要前提：本应用收录的书籍均为公版书 (Public Domain)**，即版权已过期的经典文学作品。这意味着：

- 所有书籍都是广为人知的经典作品
- 中文译名、作者译名早已约定俗成
- 豆瓣、维基百科等数据源已有完整的中文翻译数据
- **无需依赖 AI 翻译生成书名/作者名**

### 1.4 前期支持语言

前期仅支持 **英文 + 中文（简/繁）**：

| 语言       | 代码                    | 优先级 | 说明                 |
| ---------- | ----------------------- | ------ | -------------------- |
| 英语       | `en`                    | P0     | 默认语言 + 回退      |
| 简体中文   | `zh-Hans` / `zh-CN`     | P0     | 主要市场             |
| 繁体中文   | `zh-Hant` / `zh-TW`     | P0     | 港澳台市场 (OpenCC转换) |

### 1.5 后续扩展语言 (全球 Top 10)

基于全球互联网用户使用语言排行，后续可扩展支持以下语言：

| 排名 | 语言       | 代码     | 优先级 | 说明                 |
| ---- | ---------- | -------- | ------ | -------------------- |
| 4    | 西班牙语   | `es`     | P1     | 拉美 + 西班牙        |
| 5    | 阿拉伯语   | `ar`     | P1     | 中东市场 (RTL)       |
| 6    | 葡萄牙语   | `pt`     | P1     | 巴西 + 葡萄牙        |
| 7    | 印尼语     | `id`     | P1     | 东南亚市场           |
| 8    | 法语       | `fr`     | P1     | 法国 + 非洲法语区    |
| 9    | 日语       | `ja`     | P1     | 日本市场             |
| 10   | 俄语       | `ru`     | P2     | 俄罗斯 + 独联体      |
| 11   | 德语       | `de`     | P2     | 德国 + 中欧          |
| 12   | 韩语       | `ko`     | P2     | 韩国市场             |

**语言特殊处理：**

| 语言     | 特殊处理                       |
| -------- | ------------------------------ |
| 阿拉伯语 | RTL (从右到左) 布局支持        |
| 简繁中文 | OpenCC 自动转换 + 人工校对     |

---

## 二、整体架构

### 2.1 系统架构图

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   iOS App   │  │ Android App │  │   Web App   │  │   Admin     │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │                │            │
│         └────────────────┴────────────────┴────────────────┘            │
│                                    │                                     │
│                     Accept-Language: zh-Hans                            │
│                                    ▼                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                              API 网关层                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Language Middleware                          │   │
│  │  - 解析 Accept-Language Header                                    │   │
│  │  - 标准化语言代码                                                  │   │
│  │  - 注入 context.locale                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                              服务层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  Books Service  │  │ Authors Service │  │ Content Service │         │
│  │                 │  │                 │  │                 │         │
│  │  getLocalized() │  │  getLocalized() │  │  getLocalized() │         │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
│           │                    │                    │                   │
│           └────────────────────┴────────────────────┘                   │
│                                │                                         │
│                                ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Localization Service                           │   │
│  │  - selectLocalizedField(entity, field, locale)                   │   │
│  │  - getFallbackChain(locale) → ['zh-Hans', 'en']                 │   │
│  │  - translateOnDemand(text, targetLocale) [可选]                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                         │
│                                ▼                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                              数据层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────┐  ┌───────────────────────────────┐  │
│  │         PostgreSQL            │  │           Redis               │  │
│  │  ┌─────────────────────────┐  │  │  ┌─────────────────────────┐  │  │
│  │  │   books (主表)          │  │  │  │   Localized Cache       │  │  │
│  │  │   - id, cover_url, etc  │  │  │  │   book:{id}:{locale}    │  │  │
│  │  └─────────────────────────┘  │  │  │   author:{id}:{locale}  │  │  │
│  │              │                │  │  └─────────────────────────┘  │  │
│  │              ▼                │  │                               │  │
│  │  ┌─────────────────────────┐  │  │                               │  │
│  │  │   translations (翻译表)  │  │  │                               │  │
│  │  │   - entity_type         │  │  │                               │  │
│  │  │   - entity_id           │  │  │                               │  │
│  │  │   - field_name          │  │  │                               │  │
│  │  │   - locale              │  │  │                               │  │
│  │  │   - value               │  │  │                               │  │
│  │  └─────────────────────────┘  │  │                               │  │
│  └───────────────────────────────┘  └───────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流示意图

```text
用户请求 (系统语言: 简体中文)
         │
         ▼
┌─────────────────────────────────────────┐
│  HTTP Request                           │
│  GET /api/books                         │
│  Accept-Language: zh-Hans,zh;q=0.9,en   │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  Language Middleware                    │
│  解析 → locale = 'zh-Hans'              │
│  注入 → request.locale = 'zh-Hans'     │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  Books Service                          │
│  1. 查询 books 表获取基础数据            │
│  2. JOIN translations 表获取翻译        │
│  3. 调用 LocalizationService 组装       │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  Response                               │
│  {                                      │
│    "id": "book-123",                    │
│    "title": "傲慢与偏见",                │
│    "author": "简·奥斯汀",                │
│    "description": "这是一部由简·奥斯汀..." │
│  }                                      │
└─────────────────────────────────────────┘
```

---

## 三、数据库设计

### 3.1 设计方案比较

| 方案                   | 优点                   | 缺点                   | 适用场景           |
| ---------------------- | ---------------------- | ---------------------- | ------------------ |
| **方案 A: 列扩展**     | 简单直接、查询高效     | 添加语言需改表结构     | 语言数量固定 (<5)  |
| **方案 B: JSON 字段**  | 灵活、无需改表         | 索引困难、查询复杂     | 翻译内容非关键查询 |
| **方案 C: 独立翻译表** | 标准化、可无限扩展     | JOIN 多、性能开销      | 大规模多语言 (>5)  |
| **方案 D: 混合方案**   | 平衡性能与扩展性       | 架构稍复杂             | 核心语言固定+扩展  |

### 3.2 推荐方案：方案 C (独立翻译表)

由于需要支持 **10+ 种语言**，且未来可能继续扩展，采用独立翻译表方案：

- 新增语言只需插入数据，无需修改表结构
- 翻译数据与主实体解耦，便于批量管理
- 支持翻译审核流程、版本控制
- 可针对翻译表单独优化索引和缓存

### 3.3 数据表结构

#### 3.3.1 translations 表 (核心翻译表)

| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Auto-generated primary key |
| entity_type | VARCHAR(50) | 实体类型 ('book', 'author', 'genre' 等) |
| entity_id | UUID | 关联实体的 ID |
| field_name | VARCHAR(50) | 翻译字段名 ('title', 'description', 'bio' 等) |
| locale | VARCHAR(10) | 目标语言代码 ('en', 'zh-Hans', 'ja' 等) |
| value | TEXT | 翻译内容 |
| source | VARCHAR(20) | 来源 (default: 'manual')，可选: 'ai', 'opencc' |
| status | VARCHAR(20) | 状态 (default: 'draft')，可选: 'reviewed', 'published' |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |
| created_by | UUID | 翻译者/审核者 |

**唯一约束:** (entity_type, entity_id, field_name, locale)

**索引:**

| Index | Columns | Purpose |
|-------|---------|---------|
| idx_translations_entity | entity_type, entity_id | 实体查询 |
| idx_translations_locale | locale | 语言查询 |
| idx_translations_lookup | entity_type, entity_id, locale | 复合查询优化 |

#### supported_locales 表 (配置)

| Column | Type | Description |
|--------|------|-------------|
| locale | VARCHAR(10) (PK) | 语言代码 |
| name | VARCHAR(50) | 显示名称 |
| native_name | VARCHAR(50) | 原生名称 |
| is_rtl | BOOLEAN | RTL 标记 |
| fallback_locale | VARCHAR(10) | 回退语言 |
| is_active | BOOLEAN | 是否启用 |
| sort_order | INT | 排序 |

初始化数据包含 12 种语言: en, zh-Hans, zh-Hant, es, ar, pt, id, fr, ja, ru, de, ko

#### 3.3.2 books 表 (主表保留英文默认值)

| Column | Type | 本地化 | Description |
|--------|------|--------|-------------|
| id | UUID (PK) | - | 主键 |
| title | VARCHAR(500) | 是 | 英文书名 (默认值) |
| author | VARCHAR(255) | 是 | 英文作者名 (默认值) |
| description | TEXT | 是 | 英文简介 (默认值) |
| cover_url | VARCHAR(500) | 否 | 封面 URL |
| difficulty_score | DECIMAL(3,1) | 否 | 难度评分 |
| word_count | INT | 否 | 字数 |
| chapter_count | INT | 否 | 章节数 |

#### 3.3.3 authors 表

| Column | Type | 本地化 | Description |
|--------|------|--------|-------------|
| id | UUID (PK) | - | 主键 |
| name | VARCHAR(255) | 是 | 英文名 (默认值) |
| bio | TEXT | 是 | 英文简介 (默认值) |
| avatar_url | VARCHAR(500) | 否 | 头像 URL |
| birth_year | INT | 否 | 出生年份 |
| death_year | INT | 否 | 逝世年份 |
| nationality | VARCHAR(50) | 否 | 国籍 |

#### 3.3.4 genres 表 (分类)

| Column | Type | 本地化 | Description |
|--------|------|--------|-------------|
| id | UUID (PK) | - | 主键 |
| slug | VARCHAR(50) UNIQUE | 否 | URL 标识 (e.g., 'adventure') |
| name | VARCHAR(100) | 是 | 英文名称 (默认值) |
| description | TEXT | 是 | 英文描述 |
| icon | VARCHAR(50) | 否 | 图标 |
| sort_order | INT | 否 | 排序 |

### 3.4 Prisma Schema

Prisma models 定义在 `packages/database/prisma/schema.prisma` 中。核心本地化相关模型:

| Model | Table | Key Fields | Description |
|-------|-------|------------|-------------|
| Translation | translations | entityType, entityId, fieldName, locale, value, source, status | 核心翻译表 |
| SupportedLocale | supported_locales | locale, name, nativeName, isRtl, fallbackLocale | 语言配置表 |
| Book | books | title, author, description (英文默认值) | 书籍主表 |
| Author | authors | name, bio (英文默认值) | 作者主表 |
| Genre | genres | slug, name, description (英文默认值) | 分类主表 |

所有主表字段存储英文内容作为默认值，其他语言翻译通过 Translation 模型关联。

### 3.5 查询模式

#### 获取本地化书籍

查询流程: 从 books 表获取基础数据 (英文)，然后 LEFT JOIN translations 表获取 title、author、description 三个字段的目标语言翻译，使用 COALESCE 实现回退 (翻译不存在时使用英文原值)。

查询条件包括: entity_type = 'book', 目标 entity_id, 各 field_name, 以及目标 locale。

---

## 四、数据生成与填充

### 4.1 数据来源可行性评估

由于本应用收录的均为**公版书 (经典文学)**，我们对 10 本代表性书籍进行了多语言数据可用性测试：

#### 4.1.1 样本书籍测试结果 (英文 + 中文)

| 书籍 | 书名 zh | 作者名 zh | 简介 zh | 作者Bio zh | 数据来源 | 质量 |
|------|---------|----------|---------|-----------|----------|------|
| Pride and Prejudice | 傲慢与偏见 ✅ | 简·奥斯汀 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| 1984 | 一九八四 ✅ | 乔治·奥威尔 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| The Great Gatsby | 了不起的盖茨比 ✅ | 菲茨杰拉德 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| Harry Potter 1 | 哈利·波特与魔法石 ✅ | J.K.罗琳 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| The Little Prince | 小王子 ✅ | 圣埃克苏佩里 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| To Kill a Mockingbird | 杀死一只知更鸟 ✅ | 哈珀·李 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| 100 Years of Solitude | 百年孤独 ✅ | 马尔克斯 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| Norwegian Wood | 挪威的森林 ✅ | 村上春树 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| The Alchemist | 牧羊少年奇幻之旅 ✅ | 保罗·柯艾略 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |
| The Kite Runner | 追风筝的人 ✅ | 卡勒德·胡赛尼 ✅ | ✅ 完整 | ✅ 详细 | 豆瓣/维基 | 高 |

#### 4.1.2 各字段覆盖率汇总 (公版书 + EN/ZH)

| 字段 | 数据来源 | 公版书覆盖率 | 质量 | AI翻译需求 |
|------|----------|-------------|------|-----------|
| **书名 (title)** | 豆瓣, Wikidata, 维基 | **~100%** | 高 | **几乎不需要** |
| **作者名 (author)** | 豆瓣, Wikidata, 维基 | **~100%** | 高 | **几乎不需要** |
| **书籍简介 (description)** | 豆瓣 (summary) | **95%+** | 高 | < 5% |
| **作者简介 (bio)** | 豆瓣 (author_intro), 维基 | **95%+** | 高 | < 5% |
| **繁体中文** | OpenCC 自动转换 | **~100%** | 中-高 | 不需要 |

#### 4.1.3 评估结论

| 场景 | 数据来源层覆盖 | AI翻译需求 |
|------|---------------|-----------|
| 公版书 (经典文学) | **95-100%** | **< 5%** |
| 书名 + 作者名 | **~100%** | **几乎不需要** |
| 书籍简介 | **95%+** | 仅缺失字段补充 |
| 作者简介 | **95%+** | 仅缺失字段补充 |

**结论：对于公版书，数据来源层可满足绝大部分需求，AI翻译仅作为极少数缺失数据的补充机制。**

### 4.2 数据生成流程总览

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                      数据生成与填充流程 (公版书优化版)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                   1. 数据来源层 (主要来源, 覆盖95%+)                    │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                       │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│  │  │  Wikidata   │  │   豆瓣读书   │  │  中文维基    │  │ Open Library│  │ │
│  │  │  (多语言标签)│  │(简介/作者Bio)│  │  (作者Bio)  │  │ (书籍元数据)│  │ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  │ │
│  │         │                │                │                │         │ │
│  │         └────────────────┴────────────────┴────────────────┘         │ │
│  │                                  │                                    │ │
│  │                           覆盖率: 95%+                                │ │
│  └──────────────────────────────────┼────────────────────────────────────┘ │
│                                     ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                   2. 简繁转换层 (OpenCC)                               │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │  简体中文 → 繁体中文自动转换，覆盖率: ~100%                             │ │
│  └──────────────────────────────────┼────────────────────────────────────┘ │
│                                     ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                   3. AI 翻译层 (仅补充, <5%)                           │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │  仅用于: 数据来源层缺失的字段 (如部分书籍简介/作者简介)                  │ │
│  │  触发条件: 书籍入库时检测到缺失字段                                     │ │
│  └──────────────────────────────────┼────────────────────────────────────┘ │
│                                     ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                   4. 审核与入库层                                      │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│  │  │  质量检查    │→ │  人工审核    │→ │  批量入库    │→ │  缓存更新   │  │ │
│  │  │  (自动)     │  │  (仅AI生成)  │  │  (DB写入)   │  │  (Redis)   │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 数据来源策略

| 来源类型         | 适用内容               | 优先级 | 覆盖率 | 质量 |
| ---------------- | ---------------------- | ------ | ------ | ---- |
| **Wikidata**     | 书名、作者名 (多语言)  | 最高   | ~100%  | 高   |
| **豆瓣读书**     | 中文书名、简介、作者Bio | 最高   | 95%+   | 高   |
| **中文维基百科** | 作者简介               | 高     | 90%+   | 高   |
| **Open Library** | 英文原版信息、ISBN     | 高     | 95%+   | 高   |
| **OpenCC 转换**  | 简体→繁体中文          | 高     | ~100%  | 中-高|
| **AI 翻译**      | 缺失字段补充           | 低     | < 5%   | 中   |

### 4.4 AI 翻译补充 (仅用于缺失字段)

> **注意：由于公版书数据来源覆盖率 95%+，AI 翻译仅作为补充机制，预计使用率 < 5%**

#### 4.4.1 触发条件

仅当以下条件**同时满足**时才触发 AI 翻译：

1. 数据来源层 (豆瓣/维基/Wikidata) 未找到对应翻译
2. 该字段为必填字段 (如书籍简介)
3. 书籍已通过人工审核确认需要翻译

#### 4.4.2 AI 翻译 API 选择

| API | 适用场景 | 优先级 |
|-----|---------|--------|
| DeepL | 书籍简介、作者简介 | 首选 |
| Claude/GPT-4 | 复杂内容、需要理解上下文 | 备选 |

#### 4.4.3 翻译后处理

- AI 生成内容标记 `source = 'ai'`, `status = 'draft'`
- 需人工审核后方可发布 (`status = 'published'`)

### 4.5 简繁转换 (OpenCC)

```text
┌─────────────────────────────────────────────────────────────────┐
│                  OpenCC Conversion Pipeline                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: zh-Hans 翻译                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  title: "傲慢与偏见"                                     │   │
│  │  author: "简·奥斯汀"                                     │   │
│  │  description: "这是一部由简·奥斯汀于1813年创作的..."     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  Step 1: OpenCC 基础转换                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  opencc -c s2twp  (简体 → 繁体台湾)                      │   │
│  │                                                          │   │
│  │  title: "傲慢與偏見"                                     │   │
│  │  author: "簡·奧斯汀"                                     │   │
│  │  description: "這是一部由簡·奧斯汀於1813年創作的..."     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  Step 2: 专有名词修正                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  词汇映射表:                                              │   │
│  │  - "软件" → "軟體"                                       │   │
│  │  - "信息" → "資訊"                                       │   │
│  │  - "网络" → "網路"                                       │   │
│  │  (书籍领域暂无特殊映射)                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  Step 3: 入库                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  INSERT INTO translations                                │   │
│  │  (entity_type, entity_id, field_name, locale, value,    │   │
│  │   source, status)                                        │   │
│  │  VALUES ('book', ?, 'title', 'zh-Hant', '傲慢與偏見',    │   │
│  │          'opencc', 'draft')                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.5 批量填充脚本

#### 4.5.1 填充流程

```text
┌─────────────────────────────────────────────────────────────────┐
│                   Batch Translation Job                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  定时任务: 每日 02:00 AM                                         │
│                                                                 │
│  Step 1: 获取待翻译内容                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  -- 热门书籍优先                                         │   │
│  │  SELECT b.* FROM books b                                 │   │
│  │  LEFT JOIN translations t ON ...                         │   │
│  │  WHERE t.id IS NULL                                      │   │
│  │  ORDER BY b.read_count DESC                             │   │
│  │  LIMIT 100                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  Step 2: 按优先级翻译                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  P0 语言: zh-Hans, zh-Hant, en                          │   │
│  │  P1 语言: es, ar, pt, id, fr, ja                        │   │
│  │  P2 语言: ru, de, ko                                    │   │
│  │                                                          │   │
│  │  for each book:                                          │   │
│  │    for each missing_locale in priority_order:            │   │
│  │      generate_translation(book, missing_locale)          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  Step 3: 生成报告                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  {                                                       │   │
│  │    "date": "2025-12-28",                                │   │
│  │    "processed": 100,                                     │   │
│  │    "translations_added": 850,                            │   │
│  │    "errors": 3,                                          │   │
│  │    "coverage": {                                         │   │
│  │      "zh-Hans": "92%",                                  │   │
│  │      "zh-Hant": "91%",                                  │   │
│  │      "ja": "45%"                                         │   │
│  │    }                                                     │   │
│  │  }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.6 数据质量保障

| 检查项           | 规则                               | 处理方式       |
| ---------------- | ---------------------------------- | -------------- |
| 长度异常         | 翻译长度 > 原文 3 倍               | 标记待审核     |
| 空翻译           | value 为空或只有空格               | 拒绝入库       |
| 重复检测         | 与已有翻译完全相同                 | 跳过           |
| 编码检查         | 非 UTF-8 字符                      | 转码或拒绝     |
| 敏感词过滤       | 包含敏感词汇                       | 标记待审核     |

---

## 五、后端实现

### 5.1 语言中间件

```text
┌────────────────────────────────────────────────────────┐
│                 Language Middleware                     │
├────────────────────────────────────────────────────────┤
│                                                        │
│   输入: Accept-Language: zh-Hans,zh;q=0.9,en;q=0.8    │
│                        │                               │
│                        ▼                               │
│   ┌──────────────────────────────────────────┐        │
│   │  1. 解析 Accept-Language Header          │        │
│   │     → ['zh-Hans', 'zh', 'en']            │        │
│   └──────────────────────────────────────────┘        │
│                        │                               │
│                        ▼                               │
│   ┌──────────────────────────────────────────┐        │
│   │  2. 标准化语言代码                        │        │
│   │     'zh-CN' → 'zh-Hans'                  │        │
│   │     'zh-TW' → 'zh-Hant'                  │        │
│   │     'zh' + 地区判断 → 'zh-Hans'/'zh-Hant'│        │
│   └──────────────────────────────────────────┘        │
│                        │                               │
│                        ▼                               │
│   ┌──────────────────────────────────────────┐        │
│   │  3. 验证是否为支持语言                    │        │
│   │     查询 supported_locales 表             │        │
│   │     不支持 → 回退到 'en'                  │        │
│   └──────────────────────────────────────────┘        │
│                        │                               │
│                        ▼                               │
│   ┌──────────────────────────────────────────┐        │
│   │  4. 构建回退链                            │        │
│   │     zh-Hant → ['zh-Hant', 'zh-Hans', 'en']│        │
│   │     ar → ['ar', 'en']                    │        │
│   └──────────────────────────────────────────┘        │
│                        │                               │
│                        ▼                               │
│   ┌──────────────────────────────────────────┐        │
│   │  5. 注入到请求上下文                      │        │
│   │     request.locale = 'zh-Hans'           │        │
│   │     request.fallbackChain = [...]        │        │
│   │     request.isRtl = false                │        │
│   └──────────────────────────────────────────┘        │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 5.2 本地化服务

```text
┌─────────────────────────────────────────────────────────────────┐
│                     LocalizationService                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  getLocalizedEntity(entityType, entityId, locale)       │    │
│  │                                                         │    │
│  │  1. 从缓存查询: book:{id}:{locale}                      │    │
│  │  2. 缓存未命中 → 查询 translations 表                   │    │
│  │  3. 按回退链依次查找                                     │    │
│  │  4. 组装本地化实体                                       │    │
│  │  5. 写入缓存                                             │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  getTranslation(entityType, entityId, field, locale)    │    │
│  │                                                         │    │
│  │  SELECT value FROM translations                         │    │
│  │  WHERE entity_type = ? AND entity_id = ?               │    │
│  │    AND field_name = ? AND locale IN (fallback_chain)   │    │
│  │  ORDER BY CASE locale                                   │    │
│  │    WHEN 'zh-Hans' THEN 1                               │    │
│  │    WHEN 'en' THEN 2                                    │    │
│  │  END                                                    │    │
│  │  LIMIT 1                                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 API 响应格式

#### 5.3.1 客户端 API (返回本地化内容)

**请求:** GET /api/books/123 (Accept-Language: zh-Hans)

客户端 API 根据 Accept-Language header 返回对应语言的本地化字段 (title, author, description 等)。非本地化字段 (coverUrl, difficulty 等) 不受语言影响。

#### 5.3.2 管理后台 API (返回所有翻译)

**请求:** GET /api/admin/books/123/translations

管理后台 API 返回实体所有语言的翻译版本。每个字段下按 locale 分组，包含 value、source、status 三个属性。英文值直接来自主表，其他语言来自 translations 表。

---

## 六、各模块本地化内容清单

### 6.1 发现页 (Discover Tab)

| 内容类型     | 本地化字段              | 优先级    |
| ------------ | ----------------------- | --------- |
| 板块标题     | title, subtitle         | P0        |
| 书籍卡片     | title, author, description | P0     |
| 分类标签     | genre name              | P0        |
| 难度标签     | difficulty label        | P0        |
| 编辑推荐语   | recommendation text     | P1        |
| 搜索建议词   | search suggestions      | P1        |

### 6.2 听书页 (Audiobook Tab)

| 内容类型     | 本地化字段              | 优先级    |
| ------------ | ----------------------- | --------- |
| 书籍信息     | title, author, description | P0     |
| 播放器标签   | UI labels               | P0 (UI 层)|
| 章节标题     | **保持英文** (学习内容) | -         |
| 朗读内容     | **保持英文** (学习内容) | -         |

### 6.3 城邦页 (Agora Tab)

| 内容类型     | 本地化字段              | 优先级    |
| ------------ | ----------------------- | --------- |
| 板块标题     | section titles          | P0 (UI 层)|
| 用户帖子     | **保持原始语言** (UGC)  | -         |
| 引用书名     | book title (本地化)     | P1        |
| 话题标签     | **保持原始** (UGC)      | -         |
| 系统通知     | notification text       | P1        |

### 6.4 书架页 (Library Tab)

| 内容类型     | 本地化字段              | 优先级    |
| ------------ | ----------------------- | --------- |
| 书籍信息     | title, author           | P0        |
| 分组标签     | group labels            | P0 (UI 层)|
| 阅读进度     | progress format         | P0 (UI 层)|

### 6.5 个人中心 (Me Tab)

| 内容类型     | 本地化字段              | 优先级    |
| ------------ | ----------------------- | --------- |
| 统计标签     | stat labels             | P0 (UI 层)|
| 成就名称     | achievement titles      | P1        |
| 成就描述     | achievement descriptions| P1        |
| 勋章名称     | medal names             | P1        |

---

## 七、翻译工作流

### 7.1 翻译管道

```text
┌─────────────────────────────────────────────────────────────────────┐
│                         翻译工作流                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │
│  │   内容录入   │ →  │   翻译队列   │ →  │   翻译生成   │             │
│  │  (英文原文)  │    │  (待翻译)    │    │ (AI/爬虫)   │             │
│  └─────────────┘    └─────────────┘    └─────────────┘             │
│         │                  │                  │                     │
│         ▼                  ▼                  ▼                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │
│  │  主表入库    │    │  优先级排序   │    │   质量检查   │             │
│  │  title (en) │    │  热门书籍优先 │    │  自动校验   │             │
│  └─────────────┘    └─────────────┘    └─────────────┘             │
│                            │                  │                     │
│                            │                  ▼                     │
│                            │          ┌─────────────┐              │
│                            │          │  人工审核    │              │
│                            │          │  (热门内容)  │              │
│                            │          └─────────────┘              │
│                            │                  │                     │
│                            │                  ▼                     │
│                            │          ┌─────────────┐              │
│                            └────────→ │ translations │              │
│                                       │    表入库    │              │
│                                       └─────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 翻译优先级

| 优先级 | 内容类型            | 说明                   |
| ------ | ------------------- | ---------------------- |
| P0     | 热门书籍 (Top 100)  | 阅读量/收藏量排名前 100|
| P0     | 精选书籍            | 编辑推荐、首页展示     |
| P1     | 新上架书籍          | 最近 30 天上架         |
| P1     | 知名作者            | 关注量 > 1000          |
| P2     | 长尾书籍            | 其他所有书籍           |
| P2     | 历史作者            | 关注量 < 1000          |

### 7.3 翻译质量标准

| 维度         | 标准                                         |
| ------------ | -------------------------------------------- |
| 书名翻译     | 优先使用通行中文译名，无官方译名时音译/意译  |
| 作者名翻译   | 使用通用中文译名，参考维基百科               |
| 简介翻译     | 准确传达原意，语言流畅，符合目标语言习惯     |
| 一致性       | 同一作者/系列保持译名一致                    |

---

## 八、缓存策略

### 8.1 缓存架构

```text
┌─────────────────────────────────────────────────────────────────┐
│                         缓存层级                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  L1: 客户端缓存                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - HTTP Cache-Control                                   │   │
│  │  - max-age=3600 (1小时)                                 │   │
│  │  - Vary: Accept-Language                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  L2: CDN 缓存                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - 按语言分别缓存                                        │   │
│  │  - Cache Key: url + locale                              │   │
│  │  - TTL: 24小时                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  L3: Redis 缓存                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - 本地化实体缓存                                        │   │
│  │  - Key: book:{id}:{locale}                             │   │
│  │  - TTL: 1小时                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  L4: 数据库                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - PostgreSQL                                           │   │
│  │  - 索引优化                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 缓存键设计

| 缓存类型     | Key 格式                       | TTL      |
| ------------ | ------------------------------ | -------- |
| 书籍详情     | `book:{id}:{locale}`           | 1 小时   |
| 书籍列表     | `books:list:{page}:{locale}`   | 15 分钟  |
| 作者详情     | `author:{id}:{locale}`         | 1 小时   |
| 分类列表     | `genres:{locale}`              | 24 小时  |
| 发现页板块   | `discover:{section}:{locale}`  | 15 分钟  |

### 8.3 缓存失效策略

| 触发条件         | 失效操作                       |
| ---------------- | ------------------------------ |
| 翻译更新         | 删除对应实体所有语言缓存       |
| 内容更新         | 删除对应实体所有语言缓存       |
| 新增语言支持     | 无需操作，惰性填充             |

---

## 九、监控与质量保障

### 9.1 翻译覆盖率监控

```text
┌─────────────────────────────────────────────────────────────────┐
│                    翻译覆盖率 Dashboard                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  总书籍数: 10,000                                               │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  简体中文 (zh-Hans)                                    │     │
│  │  ████████████████████████████████████████░░░░ 85%    │     │
│  │  已翻译: 8,500 / 缺失: 1,500                          │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  繁体中文 (zh-Hant)                                    │     │
│  │  ████████████████████████████████░░░░░░░░░░ 70%      │     │
│  │  已翻译: 7,000 / 缺失: 3,000                          │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  西班牙语 (es)                                         │     │
│  │  ██████████████████░░░░░░░░░░░░░░░░░░░░░░░░ 40%      │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
│  ┌───────────────────────────────────────────────────────┐     │
│  │  日语 (ja)                                             │     │
│  │  ████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░ 35%      │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 缺失翻译日志

客户端在请求本地化内容时，如遇到回退情况，系统记录 WARNING 级别日志，包含以下信息:

| 日志字段 | 说明 |
|----------|------|
| entityType | 实体类型 (book, author 等) |
| entityId | 实体 ID |
| field | 缺失翻译的字段名 |
| requestedLocale | 请求的语言 |
| fallbackLocale | 实际回退到的语言 |
| originalValue | 回退后返回的原始值 |

### 9.3 告警规则

| 指标                     | 阈值       | 告警级别  |
| ------------------------ | ---------- | --------- |
| 热门书籍翻译覆盖率       | < 95%      | Critical  |
| P0 语言整体覆盖率        | < 80%      | Warning   |
| P1 语言整体覆盖率        | < 50%      | Info      |
| 翻译回退率 (24h)         | > 10%      | Warning   |
| 新增未翻译内容 (24h)     | > 100 条   | Info      |

---

## 十、实施计划

### Phase 1: 基础设施 (P0)

| 任务 | 说明                                     |
| ---- | ---------------------------------------- |
| 1.1  | 创建 translations 表和 supported_locales 表 |
| 1.2  | 实现 Language Middleware                 |
| 1.3  | 实现 LocalizationService                 |
| 1.4  | 更新现有 API 支持本地化响应              |

### Phase 2: 核心内容 (P0)

| 任务 | 说明                                     |
| ---- | ---------------------------------------- |
| 2.1  | 维基百科/豆瓣数据爬取 (热门书籍)         |
| 2.2  | AI 翻译生成 Pipeline 开发                |
| 2.3  | OpenCC 简繁转换集成                      |
| 2.4  | 热门书籍 (Top 100) 中文翻译填充          |

### Phase 3: 扩展语言 (P1)

| 任务 | 说明                                     |
| ---- | ---------------------------------------- |
| 3.1  | 西班牙语、葡萄牙语翻译生成               |
| 3.2  | 日语、法语翻译生成                       |
| 3.3  | 阿拉伯语翻译 + RTL 支持                  |
| 3.4  | 印尼语翻译生成                           |

### Phase 4: 质量与监控 (P1)

| 任务 | 说明                                     |
| ---- | ---------------------------------------- |
| 4.1  | 翻译覆盖率监控 Dashboard                 |
| 4.2  | 缺失翻译告警系统                         |
| 4.3  | 翻译质量审核流程                         |
| 4.4  | 批量翻译任务调度系统                     |

---

## 十一、FAQ

### Q1: 为什么选择独立翻译表而不是列扩展？

- 支持 10+ 种语言，列扩展会导致 30+ 列，表结构臃肿
- 新增语言只需插入数据，无需 ALTER TABLE
- 翻译数据可独立管理、审核、版本控制
- 便于实现翻译工作流和质量监控

### Q2: 繁体中文和简体中文能自动转换吗？

- 使用 OpenCC 工具自动转换基础词汇
- 专有名词、习惯用语需人工校对
- 转换后标记 source = 'opencc', status = 'draft'
- 热门内容需人工审核后发布

### Q3: AI 生成的翻译质量如何保证？

- 使用 GPT-4/Claude 等高质量模型
- 提供详细的翻译指南和上下文
- 热门内容必须人工审核
- 长尾内容可直接发布，用户反馈后修正

### Q4: 如何处理新增的语言支持？

1. 在 supported_locales 表添加新语言配置
2. 配置回退链 (fallback_locale)
3. 启动批量翻译任务
4. 无需修改代码或表结构

### Q5: RTL 语言 (如阿拉伯语) 如何处理？

- supported_locales 表标记 is_rtl = true
- 前端根据 isRtl 标记调整布局方向
- 翻译内容无特殊处理，保持文本方向

---

## 十二、客户端本地化原则

### 12.1 核心原则：客户端不维护数据翻译表

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                        本地化职责分工                                     │
├───────────────────────────────────┬─────────────────────────────────────┤
│           服务端                   │              客户端                  │
├───────────────────────────────────┼─────────────────────────────────────┤
│  ✅ 数据本地化                     │  ✅ UI 本地化                        │
│  - 书籍标题 (title)               │  - 按钮文字                          │
│  - 作者名 (author)                │  - 导航标签                          │
│  - 书籍简介 (description)         │  - 提示信息                          │
│  - 作者简介 (bio)                 │  - 错误消息                          │
│  - 分类名称 (genre name)          │  - 设置选项                          │
│  - 发现页 Tab 名称 (tab name)      │  - 状态文字                          │
│  - 难度等级标签                    │                                     │
├───────────────────────────────────┼─────────────────────────────────────┤
│  📍 存储位置: translations 表      │  📍 存储位置: Localizable.xcstrings │
│                                   │              strings.xml            │
├───────────────────────────────────┼─────────────────────────────────────┤
│  🔄 传递方式: Accept-Language     │  🔄 传递方式: 系统语言自动匹配       │
│              header               │                                     │
└───────────────────────────────────┴─────────────────────────────────────┘
```

### 12.2 客户端实现规范

#### 12.2.1 直接使用服务端返回数据

客户端**不应该**：
- 在本地翻译文件中存储 `genre.*`、`discoverTab.*` 等数据翻译
- 使用客户端翻译表对服务端返回的数据进行二次翻译
- 维护数据到翻译 key 的映射表

客户端**应该**：
- 直接使用服务端返回的已本地化字段
- 仅使用翻译文件存储纯 UI 文案

#### 12.2.2 客户端实现要点

- 直接使用服务端返回的 name 字段 (已本地化)，不查本地翻译表
- 直接使用服务端返回的 genres 数组 (已本地化)，不做客户端翻译
- 不应在客户端构造翻译 key 去查本地翻译文件 (如 "discoverTab.xxx".localized)

### 12.3 Localizable.xcstrings 内容规范

| 应该包含              | 不应该包含            |
| -------------------- | -------------------- |
| 按钮文字              | 书籍标题翻译          |
| 导航栏标题            | 作者名翻译            |
| Tab 栏标签            | 分类名称翻译          |
| 提示/错误消息         | 发现页 Tab 名翻译     |
| 设置项文字            | 难度等级翻译          |
| 空状态文字            | 任何来自 API 的数据   |
| 确认/取消等通用文字   |                      |

---

## 相关文档

- [UI 语言策略](../product/ui-language-strategy.md)
- [iOS i18n 设计](../ios/i18n-design.md)
- [模块 i18n](../modules/i18n.md)

---

## 更新日志

### v1.3 (2026-01-01)

- **新增"客户端本地化原则"章节**：明确客户端不维护数据翻译表
- 添加服务端与客户端职责分工表
- 添加客户端实现规范与示例代码
- 添加 Localizable.xcstrings 内容规范

### v1.2 (2025-12-28)

- 明确内容范围为**公版书 (经典文学)**
- 新增 10 本样本书籍的多语言数据可用性测试
- 新增各字段 (书名/作者名/简介/Bio) 覆盖率评估
- **大幅弱化 AI 翻译层**：基于评估结果，数据来源层覆盖率 95%+，AI 翻译仅作为补充 (<5%)
- 前期仅支持英文 + 中文 (简/繁)，后续可扩展至全球 Top 10
- 优化数据生成流程图：突出数据来源层为主要来源

### v1.1 (2025-12-28)

- 扩展支持语言至全球 Top 10 (12 种语言)
- 更新设计方案为独立翻译表 (方案 C)
- 新增"数据生成与填充"章节
- 新增 AI 翻译生成流程
- 新增 OpenCC 简繁转换流程
- 新增批量填充脚本设计
- 新增数据质量保障规则

### v1.0 (2025-12-28)

- 初始版本，支持 5 种语言
- 列扩展方案设计

---

*最后更新: 2026-01-01*

# 徽章模块 (Badges)

> 成就系统、徽章解锁、进度追踪

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        徽章模块                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  徽章分类 (6 类)                                                 │
│  ├── reading       阅读成就                                     │
│  ├── vocabulary    词汇成就                                     │
│  ├── streak        连续打卡                                     │
│  ├── milestone     里程碑                                       │
│  ├── special       特殊成就                                     │
│  └── author        作者相关                                     │
│                                                                  │
│  徽章等级 (4 级)                                                 │
│  ├── bronze        铜牌                                         │
│  ├── silver        银牌                                         │
│  ├── gold          金牌                                         │
│  └── platinum      铂金                                         │
│                                                                  │
│  徽章总数: 23 个                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 徽章定义

### 2.1 阅读成就 (Reading)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| first_book | 初读者 | 完成第 1 本书 | bronze |
| bookworm | 书虫 | 完成 5 本书 | silver |
| avid_reader | 阅读达人 | 完成 20 本书 | gold |
| reading_master | 阅读大师 | 完成 50 本书 | platinum |

### 2.2 词汇成就 (Vocabulary)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| word_collector | 词汇收集者 | 学习 100 个单词 | bronze |
| vocabulary_builder | 词汇建设者 | 学习 500 个单词 | silver |
| word_master | 词汇大师 | 学习 2000 个单词 | gold |
| lexicon_legend | 词汇传奇 | 学习 5000 个单词 | platinum |

### 2.3 连续打卡 (Streak)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| week_streak | 周打卡 | 连续 7 天阅读 | bronze |
| month_streak | 月打卡 | 连续 30 天阅读 | silver |
| quarter_streak | 季打卡 | 连续 90 天阅读 | gold |
| year_streak | 年打卡 | 连续 365 天阅读 | platinum |

### 2.4 里程碑 (Milestone)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| first_hour | 首小时 | 累计阅读 1 小时 | bronze |
| day_reader | 日阅读者 | 累计阅读 24 小时 | silver |
| week_reader | 周阅读者 | 累计阅读 168 小时 | gold |
| marathon_reader | 马拉松读者 | 累计阅读 500 小时 | platinum |

### 2.5 特殊成就 (Special)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| early_bird | 早起鸟 | 连续 7 天早晨阅读 | silver |
| night_owl | 夜猫子 | 连续 7 天深夜阅读 | silver |
| genre_explorer | 类型探索者 | 阅读 5 种不同类型 | silver |
| classic_lover | 经典爱好者 | 完成 10 本经典名著 | gold |

### 2.6 作者相关 (Author)

| 徽章 ID | 名称 | 条件 | 等级 |
|---------|------|------|------|
| author_fan | 作者粉丝 | 完成同一作者 3 本书 | bronze |
| author_devotee | 作者信徒 | 完成同一作者 5 本书 | silver |
| author_expert | 作者专家 | 完成同一作者 10 本书 | gold |

---

## 3. 数据模型

### Badge 表结构 (定义表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 徽章 ID (如 first_book) |
| name | String | 徽章名称 |
| nameZh | String? | 中文名称 |
| description | String | 描述 |
| descriptionZh | String? | 中文描述 |
| category | Enum | 分类 |
| tier | Enum | 等级 |
| iconUrl | String | 图标 URL |
| requirement | JSON | 解锁条件 |
| points | Int | 积分值 |
| isActive | Boolean | 是否启用 |

### UserBadge 表结构 (用户已获得)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| userId | UUID | 用户 ID |
| badgeId | String | 徽章 ID |
| unlockedAt | DateTime | 解锁时间 |
| progress | JSON? | 解锁时的进度快照 |

### BadgeProgress 表结构 (进度追踪)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| userId | UUID | 用户 ID |
| badgeId | String | 徽章 ID |
| currentValue | Int | 当前进度值 |
| targetValue | Int | 目标值 |
| lastUpdatedAt | DateTime | 最后更新 |

---

## 4. API 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /badges | 获取所有徽章定义 |
| GET | /badges/:id | 获取徽章详情 |
| GET | /badges/user | 获取用户徽章列表 |
| GET | /badges/user/progress | 获取用户徽章进度 |
| GET | /badges/user/recent | 获取最近获得的徽章 |

### 响应结构

#### UserBadgesDto

| 字段 | 类型 | 说明 |
|------|------|------|
| unlocked | BadgeWithDateDto[] | 已解锁徽章 |
| inProgress | BadgeProgressDto[] | 进行中徽章 |
| locked | BadgeDto[] | 未解锁徽章 |
| totalPoints | number | 总积分 |
| unlockedCount | number | 已解锁数量 |

---

## 5. 核心功能

### 5.1 进度追踪

```
┌─────────────────────────────────────────────────────────────────┐
│                    徽章进度追踪流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户完成阅读/学习行为                                           │
│       │                                                          │
│       ▼                                                          │
│  1. 触发事件 (如: book_completed, word_learned)                 │
│       │                                                          │
│       ▼                                                          │
│  2. 更新相关徽章进度                                             │
│     ├── 阅读完成 → 更新 reading 类徽章                          │
│     ├── 词汇学习 → 更新 vocabulary 类徽章                       │
│     └── 连续打卡 → 更新 streak 类徽章                           │
│       │                                                          │
│       ▼                                                          │
│  3. 检查是否达成解锁条件                                         │
│       │                                                          │
│       ├── 未达成 → 更新 BadgeProgress                           │
│       │                                                          │
│       └── 已达成 → 执行解锁                                      │
│               │                                                  │
│               ▼                                                  │
│           创建 UserBadge 记录                                    │
│               │                                                  │
│               ▼                                                  │
│           推送解锁通知                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 解锁条件检查

```
┌─────────────────────────────────────────────────────────────────┐
│                    解锁条件示例                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  徽章: bookworm (书虫)                                          │
│  requirement: { type: "books_completed", value: 5 }             │
│       │                                                          │
│       ▼                                                          │
│  检查: COUNT(reading_sessions WHERE completed = true) >= 5      │
│                                                                  │
│  ──────────────────────────────────────────────────────────────  │
│                                                                  │
│  徽章: week_streak (周打卡)                                     │
│  requirement: { type: "consecutive_days", value: 7 }            │
│       │                                                          │
│       ▼                                                          │
│  检查: 连续 7 天有阅读记录 (无间断)                              │
│                                                                  │
│  ──────────────────────────────────────────────────────────────  │
│                                                                  │
│  徽章: genre_explorer (类型探索者)                              │
│  requirement: { type: "unique_categories", value: 5 }           │
│       │                                                          │
│       ▼                                                          │
│  检查: COUNT(DISTINCT category) >= 5 FROM completed_books       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 等级与积分

| 等级 | 基础积分 | 颜色 |
|------|----------|------|
| bronze | 10 | #CD7F32 |
| silver | 25 | #C0C0C0 |
| gold | 50 | #FFD700 |
| platinum | 100 | #E5E4E2 |

---

## 6. 事件触发

### 6.1 触发事件列表

| 事件 | 触发条件 | 相关徽章类别 |
|------|----------|--------------|
| book_completed | 完成一本书 | reading, milestone |
| word_learned | 学习新单词 | vocabulary |
| daily_reading | 当日阅读 | streak |
| reading_duration | 阅读时长累计 | milestone |
| category_explored | 阅读新分类 | special |
| author_book_completed | 完成某作者作品 | author |

### 6.2 事件处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    事件处理架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ReadingService                   BadgesService                 │
│       │                                │                        │
│       │  emit('book_completed')        │                        │
│       │ ─────────────────────────────> │                        │
│       │                                │                        │
│       │                          handleBookCompleted()          │
│       │                                │                        │
│       │                          updateProgress()               │
│       │                                │                        │
│       │                          checkAndUnlock()               │
│       │                                │                        │
│       │                          notifyIfUnlocked()             │
│       │                                │                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 通知与展示

### 7.1 解锁通知

```
┌─────────────────────────────────────────────────────────────────┐
│                    徽章解锁弹窗                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│         ┌─────────────────────────────────────┐                 │
│         │                                     │                 │
│         │         🎉 恭喜获得徽章！            │                 │
│         │                                     │                 │
│         │           ┌─────────┐               │                 │
│         │           │  🏅     │               │                 │
│         │           │ 书虫    │               │                 │
│         │           └─────────┘               │                 │
│         │                                     │                 │
│         │      完成阅读 5 本书籍              │                 │
│         │                                     │                 │
│         │         +25 积分                    │                 │
│         │                                     │                 │
│         │         [ 分享 ]  [ 确定 ]          │                 │
│         │                                     │                 │
│         └─────────────────────────────────────┘                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 进度展示

```
┌─────────────────────────────────────────────────────────────────┐
│                    徽章进度卡片                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  📖 阅读达人                                  Gold 🥇   │    │
│  │                                                         │    │
│  │  完成 20 本书籍                                         │    │
│  │                                                         │    │
│  │  ████████████████░░░░░░░░░░░░░░░  12/20                │    │
│  │                                        60%              │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [tracking.md](tracking.md) | 行为追踪 |
| [annual-report.md](annual-report.md) | 年度报告 |
| [medal-system.md](../../modules/medal-system.md) | 勋章系统 |

---

*最后更新: 2025-12-31*

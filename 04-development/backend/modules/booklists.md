# 书单模块 (Booklists)

> 书单管理、编辑精选、AI 个性化推荐

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        书单模块                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  书单类型                                                        │
│  ├── EDITORS_PICK      编辑精选                                 │
│  ├── ANNUAL_BEST       年度最佳                                 │
│  ├── UNIVERSITY        大学书单                                 │
│  ├── CELEBRITY         名人推荐                                 │
│  ├── RANKING           榜单                                     │
│  └── AI_RECOMMENDED    AI 个性化推荐                            │
│                                                                  │
│  核心功能                                                        │
│  ├── 书单 CRUD                                                  │
│  ├── 书单内书籍排序                                              │
│  ├── AI 个性化推荐生成                                           │
│  └── 书单封面自动生成                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型

### BookList 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| title | String | 书单标题 |
| titleZh | String? | 中文标题 |
| description | String? | 描述 |
| descriptionZh | String? | 中文描述 |
| type | Enum | 书单类型 |
| coverUrl | String? | 封面图 URL |
| isPublished | Boolean | 是否发布 |
| sortOrder | Int | 排序权重 |
| metadata | JSON? | 扩展元数据 |
| creatorId | UUID? | 创建者 (名人/大学等) |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

### BookListItem 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| bookListId | UUID | 书单 ID |
| bookId | UUID | 书籍 ID |
| sortOrder | Int | 在书单内排序 |
| note | String? | 推荐语 |
| addedAt | DateTime | 添加时间 |

---

## 3. 书单类型详解

### 3.1 类型定义

| 类型 | 说明 | 创建方式 | 示例 |
|------|------|----------|------|
| EDITORS_PICK | 编辑精选 | 运营手动 | "本周编辑推荐" |
| ANNUAL_BEST | 年度最佳 | 运营手动 | "2024 年度好书" |
| UNIVERSITY | 大学书单 | 运营手动 | "哈佛大学推荐书单" |
| CELEBRITY | 名人推荐 | 运营手动 | "比尔盖茨 2024 推荐" |
| RANKING | 榜单 | 系统生成 | "本周热门 Top 10" |
| AI_RECOMMENDED | AI 推荐 | AI 生成 | "为你推荐" |

### 3.2 类型展示位置

```
┌─────────────────────────────────────────────────────────────────┐
│                    首页书单展示                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  📚 为你推荐 (AI_RECOMMENDED)                           │    │
│  │  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐                         │    │
│  │  │ 📖 │ │ 📖 │ │ 📖 │ │ 📖 │ │ 📖 │  → 横向滚动         │    │
│  │  └───┘ └───┘ └───┘ └───┘ └───┘                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ⭐ 编辑精选 (EDITORS_PICK)                             │    │
│  │  ┌───┐ ┌───┐ ┌───┐ ┌───┐                               │    │
│  │  │ 📖 │ │ 📖 │ │ 📖 │ │ 📖 │                            │    │
│  │  └───┘ └───┘ └───┘ └───┘                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🏫 哈佛大学书单 (UNIVERSITY)                           │    │
│  │  ...                                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. API 端点

### 公开端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /booklists | 获取书单列表 |
| GET | /booklists/:id | 获取书单详情 |
| GET | /booklists/:id/books | 获取书单内书籍 |
| GET | /booklists/for-you | 获取 AI 推荐书单 |

### 管理端点 (Admin)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /booklists | 创建书单 |
| PATCH | /booklists/:id | 更新书单 |
| DELETE | /booklists/:id | 删除书单 |
| POST | /booklists/:id/books | 添加书籍到书单 |
| DELETE | /booklists/:id/books/:bookId | 从书单移除书籍 |
| PATCH | /booklists/:id/books/reorder | 重排书籍顺序 |

### 查询参数

| 参数 | 类型 | 说明 |
|------|------|------|
| type | Enum? | 书单类型过滤 |
| isPublished | boolean? | 发布状态过滤 |
| page | number | 页码 |
| limit | number | 每页数量 |

---

## 5. AI 个性化推荐

### 5.1 推荐流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 个性化推荐流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户请求 /booklists/for-you                                    │
│       │                                                          │
│       ▼                                                          │
│  1. 收集用户阅读数据                                             │
│     ├── 阅读历史 (最近 30 本)                                    │
│     ├── 阅读完成率                                               │
│     ├── 收藏书籍                                                 │
│     ├── 词汇学习偏好                                             │
│     └── 用户 CEFR 等级                                          │
│       │                                                          │
│       ▼                                                          │
│  2. 构建 Prompt                                                 │
│     ├── 用户画像                                                 │
│     ├── 已读书籍列表                                             │
│     └── 推荐要求                                                 │
│       │                                                          │
│       ▼                                                          │
│  3. 调用 AI 服务 (DeepSeek)                                     │
│       │                                                          │
│       ▼                                                          │
│  4. 解析 AI 返回                                                │
│     ├── 推荐书籍 ID 列表                                         │
│     └── 推荐理由                                                 │
│       │                                                          │
│       ▼                                                          │
│  5. 构建个性化书单                                               │
│       │                                                          │
│       ▼                                                          │
│  6. 缓存结果 (TTL: 24h)                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 推荐因子

| 因子 | 权重 | 说明 |
|------|------|------|
| 阅读历史相似度 | 高 | 基于已读书籍推荐类似 |
| CEFR 等级匹配 | 高 | 难度适配 |
| 分类偏好 | 中 | 偏好的书籍分类 |
| 作者偏好 | 中 | 喜欢的作者的其他作品 |
| 热门程度 | 低 | 平台热门书籍 |
| 新书优先 | 低 | 新入库书籍 |

### 5.3 推荐去重

```
┌─────────────────────────────────────────────────────────────────┐
│                    推荐去重规则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  排除以下书籍:                                                   │
│  ├── 用户已读完的书籍                                            │
│  ├── 用户正在阅读的书籍                                          │
│  ├── 用户明确标记"不感兴趣"的书籍                                │
│  ├── 最近 7 天已推荐过的书籍                                     │
│  └── 用户书架中的书籍                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 榜单自动生成

### 6.1 榜单类型

| 榜单 | 生成频率 | 数据来源 |
|------|----------|----------|
| 本周热门 | 每周一 | 过去 7 天阅读量 |
| 本月热门 | 每月 1 日 | 过去 30 天阅读量 |
| 新书榜 | 每天 | 最近 30 天入库 |
| 好评榜 | 每周 | 用户评分加权 |

### 6.2 生成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    榜单自动生成                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  定时任务触发                                                    │
│       │                                                          │
│       ▼                                                          │
│  1. 查询统计数据                                                 │
│     ├── 阅读会话数                                               │
│     ├── 阅读总时长                                               │
│     └── 用户评分                                                 │
│       │                                                          │
│       ▼                                                          │
│  2. 计算综合得分                                                 │
│     score = reads * 0.4 + duration * 0.3 + rating * 0.3        │
│       │                                                          │
│       ▼                                                          │
│  3. 取 Top N 书籍                                               │
│       │                                                          │
│       ▼                                                          │
│  4. 更新榜单书单                                                 │
│       │                                                          │
│       ▼                                                          │
│  5. 清除缓存                                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 缓存策略

| 数据类型 | 缓存 Key | TTL | 说明 |
|----------|----------|-----|------|
| 书单列表 | `booklists:list:{type}` | 30 分钟 | 按类型缓存 |
| 书单详情 | `booklists:detail:{id}` | 1 小时 | 单个书单 |
| AI 推荐 | `booklists:ai:{userId}` | 24 小时 | 个性化推荐 |
| 榜单 | `booklists:ranking:{type}` | 1 小时 | 榜单数据 |

---

## 8. 元数据结构

### 不同类型书单的 metadata

| 类型 | metadata 字段 | 说明 |
|------|---------------|------|
| UNIVERSITY | universityName, country | 大学名、国家 |
| CELEBRITY | celebrityName, bio, avatarUrl | 名人信息 |
| ANNUAL_BEST | year | 年份 |
| RANKING | period, algorithm | 周期、算法 |
| AI_RECOMMENDED | generatedAt, factors | 生成时间、推荐因子 |

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [categories.md](categories.md) | 分类模块 |
| [recommendations.md](recommendations.md) | 推荐系统 |
| [ai-services-architecture.md](../../ai/ai-services-architecture.md) | AI 服务 |

---

*最后更新: 2025-12-31*

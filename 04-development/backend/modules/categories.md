# 分类模块 (Categories)

> 书籍分类管理、多级联动、分类树

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        分类模块                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心功能                                                        │
│  ├── 多级分类树 (最多 3 级)                                      │
│  ├── 级联选择器数据                                              │
│  ├── 分类下书籍列表                                              │
│  └── 多语言分类名                                                │
│                                                                  │
│  分类层级示例                                                    │
│  ├── Fiction (小说)                                             │
│  │   ├── Romance (言情)                                         │
│  │   │   ├── Historical Romance                                 │
│  │   │   └── Contemporary Romance                               │
│  │   └── Science Fiction (科幻)                                 │
│  │       ├── Space Opera                                        │
│  │       └── Cyberpunk                                          │
│  └── Non-Fiction (非小说)                                       │
│      └── ...                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型

### Category 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | String | 分类名 (英文) |
| nameZh | String? | 中文名 |
| slug | String | URL 友好标识 |
| parentId | UUID? | 父分类 ID |
| level | Int | 层级 (1/2/3) |
| sortOrder | Int | 排序权重 |
| bookCount | Int | 书籍数量 (缓存) |
| isActive | Boolean | 是否启用 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

### 关联关系

```
┌─────────────────────────────────────────────────────────────────┐
│                    分类关系图                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Category (self-referencing)                                    │
│       │                                                          │
│       ├── parent: Category?     (parentId → id)                 │
│       └── children: Category[]  (id ← parentId)                 │
│                                                                  │
│  Category ←──→ Book (多对多)                                    │
│       │                                                          │
│       └── BookCategory (中间表)                                 │
│            ├── bookId                                           │
│            └── categoryId                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. API 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /categories | 获取分类列表 |
| GET | /categories/tree | 获取分类树 |
| GET | /categories/cascade | 级联选择器数据 |
| GET | /categories/:id | 获取分类详情 |
| GET | /categories/:id/books | 获取分类下书籍 |
| POST | /categories | 创建分类 (Admin) |
| PATCH | /categories/:id | 更新分类 (Admin) |
| DELETE | /categories/:id | 删除分类 (Admin) |

### 查询参数

| 参数 | 类型 | 说明 |
|------|------|------|
| parentId | UUID? | 过滤父分类 |
| level | number? | 过滤层级 |
| language | string? | 语言过滤 (en/zh) |
| includeInactive | boolean? | 包含禁用分类 |

---

## 4. 核心功能

### 4.1 分类树

```
┌─────────────────────────────────────────────────────────────────┐
│                    getCategoryTree 返回结构                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [                                                               │
│    {                                                             │
│      id: "uuid-1",                                              │
│      name: "Fiction",                                           │
│      nameZh: "小说",                                            │
│      level: 1,                                                  │
│      bookCount: 245,                                            │
│      children: [                                                │
│        {                                                        │
│          id: "uuid-2",                                          │
│          name: "Romance",                                       │
│          nameZh: "言情",                                        │
│          level: 2,                                              │
│          bookCount: 89,                                         │
│          children: [                                            │
│            {                                                    │
│              id: "uuid-3",                                      │
│              name: "Historical Romance",                        │
│              level: 3,                                          │
│              bookCount: 34,                                     │
│              children: []                                       │
│            }                                                    │
│          ]                                                      │
│        }                                                        │
│      ]                                                          │
│    }                                                            │
│  ]                                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 级联选择器

```
┌─────────────────────────────────────────────────────────────────┐
│                    级联选择器交互流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户选择第一级                                                  │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │  Fiction    │  ← 选中                                        │
│  │  Non-Fiction│                                                │
│  │  Children   │                                                │
│  └─────────────┘                                                │
│       │                                                          │
│       ▼                                                          │
│  加载第二级 (parentId = Fiction.id)                             │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │  Romance    │  ← 选中                                        │
│  │  Sci-Fi     │                                                │
│  │  Mystery    │                                                │
│  └─────────────┘                                                │
│       │                                                          │
│       ▼                                                          │
│  加载第三级 (parentId = Romance.id)                             │
│       │                                                          │
│       ▼                                                          │
│  ┌──────────────────────┐                                       │
│  │  Historical Romance  │  ← 最终选择                           │
│  │  Contemporary Romance│                                       │
│  └──────────────────────┘                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 分类下书籍

| 参数 | 类型 | 说明 |
|------|------|------|
| page | number | 页码 |
| limit | number | 每页数量 |
| sortBy | string | 排序字段 |
| order | asc/desc | 排序方向 |
| includeSubcategories | boolean | 包含子分类书籍 |

```
┌─────────────────────────────────────────────────────────────────┐
│                    includeSubcategories 逻辑                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  getCategoryBooks(categoryId, includeSubcategories=true)        │
│       │                                                          │
│       ▼                                                          │
│  1. 获取当前分类 ID                                              │
│       │                                                          │
│       ▼                                                          │
│  2. 递归获取所有子分类 ID                                        │
│       │                                                          │
│       ▼                                                          │
│  3. 查询书籍: categoryId IN [当前ID, ...子分类ID]               │
│       │                                                          │
│       ▼                                                          │
│  4. 返回去重后的书籍列表                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 缓存策略

| 数据类型 | 缓存 Key | TTL | 说明 |
|----------|----------|-----|------|
| 分类树 | `categories:tree:{lang}` | 1 小时 | 完整树结构 |
| 级联数据 | `categories:cascade:{parentId}` | 1 小时 | 子分类列表 |
| 分类详情 | `categories:detail:{id}` | 30 分钟 | 单个分类 |
| 书籍计数 | `categories:count:{id}` | 10 分钟 | bookCount |

### 缓存失效

| 触发条件 | 失效范围 |
|----------|----------|
| 创建分类 | 清除所有分类缓存 |
| 更新分类 | 清除该分类及其父级缓存 |
| 删除分类 | 清除所有分类缓存 |
| 书籍分类变更 | 清除相关分类的计数缓存 |

---

## 6. 书籍计数更新

```
┌─────────────────────────────────────────────────────────────────┐
│                    bookCount 更新流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  书籍添加到分类                                                  │
│       │                                                          │
│       ▼                                                          │
│  1. 更新当前分类 bookCount + 1                                  │
│       │                                                          │
│       ▼                                                          │
│  2. 递归更新父分类 bookCount + 1                                │
│       │                                                          │
│       ▼                                                          │
│  3. 清除相关缓存                                                 │
│                                                                  │
│  书籍从分类移除                                                  │
│       │                                                          │
│       ▼                                                          │
│  1. 更新当前分类 bookCount - 1                                  │
│       │                                                          │
│       ▼                                                          │
│  2. 递归更新父分类 bookCount - 1                                │
│       │                                                          │
│       ▼                                                          │
│  3. 清除相关缓存                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 多语言支持

| 字段 | 语言 | 用途 |
|------|------|------|
| name | English | 默认显示、URL slug |
| nameZh | 中文 | 中文界面显示 |

### 语言选择逻辑

```
┌─────────────────────────────────────────────────────────────────┐
│                    显示名称选择                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  getDisplayName(category, userLanguage)                         │
│       │                                                          │
│       ├── userLanguage = 'zh' && nameZh 存在                    │
│       │       └── 返回 nameZh                                   │
│       │                                                          │
│       └── 其他情况                                               │
│               └── 返回 name (英文)                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [books.md](books.md) | 书籍模块 |
| [booklists.md](booklists.md) | 书单模块 |

---

*最后更新: 2025-12-31*

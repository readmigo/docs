# 健康检查模块 (Health)

> 服务健康检查、依赖状态监控、运维端点

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        健康检查模块                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  检查项目                                                        │
│  ├── Database        PostgreSQL 连接状态                        │
│  ├── Redis           Redis 连接状态                             │
│  ├── Storage         Cloudflare R2 存储状态                     │
│  └── Memory          内存使用情况                                │
│                                                                  │
│  使用场景                                                        │
│  ├── Fly.io 健康检查     容器存活检测                            │
│  ├── 负载均衡            流量分配依据                            │
│  ├── 监控告警            状态异常通知                            │
│  └── 运维排查            快速定位问题                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. API 端点

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | /health | 简单健康检查 | 无 |
| GET | /health/live | 存活检查 | 无 |
| GET | /health/ready | 就绪检查 | 无 |
| GET | /health/detail | 详细健康状态 | Admin |

---

## 3. 检查类型

### 3.1 简单检查 (/health)

```
┌─────────────────────────────────────────────────────────────────┐
│                    /health 响应                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HTTP 200 OK                                                    │
│  {                                                              │
│    "status": "ok",                                              │
│    "timestamp": "2025-12-31T10:00:00.000Z"                     │
│  }                                                              │
│                                                                  │
│  用途: 最简检查, 仅确认服务进程运行                              │
│  耗时: < 1ms                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 存活检查 (/health/live)

```
┌─────────────────────────────────────────────────────────────────┐
│                    /health/live 响应                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HTTP 200 OK                                                    │
│  {                                                              │
│    "status": "ok",                                              │
│    "uptime": 3600,                                              │
│    "memory": {                                                  │
│      "used": 256,                                               │
│      "total": 512,                                              │
│      "percentage": 50                                           │
│    }                                                            │
│  }                                                              │
│                                                                  │
│  用途: 容器存活检测, 内存泄漏监控                                │
│  耗时: < 5ms                                                    │
│  Fly.io 配置: 每 10 秒检查一次                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 就绪检查 (/health/ready)

```
┌─────────────────────────────────────────────────────────────────┐
│                    /health/ready 响应                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HTTP 200 OK (全部就绪)                                         │
│  {                                                              │
│    "status": "ok",                                              │
│    "checks": {                                                  │
│      "database": { "status": "ok", "latency": 5 },             │
│      "redis": { "status": "ok", "latency": 2 }                 │
│    }                                                            │
│  }                                                              │
│                                                                  │
│  HTTP 503 Service Unavailable (有依赖不可用)                    │
│  {                                                              │
│    "status": "error",                                           │
│    "checks": {                                                  │
│      "database": { "status": "ok", "latency": 5 },             │
│      "redis": { "status": "error", "error": "Connection timeout" }│
│    }                                                            │
│  }                                                              │
│                                                                  │
│  用途: 流量接入判断, 滚动部署                                    │
│  耗时: < 100ms                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 详细检查 (/health/detail)

```
┌─────────────────────────────────────────────────────────────────┐
│                    /health/detail 响应                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  HTTP 200 OK                                                    │
│  {                                                              │
│    "status": "ok",                                              │
│    "environment": "production",                                 │
│    "version": "1.2.3",                                          │
│    "uptime": 86400,                                             │
│    "timestamp": "2025-12-31T10:00:00.000Z",                    │
│    "checks": {                                                  │
│      "database": {                                              │
│        "status": "ok",                                          │
│        "latency": 5,                                            │
│        "connections": { "active": 10, "idle": 5, "max": 20 }   │
│      },                                                         │
│      "redis": {                                                 │
│        "status": "ok",                                          │
│        "latency": 2,                                            │
│        "memory": { "used": "50MB", "peak": "100MB" }           │
│      },                                                         │
│      "storage": {                                               │
│        "status": "ok",                                          │
│        "latency": 50,                                           │
│        "bucket": "readmigo-assets-production"                   │
│      }                                                          │
│    },                                                           │
│    "memory": {                                                  │
│      "rss": 256,                                                │
│      "heapTotal": 200,                                          │
│      "heapUsed": 150,                                           │
│      "external": 10                                             │
│    }                                                            │
│  }                                                              │
│                                                                  │
│  用途: 运维诊断, 性能分析                                        │
│  认证: 需要 Admin 权限                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 检查逻辑

### 4.1 数据库检查

```
┌─────────────────────────────────────────────────────────────────┐
│                    Database 健康检查                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  checkDatabase()                                                │
│       │                                                          │
│       ▼                                                          │
│  1. 执行 SELECT 1 查询                                          │
│       │                                                          │
│       ▼                                                          │
│  2. 记录响应时间 (latency)                                      │
│       │                                                          │
│       ▼                                                          │
│  3. 获取连接池状态 (可选)                                        │
│       │                                                          │
│       ▼                                                          │
│  4. 返回结果                                                     │
│     ├── latency < 100ms → status: ok                            │
│     ├── latency < 500ms → status: degraded                      │
│     └── timeout/error   → status: error                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Redis 检查

```
┌─────────────────────────────────────────────────────────────────┐
│                    Redis 健康检查                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  checkRedis()                                                   │
│       │                                                          │
│       ▼                                                          │
│  1. 执行 PING 命令                                              │
│       │                                                          │
│       ▼                                                          │
│  2. 验证返回 PONG                                               │
│       │                                                          │
│       ▼                                                          │
│  3. 获取 INFO memory (详细检查)                                 │
│       │                                                          │
│       ▼                                                          │
│  4. 返回结果                                                     │
│     ├── PONG 正常 → status: ok                                  │
│     └── 超时/错误 → status: error                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 存储检查

```
┌─────────────────────────────────────────────────────────────────┐
│                    Storage (R2) 健康检查                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  checkStorage()                                                 │
│       │                                                          │
│       ▼                                                          │
│  1. 执行 HEAD 请求到 R2 Bucket                                  │
│     (检查 bucket 是否可访问)                                     │
│       │                                                          │
│       ▼                                                          │
│  2. 记录响应时间                                                 │
│       │                                                          │
│       ▼                                                          │
│  3. 返回结果                                                     │
│     ├── HTTP 200/404 → status: ok (bucket 存在)                 │
│     └── 超时/5xx    → status: error                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Fly.io 配置

### 5.1 fly.toml 健康检查配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    Fly.io 健康检查配置                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [http_service]                                                 │
│    internal_port = 3000                                         │
│                                                                  │
│  [http_service.concurrency]                                     │
│    type = "connections"                                         │
│    hard_limit = 500                                             │
│    soft_limit = 200                                             │
│                                                                  │
│  [[http_service.checks]]                                        │
│    interval = "10s"       每 10 秒检查一次                      │
│    timeout = "5s"         超时时间 5 秒                         │
│    grace_period = "30s"   启动后 30 秒开始检查                  │
│    method = "GET"                                               │
│    path = "/health/ready"                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 检查失败处理

| 失败次数 | 处理方式 |
|----------|----------|
| 1-2 次 | 继续接收流量, 记录警告 |
| 3 次 | 停止接收新流量 |
| 5 次 | 重启容器 |

---

## 6. 状态码说明

| HTTP 状态码 | 含义 | 触发条件 |
|-------------|------|----------|
| 200 | 健康 | 所有检查通过 |
| 503 | 不可用 | 任一关键依赖失败 |
| 500 | 内部错误 | 检查过程异常 |

### 关键依赖 vs 非关键依赖

| 依赖 | 级别 | 影响 |
|------|------|------|
| Database | 关键 | 失败返回 503 |
| Redis | 关键 | 失败返回 503 |
| Storage | 非关键 | 失败仅标记 degraded |

---

## 7. 监控集成

### 7.1 Sentry 集成

| 场景 | 处理 |
|------|------|
| 检查超时 | 发送 Warning |
| 检查失败 | 发送 Error |
| 连续失败 | 发送 Critical Alert |

### 7.2 指标上报

| 指标 | 类型 | 说明 |
|------|------|------|
| health_check_latency | Histogram | 检查耗时分布 |
| health_check_status | Gauge | 当前状态 (1=ok, 0=error) |
| database_connections | Gauge | 数据库连接数 |
| redis_memory_used | Gauge | Redis 内存使用 |

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [fly-io-architecture.md](../../infrastructure/fly-io-architecture.md) | Fly.io 部署 |
| [monitoring.md](../../infrastructure/monitoring.md) | 监控系统 |

---

*最后更新: 2025-12-31*

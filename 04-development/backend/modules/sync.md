# 同步模块 (Sync)

> 跨设备阅读/收听进度同步、章节映射

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        同步模块                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心功能                                                        │
│  ├── 阅读进度同步 (电子书)                                        │
│  ├── 收听进度同步 (有声书)                                        │
│  ├── 章节映射 (电子书 ↔ 有声书)                                   │
│  └── 位置转换 (阅读位置 ↔ 收听位置)                               │
│                                                                  │
│  核心挑战                                                        │
│  ├── 电子书章节 ≠ 有声书章节 (数量/边界不同)                       │
│  ├── 不同版本章节划分差异                                         │
│  └── 实时同步 vs 最终一致性                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 同步架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    跨设备同步流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Device A (iOS)              Server                Device B     │
│        │                        │                      │         │
│        │  POST /sync/progress   │                      │         │
│        │ ─────────────────────> │                      │         │
│        │  {bookId, chapterIdx,  │                      │         │
│        │   position, type}      │                      │         │
│        │                        │                      │         │
│        │                        │  (存储/合并)          │         │
│        │                        │                      │         │
│        │                        │  GET /sync/progress  │         │
│        │                        │ <─────────────────── │         │
│        │                        │                      │         │
│        │                        │  返回最新进度         │         │
│        │                        │ ───────────────────> │         │
│        │                        │                      │         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据模型

### SyncProgress 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| userId | UUID | 用户 ID |
| bookId | UUID | 书籍 ID |
| chapterIndex | Int | 当前章节索引 |
| position | Float | 章节内位置 (0.0-1.0) |
| type | Enum | READING / LISTENING |
| deviceId | String? | 最后更新设备 |
| updatedAt | DateTime | 更新时间 |

### ChapterMapping 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| bookId | UUID | 书籍 ID |
| ebookChapterIndex | Int | 电子书章节索引 |
| audiobookChapterIndex | Int | 有声书章节索引 |
| positionRatio | Float | 位置比例系数 |

---

## 4. API 端点

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /sync/progress/:bookId | 获取书籍同步进度 |
| POST | /sync/progress | 更新同步进度 |
| GET | /sync/chapter-mapping/:bookId | 获取章节映射 |
| POST | /sync/convert-position | 位置转换 |

### 请求/响应结构

#### GetSyncProgressDto (响应)

| 字段 | 类型 | 说明 |
|------|------|------|
| bookId | UUID | 书籍 ID |
| reading | ProgressDto? | 阅读进度 |
| listening | ProgressDto? | 收听进度 |
| lastSyncAt | DateTime | 最后同步时间 |

#### ProgressDto

| 字段 | 类型 | 说明 |
|------|------|------|
| chapterIndex | number | 章节索引 |
| position | number | 章节内位置 |
| totalChapters | number | 总章节数 |
| overallProgress | number | 总体进度 (0-100) |
| deviceId | string? | 更新设备 |
| updatedAt | DateTime | 更新时间 |

---

## 5. 核心功能

### 5.1 进度同步

```
┌─────────────────────────────────────────────────────────────────┐
│                  updateSyncProgress 流程                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  输入: { bookId, chapterIndex, position, type, deviceId }       │
│       │                                                          │
│       ▼                                                          │
│  1. 查询当前存储的进度                                            │
│       │                                                          │
│       ▼                                                          │
│  2. 冲突检测                                                      │
│       │                                                          │
│       ├── 无现有记录 → 直接创建                                   │
│       │                                                          │
│       ├── 新进度 > 旧进度 → 更新                                  │
│       │                                                          │
│       └── 新进度 < 旧进度 → 使用 updatedAt 判断                   │
│           │                                                      │
│           ├── 新时间戳更晚 → 更新 (用户可能重读)                   │
│           │                                                      │
│           └── 旧时间戳更晚 → 保留旧值                             │
│                                                                  │
│  3. 更新 lastActiveAt (设备)                                     │
│                                                                  │
│  输出: 合并后的进度                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 章节映射

电子书和有声书的章节划分可能不同：

| 场景 | 电子书 | 有声书 | 处理方式 |
|------|--------|--------|----------|
| 章节一致 | 30 章 | 30 章 | 1:1 映射 |
| 有声书合并 | 30 章 | 15 章 | 2:1 映射 |
| 有声书拆分 | 10 章 | 20 章 | 1:2 映射 |
| 边界不对齐 | - | - | 使用 positionRatio |

### 5.3 位置转换

```
┌─────────────────────────────────────────────────────────────────┐
│                    位置转换示意                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  电子书阅读位置                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Ch.1 │ Ch.2 │ Ch.3 │ Ch.4 │ Ch.5 │ Ch.6 │ Ch.7 │ Ch.8 │    │
│  └─────────────────────────────────────────────────────────┘    │
│              ↑                                                   │
│         当前位置: Ch.3, pos=0.5                                  │
│                                                                  │
│  ↓ convertToListeningPosition()                                 │
│                                                                  │
│  有声书收听位置                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │   Track 1   │   Track 2   │   Track 3   │   Track 4   │     │
│  └─────────────────────────────────────────────────────────┘    │
│                     ↑                                            │
│            转换后: Track 2, pos=0.25                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 同步策略

### 6.1 触发时机

| 场景 | 策略 |
|------|------|
| 翻页 | 防抖 3 秒后上传 |
| 章节切换 | 立即上传 |
| 应用切后台 | 立即上传 |
| 应用启动 | 拉取最新进度 |
| 手动刷新 | 强制同步 |

### 6.2 冲突解决

| 规则 | 优先级 | 说明 |
|------|--------|------|
| 进度更前 | 高 | 假设用户继续阅读 |
| 时间戳更新 | 中 | 最后更新优先 |
| 当前设备 | 低 | 本地优先展示 |

### 6.3 离线处理

```
┌─────────────────────────────────────────────────────────────────┐
│                    离线同步队列                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  离线时:                                                         │
│  1. 进度变更存入本地队列                                          │
│  2. 记录时间戳和设备信息                                          │
│                                                                  │
│  恢复网络时:                                                      │
│  1. 批量上传队列中的变更                                          │
│  2. 拉取服务端最新状态                                            │
│  3. 合并冲突 (使用时间戳)                                         │
│  4. 清空本地队列                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 性能优化

| 优化点 | 策略 |
|--------|------|
| 频繁更新 | 客户端防抖 (3s) |
| 批量同步 | 支持多书籍批量查询 |
| 缓存 | Redis 缓存最近进度 |
| 索引 | (userId, bookId, type) 复合索引 |

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [devices.md](devices.md) | 设备管理 |
| [audiobook.md](../../modules/audiobook.md) | 有声书模块 |
| [reading.md](reading.md) | 阅读模块 |

---

*最后更新: 2025-12-31*

# Translation Performance Optimization Design

> 百万级书籍规模下的翻译系统性能优化方案

---

## 1. 问题分析

### 1.1 当前架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Current: EAV (Entity-Attribute-Value) Pattern        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  translations 表结构:                                                    │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ entity_type │ entity_id │ field_name │ locale  │ value             │ │
│  ├─────────────┼───────────┼────────────┼─────────┼───────────────────┤ │
│  │ book        │ uuid-001  │ title      │ zh-Hans │ 傲慢与偏见        │ │
│  │ book        │ uuid-001  │ author     │ zh-Hans │ 简·奥斯汀         │ │
│  │ book        │ uuid-002  │ title      │ zh-Hans │ 呼啸山庄          │ │
│  │ author      │ uuid-003  │ name       │ zh-Hans │ 简·奥斯汀         │ │
│  │ author      │ uuid-003  │ bio        │ zh-Hans │ 英国女性小说家... │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  优点:                                                                   │
│  ├── 灵活性高，新增语言无需改表结构                                     │
│  ├── 统一管理所有翻译内容                                               │
│  └── 支持无限数量的语言和字段                                           │
│                                                                          │
│  缺点 (大规模时):                                                        │
│  ├── 每次查询需要 JOIN translations 表                                  │
│  ├── 行数 = 实体数 × 字段数 × 语言数                                   │
│  └── 100万书 × 2字段 × 10语言 = 2000万行                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 规模估算

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Data Volume at Scale                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  当前规模 (Staging):                                                     │
│  ├── 156 books, 75 authors                                              │
│  ├── 翻译行数: ~300 rows                                                │
│  └── 查询时间: ~90ms (含网络延迟)                                       │
│                                                                          │
│  中期目标 (10,000 books):                                                │
│  ├── books: 10,000 × 2 fields × 3 locales = 60,000 rows                 │
│  ├── authors: 3,000 × 2 fields × 3 locales = 18,000 rows                │
│  └── 翻译总行数: ~100,000 rows                                          │
│                                                                          │
│  成熟规模 (1,000,000+ books):                                            │
│  ├── books: 1,000,000 × 2 fields × 10 locales = 20,000,000 rows         │
│  ├── authors: 100,000 × 2 fields × 10 locales = 2,000,000 rows          │
│  ├── 其他实体: ~5,000,000 rows                                           │
│  └── 翻译总行数: ~27,000,000 rows                                       │
│                                                                          │
│  存储估算 (1M+ books):                                                   │
│  ├── 每行平均: ~200 bytes                                                │
│  ├── 总数据量: ~5.4 GB (不含索引)                                       │
│  └── 含索引: ~8-10 GB                                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 性能瓶颈分析

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Performance Bottlenecks                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  场景 1: Discover 页面 (列表查询)                                        │
│  ══════════════════════════════════                                      │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Query Pattern:                                                   │   │
│  │  SELECT b.*, t.value as title_localized                           │   │
│  │  FROM books b                                                     │   │
│  │  LEFT JOIN translations t                                         │   │
│  │    ON t.entity_type = 'book'                                      │   │
│  │    AND t.entity_id = b.id                                         │   │
│  │    AND t.field_name = 'title'                                     │   │
│  │    AND t.locale = 'zh-Hans'                                       │   │
│  │  WHERE b.id IN (top 20 book ids)                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  性能分析 (1M books, 20M translation rows):                              │
│  ├── 无索引: ~10-30 秒 (全表扫描)                                       │
│  ├── 有复合索引: ~50-100ms                                              │
│  └── 冗余列: ~10-20ms (无JOIN)                                          │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  场景 2: 书籍详情页 (单书查询)                                           │
│  ═══════════════════════════════                                         │
│                                                                          │
│  需要查询: title, author, description, genres                           │
│  ├── EAV: 4次翻译查询或1次批量查询 (~20ms)                               │
│  └── 冗余列: 直接从books表读取 (~5ms)                                    │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  场景 3: 搜索结果页 (100+ 书籍)                                          │
│  ════════════════════════════════                                        │
│                                                                          │
│  需要本地化: title, author × 100                                        │
│  ├── EAV: JOIN 100 books × translations (~200ms)                        │
│  └── 冗余列: 直接查询 books 表 (~50ms)                                  │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  ⚠️ 关键发现:                                                            │
│  网络延迟 (Neon Singapore) 占主要时间: ~50-80ms                          │
│  数据库查询本身: ~10-40ms (索引良好时)                                   │
│  真正瓶颈: JOIN 操作和行扫描数量                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 方案对比

### 2.1 可选方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Architecture Options                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Option A: 保持 EAV + 优化索引                                           │
│  ════════════════════════════════                                        │
│  ├── 添加分区 (按 entity_type)                                          │
│  ├── 添加复合索引                                                        │
│  └── 增加 Redis 缓存层                                                   │
│                                                                          │
│  适用: 10K-100K books                                                    │
│  优点: 最小改动，向后兼容                                                │
│  缺点: 100万+时性能仍有瓶颈                                              │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Option B: 纯列模式 (Column-per-Language)                                │
│  ══════════════════════════════════════════                              │
│  ├── books 表增加: title_zh_hans, title_zh_hant, title_ja...            │
│  ├── authors 表增加: name_zh_hans, name_zh_hant...                      │
│  └── 删除 translations 表                                                │
│                                                                          │
│  适用: 语言数量固定 (≤5)                                                 │
│  优点: 查询最快，无JOIN                                                  │
│  缺点: 新增语言需改表结构，列爆炸问题                                    │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Option C: 混合模式 (Hybrid) ⭐ 推荐                                     │
│  ══════════════════════════════════                                      │
│  ├── 热字段: 冗余列 (title_zh, author_zh)                                │
│  ├── 冷字段: translations 表 (description, bio)                         │
│  └── 支持无限语言扩展                                                    │
│                                                                          │
│  适用: 所有规模                                                          │
│  优点: 热路径快，冷路径灵活                                              │
│  缺点: 需要同步机制                                                      │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Option D: JSONB 列                                                      │
│  ═══════════════════                                                     │
│  ├── books 表增加: translations JSONB                                    │
│  └── 存储: {"zh-Hans": {"title": "傲慢与偏见"}, "zh-Hant": {...}}       │
│                                                                          │
│  适用: 读多写少                                                          │
│  优点: 无JOIN，灵活性高                                                  │
│  缺点: 更新单个翻译效率低，索引复杂                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 方案对比表

| 方案 | 查询性能 | 写入性能 | 灵活性 | 复杂度 | 推荐规模 |
|------|---------|---------|--------|--------|---------|
| A. EAV优化 | ★★★☆☆ | ★★★★★ | ★★★★★ | ★★☆☆☆ | <100K books |
| B. 纯列模式 | ★★★★★ | ★★★☆☆ | ★☆☆☆☆ | ★★☆☆☆ | 语言固定 |
| C. 混合模式 | ★★★★☆ | ★★★★☆ | ★★★★☆ | ★★★☆☆ | **所有规模** |
| D. JSONB | ★★★★☆ | ★★☆☆☆ | ★★★★☆ | ★★★☆☆ | <500K books |

---

## 3. 方案选择: 根据用户分布动态决策

### 3.0 核心问题: 语言优先级是动态的

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Dynamic Language Priority                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ReadMigo 场景特点:                                                      │
│  ├── 英文 (en) 是源语言，始终是核心                                     │
│  ├── 其他语言的重要性取决于用户分布，是动态变化的                       │
│  └── 无法提前确定哪种语言会成为"热门语言"                               │
│                                                                          │
│  场景示例:                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  今天:                                                            │   │
│  │  ├── 用户分布: 中国 70%, 日本 15%, 韩国 10%, 其他 5%              │   │
│  │  └── 热门语言: zh-Hans, zh-Hant, ja                               │   │
│  │                                                                   │   │
│  │  明年:                                                            │   │
│  │  ├── 用户分布: 日本 40%, 韩国 30%, 中国 20%, 其他 10%             │   │
│  │  └── 热门语言: ja, ko, zh-Hans                                    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ⚠️ 如果硬编码 zh-Hans, zh-Hant 冗余列:                                 │
│  ├── 当用户分布变化时，需要频繁修改数据库 schema                        │
│  ├── 已添加的冗余列可能变成"浪费"                                       │
│  └── 维护成本高                                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.1 推荐方案: Redis-First + EAV 优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Recommended: Redis-First Architecture                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  核心思路: 不改表结构，通过多层缓存解决性能问题                          │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                    │  │
│  │   请求流程:                                                        │  │
│  │                                                                    │  │
│  │   ┌─────────┐   L1    ┌─────────┐   L2    ┌─────────────────────┐ │  │
│  │   │ Client  │────────▶│  Redis  │────────▶│ PostgreSQL         │ │  │
│  │   │         │  Cache  │ (热数据) │  Query  │ translations + EAV │ │  │
│  │   └─────────┘  Hit    └─────────┘  Miss   └─────────────────────┘ │  │
│  │        │                   │                        │             │  │
│  │        │                   │                        │             │  │
│  │        ▼                   ▼                        ▼             │  │
│  │   ┌─────────┐        ┌─────────┐           ┌─────────────────┐   │  │
│  │   │ Response│        │ Cache   │           │ Cache Write     │   │  │
│  │   │ < 10ms  │        │ Refresh │           │ (Background)    │   │  │
│  │   └─────────┘        └─────────┘           └─────────────────┘   │  │
│  │                                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  优势:                                                                   │
│  ├── 无需修改数据库 schema                                              │
│  ├── 语言优先级变化时，只需调整缓存策略                                 │
│  ├── Redis 缓存命中率 > 95% 时，性能与冗余列相当                        │
│  └── 实现成本低，风险小                                                  │
│                                                                          │
│  劣势:                                                                   │
│  ├── 依赖 Redis 可用性                                                   │
│  ├── 冷启动时性能较差                                                    │
│  └── 需要缓存预热机制                                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 缓存层设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Multi-Layer Cache Design                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Layer 1: 页面级缓存 (Discover, Search)                                  │
│  ══════════════════════════════════════                                  │
│                                                                          │
│  Key Pattern:                                                            │
│  ├── discover:tabs:{locale}                                              │
│  ├── discover:books:{categoryId}:{locale}                                │
│  ├── search:results:{query}:{locale}:{page}                              │
│  └── author:list:{locale}:{page}                                         │
│                                                                          │
│  TTL: 1-6 小时                                                           │
│  刷新: 定时任务 + 手动触发                                               │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Layer 2: 实体级缓存 (Book, Author)                                      │
│  ══════════════════════════════════                                      │
│                                                                          │
│  Key Pattern:                                                            │
│  ├── book:{id}:{locale}                                                  │
│  │   └── {title, author, description, genres}                           │
│  ├── author:{id}:{locale}                                                │
│  │   └── {name, bio}                                                    │
│  └── books:batch:{ids_hash}:{locale}                                     │
│      └── 批量查询结果缓存                                                │
│                                                                          │
│  TTL: 24 小时                                                            │
│  刷新: 翻译更新时失效                                                    │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Layer 3: 翻译级缓存 (原子粒度)                                          │
│  ═══════════════════════════════                                         │
│                                                                          │
│  Key Pattern:                                                            │
│  └── trans:{entityType}:{entityId}:{fieldName}:{locale}                  │
│      └── 单个翻译值                                                      │
│                                                                          │
│  TTL: 7 天                                                               │
│  刷新: 写入时更新                                                        │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  缓存预热策略:                                                           │
│  ══════════════                                                          │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  启动时:                                                          │   │
│  │  ├── 预热 Discover 页面 (所有活跃 locale)                         │   │
│  │  ├── 预热 Top 100 热门书籍 (所有活跃 locale)                      │   │
│  │  └── 预热 Top 50 作者 (所有活跃 locale)                           │   │
│  │                                                                   │   │
│  │  定时任务 (每 6 小时):                                            │   │
│  │  ├── 刷新 Discover 缓存                                           │   │
│  │  └── 刷新 Agora 缓存                                              │   │
│  │                                                                   │   │
│  │  按需加载:                                                        │   │
│  │  └── 其他内容首次访问时加载并缓存                                 │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 备选方案: 混合模式 (仅当用户分布稳定时)

如果经过长期观察，用户分布相对稳定 (如中文用户始终 > 70%)，可以考虑混合模式：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Alternative: Hybrid Mode (Stable Distribution)        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  适用条件:                                                               │
│  ├── 用户语言分布已稳定 6 个月以上                                      │
│  ├── 主要语言占比 > 70%                                                  │
│  └── 不预期短期内有大规模用户迁移                                       │
│                                                                          │
│  实施策略:                                                               │
│  ├── 仅为确定的热门语言添加冗余列                                       │
│  ├── 其他语言保持 Redis + EAV                                           │
│  └── 每季度评估是否需要调整                                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Redis-First 架构详细设计

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Redis-First Translation Architecture                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         数据库层 (不变)                            │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │                                                                    │  │
│  │  books 表:                                                         │  │
│  │  ├── id, title, author, description, ...                          │  │
│  │  └── (保持原样，无需添加冗余列)                                   │  │
│  │                                                                    │  │
│  │  authors 表:                                                       │  │
│  │  ├── id, name, name_zh, bio_short, bio_full, ...                  │  │
│  │  └── (保持原样)                                                   │  │
│  │                                                                    │  │
│  │  translations 表:                                                  │  │
│  │  ├── entity_type, entity_id, field_name, locale, value           │  │
│  │  └── (保持 EAV 模式，作为持久化存储)                              │  │
│  │                                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         Redis 缓存层 (核心)                        │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │                                                                    │  │
│  │  页面缓存 (预构建):                                                │  │
│  │  ├── discover:v2:tabs:{locale}                                    │  │
│  │  ├── discover:v2:books:{categoryId}:{locale}                      │  │
│  │  └── agora:posts:{locale}                                         │  │
│  │                                                                    │  │
│  │  实体缓存 (按需):                                                  │  │
│  │  ├── book:{id}:localized:{locale}                                 │  │
│  │  ├── author:{id}:localized:{locale}                               │  │
│  │  └── books:batch:{hash}:{locale}                                  │  │
│  │                                                                    │  │
│  │  翻译缓存 (原子):                                                  │  │
│  │  └── trans:{entityType}:{entityId}:{field}:{locale}               │  │
│  │                                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  数据流:                                                                 │
│  ═══════                                                                 │
│                                                                          │
│  ┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌────────────┐    │
│  │ Client  │────▶│ Redis   │────▶│ PostgreSQL  │────▶│ Write Back │    │
│  │ Request │ hit │ Cache   │miss │ Query       │     │ to Redis   │    │
│  └─────────┘     └─────────┘     └─────────────┘     └────────────┘    │
│       │               │                                    │            │
│       │               │                                    │            │
│       ▼               ▼                                    ▼            │
│  ┌─────────┐     ┌─────────┐                         ┌────────────┐    │
│  │ Response│     │ < 10ms  │                         │ Background │    │
│  │ Fast    │     │ latency │                         │ Job        │    │
│  └─────────┘     └─────────┘                         └────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 缓存策略详解

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Cache Strategy by Content Type                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Tier 1: 页面级缓存 (预构建) - 最高优先级                                │
│  ════════════════════════════════════════════                            │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 缓存内容      │ Key Pattern               │ TTL    │ 刷新方式    │    │
│  ├───────────────┼───────────────────────────┼────────┼─────────────┤    │
│  │ Discover Tabs │ discover:v2:tabs:{locale} │ 6h     │ 定时+手动   │    │
│  │ Discover Books│ discover:v2:books:*       │ 6h     │ 定时+手动   │    │
│  │ Agora Posts   │ agora:posts:{locale}      │ 1h     │ 定时+手动   │    │
│  │ Category List │ categories:{locale}       │ 24h    │ 变更触发    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  特点: 完整页面数据，直接返回给客户端，无需任何处理                      │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Tier 2: 实体级缓存 (按需构建) - 详情页                                  │
│  ══════════════════════════════════════════                              │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 缓存内容      │ Key Pattern                   │ TTL    │ 触发    │    │
│  ├───────────────┼───────────────────────────────┼────────┼─────────┤    │
│  │ Book Detail   │ book:{id}:localized:{locale}  │ 24h    │ 访问时  │    │
│  │ Author Detail │ author:{id}:localized:{locale}│ 24h    │ 访问时  │    │
│  │ Batch Books   │ books:batch:{ids_hash}:{locale}│ 1h    │ 访问时  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  特点: 首次访问时构建，后续请求直接返回                                  │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Tier 3: 翻译级缓存 (原子粒度) - 兜底                                    │
│  ════════════════════════════════════════                                │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 缓存内容      │ Key Pattern                           │ TTL     │    │
│  ├───────────────┼───────────────────────────────────────┼─────────┤    │
│  │ 单个翻译值    │ trans:{type}:{id}:{field}:{locale}    │ 7d      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  特点: 最小粒度，用于组装实体级缓存时使用                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 查询模式对比

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Query Pattern: Before vs After                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  场景: Discover 页面获取 Top 20 书籍 (zh-Hans)                           │
│                                                                          │
│  BEFORE (无缓存):                                                        │
│  ════════════════                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 查询 books 表                                            │   │
│  │  Step 2: 批量查询 translations 表 (title, author)                 │   │
│  │  Step 3: 合并结果                                                 │   │
│  │                                                                   │   │
│  │  总查询: 2 次数据库查询                                           │   │
│  │  预计时间: 90-150ms (含网络延迟)                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  AFTER (Redis-First):                                                    │
│  ═════════════════════                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 查询 Redis (discover:v2:books:all:zh-Hans)               │   │
│  │                                                                   │   │
│  │  缓存命中: 0 次数据库查询                                         │   │
│  │  预计时间: 5-15ms                                                 │   │
│  │                                                                   │   │
│  │  缓存未命中 (首次或过期):                                         │   │
│  │  ├── 查询数据库 + translations                                    │   │
│  │  ├── 构建本地化数据                                               │   │
│  │  ├── 写入 Redis                                                   │   │
│  │  └── 返回结果                                                     │   │
│  │  预计时间: 100-200ms (一次性)                                     │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  场景: 书籍详情页                                                        │
│                                                                          │
│  BEFORE (无缓存):                                                        │
│  ════════════════                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 查询 books 表                                            │   │
│  │  Step 2: 查询 translations (title, author, description)          │   │
│  │  总查询: 2 次                                                     │   │
│  │  预计时间: 80-120ms                                               │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  AFTER (Redis-First):                                                    │
│  ═════════════════════                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 查询 Redis (book:{id}:localized:zh-Hans)                 │   │
│  │                                                                   │   │
│  │  缓存命中: 5-15ms                                                 │   │
│  │  缓存未命中: 100-150ms (首次访问)                                 │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 缓存预热与失效

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Cache Warming & Invalidation                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  缓存预热 (启动时):                                                      │
│  ══════════════════                                                      │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  1. 获取活跃语言列表 (en, zh-Hans, zh-Hant)                       │   │
│  │  2. 对每种语言:                                                   │   │
│  │     ├── 构建 Discover Tabs 缓存                                   │   │
│  │     ├── 构建 Discover Books 缓存 (所有分类)                       │   │
│  │     ├── 构建 Agora Posts 缓存                                     │   │
│  │     └── 构建 Top 100 Books 实体缓存                               │   │
│  │  3. 记录预热完成时间                                              │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  缓存失效策略:                                                           │
│  ══════════════                                                          │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  触发事件              │ 失效范围                 │ 重建方式      │   │
│  ├────────────────────────┼──────────────────────────┼───────────────┤   │
│  │ 翻译更新 (单个)        │ 相关实体缓存             │ 延迟重建      │   │
│  │ 翻译批量导入           │ 相关页面缓存             │ 立即重建      │   │
│  │ 书籍新增/删除          │ Discover 缓存            │ 立即重建      │   │
│  │ 分类变更               │ 相关分类缓存             │ 立即重建      │   │
│  │ 手动触发               │ 所有缓存                 │ 立即重建      │   │
│  │ TTL 过期               │ 过期键                   │ 按需重建      │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  失效传播:                                                               │
│  ═══════════                                                             │
│                                                                          │
│  翻译更新事件                                                            │
│       │                                                                   │
│       ├──▶ 删除 trans:{type}:{id}:{field}:{locale}                      │
│       │                                                                   │
│       ├──▶ 删除 {entity}:{id}:localized:{locale}                        │
│       │                                                                   │
│       └──▶ 标记页面缓存需要刷新 (下次定时任务处理)                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据库优化 (配合措施)

### 5.1 索引优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Database Index Optimization                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  现有索引 (保持):                                                        │
│  ═══════════════                                                         │
│  ├── translations_entity_type_entity_id_field_name_locale_key (UNIQUE)  │
│  ├── translations_entity_type_entity_id_idx                             │
│  ├── translations_entity_type_entity_id_locale_idx                      │
│  └── translations_locale_idx                                             │
│                                                                          │
│  建议新增索引 (大规模时):                                                │
│  ═══════════════════════                                                 │
│  ├── translations_lookup_idx (entity_type, entity_id, locale)           │
│  │   └── 优化批量查询性能                                                │
│  └── translations_status_idx (status, entity_type)                      │
│      └── 支持按状态筛选 published 翻译                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 分区策略 (100K+ books)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Partitioning Strategy                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  当 translations 表超过 500 万行时，考虑按 entity_type 分区:             │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  translations_books        → entity_type = 'book'                 │   │
│  │  translations_authors      → entity_type = 'author'               │   │
│  │  translations_ui           → entity_type IN ('discoverTab',       │   │
│  │                               'category', 'medal', 'faq', ...)    │   │
│  │  translations_audiobooks   → entity_type IN ('audiobook',         │   │
│  │                               'audiobookChapter')                 │   │
│  │  translations_default      → 其他                                 │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  好处:                                                                   │
│  ├── 查询只扫描相关分区                                                  │
│  ├── 维护更容易 (分区独立 VACUUM)                                        │
│  └── 可按分区设置不同存储策略                                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 实施计划

### 6.1 实施阶段

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Implementation Phases                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Phase 1: 缓存基础设施增强 (无停机)                                      │
│  ══════════════════════════════════                                      │
│  ├── 1. 确认 Redis 服务配置和容量                                       │
│  ├── 2. 添加缓存监控指标 (命中率、延迟、内存使用)                        │
│  └── 3. 定义缓存 Key 规范文档                                            │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Phase 2: 实现多层缓存服务                                               │
│  ══════════════════════════                                              │
│  ├── 1. 创建 TranslationCacheService                                     │
│  │      ├── getLocalizedBook(id, locale)                                │
│  │      ├── getLocalizedBooks(ids, locale) // 批量                      │
│  │      └── invalidateBook(id) // 失效                                  │
│  ├── 2. 更新 LocalizationService                                         │
│  │      └── 集成 TranslationCacheService                                │
│  └── 3. 创建缓存预热任务                                                 │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Phase 3: 集成到现有服务                                                 │
│  ═══════════════════════                                                 │
│  ├── 1. 更新 DiscoverCacheService                                        │
│  │      └── 使用新的缓存服务                                             │
│  ├── 2. 更新 BookService                                                 │
│  │      └── 详情页使用缓存                                               │
│  ├── 3. 更新 AgoraCacheService                                           │
│  │      └── 作者帖子使用缓存                                             │
│  └── 4. 刷新所有缓存                                                     │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  Phase 4: 监控与优化                                                     │
│  ═══════════════════                                                     │
│  ├── 1. 监控缓存命中率 (目标 > 90%)                                      │
│  ├── 2. 监控响应时间变化                                                 │
│  ├── 3. 优化预热策略                                                     │
│  └── 4. 调整 TTL 和失效策略                                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 回滚方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Rollback Plan                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Redis-First 方案回滚风险极低:                                           │
│                                                                          │
│  ├── 数据库层无变更，无需回滚                                            │
│  ├── 翻译数据仍在 translations 表                                       │
│  └── 只需关闭缓存即可恢复原逻辑                                          │
│                                                                          │
│  回滚触发条件:                                                           │
│  ├── Redis 服务不稳定 (频繁超时)                                         │
│  ├── 缓存数据不一致                                                      │
│  └── 内存使用超出预期                                                    │
│                                                                          │
│  回滚步骤:                                                               │
│  ═══════════                                                             │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 禁用缓存                                                 │   │
│  │  └── 配置环境变量 TRANSLATION_CACHE_ENABLED=false                 │   │
│  │      或 Feature Flag 关闭缓存                                     │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 2: 清空 Redis 缓存                                          │   │
│  │  └── FLUSHDB 或 删除相关 Key Pattern                              │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 3: 恢复直接查询                                             │   │
│  │  └── 服务自动 fallback 到数据库查询                               │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  回滚预计时间: < 5 分钟                                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 预期性能收益

### 7.1 性能对比表

| 场景 | 当前 (EAV 无缓存) | 优化后 (Redis-First) | 提升 |
|------|------------------|---------------------|------|
| Discover 列表页 (20 books) | 90-150ms | 5-15ms (缓存命中) | ~90% |
| 搜索结果页 (100 books) | 200-300ms | 10-20ms (缓存命中) | ~95% |
| 书籍详情页 | 80-120ms | 5-15ms (缓存命中) | ~90% |
| 作者详情页 | 100-150ms | 5-15ms (缓存命中) | ~90% |

注: 缓存未命中时，性能与当前相同 (首次访问或 TTL 过期)

### 7.2 规模化性能预测

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Performance at Scale                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  书籍数量      │ EAV 无缓存       │ Redis-First      │ 提升             │
│  ──────────────┼──────────────────┼──────────────────┼─────────────────  │
│  1,000         │ 50ms             │ 5-10ms           │ 80-90%           │
│  10,000        │ 80ms             │ 5-10ms           │ 87-94%           │
│  100,000       │ 150ms            │ 5-10ms           │ 93-97%           │
│  1,000,000     │ 500ms+           │ 5-15ms           │ 97%+             │
│                                                                          │
│  关键点:                                                                 │
│  ├── 缓存命中时，性能与数据规模无关                                     │
│  ├── 缓存未命中时，仍需查询数据库 (同当前性能)                          │
│  └── 关键是保持高缓存命中率 (目标 > 90%)                                 │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  缓存命中率预估:                                                         │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                                                                  │    │
│  │  页面级缓存 (Discover, Agora):                                   │    │
│  │  ├── 预构建，命中率接近 100%                                     │    │
│  │  └── TTL 过期时自动重建                                          │    │
│  │                                                                  │    │
│  │  实体级缓存 (Book, Author 详情):                                 │    │
│  │  ├── 热门内容: > 95% 命中率                                      │    │
│  │  ├── 中等内容: 70-95% 命中率                                     │    │
│  │  └── 长尾内容: < 50% 命中率 (但访问量低，影响小)                 │    │
│  │                                                                  │    │
│  │  综合命中率预估: 85-95%                                          │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 后续优化建议

### 8.1 进阶优化措施

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Additional Optimizations                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. CDN 边缘缓存 (Cloudflare Workers)                                    │
│  ═════════════════════════════════════                                   │
│  ├── Discover 页面数据边缘缓存                                          │
│  ├── Workers KV 存储本地化数据                                          │
│  └── 按用户地区就近返回                                                  │
│                                                                          │
│  2. 智能预热策略                                                         │
│  ══════════════════                                                      │
│  ├── 基于访问日志预测热门内容                                            │
│  ├── 新增书籍自动预热                                                    │
│  └── 低峰期批量预热                                                      │
│                                                                          │
│  3. 分级缓存 TTL                                                         │
│  ══════════════════                                                      │
│  ├── 热门内容: 短 TTL + 主动刷新                                        │
│  ├── 普通内容: 中等 TTL                                                 │
│  └── 冷门内容: 长 TTL + 按需刷新                                        │
│                                                                          │
│  4. 数据库读副本                                                         │
│  ══════════════════                                                      │
│  ├── 缓存未命中时查询读副本                                              │
│  └── 减少主库压力                                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 扩展语言支持策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Language Expansion Strategy                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Redis-First 方案下，新增语言非常简单:                                   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 在 supported_locales 表新增语言                          │   │
│  │                                                                   │   │
│  │  Step 2: 批量生成翻译 (AI 或人工)                                 │   │
│  │          写入 translations 表                                     │   │
│  │                                                                   │   │
│  │  Step 3: 预热该语言的缓存                                         │   │
│  │          构建 discover:v2:*:{new_locale}                          │   │
│  │                                                                   │   │
│  │  Step 4: 客户端支持新语言                                         │   │
│  │          无后端代码改动                                           │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  优势:                                                                   │
│  ├── 无需修改数据库 schema                                              │
│  ├── 无需修改后端代码                                                    │
│  ├── 新语言可动态启用/禁用                                              │
│  └── 缓存自动适配新语言                                                  │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  备选: 混合模式 (当某语言用户稳定超过 50%)                               │
│                                                                          │
│  如果某语言用户长期稳定占比超过 50%，可考虑:                             │
│  ├── 为该语言添加冗余列                                                  │
│  ├── 进一步提升缓存未命中时的性能                                       │
│  └── 需要评估: 维护成本 vs 性能收益                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 文件修改清单

### 9.1 新增文件

| 文件 | 描述 |
|----------|------|
| `translation-cache.service.ts` | 翻译缓存服务，管理多层缓存 |
| `cache-warming.job.ts` | 缓存预热定时任务 |
| `cache-invalidation.service.ts` | 缓存失效服务 |

### 9.2 修改文件

| 文件 | 变更 |
|------|------|
| `localization.service.ts` | 集成 TranslationCacheService |
| `discover-cache.service.ts` | 使用新的缓存服务 |
| `agora-cache.service.ts` | 使用新的缓存服务 |
| `book.service.ts` | 详情页使用缓存 |
| `author.service.ts` | 详情页使用缓存 |

### 9.3 数据库 (无变更)

Redis-First 方案不需要任何数据库 schema 变更:
- translations 表保持 EAV 模式
- books/authors 表无需添加冗余列
- 索引保持现状 (可选优化)

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [localization-translations.md](./localization-translations.md) | 当前翻译系统设计 |
| [localization-migration-plan.md](./localization-migration-plan.md) | 双字段迁移计划 |
| [database-design.md](../api/database-design.md) | 数据库设计 |

---

## 11. 总结与决策

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Summary: Redis-First Approach                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  核心决策:                                                               │
│  ═════════                                                               │
│  ├── 保持 EAV (translations 表) 作为数据存储                            │
│  ├── 使用 Redis 多层缓存解决性能问题                                    │
│  └── 不添加冗余列，保持 schema 灵活性                                   │
│                                                                          │
│  适用条件:                                                               │
│  ═══════════                                                             │
│  ├── 语言优先级动态变化                                                  │
│  ├── 无法预测哪种语言会成为热门                                         │
│  └── 希望最小化 schema 变更                                             │
│                                                                          │
│  预期收益:                                                               │
│  ═══════════                                                             │
│  ├── 缓存命中: 90%+ 性能提升                                            │
│  ├── 新增语言: 无代码改动                                               │
│  └── 回滚风险: 极低                                                      │
│                                                                          │
│  冗余列备选条件:                                                         │
│  ═══════════════                                                         │
│  如果某语言用户稳定超过 50% 且持续 6 个月以上，                          │
│  可评估是否为该语言添加冗余列 (混合模式)                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 实施时机

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Implementation Timeline                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  当前状态 (2026-01-03):                                                  │
│  ══════════════════════                                                  │
│  ├── 书籍数量: ~156 本                                                   │
│  ├── 查询性能: ~90ms (可接受)                                           │
│  └── 决定: 暂不实施，保持现状                                            │
│                                                                          │
│  实施阈值:                                                               │
│  ═══════════                                                             │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 书籍数量      │ 建议操作                                         │    │
│  ├───────────────┼──────────────────────────────────────────────────┤    │
│  │ < 10,000      │ 暂不实施，保持现状                               │    │
│  │ 10,000+       │ 可开始考虑实施                                   │    │
│  │ 100,000+      │ 建议实施                                         │    │
│  │ 1,000,000+    │ 必须实施                                         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  本文档作为未来扩展的技术参考，待书籍量增长后启动优化。                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

*Created: 2026-01-03*

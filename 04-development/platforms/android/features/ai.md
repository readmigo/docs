# Android AI 功能模块

> 智能查词 + 翻译 + 问答

---

## 1. 模块概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 功能架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    AI Panel UI                           │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │    │
│  │  │  查词    │  │   翻译   │  │   问答   │  │  解读   │ │    │
│  │  │  Lookup  │  │Translate │  │   Q&A    │  │ Explain │ │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘ │    │
│  └───────┼─────────────┼─────────────┼─────────────┼───────┘    │
│          │             │             │             │             │
│          ▼             ▼             ▼             ▼             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   AIViewModel                            │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                      │
│                           ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   AI UseCase Layer                       │    │
│  │  LookupUseCase │ TranslateUseCase │ QAUseCase           │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                      │
│                           ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   AIRepository                           │    │
│  │  Remote (API) │ Local (Cache) │ Offline (Dict)          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 功能列表

| 功能 | 描述 | 触发方式 |
|------|------|----------|
| 智能查词 | 词汇解释、例句、发音 | 选中单词 |
| 句子翻译 | 整句翻译 | 选中句子 |
| 段落解读 | AI 解释段落含义 | 选中段落 |
| 智能问答 | 基于上下文问答 | 手动输入 |
| 语法分析 | 句子成分分析 | 选中句子 |

---

## 3. 智能查词

### 3.1 查词流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    查词流程                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户选中单词                                                    │
│       │                                                          │
│       ▼                                                          │
│  检查本地缓存                                                    │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 命中     未命中                                                  │
│  │         │                                                    │
│  │         ▼                                                    │
│  │    检查网络状态                                               │
│  │         │                                                    │
│  │    ┌────┴────┐                                              │
│  │    │         │                                              │
│  │    ▼         ▼                                              │
│  │   在线      离线                                              │
│  │    │         │                                              │
│  │    ▼         ▼                                              │
│  │  调用 AI API  使用离线词典                                   │
│  │    │         │                                              │
│  │    ▼         │                                              │
│  │  缓存结果    │                                              │
│  │    │         │                                              │
│  └────┴─────────┘                                              │
│       │                                                          │
│       ▼                                                          │
│  显示查词结果                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 查词结果

| 内容 | 说明 |
|------|------|
| 词义 | 中英文释义 |
| 音标 | 美式/英式音标 |
| 发音 | TTS 播放 |
| 例句 | 使用示例 |
| 词根词缀 | 构词分析 |
| 同义词 | 相关词汇 |

---

## 4. 翻译功能

### 4.1 翻译模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    翻译模式                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  句子翻译                                                        │
│  ├── 选中句子触发                                                │
│  ├── AI 驱动翻译                                                │
│  └── 保留原文对照                                                │
│                                                                  │
│  段落翻译                                                        │
│  ├── 选中多句触发                                                │
│  ├── 上下文感知翻译                                              │
│  └── 分句对照显示                                                │
│                                                                  │
│  全文翻译 (付费)                                                 │
│  ├── 整章翻译                                                    │
│  ├── 双语对照模式                                                │
│  └── 翻译结果缓存                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 支持语言

| 源语言 | 目标语言 |
|--------|----------|
| 英语 | 中文 |
| 中文 | 英语 |
| 日语 | 中文 |
| 法语 | 中文 |

---

## 5. 智能问答

### 5.1 问答功能

```
┌─────────────────────────────────────────────────────────────────┐
│                    智能问答                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  上下文问答                                                      │
│  ├── 基于当前阅读内容                                            │
│  ├── 理解书籍背景                                                │
│  └── 回答阅读相关问题                                            │
│                                                                  │
│  内容解读                                                        │
│  ├── 解释难懂段落                                                │
│  ├── 分析人物关系                                                │
│  └── 总结章节要点                                                │
│                                                                  │
│  学习辅助                                                        │
│  ├── 生成阅读笔记                                                │
│  ├── 提供背景知识                                                │
│  └── 推荐相关阅读                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 对话历史

| 字段 | 说明 |
|------|------|
| role | user/assistant |
| content | 消息内容 |
| bookContext | 书籍上下文 |
| timestamp | 时间戳 |

---

## 6. 缓存策略

### 6.1 缓存层级

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 缓存策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  L1: 内存缓存                                                    │
│  ├── 当前会话查词结果                                            │
│  └── LRU 策略，最大 100 条                                      │
│                                                                  │
│  L2: 数据库缓存                                                  │
│  ├── 所有查词历史                                                │
│  ├── 翻译结果                                                    │
│  └── 问答记录                                                    │
│                                                                  │
│  缓存键生成                                                      │
│  ├── 查词: word + language                                      │
│  ├── 翻译: text + sourceLang + targetLang                      │
│  └── 问答: question + bookContext hash                         │
│                                                                  │
│  过期策略                                                        │
│  ├── 查词: 永不过期                                              │
│  ├── 翻译: 30 天                                                │
│  └── 问答: 7 天                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 离线支持

| 功能 | 离线方案 |
|------|----------|
| 查词 | 本地词典 |
| 翻译 | 仅显示缓存 |
| 问答 | 不支持 |

---

## 7. 使用限额

### 7.1 配额管理

```
┌─────────────────────────────────────────────────────────────────┐
│                    使用配额                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  免费用户                                                        │
│  ├── 查词: 50 次/天                                             │
│  ├── 翻译: 20 次/天                                             │
│  └── 问答: 5 次/天                                              │
│                                                                  │
│  付费用户                                                        │
│  ├── 查词: 无限制                                               │
│  ├── 翻译: 无限制                                               │
│  └── 问答: 100 次/天                                            │
│                                                                  │
│  配额重置                                                        │
│  └── 每日 00:00 UTC 重置                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 超额处理

| 场景 | 处理 |
|------|------|
| 接近限额 | 显示提醒 |
| 达到限额 | 提示升级 |
| 离线缓存 | 不消耗配额 |

---

## 8. UI 组件

### 8.1 AI Panel

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI Panel 组件                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  AIPanelSheet                                                   │
│  ├── 标签页切换                                                  │
│  │   ├── 查词 Tab                                              │
│  │   ├── 翻译 Tab                                              │
│  │   └── 问答 Tab                                              │
│  │                                                              │
│  ├── 结果显示区                                                  │
│  │   ├── 加载状态                                               │
│  │   ├── 结果卡片                                               │
│  │   └── 错误状态                                               │
│  │                                                              │
│  └── 操作区                                                      │
│      ├── 添加到词汇本                                            │
│      ├── 复制                                                    │
│      └── 分享                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 交互设计

| 交互 | 行为 |
|------|------|
| 上滑 | 展开面板 |
| 下滑 | 收起面板 |
| 点击外部 | 关闭面板 |
| 长按结果 | 复制内容 |

---

## 9. 错误处理

### 9.1 错误类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 错误处理                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  网络错误                                                        │
│  ├── 无网络连接 → 使用离线词典                                   │
│  ├── 请求超时 → 重试 + 提示                                     │
│  └── 服务不可用 → 显示错误信息                                   │
│                                                                  │
│  配额错误                                                        │
│  ├── 日配额用尽 → 提示升级                                       │
│  └── 请求过频 → 节流处理                                         │
│                                                                  │
│  内容错误                                                        │
│  ├── 无法识别 → 提示重新选择                                     │
│  └── 内容过长 → 提示截断                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 降级策略

| 场景 | 降级方案 |
|------|----------|
| AI 不可用 | 本地词典 |
| 高级功能受限 | 基础查词 |
| 全部不可用 | 提示错误 |

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [reader.md](./reader.md) | 阅读器 |
| [learning.md](./learning.md) | 学习功能 |
| [../architecture.md](../architecture.md) | 架构设计 |

---

*最后更新: 2025-12-31*

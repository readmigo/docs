# Android 有声书模块

> TTS 朗读 + 音频播放 + 后台控制

---

## 1. 模块概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    有声书架构                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   AudiobookScreen                        │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │    │
│  │  │  播放器  │  │   章节   │  │   速度   │  │  定时   │ │    │
│  │  │  Player  │  │ Chapters │  │   Speed  │  │  Timer  │ │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘ │    │
│  └───────┼─────────────┼─────────────┼─────────────┼───────┘    │
│          │             │             │             │             │
│          ▼             ▼             ▼             ▼             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                AudiobookViewModel                        │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                      │
│                           ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   Audio Engine                           │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │   System     │  │    Cloud     │  │    Media     │  │    │
│  │  │     TTS      │  │     TTS      │  │    Player    │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                      │
│                           ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              MediaSession + Foreground Service           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心功能

| 功能 | 说明 |
|------|------|
| TTS 朗读 | 文本转语音 |
| 音频播放 | 有声书播放 |
| 后台播放 | 锁屏/后台继续 |
| 睡眠定时 | 定时停止 |
| 书签跳转 | 章节导航 |

---

## 3. TTS 引擎

### 3.1 引擎类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    TTS 引擎                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  系统 TTS (Android TextToSpeech)                               │
│  ├── 优点: 离线可用、免费                                        │
│  ├── 缺点: 音质一般                                              │
│  └── 适用: 基础朗读                                              │
│                                                                  │
│  云端 TTS (Azure/Google)                                        │
│  ├── 优点: 音质高、自然                                          │
│  ├── 缺点: 需网络、付费                                          │
│  └── 适用: 高质量朗读                                            │
│                                                                  │
│  引擎选择                                                        │
│  ├── 默认: 系统 TTS                                             │
│  ├── WiFi: 自动切换云端                                         │
│  └── 设置: 用户手动选择                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 语音设置

| 设置 | 范围 | 默认 |
|------|------|------|
| 语速 | 0.5x - 2.0x | 1.0x |
| 音调 | 0.5 - 2.0 | 1.0 |
| 音量 | 0 - 100% | 100% |
| 语言 | 自动/手动 | 自动 |

---

## 4. 播放控制

### 4.1 播放状态

```
┌─────────────────────────────────────────────────────────────────┐
│                    播放状态机                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│         ┌──────────────────────────────────────────┐            │
│         │                                          │            │
│         ▼                                          │            │
│    ┌─────────┐     play()     ┌─────────┐        │            │
│    │  IDLE   │───────────────▶│ PLAYING │────────┘            │
│    └────┬────┘                └────┬────┘   complete()         │
│         │                          │                            │
│         │ prepare()                │ pause()                    │
│         │                          ▼                            │
│         │                    ┌─────────┐                       │
│         │                    │ PAUSED  │                       │
│         │                    └────┬────┘                       │
│         │                         │ resume()                   │
│         │                         ▼                            │
│         │                    ┌─────────┐                       │
│         └───────────────────▶│ PLAYING │                       │
│                              └─────────┘                       │
│                                                                  │
│  状态说明                                                        │
│  ├── IDLE: 初始/停止状态                                        │
│  ├── PLAYING: 正在播放                                          │
│  └── PAUSED: 暂停状态                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 播放操作

| 操作 | 说明 |
|------|------|
| 播放/暂停 | 切换播放状态 |
| 上一句 | 跳到上一句 |
| 下一句 | 跳到下一句 |
| 上一章 | 跳到上一章节 |
| 下一章 | 跳到下一章节 |
| 进度拖动 | 跳到指定位置 |

---

## 5. 后台服务

### 5.1 Foreground Service

```
┌─────────────────────────────────────────────────────────────────┐
│                    后台服务                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  AudioService (Foreground Service)                             │
│  │                                                              │
│  ├── 通知栏控制                                                  │
│  │   ├── 播放/暂停按钮                                          │
│  │   ├── 上一章/下一章                                          │
│  │   ├── 当前播放信息                                            │
│  │   └── 关闭按钮                                                │
│  │                                                              │
│  ├── MediaSession                                               │
│  │   ├── 系统媒体控制集成                                        │
│  │   ├── 蓝牙控制支持                                            │
│  │   └── 锁屏控制支持                                            │
│  │                                                              │
│  └── 音频焦点管理                                                │
│      ├── 来电自动暂停                                            │
│      ├── 其他媒体自动暂停                                        │
│      └── 焦点恢复自动继续                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 音频焦点

| 场景 | 行为 |
|------|------|
| 来电 | 暂停播放 |
| 通话结束 | 恢复播放 |
| 其他媒体播放 | 暂停播放 |
| 导航播报 | 降低音量 |

---

## 6. 睡眠定时

### 6.1 定时模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    睡眠定时                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  定时模式                                                        │
│  ├── 时长定时: 15/30/45/60 分钟                                 │
│  ├── 章节定时: 本章结束/N 章后                                   │
│  └── 自定义: 精确到分钟                                          │
│                                                                  │
│  定时行为                                                        │
│  ├── 淡出效果: 最后 30 秒渐弱                                    │
│  ├── 停止播放                                                    │
│  └── 保存进度                                                    │
│                                                                  │
│  UI 显示                                                         │
│  ├── 剩余时间倒计时                                              │
│  ├── 延长按钮: +5/+10 分钟                                      │
│  └── 取消按钮                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 定时选项

| 选项 | 说明 |
|------|------|
| 15 分钟 | 短时小憩 |
| 30 分钟 | 标准时长 |
| 45 分钟 | 长时收听 |
| 本章结束 | 章节边界 |
| 自定义 | 精确设置 |

---

## 7. 章节导航

### 7.1 导航功能

```
┌─────────────────────────────────────────────────────────────────┐
│                    章节导航                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  目录显示                                                        │
│  ├── 章节列表                                                    │
│  ├── 当前章节高亮                                                │
│  ├── 播放进度指示                                                │
│  └── 快速跳转                                                    │
│                                                                  │
│  进度条                                                          │
│  ├── 章节内进度                                                  │
│  ├── 整本进度                                                    │
│  ├── 拖动跳转                                                    │
│  └── 时间显示                                                    │
│                                                                  │
│  书签功能                                                        │
│  ├── 添加书签                                                    │
│  ├── 书签列表                                                    │
│  └── 跳转到书签                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 进度同步

| 同步内容 | 时机 |
|----------|------|
| 当前位置 | 实时 |
| 章节进度 | 章节切换时 |
| 书签 | 添加时 |

---

## 8. 文本高亮同步

### 8.1 同步模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    高亮同步                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  句子高亮                                                        │
│  ├── 当前朗读句子高亮                                            │
│  ├── 自动滚动跟随                                                │
│  └── 颜色可自定义                                                │
│                                                                  │
│  实现方式                                                        │
│  ├── TTS 回调获取进度                                           │
│  ├── 文本分句处理                                                │
│  └── 计算当前句子索引                                            │
│                                                                  │
│  边界处理                                                        │
│  ├── 句子边界检测                                                │
│  ├── 段落边界检测                                                │
│  └── 章节边界处理                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 高亮选项

| 选项 | 说明 |
|------|------|
| 开启/关闭 | 高亮显示开关 |
| 颜色选择 | 高亮颜色 |
| 自动滚动 | 跟随滚动开关 |

---

## 9. 性能优化

### 9.1 优化策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能优化                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  文本预处理                                                      │
│  ├── 预分句处理                                                  │
│  ├── 缓存分句结果                                                │
│  └── 后台预加载                                                  │
│                                                                  │
│  音频预加载                                                      │
│  ├── 预合成下一段                                                │
│  ├── 缓存合成结果                                                │
│  └── 网络优化                                                    │
│                                                                  │
│  电池优化                                                        │
│  ├── 屏幕关闭时降低更新频率                                      │
│  ├── 高效的后台服务                                              │
│  └── 合理的音频缓冲区                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 性能目标

| 指标 | 目标 |
|------|------|
| 启动延迟 | < 500ms |
| 切换延迟 | < 200ms |
| 后台电量 | < 3%/小时 |

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [reader.md](./reader.md) | 阅读器 |
| [../architecture.md](../architecture.md) | 架构设计 |
| [../performance.md](../performance.md) | 性能优化 |

---

*最后更新: 2025-12-31*

# Android 监控与可观测性

> Firebase + Sentry + 自定义指标

---

## 1. 监控体系概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控体系架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    数据采集层                              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │   │
│  │  │  崩溃    │  │  性能    │  │  日志    │  │  用户    │ │   │
│  │  │ Crashes  │  │ Metrics  │  │  Logs    │  │ Events   │ │   │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │   │
│  └───────┼─────────────┼─────────────┼─────────────┼────────┘   │
│          │             │             │             │             │
│          ▼             ▼             ▼             ▼             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    处理/上报层                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │   │
│  │  │  Crashlytics │  │   Firebase   │  │    Sentry    │   │   │
│  │  │              │  │  Performance │  │              │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    可视化/告警层                           │   │
│  │  Dashboard │ Alerts │ Reports │ Analytics                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 崩溃监控

### 2.1 Firebase Crashlytics

```
┌─────────────────────────────────────────────────────────────────┐
│                    Crashlytics 配置                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  自动采集                                                        │
│  ├── 未捕获异常                                                  │
│  ├── ANR (Application Not Responding)                          │
│  ├── Fatal 信号                                                 │
│  └── Non-fatal 异常                                             │
│                                                                  │
│  附加信息                                                        │
│  ├── 设备信息                                                    │
│  ├── OS 版本                                                    │
│  ├── App 版本                                                   │
│  ├── 内存状态                                                    │
│  └── 自定义 Key-Value                                           │
│                                                                  │
│  用户标识                                                        │
│  ├── setUserId()                                               │
│  └── setCustomKey()                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 崩溃分析指标

| 指标 | 目标 | 告警阈值 |
|------|------|----------|
| 崩溃率 | < 0.1% | > 0.5% |
| ANR 率 | < 0.05% | > 0.1% |
| 无崩溃用户比例 | > 99.5% | < 99% |

---

## 3. 性能监控

### 3.1 Firebase Performance

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能监控指标                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  自动跟踪                                                        │
│  ├── App 启动时间                                               │
│  │   ├── 冷启动                                                 │
│  │   ├── 温启动                                                 │
│  │   └── 热启动                                                 │
│  │                                                              │
│  ├── 屏幕渲染                                                    │
│  │   ├── 慢帧率                                                 │
│  │   └── 冻结帧                                                 │
│  │                                                              │
│  └── 网络请求                                                    │
│      ├── 响应时间                                                │
│      ├── 成功率                                                  │
│      └── 负载大小                                                │
│                                                                  │
│  自定义跟踪                                                      │
│  ├── 书籍加载时间                                                │
│  ├── 翻页耗时                                                    │
│  ├── AI 响应时间                                                │
│  └── 同步耗时                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 性能目标

| 指标 | 目标 | 说明 |
|------|------|------|
| 冷启动 | < 2s | 首帧渲染 |
| 热启动 | < 500ms | 后台恢复 |
| 慢帧率 | < 5% | > 16ms 的帧 |
| 冻结帧 | < 1% | > 700ms 的帧 |

---

## 4. 错误追踪

### 4.1 Sentry 集成

```
┌─────────────────────────────────────────────────────────────────┐
│                    Sentry 配置                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  异常捕获                                                        │
│  ├── Kotlin/Java 异常                                           │
│  ├── Coroutine 异常                                             │
│  └── Native 崩溃                                                │
│                                                                  │
│  面包屑 (Breadcrumbs)                                           │
│  ├── 用户操作                                                    │
│  ├── 网络请求                                                    │
│  ├── 页面导航                                                    │
│  └── 状态变更                                                    │
│                                                                  │
│  上下文                                                          │
│  ├── 用户信息                                                    │
│  ├── 设备信息                                                    │
│  ├── 应用状态                                                    │
│  └── 自定义标签                                                  │
│                                                                  │
│  Release 追踪                                                    │
│  ├── 版本关联                                                    │
│  ├── Source Map                                                 │
│  └── ProGuard 映射                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 错误分级

| 级别 | 说明 | 处理方式 |
|------|------|----------|
| Fatal | 崩溃 | 立即告警 |
| Error | 功能异常 | 24h 内处理 |
| Warning | 潜在问题 | 定期检查 |
| Info | 信息记录 | 分析参考 |

---

## 5. 日志管理

### 5.1 日志框架

```
┌─────────────────────────────────────────────────────────────────┐
│                    日志架构                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Timber                                                         │
│  │                                                              │
│  ├── Debug Tree (开发)                                          │
│  │   └── Logcat 输出                                           │
│  │                                                              │
│  ├── Release Tree (生产)                                        │
│  │   ├── 过滤敏感信息                                           │
│  │   ├── 上报 Crashlytics                                       │
│  │   └── 上报 Sentry                                            │
│  │                                                              │
│  └── File Tree (可选)                                           │
│      └── 本地文件记录                                            │
│                                                                  │
│  日志级别                                                        │
│  ├── VERBOSE  详细调试                                          │
│  ├── DEBUG    调试信息                                          │
│  ├── INFO     一般信息                                          │
│  ├── WARN     警告                                              │
│  └── ERROR    错误                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 日志规范

| 场景 | 级别 | 内容要求 |
|------|------|----------|
| 用户操作 | INFO | 操作类型 + 上下文 |
| API 调用 | DEBUG | 请求/响应摘要 |
| 异常捕获 | ERROR | 异常类型 + 堆栈 |
| 性能点 | DEBUG | 耗时 + 数据量 |

---

## 6. 用户行为分析

### 6.1 Firebase Analytics

```
┌─────────────────────────────────────────────────────────────────┐
│                    Analytics 事件                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心事件                                                        │
│  ├── app_open                 应用打开                          │
│  ├── screen_view              页面访问                          │
│  ├── login                    登录                              │
│  └── sign_up                  注册                              │
│                                                                  │
│  阅读事件                                                        │
│  ├── book_open                打开书籍                          │
│  ├── book_read                阅读书籍                          │
│  ├── chapter_complete         完成章节                          │
│  └── book_complete            完成书籍                          │
│                                                                  │
│  AI 功能事件                                                     │
│  ├── ai_lookup                AI 查词                           │
│  ├── ai_translate             AI 翻译                           │
│  └── ai_qa                    AI 问答                           │
│                                                                  │
│  学习事件                                                        │
│  ├── vocabulary_add           添加词汇                          │
│  ├── vocabulary_review        复习词汇                          │
│  └── learning_session         学习会话                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 用户属性

| 属性 | 说明 |
|------|------|
| user_type | 免费/付费用户 |
| reading_level | 阅读级别 |
| preferred_language | 偏好语言 |
| books_count | 书籍数量 |

---

## 7. 业务指标监控

### 7.1 核心业务指标

```
┌─────────────────────────────────────────────────────────────────┐
│                    业务指标                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户指标                                                        │
│  ├── DAU (日活跃用户)                                           │
│  ├── MAU (月活跃用户)                                           │
│  ├── 留存率 (D1, D7, D30)                                      │
│  └── 会话时长                                                    │
│                                                                  │
│  阅读指标                                                        │
│  ├── 日均阅读时长                                                │
│  ├── 书籍完读率                                                  │
│  ├── 章节完成数                                                  │
│  └── 阅读速度                                                    │
│                                                                  │
│  功能指标                                                        │
│  ├── AI 功能使用率                                              │
│  ├── 词汇添加量                                                  │
│  ├── 学习完成率                                                  │
│  └── TTS 使用时长                                               │
│                                                                  │
│  转化指标                                                        │
│  ├── 注册转化率                                                  │
│  ├── 付费转化率                                                  │
│  └── 订阅续费率                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 漏斗分析

| 漏斗阶段 | 指标 |
|----------|------|
| 安装 → 注册 | 注册转化率 |
| 注册 → 首次阅读 | 激活率 |
| 首次阅读 → 活跃 | 留存率 |
| 活跃 → 付费 | 付费转化率 |

---

## 8. 告警配置

### 8.1 告警规则

```
┌─────────────────────────────────────────────────────────────────┐
│                    告警规则配置                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  崩溃告警                                                        │
│  ├── 触发: 崩溃率 > 0.5%                                        │
│  ├── 通知: Slack + 邮件                                         │
│  └── 级别: P0                                                   │
│                                                                  │
│  性能告警                                                        │
│  ├── 触发: 启动时间 > 5s (P90)                                  │
│  ├── 通知: Slack                                                │
│  └── 级别: P1                                                   │
│                                                                  │
│  API 告警                                                        │
│  ├── 触发: 错误率 > 5%                                          │
│  ├── 通知: Slack + PagerDuty                                    │
│  └── 级别: P1                                                   │
│                                                                  │
│  业务告警                                                        │
│  ├── 触发: DAU 下降 > 20%                                       │
│  ├── 通知: 邮件                                                  │
│  └── 级别: P2                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 告警级别

| 级别 | 响应时间 | 说明 |
|------|----------|------|
| P0 | 15 分钟 | 严重故障 |
| P1 | 1 小时 | 功能受损 |
| P2 | 24 小时 | 轻微问题 |
| P3 | 一周内 | 优化建议 |

---

## 9. Android Vitals

### 9.1 核心 Vitals

```
┌─────────────────────────────────────────────────────────────────┐
│                    Android Vitals                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  核心指标                                                        │
│  ├── 崩溃率                                                      │
│  │   └── 目标: < 1.09% (达到 Play 商店标准)                     │
│  │                                                              │
│  ├── ANR 率                                                     │
│  │   └── 目标: < 0.47%                                         │
│  │                                                              │
│  ├── 过度唤醒                                                    │
│  │   └── 目标: < 10 次/小时                                    │
│  │                                                              │
│  └── 后台 WiFi 扫描                                             │
│      └── 目标: < 4 次/小时                                      │
│                                                                  │
│  电池指标                                                        │
│  ├── 后台网络使用                                                │
│  ├── 前台服务使用                                                │
│  └── 位置请求频率                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Play Console 监控

| 报告 | 内容 |
|------|------|
| 崩溃和 ANR | 按版本/设备统计 |
| 性能 | 启动时间、渲染 |
| 评分和评论 | 用户反馈 |
| 统计信息 | 安装、卸载 |

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [performance.md](./performance.md) | 性能优化 |
| [error-handling.md](./error-handling.md) | 错误处理 |
| [release-process.md](./release-process.md) | 发布监控 |

---

*最后更新: 2025-12-31*

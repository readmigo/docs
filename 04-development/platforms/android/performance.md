# Android 性能优化

> Compose 优化 + 内存管理 + 启动优化

---

## 1. 性能目标

### 1.1 核心指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 冷启动 | < 2s | 首次启动到可交互 |
| 热启动 | < 500ms | 后台恢复 |
| 帧率 | 60fps | 滑动/动画流畅 |
| 内存 | < 150MB | 正常使用峰值 |
| APK 大小 | < 30MB | 压缩后大小 |

### 1.2 阅读器指标

| 指标 | 目标 |
|------|------|
| 书籍打开 | < 1s |
| 翻页延迟 | < 100ms |
| 章节加载 | < 500ms |
| AI 响应 | < 3s |

---

## 2. Compose 优化

### 2.1 重组优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    重组优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  减少不必要重组                                                  │
│  ├── 使用 remember 缓存计算                                     │
│  ├── 使用 derivedStateOf 派生状态                               │
│  ├── 参数使用稳定类型                                            │
│  └── 避免在 Composable 中创建对象                               │
│                                                                  │
│  状态管理                                                        │
│  ├── 状态提升到合适层级                                          │
│  ├── 使用 Immutable 数据类                                      │
│  └── collectAsStateWithLifecycle                               │
│                                                                  │
│  Lambda 优化                                                    │
│  ├── 使用方法引用                                                │
│  └── remember lambda                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 LazyList 优化

| 优化项 | 说明 |
|--------|------|
| key | 为每个 item 提供唯一 key |
| contentType | 指定 item 类型 |
| LazyListState | 复用 state |
| 分页加载 | Paging 3 集成 |

### 2.3 稳定性注解

```
┌─────────────────────────────────────────────────────────────────┐
│                    稳定性优化                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  @Stable                                                        │
│  └── 标记稳定类型                                                │
│                                                                  │
│  @Immutable                                                     │
│  └── 标记不可变类型                                              │
│                                                                  │
│  kotlinx.collections.immutable                                  │
│  └── 使用不可变集合                                              │
│                                                                  │
│  编译器报告                                                      │
│  └── 检查重组原因                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 启动优化

### 3.1 冷启动优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    启动优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Application 初始化                                              │
│  ├── 延迟初始化非必要 SDK                                        │
│  ├── 使用 App Startup 库                                        │
│  └── 后台线程初始化                                              │
│                                                                  │
│  首屏优化                                                        │
│  ├── 减少首屏 Composable 复杂度                                 │
│  ├── 使用 Splash Screen API                                    │
│  └── 预加载关键数据                                              │
│                                                                  │
│  资源优化                                                        │
│  ├── 移除未使用资源                                              │
│  ├── 压缩图片资源                                                │
│  └── 使用 WebP 格式                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 App Startup

| 初始化项 | 时机 | 优先级 |
|----------|------|--------|
| 日志库 | 启动时 | 高 |
| 网络库 | 启动时 | 高 |
| 数据库 | 延迟 | 中 |
| Analytics | 延迟 | 低 |
| 推送 | 后台 | 低 |

---

## 4. 内存优化

### 4.1 内存管理

```
┌─────────────────────────────────────────────────────────────────┐
│                    内存优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  图片内存                                                        │
│  ├── Coil 内存缓存限制                                          │
│  ├── 按需加载不同尺寸                                            │
│  └── 及时释放大图                                                │
│                                                                  │
│  阅读器内存                                                      │
│  ├── 只保留可视页面 + 前后各 1 页                               │
│  ├── 章节按需加载                                                │
│  └── 大文件分块处理                                              │
│                                                                  │
│  避免泄漏                                                        │
│  ├── 使用 viewModelScope                                        │
│  ├── 及时取消协程                                                │
│  └── 避免静态持有 Context                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 内存监控

| 工具 | 用途 |
|------|------|
| LeakCanary | 内存泄漏检测 |
| Android Profiler | 内存分析 |
| StrictMode | 开发期检测 |

---

## 5. 网络优化

### 5.1 请求优化

| 优化项 | 说明 |
|--------|------|
| 连接复用 | OkHttp 连接池 |
| 请求合并 | 批量请求 |
| 数据压缩 | gzip 压缩 |
| 缓存策略 | HTTP 缓存 |

### 5.2 图片加载

```
┌─────────────────────────────────────────────────────────────────┐
│                    Coil 图片优化                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  缓存配置                                                        │
│  ├── 内存缓存: 25% 可用内存                                     │
│  └── 磁盘缓存: 250MB                                            │
│                                                                  │
│  请求优化                                                        │
│  ├── 指定目标尺寸                                                │
│  ├── 使用占位图                                                  │
│  └── 错误重试                                                    │
│                                                                  │
│  格式支持                                                        │
│  ├── WebP                                                       │
│  ├── AVIF                                                       │
│  └── SVG                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 阅读器优化

### 6.1 EPUB 渲染优化

| 优化项 | 说明 |
|--------|------|
| 分页预渲染 | 预渲染前后页 |
| 章节延迟加载 | 按需加载章节 |
| 图片懒加载 | 可视区域加载 |
| 虚拟化 | 长章节虚拟滚动 |

### 6.2 翻页优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    翻页性能优化                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  预加载策略                                                      │
│  ├── 当前页 + 前后各 1 页常驻内存                               │
│  ├── 翻页时预加载下一页                                          │
│  └── 空闲时预渲染                                                │
│                                                                  │
│  动画优化                                                        │
│  ├── 使用硬件加速                                                │
│  ├── 60fps 动画帧率                                             │
│  └── 减少过度绘制                                                │
│                                                                  │
│  手势优化                                                        │
│  ├── 低延迟响应                                                  │
│  └── 平滑跟手                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. APK 优化

### 7.1 包体优化

| 优化项 | 效果 |
|--------|------|
| R8 混淆 | 代码缩减 |
| 资源压缩 | 移除未使用资源 |
| 图片压缩 | WebP 转换 |
| 动态下发 | 按需下载模块 |
| App Bundle | 按设备分包 |

### 7.2 ProGuard/R8

```
┌─────────────────────────────────────────────────────────────────┐
│                    R8 配置要点                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  保留规则                                                        │
│  ├── Serialization 类                                           │
│  ├── Retrofit 接口                                              │
│  ├── Room Entity                                                │
│  └── Hilt 组件                                                  │
│                                                                  │
│  优化选项                                                        │
│  ├── 代码缩减                                                    │
│  ├── 资源缩减                                                    │
│  ├── 混淆                                                        │
│  └── 优化                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 监控与分析

### 8.1 性能监控

| 工具 | 监控项 |
|------|--------|
| Firebase Performance | 启动时间、网络延迟 |
| Android Vitals | ANR、崩溃率 |
| Sentry | 错误追踪 |

### 8.2 性能分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能分析工具                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Android Studio Profiler                                        │
│  ├── CPU Profiler                                               │
│  ├── Memory Profiler                                            │
│  ├── Network Profiler                                           │
│  └── Energy Profiler                                            │
│                                                                  │
│  Compose 专用                                                   │
│  ├── Layout Inspector                                           │
│  ├── Recomposition 计数                                         │
│  └── 编译器稳定性报告                                            │
│                                                                  │
│  Baseline Profiles                                              │
│  └── 预编译热路径                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [offline.md](./offline.md) | 离线优化 |
| [monitoring.md](./monitoring.md) | 性能监控 |

---

*最后更新: 2025-12-31*

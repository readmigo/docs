# Android 测试策略

> JUnit 5 + MockK + Compose Testing

---

## 1. 测试金字塔

```
┌─────────────────────────────────────────────────────────────────┐
│                      测试金字塔                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                         UI Tests                                │
│                        /         \                              │
│                       /  Compose   \                            │
│                      /   Testing    \                           │
│                     ─────────────────                           │
│                    /                   \                        │
│                   /  Integration Tests  \                       │
│                  /   Hilt + Room + API   \                      │
│                 ───────────────────────────                     │
│                /                           \                    │
│               /       Unit Tests            \                   │
│              /   ViewModel, UseCase, Repo    \                  │
│             ─────────────────────────────────────               │
│                                                                  │
│  比例: Unit 70% | Integration 20% | UI 10%                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 测试工具栈

| 工具 | 用途 |
|------|------|
| JUnit 5 | 测试框架 |
| MockK | Kotlin Mock 库 |
| Turbine | Flow 测试 |
| Compose Testing | UI 测试 |
| Hilt Testing | DI 测试 |
| Robolectric | JVM Android 测试 |

---

## 3. 单元测试

### 3.1 ViewModel 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    ViewModel 测试结构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  测试内容                                                        │
│  ├── 初始状态验证                                                │
│  ├── Action 处理                                                │
│  ├── State 更新                                                 │
│  ├── SideEffect 发送                                            │
│  └── 错误处理                                                    │
│                                                                  │
│  Mock 依赖                                                       │
│  ├── UseCase (MockK)                                            │
│  └── SavedStateHandle                                           │
│                                                                  │
│  测试工具                                                        │
│  ├── Turbine (Flow 测试)                                        │
│  └── TestDispatcher                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 UseCase 测试

| 测试点 | 说明 |
|--------|------|
| 业务逻辑 | 核心逻辑验证 |
| 参数校验 | 输入验证 |
| 异常处理 | 错误场景 |
| 边界条件 | 边界值测试 |

### 3.3 Repository 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    Repository 测试策略                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Mock DataSource                                                │
│  ├── Remote DataSource                                          │
│  └── Local DataSource                                           │
│                                                                  │
│  测试场景                                                        │
│  ├── 网络成功 + 缓存成功                                        │
│  ├── 网络成功 + 缓存失败                                        │
│  ├── 网络失败 + 缓存命中                                        │
│  └── 网络失败 + 缓存失败                                        │
│                                                                  │
│  数据转换                                                        │
│  ├── DTO → Domain Model                                         │
│  └── Domain Model → Entity                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 集成测试

### 4.1 数据库测试

| 测试项 | 工具 |
|--------|------|
| DAO 测试 | Room Testing |
| 迁移测试 | MigrationTestHelper |
| 数据完整性 | 真实数据库实例 |

### 4.2 API 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    API 集成测试                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  MockWebServer                                                  │
│  ├── 模拟 API 响应                                              │
│  ├── 验证请求格式                                                │
│  └── 测试错误处理                                                │
│                                                                  │
│  测试内容                                                        │
│  ├── 请求路径                                                    │
│  ├── 请求头                                                      │
│  ├── 请求体                                                      │
│  ├── 响应解析                                                    │
│  └── 错误码处理                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. UI 测试

### 5.1 Compose 测试

| API | 用途 |
|-----|------|
| onNodeWithText | 文本查找 |
| onNodeWithTag | 标签查找 |
| performClick | 点击操作 |
| assertIsDisplayed | 显示断言 |
| assertTextEquals | 文本断言 |

### 5.2 测试结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Compose 测试结构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  @get:Rule                                                      │
│  val composeTestRule = createComposeRule()                     │
│                                                                  │
│  测试步骤                                                        │
│  ├── 1. 设置 UI 内容                                            │
│  │   └── setContent { MyScreen() }                             │
│  │                                                              │
│  ├── 2. 查找节点                                                │
│  │   └── onNodeWithText("...")                                 │
│  │                                                              │
│  ├── 3. 执行操作                                                │
│  │   └── performClick()                                        │
│  │                                                              │
│  └── 4. 验证结果                                                │
│      └── assertIsDisplayed()                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 截图测试

| 工具 | 说明 |
|------|------|
| Paparazzi | JVM 截图测试 |
| Shot | 设备截图对比 |

---

## 6. 测试覆盖率

### 6.1 覆盖率目标

| 层级 | 目标 |
|------|------|
| ViewModel | 90%+ |
| UseCase | 95%+ |
| Repository | 85%+ |
| 整体 | 80%+ |

### 6.2 Jacoco 配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    Jacoco 配置                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  排除项                                                          │
│  ├── **/di/**                    DI 模块                        │
│  ├── **/*_Factory.*              Hilt 生成                      │
│  ├── **/*_HiltModules*           Hilt 模块                      │
│  ├── **/BuildConfig.*            构建配置                       │
│  └── **/*Composable*             Compose 函数                   │
│                                                                  │
│  报告格式                                                        │
│  ├── HTML                                                       │
│  └── XML (CI 集成)                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. CI 集成

### 7.1 测试流水线

```
┌─────────────────────────────────────────────────────────────────┐
│                    CI 测试流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PR 提交                                                         │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │   Lint      │  ktlint + detekt                              │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │ Unit Tests  │  ./gradlew test                               │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  Coverage   │  Jacoco 报告                                   │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │    Build    │  ./gradlew assembleDebug                      │
│  └─────────────┘                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 测试命令

| 命令 | 说明 |
|------|------|
| `./gradlew test` | 运行单元测试 |
| `./gradlew connectedAndroidTest` | 运行 UI 测试 |
| `./gradlew jacocoTestReport` | 生成覆盖率 |
| `./gradlew lintDebug` | Lint 检查 |

---

## 8. 测试最佳实践

### 8.1 命名规范

| 格式 | 示例 |
|------|------|
| 方法名 | `test_functionName_condition_expectedResult` |
| Given-When-Then | `givenUserLoggedIn_whenClickLogout_thenNavigateToLogin` |

### 8.2 测试隔离

```
┌─────────────────────────────────────────────────────────────────┐
│                    测试隔离原则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  每个测试                                                        │
│  ├── 独立运行                                                    │
│  ├── 不依赖执行顺序                                              │
│  ├── 清理副作用                                                  │
│  └── 使用独立测试数据                                            │
│                                                                  │
│  @BeforeEach                                                    │
│  ├── 重置 Mock                                                  │
│  └── 初始化测试数据                                              │
│                                                                  │
│  @AfterEach                                                     │
│  └── 清理资源                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [error-handling.md](./error-handling.md) | 错误处理 |
| [../shared/testing-strategy.md](../shared/testing-strategy.md) | 跨平台测试 |

---

*最后更新: 2025-12-31*

# 数据流与系统集成

## Content Studio 在整体流程中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           EPUB 内容处理完整流程                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  EPUB    │
    │  文件    │
    └────┬─────┘
         │
         ▼
┌────────────────────┐
│    Pipeline        │
│   (EPUB 解析)      │
│                    │
│ • 解压 EPUB        │
│ • 解析元数据       │
│ • 提取章节内容     │
│ • 基础 HTML 清理   │
└────────┬───────────┘
         │
         │ 原始解析结果
         ▼
┌────────────────────────────────────────────────────────┐
│                  Content Studio                         │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌────────────┐ │
│  │ 自动应用    │───▶│ 人工校正    │───▶│ 质量审核   │ │
│  │ 已学规则    │    │ & 修复      │    │ & 发布     │ │
│  └─────────────┘    └─────────────┘    └────────────┘ │
│         ▲                  │                           │
│         │                  │                           │
│         │    ┌─────────────▼─────────────┐            │
│         │    │       学习系统             │            │
│         │    │   • 模式识别              │            │
│         │    │   • 规则生成              │            │
│         └────│   • 置信度计算            │            │
│              └───────────────────────────┘            │
└─────────────────────────┬──────────────────────────────┘
                          │
                          │ 校正后的内容
                          ▼
              ┌───────────────────────┐
              │   Readmigo 数据库     │
              │                       │
              │ • books 表            │
              │ • chapters 表         │
              │ • content_corrections │
              │ • correction_rules    │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │    用户端 APP         │
              │   (iOS / Android)     │
              └───────────────────────┘
```

## 数据流详解

### 输入数据

| 来源 | 数据类型 | 说明 |
|------|----------|------|
| Pipeline | 原始 HTML | 经过初步解析的章节内容 |
| Pipeline | 书籍元数据 | 标题、作者、封面等 |
| 数据库 | 校正规则 | 已积累的自动校正规则 |
| 数据库 | 学习模式 | 从历史校正中学习到的模式 |

### 输出数据

| 目标 | 数据类型 | 说明 |
|------|----------|------|
| 数据库 | 校正后 HTML | 经过人工校正的章节内容 |
| 数据库 | 校正日志 | 每次校正操作的详细记录 |
| 数据库 | 新规则 | 从学习模式转化的规则 |

## 数据库表关系

```
┌─────────────────┐       ┌─────────────────┐
│     books       │       │    chapters     │
├─────────────────┤       ├─────────────────┤
│ id              │◄──────│ book_id         │
│ title           │       │ original_html   │
│ content_status  │       │ corrected_html  │
│ ...             │       │ ...             │
└────────┬────────┘       └────────┬────────┘
         │                         │
         │    ┌────────────────────┘
         │    │
         ▼    ▼
┌─────────────────────────┐
│  content_corrections    │
├─────────────────────────┤
│ id                      │
│ book_id                 │
│ chapter_id              │
│ fix_type                │
│ before_html             │
│ after_html              │
│ status                  │
│ rule_id (nullable)      │
└───────────┬─────────────┘
            │
            │ 聚合分析
            ▼
┌─────────────────────────┐       ┌─────────────────────┐
│    learned_patterns     │──────▶│   correction_rules  │
├─────────────────────────┤       ├─────────────────────┤
│ pattern_hash            │       │ id                  │
│ action_type             │       │ name                │
│ selector_pattern        │       │ selector            │
│ occurrences             │       │ action_type         │
│ confidence              │       │ source (learned/    │
│ status (pending/        │       │         builtin/    │
│         approved)       │       │         custom)     │
└─────────────────────────┘       │ confidence          │
                                  │ is_active           │
                                  └─────────────────────┘
```

## 状态流转

### 书籍内容状态

```
          ┌──────────────┐
          │   pending    │  待处理
          └──────┬───────┘
                 │ Pipeline 解析完成
                 ▼
          ┌──────────────┐
          │  auto_fixed  │  已自动修复
          └──────┬───────┘
                 │ 进入 Content Studio
                 ▼
          ┌──────────────┐
          │  in_review   │  审核中
          └──────┬───────┘
                 │ 人工校正完成
                 ▼
          ┌──────────────┐
          │  approved    │  已批准
          └──────┬───────┘
                 │ 发布
                 ▼
          ┌──────────────┐
          │  published   │  已发布
          └──────────────┘
```

### 修复项状态

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ auto_applied│     │pending_confirm│    │ suggestion  │
│  (自动应用) │     │  (待确认)    │     │   (建议)    │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │                   │                   │
       ▼                   ▼                   ▼
┌──────────────────────────────────────────────────────┐
│                    人工审核决策                        │
└──────────────────────────────────────────────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  confirmed  │     │  reverted   │     │  rejected   │
│   (已确认)  │     │  (已回滚)   │     │  (已拒绝)   │
└─────────────┘     └─────────────┘     └─────────────┘
```

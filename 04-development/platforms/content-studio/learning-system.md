# 学习系统

## 系统概述

学习系统从人工校正操作中自动识别模式，生成可复用的校正规则，实现知识积累和自动化校正。

## 学习流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         学习系统流程                                  │
└─────────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │  人工校正    │  运营人员执行校正操作
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │  记录日志    │  记录每次校正的详细信息
     │              │  • 操作类型
     │              │  • 选择器
     │              │  • 前后内容
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │  模式识别    │  分析相似的校正操作
     │              │  • 相同选择器
     │              │  • 相同操作类型
     │              │  • 相似内容模式
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │  聚类分析    │  将相似操作聚合为模式
     │              │  • 计算哈希值
     │              │  • 统计出现次数
     │              │  • 记录涉及书籍数
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │  置信度计算  │  评估模式可靠性
     │              │  • 出现频率
     │              │  • 跨书籍一致性
     │              │  • 人工确认比例
     └──────┬───────┘
            │
            ├─────────────────────────────────┐
            │                                 │
            ▼                                 ▼
     ┌──────────────┐                 ┌──────────────┐
     │ 高置信度     │                 │ 中/低置信度   │
     │ (≥95%)      │                 │ (<95%)       │
     └──────┬───────┘                 └──────┬───────┘
            │                                 │
            │ 自动转化                        │ 待审批
            ▼                                 ▼
     ┌──────────────┐                 ┌──────────────┐
     │  生成规则    │                 │  学习报告    │
     │  自动启用    │                 │  人工审批    │
     └──────────────┘                 └──────────────┘
```

## 置信度等级

| 置信度 | 等级 | 处理方式 | 说明 |
|--------|------|----------|------|
| ≥95% | 高 | 自动应用 | 直接应用，无需人工确认 |
| 80%-94% | 中 | 标记待确认 | 应用但需人工确认 |
| <80% | 低 | 仅建议 | 仅作为建议展示，不自动应用 |

## 置信度计算公式

```
置信度 = W1 × 出现频率分数 + W2 × 一致性分数 + W3 × 确认率分数

其中:
  - W1 = 0.3 (出现频率权重)
  - W2 = 0.4 (跨书籍一致性权重)
  - W3 = 0.3 (人工确认率权重)

出现频率分数 = min(出现次数 / 100, 1.0)
一致性分数   = 涉及书籍数 / 总处理书籍数
确认率分数   = 确认次数 / (确认次数 + 拒绝次数)
```

## 模式识别策略

### 识别维度

```
┌─────────────────────────────────────────────────────────┐
│                    模式识别维度                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌───────────────┐                                      │
│  │  选择器模式   │  CSS 选择器相似度                     │
│  │               │  例: p:empty, div:empty → *:empty    │
│  └───────────────┘                                      │
│                                                          │
│  ┌───────────────┐                                      │
│  │  操作类型     │  remove, merge, wrap, unwrap, etc.  │
│  │               │                                      │
│  └───────────────┘                                      │
│                                                          │
│  ┌───────────────┐                                      │
│  │  内容模式     │  正则表达式匹配                       │
│  │               │  例: 空白内容、特定格式                │
│  └───────────────┘                                      │
│                                                          │
│  ┌───────────────┐                                      │
│  │  上下文特征   │  前后元素关系                         │
│  │               │  例: 段落合并时的前后段落特征          │
│  └───────────────┘                                      │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 模式哈希计算

```
模式哈希 = SHA256(操作类型 + 选择器模式 + 内容正则)

示例:
  - remove + p:empty + ^$ → abc123...
  - merge + p + ^[a-z]   → def456...
```

## 规则生命周期

```
┌──────────────┐
│   待审批     │  新学习到的模式
│  (pending)   │
└──────┬───────┘
       │
       ├───────────────────┬───────────────────┐
       │                   │                   │
       ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   已批准     │    │   已拒绝     │    │ 自动转化     │
│  (approved)  │    │  (rejected)  │    │ (置信度≥95%) │
└──────┬───────┘    └──────────────┘    └──────┬───────┘
       │                                       │
       └───────────────┬───────────────────────┘
                       │
                       ▼
               ┌──────────────┐
               │  活跃规则    │  应用于新书籍
               │  (active)    │
               └──────┬───────┘
                      │
           ┌──────────┴──────────┐
           │                     │
           ▼                     ▼
    ┌──────────────┐      ┌──────────────┐
    │   禁用       │      │   废弃       │
    │  (disabled)  │      │ (deprecated) │
    └──────────────┘      └──────────────┘
```

## 学习报告界面

```
┌──────────────────────────────────────────────────────────────────┐
│  学习报告                                                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  统计概览                                                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │   12    │  │    5    │  │    4    │  │    3    │            │
│  │ 总模式数 │  │ 待审核  │  │ 已批准  │  │ 已拒绝  │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
│                                                                   │
│  筛选: [全部] [待审核] [已批准] [已拒绝]                         │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ ⏳ REMOVE  p:empty                                          │ │
│  │    出现 156 次 | 涉及 12 本书 | 置信度: 96%                 │ │
│  │    样本: Pride and Prejudice: <p></p>                       │ │
│  │                                          [批准] [拒绝] [▼]  │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ ⏳ MERGE  p[style*="text-indent"] + p:not([style])          │ │
│  │    出现 34 次 | 涉及 5 本书 | 置信度: 72%                   │ │
│  │    样本: The Great Gatsby: <p>partial</p><p>text</p>        │ │
│  │                                          [批准] [拒绝] [▼]  │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

## 反馈循环

```
        ┌─────────────────────────────────────────┐
        │              反馈循环                    │
        │                                         │
        │    新书籍 ──────────▶ 应用规则          │
        │       ▲                   │             │
        │       │                   ▼             │
        │       │              人工校正           │
        │       │                   │             │
        │    规则优化 ◀──────── 记录反馈          │
        │       ▲                   │             │
        │       │                   ▼             │
        │       └────────────── 模式学习          │
        │                                         │
        └─────────────────────────────────────────┘

每次校正后:
  ✓ 确认 → 增加规则置信度
  ✗ 回滚 → 降低规则置信度
  ✎ 修改 → 记录变体，可能产生新模式
```

# Dashboard API 集成

## dataProvider 概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       dataProvider 架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  dataProvider 是 React Admin 与后端 API 通信的核心层                         │
│                                                                             │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐       │
│  │ React Admin     │────▶│  dataProvider   │────▶│   REST API      │       │
│  │ 组件            │     │                 │     │   /api/v1/admin │       │
│  └─────────────────┘     └─────────────────┘     └─────────────────┘       │
│                                │                                            │
│                                ▼                                            │
│                    ┌───────────────────────┐                                │
│                    │  请求处理              │                                │
│                    │  • 动态 baseUrl       │                                │
│                    │  • 认证头注入         │                                │
│                    │  • 内容语言过滤       │                                │
│                    │  • 响应格式转换       │                                │
│                    └───────────────────────┘                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API 端点配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       环境 API URL                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  环境             API Base URL                                              │
│  ─────────────────────────────────────────────────────────────────          │
│  Local            http://localhost:3000/api/v1/admin                        │
│  Debug            https://readmigo-debug.fly.dev/api/v1/admin               │
│  Staging          https://staging-api.readmigo.com/api/v1/admin             │
│  Production       https://api.readmigo.com/api/v1/admin                     │
│                                                                             │
│  URL 选择逻辑:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  1. 读取 EnvironmentContext 中的当前环境                                    │
│  2. 从 environments 配置中获取对应 apiUrl                                   │
│  3. 拼接资源路径: baseUrl + '/' + resource                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 请求头配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       HTTP 请求头                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  标准请求头:                                                                 │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    'Content-Type': 'application/json',                                      │
│    'Authorization': 'Bearer {adminToken}',                                  │
│    'X-Admin-Mode': 'true',                                                  │
│    'X-Content-Filter': '{contentLanguage}'                                  │
│  }                                                                          │
│                                                                             │
│  Header 说明:                                                                │
│  ─────────────────────────────────────────────────────────────────          │
│  Authorization      JWT Token 认证                                          │
│  X-Admin-Mode       标识为管理后台请求                                       │
│  X-Content-Filter   内容语言过滤 (all/en/zh)                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## dataProvider 方法

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       核心方法                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  getList(resource, params)                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /{resource}?page={page}&limit={perPage}&sort={field}&order={order}     │
│                                                                             │
│  参数:                                                                       │
│  • pagination: { page, perPage }                                            │
│  • sort: { field, order }                                                   │
│  • filter: { ... }                                                          │
│                                                                             │
│  返回: { data: [...], total: number }                                       │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  getOne(resource, params)                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /{resource}/{id}                                                       │
│                                                                             │
│  参数: { id }                                                               │
│  返回: { data: {...} }                                                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  create(resource, params)                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  POST /{resource}                                                           │
│  Body: { ...data }                                                          │
│                                                                             │
│  参数: { data }                                                             │
│  返回: { data: {...} }                                                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  update(resource, params)                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  PATCH /{resource}/{id}                                                     │
│  Body: { ...data }                                                          │
│                                                                             │
│  参数: { id, data }                                                         │
│  返回: { data: {...} }                                                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  delete(resource, params)                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  DELETE /{resource}/{id}                                                    │
│                                                                             │
│  参数: { id }                                                               │
│  返回: { data: {...} }                                                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  getMany(resource, params)                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /{resource}?ids={id1,id2,id3}                                          │
│                                                                             │
│  参数: { ids: [...] }                                                       │
│  返回: { data: [...] }                                                      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  getManyReference(resource, params)                                         │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /{resource}?{target}={id}                                              │
│                                                                             │
│  参数: { target, id }                                                       │
│  返回: { data: [...], total: number }                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API 端点列表

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       资源端点映射                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  资源              API 路径                          支持操作               │
│  ─────────────────────────────────────────────────────────────────          │
│  books             /api/v1/admin/books              CRUD                    │
│  authors           /api/v1/admin/authors            CRU                     │
│  categories        /api/v1/admin/categories         CRUD                    │
│  booklists         /api/v1/admin/booklists          CRUD                    │
│  users             /api/v1/admin/users              R                       │
│  quotes            /api/v1/admin/quotes             CRUD                    │
│  postcards         /api/v1/admin/postcards          R                       │
│  postcard-templates /api/v1/admin/postcard-templates CRUD                   │
│  messages          /api/v1/admin/messages/threads   R                       │
│  feedback          /api/v1/admin/feedback           R                       │
│  admin/tickets     /api/v1/admin/tickets            R                       │
│  admin/orders      /api/v1/admin/orders             R                       │
│  import/batches    /admin/import/batches            R                       │
│                                                                             │
│  CRUD = Create, Read, Update, Delete                                        │
│  CRU = Create, Read, Update (无Delete)                                      │
│  R = Read Only                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 特殊端点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       特殊 API 端点                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  认证端点:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  POST /api/v1/admin/auth/login                                              │
│  Body: { email, password }                                                  │
│  Response: { accessToken, user }                                            │
│                                                                             │
│  功能开关端点:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  GET    /api/v1/config/admin/flags        获取所有功能开关                  │
│  POST   /api/v1/config/admin/flags        创建功能开关                      │
│  PUT    /api/v1/config/admin/flags/:id    更新功能开关                      │
│  DELETE /api/v1/config/admin/flags/:id    删除功能开关                      │
│                                                                             │
│  AI 统计端点:                                                                │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /api/v1/admin/ai/stats               获取 AI 使用统计                  │
│                                                                             │
│  分析端点:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /admin/analytics/overview            仪表盘概览数据                    │
│  GET /admin/analytics/user-growth         用户增长趋势                      │
│  GET /admin/analytics/reading-activity    阅读活跃度                        │
│  GET /admin/analytics/ai-usage            AI 使用分布                       │
│  GET /admin/analytics/top-books           热门书籍排行                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 响应格式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       API 响应格式                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  列表响应:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "items": [                                                               │
│      { "id": "1", "title": "...", ... },                                    │
│      { "id": "2", "title": "...", ... }                                     │
│    ],                                                                       │
│    "total": 100,                                                            │
│    "page": 1,                                                               │
│    "limit": 25                                                              │
│  }                                                                          │
│                                                                             │
│  dataProvider 转换:                                                          │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "data": [...items],                                                      │
│    "total": 100                                                             │
│  }                                                                          │
│                                                                             │
│  单条响应:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "id": "1",                                                               │
│    "title": "...",                                                          │
│    ...                                                                      │
│  }                                                                          │
│                                                                             │
│  dataProvider 转换:                                                          │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "data": { "id": "1", "title": "...", ... }                               │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 分页与排序

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       分页排序参数                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  分页参数:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • page: 页码 (从1开始)                                                     │
│  • limit / perPage: 每页数量                                                │
│                                                                             │
│  排序参数:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • sort: 排序字段名                                                         │
│  • order: ASC | DESC                                                        │
│                                                                             │
│  示例请求:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /api/v1/admin/books?page=2&limit=25&sort=createdAt&order=DESC          │
│                                                                             │
│  筛选参数:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 直接作为查询参数传递                                                      │
│  • 例: ?status=published&difficulty=intermediate                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 错误处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       错误处理                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  HTTP 状态码处理:                                                            │
│  ─────────────────────────────────────────────────────────────────          │
│  200  OK           请求成功                                                 │
│  201  Created      创建成功                                                 │
│  400  Bad Request  请求参数错误                                             │
│  401  Unauthorized Token 无效/过期 → 触发登出                               │
│  403  Forbidden    权限不足 → 触发登出                                      │
│  404  Not Found    资源不存在                                               │
│  500  Server Error 服务器错误                                               │
│                                                                             │
│  错误响应格式:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "statusCode": 400,                                                       │
│    "message": "Validation failed",                                          │
│    "errors": [                                                              │
│      { "field": "title", "message": "Title is required" }                   │
│    ]                                                                        │
│  }                                                                          │
│                                                                             │
│  React Admin 错误通知:                                                       │
│  ─────────────────────────────────────────────────────────────────          │
│  • 自动显示 Snackbar 错误消息                                               │
│  • 支持国际化错误消息                                                        │
│  • 401/403 自动重定向到登录页                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 请求流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       完整请求流程                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 组件触发                                                                 │
│     ─────────────────────────────────────────────────────────────────       │
│     <List resource="books"> 或 useGetList('books', params)                  │
│                                                                             │
│  2. React Admin 调用 dataProvider                                           │
│     ─────────────────────────────────────────────────────────────────       │
│     dataProvider.getList('books', { pagination, sort, filter })             │
│                                                                             │
│  3. 获取当前环境                                                             │
│     ─────────────────────────────────────────────────────────────────       │
│     const env = useEnvironment() → 'production'                             │
│     const baseUrl = environments['production'].apiUrl                       │
│                                                                             │
│  4. 构建请求                                                                 │
│     ─────────────────────────────────────────────────────────────────       │
│     URL: https://api.readmigo.com/api/v1/admin/books?page=1&limit=25        │
│     Headers: {                                                              │
│       Authorization: 'Bearer xxx',                                          │
│       X-Admin-Mode: 'true',                                                 │
│       X-Content-Filter: 'en'                                                │
│     }                                                                       │
│                                                                             │
│  5. 发送请求                                                                 │
│     ─────────────────────────────────────────────────────────────────       │
│     fetch(url, { headers })                                                 │
│                                                                             │
│  6. 处理响应                                                                 │
│     ─────────────────────────────────────────────────────────────────       │
│     const { items, total } = await response.json()                          │
│     return { data: items, total }                                           │
│                                                                             │
│  7. 更新 UI                                                                  │
│     ─────────────────────────────────────────────────────────────────       │
│     React Admin 更新内部状态 → 组件重新渲染                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

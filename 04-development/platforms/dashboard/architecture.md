# Dashboard 架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Dashboard 系统架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         表现层 (Presentation)                          │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │  │
│  │  │ CustomLayout │  │ CustomAppBar │  │  CustomMenu  │                 │  │
│  │  │   布局容器   │  │    顶部导航   │  │   侧边菜单   │                 │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                 │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐     │  │
│  │  │                      页面组件 (Pages)                         │     │  │
│  │  │  Dashboard │ Books │ Users │ Orders │ AI Stats │ ...         │     │  │
│  │  └──────────────────────────────────────────────────────────────┘     │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         状态层 (State Management)                      │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                        │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │ EnvironmentCtx   │  │ ContentLangCtx   │  │ React Admin State│    │  │
│  │  │   环境上下文     │  │  内容语言上下文   │  │   内置状态管理   │    │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         服务层 (Services)                              │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                        │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │   authProvider   │  │   dataProvider   │  │ featureFlagsServ │    │  │
│  │  │     认证服务     │  │     数据服务     │  │    功能开关服务   │    │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         网络层 (Network)                               │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │                                                                        │  │
│  │               Fetch API → REST API (NestJS Backend)                   │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 技术栈详情

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           技术栈版本                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心框架                                                                    │
│  ─────────────────────────────────────────────────────────────────          │
│  react                    18.3.1       前端框架                              │
│  typescript               5.6.x        类型系统                              │
│  react-router-dom         7.11.0       路由管理                              │
│                                                                             │
│  Admin 框架                                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  react-admin              5.3.0        Admin框架核心                         │
│  ra-data-simple-rest      5.3.0        REST数据提供者                        │
│  ra-i18n-polyglot         5.3.0        国际化支持                            │
│                                                                             │
│  UI 组件                                                                     │
│  ─────────────────────────────────────────────────────────────────          │
│  @mui/material            6.1.0        Material UI组件库                     │
│  @mui/icons-material      6.1.0        Material图标库                        │
│  @emotion/react           11.13.0      CSS-in-JS样式                         │
│  @emotion/styled          11.13.0      样式组件                              │
│                                                                             │
│  数据可视化                                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  recharts                 2.13.0       图表库                                │
│                                                                             │
│  国际化                                                                      │
│  ─────────────────────────────────────────────────────────────────          │
│  ra-language-chinese      2.0.10       中文语言包                            │
│  ra-language-english      5.0.0        英文语言包                            │
│                                                                             │
│  构建工具                                                                    │
│  ─────────────────────────────────────────────────────────────────          │
│  vite                     5.4.0        构建工具                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据流架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐     │
│  │  用户   │───▶│  React Admin │───▶│ dataProvider │───▶│  REST API   │     │
│  │  操作   │    │    组件      │    │   数据服务   │    │   后端      │     │
│  └─────────┘    └─────────────┘    └──────────────┘    └─────────────┘     │
│       │                                                        │            │
│       │                                                        │            │
│       │         ┌─────────────┐    ┌──────────────┐           │            │
│       │         │  UI 更新    │◀───│  状态更新    │◀──────────┘            │
│       └────────▶│             │    │              │                        │
│                 └─────────────┘    └──────────────┘                        │
│                                                                             │
│  数据请求流程:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  1. 用户在页面组件中触发操作 (列表加载/创建/编辑/删除)                        │
│  2. React Admin 调用 dataProvider 对应方法                                  │
│  3. dataProvider 构建请求 (添加认证头、环境URL、内容语言)                     │
│  4. Fetch API 发送 REST 请求到后端                                          │
│  5. 后端返回响应数据                                                         │
│  6. dataProvider 转换响应格式                                                │
│  7. React Admin 更新内部状态缓存                                             │
│  8. 组件根据新状态重新渲染                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 环境切换架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         环境切换机制                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    EnvironmentSelector 组件                            │  │
│  │                                                                        │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐              │  │
│  │  │  Local  │  │  Debug  │  │ Staging │  │ Production  │              │  │
│  │  │ (警告色)│  │ (警告色)│  │ (信息色)│  │  (成功色)   │              │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────────┘              │  │
│  │                                              │                        │  │
│  │                                              ▼                        │  │
│  │                              ┌─────────────────────────┐              │  │
│  │                              │   生产环境确认对话框    │              │  │
│  │                              │ "确定切换到生产环境?"   │              │  │
│  │                              └─────────────────────────┘              │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                     EnvironmentContext                                 │  │
│  │                                                                        │  │
│  │  状态: { environment: 'local' | 'debug' | 'staging' | 'production' }  │  │
│  │                                                                        │  │
│  │  存储: localStorage.dashboard_environment                             │  │
│  │                                                                        │  │
│  │  事件: dispatch(CustomEvent('environment-changed'))                   │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                       dataProvider                                     │  │
│  │                                                                        │  │
│  │  baseUrl = environments[currentEnvironment].apiUrl                    │  │
│  │                                                                        │  │
│  │  ┌───────────────────────────────────────────────────────────────┐    │  │
│  │  │ local:      http://localhost:3000/api/v1/admin               │    │  │
│  │  │ debug:      https://readmigo-debug.fly.dev/api/v1/admin      │    │  │
│  │  │ staging:    https://staging-api.readmigo.com/api/v1/admin    │    │  │
│  │  │ production: https://api.readmigo.com/api/v1/admin            │    │  │
│  │  └───────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 内容语言过滤架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       内容语言过滤机制                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  设计原则:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 一次选择: 用户在全局设置中选择语言，无需每页选择                          │
│  • 无混合内容: 选择后所有页面只显示该语言内容                                │
│  • 无单项选择: 创建/编辑内容时无需选择语言                                   │
│  • 上下文感知: 所有操作继承全局语言上下文                                    │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                  ContentLanguageSwitch 组件                            │  │
│  │                                                                        │  │
│  │              ┌─────┐  ┌─────┐  ┌─────┐                                │  │
│  │              │ All │  │ EN  │  │ ZH  │                                │  │
│  │              │全部 │  │英文 │  │中文 │                                │  │
│  │              └─────┘  └─────┘  └─────┘                                │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   ContentLanguageContext                               │  │
│  │                                                                        │  │
│  │  状态: { contentLanguage: 'all' | 'en' | 'zh' }                       │  │
│  │                                                                        │  │
│  │  存储: localStorage.contentLanguage                                   │  │
│  │                                                                        │  │
│  │  事件: dispatch(CustomEvent('content-language-changed'))              │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                       请求头注入                                       │  │
│  │                                                                        │  │
│  │  Headers: {                                                           │  │
│  │    'Authorization': 'Bearer {token}',                                 │  │
│  │    'X-Admin-Mode': 'true',                                            │  │
│  │    'X-Content-Filter': '{contentLanguage}'  ← 内容语言过滤            │  │
│  │  }                                                                    │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## React Admin 资源注册

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       资源注册架构 (App.tsx)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  <Admin                                                                     │
│    dataProvider={dataProvider}                                              │
│    authProvider={authProvider}                                              │
│    i18nProvider={i18nProvider}                                              │
│    layout={CustomLayout}                                                    │
│    theme={theme}                                                            │
│  >                                                                          │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │                        标准资源                                      │  │
│    │                                                                      │  │
│    │  Resource: books                                                     │  │
│    │    └── list, create, edit, show                                     │  │
│    │                                                                      │  │
│    │  Resource: authors                                                   │  │
│    │    └── list, edit, show                                             │  │
│    │                                                                      │  │
│    │  Resource: categories                                                │  │
│    │    └── list, create, edit                                           │  │
│    │                                                                      │  │
│    │  Resource: booklists                                                 │  │
│    │    └── list, create, edit, show                                     │  │
│    │                                                                      │  │
│    │  Resource: users                                                     │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: quotes                                                    │  │
│    │    └── list, create, edit, show                                     │  │
│    │                                                                      │  │
│    │  Resource: postcards                                                 │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: postcard-templates                                        │  │
│    │    └── list, create, edit                                           │  │
│    │                                                                      │  │
│    │  Resource: messages                                                  │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: feedback                                                  │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: admin/tickets                                             │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: admin/orders                                              │  │
│    │    └── list, show                                                   │  │
│    │                                                                      │  │
│    │  Resource: import/batches                                            │  │
│    │    └── list                                                         │  │
│    │                                                                      │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │                       自定义路由                                     │  │
│    │                                                                      │  │
│    │  Route: /                     → Dashboard                           │  │
│    │  Route: /ai-stats             → AIStats                             │  │
│    │  Route: /feature-flags        → FeatureFlagsList                    │  │
│    │  Route: /support-dashboard    → SupportDashboard                    │  │
│    │                                                                      │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  </Admin>                                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 认证流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           认证流程                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  正常登录流程:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│  │ 登录页面 │──▶│ authProvider │──▶│ POST /login  │──▶│ 返回 Token   │     │
│  │          │   │   login()    │   │              │   │ + User       │     │
│  └──────────┘   └──────────────┘   └──────────────┘   └──────────────┘     │
│                                                              │              │
│                                                              ▼              │
│                                           ┌─────────────────────────────┐   │
│                                           │      localStorage           │   │
│                                           │  adminToken: JWT            │   │
│                                           │  adminUser: {email, ...}    │   │
│                                           └─────────────────────────────┘   │
│                                                                             │
│  开发模式 (VITE_AUTH_DISABLED=true):                                        │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────┐   ┌──────────────┐   ┌─────────────────────────────────────┐  │
│  │ 任意页面 │──▶│ authProvider │──▶│ 自动注入 Mock Admin                 │  │
│  │          │   │   login()    │   │ {id: 'dev-admin', roles: ['admin']} │  │
│  └──────────┘   └──────────────┘   └─────────────────────────────────────┘  │
│                                                                             │
│  Token 验证流程:                                                             │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────────┐   ┌──────────────┐                                       │
│  │ API 请求     │──▶│ 检查 Token   │                                       │
│  │              │   │              │                                       │
│  └──────────────┘   └──────────────┘                                       │
│                            │                                                │
│                            ▼                                                │
│                   ┌────────────────┐                                        │
│                   │  Token 有效?   │                                        │
│                   └────────────────┘                                        │
│                     │           │                                           │
│                    Yes          No                                          │
│                     │           │                                           │
│                     ▼           ▼                                           │
│              ┌──────────┐  ┌──────────────┐                                 │
│              │ 继续请求 │  │ 跳转登录页   │                                 │
│              │          │  │ 清除存储     │                                 │
│              └──────────┘  └──────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 构建与部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       构建与部署架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  本地开发:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────┐   ┌──────────────┐   ┌──────────────────────────────┐        │
│  │ npm run  │──▶│    Vite      │──▶│ localhost:3001               │        │
│  │   dev    │   │  Dev Server  │   │ HMR + Proxy → localhost:3000 │        │
│  └──────────┘   └──────────────┘   └──────────────────────────────┘        │
│                                                                             │
│  生产构建:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│  │ npm run  │──▶│     tsc      │──▶│    Vite      │──▶│    dist/     │     │
│  │  build   │   │  类型检查    │   │    Build     │   │ 静态资源     │     │
│  └──────────┘   └──────────────┘   └──────────────┘   └──────────────┘     │
│                                                                             │
│  Vercel 部署:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────────────────────┐    │
│  │ Git Push     │──▶│   Vercel     │──▶│  dashboard.readmigo.com     │    │
│  │ (main分支)   │   │   CI/CD      │   │  SPA路由: /* → /index.html  │    │
│  └──────────────┘   └──────────────┘   └──────────────────────────────┘    │
│                                                                             │
│  vercel.json 配置:                                                          │
│  ─────────────────────────────────────────────────────────────────          │
│  {                                                                          │
│    "buildCommand": "npm run build",                                         │
│    "outputDirectory": "dist",                                               │
│    "framework": "vite",                                                     │
│    "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }]       │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

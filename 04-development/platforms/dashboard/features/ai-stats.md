# AI 服务监控

## 概述

AI 服务监控模块提供 AI 功能的使用统计、成本追踪和性能监控功能。

## 路由配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         路由信息                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  路径                /ai-stats                                              │
│  组件                AIStats.tsx                                            │
│  类型                自定义页面 (非标准资源)                                 │
│  权限                所有角色可访问                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 页面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI 统计页面                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  时间范围: [今天] [最近7天] [最近30天] [自定义...]                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        核心指标                                      │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │ 总调用  │ │ 成功率  │ │平均延迟 │ │ 缓存命中│ │ 今日费用│       │    │
│  │  │ 45,678  │ │ 99.2%   │ │ 1.2s    │ │ 45.6%   │ │ $123.45 │       │    │
│  │  │ ↑15%    │ │ ↑0.3%   │ │ ↓0.2s   │ │ ↑5%     │ │ ↑8%     │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌──────────────────────────────┐ ┌──────────────────────────────┐         │
│  │      调用量趋势              │ │       费用趋势               │         │
│  │                              │ │                              │         │
│  │   ╱────────────────         │ │        ╱──────────           │         │
│  │  ╱                          │ │    ╱──╱                      │         │
│  │ ╱                           │ │   ╱                          │         │
│  │                              │ │                              │         │
│  └──────────────────────────────┘ └──────────────────────────────┘         │
│                                                                             │
│  ┌──────────────────────────────┐ ┌──────────────────────────────┐         │
│  │      功能分布饼图            │ │      模型使用分布            │         │
│  │                              │ │                              │         │
│  │      ┌───────┐              │ │    DeepSeek    ████████      │         │
│  │     /  查词   \             │ │    GPT-4o-mini ████          │         │
│  │    │  翻译    │             │ │    Claude      ██            │         │
│  │     \  简化  /              │ │    Local       █             │         │
│  │      └───────┘              │ │                              │         │
│  └──────────────────────────────┘ └──────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         指标说明                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  总调用次数                                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  • 选定时间范围内的 AI 接口调用总次数                                        │
│  • 包含所有功能: 查词、翻译、简化、问答等                                    │
│  • 对比指标: 与上一周期对比                                                  │
│                                                                             │
│  成功率                                                                      │
│  ─────────────────────────────────────────────────────────────────          │
│  • 成功调用 / 总调用 × 100%                                                 │
│  • 成功定义: HTTP 200 且返回有效结果                                        │
│  • 目标: >= 99%                                                             │
│                                                                             │
│  平均延迟                                                                    │
│  ─────────────────────────────────────────────────────────────────          │
│  • 从请求发送到响应接收的平均时间                                            │
│  • 单位: 秒                                                                  │
│  • 目标: < 2秒                                                              │
│                                                                             │
│  缓存命中率                                                                  │
│  ─────────────────────────────────────────────────────────────────          │
│  • 从缓存返回的请求比例                                                      │
│  • 缓存来源: Redis 缓存 + 本地词典                                          │
│  • 目标: >= 40%                                                             │
│                                                                             │
│  费用                                                                        │
│  ─────────────────────────────────────────────────────────────────          │
│  • 选定时间范围内的 AI 服务费用                                              │
│  • 包含所有模型的调用费用                                                    │
│  • 单位: 美元                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 功能分类统计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能类型                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  功能名称          说明                              典型费用/次            │
│  ─────────────────────────────────────────────────────────────────          │
│  explain           单词/短语解释                    $0.001                  │
│  translate         段落翻译                         $0.003                  │
│  simplify          句子简化                         $0.002                  │
│  grammar           语法分析                         $0.002                  │
│  summarize         章节摘要                         $0.005                  │
│  qa                问答                             $0.004                  │
│                                                                             │
│  每个功能显示:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  • 调用次数                                                                  │
│  • 成功率                                                                    │
│  • 平均延迟                                                                  │
│  • 费用占比                                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 模型使用统计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         模型分布                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  模型名称          调用次数     成功率     平均延迟    费用                 │
│  ─────────────────────────────────────────────────────────────────          │
│  Local Dict        12,345       100%       50ms        $0                   │
│  Redis Cache       8,901        99.9%      80ms        $0                   │
│  DeepSeek          15,678       99.5%      1.5s        $78.90               │
│  GPT-4o-mini       5,432        99.2%      2.0s        $32.45               │
│  Claude            2,345        98.8%      2.5s        $12.10               │
│                                                                             │
│  模型优先级:                                                                 │
│  ─────────────────────────────────────────────────────────────────          │
│  1. Local Dict (本地词典) → 无费用，最快                                    │
│  2. Redis Cache (缓存) → 无费用，快速                                       │
│  3. DeepSeek → 低成本，适合大部分场景                                       │
│  4. GPT-4o-mini → 备用模型                                                  │
│  5. Claude → 高质量备用                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 费用分析

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         费用报表                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  本月费用概览:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│                                                                             │
│  总费用: $1,234.56                      预算: $2,000                        │
│  ████████████████████░░░░░░░░░░░░░░░░░░░░  62% 已使用                      │
│                                                                             │
│  按模型分布                             按功能分布                          │
│  ┌───────────────────┐                 ┌───────────────────┐               │
│  │ DeepSeek   $789   │                 │ 查词      $567    │               │
│  │ GPT-4o-mini $345  │                 │ 翻译      $234    │               │
│  │ Claude     $100   │                 │ 语法分析  $189    │               │
│  │                   │                 │ 摘要      $145    │               │
│  │                   │                 │ 其他      $99     │               │
│  └───────────────────┘                 └───────────────────┘               │
│                                                                             │
│  日均费用趋势:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  • 工作日平均: $45.67                                                       │
│  • 周末平均: $32.10                                                         │
│  • 峰值日期: 12月15日 ($78.90)                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 性能监控

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         性能指标                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  延迟分布:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • P50: 0.8s                                                                │
│  • P90: 1.5s                                                                │
│  • P95: 2.0s                                                                │
│  • P99: 3.5s                                                                │
│                                                                             │
│  错误类型分布:                                                               │
│  ─────────────────────────────────────────────────────────────────          │
│  • 超时错误: 45%                                                            │
│  • 模型错误: 30%                                                            │
│  • 速率限制: 15%                                                            │
│  • 其他错误: 10%                                                            │
│                                                                             │
│  健康状态:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  服务        状态      最后检查      响应时间                        │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  DeepSeek    ✅ 正常   1分钟前       1.2s                            │    │
│  │  GPT-4o-mini ✅ 正常   1分钟前       1.8s                            │    │
│  │  Claude      ⚠️ 慢     1分钟前       3.5s                            │    │
│  │  Redis       ✅ 正常   1分钟前       50ms                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API 接口

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API 端点                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  GET /api/v1/admin/ai/stats                                                 │
│  ─────────────────────────────────────────────────────────────────          │
│  参数: startDate, endDate                                                   │
│  返回: {                                                                    │
│    totalCalls: number,                                                      │
│    successRate: number,                                                     │
│    avgLatency: number,                                                      │
│    cacheHitRate: number,                                                    │
│    totalCost: number,                                                       │
│    byFunction: [...],                                                       │
│    byModel: [...],                                                          │
│    dailyTrend: [...]                                                        │
│  }                                                                          │
│                                                                             │
│  GET /api/v1/admin/ai/health                                                │
│  ─────────────────────────────────────────────────────────────────          │
│  返回: 各模型服务健康状态                                                   │
│                                                                             │
│  GET /api/v1/admin/ai/errors                                                │
│  ─────────────────────────────────────────────────────────────────          │
│  参数: startDate, endDate, limit                                            │
│  返回: 错误日志列表                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

# 功能开关

## 概述

功能开关模块提供功能配置管理，支持按环境启用/禁用功能，实现灰度发布和功能控制。

## 路由配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         路由信息                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  路径                /feature-flags                                         │
│  组件                FeatureFlagsList.tsx                                   │
│  类型                自定义页面 (非标准资源)                                 │
│  权限                Super Admin                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 页面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能开关页面                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  环境: [Local] [Debug] [Staging] [Production]           [+ 新建]    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 功能名称              │ 描述              │ Local│Debug│Stag│Prod │操作│    │
│  │──────────────────────┼───────────────────┼──────┼─────┼────┼─────┼────│    │
│  │ enable_tts           │ 启用文本转语音    │  ✅  │ ✅  │ ✅ │ ✅  │[⋮]│    │
│  │ enable_ai_qa         │ 启用AI问答功能    │  ✅  │ ✅  │ ✅ │ ❌  │[⋮]│    │
│  │ enable_social_login  │ 启用社交登录      │  ✅  │ ✅  │ ❌ │ ❌  │[⋮]│    │
│  │ enable_new_reader    │ 启用新版阅读器    │  ✅  │ ✅  │ ❌ │ ❌  │[⋮]│    │
│  │ show_premium_badge   │ 显示高级用户徽章  │  ✅  │ ✅  │ ✅ │ ✅  │[⋮]│    │
│  │ maintenance_mode     │ 维护模式          │  ❌  │ ❌  │ ❌ │ ❌  │[⋮]│    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  缓存管理                                                            │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  最后更新: 2024-12-15 14:30:00                    [刷新缓存]         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 功能开关管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能开关字段                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  字段              类型           说明                                       │
│  ─────────────────────────────────────────────────────────────────          │
│  key               string         功能标识 (唯一)                           │
│  description       string         功能描述                                  │
│  environments      object         各环境状态                                │
│    - local         boolean        本地环境                                  │
│    - debug         boolean        调试环境                                  │
│    - staging       boolean        预发布环境                                │
│    - production    boolean        生产环境                                  │
│  createdAt         datetime       创建时间                                  │
│  updatedAt         datetime       更新时间                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 创建/编辑功能开关

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能开关表单                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  新建功能开关                                                       │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │                                                                      │    │
│  │  功能标识 *                                                          │    │
│  │  [enable_new_feature        ]                                        │    │
│  │  格式: 小写字母、下划线，如 enable_xxx                                │    │
│  │                                                                      │    │
│  │  功能描述 *                                                          │    │
│  │  [启用新功能                ]                                        │    │
│  │                                                                      │    │
│  │  环境配置                                                            │    │
│  │  ────────                                                            │    │
│  │  ☑ Local      本地开发环境                                           │    │
│  │  ☑ Debug      调试环境                                               │    │
│  │  ☐ Staging    预发布环境                                             │    │
│  │  ☐ Production 生产环境                                               │    │
│  │                                                                      │    │
│  │                                    [取消] [保存]                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 批量操作

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         批量操作                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  复制配置:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 从一个环境复制所有开关状态到另一个环境                                    │
│  • 例: Staging → Production                                                 │
│  • 需要二次确认                                                              │
│                                                                             │
│  快速切换:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 点击单元格中的开关图标直接切换状态                                        │
│  • 即时生效，无需额外确认                                                    │
│  • 生产环境切换需要二次确认                                                  │
│                                                                             │
│  维护模式:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 特殊开关 maintenance_mode                                                │
│  • 启用后客户端显示维护提示                                                  │
│  • 切换需要多重确认                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 缓存管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         缓存策略                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  客户端缓存:                                                                 │
│  ─────────────────────────────────────────────────────────────────          │
│  • 缓存时间: 5分钟                                                          │
│  • 客户端启动时拉取最新配置                                                  │
│  • 后台定期刷新                                                              │
│                                                                             │
│  服务端缓存:                                                                 │
│  ─────────────────────────────────────────────────────────────────          │
│  • Redis 缓存功能开关状态                                                   │
│  • 缓存时间: 1分钟                                                          │
│  • 支持手动刷新                                                              │
│                                                                             │
│  刷新缓存:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  • 修改开关后自动清除服务端缓存                                              │
│  • 手动刷新按钮强制清除所有缓存                                              │
│  • 客户端最迟 5 分钟后获取新状态                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 常用功能开关

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         预置功能开关                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心功能:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  enable_tts              启用文本转语音                                     │
│  enable_ai_explain       启用AI单词解释                                     │
│  enable_ai_translate     启用AI翻译                                         │
│  enable_ai_simplify      启用AI句子简化                                     │
│  enable_ai_qa            启用AI问答                                         │
│                                                                             │
│  用户功能:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  enable_social_login     启用社交登录                                       │
│  enable_streak_rewards   启用连续学习奖励                                   │
│  enable_achievements     启用成就系统                                       │
│  enable_leaderboard      启用排行榜                                         │
│                                                                             │
│  实验功能:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  enable_new_reader       启用新版阅读器                                     │
│  enable_agora            启用城邦社区                                       │
│  enable_postcard         启用明信片功能                                     │
│                                                                             │
│  系统功能:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  maintenance_mode        维护模式                                           │
│  force_update            强制更新                                           │
│  show_debug_info         显示调试信息                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API 接口

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API 端点                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  GET /api/v1/config/admin/flags                                             │
│  ─────────────────────────────────────────────────────────────────          │
│  返回: 所有功能开关列表                                                     │
│                                                                             │
│  POST /api/v1/config/admin/flags                                            │
│  ─────────────────────────────────────────────────────────────────          │
│  Body: { key, description, environments }                                   │
│  返回: 创建的功能开关                                                       │
│                                                                             │
│  PUT /api/v1/config/admin/flags/:id                                         │
│  ─────────────────────────────────────────────────────────────────          │
│  Body: { description, environments }                                        │
│  返回: 更新后的功能开关                                                     │
│                                                                             │
│  DELETE /api/v1/config/admin/flags/:id                                      │
│  ─────────────────────────────────────────────────────────────────          │
│  返回: 删除确认                                                             │
│                                                                             │
│  POST /api/v1/config/admin/flags/refresh-cache                              │
│  ─────────────────────────────────────────────────────────────────          │
│  返回: 缓存刷新结果                                                         │
│                                                                             │
│  客户端端点 (非管理):                                                        │
│  ─────────────────────────────────────────────────────────────────          │
│  GET /api/v1/config/flags                                                   │
│  返回: 当前环境的功能开关状态                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 使用场景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         典型场景                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  灰度发布:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  1. 新功能先在 Local 和 Debug 环境开启                                      │
│  2. 内部测试通过后开启 Staging                                              │
│  3. 预发布验证通过后开启 Production                                         │
│  4. 如有问题可快速关闭                                                       │
│                                                                             │
│  紧急回滚:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  1. 发现生产环境问题                                                         │
│  2. 直接关闭对应功能开关                                                     │
│  3. 功能立即禁用，无需发版                                                   │
│  4. 排查修复后重新开启                                                       │
│                                                                             │
│  维护公告:                                                                   │
│  ─────────────────────────────────────────────────────────────────          │
│  1. 计划停机维护前                                                           │
│  2. 开启 maintenance_mode                                                   │
│  3. 客户端显示维护提示                                                       │
│  4. 维护完成后关闭                                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

# 运营数据统计系统设计

## 1. 概述

本文档定义运营数据统计系统的设计方案，为运营人员提供全面的数据洞察能力，支持日常运营决策。

### 1.1 设计目标

| 目标 | 描述 |
|------|------|
| 多维度分析 | 支持客户端、用户行为、内容、时间等多维度交叉分析 |
| 实时性 | 关键指标（DAU、MAU）支持准实时更新 |
| 可扩展性 | 易于添加新的统计维度和指标 |
| 性能优化 | 大数据量下保持查询响应速度 |

### 1.2 核心指标体系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         运营指标体系                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   用户指标       │  │   用户画像       │  │   内容指标       │              │
│  │   ───────────   │  │   ───────────   │  │   ───────────   │              │
│  │  · DAU/MAU     │  │  · 性别分布     │  │  · 热门书籍     │              │
│  │  · 新增用户     │  │  · 年龄分布     │  │  · 热门金句     │              │
│  │  · 留存率       │  │  · 地区分布     │  │  · 阅读完成率   │              │
│  │  · 客户端分布   │  │  · 语言偏好     │  │  · 收藏排行     │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   行为指标       │  │   订阅指标       │  │   城邦指标       │              │
│  │   ───────────   │  │   ───────────   │  │   ───────────   │              │
│  │  · 阅读时长     │  │  · 付费转化率   │  │  · 帖子发布量   │              │
│  │  · 查词次数     │  │  · 订阅分布     │  │  · 互动率       │              │
│  │  · AI调用量     │  │  · 续费率       │  │  · 活跃用户     │              │
│  │  · 会话频次     │  │  · 流失率       │  │  · 评论数       │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                             │
│  ┌─────────────────┐                                                        │
│  │   词汇指标       │                                                        │
│  │   ───────────   │                                                        │
│  │  · 学习词汇数   │                                                        │
│  │  · 掌握词汇数   │                                                        │
│  │  · 复习完成率   │                                                        │
│  │  · 正确率       │                                                        │
│  └─────────────────┘                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构

### 2.1 数据流架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据统计系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   客户端                                                                     │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                        │
│   │  iOS    │  │ Android │  │   Web   │  │  Expo   │                        │
│   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                        │
│        │            │            │            │                             │
│        └────────────┴────────────┴────────────┘                             │
│                          │                                                  │
│                          ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      事件采集层                                       │  │
│   │  ───────────────────────────────────────────────────────────────    │  │
│   │  · POST /tracking/reading      阅读事件                             │  │
│   │  · POST /tracking/ai           AI交互事件                           │  │
│   │  · POST /tracking/batch        批量事件上报                         │  │
│   │  · POST /tracking/app-launch   应用启动事件                         │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
│            ┌─────────────┴─────────────┐                                   │
│            ▼                           ▼                                   │
│   ┌─────────────────┐         ┌─────────────────┐                          │
│   │   Redis Queue   │         │   PostgreSQL    │                          │
│   │   (异步处理)    │         │   (实时写入)    │                          │
│   └────────┬────────┘         └────────┬────────┘                          │
│            │                           │                                   │
│            ▼                           ▼                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      数据聚合层                                       │  │
│   │  ───────────────────────────────────────────────────────────────    │  │
│   │                                                                      │  │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │  │
│   │  │  实时聚合       │  │  定时聚合       │  │  按需聚合       │      │  │
│   │  │  (Redis)       │  │  (Cron Job)    │  │  (API触发)     │      │  │
│   │  │  · DAU计数     │  │  · 日报表      │  │  · 自定义报表   │      │  │
│   │  │  · 活跃用户    │  │  · 月度汇总    │  │  · 导出数据     │      │  │
│   │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
│                          ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      数据存储层                                       │  │
│   │  ───────────────────────────────────────────────────────────────    │  │
│   │                                                                      │  │
│   │  ┌──────────────────────────────────────────────────────────────┐   │  │
│   │  │                     PostgreSQL                                │   │  │
│   │  ├──────────────────────────────────────────────────────────────┤   │  │
│   │  │  运营日报表              运营月报表             热门内容表    │   │  │
│   │  │  OperationsDailyStats   OperationsMonthlyStats  HotContent  │   │  │
│   │  │  · 日期                 · 年月                  · 类型       │   │  │
│   │  │  · 客户端类型           · 客户端类型            · 内容ID     │   │  │
│   │  │  · DAU/新增用户         · MAU/新增用户          · 统计值     │   │  │
│   │  │  · 各维度统计           · 各维度汇总            · 排名       │   │  │
│   │  └──────────────────────────────────────────────────────────────┘   │  │
│   │                                                                      │  │
│   │  ┌────────────────────────────────────┐                             │  │
│   │  │              Redis                  │                             │  │
│   │  ├────────────────────────────────────┤                             │  │
│   │  │  · dau:2025-01-03:ios    (BitMap)  │                             │  │
│   │  │  · dau:2025-01-03:android          │                             │  │
│   │  │  · mau:2025-01:ios       (HyperLogLog)                           │  │
│   │  │  · hot:books:2025-01-03  (Sorted Set)                            │  │
│   │  └────────────────────────────────────┘                             │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
│                          ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      展示层 (Dashboard)                               │  │
│   │  ───────────────────────────────────────────────────────────────    │  │
│   │  · 实时看板      · 趋势图表      · 排行榜      · 报表导出          │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 客户端标识方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         客户端类型识别                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  请求来源识别                                                                 │
│  ══════════════                                                             │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  HTTP Header: X-Client-Platform                                      │  │
│  ├──────────────────────────────────────────────────────────────────────┤  │
│  │                                                                       │  │
│  │  值              描述                  示例                            │  │
│  │  ─────────────────────────────────────────────────────────────────   │  │
│  │  ios            iOS原生应用            X-Client-Platform: ios        │  │
│  │  android        Android原生应用        X-Client-Platform: android    │  │
│  │  web            Web浏览器              X-Client-Platform: web        │  │
│  │  expo-ios       Expo iOS应用           X-Client-Platform: expo-ios   │  │
│  │  expo-android   Expo Android应用       X-Client-Platform: expo-android│  │
│  │                                                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  附加信息                                                                    │
│  ═════════                                                                  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  Header                  描述                  示例                   │  │
│  │  ────────────────────────────────────────────────────────────────    │  │
│  │  X-Client-Version       客户端版本号           1.2.3                 │  │
│  │  X-Device-Model         设备型号               iPhone 15 Pro         │  │
│  │  X-OS-Version           操作系统版本           iOS 17.2              │  │
│  │  X-Device-Id            设备唯一标识           UUID                  │  │
│  │  Accept-Language        语言偏好               zh-Hans               │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据模型

### 3.1 运营日报表 (OperationsDailyStats)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Int | 主键 |
| date | Date | 统计日期 |
| platform | Enum | 客户端类型 (ALL, IOS, ANDROID, WEB, EXPO_IOS, EXPO_ANDROID) |
| **用户指标** | | |
| dau | Int | 日活跃用户数 |
| newUsers | Int | 新增用户数 |
| guestUsers | Int | 新增游客用户数 |
| registeredUsers | Int | 新增注册用户数 |
| **留存指标** | | |
| retention1d | Decimal | 次日留存率 |
| retention7d | Decimal | 7日留存率 |
| retention30d | Decimal | 30日留存率 |
| **阅读指标** | | |
| totalReadingMinutes | Int | 总阅读时长（分钟） |
| avgReadingMinutes | Decimal | 人均阅读时长（分钟） |
| readingSessions | Int | 阅读会话数 |
| booksStarted | Int | 开始阅读的书籍数 |
| booksFinished | Int | 完成阅读的书籍数 |
| **词汇指标** | | |
| wordsLookedUp | Int | 查词次数 |
| wordsLearned | Int | 新学习词汇数 |
| wordsMastered | Int | 掌握词汇数 |
| reviewSessions | Int | 复习会话数 |
| **AI指标** | | |
| aiInteractions | Int | AI交互次数 |
| aiCost | Decimal | AI调用成本 (USD) |
| cacheHitRate | Decimal | 缓存命中率 |
| **社交指标** | | |
| agoraPosts | Int | 城邦发帖数 |
| agoraComments | Int | 城邦评论数 |
| agoraLikes | Int | 城邦点赞数 |
| **订阅指标** | | |
| newSubscriptions | Int | 新订阅数 |
| cancelledSubscriptions | Int | 取消订阅数 |
| revenue | Decimal | 收入 (USD) |
| **时间戳** | | |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

**唯一索引**: (date, platform)

### 3.2 运营月报表 (OperationsMonthlyStats)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Int | 主键 |
| yearMonth | String | 年月 (格式: YYYY-MM) |
| platform | Enum | 客户端类型 |
| mau | Int | 月活跃用户数 |
| peakDau | Int | 峰值DAU |
| avgDau | Decimal | 平均DAU |
| totalNewUsers | Int | 月新增用户总数 |
| totalReadingMinutes | Int | 月总阅读时长 |
| totalAiInteractions | Int | 月AI交互总数 |
| totalRevenue | Decimal | 月收入总计 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

**唯一索引**: (yearMonth, platform)

### 3.3 热门内容表 (HotContent)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Int | 主键 |
| date | Date | 统计日期 |
| contentType | Enum | 内容类型 (BOOK, QUOTE, AUTHOR, POST) |
| contentId | String | 内容ID |
| title | String | 内容标题 (冗余存储，避免JOIN) |
| viewCount | Int | 浏览次数 |
| interactionCount | Int | 互动次数 (点赞+评论+分享) |
| readingMinutes | Int | 阅读时长 (仅书籍) |
| rank | Int | 当日排名 |
| platform | Enum | 客户端类型 (ALL表示汇总) |

**唯一索引**: (date, contentType, contentId, platform)

### 3.4 用户活跃记录表 (UserActivityLog)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | BigInt | 主键 |
| userId | String | 用户ID |
| date | Date | 活跃日期 |
| platform | Enum | 客户端类型 |
| firstActiveAt | DateTime | 当日首次活跃时间 |
| lastActiveAt | DateTime | 当日最后活跃时间 |
| sessionCount | Int | 会话次数 |
| readingMinutes | Int | 阅读时长 |
| aiInteractions | Int | AI交互次数 |

**唯一索引**: (userId, date, platform)

### 3.5 用户画像表 (UserProfile)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Int | 主键 |
| userId | String | 用户ID (外键) |
| **人口统计** | | |
| gender | Enum | 性别 (UNKNOWN, MALE, FEMALE, OTHER) |
| birthYear | Int | 出生年份 (可选，用于计算年龄段) |
| ageGroup | Enum | 年龄段 (UNDER_18, 18_24, 25_34, 35_44, 45_54, 55_PLUS, UNKNOWN) |
| **地理信息** | | |
| country | String | 国家代码 (ISO 3166-1 alpha-2, 如 CN, US) |
| region | String | 地区/省份 |
| city | String | 城市 |
| timezone | String | 时区 (如 Asia/Shanghai) |
| **语言偏好** | | |
| nativeLanguage | String | 母语 (如 zh-Hans) |
| learningLanguage | String | 学习语言 (如 en) |
| uiLanguage | String | 界面语言 |
| **用户特征** | | |
| englishLevel | Enum | 英语水平 (BEGINNER, INTERMEDIATE, ADVANCED) |
| readingPreferences | Json | 阅读偏好 (体裁、主题等) |
| **数据来源** | | |
| profileSource | Enum | 画像来源 (OAUTH, SELF_REPORTED, INFERRED) |
| lastUpdatedAt | DateTime | 最后更新时间 |
| createdAt | DateTime | 创建时间 |

**唯一索引**: (userId)

### 3.6 用户画像统计表 (UserProfileStats)

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Int | 主键 |
| date | Date | 统计日期 |
| platform | Enum | 客户端类型 |
| **性别分布** | | |
| genderMale | Int | 男性用户数 |
| genderFemale | Int | 女性用户数 |
| genderOther | Int | 其他性别用户数 |
| genderUnknown | Int | 未知性别用户数 |
| **年龄分布** | | |
| ageUnder18 | Int | 18岁以下 |
| age18To24 | Int | 18-24岁 |
| age25To34 | Int | 25-34岁 |
| age35To44 | Int | 35-44岁 |
| age45To54 | Int | 45-54岁 |
| age55Plus | Int | 55岁以上 |
| ageUnknown | Int | 年龄未知 |
| **地区分布 (Top 10)** | | |
| regionDistribution | Json | 地区分布 JSON (country -> count) |
| topCountries | Json | 前10国家及用户数 |
| topCities | Json | 前10城市及用户数 |
| **语言分布** | | |
| languageDistribution | Json | 语言分布 JSON |
| **英语水平分布** | | |
| levelBeginner | Int | 初级用户数 |
| levelIntermediate | Int | 中级用户数 |
| levelAdvanced | Int | 高级用户数 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

**唯一索引**: (date, platform)

### 3.7 用户画像数据采集

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       用户画像数据来源                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  数据采集渠道                                                                │
│  ══════════════                                                             │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  来源              数据类型              采集时机                     │  │
│  │  ────────────────────────────────────────────────────────────────    │  │
│  │  OAuth登录         性别、地区            用户首次登录/绑定            │  │
│  │  (Apple/Google)    (从OAuth Profile获取)                             │  │
│  │                                                                       │  │
│  │  用户主动填写      性别、年龄、职业      个人设置页面                 │  │
│  │  (Self-Reported)   阅读偏好                                          │  │
│  │                                                                       │  │
│  │  IP地理定位        国家、地区、城市      每次请求 (GeoIP)            │  │
│  │  (Inferred)        时区                                              │  │
│  │                                                                       │  │
│  │  设备信息          语言偏好、时区        App启动时                    │  │
│  │  (Device)          系统语言                                          │  │
│  │                                                                       │  │
│  │  行为推断          阅读偏好              持续学习行为分析             │  │
│  │  (Behavioral)      英语水平变化                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  数据优先级 (同一字段多来源时)                                               │
│  ═══════════════════════════════                                            │
│                                                                             │
│  1. 用户主动填写 (最高优先级)                                                │
│  2. OAuth 登录获取                                                          │
│  3. 设备/系统信息                                                            │
│  4. IP 地理定位                                                              │
│  5. 行为推断 (最低优先级)                                                    │
│                                                                             │
│  隐私合规                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  · 所有画像数据均为可选，用户可选择不提供                                     │
│  · 遵循 GDPR/CCPA 规定，用户可请求删除                                       │
│  · 统计报表仅展示聚合数据，不暴露个人信息                                     │
│  · 年龄数据仅存储年龄段，不存储精确出生日期                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. API 设计

### 4.1 API 端点总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      运营统计 API 端点                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  概览数据                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/overview          获取运营数据概览                    │
│  GET /admin/operations/realtime          获取实时数据                        │
│                                                                             │
│  用户分析                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/users/dau         获取DAU数据                        │
│  GET /admin/operations/users/mau         获取MAU数据                        │
│  GET /admin/operations/users/retention   获取留存率数据                      │
│  GET /admin/operations/users/platforms   获取客户端分布                      │
│  GET /admin/operations/users/growth      获取用户增长趋势                    │
│                                                                             │
│  用户画像                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/profile/overview      用户画像概览                   │
│  GET /admin/operations/profile/gender        性别分布统计                   │
│  GET /admin/operations/profile/age           年龄分布统计                   │
│  GET /admin/operations/profile/region        地区分布统计                   │
│  GET /admin/operations/profile/language      语言偏好统计                   │
│  GET /admin/operations/profile/level         英语水平分布                   │
│  GET /admin/operations/profile/trend         画像变化趋势                   │
│                                                                             │
│  内容分析                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/content/hot-books     热门书籍排行                   │
│  GET /admin/operations/content/hot-quotes    热门金句排行                   │
│  GET /admin/operations/content/hot-authors   热门作者排行                   │
│  GET /admin/operations/content/reading-stats 阅读统计                       │
│                                                                             │
│  行为分析                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/behavior/reading      阅读行为分析                   │
│  GET /admin/operations/behavior/vocabulary   词汇学习分析                   │
│  GET /admin/operations/behavior/ai           AI使用分析                     │
│  GET /admin/operations/behavior/agora        城邦互动分析                   │
│                                                                             │
│  订阅分析                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/subscription/overview     订阅概览                   │
│  GET /admin/operations/subscription/conversion   转化漏斗                   │
│  GET /admin/operations/subscription/churn        流失分析                   │
│                                                                             │
│  报表导出                                                                    │
│  ═════════                                                                  │
│  GET /admin/operations/reports/daily         导出日报                       │
│  GET /admin/operations/reports/weekly        导出周报                       │
│  GET /admin/operations/reports/monthly       导出月报                       │
│  POST /admin/operations/reports/custom       自定义报表                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 通用查询参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| startDate | Date | 是 | 开始日期 (YYYY-MM-DD) |
| endDate | Date | 是 | 结束日期 (YYYY-MM-DD) |
| platform | Enum | 否 | 客户端类型筛选，默认ALL |
| granularity | Enum | 否 | 粒度: DAILY / WEEKLY / MONTHLY |

### 4.3 响应数据结构

**概览数据响应**:

| 字段 | 类型 | 描述 |
|------|------|------|
| summary.dau | number | 当日DAU |
| summary.dauChange | number | DAU环比变化 (%) |
| summary.mau | number | 当月MAU |
| summary.mauChange | number | MAU环比变化 (%) |
| summary.newUsers | number | 当日新增用户 |
| summary.activeRate | number | 活跃率 (DAU/总用户) |
| platforms | object | 各平台数据分布 |
| trends | array | 趋势数据点 |

**热门内容响应**:

| 字段 | 类型 | 描述 |
|------|------|------|
| items[].rank | number | 排名 |
| items[].id | string | 内容ID |
| items[].title | string | 标题 |
| items[].author | string | 作者 (书籍/金句) |
| items[].viewCount | number | 浏览次数 |
| items[].interactionCount | number | 互动次数 |
| items[].readingMinutes | number | 阅读时长 (书籍) |
| items[].change | number | 排名变化 |
| pagination | object | 分页信息 |

---

## 5. Dashboard 界面设计

### 5.1 运营数据首页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Readmigo 运营数据看板                        [今日] [本周] [本月] [自定义]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心指标                                              更新时间: 10:32:15   │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐   │
│  │     DAU       │ │     MAU       │ │    新增用户    │ │   活跃率      │   │
│  │    8,432      │ │   45,678      │ │     234       │ │   18.5%       │   │
│  │   ↑ 12.3%     │ │   ↑ 8.2%      │ │   ↓ 3.1%      │ │   ↑ 0.8%      │   │
│  │   vs 昨日      │ │   vs 上月      │ │   vs 昨日      │ │   vs 昨日      │   │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘   │
│                                                                             │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐   │
│  │   阅读时长     │ │   查词次数     │ │   AI调用      │ │    收入       │   │
│  │   3.2h/人     │ │   12,456      │ │   45,678      │ │  $1,234       │   │
│  │   ↑ 0.3h      │ │   ↑ 15.2%     │ │   ↓ 5.3%      │ │   ↑ 22.1%     │   │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  客户端分布                              用户增长趋势 (30天)                  │
│  ══════════════                          ══════════════════════════          │
│                                                                             │
│  ┌─────────────────────────┐            ┌─────────────────────────────────┐ │
│  │                         │            │                                 │ │
│  │      iOS                │            │      ╱──────────────            │ │
│  │    ████████████  45%    │            │     ╱                           │ │
│  │                         │            │    ╱                            │ │
│  │    Android              │            │   ╱                ── DAU       │ │
│  │    ████████     35%     │            │  ╱                 ·· 新增      │ │
│  │                         │            │ ╱ ···················           │ │
│  │    Web                  │            │                                 │ │
│  │    ████         15%     │            │ 12/4  12/11  12/18  12/25  1/1  │ │
│  │                         │            │                                 │ │
│  │    Expo                 │            └─────────────────────────────────┘ │
│  │    ██           5%      │                                                │
│  │                         │                                                │
│  └─────────────────────────┘                                                │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  热门书籍 TOP 10                         热门金句 TOP 10                     │
│  ══════════════════                      ══════════════════                  │
│                                                                             │
│  ┌───────────────────────────────────┐  ┌───────────────────────────────────┐│
│  │ # │ 书名              │ 阅读量    │  │ # │ 金句              │ 浏览量    ││
│  │───┼───────────────────┼───────────│  │───┼───────────────────┼───────────││
│  │ 1 │ Pride & Prejudice │ ↑  12,345 │  │ 1 │ "To be or not..." │ ↑  5,678 ││
│  │ 2 │ Great Expectations│ ↑  8,901  │  │ 2 │ "In the begin..." │ ↓  4,567 ││
│  │ 3 │ Jane Eyre         │ ─  7,654  │  │ 3 │ "It was the..."   │ ↑  3,456 ││
│  │ 4 │ 1984              │ ↓  6,543  │  │ 4 │ "All happy..."    │ ─  2,345 ││
│  │ 5 │ The Great Gatsby  │ ↑  5,432  │  │ 5 │ "Call me Ish..."  │ ↑  1,890 ││
│  │   │ ...               │           │  │   │ ...               │          ││
│  └───────────────────────────────────┘  └───────────────────────────────────┘│
│                            [查看全部]                        [查看全部]       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 用户分析页面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  用户分析                          筛选: [iOS ▼] [2024-12-01 至 2025-01-03] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  留存率分析                                                                  │
│  ═══════════                                                                 │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  日期       │ 新增  │ 次日  │ 3日   │ 7日   │ 14日  │ 30日  │ 60日   ││
│  │─────────────┼───────┼───────┼───────┼───────┼───────┼───────┼────────││
│  │  2025-01-03 │  234  │ 45.2% │  --   │  --   │  --   │  --   │   --   ││
│  │  2025-01-02 │  256  │ 48.1% │ 38.2% │  --   │  --   │  --   │   --   ││
│  │  2025-01-01 │  312  │ 52.3% │ 41.5% │ 35.2% │  --   │  --   │   --   ││
│  │  2024-12-31 │  198  │ 44.2% │ 36.8% │ 28.9% │  --   │  --   │   --   ││
│  │  2024-12-30 │  267  │ 49.8% │ 40.1% │ 32.4% │ 25.1% │  --   │   --   ││
│  │  ...        │       │       │       │       │       │       │        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  用户画像分布                                                                │
│  ═══════════════                                                             │
│                                                                             │
│  ┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────┐│
│  │  性别分布              │  │  年龄分布              │  │  英语水平分布     ││
│  │  ───────────          │  │  ───────────          │  │  ───────────       ││
│  │                       │  │                       │  │                    ││
│  │  男性    ████████ 42% │  │  18-24   ████████ 35% │  │  初级  ████████ 45%││
│  │  女性    ██████   38% │  │  25-34   ██████   28% │  │  中级  ██████   35%││
│  │  未知    ████     20% │  │  35-44   ████     18% │  │  高级  ████     20%││
│  │                       │  │  其他    ███      19% │  │                    ││
│  └───────────────────────┘  └───────────────────────┘  └───────────────────┘│
│                                                                             │
│  ┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────┐│
│  │  地区分布 (Top 5)      │  │  账户类型分布          │  │  订阅状态分布     ││
│  │  ───────────          │  │  ───────────          │  │  ───────────       ││
│  │                       │  │                       │  │                    ││
│  │  中国    ████████ 65% │  │  游客    ████████ 40% │  │  免费  ████████ 65%││
│  │  美国    ███      12% │  │  注册    ████████ 60% │  │  Pro   ████    25% ││
│  │  日本    ██        8% │  │                       │  │  Premium ██   10%  ││
│  │  韩国    ██        6% │  │                       │  │                    ││
│  │  其他    ██        9% │  │                       │  │                    ││
│  └───────────────────────┘  └───────────────────────┘  └───────────────────┘│
│                                                                             │
│  地区详细分布 (地图视图)                                                      │
│  ═════════════════════════                                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                          [世界地图热力图]                                ││
│  │                                                                         ││
│  │     ┌─────────────────────────────────────────────────────────────┐     ││
│  │     │                                                             │     ││
│  │     │          ▓▓▓                                                │     ││
│  │     │       ▓▓▓▓▓▓▓▓         ░░                    ████████       │     ││
│  │     │         ▓▓▓▓           ░░░░                  ████████       │     ││
│  │     │                          ░░                  ████████       │     ││
│  │     │                                              ██████         │     ││
│  │     │            ░                                                │     ││
│  │     │                              ░░                             │     ││
│  │     │                                                             │     ││
│  │     └─────────────────────────────────────────────────────────────┘     ││
│  │                                                                         ││
│  │     图例: ████ 高密度 (>1000用户)  ▓▓▓ 中密度  ░░ 低密度               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  活跃时段分布 (过去7天)                                                       │
│  ═══════════════════════                                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  时段    │ 0  │ 2  │ 4  │ 6  │ 8  │ 10 │ 12 │ 14 │ 16 │ 18 │ 20 │ 22 ││
│  │──────────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────││
│  │  活跃度  │ ░  │ ░  │ ░  │ ▒  │ ▓  │ ▓  │ ▓  │ ▒  │ ▒  │ ▓  │ █  │ ▓  ││
│  │          │ 2% │ 1% │ 1% │ 5% │ 8% │ 10%│ 9% │ 7% │ 8% │ 12%│ 15%│ 10%││
│  └─────────────────────────────────────────────────────────────────────────┘│
│  峰值时段: 20:00-22:00 (北京时间)                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 内容分析页面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  内容分析                           [书籍] [金句] [作者] [城邦]              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  书籍统计概览                                                                │
│  ═══════════════                                                             │
│                                                                             │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐   │
│  │   总书籍数     │ │  本月新增      │ │  被阅读书籍   │ │  完读率       │   │
│  │    2,456      │ │     123       │ │    1,234      │ │   12.5%       │   │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘   │
│                                                                             │
│  热门书籍排行榜                                                              │
│  ═══════════════                                                             │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 排名│ 书名                   │ 作者         │ 阅读人数│ 完读人数│ 完读率││
│  │─────┼────────────────────────┼──────────────┼─────────┼─────────┼───────││
│  │  1  │ Pride and Prejudice    │ Jane Austen  │  12,345 │   1,234 │ 10.0% ││
│  │  2  │ Great Expectations     │ Dickens      │   8,901 │     890 │ 10.0% ││
│  │  3  │ Jane Eyre              │ C. Brontë    │   7,654 │     612 │  8.0% ││
│  │  4  │ 1984                   │ Orwell       │   6,543 │     981 │ 15.0% ││
│  │  5  │ The Great Gatsby       │ Fitzgerald   │   5,432 │     760 │ 14.0% ││
│  │  6  │ Wuthering Heights      │ E. Brontë    │   4,567 │     365 │  8.0% ││
│  │  7  │ Oliver Twist           │ Dickens      │   4,123 │     247 │  6.0% ││
│  │  8  │ Frankenstein           │ Shelley      │   3,890 │     545 │ 14.0% ││
│  │  9  │ Dracula                │ Stoker       │   3,456 │     380 │ 11.0% ││
│  │ 10  │ The Picture of D.G.    │ Wilde        │   3,234 │     485 │ 15.0% ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  分类阅读分布                        难度分布                                 │
│  ══════════════                      ═════════                               │
│                                                                             │
│  ┌───────────────────────────────┐  ┌───────────────────────────────────┐   │
│  │  Classic Fiction   ███████ 35%│  │  初级 (CEFR A1-A2)  ████████  40% │   │
│  │  Literary Fiction  █████   25%│  │  中级 (CEFR B1-B2)  ██████    30% │   │
│  │  Non-Fiction       ████    20%│  │  高级 (CEFR C1-C2)  ██████    30% │   │
│  │  Science Fiction   ███     15%│  │                                   │   │
│  │  Other             ██       5%│  │                                   │   │
│  └───────────────────────────────┘  └───────────────────────────────────┘   │
│                                                                             │
│  金句统计                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 排名│ 金句                               │ 来源        │ 点赞  │ 分享  ││
│  │─────┼────────────────────────────────────┼─────────────┼───────┼───────││
│  │  1  │ "To be, or not to be..."           │ Hamlet      │ 5,678 │ 1,234 ││
│  │  2  │ "It is a truth universally..."     │ P&P         │ 4,567 │   987 ││
│  │  3  │ "All happy families resemble..."   │ Anna K.     │ 3,456 │   654 ││
│  │  4  │ "In the beginning God created..."  │ Genesis     │ 2,345 │   432 ││
│  │  5  │ "Call me Ishmael."                 │ Moby-Dick   │ 1,890 │   321 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 报表导出页面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  报表中心                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  快速导出                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                   │
│  │  📊 日报                │  │  📈 周报                │                   │
│  │  ───────────            │  │  ───────────            │                   │
│  │  生成昨日运营数据报表    │  │  生成上周运营数据报表    │                   │
│  │                         │  │                         │                   │
│  │  [生成 CSV] [生成 PDF]   │  │  [生成 CSV] [生成 PDF]   │                   │
│  └─────────────────────────┘  └─────────────────────────┘                   │
│                                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                   │
│  │  📉 月报                │  │  📋 自定义报表          │                   │
│  │  ───────────            │  │  ───────────            │                   │
│  │  生成上月运营数据报表    │  │  自定义时间范围和指标    │                   │
│  │                         │  │                         │                   │
│  │  [生成 CSV] [生成 PDF]   │  │  [创建报表]              │                   │
│  └─────────────────────────┘  └─────────────────────────┘                   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  自定义报表配置                                                              │
│  ═══════════════                                                             │
│                                                                             │
│  时间范围: [2024-12-01] 至 [2025-01-03]                                      │
│                                                                             │
│  客户端筛选: [✓] iOS  [✓] Android  [✓] Web  [ ] Expo                         │
│                                                                             │
│  指标选择:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  用户指标              内容指标              行为指标                    ││
│  │  [✓] DAU              [✓] 热门书籍          [✓] 阅读时长                ││
│  │  [✓] MAU              [✓] 热门金句          [✓] 查词次数                ││
│  │  [✓] 新增用户         [ ] 热门作者          [✓] AI调用量                ││
│  │  [✓] 留存率           [ ] 阅读完成统计      [ ] 复习数据                 ││
│  │  [ ] 用户画像分布                                                       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  导出格式: ○ CSV  ● Excel  ○ PDF                                             │
│                                                                             │
│  [预览报表]  [导出报表]                                                       │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  历史报表                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  日期        │ 类型    │ 格式  │ 生成人   │ 状态    │ 操作             ││
│  │──────────────┼─────────┼───────┼──────────┼─────────┼──────────────────││
│  │  2025-01-03  │ 日报    │ PDF   │ 系统     │ ✓ 完成  │ [下载] [删除]    ││
│  │  2025-01-02  │ 日报    │ PDF   │ 系统     │ ✓ 完成  │ [下载] [删除]    ││
│  │  2024-12-29  │ 周报    │ Excel │ admin    │ ✓ 完成  │ [下载] [删除]    ││
│  │  2024-12-01  │ 月报    │ PDF   │ 系统     │ ✓ 完成  │ [下载] [删除]    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 数据聚合策略

### 6.1 聚合时机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         数据聚合时机策略                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  实时聚合 (Redis)                                                            │
│  ════════════════                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  指标              数据结构          更新时机          TTL              ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  DAU计数           HyperLogLog      用户请求时         48小时          ││
│  │  在线用户          Set              心跳/活动         5分钟            ││
│  │  实时热门书籍      Sorted Set       阅读事件时         24小时          ││
│  │  实时热门金句      Sorted Set       浏览/点赞时        24小时          ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  定时聚合 (Cron Job)                                                         │
│  ════════════════════                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  任务                执行时间              描述                         ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  日统计聚合          每日 00:30 UTC       聚合前一天所有维度数据        ││
│  │  周统计聚合          每周一 01:00 UTC     聚合上周数据                   ││
│  │  月统计聚合          每月1日 02:00 UTC    聚合上月数据，计算MAU          ││
│  │  热门排行更新        每小时整点           更新热门内容排行榜             ││
│  │  留存率计算          每日 03:00 UTC       计算各周期留存率               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  按需聚合 (API触发)                                                          │
│  ════════════════════                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  场景                    触发方式              缓存策略                 ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  自定义时间范围查询       API请求               结果缓存10分钟          ││
│  │  复杂交叉分析            Dashboard点击          结果缓存5分钟           ││
│  │  报表导出                用户发起               不缓存                  ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 数据一致性保证

| 策略 | 描述 |
|------|------|
| 幂等写入 | 使用 UPSERT 确保重复事件不会导致数据重复 |
| 延迟容忍 | 实时数据允许 5 分钟延迟，日报数据 T+1 生成 |
| 数据校验 | 日报生成后与源数据校验，差异超过 5% 触发告警 |
| 回补机制 | 支持手动触发历史数据重新聚合 |

---

## 7. 性能优化

### 7.1 查询优化策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         查询优化策略                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  索引策略                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  OperationsDailyStats                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  索引名                    字段                      类型               ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  idx_ops_daily_date        (date DESC)               B-tree            ││
│  │  idx_ops_daily_platform    (platform, date DESC)     B-tree            ││
│  │  uniq_ops_daily            (date, platform)          Unique            ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  HotContent                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  索引名                    字段                           类型          ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  idx_hot_date_type         (date DESC, contentType)       B-tree       ││
│  │  idx_hot_rank              (date, contentType, rank)      B-tree       ││
│  │  uniq_hot_content          (date, contentType, contentId) Unique       ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  UserActivityLog                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  索引名                    字段                      类型               ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  idx_activity_user         (userId, date DESC)       B-tree            ││
│  │  idx_activity_date         (date DESC, platform)     B-tree            ││
│  │  uniq_activity             (userId, date, platform)  Unique            ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  分区策略                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  UserActivityLog 按月分区:                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  user_activity_log_2025_01  (2025-01-01 至 2025-01-31)                  ││
│  │  user_activity_log_2025_02  (2025-02-01 至 2025-02-28)                  ││
│  │  ...                                                                     ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  缓存策略                                                                    │
│  ═════════                                                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  数据类型              缓存位置      TTL         失效策略               ││
│  │  ────────────────────────────────────────────────────────────────────   ││
│  │  实时DAU               Redis        5分钟        时间过期               ││
│  │  日报数据              Redis        24小时       次日更新时失效         ││
│  │  热门排行榜            Redis        1小时        定时刷新               ││
│  │  Dashboard概览         Redis        5分钟        时间过期               ││
│  │  历史趋势数据          Redis        1小时        时间过期               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 大数据量处理

| 场景 | 策略 |
|------|------|
| 历史数据查询 | 限制最大查询范围为 90 天，超出需分页 |
| 导出大报表 | 异步生成，完成后通知下载 |
| 实时聚合 | 使用 Redis HyperLogLog 降低内存占用 |
| 热门排行 | 只保留 TOP 100，超出范围的数据不存储 |

---

## 8. 后台任务

### 8.1 定时任务列表

| 任务名 | Cron 表达式 | 描述 |
|--------|-------------|------|
| DailyStatsAggregationJob | `30 0 * * *` | 聚合前一天的运营数据 |
| WeeklyStatsAggregationJob | `0 1 * * 1` | 聚合上周运营数据 |
| MonthlyStatsAggregationJob | `0 2 1 * *` | 聚合上月运营数据，计算MAU |
| HotContentUpdateJob | `0 * * * *` | 每小时更新热门内容排行 |
| RetentionCalculationJob | `0 3 * * *` | 计算各周期留存率 |
| ReportGenerationJob | `0 6 * * *` | 自动生成并发送日报邮件 |

### 8.2 任务执行流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     日报聚合任务流程                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                            │
│  │   触发      │  Cron: 每日 00:30 UTC                                      │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │  获取日期   │  计算昨日日期 (UTC)                                         │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐            │
│  │                   并行聚合各维度数据                          │            │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │            │
│  │  │ 用户指标   │ │ 阅读指标   │ │ 词汇指标   │ │ AI指标     │ │            │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘ │            │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                │            │
│  │  │ 社交指标   │ │ 订阅指标   │ │ 热门内容   │                │            │
│  │  └────────────┘ └────────────┘ └────────────┘                │            │
│  └─────────────────────────────────────────────────────────────┘            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │  按平台拆分  │  ALL / iOS / Android / Web / Expo                         │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │  写入数据库  │  UPSERT 到 OperationsDailyStats                           │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │  更新缓存   │  刷新 Redis 缓存                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │  发送通知   │  如有异常指标，发送告警                                      │
│  └─────────────┘                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 告警规则

### 9.1 告警阈值配置

| 指标 | 告警条件 | 级别 | 通知方式 |
|------|----------|------|----------|
| DAU 下降 | 环比下降 > 20% | 警告 | 邮件 + Slack |
| DAU 暴跌 | 环比下降 > 50% | 严重 | 邮件 + Slack + 电话 |
| 新增用户 | 日新增 < 50 | 警告 | 邮件 |
| AI成本 | 日成本 > $500 | 警告 | 邮件 + Slack |
| 错误率 | API 错误率 > 5% | 严重 | 邮件 + Slack |
| 留存率 | 次日留存 < 30% | 警告 | 邮件 |

### 9.2 告警流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           告警处理流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                  │
│  │  指标采集   │ ───▶ │  规则匹配   │ ───▶ │  告警判定   │                  │
│  └─────────────┘      └─────────────┘      └──────┬──────┘                  │
│                                                   │                         │
│                           ┌───────────────────────┴───────────────────────┐ │
│                           │                                               │ │
│                           ▼                                               ▼ │
│                    ┌─────────────┐                               ┌─────────────┐│
│                    │  正常       │                               │  触发告警   ││
│                    │  (无操作)   │                               └──────┬──────┘│
│                    └─────────────┘                                      │       │
│                                                                         ▼       │
│                                                              ┌─────────────┐   │
│                                                              │  去重检查   │   │
│                                                              │  (防止重复)  │   │
│                                                              └──────┬──────┘   │
│                                                                     │          │
│                                              ┌──────────────────────┴─────────┐│
│                                              │                                ││
│                                              ▼                                ▼│
│                                       ┌─────────────┐               ┌─────────────┐│
│                                       │  新告警     │               │  已存在     ││
│                                       │  发送通知   │               │  (静默)     ││
│                                       └──────┬──────┘               └─────────────┘│
│                                              │                                     │
│                                              ▼                                     │
│                                       ┌─────────────┐                              │
│                                       │  记录日志   │                              │
│                                       │  更新状态   │                              │
│                                       └─────────────┘                              │
│                                                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 权限控制

### 10.1 角色权限矩阵

| 功能 | 超级管理员 | 管理员 | 数据分析师 | 运营人员 | 客服 |
|------|:----------:|:------:|:----------:|:--------:|:----:|
| 查看概览数据 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 查看用户分析 | ✓ | ✓ | ✓ | ✓ | ✗ |
| 查看内容分析 | ✓ | ✓ | ✓ | ✓ | ✗ |
| 查看订阅分析 | ✓ | ✓ | ✓ | ✗ | ✗ |
| 查看收入数据 | ✓ | ✓ | ✗ | ✗ | ✗ |
| 导出报表 | ✓ | ✓ | ✓ | ✓ | ✗ |
| 创建自定义报表 | ✓ | ✓ | ✓ | ✗ | ✗ |
| 配置告警规则 | ✓ | ✓ | ✗ | ✗ | ✗ |
| 查看原始数据 | ✓ | ✗ | ✗ | ✗ | ✗ |

---

## 11. 实施计划

### 11.1 阶段划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           实施阶段                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 1: 基础数据采集                                                       │
│  ═══════════════════════                                                     │
│  □ 客户端添加 X-Client-Platform Header                                       │
│  □ 新增 UserActivityLog 表                                                   │
│  □ 实现活跃用户实时计数 (Redis HyperLogLog)                                   │
│  □ 部署日报聚合定时任务                                                       │
│                                                                             │
│  Phase 2: 核心指标                                                           │
│  ═══════════════════                                                         │
│  □ 实现 DAU/MAU 统计 API                                                     │
│  □ 实现客户端分布统计                                                         │
│  □ 实现热门书籍/金句排行                                                      │
│  □ Dashboard 基础看板页面                                                    │
│                                                                             │
│  Phase 3: 深度分析                                                           │
│  ═══════════════════                                                         │
│  □ 实现留存率计算                                                             │
│  □ 实现用户画像分析                                                           │
│  □ 实现阅读行为分析                                                           │
│  □ 实现词汇学习分析                                                           │
│                                                                             │
│  Phase 4: 报表与告警                                                         │
│  ═══════════════════                                                         │
│  □ 实现报表导出功能                                                           │
│  □ 实现自定义报表                                                             │
│  □ 配置告警规则                                                               │
│  □ 对接通知渠道                                                               │
│                                                                             │
│  Phase 5: 优化与扩展                                                         │
│  ═══════════════════                                                         │
│  □ 性能优化 (大数据量场景)                                                    │
│  □ 增加更多分析维度                                                           │
│  □ 实现自动化报告发送                                                         │
│  □ 移动端运营数据查看                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. 技术选型与架构决策

### 12.1 产品分析工具评估

#### PostHog vs 自建方案

| 维度 | PostHog | 自建方案 |
|------|---------|----------|
| 开发成本 | 低 (SDK集成即可) | 高 (需要开发埋点+后端+前端) |
| 分析能力 | 强 (内置多种分析) | 需自行实现 |
| 数据灵活性 | 中等 (需遵循其模型) | 高 (完全自定义) |
| 与业务系统集成 | 需要额外开发 | 天然集成 |
| 运营人员学习成本 | 需学习新工具 | 使用熟悉的后台 |
| 数据统一性 | 独立系统 | 可统一在一个Dashboard |

#### 技术选型决策

| 场景 | 选择 | 原因 |
|------|------|------|
| 产品行为分析 | 自建 | 已有完整模型设计，与业务深度集成 |
| 崩溃/错误监控 | Sentry | 专业工具，堆栈分析能力强 |
| 渠道数据 | API同步到自建Dashboard | App Store/Google Play API 可拉取数据 |
| Feature Flags | 可考虑 PostHog | 如需A/B测试再引入 |
| Session Replay | 可考虑 PostHog | 调试用户问题时有价值 |

### 12.2 Dashboard 职责划分

#### 数据来源现状

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      外部数据来源                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │     Sentry      │  │  App Store      │  │  Google Play    │              │
│  │   ───────────   │  │   Connect       │  │   Console       │              │
│  │  · 崩溃报告     │  │   ───────────   │  │   ───────────   │              │
│  │  · 错误追踪     │  │  · 下载量       │  │  · 下载量       │              │
│  │  · 性能指标     │  │  · 收入         │  │  · 收入         │              │
│  │  · Issue管理    │  │  · 评分/评论    │  │  · 评分/评论    │              │
│  │                 │  │  · 审核状态     │  │  · 发布状态     │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 分层架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Dashboard 分层架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              统一运营 Dashboard (自建 - 运营人员主入口)              │   │
│  │  ═══════════════════════════════════════════════════════════════    │   │
│  │                                                                      │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐│   │
│  │  │ 运营数据     │ │ 渠道汇总     │ │ 收入汇总     │ │ 告警中心     ││   │
│  │  │ ──────────   │ │ ──────────   │ │ ──────────   │ │ ──────────   ││   │
│  │  │ DAU/MAU     │ │ iOS下载量   │ │ iOS收入     │ │ 崩溃告警    ││   │
│  │  │ 用户画像    │ │ Android下载 │ │ Android收入 │ │ API告警     ││   │
│  │  │ 热门内容    │ │ 评分趋势    │ │ 订阅转化    │ │ 服务器告警  ││   │
│  │  │ 留存分析    │ │             │ │             │ │             ││   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘│   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                   ▲                                        │
│                                   │ 数据聚合 (API同步/定时拉取)            │
│            ┌──────────────────────┴──────────────────────┐                │
│            │                                              │                │
│  ┌─────────────────────────────┐        ┌─────────────────────────────┐   │
│  │    专业工具 (技术人员入口)   │        │       自建数据系统          │   │
│  │  ═══════════════════════════ │        │  ═══════════════════════════ │   │
│  │                              │        │                              │   │
│  │  Sentry                      │        │  PostgreSQL                  │   │
│  │  · 崩溃详情分析              │        │  · 用户行为数据              │   │
│  │  · 堆栈追踪                  │        │  · 阅读/学习数据             │   │
│  │  · Issue管理                 │        │  · 业务指标                  │   │
│  │                              │        │                              │   │
│  │  App Store Connect           │        │  Redis                       │   │
│  │  · 审核管理                  │        │  · 实时指标                  │   │
│  │  · TestFlight                │        │  · 缓存                      │   │
│  │                              │        │                              │   │
│  │  Google Play Console         │        │                              │   │
│  │  · 发布管理                  │        │                              │   │
│  │  · 设备兼容性                │        │                              │   │
│  └─────────────────────────────┘        └─────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Dashboard 职责矩阵

| 数据类型 | 主要入口 | 详细分析 | 数据来源 |
|----------|----------|----------|----------|
| 运营数据 (DAU/MAU/留存) | 自建 Dashboard | 自建 Dashboard | PostgreSQL |
| 用户画像 (性别/年龄/地区) | 自建 Dashboard | 自建 Dashboard | PostgreSQL |
| 热门内容 (书籍/金句) | 自建 Dashboard | 自建 Dashboard | PostgreSQL |
| 崩溃/错误汇总 | 自建 Dashboard | Sentry | Sentry API |
| 崩溃详情/堆栈 | 自建跳转链接 | Sentry | Sentry |
| iOS 下载/收入 | 自建 Dashboard | App Store Connect | ASC API |
| iOS 审核/发布 | App Store Connect | App Store Connect | ASC |
| Android 下载/收入 | 自建 Dashboard | Google Play Console | GPC API |
| Android 发布/兼容性 | Google Play Console | Google Play Console | GPC |
| 服务器性能 | 自建 Dashboard | 自建 Dashboard | 自采集 |

### 12.3 外部数据集成

#### App Store Connect API 集成

| 数据类型 | API | 同步频率 |
|----------|-----|----------|
| 下载量 | Sales and Trends API | 每日 |
| 收入 | Financial Reports API | 每日 |
| 评分 | App Store Connect API | 每小时 |
| 评论 | App Store Connect API | 每小时 |

#### Google Play Console API 集成

| 数据类型 | API | 同步频率 |
|----------|-----|----------|
| 下载量 | Google Play Developer API | 每日 |
| 收入 | Google Play Developer API | 每日 |
| 评分 | Google Play Developer API | 每小时 |
| 评论 | Google Play Developer API | 每小时 |
| 崩溃统计 | Google Play Developer API | 每小时 |

#### Sentry API 集成

| 数据类型 | 用途 | 同步频率 |
|----------|------|----------|
| Issue 列表 | 告警展示 | 实时 Webhook |
| 崩溃统计 | 趋势图表 | 每小时 |
| 错误率 | 健康度指标 | 每5分钟 |

### 12.4 架构决策总结

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      核心原则                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 自建为主                                                                 │
│     · 运营数据完全自建，与业务深度集成                                       │
│     · 数据完全自主控制，灵活度最高                                           │
│                                                                             │
│  2. 专业工具互补                                                             │
│     · Sentry: 崩溃监控专业能力强，继续使用                                   │
│     · App Store/Google Play: 渠道管理必须使用官方工具                       │
│                                                                             │
│  3. 统一视图                                                                 │
│     · 运营人员只需登录自建 Dashboard                                         │
│     · 通过 API 聚合各平台关键数据                                            │
│     · 需要详细分析时提供跳转链接                                             │
│                                                                             │
│  4. 暂不引入 PostHog                                                        │
│     · 当前自建方案满足需求                                                   │
│     · 避免增加系统复杂度和学习成本                                           │
│     · 未来如需 Feature Flags / A/B Testing 再评估                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 13. 附录

### 13.1 客户端类型枚举

| 值 | 描述 |
|----|------|
| ALL | 全部平台汇总 |
| IOS | iOS 原生应用 |
| ANDROID | Android 原生应用 |
| WEB | Web 浏览器 |
| EXPO_IOS | Expo iOS 应用 |
| EXPO_ANDROID | Expo Android 应用 |

### 13.2 内容类型枚举

| 值 | 描述 |
|----|------|
| BOOK | 书籍 |
| QUOTE | 金句 |
| AUTHOR | 作者 |
| POST | 城邦帖子 |

### 13.3 相关文档

| 文档 | 描述 |
|------|------|
| dashboard-platform.md | Dashboard 运营管理平台设计 |
| database-design.md | 数据库设计 |
| api-design.md | API 设计规范 |
| monitoring.md | 监控系统设计 |

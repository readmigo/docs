# Dashboard 运营数据需求文档

## 文档信息

- **创建时间**: 2026-01-11
- **最后更新**: 2026-01-11
- **版本**: v1.0
- **状态**: Draft
- **相关文档**: [operations-analytics-design.md](./operations-analytics-design.md)

---

## 一、概述

### 1.1 目标

从商业级产品运营角度，系统梳理 Readmigo Dashboard 需要补充的数据维度，为运营决策提供全面的数据支持。

### 1.2 设计原则

- **数据驱动**: 所有运营决策基于真实数据
- **分层设计**: 按优先级 P0/P1/P2 分阶段实现
- **可视化优先**: 数据以图表形式直观展示
- **交互友好**: 支持时间范围筛选、维度下钻、数据导出
- **性能优化**: 大数据量下保持流畅体验

---

## 二、数据维度全景图

### 2.1 核心数据域

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Readmigo 运营数据体系                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  用户增长与留存  │  │  内容运营分析    │  │  商业化分析      │         │
│  │  ─────────────  │  │  ─────────────  │  │  ─────────────  │         │
│  │  · DAU/MAU     │  │  · 阅读时长     │  │  · 付费转化     │         │
│  │  · 留存率       │  │  · 书籍完成率   │  │  · ARPU/LTV    │         │
│  │  · 用户分层     │  │  · 内容互动     │  │  · 订单分析     │         │
│  │  · 用户画像     │  │  · 推荐效果     │  │  · 收入预测     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  功能使用分析    │  │  渠道与增长      │  │  运营活动效果    │         │
│  │  ─────────────  │  │  ─────────────  │  │  ─────────────  │         │
│  │  · 核心功能     │  │  · 渠道效果     │  │  · 活动参与     │         │
│  │  · AI 使用      │  │  · 获客成本     │  │  · Push 效果    │         │
│  │  · 社交功能     │  │  · 渠道质量     │  │  · A/B 测试     │         │
│  │  · 功能漏斗     │  │  · 病毒增长     │  │  · ROI 分析     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  内容库存管理    │  │  用户反馈分析    │  │  性能与质量      │         │
│  │  ─────────────  │  │  ─────────────  │  │  ─────────────  │         │
│  │  · 库存分布     │  │  · 反馈分类     │  │  · 错误率       │         │
│  │  · 采购建议     │  │  · 问题热度     │  │  · 性能指标     │         │
│  │  · 内容利用率   │  │  · 满意度       │  │  · 健康度       │         │
│  │  · 冷热分析     │  │  · 响应时效     │  │  · 告警监控     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、优先级分级

### 3.1 P0 优先级（核心必须）

**目标**: 满足基础运营监控需求，快速上线

| 序号 | 功能模块 | 核心指标 | 业务价值 |
|------|---------|---------|---------|
| 1 | 基础运营数据 | DAU/MAU/新增用户/平台分布 | 了解产品健康度 ✅ 已有 |
| 2 | **阅读时长分析** | 书籍/用户/分类/时段维度阅读时长 | **核心内容消费指标** 🔥 |
| 3 | 留存率分析 | 次日/7日/30日留存曲线 | 衡量产品粘性 |
| 4 | 付费转化与收入 | 付费转化漏斗/订单分析/收入趋势 | 商业化核心指标 |
| 5 | **用户画像统计** | 性别/年龄/地区分布 | **精准运营和市场分析** 🎯 |

**时间规划**: 3周完成

---

### 3.2 P1 优先级（重要增强）

**目标**: 深化运营能力，支持精细化运营

| 序号 | 功能模块 | 核心指标 | 业务价值 |
|------|---------|---------|---------|
| 5 | 用户分层管理 | 活跃/成长/沉默/流失用户统计 | 精准用户运营 |
| 6 | 内容完成率 | 书籍完成率分布/弃读分析 | 内容质量优化 |
| 7 | 功能使用率 | 核心功能/AI功能使用统计 | 产品优化方向 |
| 8 | 渠道效果分析 | 各渠道获客质量对比 | 投放优化 |

**时间规划**: 4周完成

---

### 3.3 P2 优先级（优化增强）

**目标**: 完善运营体系，支持高级分析

| 序号 | 功能模块 | 核心指标 | 业务价值 |
|------|---------|---------|---------|
| 9 | 推荐效果分析 | 推荐转化漏斗/书单效果 | 算法优化 |
| 10 | 运营活动追踪 | 活动参与度/效果分析 | 活动优化 |
| 11 | A/B测试结果 | 实验数据对比 | 科学决策 |
| 12 | 用户反馈趋势 | 反馈热度/问题分布 | 产品迭代 |

**时间规划**: 6周完成

---

## 四、P0 优先级详细设计

### 4.1 基础运营数据（已有）

**当前状态**: ✅ 已实现
- 页面: `/operations`
- 接口: `/api/v1/admin/operations/overview`
- 功能: DAU/MAU/新增用户/AI交互/阅读统计/平台分布

**待优化**:
- [ ] 添加环比/同比数据
- [ ] 支持自定义时间范围筛选
- [ ] 导出数据功能

---

### 4.2 阅读时长分析（核心需求）

#### 4.2.1 需求背景

阅读时长是衡量内容质量和用户价值的核心指标，需要从多个维度进行拆解分析：

- **书籍维度**: 找到最受欢迎和最冷门的内容
- **用户维度**: 识别高价值用户和需要激活的用户
- **分类维度**: 指导内容采购和运营策略
- **时间维度**: 优化内容推荐和运营活动时机

#### 4.2.2 数据指标

| 维度 | 指标 | 说明 |
|------|------|------|
| **书籍维度** | 阅读时长TOP书籍 | 总阅读时长最多的书籍（前20） |
| | 阅读时长BOTTOM书籍 | 总阅读时长最少的书籍（排除0时长，后20） |
| | 平均阅读时长TOP书籍 | 人均阅读时长最长的书（衡量深度） |
| | 书籍阅读详情 | 总时长/独立读者数/会话数/完成率 |
| **用户维度** | 阅读时长TOP用户 | 累计阅读时长最长的用户（前50） |
| | 用户阅读分布 | 20%/50%/80%分位数 |
| | 重度用户画像 | 阅读偏好/活跃时段/设备偏好 |
| | 用户阅读趋势 | 单个用户的阅读时长趋势 |
| **分类维度** | 分类阅读时长占比 | 各分类总阅读时长和百分比 |
| | 分类平均阅读时长 | 各分类人均阅读时长 |
| | 分类增长趋势 | 环比/同比增长率 |
| | 分类热力图 | 时段×分类的阅读热力分布 |
| **时间维度** | 阅读时长趋势 | 日/周/月趋势图 |
| | 小时级热力图 | 24小时阅读高峰分析 |
| | 工作日vs周末 | 对比分析 |
| | 季节性分析 | 识别周期性规律 |

#### 4.2.3 页面设计

**新增页面**: `/reading-stats`

**页面结构**:
```
┌─────────────────────────────────────────────────────────────────┐
│                       阅读时长统计                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [时间筛选] 今日 | 本周 | 本月 | 自定义  [刷新] [导出]            │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 总阅读时长    │ │ 总阅读会话    │ │ 平均会话时长  │            │
│  │ 1,234,567min │ │ 45,678       │ │ 27 min       │            │
│  │ ↑ 12.5%      │ │ ↑ 8.3%       │ │ ↑ 3.2%       │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   阅读时长趋势                            │  │
│  │  [折线图: 过去30天每日阅读时长]                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─────────────────────────┐ ┌──────────────────────────────┐  │
│  │  24小时阅读热力图        │ │  分类阅读时长分布            │  │
│  │  [热力图: 小时×星期]     │ │  [饼图或条形图]             │  │
│  └─────────────────────────┘ └──────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              书籍阅读时长排行 TOP 20                       │  │
│  │  [表格: 排名/封面/书名/作者/总时长/读者数/平均时长]       │  │
│  │  支持排序: 总时长↓/读者数/平均时长                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              用户阅读时长排行 TOP 50                       │  │
│  │  [表格: 排名/用户ID/总时长/会话数/活跃天数/最爱分类]       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.4 API 设计

**新增接口**:

#### 4.2.5 数据库查询示例

**核心查询逻辑**:

#### 4.2.6 性能优化

**索引优化**:

**数据预计算**:
- 每日定时任务（凌晨2点）计算前一天的阅读时长统计
- 存储到 `operations_daily_stats` 表
- Dashboard 优先读取预计算数据，降低实时查询压力

**缓存策略**:
- 当日数据：缓存 5 分钟
- 历史数据：缓存 1 小时
- 使用 Redis 存储热点数据

---

### 4.3 留存率分析

#### 4.3.1 数据指标

| 指标 | 说明 |
|------|------|
| 次日留存率 | 注册后第2天继续使用的用户占比 |
| 7日留存率 | 注册后第8天继续使用的用户占比 |
| 30日留存率 | 注册后第31天继续使用的用户占比 |
| 留存曲线 | 1-90天留存率趋势 |
| 渠道留存对比 | 不同渠道用户的留存差异 |

#### 4.3.2 页面设计

**新增页面**: `/user-retention`

**页面结构**:
```
┌─────────────────────────────────────────────────────────────────┐
│                         用户留存分析                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [选择cohort] 2026-01-01 注册用户 [对比另一个cohort]            │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 次日留存      │ │ 7日留存       │ │ 30日留存      │            │
│  │ 45.2%        │ │ 23.8%        │ │ 12.5%        │            │
│  │ ↑ 3.2pp      │ │ ↑ 1.5pp      │ │ ↓ 0.8pp      │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  留存曲线（1-90天）                        │  │
│  │  [折线图: 显示留存率随天数的衰减]                         │  │
│  │  支持对比多个 cohort                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  渠道留存对比                              │  │
│  │  [表格: 渠道/注册数/次日留存/7日留存/30日留存]            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.3.4 数据库设计

**新增表**: `user_retention`

#### 4.3.5 计算逻辑

---

### 4.4 订阅转化与收入分析

#### 4.4.1 需求背景

Readmigo 采用**订阅制**商业模式，提供月度/季度/年度会员订阅。需要重点关注订阅制产品的核心指标，与单次付费产品有本质区别。

#### 4.4.2 数据指标

**订阅健康度指标**:

| 维度 | 指标 | 说明 | 重要性 |
|------|------|------|-------|
| **收入指标** | MRR（月度经常性收入） | 所有活跃订阅的月度收入 | ⭐⭐⭐⭐⭐ |
| | ARR（年度经常性收入） | MRR × 12 | ⭐⭐⭐⭐⭐ |
| | 新增 MRR | 新订阅带来的 MRR | ⭐⭐⭐⭐ |
| | 流失 MRR | 取消/到期订阅损失的 MRR | ⭐⭐⭐⭐⭐ |
| | 扩展 MRR | 升级订阅带来的 MRR | ⭐⭐⭐ |
| | 降级 MRR | 降级订阅损失的 MRR | ⭐⭐⭐ |
| **用户指标** | 活跃订阅用户数 | 当前有效订阅的用户数 | ⭐⭐⭐⭐⭐ |
| | 新增订阅用户 | 本期新付费用户 | ⭐⭐⭐⭐ |
| | 流失订阅用户 | 本期取消/到期用户 | ⭐⭐⭐⭐⭐ |
| | ARPU | 人均收入（所有用户） | ⭐⭐⭐⭐ |
| | ARPPU | 人均收入（仅付费用户） | ⭐⭐⭐ |
| **转化指标** | 注册→试用转化率 | 注册后开始试用的比例 | ⭐⭐⭐⭐ |
| | 试用→付费转化率 | 试用后转为付费的比例 | ⭐⭐⭐⭐⭐ |
| | 整体付费转化率 | 注册→付费的整体转化 | ⭐⭐⭐⭐ |
| **留存指标** | 月度流失率（Churn Rate） | 当月取消订阅的比例 | ⭐⭐⭐⭐⭐ |
| | 续费率（Renewal Rate） | 到期后续费的比例 | ⭐⭐⭐⭐⭐ |
| | 升级率 | 订阅升级的比例 | ⭐⭐⭐ |
| | 降级率 | 订阅降级的比例 | ⭐⭐⭐ |
| **订阅分布** | 月度会员占比 | 月度订阅用户数/总数 | ⭐⭐⭐ |
| | 季度会员占比 | 季度订阅用户数/总数 | ⭐⭐⭐ |
| | 年度会员占比 | 年度订阅用户数/总数 | ⭐⭐⭐ |
| | 试用用户占比 | 试用期用户数/总数 | ⭐⭐⭐ |
| **价值指标** | LTV（用户生命周期价值） | 单个用户预期总收入 | ⭐⭐⭐⭐⭐ |
| | CAC（获客成本） | 单个用户获取成本 | ⭐⭐⭐⭐ |
| | LTV/CAC 比率 | 投资回报率 | ⭐⭐⭐⭐⭐ |

#### 4.4.3 页面设计

**新增页面**: `/subscription-analytics`

**页面结构**:
```
┌─────────────────────────────────────────────────────────────────┐
│                       订阅与收入分析                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [时间筛选] 本月 | 本季度 | 本年 | 自定义  [刷新] [导出]        │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ MRR          │ │ ARR          │ │ 活跃订阅      │            │
│  │ $12,345      │ │ $148,140     │ │ 1,234        │            │
│  │ ↑ 8.5%       │ │ ↑ 8.5%       │ │ ↑ 45         │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 月度流失率    │ │ 试用转化率    │ │ 续费率        │            │
│  │ 4.2%         │ │ 12.5%        │ │ 78.3%        │            │
│  │ ↓ 0.5pp      │ │ ↑ 1.2pp      │ │ ↑ 2.1pp      │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   MRR 趋势与构成                           │  │
│  │  [堆叠面积图: 新增MRR/扩展MRR/流失MRR/净MRR]              │  │
│  │  显示 MRR 增长轨迹和各部分贡献                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─────────────────────────┐ ┌──────────────────────────────┐  │
│  │  订阅类型分布            │ │  订阅转化漏斗                │  │
│  │  [饼图]                │ │  [漏斗图]                    │  │
│  │  · 月度 45%            │ │  注册 (100%)                 │  │
│  │  · 季度 15%            │ │    ↓                         │  │
│  │  · 年度 35%            │ │  开始试用 (65%)              │  │
│  │  · 试用  5%            │ │    ↓                         │  │
│  │                        │ │  转为付费 (12.5%)            │  │
│  └─────────────────────────┘ └──────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   订阅健康度指标                           │  │
│  │  [表格]                                                   │  │
│  │  指标          | 本月    | 上月    | 变化   | 趋势图      │  │
│  │  ──────────────|────────|────────|───────|───────────  │  │
│  │  新增 MRR      | $2,345 | $2,100 | +11.7%| ↗          │  │
│  │  流失 MRR      | $  520 | $  680 | -23.5%| ↘          │  │
│  │  扩展 MRR      | $  180 | $  150 | +20.0%| ↗          │  │
│  │  降级 MRR      | $   80 | $   90 | -11.1%| ↘          │  │
│  │  净增 MRR      | $1,925 | $1,480 | +30.1%| ↗          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              订阅用户生命周期价值（LTV）                   │  │
│  │  [卡片组]                                                 │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │  │
│  │  │ 月度会员LTV  │ │ 季度会员LTV  │ │ 年度会员LTV  │         │  │
│  │  │ $45.20      │ │ $89.50      │ │ $156.80     │         │  │
│  │  │ (3.2个月)   │ │ (4.5个月)   │ │ (13.2个月)  │         │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   近期订阅动态                             │  │
│  │  [表格: 时间/用户/类型/套餐/金额/状态/来源平台]           │  │
│  │  支持筛选: 新订阅/续费/升级/降级/取消                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.4.4 API 设计

**新增接口**:

#### 4.4.5 数据库查询

**核心表**: `subscriptions` (已存在，包含订阅信息)

**关键查询示例**:

#### 4.4.6 性能优化

**索引优化**:

**缓存策略**:
- 当日 MRR：5分钟缓存
- 历史 MRR 趋势：1小时缓存
- 订阅健康度指标：15分钟缓存
- 订阅动态列表：实时查询（无缓存）

**预计算表（可选）**:

**定时任务**:
- 每日凌晨 3 点计算前一天的订阅统计数据
- 每月 1 号计算上月的完整指标

#### 4.4.7 实施计划

**预计时间**: 3 个工作日

**Day 1: 数据库准备**
- [ ] 确认 `subscriptions` 表结构
- [ ] 创建必要的索引
- [ ] （可选）创建 `subscription_daily_stats` 预计算表
- [ ] 验证数据质量和完整性

**Day 2: 后端开发**
- [ ] 创建 `SubscriptionAnalyticsService`
- [ ] 实现 7 个 API 接口：
  - `/api/v1/admin/subscription/overview`
  - `/api/v1/admin/subscription/mrr-trend`
  - `/api/v1/admin/subscription/plan-distribution`
  - `/api/v1/admin/subscription/conversion-funnel`
  - `/api/v1/admin/subscription/health-metrics`
  - `/api/v1/admin/subscription/activity`
  - `/api/v1/admin/subscription/ltv-analysis`
- [ ] 实现 Redis 缓存
- [ ] 编写单元测试

**Day 3: 前端开发与测试**
- [ ] 创建 `/subscription-analytics` 页面
- [ ] 实现 MRR 趋势堆叠面积图
- [ ] 实现订阅类型分布饼图
- [ ] 实现转化漏斗图
- [ ] 实现健康度指标表格
- [ ] 实现 LTV 卡片组
- [ ] 实现订阅动态列表
- [ ] 数据验证和测试
- [ ] 性能测试

---

### 4.5 用户画像统计

#### 4.5.1 需求背景

用户画像是精准运营的基础，通过统计用户的性别、年龄、地区分布，可以：

- **市场分析**: 了解目标用户群体特征
- **精准投放**: 根据用户画像优化广告投放
- **产品优化**: 针对主要用户群体优化产品功能
- **内容策略**: 根据用户偏好调整内容采购方向

#### 4.5.2 数据库字段设计

**需要在 User 表中新增字段**:

```prisma
model User {
  // ... 现有字段 ...

  // 用户画像扩展
  gender       Gender?   @default(UNKNOWN) // 性别
  birthDate    DateTime? @map("birth_date") @db.Date // 出生日期
  country      String?   @db.VarChar(50) // 国家
  region       String?   @db.VarChar(100) // 省份/州
  city         String?   @db.VarChar(100) // 城市
  timezone     String?   @db.VarChar(50) // 时区

  // 数据来源和隐私
  profileSource String?  @map("profile_source") @db.VarChar(20) // USER_INPUT, DEVICE, INFERRED
  profileConsent Boolean @default(false) @map("profile_consent") // 用户是否同意使用画像数据

  // ... 其他字段 ...
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
  UNKNOWN
}
```

**数据迁移说明**:
- 新增字段默认为 NULL 或 UNKNOWN
- 不影响现有用户
- 客户端逐步收集用户画像信息（注册流程、个人设置页）

#### 4.5.3 数据指标

| 维度 | 指标 | 说明 |
|------|------|------|
| **性别维度** | 性别分布 | 男性/女性/其他/未设置的用户数和占比 |
| | 性别活跃度 | 各性别的 DAU/MAU |
| | 性别付费率 | 各性别的付费转化率和 ARPU |
| | 性别阅读偏好 | 各性别最喜欢的书籍分类 |
| **年龄维度** | 年龄段分布 | <18岁/18-24/25-34/35-44/45-54/55+/未设置 |
| | 年龄段活跃度 | 各年龄段的 DAU/MAU |
| | 年龄段付费率 | 各年龄段的付费转化率和 ARPU |
| | 年龄段阅读偏好 | 各年龄段最喜欢的书籍分类 |
| **地区维度** | 国家分布 | TOP 20 国家的用户数和占比 |
| | 省份/城市分布 | TOP 50 省份/城市的用户数（中国） |
| | 地区活跃度 | 各地区的 DAU/MAU |
| | 地区付费率 | 各地区的付费转化率和 ARPU |
| | 地区时段偏好 | 不同地区的活跃时段分布 |

#### 4.5.4 页面设计

**新增页面**: `/user-demographics`

**页面结构**:
```
┌─────────────────────────────────────────────────────────────────┐
│                       用户画像统计                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [时间筛选] 全部用户 | 活跃用户 | 付费用户  [刷新] [导出]        │
│                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 画像完整度    │ │ 性别分布      │ │ 年龄分布      │            │
│  │ 45.2%        │ │ 男52% 女38%  │ │ 25-34岁最多   │            │
│  │ (有画像数据)  │ │ 其他10%      │ │              │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│                                                                 │
│  ┌─────────────────────────┐ ┌──────────────────────────────┐  │
│  │  性别分布               │ │  性别×阅读偏好               │  │
│  │  [饼图]                │ │  [分组条形图]               │  │
│  │  · 男性 52%            │ │  显示各性别最爱分类          │  │
│  │  · 女性 38%            │ │                             │  │
│  │  · 其他 2%             │ │                             │  │
│  │  · 未设置 8%           │ │                             │  │
│  └─────────────────────────┘ └──────────────────────────────┘  │
│                                                                 │
│  ┌─────────────────────────┐ ┌──────────────────────────────┐  │
│  │  年龄段分布             │ │  年龄段×付费率               │  │
│  │  [柱状图]              │ │  [折线图+柱状图组合]         │  │
│  │  <18 | 18-24 | 25-34  │ │  显示各年龄段付费转化率      │  │
│  │  35-44 | 45-54 | 55+  │ │                             │  │
│  └─────────────────────────┘ └──────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  地区分布 TOP 20                          │  │
│  │  [地图热力图 或 表格]                                     │  │
│  │  排名 | 国家/地区 | 用户数 | 占比 | DAU | 付费率 | ARPU  │  │
│  │  1    | 中国      | 45,678 | 52% | 12K | 5.2%  | $3.45 │  │
│  │  2    | 美国      | 8,234  | 9%  | 2.3K| 8.5%  | $9.20 │  │
│  │  ...                                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              中国省份/城市分布 TOP 20                      │  │
│  │  [表格: 省份/城市 | 用户数 | 占比 | 活跃度]               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.5.5 API 设计

**新增接口**:

#### 4.5.6 SQL 查询示例

**性别分布统计**:

**年龄段分布统计**:

**地区分布统计（国家级别）**:

**性别×年龄交叉分析**:

#### 4.5.7 性能优化

**索引优化**:

**数据预计算**:
- 每日定时任务（凌晨3点）计算用户画像统计
- 存储到新表 `user_demographics_stats`
- Dashboard 优先读取预计算数据

**缓存策略**:
- 用户画像概览：1小时缓存
- 详细统计数据：30分钟缓存
- 交叉分析：15分钟缓存

#### 4.5.8 隐私合规

**GDPR & 数据隐私**:

1. **数据收集原则**:
   - 明确告知用户数据用途
   - 获取用户明确同意（`profileConsent` 字段）
   - 提供选择不提供画像数据的选项

2. **数据展示原则**:
   - Dashboard 中仅展示聚合数据，不展示个人信息
   - 导出数据需要脱敏处理
   - 访问日志记录和审计

3. **用户权利**:
   - 用户可随时修改/删除画像数据
   - 提供数据导出功能（GDPR Right to Data Portability）
   - 提供"被遗忘权"（删除账户同时删除所有画像数据）

4. **数据安全**:
   - 画像数据加密存储
   - API 访问权限控制
   - 定期安全审计

**客户端数据收集**:

**数据推断（可选）**:

如果用户未主动提供画像信息，可以通过以下方式推断（需获得同意）：

- 通过设备信息推断地区（IP地址、时区）
- 通过阅读偏好推断年龄段（仅作为参考，不作为确定数据）
- 标记数据来源：`profileSource = 'INFERRED'`

#### 4.5.9 实施步骤

**阶段1: 数据库准备（1天）**
- [ ] 添加新字段到 User 表
- [ ] 创建迁移文件
- [ ] 添加索引
- [ ] 部署到生产环境

**阶段2: 后端开发（2天）**
- [ ] 创建 demographics module
- [ ] 实现 API 接口
- [ ] 编写 SQL 查询逻辑
- [ ] 单元测试

**阶段3: 前端开发（2天）**
- [ ] 创建 UserDemographicsDashboard 页面
- [ ] 实现图表组件（饼图、柱状图、地图）
- [ ] 交叉分析功能
- [ ] 数据导出功能

**阶段4: 客户端集成（并行，不阻塞 Dashboard）**
- [ ] iOS: 添加画像收集流程
- [ ] Android: 添加画像收集流程
- [ ] Web: 添加画像收集流程
- [ ] 注册流程优化

**阶段5: 测试与发布（1天）**
- [ ] 功能测试
- [ ] 性能测试
- [ ] 隐私合规检查
- [ ] 部署发布

**总计**: 6个工作日

---

## 五、实施计划

### 5.1 技术架构

**后端（NestJS）**:
```
apps/backend/src/modules/admin/
├── operations/              # 已有
│   ├── operations.controller.ts
│   └── operations.service.ts
├── reading-stats/           # 新增
│   ├── reading-stats.controller.ts
│   ├── reading-stats.service.ts
│   └── dto/
├── retention/               # 新增
│   ├── retention.controller.ts
│   ├── retention.service.ts
│   └── dto/
├── monetization/            # 新增
│   ├── monetization.controller.ts
│   ├── monetization.service.ts
│   └── dto/
└── demographics/            # 新增（用户画像）
    ├── demographics.controller.ts
    ├── demographics.service.ts
    └── dto/
```

**前端（React Admin）**:
```
apps/dashboard/src/pages/
├── operations/              # 已有
│   ├── OperationsDashboard.tsx
│   └── PerformanceDashboard.tsx
├── reading-stats/           # 新增
│   ├── ReadingStatsDashboard.tsx
│   ├── components/
│   │   ├── ReadingHeatmap.tsx
│   │   ├── BookRankingTable.tsx
│   │   ├── UserRankingTable.tsx
│   │   └── CategoryDistribution.tsx
│   └── index.tsx
├── retention/               # 新增
│   ├── RetentionDashboard.tsx
│   ├── components/
│   │   ├── RetentionCurve.tsx
│   │   └── ChannelComparison.tsx
│   └── index.tsx
├── monetization/            # 新增
│   ├── MonetizationDashboard.tsx
│   ├── components/
│   │   ├── ConversionFunnel.tsx
│   │   └── RevenueChart.tsx
│   └── index.tsx
└── demographics/            # 新增（用户画像）
    ├── UserDemographicsDashboard.tsx
    ├── components/
    │   ├── GenderDistribution.tsx
    │   ├── AgeDistribution.tsx
    │   ├── LocationDistribution.tsx
    │   └── CrossAnalysis.tsx
    └── index.tsx
```

**数据库迁移**:
```
packages/database/prisma/migrations/
├── xxx_add_retention_table.sql
└── xxx_add_user_demographics_fields.sql
```

### 5.2 实施步骤（P0）

#### 阶段1: 阅读时长分析（5天）
- [ ] Day 1-2: 后端API开发
  - 实现 reading-stats controller/service
  - 编写数据库查询逻辑
  - 添加必要索引
- [ ] Day 3-4: 前端页面开发
  - 创建 ReadingStatsDashboard
  - 实现各个组件（热力图、排行榜等）
- [ ] Day 5: 测试与优化
  - 性能测试
  - 数据准确性验证

#### 阶段2: 留存率分析（4天）
- [ ] Day 1-2: 后端开发
  - 创建 user_retention 表
  - 实现留存计算定时任务
  - 开发 retention API
- [ ] Day 3: 前端开发
  - 创建 RetentionDashboard
  - 实现留存曲线图
- [ ] Day 4: 测试与优化

#### 阶段3: 付费转化分析（3天）
- [ ] Day 1-2: 后端开发
  - 实现 monetization API
  - 优化订单查询
- [ ] Day 2-3: 前端开发
  - 创建 MonetizationDashboard
  - 实现转化漏斗和收入趋势图

#### 阶段4: 用户画像统计（6天）
- [ ] Day 1: 数据库准备
  - 添加 gender, birthDate, country, region, city 等字段到 User 表
  - 创建迁移文件和索引
  - 部署数据库变更
- [ ] Day 2-3: 后端开发
  - 创建 demographics module
  - 实现 5个 API 接口（overview/gender/age/location/cross-analysis）
  - 编写 SQL 查询逻辑
- [ ] Day 4-5: 前端开发
  - 创建 UserDemographicsDashboard 页面
  - 实现图表组件（性别饼图、年龄柱状图、地区分布）
  - 实现交叉分析功能
- [ ] Day 6: 测试与优化
  - 功能测试
  - 性能测试
  - 隐私合规检查

#### 阶段5: 集成与发布（2天）
- [ ] 添加菜单导航
- [ ] 权限配置
- [ ] 文档编写
- [ ] 部署到生产环境

**总计**: 20个工作日（约4周）

**备注**: 客户端画像数据收集功能（iOS/Android/Web）可以并行开发，不阻塞 Dashboard 上线。

---

## 六、数据可视化标准

### 6.1 图表选择指南

| 数据类型 | 推荐图表 | 使用场景 | 库/组件 |
|---------|---------|---------|---------|
| 趋势数据 | 折线图 | DAU/收入趋势 | Recharts Line Chart |
| 占比数据 | 饼图/环形图 | 平台/分类占比 | Recharts Pie Chart |
| 排行数据 | 条形图/表格 | 书籍/用户排行 | MUI Table |
| 分布数据 | 直方图 | 用户阅读时长分布 | Recharts Bar Chart |
| 漏斗数据 | 漏斗图 | 付费转化流程 | Recharts Funnel |
| 对比数据 | 分组柱状图 | 渠道效果对比 | Recharts Bar Chart |
| 时段数据 | 热力图 | 24小时阅读热力 | react-calendar-heatmap |
| 关联数据 | 散点图 | 阅读时长vs留存 | Recharts Scatter |

### 6.2 配色方案

**主题色（遵循 Readmigo 品牌）**:
- 主色: `#7C8DF5` (紫蓝)
- 辅助色: `#6ED6A8` (绿)、`#FFD36A` (黄)、`#F3A6DC` (粉)
- 中性色: `#9E9E9E` (灰)

**数据可视化色板**:

### 6.3 交互规范

- **Tooltip**: 鼠标悬停显示详细数据
- **Legend**: 图例支持点击切换显示/隐藏
- **Zoom**: 大数据量图表支持缩放
- **Export**: 所有图表支持导出为 PNG
- **Drill-down**: 支持从汇总数据下钻到详情

---

## 七、性能与监控

### 7.1 性能目标

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 页面加载时间 | < 2s | 首屏渲染完成 |
| API响应时间 | < 500ms | P95 |
| 数据刷新间隔 | 5min | 当日数据 |
| 并发支持 | 50+ | 同时在线运营人员 |

### 7.2 监控告警

**关键指标告警**:
- DAU 突然下降 > 20%
- 付费转化率下降 > 15%
- API 错误率 > 1%
- 查询超时 > 5s

**告警渠道**:
- 钉钉/飞书通知
- 邮件通知
- Dashboard 红色标识

---

## 八、权限与安全

### 8.1 角色权限

| 角色 | 权限范围 |
|------|---------|
| SuperAdmin | 所有数据查看/导出 |
| Operations | 运营数据查看/导出 |
| Finance | 付费数据查看/导出 |
| Support | 基础数据查看 |

### 8.2 数据安全

- 敏感数据脱敏（用户手机号、邮箱等）
- 操作日志记录
- 数据导出审计
- 访问频率限制

---

## 九、后续迭代计划

### P1 优先级（4周）
- 用户分层管理
- 内容完成率分析
- 功能使用率统计
- 渠道效果分析

### P2 优先级（6周）
- 推荐效果分析
- 运营活动追踪
- A/B测试结果
- 用户反馈趋势

### 长期规划
- AI 驱动的异常检测
- 自动化运营报告生成
- 预测分析（用户流失预测、LTV预测）
- 实时数据大屏

---

## 十、参考资料

- [operations-analytics-design.md](./operations-analytics-design.md) - 运营数据统计系统设计
- [Dashboard Platform](./dashboard-platform.md) - Dashboard 平台架构
- [Database Schema](../../../packages/database/prisma/schema.prisma) - 数据库设计

---

## 附录

### A. 数据字典

详见数据库 schema 文档。

### B. API 文档

详见 Swagger 文档（生产环境不开放）。

### C. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-01-11 | 初始版本 | - |

---

**文档结束**

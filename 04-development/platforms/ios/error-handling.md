# iOS 错误处理

> Swift Error + Result 类型 + 错误恢复

---

## 1. 错误处理概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误处理架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    错误分类                              │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  业务错误                     系统错误                    │    │
│  │  ├── AuthError               ├── NetworkError           │    │
│  │  ├── ValidationError         ├── StorageError           │    │
│  │  └── BusinessLogicError      └── SystemError            │    │
│  │                                                          │    │
│  │  可恢复错误                   不可恢复错误                 │    │
│  │  ├── 网络超时 → 重试          ├── 数据损坏 → 清除        │    │
│  │  ├── Token 过期 → 刷新        ├── 致命错误 → 重启        │    │
│  │  └── 输入错误 → 提示          └── 配置错误 → 报告        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 错误类型定义

### 2.1 AppError 基类

```
┌─────────────────────────────────────────────────────────────────┐
│                    AppError 层级                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  AppError (Protocol)                                            │
│  ├── errorCode: String                                         │
│  ├── localizedDescription: String                              │
│  ├── isRecoverable: Bool                                       │
│  └── underlyingError: Error?                                   │
│                                                                  │
│  NetworkError                                                   │
│  ├── noConnection                                              │
│  ├── timeout                                                   │
│  ├── serverError(statusCode: Int, message: String?)            │
│  ├── invalidResponse                                           │
│  └── decodingFailed(Error)                                     │
│                                                                  │
│  AuthError                                                      │
│  ├── unauthorized                                              │
│  ├── tokenExpired                                              │
│  ├── invalidCredentials                                        │
│  ├── accountLocked                                             │
│  └── sessionExpired                                            │
│                                                                  │
│  StorageError                                                   │
│  ├── readFailed(path: String)                                  │
│  ├── writeFailed(path: String)                                 │
│  ├── notFound(identifier: String)                              │
│  ├── insufficientSpace                                         │
│  └── corruptedData                                             │
│                                                                  │
│  ReaderError                                                    │
│  ├── invalidFormat                                             │
│  ├── parseFailed(reason: String)                               │
│  ├── renderFailed                                              │
│  ├── unsupportedFeature                                        │
│  └── resourceMissing(name: String)                             │
│                                                                  │
│  AIError                                                        │
│  ├── quotaExceeded                                             │
│  ├── requestFailed                                             │
│  ├── invalidInput                                              │
│  └── serviceUnavailable                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 错误属性

| 属性 | 说明 |
|------|------|
| errorCode | 唯一错误标识 |
| localizedDescription | 用户可读描述 |
| isRecoverable | 是否可恢复 |
| recoverySuggestion | 恢复建议 |
| underlyingError | 底层错误 |

---

## 3. 错误处理模式

### 3.1 throws 模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    throws 错误处理                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  函数声明                                                        │
│  func fetchBook(id: String) async throws -> Book                │
│                                                                  │
│  调用处理                                                        │
│  ├── do-catch                                                  │
│  │   do {                                                       │
│  │       let book = try await fetchBook(id: "123")             │
│  │   } catch let error as NetworkError {                       │
│  │       handleNetworkError(error)                             │
│  │   } catch let error as AuthError {                          │
│  │       handleAuthError(error)                                │
│  │   } catch {                                                  │
│  │       handleUnknownError(error)                             │
│  │   }                                                          │
│  │                                                              │
│  ├── try?                                                      │
│  │   let book = try? await fetchBook(id: "123")                │
│  │   └── 失败返回 nil                                           │
│  │                                                              │
│  └── try!                                                      │
│      let book = try! await fetchBook(id: "123")                │
│      └── 失败崩溃 (仅用于确定不会失败的场景)                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Result 模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    Result 类型                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Result<Success, Failure: Error>                               │
│  ├── .success(value)                                           │
│  └── .failure(error)                                           │
│                                                                  │
│  使用场景                                                        │
│  ├── 回调中返回结果                                              │
│  ├── 需要保存结果供后续处理                                      │
│  └── 需要 map/flatMap 转换                                      │
│                                                                  │
│  常用操作                                                        │
│  ├── result.get()           throws 获取值                      │
│  ├── result.map { }         转换成功值                          │
│  ├── result.mapError { }    转换错误                            │
│  └── result.flatMap { }     链式转换                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 异步错误处理

### 4.1 async/await 错误处理

```
┌─────────────────────────────────────────────────────────────────┐
│                    异步错误处理                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ViewModel 中的异步调用                                          │
│                                                                  │
│  @MainActor                                                     │
│  func loadBooks() async {                                       │
│      isLoading = true                                           │
│      defer { isLoading = false }                               │
│                                                                  │
│      do {                                                       │
│          books = try await bookService.fetchBooks()            │
│          error = nil                                            │
│      } catch is CancellationError {                            │
│          // Task 被取消，不处理                                   │
│      } catch let error as NetworkError {                       │
│          self.error = error                                     │
│          handleNetworkError(error)                             │
│      } catch {                                                  │
│          self.error = AppError.unknown(error)                  │
│          logger.error("Unexpected: \(error)")                  │
│      }                                                          │
│  }                                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Task 错误处理

| 场景 | 处理方式 |
|------|----------|
| Task 取消 | CancellationError |
| 超时 | withTimeout |
| 重试 | 自定义重试逻辑 |
| 并发错误 | TaskGroup 错误聚合 |

---

## 5. 网络错误处理

### 5.1 HTTP 错误映射

```
┌─────────────────────────────────────────────────────────────────┐
│                    HTTP 状态码处理                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  状态码         错误类型                处理策略                  │
│  ─────────────────────────────────────────────────────────────  │
│  400            ValidationError        显示验证错误              │
│  401            AuthError.unauthorized 跳转登录                  │
│  403            AuthError.forbidden    显示权限不足              │
│  404            NotFoundError          显示未找到                │
│  408            NetworkError.timeout   提示重试                  │
│  429            RateLimitError         显示限流提示              │
│  500-599        NetworkError.server    显示服务异常              │
│                                                                  │
│  网络层错误                                                      │
│  ─────────────────────────────────────────────────────────────  │
│  无网络          NetworkError.noConnection  显示离线提示        │
│  超时            NetworkError.timeout       提示重试            │
│  SSL 错误        NetworkError.ssl          显示安全警告         │
│  DNS 失败        NetworkError.dns          检查网络设置         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 重试策略

| 策略 | 说明 |
|------|------|
| 固定间隔 | 每次重试间隔相同 |
| 指数退避 | 间隔逐次翻倍 |
| 带抖动 | 添加随机偏移 |
| 最大次数 | 限制重试次数 |

---

## 6. UI 错误展示

### 6.1 错误展示策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误 UI 策略                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  错误严重程度              展示方式                              │
│  ─────────────────────────────────────────────────────────────  │
│  低 (提示性)               Toast / Banner                       │
│                            └── 短暂显示后自动消失               │
│                                                                  │
│  中 (需确认)               Alert                                │
│                            └── 用户确认后消失                   │
│                                                                  │
│  高 (阻断性)               FullScreen Error                     │
│                            └── 需要用户操作才能继续             │
│                                                                  │
│  致命                       App 重启提示                        │
│                            └── 建议重启应用                     │
│                                                                  │
│  展示组件                                                        │
│  ├── ErrorToast           顶部/底部滑入                         │
│  ├── ErrorBanner          页面内嵌                              │
│  ├── ErrorAlert           模态弹窗                              │
│  ├── ErrorView            整页错误                              │
│  └── ErrorSheet           底部弹出                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 错误视图组件

| 组件 | 用途 |
|------|------|
| ErrorView | 整页错误展示 |
| ErrorBanner | 页面顶部提示 |
| ErrorToast | 临时消息提示 |
| RetryButton | 重试按钮 |

---

## 7. 错误恢复

### 7.1 恢复策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误恢复策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  网络错误恢复                                                    │
│  ├── 自动重试                                                    │
│  │   ├── 最多 3 次                                              │
│  │   ├── 指数退避 (1s, 2s, 4s)                                 │
│  │   └── 网络恢复后自动重试                                      │
│  │                                                              │
│  └── 手动重试                                                    │
│      └── 用户点击重试按钮                                        │
│                                                                  │
│  认证错误恢复                                                    │
│  ├── Token 过期                                                 │
│  │   └── 自动刷新 Token                                         │
│  │                                                              │
│  └── 登录失效                                                    │
│      └── 跳转登录页                                              │
│                                                                  │
│  数据错误恢复                                                    │
│  ├── 缓存失效                                                    │
│  │   └── 重新获取远程数据                                        │
│  │                                                              │
│  └── 数据损坏                                                    │
│      └── 清除本地缓存                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 网络监听恢复

| 事件 | 动作 |
|------|------|
| 网络恢复 | 重试失败请求 |
| 网络断开 | 显示离线提示 |
| 切换网络 | 检查连接状态 |

---

## 8. 错误日志

### 8.1 日志策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误日志策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  日志级别                                                        │
│  ├── debug    开发调试信息                                      │
│  ├── info     一般信息                                          │
│  ├── warning  警告信息                                          │
│  ├── error    错误信息                                          │
│  └── fatal    致命错误                                          │
│                                                                  │
│  错误日志内容                                                    │
│  ├── 错误类型                                                    │
│  ├── 错误消息                                                    │
│  ├── 错误码                                                      │
│  ├── 堆栈追踪                                                    │
│  ├── 上下文信息                                                  │
│  │   ├── 用户 ID                                                │
│  │   ├── 设备信息                                                │
│  │   ├── App 版本                                               │
│  │   └── 时间戳                                                  │
│  └── 底层错误                                                    │
│                                                                  │
│  上报策略                                                        │
│  ├── 致命错误 → 立即上报                                        │
│  ├── 普通错误 → 批量上报                                        │
│  └── 调试信息 → 仅本地                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 Crashlytics 集成

| 功能 | 说明 |
|------|------|
| 崩溃报告 | 自动捕获崩溃 |
| 非致命错误 | 手动记录 |
| 自定义 Key | 添加上下文 |
| 用户标识 | 关联用户 |

---

## 9. 阅读器错误处理

### 9.1 阅读器错误类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器错误处理                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  书籍加载错误                                                    │
│  ├── 文件不存在        → 提示重新下载                           │
│  ├── 格式不支持        → 显示格式不支持                         │
│  ├── 解析失败          → 尝试备用解析器                         │
│  └── 加密文件          → 提示输入密码                           │
│                                                                  │
│  渲染错误                                                        │
│  ├── 字体缺失          → 使用系统默认字体                       │
│  ├── 图片加载失败      → 显示占位图                             │
│  ├── CSS 解析错误      → 使用默认样式                           │
│  └── 内存不足          → 清理缓存后重试                         │
│                                                                  │
│  交互错误                                                        │
│  ├── 划词失败          → 静默忽略                               │
│  ├── 书签保存失败      → 提示重试                               │
│  ├── 同步失败          → 本地保存 + 后台重试                    │
│  └── TTS 失败          → 检查系统设置                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 降级策略

| 错误 | 降级方案 |
|------|----------|
| 高级渲染失败 | 使用基础渲染 |
| 云端字体失败 | 使用本地字体 |
| 图片加载失败 | 显示占位符 |
| AI 服务不可用 | 使用本地词典 |

---

## 10. 最佳实践

### 10.1 错误处理原则

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误处理原则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  明确的错误类型                                                  │
│  ├── 使用 enum 定义具体错误                                     │
│  ├── 避免使用通用 Error                                         │
│  └── 提供足够的错误上下文                                        │
│                                                                  │
│  优雅降级                                                        │
│  ├── 提供备选方案                                                │
│  ├── 保持核心功能可用                                            │
│  └── 不让用户卡住                                                │
│                                                                  │
│  用户友好                                                        │
│  ├── 错误信息本地化                                              │
│  ├── 提供可操作建议                                              │
│  └── 避免技术术语                                                │
│                                                                  │
│  完整记录                                                        │
│  ├── 记录错误上下文                                              │
│  ├── 保留原始错误                                                │
│  └── 便于问题排查                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 常见错误模式

| 反模式 | 正确做法 |
|--------|----------|
| 忽略错误 | 明确处理或传播 |
| 空 catch | 至少记录日志 |
| 通用错误 | 使用具体类型 |
| 无上下文 | 提供错误上下文 |

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [monitoring.md](./monitoring.md) | 监控体系 |
| [testing.md](./testing.md) | 测试策略 |

---

*最后更新: 2025-12-31*

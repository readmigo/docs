# iOS AI 功能

> AI 查词 + 翻译 + 问答 + 智能推荐

---

## 1. AI 功能概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 功能架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    阅读场景 AI                           │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  AI 查词  │  │  AI 翻译  │  │  AI 解释  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    对话场景 AI                           │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  书籍问答  │  │  内容总结  │  │  角色对话  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    智能推荐 AI                           │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  书籍推荐  │  │  词汇推荐  │  │  阅读计划  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. AI 查词

### 2.1 查词功能

| 功能 | 说明 |
|------|------|
| 单词释义 | 音标、词性、中英释义 |
| 例句展示 | 权威例句 |
| 语境解释 | 基于当前上下文解释 |
| 发音播放 | 美式/英式发音 |
| 词根分析 | 词根词缀解析 |

### 2.2 查词流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 查词流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户选词                                                        │
│       │                                                          │
│       ▼                                                          │
│  检查本地缓存                                                    │
│       │                                                          │
│       ├── 命中 ──▶ 显示缓存结果                                │
│       │                                                          │
│       └── 未命中                                                 │
│            │                                                     │
│            ▼                                                     │
│       检查配额                                                   │
│            │                                                     │
│            ├── 无配额 ──▶ 显示升级提示                         │
│            │                                                     │
│            └── 有配额                                            │
│                 │                                                │
│                 ▼                                                │
│            发送 AI 请求                                          │
│            ├── 单词                                              │
│            └── 上下文句子                                        │
│                 │                                                │
│                 ▼                                                │
│            接收流式响应                                          │
│                 │                                                │
│                 ▼                                                │
│            显示结果 + 缓存                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. AI 翻译

### 3.1 翻译功能

| 功能 | 说明 |
|------|------|
| 句子翻译 | 选中句子翻译 |
| 段落翻译 | 选中段落翻译 |
| 双语对照 | 显示原文和译文 |
| 语言检测 | 自动检测源语言 |

### 3.2 翻译配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    翻译配置                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  目标语言                                                        │
│  ├── 简体中文                                                    │
│  ├── 繁体中文                                                    │
│  ├── English                                                    │
│  ├── 日本語                                                      │
│  └── 한국어                                                      │
│                                                                  │
│  翻译风格                                                        │
│  ├── 直译    尽量保持原文结构                                   │
│  ├── 意译    注重表达流畅                                       │
│  └── 学术    专业术语准确                                       │
│                                                                  │
│  显示选项                                                        │
│  ├── 仅译文                                                      │
│  ├── 双语对照                                                    │
│  └── 原文标注                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. AI 问答

### 4.1 问答类型

| 类型 | 说明 |
|------|------|
| 内容理解 | 解释书中内容 |
| 背景知识 | 补充相关背景 |
| 人物分析 | 分析角色性格 |
| 主题探讨 | 讨论主题思想 |

### 4.2 对话界面

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 对话界面                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    对话历史区                            │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ 👤 用户: 请解释这段话的意思                        │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ 🤖 AI: 这段话描述了...                            │    │    │
│  │  │      (流式显示)                                   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  快捷问题:                                              │    │
│  │  [解释这段] [总结全文] [分析人物] [背景知识]             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  输入框                                     [发送]       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 智能推荐

### 5.1 推荐类型

| 类型 | 依据 |
|------|------|
| 相似书籍 | 当前阅读书籍 |
| 个性推荐 | 阅读历史偏好 |
| 热门推荐 | 用户群体数据 |
| 新书推荐 | 最新上架书籍 |

### 5.2 推荐算法

```
┌─────────────────────────────────────────────────────────────────┐
│                    推荐系统                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户画像                                                        │
│  ├── 阅读偏好 (类别、作者、难度)                                 │
│  ├── 阅读习惯 (时间、时长、频率)                                 │
│  ├── 交互行为 (高亮、笔记、查词)                                 │
│  └── 学习进度 (词汇量、阅读能力)                                 │
│                                                                  │
│  推荐策略                                                        │
│  ├── 协同过滤    相似用户喜欢的书籍                             │
│  ├── 内容匹配    与当前书籍相似的书籍                           │
│  ├── 难度匹配    符合用户阅读水平                               │
│  └── 新鲜度      平衡推荐新书和热门书                           │
│                                                                  │
│  A/B 测试                                                        │
│  └── 持续优化推荐效果                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 配额管理

### 6.1 配额规则

| 用户类型 | 日配额 | 功能限制 |
|----------|--------|----------|
| 免费用户 | 10 次 | 基础功能 |
| 基础会员 | 100 次 | 全部功能 |
| 高级会员 | 500 次 | 全部功能 + 优先 |
| 专业会员 | 无限 | 全部功能 + 优先 |

### 6.2 配额提示

```
┌─────────────────────────────────────────────────────────────────┐
│                    配额管理                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  配额显示                                                        │
│  ├── 剩余配额    设置页面显示剩余次数                           │
│  ├── 使用提示    每次使用后显示剩余                             │
│  └── 耗尽提醒    配额不足时提醒                                 │
│                                                                  │
│  配额不足处理                                                    │
│  ├── 提示升级    引导订阅会员                                   │
│  ├── 离线词典    降级使用本地词典                               │
│  └── 等待恢复    显示恢复倒计时                                 │
│                                                                  │
│  配额恢复                                                        │
│  ├── 每日重置    每日 0 点重置                                  │
│  └── 时区处理    按用户时区计算                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 缓存策略

### 7.1 缓存层级

| 层级 | 存储 | 过期时间 |
|------|------|----------|
| 内存缓存 | Dictionary | App 生命周期 |
| 磁盘缓存 | CoreData | 30 天 |
| 云端缓存 | 服务器 | 永久 |

### 7.2 缓存策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 缓存策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  缓存 Key 生成                                                   │
│  ├── 查词: word + context_hash                                 │
│  ├── 翻译: text_hash + target_lang                             │
│  └── 问答: question_hash + book_id                             │
│                                                                  │
│  缓存优先级                                                      │
│  ├── 高频词汇    优先缓存常用单词                               │
│  ├── 最近使用    LRU 淘汰策略                                   │
│  └── 用户个人    优先保留用户查询                               │
│                                                                  │
│  缓存大小限制                                                    │
│  ├── 内存: 50MB                                                 │
│  ├── 磁盘: 200MB                                                │
│  └── 自动清理                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 流式响应

### 8.1 流式显示

| 特性 | 说明 |
|------|------|
| 逐字显示 | 打字机效果 |
| 中断支持 | 可随时停止 |
| 错误恢复 | 断点续传 |

### 8.2 流式实现

```
┌─────────────────────────────────────────────────────────────────┐
│                    流式响应                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  请求发送                                                        │
│       │                                                          │
│       ▼                                                          │
│  建立 SSE 连接                                                   │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    流式接收循环                          │    │
│  │                                                          │    │
│  │  接收 chunk                                              │    │
│  │       │                                                  │    │
│  │       ▼                                                  │    │
│  │  解析 JSON                                               │    │
│  │       │                                                  │    │
│  │       ▼                                                  │    │
│  │  追加到显示文本                                          │    │
│  │       │                                                  │    │
│  │       ▼                                                  │    │
│  │  更新 UI (主线程)                                        │    │
│  │       │                                                  │    │
│  │       ▼                                                  │    │
│  │  检查是否结束 ──────▶ 是 ──▶ 完成处理                   │    │
│  │       │                                                  │    │
│  │       └── 否 ──▶ 继续接收                                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 错误处理

### 9.1 错误类型

| 错误 | 处理方式 |
|------|----------|
| 网络错误 | 显示重试按钮 |
| 配额耗尽 | 引导升级 |
| 内容过长 | 提示截断 |
| 服务不可用 | 降级到本地 |

### 9.2 降级策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 降级策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  查词降级                                                        │
│  ├── AI 不可用 ──▶ 本地词典                                    │
│  ├── 本地词典不可用 ──▶ 系统词典                               │
│  └── 均不可用 ──▶ 提示用户                                      │
│                                                                  │
│  翻译降级                                                        │
│  ├── AI 不可用 ──▶ 系统翻译                                    │
│  └── 均不可用 ──▶ 提示用户                                      │
│                                                                  │
│  问答降级                                                        │
│  └── AI 不可用 ──▶ 提示稍后重试                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 性能优化

### 10.1 性能指标

| 指标 | 目标值 |
|------|--------|
| 首字响应 | < 500ms |
| 完整响应 | < 3s |
| 缓存命中率 | > 30% |

### 10.2 优化措施

| 措施 | 说明 |
|------|------|
| 预热连接 | 提前建立连接 |
| 请求合并 | 批量处理请求 |
| 缓存优化 | 多级缓存 |
| 压缩传输 | gzip 压缩 |

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [reader.md](./reader.md) | 阅读器功能 |
| [learning.md](./learning.md) | 学习功能 |
| [../architecture.md](../architecture.md) | 架构设计 |

---

*最后更新: 2025-12-31*

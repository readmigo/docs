# iOS 认证功能

> 登录注册 + OAuth + 会话管理

---

## 1. 功能概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    认证功能架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    登录方式                              │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ 邮箱登录  │  │ Apple登录 │  │ 微信登录  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    Token 管理                            │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ Access    │  │ Refresh   │  │ Keychain  │           │    │
│  │  │  Token    │  │  Token    │  │  存储     │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    会话管理                              │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ 自动续期  │  │ 登出处理  │  │ 多设备    │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 登录方式

### 2.1 支持的登录方式

| 方式 | 说明 | 优先级 |
|------|------|--------|
| Apple 登录 | Sign in with Apple | 推荐 |
| 邮箱登录 | 邮箱 + 密码 | 基础 |
| 微信登录 | 微信 OAuth | 可选 |
| 手机号登录 | 验证码登录 | 可选 |

### 2.2 登录流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    登录流程                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Apple 登录                                                      │
│       │                                                          │
│       ▼                                                          │
│  ASAuthorizationController 授权                                  │
│       │                                                          │
│       ▼                                                          │
│  获取 Apple ID Token                                            │
│       │                                                          │
│       ▼                                                          │
│  发送 Token 到服务器                                             │
│       │                                                          │
│       ▼                                                          │
│  服务器验证并返回                                                │
│  ├── Access Token                                               │
│  └── Refresh Token                                              │
│       │                                                          │
│       ▼                                                          │
│  存储到 Keychain                                                 │
│       │                                                          │
│       ▼                                                          │
│  进入主页面                                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 注册流程

### 3.1 邮箱注册

| 步骤 | 说明 |
|------|------|
| 输入邮箱 | 验证邮箱格式 |
| 设置密码 | 验证密码强度 |
| 发送验证码 | 邮箱验证码 |
| 验证邮箱 | 输入验证码 |
| 完善资料 | 昵称等信息 |

### 3.2 注册界面

```
┌─────────────────────────────────────────────────────────────────┐
│                    注册界面                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │                    创建账户                              │    │
│  │                                                          │    │
│  │  邮箱                                                    │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  user@example.com                               │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  密码                                                    │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  ••••••••                              👁       │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │  密码强度: ████░░░░ 中等                                │    │
│  │                                                          │    │
│  │  确认密码                                                │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  ••••••••                              👁       │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  ☑ 我已阅读并同意《用户协议》和《隐私政策》              │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │                   注册                          │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  │  已有账户？ [登录]                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Token 管理

### 4.1 Token 类型

| Token | 有效期 | 用途 |
|-------|--------|------|
| Access Token | 2 小时 | API 认证 |
| Refresh Token | 30 天 | 刷新 Access Token |

### 4.2 Token 存储

```
┌─────────────────────────────────────────────────────────────────┐
│                    Keychain 存储                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  存储项                                                          │
│  ├── kSecAttrAccount: "access_token"                           │
│  │   └── 值: JWT Access Token                                  │
│  │                                                              │
│  ├── kSecAttrAccount: "refresh_token"                          │
│  │   └── 值: Refresh Token                                     │
│  │                                                              │
│  └── kSecAttrAccount: "user_id"                                │
│      └── 值: 用户 ID                                            │
│                                                                  │
│  安全配置                                                        │
│  ├── kSecAttrAccessible: afterFirstUnlock                      │
│  ├── kSecAttrSynchronizable: false (不同步 iCloud)             │
│  └── kSecAttrService: "com.readmigo.app"                       │
│                                                                  │
│  KeychainAccess 封装                                            │
│  ├── keychain["access_token"]                                  │
│  ├── keychain["refresh_token"]                                 │
│  └── keychain.remove("access_token")                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 自动刷新

### 5.1 刷新时机

| 时机 | 说明 |
|------|------|
| Token 即将过期 | 剩余 5 分钟时刷新 |
| API 返回 401 | 自动刷新重试 |
| App 启动时 | 检查并刷新 |

### 5.2 刷新流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Token 刷新流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  API 请求                                                        │
│       │                                                          │
│       ▼                                                          │
│  检查 Access Token                                              │
│       │                                                          │
│       ├── 有效 ──────────────────▶ 发送请求                    │
│       │                                                          │
│       └── 过期/即将过期                                         │
│            │                                                     │
│            ▼                                                     │
│       使用 Refresh Token 刷新                                   │
│            │                                                     │
│            ├── 成功                                              │
│            │   ├── 更新 Access Token                            │
│            │   └── 重试原请求                                    │
│            │                                                     │
│            └── 失败 (Refresh Token 过期)                        │
│                │                                                 │
│                ▼                                                 │
│           清除 Token                                             │
│                │                                                 │
│                ▼                                                 │
│           跳转登录页                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 会话管理

### 6.1 会话状态

| 状态 | 说明 |
|------|------|
| 未登录 | 无有效 Token |
| 已登录 | 有有效 Token |
| 过期 | Token 过期 |

### 6.2 多设备登录

```
┌─────────────────────────────────────────────────────────────────┐
│                    多设备管理                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  设备列表                                                        │
│  ├── iPhone 15 Pro (当前设备)                                   │
│  │   └── 最后活动: 刚刚                                         │
│  │                                                              │
│  ├── iPad Pro                                                   │
│  │   └── 最后活动: 2 小时前                                     │
│  │                                                              │
│  └── MacBook Pro                                                │
│      └── 最后活动: 1 天前                                       │
│                                                                  │
│  操作                                                            │
│  ├── 退出其他设备                                                │
│  └── 退出单个设备                                                │
│                                                                  │
│  安全设置                                                        │
│  ├── ☑ 新设备登录时通知                                         │
│  └── ☑ 异常登录时强制验证                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 登出处理

### 7.1 登出流程

| 步骤 | 说明 |
|------|------|
| 调用登出 API | 通知服务器 |
| 清除 Keychain | 删除 Token |
| 清除缓存 | 清除用户数据 |
| 重置状态 | 重置 App 状态 |
| 跳转登录页 | 返回登录界面 |

### 7.2 数据清理

```
┌─────────────────────────────────────────────────────────────────┐
│                    登出数据清理                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  必须清理                                                        │
│  ├── Access Token                                               │
│  ├── Refresh Token                                              │
│  ├── 用户信息缓存                                                │
│  └── 会话状态                                                    │
│                                                                  │
│  可选清理                                                        │
│  ├── 离线数据                                                    │
│  │   └── 提示用户是否保留                                        │
│  │                                                              │
│  ├── 阅读进度                                                    │
│  │   └── 已同步的可保留                                          │
│  │                                                              │
│  └── 下载的书籍                                                  │
│      └── 提示用户是否删除                                        │
│                                                                  │
│  保留项                                                          │
│  ├── App 设置                                                   │
│  └── 阅读偏好                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 安全措施

### 8.1 安全策略

| 措施 | 说明 |
|------|------|
| HTTPS | 所有请求加密 |
| Keychain | 安全存储 Token |
| Certificate Pinning | 防止中间人攻击 |
| 设备绑定 | 设备指纹验证 |

### 8.2 密码安全

```
┌─────────────────────────────────────────────────────────────────┐
│                    密码安全策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  密码要求                                                        │
│  ├── 最少 8 位                                                  │
│  ├── 包含大小写字母                                              │
│  ├── 包含数字                                                    │
│  └── 可选特殊字符                                                │
│                                                                  │
│  密码强度检测                                                    │
│  ├── 弱: 仅数字或字母                                           │
│  ├── 中: 字母 + 数字                                            │
│  ├── 强: 大小写 + 数字                                          │
│  └── 很强: 大小写 + 数字 + 特殊字符                             │
│                                                                  │
│  防暴力破解                                                      │
│  ├── 连续 5 次错误锁定 5 分钟                                   │
│  ├── 连续 10 次错误锁定 1 小时                                  │
│  └── 发送安全警告邮件                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 生物识别

### 9.1 支持类型

| 类型 | 说明 |
|------|------|
| Face ID | 面容识别 |
| Touch ID | 指纹识别 |

### 9.2 生物识别流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    生物识别登录                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  启用流程                                                        │
│  ├── 首次登录成功后                                              │
│  ├── 提示启用生物识别                                            │
│  ├── 验证生物识别                                                │
│  └── 关联 Token 到生物识别                                      │
│                                                                  │
│  使用流程                                                        │
│  ├── App 启动                                                   │
│  ├── 检查是否启用                                                │
│  ├── 弹出生物识别验证                                            │
│  │   ├── 成功 ──▶ 读取 Token ──▶ 进入 App                     │
│  │   └── 失败 ──▶ 显示登录界面                                  │
│  └── 提供密码登录备选                                            │
│                                                                  │
│  LAContext 使用                                                  │
│  ├── canEvaluatePolicy                                         │
│  └── evaluatePolicy                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 错误处理

### 10.1 认证错误

| 错误 | 处理 |
|------|------|
| 密码错误 | 提示错误次数 |
| 账号不存在 | 引导注册 |
| 账号被锁定 | 显示解锁时间 |
| 网络错误 | 提示重试 |
| Token 过期 | 跳转登录 |

### 10.2 错误提示

| 错误码 | 提示信息 |
|--------|----------|
| AUTH_001 | 邮箱或密码错误 |
| AUTH_002 | 账号已被锁定 |
| AUTH_003 | 验证码错误 |
| AUTH_004 | 登录已过期 |

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [../login-design.md](../login-design.md) | 登录设计 |
| [../architecture.md](../architecture.md) | 架构设计 |
| [settings.md](./settings.md) | 设置功能 |

---

*最后更新: 2025-12-31*

# iOS 阅读器功能

> EPUB + PDF + 多种阅读模式

---

## 1. 功能概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器功能架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    格式支持                              │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │   EPUB    │  │    PDF    │  │    TXT    │           │    │
│  │  │  主要格式  │  │  PDF 渲染 │  │  纯文本   │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    核心功能                              │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  分页渲染  │  │  主题设置  │  │  进度同步  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  目录导航  │  │  划词操作  │  │  书签笔记  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    增强功能                              │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  AI 查词  │  │    TTS    │  │  智能翻页  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 格式支持

### 2.1 支持的格式

| 格式 | 引擎 | 功能完整度 |
|------|------|------------|
| EPUB 2.0 | 自研引擎 | 完整 |
| EPUB 3.0 | 自研引擎 | 完整 |
| PDF | PDFKit | 完整 |
| TXT | 原生渲染 | 基础 |

### 2.2 EPUB 解析

```
┌─────────────────────────────────────────────────────────────────┐
│                    EPUB 解析流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  EPUB 文件                                                       │
│       │                                                          │
│       ▼                                                          │
│  解压缩 (ZIP)                                                    │
│       │                                                          │
│       ▼                                                          │
│  解析 META-INF/container.xml                                    │
│       │                                                          │
│       ▼                                                          │
│  解析 OPF (Open Packaging Format)                               │
│  ├── metadata    书籍元数据                                     │
│  ├── manifest    资源清单                                       │
│  └── spine       阅读顺序                                       │
│       │                                                          │
│       ▼                                                          │
│  解析 NCX/Nav    目录结构                                        │
│       │                                                          │
│       ▼                                                          │
│  解析 XHTML 章节内容                                             │
│       │                                                          │
│       ▼                                                          │
│  渲染引擎                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 渲染引擎

### 3.1 渲染方式

| 渲染方式 | 说明 | 适用场景 |
|----------|------|----------|
| WebKit | WKWebView 渲染 | 复杂排版 |
| AttributedString | 原生文本渲染 | 简单排版 |
| PDFKit | PDF 原生渲染 | PDF 文件 |

### 3.2 分页算法

```
┌─────────────────────────────────────────────────────────────────┐
│                    分页计算                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  分页参数                                                        │
│  ├── 可视区域大小                                                │
│  ├── 字体大小                                                    │
│  ├── 行间距                                                      │
│  ├── 边距设置                                                    │
│  └── 屏幕方向                                                    │
│                                                                  │
│  分页策略                                                        │
│  ├── 预分页: 打开书籍时计算所有页面                             │
│  ├── 懒分页: 按章节分页                                         │
│  └── 动态分页: 滑动时实时计算                                    │
│                                                                  │
│  缓存策略                                                        │
│  ├── 当前页 + 前后各 1 页                                       │
│  ├── 章节级缓存                                                  │
│  └── 配置变更时清除缓存                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 翻页交互

### 4.1 翻页方式

| 方式 | 手势 | 动画 |
|------|------|------|
| 滑动翻页 | 左右滑动 | 滑动跟手 |
| 点击翻页 | 左右区域点击 | 淡入淡出 |
| 仿真翻页 | 拖动页角 | 翻书效果 |
| 上下滚动 | 上下滑动 | 连续滚动 |

### 4.2 翻页区域

```
┌─────────────────────────────────────────────────────────────────┐
│                    点击区域划分                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────┐      │
│  │                                                        │      │
│  │    ┌──────┐    ┌─────────────────┐    ┌──────┐       │      │
│  │    │      │    │                 │    │      │       │      │
│  │    │ 上页  │    │    菜单区域     │    │ 下页  │       │      │
│  │    │      │    │   (显示工具栏)   │    │      │       │      │
│  │    │ 25%  │    │      50%        │    │ 25%  │       │      │
│  │    │      │    │                 │    │      │       │      │
│  │    │      │    │                 │    │      │       │      │
│  │    │      │    │                 │    │      │       │      │
│  │    └──────┘    └─────────────────┘    └──────┘       │      │
│  │                                                        │      │
│  └───────────────────────────────────────────────────────┘      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 阅读设置

### 5.1 显示设置

| 设置 | 范围 | 默认值 |
|------|------|--------|
| 字号 | 12-32pt | 18pt |
| 行间距 | 1.2-2.0x | 1.5x |
| 边距 | 小/中/大 | 中 |
| 字体 | 系统/自定义 | 系统 |
| 主题 | 6 种 | 纸白 |
| 亮度 | 0-100% | 系统 |

### 5.2 阅读主题

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读主题                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  纸白 (Paper White)                                             │
│  ├── 背景: #FFFFFF                                              │
│  ├── 文本: #1F2937                                              │
│  └── 适合: 日间阅读                                              │
│                                                                  │
│  暖黄 (Sepia)                                                   │
│  ├── 背景: #F5F0E1                                              │
│  ├── 文本: #5C4B37                                              │
│  └── 适合: 护眼阅读                                              │
│                                                                  │
│  浅灰 (Light Gray)                                              │
│  ├── 背景: #E5E7EB                                              │
│  ├── 文本: #374151                                              │
│  └── 适合: 减少对比                                              │
│                                                                  │
│  深灰 (Dark Gray)                                               │
│  ├── 背景: #374151                                              │
│  ├── 文本: #E5E7EB                                              │
│  └── 适合: 暗光环境                                              │
│                                                                  │
│  纯黑 (OLED Black)                                              │
│  ├── 背景: #000000                                              │
│  ├── 文本: #E5E7EB                                              │
│  └── 适合: OLED 省电                                            │
│                                                                  │
│  绿色 (Eye Care)                                                │
│  ├── 背景: #CCE8CF                                              │
│  ├── 文本: #2D5A3D                                              │
│  └── 适合: 长时间阅读                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 划词功能

### 6.1 划词操作

| 操作 | 功能 |
|------|------|
| 单词选中 | 双击选词 |
| 句子选中 | 三击选句 |
| 自由选择 | 长按拖选 |

### 6.2 划词菜单

```
┌─────────────────────────────────────────────────────────────────┐
│                    划词菜单                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  查词  │  翻译  │  高亮  │  笔记  │  复制  │  朗读  │  更多 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  查词                                                            │
│  └── 调用 AI 查词，显示释义和例句                               │
│                                                                  │
│  翻译                                                            │
│  └── 调用 AI 翻译选中内容                                        │
│                                                                  │
│  高亮                                                            │
│  └── 添加高亮标记，支持多种颜色                                  │
│                                                                  │
│  笔记                                                            │
│  └── 添加文字笔记                                                │
│                                                                  │
│  复制                                                            │
│  └── 复制到剪贴板                                                │
│                                                                  │
│  朗读                                                            │
│  └── TTS 朗读选中内容                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 目录与导航

### 7.1 目录功能

| 功能 | 说明 |
|------|------|
| 章节目录 | 显示书籍目录结构 |
| 书签列表 | 显示所有书签 |
| 笔记列表 | 显示所有笔记 |
| 高亮列表 | 显示所有高亮 |

### 7.2 导航方式

```
┌─────────────────────────────────────────────────────────────────┐
│                    导航方式                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  目录导航                                                        │
│  └── 点击目录项跳转到对应章节                                    │
│                                                                  │
│  进度条导航                                                      │
│  └── 拖动进度条快速定位                                          │
│                                                                  │
│  页码跳转                                                        │
│  └── 输入页码直接跳转                                            │
│                                                                  │
│  搜索跳转                                                        │
│  └── 搜索内容后跳转到结果位置                                    │
│                                                                  │
│  书签跳转                                                        │
│  └── 点击书签跳转到书签位置                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 书签与笔记

### 8.1 书签功能

| 操作 | 说明 |
|------|------|
| 添加书签 | 点击右上角书签图标 |
| 删除书签 | 左滑删除 |
| 同步书签 | 自动云端同步 |

### 8.2 笔记功能

```
┌─────────────────────────────────────────────────────────────────┐
│                    笔记功能                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  笔记类型                                                        │
│  ├── 高亮笔记    选中文本 + 颜色标记                            │
│  ├── 文字笔记    选中文本 + 文字备注                            │
│  └── 想法笔记    任意位置的想法记录                             │
│                                                                  │
│  高亮颜色                                                        │
│  ├── 黄色 #FEF08A                                               │
│  ├── 绿色 #BBF7D0                                               │
│  ├── 蓝色 #BFDBFE                                               │
│  ├── 粉色 #FBCFE8                                               │
│  └── 紫色 #DDD6FE                                               │
│                                                                  │
│  笔记导出                                                        │
│  ├── 导出为 Markdown                                            │
│  ├── 导出为 PDF                                                 │
│  └── 分享到其他应用                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 阅读进度

### 9.1 进度记录

| 记录项 | 说明 |
|--------|------|
| 当前位置 | CFI 或百分比 |
| 阅读时长 | 累计阅读时间 |
| 今日阅读 | 今日阅读量 |
| 阅读速度 | 字/分钟 |

### 9.2 进度同步

```
┌─────────────────────────────────────────────────────────────────┐
│                    进度同步                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  同步策略                                                        │
│  ├── 实时同步    翻页时触发同步                                 │
│  ├── 定时同步    每 30 秒同步一次                               │
│  └── 退出同步    关闭阅读器时同步                               │
│                                                                  │
│  冲突处理                                                        │
│  ├── 本地优先    使用本地最新进度                               │
│  ├── 云端优先    使用云端最新进度                               │
│  └── 用户选择    弹窗让用户选择                                 │
│                                                                  │
│  离线支持                                                        │
│  ├── 本地存储    离线时保存到本地                               │
│  └── 在线同步    恢复网络后同步                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 性能优化

### 10.1 性能指标

| 指标 | 目标值 |
|------|--------|
| 书籍打开时间 | < 1s |
| 翻页响应 | < 100ms |
| 章节加载 | < 500ms |
| 内存占用 | < 100MB |

### 10.2 优化策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能优化                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  渲染优化                                                        │
│  ├── 预渲染前后页                                                │
│  ├── WebView 复用                                               │
│  ├── 分页结果缓存                                                │
│  └── 图片懒加载                                                  │
│                                                                  │
│  内存优化                                                        │
│  ├── 只保留可视页 + 前后 1 页                                   │
│  ├── 大图片降采样                                                │
│  ├── 及时释放章节缓存                                            │
│  └── 监听内存警告                                                │
│                                                                  │
│  加载优化                                                        │
│  ├── 章节懒加载                                                  │
│  ├── 后台预解析                                                  │
│  ├── 增量渲染                                                    │
│  └── 骨架屏占位                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [../reader-engine.md](../reader-engine.md) | 阅读器引擎 |
| [../advanced-reader-design.md](../advanced-reader-design.md) | 高级阅读器设计 |
| [ai.md](./ai.md) | AI 功能 |

---

*最后更新: 2025-12-31*

# iOS 订阅系统技术实现

## 系统概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅系统全链路架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                 │
│  │   iOS App   │◄────►│   Backend   │◄────►│  Dashboard  │                 │
│  │  StoreKit 2 │      │   NestJS    │      │ React Admin │                 │
│  └──────┬──────┘      └──────┬──────┘      └─────────────┘                 │
│         │                    │                                              │
│         ▼                    ▼                                              │
│  ┌─────────────┐      ┌─────────────┐                                      │
│  │ App Store   │─────►│ App Store   │                                      │
│  │  Connect    │      │ Server API  │                                      │
│  └─────────────┘      └─────────────┘                                      │
│                              │                                              │
│                              ▼                                              │
│                       ┌─────────────┐                                      │
│                       │  Webhooks   │                                      │
│                       │ Notifications│                                      │
│                       └─────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 订阅产品定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅产品配置                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Product ID                        Plan      Period    Trial               │
│  ─────────────────────────────────────────────────────────────────         │
│  com.readmigo.pro.monthly          PRO       Monthly   -                   │
│  com.readmigo.pro.yearly           PRO       Yearly    7 days              │
│  com.readmigo.premium.monthly      PREMIUM   Monthly   -                   │
│  com.readmigo.premium.yearly       PREMIUM   Yearly    7 days              │
│                                                                             │
│  订阅层级:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  FREE        免费用户 (默认)                                                │
│  PRO         专业版订阅                                                     │
│  PREMIUM     高级版订阅                                                     │
│                                                                             │
│  订阅状态:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  ACTIVE          有效订阅中                                                 │
│  EXPIRED         已过期                                                     │
│  CANCELLED       已取消 (到期前仍可用)                                       │
│  GRACE_PERIOD    宽限期 (续费失败，等待重试)                                 │
│  TRIAL           试用期                                                     │
│  TRIAL_EXPIRED   试用已过期                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 功能权限矩阵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         功能权限配置                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  功能                    FREE          PRO           PREMIUM                │
│  ─────────────────────────────────────────────────────────────────         │
│  AI 单词解释             5次/天        100次/天       无限制                 │
│  AI 文章总结             禁用          50次/天        无限制                 │
│  高级AI (GPT-4/Claude)   禁用          禁用           开放                  │
│  语音对话                禁用          30分钟/月       无限制                │
│  视频对话                禁用          禁用           开放                  │
│  词汇保存数量            50个          1000个         无限制                │
│  间隔重复学习            禁用          开放           开放                  │
│  离线书籍下载            0本           10本           无限制                │
│  阅读统计                禁用          开放           开放                  │
│  词汇导出                禁用          开放           开放                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第一部分: iOS 客户端实现

## 技术方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         StoreKit 2 架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  采用 StoreKit 2 (iOS 15+) 现代异步 API                                     │
│                                                                             │
│  核心类:                                                                     │
│  ─────────────────────────────────────────────────────────────────         │
│  Product              StoreKit 产品表示                                     │
│  Transaction          交易记录 (自动验证)                                   │
│  AppStore             应用商店操作 (sync)                                   │
│  VerificationResult   交易验证结果                                          │
│                                                                             │
│  优势:                                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  • async/await 原生支持                                                     │
│  • 自动 JWS 签名验证                                                        │
│  • Transaction.updates 实时监听                                             │
│  • currentEntitlements 权益查询                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心组件

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         客户端组件架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                    SubscriptionManager                          │        │
│  │                    (单例, ObservableObject)                      │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  Published Properties:                                          │        │
│  │  • products: [Product]           可购买产品列表                  │        │
│  │  • purchasedProductIds: Set      已购买产品 ID                   │        │
│  │  • subscriptionState: State      当前订阅状态                    │        │
│  │  • isSubscribed: Bool            是否已订阅                      │        │
│  │  • currentTier: Tier             当前层级                        │        │
│  │  • isLoading: Bool               加载状态                        │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │  Methods:                                                       │        │
│  │  • loadProducts()                加载产品列表                    │        │
│  │  • purchase(product)             执行购买                        │        │
│  │  • restorePurchases()            恢复购买                        │        │
│  │  • refreshSubscriptionStatus()   刷新订阅状态                    │        │
│  │  • listenForTransactions()       监听交易更新                    │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                              │                                              │
│          ┌───────────────────┼───────────────────┐                          │
│          ▼                   ▼                   ▼                          │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐                 │
│  │FeatureGate   │   │ UsageTracker  │   │  APIClient    │                 │
│  │Service       │   │               │   │               │                 │
│  │功能门禁检查    │   │ 用量追踪      │   │ 后端通信      │                 │
│  └───────────────┘   └───────────────┘   └───────────────┘                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 购买流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         购买流程时序                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户        PaywallView    SubscriptionManager    StoreKit    Backend      │
│   │              │                 │                  │           │         │
│   │──选择产品───►│                 │                  │           │         │
│   │              │──purchase()────►│                  │           │         │
│   │              │                 │──product.purchase()─────────►│         │
│   │              │                 │                  │           │         │
│   │              │                 │◄─PurchaseResult──│           │         │
│   │              │                 │                  │           │         │
│   │              │                 │  [.success]                  │         │
│   │              │                 │──checkVerified()─►           │         │
│   │              │                 │                  │           │         │
│   │              │                 │──verifyWithBackend()────────►│         │
│   │              │                 │                              │         │
│   │              │                 │◄────VerifyReceiptResponse────│         │
│   │              │                 │                  │           │         │
│   │              │                 │──transaction.finish()───────►│         │
│   │              │                 │                  │           │         │
│   │              │◄──更新状态──────│                  │           │         │
│   │◄─显示成功────│                 │                  │           │         │
│                                                                             │
│  PurchaseResult 处理:                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  .success(verification)    验证交易 → 后端验证 → 完成交易                   │
│  .pending                  交易待审批 (家长控制等)                           │
│  .userCancelled            用户取消，不做处理                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 交易监听

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Transaction Listener                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  App 启动时调用 listenForTransactions()                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Task.detached {                                                │        │
│  │      for await result in Transaction.updates {                  │        │
│  │          switch result {                                        │        │
│  │          case .verified(let transaction):                       │        │
│  │              // 1. 更新已购买产品集合                             │        │
│  │              // 2. 向后端验证                                     │        │
│  │              // 3. 完成交易                                       │        │
│  │          case .unverified(_, let error):                        │        │
│  │              // 记录验证失败                                      │        │
│  │          }                                                      │        │
│  │      }                                                          │        │
│  │  }                                                              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  监听场景:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • App 后台续费成功                                                         │
│  • 外部购买 (App Store 直接购买)                                            │
│  • 促销代码兑换                                                              │
│  • 订阅升级/降级                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 恢复购买

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         恢复购买流程                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  func restorePurchases() async {                                │        │
│  │      // 1. 同步 App Store 状态                                   │        │
│  │      try await AppStore.sync()                                  │        │
│  │                                                                 │        │
│  │      // 2. 遍历当前权益                                          │        │
│  │      for await result in Transaction.currentEntitlements {      │        │
│  │          if case .verified(let transaction) = result {          │        │
│  │              purchasedProductIds.insert(transaction.productID)  │        │
│  │              await verifyWithBackend(transaction)               │        │
│  │          }                                                      │        │
│  │      }                                                          │        │
│  │                                                                 │        │
│  │      // 3. 调用后端恢复接口                                       │        │
│  │      let response = try await APIClient.request(                │        │
│  │          endpoint: .subscriptionsRestore,                       │        │
│  │          method: .post                                          │        │
│  │      )                                                          │        │
│  │      subscriptionState = response.subscription                  │        │
│  │  }                                                              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  使用场景:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • 用户重新安装 App                                                         │
│  • 用户更换设备                                                              │
│  • 订阅状态不同步                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 收据验证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         双重验证机制                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  第一层: StoreKit 本地验证                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  VerificationResult<Transaction>                                            │
│  • .verified(transaction)      交易有效 (JWS 签名验证通过)                   │
│  • .unverified(transaction, error)  签名验证失败                            │
│                                                                             │
│  第二层: 后端验证                                                            │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  private func verifyWithBackend(transaction) async {            │        │
│  │      // 获取 App Store Receipt                                   │        │
│  │      guard let receiptURL = Bundle.main.appStoreReceiptURL,     │        │
│  │            let receiptData = try? Data(contentsOf: receiptURL)  │        │
│  │      else { return }                                            │        │
│  │                                                                 │        │
│  │      let request = VerifyReceiptRequest(                        │        │
│  │          receiptData: receiptData.base64EncodedString(),        │        │
│  │          productId: transaction.productID,                      │        │
│  │          transactionId: String(transaction.id)                  │        │
│  │      )                                                          │        │
│  │                                                                 │        │
│  │      let response = try await APIClient.request(                │        │
│  │          endpoint: .subscriptionsVerify,                        │        │
│  │          method: .post,                                         │        │
│  │          body: request                                          │        │
│  │      )                                                          │        │
│  │  }                                                              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## UI 视图组件

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅相关视图                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PaywallView (付费墙)                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  ┌─────────────────────────────────────────────────────────┐    │        │
│  │  │           🎉 解锁 Readmigo Pro                          │    │        │
│  │  └─────────────────────────────────────────────────────────┘    │        │
│  │                                                                 │        │
│  │  ┌───────────────┐  ┌───────────────┐                          │        │
│  │  │    月度       │  │    年度 ✓     │  ← 周期选择器             │        │
│  │  │   ¥18/月     │  │   ¥128/年    │                          │        │
│  │  └───────────────┘  └───────────────┘                          │        │
│  │                                                                 │        │
│  │  ┌─────────────────────────────────────────────────────────┐    │        │
│  │  │  ✓ 无限 AI 对话                                         │    │        │
│  │  │  ✓ 离线阅读                                             │    │        │
│  │  │  ✓ 高级学习功能                                         │    │        │
│  │  └─────────────────────────────────────────────────────────┘    │        │
│  │                                                                 │        │
│  │  ┌─────────────────────────────────────────────────────────┐    │        │
│  │  │              🚀 开始 7 天免费试用                        │    │        │
│  │  └─────────────────────────────────────────────────────────┘    │        │
│  │                                                                 │        │
│  │  恢复购买 | 隐私政策 | 服务条款                                  │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  SubscriptionStatusView (订阅状态)                                          │
│  ─────────────────────────────────────────────────────────────────         │
│  • 当前计划卡片 (层级、状态)                                                 │
│  • 订阅详情 (到期日、续费状态、交易 ID)                                      │
│  • 免费用户用量进度条                                                        │
│  • 锁定功能列表                                                              │
│  • 管理订阅按钮                                                              │
│                                                                             │
│  RestorePurchasesView (恢复购买)                                            │
│  ─────────────────────────────────────────────────────────────────         │
│  • 状态动画 (idle, restoring, success, error, noSubscriptions)              │
│  • 恢复指南说明                                                              │
│  • 联系支持入口                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 功能门禁

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FeatureGateService                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  功能访问检查:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  func checkAccess(feature: Feature) -> FeatureAccessResult {    │        │
│  │      let tier = SubscriptionManager.shared.currentTier          │        │
│  │      let usage = UsageTracker.shared.currentUsage               │        │
│  │                                                                 │        │
│  │      // 检查功能是否在当前层级开放                                │        │
│  │      guard feature.availableIn.contains(tier) else {            │        │
│  │          return .restricted(reason: .tierRequired)              │        │
│  │      }                                                          │        │
│  │                                                                 │        │
│  │      // 检查用量限制                                             │        │
│  │      if let limit = feature.limits[tier],                       │        │
│  │         usage[feature] >= limit {                               │        │
│  │          return .restricted(reason: .limitReached)              │        │
│  │      }                                                          │        │
│  │                                                                 │        │
│  │      return .allowed                                            │        │
│  │  }                                                              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  FeatureAccessResult:                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  .allowed                     功能可用                                      │
│  .restricted(.tierRequired)   需要升级订阅                                  │
│  .restricted(.limitReached)   已达每日/每月限制                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 用量追踪

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         UsageTracker                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  追踪指标:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  aiCallsToday          AI 调用次数/天                                       │
│  vocabularyCount       词汇保存总数                                          │
│  offlineDownloads      离线下载数量                                          │
│  voiceChatMinutes      语音对话分钟数/月                                     │
│  booksRead             已读书籍数                                            │
│                                                                             │
│  同步机制:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • 本地 UserDefaults 缓存                                                   │
│  • 定期与后端同步: GET /usage/current                                       │
│  • 使用记录上报: POST /usage/ai, POST /usage/voice-chat                     │
│  • 每日/每月自动重置                                                        │
│                                                                             │
│  重置逻辑:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  日重置指标: aiCallsToday                                                   │
│  月重置指标: voiceChatMinutes                                               │
│  累计指标: vocabularyCount, offlineDownloads, booksRead                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第二部分: Apple 后台服务接入

## App Store Server API

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         收据验证 API                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  验证端点:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  Production:  https://buy.itunes.apple.com/verifyReceipt                   │
│  Sandbox:     https://sandbox.itunes.apple.com/verifyReceipt               │
│                                                                             │
│  请求格式:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    "receipt-data": "<base64 encoded receipt>",                             │
│    "password": "<app shared secret>",                                      │
│    "exclude-old-transactions": true                                        │
│  }                                                                          │
│                                                                             │
│  状态码处理:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  0       收据有效                                                           │
│  21007   沙盒收据发送到生产环境 → 自动重试沙盒端点                           │
│  21008   生产收据发送到沙盒环境 → 自动重试生产端点                           │
│  其他    验证失败                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## App Store Server Notifications V2

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Webhook 通知处理                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Webhook 端点: POST /webhooks/apple                                         │
│                                                                             │
│  通知类型及处理:                                                             │
│  ─────────────────────────────────────────────────────────────────         │
│  通知类型                处理方法                    操作                   │
│  ─────────────────────────────────────────────────────────────────         │
│  SUBSCRIBED             handleSubscribed()         创建/更新订阅为 ACTIVE   │
│  DID_RENEW              handleRenewal()            更新到期日，保持 ACTIVE  │
│  DID_FAIL_TO_RENEW      handleRenewalFailure()     设置 GRACE_PERIOD       │
│  DID_CHANGE_RENEWAL_STATUS  handleRenewalStatusChange()  处理自动续订开关  │
│  EXPIRED                handleExpired()            标记为 EXPIRED          │
│  GRACE_PERIOD_EXPIRED   handleGracePeriodExpired() 终止订阅                 │
│  REFUND                 handleRefund()             立即撤销权限             │
│  REVOKE                 handleRevoke()             同 REFUND                │
│  TEST                   返回成功                    Webhook 测试            │
│                                                                             │
│  响应规范:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • 始终返回 HTTP 200 (防止 Apple 重试)                                      │
│  • 即使处理失败也返回 200                                                    │
│  • 内部记录错误日志                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## JWS 载荷解码

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         通知数据结构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  AppleNotificationPayload:                                                  │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    notificationType: string;      // SUBSCRIBED, DID_RENEW, etc.           │
│    subtype?: string;              // INITIAL_BUY, RESUBSCRIBE, etc.        │
│    data: {                                                                 │
│      signedTransactionInfo: string;  // JWS 编码的交易信息                 │
│      signedRenewalInfo: string;      // JWS 编码的续订信息                 │
│    }                                                                       │
│  }                                                                          │
│                                                                             │
│  AppleTransactionInfo (解码后):                                             │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    transactionId: string;                                                  │
│    originalTransactionId: string;    // 订阅链的永久标识                   │
│    productId: string;                // com.readmigo.pro.yearly            │
│    purchaseDate: number;             // 毫秒时间戳                          │
│    expiresDate: number;              // 到期时间                            │
│    environment: 'Sandbox' | 'Production';                                  │
│    revocationDate?: number;          // 退款时间                            │
│    revocationReason?: number;        // 退款原因                            │
│  }                                                                          │
│                                                                             │
│  AppleRenewalInfo (解码后):                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    autoRenewProductId: string;       // 续订产品                            │
│    autoRenewStatus: number;          // 0=关闭, 1=开启                     │
│    expirationIntent?: number;        // 过期原因                            │
│    gracePeriodExpiresDate?: number;  // 宽限期到期                          │
│    isInBillingRetryPeriod?: boolean; // 是否在扣费重试期                   │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第三部分: 后端服务实现

## API 端点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅 API 端点                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户端点 (需要 JWT 认证):                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  GET  /subscriptions/status           获取当前订阅状态                      │
│  POST /subscriptions/verify           验证 App Store 收据                   │
│  POST /subscriptions/restore          恢复购买                              │
│  GET  /subscriptions/trial/eligibility  检查试用资格                        │
│  GET  /subscriptions/trial/status     获取试用状态                          │
│  POST /subscriptions/trial/start      开始试用                              │
│                                                                             │
│  Webhook 端点 (无认证):                                                      │
│  ─────────────────────────────────────────────────────────────────         │
│  POST /webhooks/apple                 Apple 服务器通知                      │
│  POST /webhooks/apple/test            Webhook 测试端点                      │
│                                                                             │
│  管理端点 (需要 Admin 权限):                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  GET  /admin/subscriptions            订阅列表                              │
│  GET  /admin/subscriptions/:userId    用户订阅详情                          │
│  POST /admin/subscriptions/:userId/extend    延长订阅                       │
│  POST /admin/subscriptions/:userId/grant     赠送订阅                       │
│  POST /admin/subscriptions/:userId/revoke    撤销订阅                       │
│  POST /admin/subscriptions/:userId/change-tier  变更层级                    │
│  GET  /admin/subscriptions/stats/overview   订阅统计                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅数据模型                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Subscription 表:                                                           │
│  ─────────────────────────────────────────────────────────────────         │
│  字段                    类型           说明                                │
│  ─────────────────────────────────────────────────────────────────         │
│  id                     UUID           主键                                 │
│  userId                 UUID           关联用户 (1:1)                       │
│  planType               ENUM           FREE, PRO, PREMIUM                  │
│  status                 ENUM           ACTIVE, EXPIRED, CANCELLED, etc.    │
│  source                 ENUM           APPLE_IAP, GOOGLE_PLAY, PROMO_CODE  │
│  originalTransactionId  String?        Apple 永久交易 ID                   │
│  latestReceiptData      Text?          最新收据数据                         │
│  expiresAt              DateTime?      到期时间                             │
│  cancelledAt            DateTime?      取消时间                             │
│  trialStartedAt         DateTime?      试用开始时间                         │
│  trialEndsAt            DateTime?      试用结束时间                         │
│  createdAt              DateTime       创建时间                             │
│  updatedAt              DateTime       更新时间                             │
│                                                                             │
│  索引:                                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  • userId (唯一)                                                             │
│  • originalTransactionId (唯一，可为空)                                     │
│  • status + expiresAt (复合索引，用于过期检查)                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 收据验证服务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SubscriptionService                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  verifyReceipt(userId, receiptData):                                        │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 调用 Apple verifyReceipt API                                            │
│  2. 处理 status 21007 (沙盒/生产环境切换)                                   │
│  3. 解析 latest_receipt_info                                                │
│  4. 提取: productId, originalTransactionId, expiresDate                    │
│  5. 映射 productId → planType                                               │
│  6. 创建或更新 Subscription 记录                                            │
│  7. 创建 Order 和 Transaction 记录                                          │
│  8. 返回订阅状态                                                             │
│                                                                             │
│  refreshStatus(userId):                                                     │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 获取用户订阅记录                                                         │
│  2. 检查 expiresAt 是否已过期                                               │
│  3. 自动更新状态为 EXPIRED (如果需要)                                       │
│  4. 返回当前状态                                                             │
│                                                                             │
│  restorePurchases(userId):                                                  │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 查找用户所有有效订阅记录                                                 │
│  2. 验证 latestReceiptData (如果有)                                         │
│  3. 返回恢复的订阅信息                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 试用管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TrialService                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  配置:                                                                       │
│  ─────────────────────────────────────────────────────────────────         │
│  TRIAL_DURATION         7 天                                                │
│  TRIAL_PLAN            PRO                                                  │
│  ELIGIBLE_PRODUCTS     com.readmigo.pro.yearly                             │
│                                                                             │
│  checkEligibility(userId):                                                  │
│  ─────────────────────────────────────────────────────────────────         │
│  规则:                                                                       │
│  • 无订阅记录 → 可试用                                                       │
│  • 已使用过试用 → 不可试用                                                   │
│  • 有活跃付费订阅 → 不可试用                                                 │
│  • 曾经付费过 (非 FREE) → 不可试用                                          │
│                                                                             │
│  startTrial(userId):                                                        │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 验证资格                                                                 │
│  2. 创建订阅记录: planType=PRO, status=TRIAL                                │
│  3. 设置 trialStartedAt, trialEndsAt                                       │
│  4. 返回试用状态                                                             │
│                                                                             │
│  expireTrials() [定时任务]:                                                  │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 查询 status=TRIAL 且 trialEndsAt < now                                 │
│  2. 批量更新: status=TRIAL_EXPIRED, planType=FREE                          │
│  3. 记录日志                                                                 │
│                                                                             │
│  convertTrial(userId, transaction):                                         │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 更新 status: TRIAL → ACTIVE                                             │
│  2. 更新 source: NONE → APPLE_IAP                                           │
│  3. 设置 originalTransactionId, expiresAt                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 订阅守卫

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SubscriptionGuard                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  使用方式:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  @RequiredSubscription([PlanType.PRO, PlanType.PREMIUM])                   │
│  @UseGuards(SubscriptionGuard)                                              │
│  async protectedEndpoint() { ... }                                          │
│                                                                             │
│  验证逻辑:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 从 JWT 获取 userId                                                      │
│  2. 查询用户订阅状态                                                         │
│  3. 检查 planType 是否在允许列表                                            │
│  4. 检查 status 是否为活跃状态 (ACTIVE, TRIAL, GRACE_PERIOD)               │
│  5. 检查 expiresAt 是否未过期                                               │
│  6. 自动过期处理 (更新数据库)                                               │
│                                                                             │
│  活跃状态列表:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  ACTIVE          正常订阅                                                   │
│  TRIAL           试用期                                                     │
│  GRACE_PERIOD    宽限期                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第四部分: 订单管理系统

## 订单数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订单数据结构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Order 表:                                                                  │
│  ─────────────────────────────────────────────────────────────────         │
│  字段                      类型           说明                              │
│  ─────────────────────────────────────────────────────────────────         │
│  id                       UUID           主键                               │
│  orderNumber              String         订单号 ORD-YYYYMMDD-XXXX          │
│  userId                   UUID           用户 ID                            │
│  productId                String         产品 ID                            │
│  productName              String         产品名称                           │
│  planType                 ENUM           订阅层级                           │
│  amount                   Decimal        金额                               │
│  currency                 String         货币 (默认 USD)                    │
│  status                   ENUM           订单状态                           │
│  source                   ENUM           来源                               │
│  appleOriginalTransactionId  String?     Apple 原始交易 ID                 │
│  appleTransactionId       String?        Apple 交易 ID                     │
│  appleEnvironment         ENUM?          SANDBOX / PRODUCTION              │
│  startedAt                DateTime?      订阅开始时间                       │
│  expiresAt                DateTime?      订阅到期时间                       │
│  refundedAmount           Decimal        已退款金额                         │
│  refundedAt               DateTime?      退款时间                           │
│  createdAt                DateTime       创建时间                           │
│  updatedAt                DateTime       更新时间                           │
│                                                                             │
│  订单状态流转:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  PENDING → COMPLETED → (PARTIALLY_REFUNDED | REFUNDED)                     │
│     ↓                                                                       │
│  FAILED / CANCELLED                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 交易记录

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Transaction 表                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  字段                    类型           说明                                │
│  ─────────────────────────────────────────────────────────────────         │
│  id                     UUID           主键                                 │
│  orderId                UUID           关联订单                             │
│  type                   ENUM           交易类型                             │
│  status                 ENUM           交易状态                             │
│  amount                 Decimal        金额 (退款为负数)                    │
│  currency               String         货币                                 │
│  appleTransactionId     String?        Apple 交易 ID                       │
│  failureReason          String?        失败原因                             │
│  createdAt              DateTime       创建时间                             │
│                                                                             │
│  交易类型:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  INITIAL_PURCHASE       首次购买                                            │
│  RENEWAL                续费                                                │
│  UPGRADE                升级                                                │
│  DOWNGRADE              降级                                                │
│  REFUND                 退款                                                │
│  REVOKE                 撤销                                                │
│                                                                             │
│  交易状态:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  PENDING                处理中                                              │
│  SUCCESS                成功                                                │
│  FAILED                 失败                                                │
│  CANCELLED              取消                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 退款处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         退款工作流                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  RefundRequest 表:                                                          │
│  ─────────────────────────────────────────────────────────────────         │
│  字段                    类型           说明                                │
│  ─────────────────────────────────────────────────────────────────         │
│  id                     UUID           主键                                 │
│  orderId                UUID           关联订单                             │
│  type                   ENUM           FULL / PARTIAL / PRORATED           │
│  status                 ENUM           请求状态                             │
│  requestedAmount        Decimal        申请金额                             │
│  approvedAmount         Decimal?       批准金额                             │
│  reason                 String         退款原因                             │
│  internalNote           String?        内部备注                             │
│  appleRefundId          String?        Apple 退款 ID                       │
│  requestedBy            UUID?          申请人 (管理员)                      │
│  processedBy            UUID?          处理人 (管理员)                      │
│  processedAt            DateTime?      处理时间                             │
│  createdAt              DateTime       创建时间                             │
│                                                                             │
│  退款状态流转:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  PENDING → APPROVED → PROCESSED                                             │
│     ↓                                                                       │
│  REJECTED / CANCELLED                                                       │
│                                                                             │
│  退款类型:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  FULL       全额退款                                                        │
│  PARTIAL    部分退款 (自定义金额)                                           │
│  PRORATED   按比例退款 (剩余订阅时间)                                       │
│                                                                             │
│  退款流程:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 管理员创建退款请求                                                       │
│  2. 填写类型、金额、原因                                                     │
│  3. 管理员审批或拒绝                                                         │
│  4. 批准后:                                                                  │
│     • 更新订单状态 (PARTIALLY_REFUNDED / REFUNDED)                          │
│     • 创建退款交易记录 (负数金额)                                            │
│     • 更新已退款金额                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Apple Webhook 退款

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Apple 退款通知处理                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  触发场景:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • 用户通过 Apple 客服申请退款                                               │
│  • Apple 自动退款 (争议处理)                                                │
│  • 家长控制退款                                                              │
│                                                                             │
│  处理逻辑 (handleRefund):                                                    │
│  ─────────────────────────────────────────────────────────────────         │
│  1. 解析 transactionInfo.revocationDate                                     │
│  2. 获取 revocationReason                                                   │
│  3. 查找用户订阅记录 (by originalTransactionId)                             │
│  4. 立即更新:                                                                │
│     • planType → FREE                                                       │
│     • status → EXPIRED                                                      │
│     • expiresAt → 当前时间                                                  │
│  5. 记录退款日志                                                             │
│                                                                             │
│  退款原因代码:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  0    未指定                                                                │
│  1    用户请求退款                                                          │
│  2    其他原因                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第五部分: Dashboard 管理

## 订单管理界面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订单列表 (OrderList)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🔍 搜索订单号、交易ID、产品名        [状态筛选 ▼]  [导出]          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 订单号            用户        产品           金额   状态   环境  时间 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ ORD-20241215-001  张三      Pro 年度       $128  ✅完成  PROD  12:00│    │
│  │ ORD-20241215-002  李四      Pro 月度        $18  ⏳待处理 SAND  11:30│    │
│  │ ORD-20241214-005  王五      Premium 年度   $198  🔄部分退款 PROD 10:00│    │
│  │ ORD-20241214-003  赵六      Pro 年度       $128  ❌已退款 PROD  09:00│    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  分页: 25 条/页                                                              │
│                                                                             │
│  状态颜色:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  PENDING            黄色                                                    │
│  COMPLETED          绿色                                                    │
│  FAILED             红色                                                    │
│  REFUNDED           灰色                                                    │
│  PARTIALLY_REFUNDED 蓝色                                                    │
│  CANCELLED          默认                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 订单详情

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订单详情 (OrderShow)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  订单信息                                              [COMPLETED]  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  订单号:     ORD-20241215-0001                                      │    │
│  │  产品:       Readmigo Pro 年度订阅                                  │    │
│  │  金额:       $128.00 USD                                            │    │
│  │  用户:       张三 (zhangsan@example.com)                            │    │
│  │  创建时间:   2024-12-15 12:00:00                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Apple 交易信息                                     [PRODUCTION]    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  交易 ID:         1000000123456789                                  │    │
│  │  原始交易 ID:     1000000123456780                                  │    │
│  │  环境:            Production                                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  交易记录                                                           │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  类型            状态      金额           时间                       │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  INITIAL_PURCHASE SUCCESS  +$128.00      2024-12-15 12:00:00       │    │
│  │  RENEWAL          SUCCESS  +$128.00      2025-12-15 12:00:00       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  退款管理                                    [创建退款请求]          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 退款管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         退款操作                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  创建退款请求对话框:                                                         │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  创建退款请求                                              [×]       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  退款类型:  ○ 全额退款  ○ 部分退款  ○ 按比例退款                    │    │
│  │                                                                     │    │
│  │  退款金额:  [________] USD  (最大: $128.00)                         │    │
│  │                                                                     │    │
│  │  退款原因:                                                          │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │ 用户反馈功能不符合预期...                                    │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │                              [取消]  [提交请求]                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  退款请求卡片:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  退款请求 #RF-001                                    [PENDING]       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  类型: 全额退款     金额: $128.00                                   │    │
│  │  原因: 用户反馈功能不符合预期                                       │    │
│  │  申请时间: 2024-12-15 14:00:00                                      │    │
│  │  申请人: admin@readmigo.com                                         │    │
│  │                                                                     │    │
│  │                              [拒绝]  [批准]                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 订阅管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         管理员订阅操作                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  操作                 说明                       参数                       │
│  ─────────────────────────────────────────────────────────────────         │
│  延长订阅             增加订阅天数               days, reason               │
│  赠送订阅             免费给予订阅               planType, days, reason     │
│  撤销订阅             立即终止订阅               reason                      │
│  变更层级             切换 FREE/PRO/PREMIUM      planType, reason           │
│                                                                             │
│  示例操作对话框:                                                             │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  赠送订阅                                                  [×]       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  用户: 张三 (zhangsan@example.com)                                  │    │
│  │                                                                     │    │
│  │  订阅层级:  ○ PRO  ○ PREMIUM                                        │    │
│  │                                                                     │    │
│  │  时长:  [30] 天                                                     │    │
│  │                                                                     │    │
│  │  原因:                                                              │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │ 测试账户 / 推广活动 / 客户补偿...                            │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  │                              [取消]  [确认赠送]                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  审计日志:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  所有管理操作记录:                                                           │
│  • 操作人 (管理员 ID)                                                       │
│  • 操作类型                                                                  │
│  • 目标用户                                                                  │
│  • 原因/备注                                                                 │
│  • 操作时间                                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 统计面板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         支持面板统计                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  订单概览卡片:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐     │
│  │ 今日订单   │ │ 今日收入   │ │ 总收入     │ │ 待处理退款 │ │ 退款率     │     │
│  │    12     │ │  $1,536   │ │ $128,456  │ │     3     │ │   2.5%    │     │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘     │
│                                                                             │
│  订阅统计:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  总用户       FREE        PRO         PREMIUM      试用中           │    │
│  │  10,000      8,500       1,200         200          100            │    │
│  │              85%         12%           2%           1%             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  收入趋势图 (月度):                                                          │
│  ─────────────────────────────────────────────────────────────────         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  $50k ┤                                              ┌─┐             │    │
│  │       │                                        ┌─┐   │ │             │    │
│  │  $40k ┤                                  ┌─┐   │ │   │ │             │    │
│  │       │                            ┌─┐   │ │   │ │   │ │             │    │
│  │  $30k ┤                      ┌─┐   │ │   │ │   │ │   │ │             │    │
│  │       │                ┌─┐   │ │   │ │   │ │   │ │   │ │             │    │
│  │  $20k ┤          ┌─┐   │ │   │ │   │ │   │ │   │ │   │ │             │    │
│  │       │    ┌─┐   │ │   │ │   │ │   │ │   │ │   │ │   │ │             │    │
│  │  $10k ┤    │ │   │ │   │ │   │ │   │ │   │ │   │ │   │ │             │    │
│  │       └────┴─┴───┴─┴───┴─┴───┴─┴───┴─┴───┴─┴───┴─┴───┴─┴─────────    │    │
│  │         Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第六部分: 续订与取消

## 自动续订流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         自动续订时序                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Apple           Webhook              Backend              User             │
│    │                │                    │                   │              │
│    │  到期前尝试扣费 │                    │                   │              │
│    │─────────────────                    │                   │              │
│    │                │                    │                   │              │
│    │  [扣费成功]    │                    │                   │              │
│    │──DID_RENEW────►│                    │                   │              │
│    │                │──handleRenewal()──►│                   │              │
│    │                │                    │──更新 expiresAt──►│              │
│    │                │                    │                   │              │
│    │  [扣费失败]    │                    │                   │              │
│    │──DID_FAIL_TO_RENEW─────────────────►│                   │              │
│    │                │                    │──进入宽限期───────►│              │
│    │                │                    │  (GRACE_PERIOD)   │              │
│    │                │                    │                   │              │
│    │  [宽限期结束]  │                    │                   │              │
│    │──GRACE_PERIOD_EXPIRED──────────────►│                   │              │
│    │                │                    │──订阅过期─────────►│              │
│    │                │                    │  (EXPIRED)        │              │
│                                                                             │
│  宽限期说明:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  • 持续 16-28 天 (Apple 决定)                                               │
│  • 期间仍可访问付费功能                                                      │
│  • Apple 自动重试扣费                                                        │
│  • 用户可更新支付方式                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 取消订阅

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         取消订阅流程                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户取消方式:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  1. iOS 设置 > Apple ID > 订阅 > Readmigo > 取消订阅                        │
│  2. App Store > 账户 > 订阅 > 取消                                          │
│                                                                             │
│  取消后流程:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  User          Apple          Webhook           Backend                     │
│    │             │                │                 │                       │
│    │──取消订阅───►│                │                 │                       │
│    │             │──DID_CHANGE_RENEWAL_STATUS──────►│                       │
│    │             │   (autoRenewStatus = 0)          │                       │
│    │             │                │                 │                       │
│    │             │                │──handleRenewalStatusChange()            │
│    │             │                │                 │                       │
│    │             │                │     更新状态: CANCELLED                 │
│    │             │                │     保留 expiresAt 不变                 │
│    │             │                │                 │                       │
│    │◄─────────────────────仍可使用到期日前──────────│                       │
│    │             │                │                 │                       │
│    │             │──EXPIRED (到期后)───────────────►│                       │
│    │             │                │                 │──设为 FREE            │
│    │             │                │                 │                       │
│                                                                             │
│  关键点:                                                                     │
│  ─────────────────────────────────────────────────────────────────         │
│  • 取消 ≠ 立即失效                                                          │
│  • CANCELLED 状态仍可访问付费功能                                           │
│  • 到期后自动转为 EXPIRED → FREE                                            │
│  • 用户可随时重新订阅                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 升级与降级

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         订阅变更                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  升级 (PRO → PREMIUM):                                                      │
│  ─────────────────────────────────────────────────────────────────         │
│  • 立即生效                                                                  │
│  • 按比例计算差价                                                            │
│  • 生成 UPGRADE 类型交易                                                     │
│  • Webhook: DID_CHANGE_RENEWAL_PREF + SUBSCRIBED                           │
│                                                                             │
│  降级 (PREMIUM → PRO):                                                      │
│  ─────────────────────────────────────────────────────────────────         │
│  • 当前周期结束后生效                                                        │
│  • 不产生退款                                                                │
│  • Webhook: DID_CHANGE_RENEWAL_PREF                                        │
│  • 下次续费时生效新等级                                                      │
│                                                                             │
│  周期变更 (月度 ↔ 年度):                                                    │
│  ─────────────────────────────────────────────────────────────────         │
│  • 当前周期结束后生效                                                        │
│  • 下次续费按新周期计费                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第七部分: 财务与入账

## 收入记录

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         收入跟踪                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  订单入账条件:                                                               │
│  ─────────────────────────────────────────────────────────────────         │
│  • 订单状态为 COMPLETED                                                      │
│  • 收据验证通过                                                              │
│  • 交易状态为 SUCCESS                                                        │
│                                                                             │
│  收入计算:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  毛收入 = SUM(订单金额) where status IN (COMPLETED, PARTIALLY_REFUNDED)     │
│  退款金额 = SUM(refundedAmount)                                              │
│  净收入 = 毛收入 - 退款金额                                                  │
│  退款率 = 退款金额 / 毛收入 × 100%                                          │
│                                                                             │
│  Apple 分成:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  首年订阅: Apple 30%, 开发者 70%                                            │
│  续订 (超过1年): Apple 15%, 开发者 85%                                      │
│                                                                             │
│  实际到账 = 净收入 × 0.7 (首年) 或 × 0.85 (续订)                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 统计 API

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         统计端点                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  GET /admin/orders/stats                                                    │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    totalOrders: number,          // 总订单数                                │
│    totalRevenue: Decimal,        // 总收入                                  │
│    todayOrders: number,          // 今日订单数                              │
│    todayRevenue: Decimal,        // 今日收入                                │
│    pendingRefunds: number,       // 待处理退款数                            │
│    totalRefunded: Decimal,       // 总退款金额                              │
│    refundRate: number,           // 退款率 (%)                              │
│  }                                                                          │
│                                                                             │
│  GET /admin/subscriptions/stats/overview                                    │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    totalUsers: number,           // 总用户数                                │
│    freeUsers: number,            // 免费用户数                              │
│    proUsers: number,             // PRO 用户数                              │
│    premiumUsers: number,         // PREMIUM 用户数                          │
│    trialUsers: number,           // 试用用户数                              │
│    expiredUsers: number,         // 过期用户数                              │
│    conversionRate: number,       // 转化率 (%)                              │
│    activeSubscribers: number,    // 活跃订阅数                              │
│  }                                                                          │
│                                                                             │
│  GET /admin/support/stats (收入趋势)                                        │
│  ─────────────────────────────────────────────────────────────────         │
│  {                                                                          │
│    revenueTrends: [                                                         │
│      { date: '2024-12', revenue: 45000 },                                  │
│      { date: '2024-11', revenue: 42000 },                                  │
│      ...                                                                   │
│    ]                                                                        │
│  }                                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第八部分: 安全与日志

## 安全措施

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         安全机制                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  客户端安全:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  • StoreKit 2 自动 JWS 签名验证                                             │
│  • VerificationResult 强制检查                                               │
│  • 收据数据不存储在客户端                                                    │
│                                                                             │
│  后端安全:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • Apple Shared Secret 环境变量存储                                         │
│  • 收据验证使用 HTTPS                                                        │
│  • JWT 认证保护所有用户端点                                                  │
│  • Admin 权限保护管理端点                                                    │
│  • 订阅状态绑定到用户 ID                                                    │
│                                                                             │
│  待改进:                                                                     │
│  ─────────────────────────────────────────────────────────────────         │
│  • Webhook JWS 签名验证 (生产环境必须)                                      │
│  • 收据验证接口限流                                                          │
│  • 敏感操作审计日志增强                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 日志记录

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         日志事件                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  记录事件:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  • 收据验证尝试和结果                                                        │
│  • Webhook 通知处理                                                          │
│  • 订阅状态变更                                                              │
│  • 试用创建/转换/过期                                                        │
│  • 管理员操作 (赠送、延长、撤销)                                            │
│  • 退款请求和审批                                                            │
│                                                                             │
│  日志级别:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  INFO      正常操作记录                                                     │
│  WARNING   异常但可恢复的情况                                               │
│  ERROR     错误和失败                                                       │
│                                                                             │
│  元数据:                                                                     │
│  ─────────────────────────────────────────────────────────────────         │
│  • 用户 ID                                                                  │
│  • 计划类型                                                                  │
│  • 到期日期                                                                  │
│  • 原始交易 ID                                                              │
│  • 管理员 ID (管理操作)                                                     │
│  • 原因/备注                                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第九部分: 文件索引

## 代码文件位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         文件结构                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  iOS 客户端:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  ios/Readmigo/                                                              │
│  ├── Core/Models/Subscription.swift           订阅模型定义                  │
│  ├── Features/Subscriptions/                                               │
│  │   ├── SubscriptionManager.swift           核心订阅管理器                 │
│  │   ├── PaywallView.swift                   付费墙 UI                     │
│  │   ├── SubscriptionStatusView.swift        订阅状态 UI                   │
│  │   └── RestorePurchasesView.swift          恢复购买 UI                   │
│  └── Services/                                                              │
│      ├── FeatureGateService.swift            功能门禁服务                   │
│      └── UsageTracker.swift                  用量追踪服务                   │
│                                                                             │
│  后端服务:                                                                   │
│  ─────────────────────────────────────────────────────────────────         │
│  apps/backend/src/modules/subscriptions/                                   │
│  ├── subscriptions.controller.ts             用户端点                       │
│  ├── subscriptions.service.ts                收据验证 & 状态管理            │
│  ├── subscriptions.module.ts                 模块定义                       │
│  ├── admin-subscription.controller.ts        管理端点                       │
│  ├── trial.service.ts                        试用管理                       │
│  ├── apple-webhook.controller.ts             Webhook 接收                   │
│  ├── apple-webhook.service.ts                通知处理                       │
│  └── dto/apple-webhook.dto.ts                Apple 类型定义                │
│                                                                             │
│  apps/backend/src/modules/support/services/                                │
│  ├── orders.service.ts                       订单 & 退款管理               │
│  └── support-stats.service.ts                统计服务                       │
│                                                                             │
│  apps/backend/src/common/guards/                                           │
│  ├── subscription.guard.ts                   订阅授权守卫                   │
│  ├── subscription.types.ts                   功能权限矩阵                   │
│  └── usage-limit.guard.ts                    用量限制守卫                   │
│                                                                             │
│  Dashboard:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  apps/dashboard/src/pages/orders/                                          │
│  ├── OrderList.tsx                           订单列表                       │
│  └── OrderShow.tsx                           订单详情 & 退款               │
│                                                                             │
│  apps/dashboard/src/pages/support/                                         │
│  └── SupportDashboard.tsx                    支持面板                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 相关文档

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         参考文档                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Apple 官方文档:                                                             │
│  ─────────────────────────────────────────────────────────────────         │
│  • StoreKit 2: developer.apple.com/documentation/storekit                  │
│  • App Store Server API: developer.apple.com/documentation/appstoreserverapi│
│  • Server Notifications V2: developer.apple.com/documentation/appstoreservernotifications│
│  • 收据验证: developer.apple.com/documentation/appstorereceipts            │
│                                                                             │
│  项目内文档:                                                                 │
│  ─────────────────────────────────────────────────────────────────         │
│  • docs/04-development/platforms/ios/features/subscription-implementation.md (本文档) │
│  • docs/04-development/platforms/dashboard/features/orders.md              │
│  • docs/04-development/backend/subscriptions/api-reference.md              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

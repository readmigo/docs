# iOS 监控体系

> Firebase + MetricKit + Sentry + 自定义埋点

---

## 1. 监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控体系架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    数据采集层                            │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ Crashlytics│  │ MetricKit │  │  自定义   │           │    │
│  │  │  崩溃监控  │  │ 系统指标  │  │  埋点    │           │    │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘           │    │
│  │        │              │              │                  │    │
│  └────────┼──────────────┼──────────────┼──────────────────┘    │
│           │              │              │                        │
│  ┌────────┴──────────────┴──────────────┴──────────────────┐    │
│  │                    数据处理层                            │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  聚合处理  │  │  过滤采样  │  │  格式转换  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────┐    │
│  │                    数据上报层                            │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                          │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ Firebase  │  │  Sentry   │  │ 自建平台  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 崩溃监控

### 2.1 Firebase Crashlytics

| 功能 | 说明 |
|------|------|
| 崩溃捕获 | 自动捕获崩溃 |
| 堆栈分析 | 符号化堆栈 |
| 崩溃分组 | 智能分组 |
| 用户影响 | 影响用户统计 |
| 实时告警 | 崩溃率告警 |

### 2.2 崩溃信息采集

```
┌─────────────────────────────────────────────────────────────────┐
│                    崩溃信息采集                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  自动采集                                                        │
│  ├── 崩溃堆栈                                                    │
│  ├── 设备信息                                                    │
│  │   ├── 设备型号                                                │
│  │   ├── iOS 版本                                               │
│  │   ├── App 版本                                               │
│  │   └── 内存状态                                                │
│  │                                                              │
│  └── 崩溃上下文                                                  │
│      ├── 前台/后台状态                                           │
│      ├── 电量状态                                                │
│      └── 磁盘空间                                                │
│                                                                  │
│  自定义信息                                                      │
│  ├── 用户 ID (可选)                                             │
│  ├── 自定义 Key-Value                                           │
│  │   ├── current_screen                                        │
│  │   ├── current_book_id                                       │
│  │   └── reading_mode                                          │
│  │                                                              │
│  └── 面包屑日志                                                  │
│      └── 最近操作记录                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 性能监控

### 3.1 MetricKit

```
┌─────────────────────────────────────────────────────────────────┐
│                    MetricKit 指标                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  启动指标 (MXAppLaunchMetric)                                   │
│  ├── 冷启动时间                                                  │
│  ├── 热启动时间                                                  │
│  └── 优化启动时间                                                │
│                                                                  │
│  响应指标 (MXAppResponsivenessMetric)                           │
│  ├── Hang 时间                                                  │
│  └── 响应延迟分布                                                │
│                                                                  │
│  内存指标 (MXMemoryMetric)                                      │
│  ├── 峰值内存                                                    │
│  └── 平均内存使用                                                │
│                                                                  │
│  磁盘指标 (MXDiskIOMetric)                                      │
│  ├── 读取量                                                      │
│  └── 写入量                                                      │
│                                                                  │
│  网络指标 (MXNetworkTransferMetric)                             │
│  ├── WiFi 传输量                                                │
│  └── 蜂窝传输量                                                  │
│                                                                  │
│  电量指标                                                        │
│  ├── CPU 使用                                                   │
│  ├── GPU 使用                                                   │
│  └── 位置服务使用                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Firebase Performance

| 监控项 | 说明 |
|--------|------|
| App 启动 | 启动时间追踪 |
| 网络请求 | 请求耗时 |
| 自定义 Trace | 自定义性能追踪 |
| 屏幕渲染 | 帧率监控 |

---

## 4. 行为埋点

### 4.1 埋点策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    埋点策略                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  页面浏览 (Page View)                                           │
│  ├── 页面名称                                                    │
│  ├── 来源页面                                                    │
│  ├── 停留时长                                                    │
│  └── 页面参数                                                    │
│                                                                  │
│  用户行为 (Action)                                              │
│  ├── 按钮点击                                                    │
│  ├── 列表滑动                                                    │
│  ├── 搜索查询                                                    │
│  └── 分享操作                                                    │
│                                                                  │
│  业务事件 (Business Event)                                      │
│  ├── 书籍打开                                                    │
│  ├── 阅读进度                                                    │
│  ├── 订阅购买                                                    │
│  └── AI 功能使用                                                │
│                                                                  │
│  技术事件 (Technical Event)                                     │
│  ├── 网络请求                                                    │
│  ├── 缓存命中                                                    │
│  ├── 错误发生                                                    │
│  └── 性能指标                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 核心埋点事件

| 事件类别 | 事件名 | 说明 |
|----------|--------|------|
| 阅读 | book_open | 打开书籍 |
| 阅读 | reading_progress | 阅读进度 |
| 阅读 | chapter_complete | 章节完成 |
| AI | ai_lookup | AI 查词 |
| AI | ai_translate | AI 翻译 |
| 学习 | word_added | 添加生词 |
| 学习 | review_complete | 复习完成 |
| 订阅 | subscription_view | 查看订阅 |
| 订阅 | subscription_purchase | 购买订阅 |

---

## 5. 实时监控

### 5.1 关键指标告警

```
┌─────────────────────────────────────────────────────────────────┐
│                    告警规则                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  崩溃率告警                                                      │
│  ├── P0: 崩溃率 > 1%      → 立即处理                           │
│  ├── P1: 崩溃率 > 0.5%    → 24 小时内处理                      │
│  └── P2: 崩溃率 > 0.1%    → 下版本修复                         │
│                                                                  │
│  性能告警                                                        │
│  ├── 启动时间 > 3s        → P1 优化                            │
│  ├── API 耗时 > 5s        → P1 排查                            │
│  └── 内存超 200MB         → P2 优化                            │
│                                                                  │
│  业务告警                                                        │
│  ├── 订阅成功率下降 10%   → P0 排查                            │
│  ├── AI 调用失败率 > 5%   → P1 排查                            │
│  └── 下载失败率 > 10%     → P1 排查                            │
│                                                                  │
│  告警通知                                                        │
│  ├── Slack 推送                                                 │
│  ├── 邮件通知                                                    │
│  └── 电话告警 (P0)                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 监控大盘

| 看板 | 指标 |
|------|------|
| 稳定性 | 崩溃率、ANR 率 |
| 性能 | 启动时间、帧率 |
| 业务 | DAU、阅读时长 |
| 技术 | API 成功率、缓存命中率 |

---

## 6. 阅读器监控

### 6.1 阅读器专项指标

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器监控指标                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  加载性能                                                        │
│  ├── 书籍打开时间                                                │
│  │   ├── P50 < 500ms                                           │
│  │   ├── P90 < 1s                                              │
│  │   └── P99 < 2s                                              │
│  │                                                              │
│  ├── 章节加载时间                                                │
│  │   ├── P50 < 200ms                                           │
│  │   └── P90 < 500ms                                           │
│  │                                                              │
│  └── 翻页响应时间                                                │
│      └── < 100ms                                                │
│                                                                  │
│  渲染性能                                                        │
│  ├── 帧率                                                        │
│  │   └── 滑动时 > 55fps                                        │
│  │                                                              │
│  └── 渲染成功率                                                  │
│      └── > 99.9%                                                │
│                                                                  │
│  资源消耗                                                        │
│  ├── 内存使用                                                    │
│  │   └── 阅读时 < 100MB                                        │
│  │                                                              │
│  └── 电量消耗                                                    │
│      └── 每小时 < 5%                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 阅读行为分析

| 指标 | 说明 |
|------|------|
| 平均阅读时长 | 每次阅读会话时长 |
| 日均阅读页数 | 每日阅读量 |
| 完读率 | 书籍完成比例 |
| 功能使用率 | AI、笔记等功能使用 |

---

## 7. App Store 指标

### 7.1 App Analytics

```
┌─────────────────────────────────────────────────────────────────┐
│                    App Store 指标                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  获客指标                                                        │
│  ├── 展示次数 (Impressions)                                     │
│  ├── 产品页浏览 (Product Page Views)                            │
│  ├── 下载量 (Downloads)                                         │
│  └── 转化率                                                      │
│                                                                  │
│  使用指标                                                        │
│  ├── 活跃设备数                                                  │
│  ├── 会话次数                                                    │
│  ├── 崩溃次数                                                    │
│  └── 留存率                                                      │
│                                                                  │
│  营收指标                                                        │
│  ├── 销售额                                                      │
│  ├── 订阅者数                                                    │
│  ├── 付费转化率                                                  │
│  └── ARPU                                                       │
│                                                                  │
│  质量指标                                                        │
│  ├── 评分                                                        │
│  ├── 评论数                                                      │
│  └── 崩溃率排名                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 App Store Connect 告警

| 指标 | 告警阈值 |
|------|----------|
| 崩溃率 | > 行业 P50 |
| 评分下降 | 周均下降 > 0.2 |
| 1 星评论 | 日增 > 10 条 |

---

## 8. 日志系统

### 8.1 日志分级

```
┌─────────────────────────────────────────────────────────────────┐
│                    日志分级                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  级别            说明              存储              上报        │
│  ─────────────────────────────────────────────────────────────  │
│  verbose         详细调试信息       本地开发          否         │
│  debug           调试信息           本地 + 开发环境    否         │
│  info            一般信息           本地              采样上报   │
│  warning         警告信息           本地 + 远程        全量上报   │
│  error           错误信息           本地 + 远程        全量上报   │
│  fatal           致命错误           本地 + 远程        立即上报   │
│                                                                  │
│  日志格式                                                        │
│  [timestamp] [level] [tag] [file:line] message                 │
│  2025-12-31 10:30:00 [ERROR] [Reader] ReaderView:123 解析失败  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 日志工具

| 工具 | 用途 |
|------|------|
| OSLog | Apple 官方日志 |
| CocoaLumberjack | 功能丰富的日志库 |
| SwiftyBeaver | 多目标日志 |

---

## 9. 隐私合规

### 9.1 数据采集合规

```
┌─────────────────────────────────────────────────────────────────┐
│                    隐私合规要求                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  App Tracking Transparency (ATT)                                │
│  ├── iOS 14.5+ 需要用户授权                                     │
│  ├── 跟踪用户需要弹窗确认                                        │
│  └── 拒绝后使用有限数据                                          │
│                                                                  │
│  App Privacy Report                                             │
│  ├── 声明数据收集类型                                            │
│  ├── 说明数据用途                                                │
│  └── 标注是否关联用户                                            │
│                                                                  │
│  数据最小化                                                      │
│  ├── 只收集必要数据                                              │
│  ├── 匿名化处理                                                  │
│  ├── 定期清理                                                    │
│  └── 用户可删除                                                  │
│                                                                  │
│  采集数据分类                                                    │
│  ├── 功能数据 → 无需授权                                        │
│  ├── 分析数据 → 需要同意                                        │
│  └── 广告数据 → 需要 ATT                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 数据分类

| 数据类型 | 是否关联用户 | 用途 |
|----------|--------------|------|
| 崩溃日志 | 可选 | 问题诊断 |
| 性能数据 | 否 | 性能优化 |
| 使用统计 | 否 | 产品分析 |
| 购买记录 | 是 | 交易记录 |

---

## 10. 监控工具集成

### 10.1 工具配置

| 工具 | 配置文件 |
|------|----------|
| Firebase | GoogleService-Info.plist |
| Sentry | Sentry.init() in AppDelegate |
| MetricKit | MXMetricManager 订阅 |

### 10.2 SDK 集成清单

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控 SDK 清单                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  崩溃监控                                                        │
│  ├── Firebase Crashlytics                                      │
│  └── Sentry (备选)                                              │
│                                                                  │
│  性能监控                                                        │
│  ├── Firebase Performance                                      │
│  └── MetricKit (系统)                                           │
│                                                                  │
│  数据分析                                                        │
│  ├── Firebase Analytics                                        │
│  └── App Store Connect                                         │
│                                                                  │
│  日志收集                                                        │
│  ├── OSLog                                                     │
│  └── 自建日志系统                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [error-handling.md](./error-handling.md) | 错误处理 |
| [performance.md](./performance.md) | 性能优化 |
| [release-process.md](./release-process.md) | 发布流程 |

---

*最后更新: 2025-12-31*

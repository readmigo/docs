# iOS 性能优化

> SwiftUI 优化 + 内存管理 + 启动优化

---

## 1. 性能目标

### 1.1 核心指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 冷启动 | < 2s | 首次启动到可交互 |
| 热启动 | < 500ms | 后台恢复 |
| 帧率 | 60fps | 滑动/动画流畅 |
| 内存 | < 150MB | 正常使用峰值 |
| App 大小 | < 50MB | 下载大小 |

### 1.2 阅读器指标

| 指标 | 目标 |
|------|------|
| 书籍打开 | < 1s |
| 翻页延迟 | < 100ms |
| 章节加载 | < 500ms |
| AI 响应 | < 3s |

---

## 2. SwiftUI 优化

### 2.1 视图更新优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    SwiftUI 优化策略                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  减少不必要重绘                                                  │
│  ├── 使用 @State 精确到最小范围                                 │
│  ├── 避免在 body 中创建对象                                     │
│  ├── 使用 EquatableView 减少比较                               │
│  └── 提取子视图减少重绘范围                                      │
│                                                                  │
│  状态管理                                                        │
│  ├── 使用 @Observable (iOS 17+)                                │
│  ├── 避免深层嵌套 @ObservedObject                              │
│  └── 使用 @StateObject 管理生命周期                            │
│                                                                  │
│  视图标识                                                        │
│  ├── 使用 .id() 控制视图重建                                    │
│  └── ForEach 提供稳定 id                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 List/LazyVStack 优化

| 优化项 | 说明 |
|--------|------|
| LazyVStack | 延迟加载视图 |
| 固定高度 | 避免动态计算 |
| id 参数 | 提供唯一标识 |
| 分页加载 | 按需加载数据 |

---

## 3. 启动优化

### 3.1 冷启动优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    启动优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Pre-main 优化                                                  │
│  ├── 减少动态库数量                                              │
│  ├── 移除无用 ObjC 类                                           │
│  └── 减少 +load 方法                                            │
│                                                                  │
│  Main 阶段优化                                                   │
│  ├── 延迟非必要初始化                                            │
│  ├── 异步初始化 SDK                                              │
│  └── 减少首屏视图复杂度                                          │
│                                                                  │
│  首屏优化                                                        │
│  ├── 减少首屏视图层级                                            │
│  ├── 使用占位符                                                  │
│  └── 延迟加载图片                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 初始化优先级

| 初始化项 | 时机 | 优先级 |
|----------|------|--------|
| 日志系统 | 启动时 | 高 |
| 网络配置 | 启动时 | 高 |
| 数据库 | 延迟 | 中 |
| 分析 SDK | 延迟 | 低 |
| 推送 | 后台 | 低 |

---

## 4. 内存优化

### 4.1 内存管理

```
┌─────────────────────────────────────────────────────────────────┐
│                    内存优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  图片内存                                                        │
│  ├── 使用合适尺寸的图片                                          │
│  ├── 及时释放大图                                                │
│  ├── 使用 SDWebImage 缓存策略                                   │
│  └── 监听内存警告                                                │
│                                                                  │
│  阅读器内存                                                      │
│  ├── 只保留可视页面 + 前后各 1 页                               │
│  ├── 章节按需加载                                                │
│  └── 大文件分块处理                                              │
│                                                                  │
│  避免泄漏                                                        │
│  ├── 使用 [weak self]                                          │
│  ├── 避免循环引用                                                │
│  ├── 及时取消 Task                                              │
│  └── 使用 Instruments 检测                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 内存监控

| 工具 | 用途 |
|------|------|
| Instruments | 内存分析 |
| Xcode Memory Graph | 泄漏检测 |
| Memory Report | 实时监控 |

---

## 5. 网络优化

### 5.1 请求优化

| 优化项 | 说明 |
|--------|------|
| 连接复用 | URLSession 配置 |
| 请求合并 | 批量请求 |
| 数据压缩 | gzip 压缩 |
| 缓存策略 | HTTP 缓存 |

### 5.2 图片加载

```
┌─────────────────────────────────────────────────────────────────┐
│                    图片优化                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SDWebImage / Kingfisher                                        │
│  ├── 内存缓存: 最大 100MB                                       │
│  ├── 磁盘缓存: 最大 250MB                                       │
│  └── 过期时间: 7 天                                             │
│                                                                  │
│  请求优化                                                        │
│  ├── 渐进式加载                                                  │
│  ├── 预加载                                                      │
│  ├── 降采样                                                      │
│  └── 使用 WebP 格式                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 阅读器优化

### 6.1 EPUB 渲染优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器优化                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  分页优化                                                        │
│  ├── 预渲染前后页                                                │
│  ├── 复用 WebView                                               │
│  └── 缓存分页结果                                                │
│                                                                  │
│  章节优化                                                        │
│  ├── 懒加载章节                                                  │
│  ├── 后台预解析                                                  │
│  └── 增量加载                                                    │
│                                                                  │
│  图片优化                                                        │
│  ├── 可视区域加载                                                │
│  ├── 压缩大图                                                    │
│  └── 占位图                                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 翻页优化

| 优化项 | 说明 |
|--------|------|
| 硬件加速 | 使用 Metal |
| 预渲染 | 提前渲染下一页 |
| 手势优化 | 低延迟响应 |

---

## 7. App 包体优化

### 7.1 包体优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    包体优化                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  资源优化                                                        │
│  ├── 图片压缩                                                    │
│  ├── 使用 Asset Catalog                                         │
│  ├── 移除未使用资源                                              │
│  └── 按需下载资源 (ODR)                                         │
│                                                                  │
│  代码优化                                                        │
│  ├── Strip Unused Code                                          │
│  ├── Dead Code Stripping                                        │
│  └── 移除未使用框架                                              │
│                                                                  │
│  编译优化                                                        │
│  ├── Bitcode                                                    │
│  ├── App Thinning                                               │
│  └── Swift 优化级别                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 App Thinning

| 技术 | 说明 |
|------|------|
| Slicing | 按设备生成 |
| Bitcode | 后端优化 |
| ODR | 按需资源 |

---

## 8. 监控与分析

### 8.1 性能监控

| 工具 | 监控项 |
|------|--------|
| MetricKit | 系统性能指标 |
| Instruments | 详细分析 |
| Firebase Performance | 线上监控 |

### 8.2 性能分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能分析工具                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Instruments                                                    │
│  ├── Time Profiler                                              │
│  ├── Allocations                                                │
│  ├── Leaks                                                      │
│  ├── Core Animation                                             │
│  └── Network                                                    │
│                                                                  │
│  Xcode                                                          │
│  ├── Debug Navigator                                            │
│  ├── Memory Graph                                               │
│  └── View Hierarchy Debugger                                    │
│                                                                  │
│  SwiftUI 专用                                                    │
│  ├── Self._printChanges()                                      │
│  └── Instruments: SwiftUI                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 电量优化

### 9.1 电量优化策略

| 策略 | 说明 |
|------|------|
| 减少后台活动 | 合理使用 Background Task |
| 批量网络请求 | 减少无线唤醒 |
| 位置服务优化 | 使用 Significant Location |
| 减少动画 | 低电量模式适配 |

### 9.2 低电量模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    低电量模式适配                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  检测低电量模式                                                  │
│  └── ProcessInfo.processInfo.isLowPowerModeEnabled             │
│                                                                  │
│  适配策略                                                        │
│  ├── 降低刷新频率                                                │
│  ├── 暂停自动同步                                                │
│  ├── 减少动画效果                                                │
│  └── 延迟非关键任务                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [reader-engine.md](./reader-engine.md) | 阅读器引擎 |
| [offline-support.md](./offline-support.md) | 离线优化 |

---

*最后更新: 2025-12-31*

# 书签系统实现文档

## 1. 功能概述

### 1.1 功能边界

| 功能项 | 包含 | 不包含 |
|--------|------|--------|
| 创建方式 | 点击书签按钮/选中文本 | 自动书签 |
| 书签类型 | 位置书签/文本书签 | 分类标签 |
| 显示方式 | 书签图标/书签列表 | 时间线视图 |
| 存储范围 | 本地持久化/云同步 | 仅会话级 |

### 1.2 书签类型

```
┌─────────────────────────────────────────────────────────┐
│                   书签类型对比                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  位置书签 (Page Bookmark)                               │
│  ├── 标记阅读位置                                      │
│  ├── 无需选中文本                                      │
│  ├── 精确到页面/段落                                   │
│  └── 可添加标题备注                                    │
│                                                         │
│  文本书签 (Text Bookmark)                               │
│  ├── 标记特定文本                                      │
│  ├── 需要选中文本                                      │
│  ├── 保存文本内容                                      │
│  └── 兼具高亮功能                                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 2. 系统架构

### 2.1 模块架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      BookmarkManager                            │
│                        (单例模式)                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │PositionMgr  │  │IconRenderer │  │StorageManager           │  │
│  │ (位置管理)  │  │ (图标渲染)  │  │ (存储管理)             │  │
│  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘  │
│         │                │                      │                │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌───────────┴───────────┐   │
│  │CFICalculator│  │PageCornerMark│ │CoreDataStore          │   │
│  │PageMapper   │  │MarginIcon   │  │CloudKitSync           │   │
│  │ProgressCalc │  │ListRenderer │  │ExportService          │   │
│  └─────────────┘  └─────────────┘  └───────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ BookmarkListController (书签列表控制器)                 │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  用户交互    │     │  书签管理器  │     │  存储/渲染   │
│              │     │              │     │              │
│ 点击书签按钮├────►│ 创建书签    ├────►│ 持久化存储  │
│ 选中+添加   │     │ 位置计算    │     │ 图标渲染    │
│ 书签列表操作│     │ 列表管理    │     │ 云端同步    │
└──────────────┘     └──────────────┘     └──────────────┘
```

## 3. 数据模型

### 3.1 书签实体

```
Bookmark
├── id: UUID                     // 唯一标识
├── bookId: String               // 所属书籍ID
├── chapterId: String            // 所属章节ID
├── cfi: String                  // CFI位置
├── type: BookmarkType           // 书签类型
├── title: String                // 书签标题
├── selectedText: String?        // 选中文本(文本书签)
├── pageNumber: Int?             // 页码(分页模式)
├── progress: Double             // 阅读进度百分比
├── color: BookmarkColor         // 书签颜色
├── createdAt: Date              // 创建时间
├── updatedAt: Date              // 更新时间
├── syncStatus: SyncStatus       // 同步状态
└── isDeleted: Bool              // 软删除标记

BookmarkType
├── position                     // 位置书签
└── text                         // 文本书签

BookmarkColor
├── red       (#E53935, 默认)
├── blue      (#1E88E5)
├── green     (#43A047)
├── yellow    (#FDD835)
├── purple    (#8E24AA)
└── orange    (#FB8C00)
```

### 3.2 书签预览信息

```
BookmarkPreview
├── id: UUID                     // 书签ID
├── title: String                // 标题
├── chapterTitle: String         // 章节名
├── previewText: String          // 预览文本(周围上下文)
├── progress: Double             // 进度
├── color: BookmarkColor         // 颜色
└── createdAt: Date              // 创建时间
```

## 4. 书签创建

### 4.1 位置书签创建流程

```
用户点击书签按钮
    │
    ▼
┌───────────────────┐
│ 获取当前阅读位置  │
│ (CFI + 页码)      │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 检查是否已有书签  │
└────────┬──────────┘
         │
    ┌────┴────┐
    ▼         ▼
  已有       没有
    │         │
    ▼         ▼
提示删除   ┌───────────────────────────────────────┐
或跳转     │          添加书签                     │
           ├───────────────────────────────────────┤
           │                                       │
           │  标题: [自动生成的默认标题]           │
           │                                       │
           │  颜色: [🔴][🔵][🟢][🟡][🟣][🟠]       │
           │                                       │
           │       [取消]         [保存]           │
           │                                       │
           └───────────────────────────────────────┘
```

### 4.2 文本书签创建流程

```
选中文本 → 显示菜单 → 点击[添加书签]
    │
    ▼
┌───────────────────────────────────────────────────┐
│              添加文本书签                          │
├───────────────────────────────────────────────────┤
│                                                   │
│  选中内容: "用户选中的文本内容..."                │
│                                                   │
│  标题: [选中文本前20字符...]                      │
│                                                   │
│  颜色: [🔴][🔵][🟢][🟡][🟣][🟠]                   │
│                                                   │
│         [取消]              [保存]                │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 4.3 默认标题生成规则

| 书签类型 | 默认标题格式 | 示例 |
|----------|--------------|------|
| 位置书签 | 章节名 - 页码 | 第一章 - 第15页 |
| 文本书签 | 选中文本前20字符... | 这是一段重要的内... |

## 5. 书签图标显示

### 5.1 页角书签标记

```
┌─────────────────────────────────────────────────────────┐
│                   页角书签显示                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  分页模式:                                              │
│  ┌──────────────────────────────────────────────┬──┐   │
│  │                                              │🔖│   │
│  │                                              └──┤   │
│  │                                                 │   │
│  │              页面内容                           │   │
│  │                                                 │   │
│  │                                                 │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  书签角标:                                              │
│  ├── 位置: 右上角                                      │
│  ├── 尺寸: 24x32pt                                     │
│  ├── 颜色: 书签颜色                                    │
│  └── 动画: 点击时轻微弹跳                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 滚动模式书签标记

```
滚动模式:
┌──────────────────────────────────────────────────────────┐
│ 🔖 ← 边距书签图标                                       │
│    这是被书签标记的段落开始位置                         │
│    段落内容继续...                                      │
│                                                         │
│    普通段落内容                                         │
│                                                         │
│ 🔖                                                      │
│    另一个书签位置                                       │
│                                                         │
└──────────────────────────────────────────────────────────┘
```

### 5.3 图标交互

| 操作 | 响应 |
|------|------|
| 单击 | 显示书签详情弹窗 |
| 长按 | 显示操作菜单(编辑/删除) |
| 再次点击书签按钮 | 切换书签(添加/删除) |

## 6. 书签列表

### 6.1 列表界面

```
┌─────────────────────────────────────────────────────────┐
│                     书签列表                            │
├─────────────────────────────────────────────────────────┤
│  [全部] [位置书签] [文本书签]        排序: [▼ 时间]    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🔴 第一章 - 重要概念                            │   │
│  │    "这里解释了核心理论..."                      │   │
│  │    进度: 15%  •  2024-01-15                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🔵 第三章 - 第42页                              │   │
│  │    "关于实践应用的部分..."                      │   │
│  │    进度: 45%  •  2024-01-14                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🟢 第五章 - 总结要点                            │   │
│  │    位置书签                                      │   │
│  │    进度: 78%  •  2024-01-13                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 列表功能

| 功能 | 操作 | 说明 |
|------|------|------|
| 筛选 | 顶部标签切换 | 全部/位置/文本 |
| 排序 | 排序下拉 | 时间/进度/章节 |
| 跳转 | 点击条目 | 跳转到书签位置 |
| 编辑 | 左滑条目 | 显示编辑/删除按钮 |
| 批量操作 | 长按进入 | 多选删除 |

### 6.3 空状态

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│                                                         │
│                        📑                               │
│                                                         │
│                  还没有书签                             │
│                                                         │
│           点击右上角书签图标添加                        │
│           或选中文字后添加文本书签                      │
│                                                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 7. 书签跳转

### 7.1 跳转流程

```
点击书签条目
    │
    ▼
┌───────────────────┐
│ 解析书签CFI       │
└────────┬──────────┘
         │
         ▼
┌───────────────────┐
│ 判断是否同章节    │
└────────┬──────────┘
         │
    ┌────┴────┐
    ▼         ▼
  同章节     不同章节
    │         │
    ▼         ▼
直接滚动/  加载目标章节
翻页定位   完成后定位
```

### 7.2 跳转动画

| 场景 | 动画类型 | 时长 |
|------|----------|------|
| 同页面 | 高亮闪烁 | 500ms |
| 同章节不同页 | 滑动/翻页 | 300ms |
| 不同章节 | 淡入淡出 | 400ms |

## 8. 存储与同步

### 8.1 Core Data实体

```
Core Data Entity: BookmarkEntity
├── Attributes
│   ├── id: UUID
│   ├── bookId: String
│   ├── chapterId: String
│   ├── cfi: String
│   ├── typeRaw: Int16
│   ├── title: String
│   ├── selectedText: String (optional)
│   ├── pageNumber: Int32 (optional)
│   ├── progress: Double
│   ├── colorName: String
│   ├── createdAt: Date
│   ├── updatedAt: Date
│   ├── syncStatus: Int16
│   └── isDeleted: Bool
│
└── Relationships
    └── book: BookEntity (optional)
```

### 8.2 阅读进度书签

```
┌─────────────────────────────────────────────────────────┐
│              自动阅读进度保存                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  特殊书签: LastReadPosition                            │
│  ├── 每本书仅一个                                      │
│  ├── 自动更新(退出阅读器时)                            │
│  ├── 不显示在书签列表                                  │
│  └── 用于恢复阅读位置                                  │
│                                                         │
│  更新时机:                                              │
│  ├── 翻页/滚动停止后3秒                                │
│  ├── 退出阅读器                                        │
│  ├── 应用进入后台                                      │
│  └── 切换书籍                                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 9. 快捷操作

### 9.1 工具栏书签按钮

```
书签按钮状态
├── 未添加状态
│   ├── 图标: 空心书签 ☆
│   ├── 点击: 添加书签
│   └── 长按: 打开书签列表
│
└── 已添加状态
    ├── 图标: 实心书签 ★ (书签颜色)
    ├── 点击: 显示书签详情
    └── 长按: 打开书签列表
```

### 9.2 快速书签

```
快速书签模式:
├── 启用设置: 单击直接添加/删除书签
├── 使用默认颜色和自动标题
├── 适合快速标记场景
└── 可在设置中开启/关闭
```

## 10. 回调与事件

### 10.1 委托协议

```
BookmarkManagerDelegate
├── 创建回调
│   ├── didCreateBookmark(bookmark)       // 创建成功
│   └── didFailToCreate(error)            // 创建失败
│
├── 编辑回调
│   ├── didUpdateBookmark(bookmark)       // 更新成功
│   └── didDeleteBookmark(id)             // 删除成功
│
├── 交互回调
│   ├── didSelectBookmark(bookmark)       // 选中书签
│   └── willNavigateToBookmark(bookmark)  // 即将跳转
│
├── 列表回调
│   ├── didOpenList()                     // 打开列表
│   └── didCloseList()                    // 关闭列表
│
└── 同步回调
    └── didSyncComplete(result)           // 同步完成
```

## 11. 性能优化

### 11.1 优化策略

| 策略 | 实现方式 |
|------|----------|
| 列表虚拟化 | 大量书签使用UITableView复用 |
| 预览缓存 | 缓存书签周围文本 |
| 懒加载图标 | 仅渲染可见区域书签图标 |
| 批量查询 | 章节加载时批量查询书签 |

### 11.2 书签数量建议

| 数量级 | 性能表现 | 建议 |
|--------|----------|------|
| < 50 | 流畅 | 正常使用 |
| 50-200 | 良好 | 考虑分类管理 |
| > 200 | 可能卡顿 | 建议清理或归档 |

## 12. API接口

### 12.1 对外提供

| 接口 | 说明 |
|------|------|
| createBookmark(cfi:type:title:color:) | 创建书签 |
| updateBookmark(id:title:color:) | 更新书签 |
| deleteBookmark(id:) | 删除书签 |
| getBookmarks(bookId:type:) | 获取书签列表 |
| hasBookmark(at: cfi) | 检查位置是否有书签 |
| navigateToBookmark(id:) | 跳转到书签 |
| toggleBookmark(at: cfi) | 切换书签(添加/删除) |
| getLastReadPosition(bookId:) | 获取上次阅读位置 |
| saveReadPosition(bookId:cfi:) | 保存阅读位置 |

### 12.2 外部依赖

| 依赖项 | 用途 |
|--------|------|
| WebViewBridge | JavaScript通信 |
| CoreDataStack | 本地持久化 |
| CloudKitManager | 云端同步 |
| ReaderViewController | 页面导航 |
| ChapterManager | 章节信息 |

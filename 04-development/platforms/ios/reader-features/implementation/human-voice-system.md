# 人声朗读系统实现文档

## 1. 功能概述

### 1.1 功能边界

| 功能项 | 包含 | 不包含 |
|--------|------|--------|
| 音频源 | LibriVox/ThoughtAudio预录制音频 | AI合成语音 |
| 播放控制 | 播放/暂停/跳转/倍速 | 录音功能 |
| 同步功能 | 音频-文本位置映射 | 实时生成对齐 |
| 缓存管理 | 本地音频缓存/流式播放 | 云端存储 |

### 1.2 与TTS系统的区别

```
┌─────────────────────────────────────────────────────────┐
│                    朗读系统对比                          │
├─────────────────────────┬───────────────────────────────┤
│      TTS系统            │        人声系统               │
├─────────────────────────┼───────────────────────────────┤
│ AVSpeechSynthesizer     │ AVPlayer/AVAudioPlayer        │
│ 实时合成语音            │ 播放预录制音频                │
│ 逐句utterance生成       │ 完整章节音频文件              │
│ 字符级精确定位          │ 时间戳-位置映射表             │
│ 无需下载                │ 需下载/流式传输               │
│ 任意文本支持            │ 仅匹配书籍支持                │
└─────────────────────────┴───────────────────────────────┘
```

## 2. 系统架构

### 2.1 模块架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      HumanVoiceManager                          │
│                        (单例模式)                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │AudioPlayer  │  │SyncEngine   │  │ChapterManager           │  │
│  │ (播放引擎)  │  │ (同步引擎)  │  │ (章节管理)              │  │
│  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘  │
│         │                │                      │                │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌───────────┴───────────┐   │
│  │AVPlayer     │  │TimestampMap │  │AudioChapterInfo       │   │
│  │AVAudioSession│ │PositionSync │  │DownloadState          │   │
│  │TimeObserver │  │CFIMapper    │  │PlaybackProgress       │   │
│  └─────────────┘  └─────────────┘  └───────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │CacheManager │  │RemoteControl│  │NetworkManager          │  │
│  │ (缓存管理)  │  │ (远程控制)  │  │ (网络管理)             │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  音频源      │     │  处理层      │     │  输出层      │
│              │     │              │     │              │
│ LibriVox    ├────►│ 下载/缓存   ├────►│ AVPlayer    │
│ ThoughtAudio│     │ 解析时间戳   │     │ 锁屏控制    │
│ 本地缓存    │     │ 位置映射     │     │ 高亮同步    │
└──────────────┘     └──────────────┘     └──────────────┘
```

## 3. 音频资源管理

### 3.1 音频源数据模型

```
AudioBookInfo
├── bookId: String           // 书籍唯一标识
├── title: String            // 书籍标题
├── narrator: String         // 朗读者名称
├── totalDuration: Double    // 总时长(秒)
├── chapters: [AudioChapter] // 章节列表
├── source: AudioSource      // 来源(LibriVox/ThoughtAudio)
└── quality: AudioQuality    // 音质等级

AudioChapter
├── chapterId: String        // 章节ID
├── chapterIndex: Int        // 章节序号
├── title: String            // 章节标题
├── duration: Double         // 章节时长(秒)
├── audioURL: URL            // 音频文件URL
├── localPath: URL?          // 本地缓存路径
├── timestampMapURL: URL     // 时间戳映射文件URL
├── downloadState: DownloadState
└── fileSize: Int64          // 文件大小(bytes)

AudioSource
├── libriVox                 // LibriVox公版有声书
└── thoughtAudio             // ThoughtAudio来源

DownloadState
├── notDownloaded            // 未下载
├── downloading(progress: Double) // 下载中
├── downloaded               // 已下载
└── failed(error: Error)     // 下载失败
```

### 3.2 缓存策略

```
┌─────────────────────────────────────────────────────────┐
│                   缓存管理策略                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  优先级分层:                                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │ P0: 当前播放章节 (必须保留)                      │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ P1: 前后相邻章节 (预加载)                        │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ P2: 用户手动下载章节                             │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ P3: 最近播放章节 (LRU淘汰)                       │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  存储限制:                                              │
│  ├── 默认缓存上限: 500MB                               │
│  ├── 用户可配置: 200MB - 2GB                           │
│  └── 低存储空间自动清理: 设备剩余 < 1GB 时触发         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 下载管理流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 请求下载 │────►│ 检查缓存 │────►│ 网络下载 │────►│ 存储验证 │
└──────────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
                      │                │                │
                      ▼                ▼                ▼
                 ┌─────────┐     ┌─────────┐      ┌─────────┐
                 │ 命中    │     │ 进度回调│      │ 完成回调│
                 │ 直接使用│     │ 断点续传│      │ 校验文件│
                 └─────────┘     └─────────┘      └─────────┘
```

## 4. 播放引擎

### 4.1 AVPlayer配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| automaticallyWaitsToMinimizeStalling | true | 自动缓冲优化 |
| allowsExternalPlayback | false | 禁用AirPlay视频 |
| preventsDisplaySleepDuringVideoPlayback | false | 允许屏幕休眠 |

### 4.2 播放状态机

```
                    ┌─────────────┐
                    │   idle      │
                    │   (空闲)    │
                    └──────┬──────┘
                           │ load()
                           ▼
                    ┌─────────────┐
          ┌────────│  loading    │────────┐
          │        │  (加载中)   │        │
          │        └──────┬──────┘        │
          │ error         │ ready         │ timeout
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │   error     │ │   ready     │ │   error     │
   │   (错误)    │ │   (就绪)    │ │   (超时)    │
   └─────────────┘ └──────┬──────┘ └─────────────┘
                          │ play()
                          ▼
                   ┌─────────────┐
         ┌────────│  playing    │◄───────┐
         │        │  (播放中)   │        │
         │        └──────┬──────┘        │
         │               │               │
   pause()│        pause()│         resume()
         │               │               │
         │               ▼               │
         │        ┌─────────────┐        │
         └───────►│   paused    │────────┘
                  │   (暂停)    │
                  └──────┬──────┘
                         │ stop()
                         ▼
                  ┌─────────────┐
                  │  stopped    │
                  │  (停止)     │
                  └─────────────┘
```

### 4.3 时间观察器配置

```
TimeObserver配置
├── 进度更新间隔: 0.5秒 (用于UI进度条)
├── 同步更新间隔: 0.1秒 (用于高亮同步)
├── 边界观察: 章节结束前5秒预加载下一章节
└── 播放完成: 章节结束触发自动切换
```

### 4.4 倍速播放映射

| 用户选择 | AVPlayer rate | 实际效果 |
|----------|---------------|----------|
| 0.5x | 0.5 | 慢速 |
| 0.75x | 0.75 | 较慢 |
| 1.0x | 1.0 | 正常 |
| 1.25x | 1.25 | 较快 |
| 1.5x | 1.5 | 快速 |
| 2.0x | 2.0 | 倍速 |

## 5. 音频-文本同步

### 5.1 时间戳映射表结构

```
TimestampMap
├── version: String              // 映射表版本
├── chapterId: String            // 对应章节
├── totalDuration: Double        // 音频总时长
├── segments: [TimestampSegment] // 时间段列表
└── checksum: String             // 校验和

TimestampSegment
├── startTime: Double            // 开始时间(秒)
├── endTime: Double              // 结束时间(秒)
├── text: String                 // 对应文本内容
├── cfi: String                  // EPUB CFI位置
└── paragraphIndex: Int          // 段落索引
```

### 5.2 同步查找算法

```
┌─────────────────────────────────────────────────────────┐
│              时间戳 → 文本位置 查找                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  输入: currentTime (当前播放时间)                       │
│                                                         │
│  1. 二分查找定位segment                                 │
│     ├── 比较 startTime <= currentTime < endTime        │
│     └── 时间复杂度 O(log n)                            │
│                                                         │
│  2. 返回对应CFI位置                                     │
│     ├── 用于WebView滚动定位                            │
│     └── 用于高亮当前朗读文本                           │
│                                                         │
│  3. 缓存最近查找结果                                    │
│     └── 顺序播放时直接返回下一segment                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.3 文本位置 → 时间戳 查找

```
┌─────────────────────────────────────────────────────────┐
│              CFI位置 → 播放时间 查找                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  场景: 用户点击某段文字开始朗读                         │
│                                                         │
│  1. 解析CFI获取段落索引                                 │
│                                                         │
│  2. 在TimestampMap中查找                                │
│     ├── 按paragraphIndex匹配                           │
│     └── 返回对应startTime                              │
│                                                         │
│  3. seek到对应时间点                                    │
│     └── player.seek(to: targetTime)                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 6. 章节管理

### 6.1 章节切换流程

```
当前章节播放完成
        │
        ▼
┌───────────────────┐
│ 检查播放模式      │
└────────┬──────────┘
         │
    ┌────┴────┬────────────┐
    ▼         ▼            ▼
┌───────┐ ┌───────┐  ┌───────────┐
│单章节 │ │顺序播放│  │列表循环   │
│ 停止  │ │下一章 │  │ 回到首章  │
└───────┘ └───┬───┘  └─────┬─────┘
              │            │
              ▼            ▼
       ┌─────────────────────────┐
       │ 检查下一章节缓存状态    │
       └───────────┬─────────────┘
                   │
         ┌─────────┴─────────┐
         ▼                   ▼
    ┌─────────┐        ┌─────────┐
    │ 已缓存  │        │ 未缓存  │
    │ 直接播放│        │ 开始缓冲│
    └─────────┘        └─────────┘
```

### 6.2 预加载策略

| 触发条件 | 预加载内容 | 优先级 |
|----------|------------|--------|
| 开始播放某章节 | 下一章节音频 | 高 |
| 当前章节剩余30秒 | 下一章节时间戳映射 | 高 |
| WiFi环境 | 前后各2章节 | 中 |
| 用户手动选择 | 指定章节完整下载 | 最高 |

## 7. 远程控制与后台播放

### 7.1 锁屏信息显示

```
MPNowPlayingInfoCenter配置
├── MPMediaItemPropertyTitle: 章节标题
├── MPMediaItemPropertyArtist: 朗读者名称
├── MPMediaItemPropertyAlbumTitle: 书籍名称
├── MPMediaItemPropertyArtwork: 书籍封面
├── MPMediaItemPropertyPlaybackDuration: 章节时长
├── MPNowPlayingInfoPropertyElapsedPlaybackTime: 当前时间
├── MPNowPlayingInfoPropertyPlaybackRate: 播放速率
└── MPNowPlayingInfoPropertyDefaultPlaybackRate: 1.0
```

### 7.2 远程命令处理

| 命令 | 处理方式 |
|------|----------|
| playCommand | 继续播放 |
| pauseCommand | 暂停播放 |
| skipForwardCommand | 快进15秒 |
| skipBackwardCommand | 快退15秒 |
| nextTrackCommand | 下一章节 |
| previousTrackCommand | 上一章节/重新开始 |
| changePlaybackPositionCommand | 拖动进度条 |
| changePlaybackRateCommand | 调整倍速 |

## 8. 回调与事件

### 8.1 委托协议

```
HumanVoiceManagerDelegate
├── 状态回调
│   ├── didChangeState(old, new)      // 状态变化
│   └── didLoadChapter(chapter)       // 章节加载完成
│
├── 播放回调
│   ├── didUpdateProgress(time, duration) // 进度更新
│   ├── didFinishChapter(chapter)     // 章节播放完成
│   └── didChangeChapter(from, to)    // 章节切换
│
├── 同步回调
│   ├── didUpdatePosition(cfi)        // 位置更新(用于高亮同步)
│   └── didUpdateSegment(segment)     // 当前朗读段落更新
│
├── 下载回调
│   ├── didStartDownload(chapter)     // 开始下载
│   ├── didUpdateDownloadProgress(chapter, progress)
│   └── didFinishDownload(chapter, result)
│
└── 错误回调
    └── didEncounterError(error)      // 错误发生
```

## 9. 错误处理

### 9.1 错误类型

| 错误类型 | 原因 | 恢复策略 |
|----------|------|----------|
| audioNotFound | 音频资源不存在 | 提示用户/切换TTS |
| downloadFailed | 下载失败 | 重试/使用流式播放 |
| networkUnavailable | 无网络 | 播放已缓存/提示下载 |
| playbackFailed | 播放器错误 | 重新初始化播放器 |
| timestampMissing | 时间戳映射缺失 | 禁用同步功能 |
| corruptedCache | 缓存损坏 | 清除重新下载 |

### 9.2 降级策略

```
┌─────────────────────────────────────────────────────────┐
│                    降级流程                             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  人声播放失败                                           │
│       │                                                 │
│       ▼                                                 │
│  ┌─────────────────────────────────┐                   │
│  │ 询问用户: 切换到TTS朗读?       │                   │
│  └────────────┬────────────────────┘                   │
│               │                                         │
│       ┌───────┴───────┐                                │
│       ▼               ▼                                │
│    确认            取消                                 │
│       │               │                                │
│       ▼               ▼                                │
│  切换TTS         保持静默                               │
│  继续朗读        显示错误提示                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 10. 性能优化

### 10.1 内存管理

| 策略 | 实现方式 |
|------|----------|
| 音频缓冲限制 | AVPlayer preferredForwardBufferDuration = 30秒 |
| 时间戳映射懒加载 | 仅加载当前章节映射表 |
| 封面图片压缩 | 锁屏显示使用压缩版本 |
| 后台内存释放 | 进入后台释放UI相关资源 |

### 10.2 电量优化

| 策略 | 实现方式 |
|------|----------|
| 网络请求批量化 | 批量请求章节信息 |
| 后台下载 | 使用URLSessionConfiguration.background |
| 减少UI更新 | 后台时暂停非必要回调 |

## 11. API接口

### 11.1 对外提供

| 接口 | 说明 |
|------|------|
| loadBook(bookId:) | 加载有声书信息 |
| playChapter(chapterId:) | 播放指定章节 |
| playFromPosition(cfi:) | 从指定位置开始播放 |
| pause() | 暂停 |
| resume() | 继续 |
| seek(to:) | 跳转到指定时间 |
| setPlaybackRate(_:) | 设置播放速率 |
| downloadChapter(chapterId:) | 下载章节 |
| cancelDownload(chapterId:) | 取消下载 |
| deleteCache(chapterId:) | 删除缓存 |
| isBookAvailable(bookId:) | 检查书籍是否有人声版本 |

### 11.2 外部依赖

| 依赖项 | 用途 |
|--------|------|
| ReaderViewController | 获取当前阅读位置 |
| HighlightSyncManager | 同步当前朗读位置高亮 |
| NetworkService | 网络请求 |
| PersistenceManager | 下载状态持久化 |

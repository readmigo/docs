# iOS 状态管理

> @Observable + SwiftUI State + Combine

---

## 1. 状态管理概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    状态管理架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    View Layer                            │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │  @State   │  │ @Binding  │  │@Environment│           │    │
│  │  │  局部状态  │  │  双向绑定  │  │  环境值    │           │    │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘           │    │
│  └────────┼──────────────┼──────────────┼──────────────────┘    │
│           │              │              │                        │
│  ┌────────┴──────────────┴──────────────┴──────────────────┐    │
│  │                    ViewModel Layer                       │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │@Observable│  │@Published │  │  Combine  │           │    │
│  │  │ iOS 17+   │  │ 可观察属性 │  │  Publisher│           │    │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘           │    │
│  └────────┼──────────────┼──────────────┼──────────────────┘    │
│           │              │              │                        │
│  ┌────────┴──────────────┴──────────────┴──────────────────┐    │
│  │                    Data Layer                            │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐           │    │
│  │  │ SwiftData │  │ UserDef   │  │ Keychain  │           │    │
│  │  │  持久化   │  │  偏好设置  │  │  安全存储  │           │    │
│  │  └───────────┘  └───────────┘  └───────────┘           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. SwiftUI 状态属性

### 2.1 属性包装器对比

| 属性包装器 | 用途 | 生命周期 |
|-----------|------|----------|
| @State | 视图私有状态 | 视图生命周期 |
| @Binding | 双向数据绑定 | 父视图控制 |
| @StateObject | ViewModel 持有 | 视图生命周期 |
| @ObservedObject | ViewModel 引用 | 外部控制 |
| @EnvironmentObject | 环境共享 | App 生命周期 |
| @Environment | 系统环境值 | 系统控制 |
| @AppStorage | UserDefaults | 持久化 |

### 2.2 状态选择决策

```
┌─────────────────────────────────────────────────────────────────┐
│                    状态选择决策树                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  状态需要持久化?                                                 │
│       │                                                          │
│       ├── 是 ──▶ @AppStorage / SwiftData                       │
│       │                                                          │
│       └── 否                                                     │
│            │                                                     │
│            ▼                                                     │
│       状态需要跨视图共享?                                        │
│            │                                                     │
│            ├── 是 ──▶ @EnvironmentObject                       │
│            │                                                     │
│            └── 否                                                │
│                 │                                                │
│                 ▼                                                │
│            状态是复杂对象?                                       │
│                 │                                                │
│                 ├── 是 ──▶ @StateObject / @Observable          │
│                 │                                                │
│                 └── 否                                           │
│                      │                                           │
│                      ▼                                           │
│                 @State                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. @Observable (iOS 17+)

### 3.1 @Observable vs ObservableObject

| 特性 | @Observable | ObservableObject |
|------|-------------|------------------|
| 语法 | 宏标注 | 协议遵循 |
| 属性声明 | 自动追踪 | @Published |
| 性能 | 更精确更新 | 全对象更新 |
| iOS 版本 | 17+ | 13+ |

### 3.2 @Observable 数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                    @Observable 数据流                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  @Observable                                                    │
│  class ViewModel {                                              │
│      var books: [Book]         ◀── 自动追踪                     │
│      var selectedBook: Book?   ◀── 自动追踪                     │
│      var isLoading: Bool       ◀── 自动追踪                     │
│  }                                                              │
│                                                                  │
│  视图订阅                                                        │
│  ├── View A 使用 books        → 只响应 books 变化              │
│  ├── View B 使用 selectedBook → 只响应 selectedBook 变化       │
│  └── View C 使用 isLoading    → 只响应 isLoading 变化          │
│                                                                  │
│  优势                                                            │
│  ├── 更精确的视图更新                                            │
│  ├── 更少的不必要重绘                                            │
│  └── 更简洁的代码                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Combine 集成

### 4.1 Publisher 类型

| Publisher | 用途 |
|-----------|------|
| CurrentValueSubject | 有初始值的状态 |
| PassthroughSubject | 事件流 |
| @Published | 属性包装器 |
| Just | 单值发布 |
| Future | 异步单值 |

### 4.2 Combine 在 ViewModel 中的应用

```
┌─────────────────────────────────────────────────────────────────┐
│                    Combine 数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  网络请求                                                        │
│       │                                                          │
│       ▼                                                          │
│  URLSession.dataTaskPublisher                                   │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │   decode    │  JSON 解析                                     │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │    map      │  数据转换                                       │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  receive    │  切换到主线程                                   │
│  │  (on: Main) │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │   assign    │  赋值到 @Published                             │
│  └─────────────┘                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 全局状态管理

### 5.1 App 状态容器

```
┌─────────────────────────────────────────────────────────────────┐
│                    全局状态容器                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  AppState                                                       │
│  ├── AuthState                                                  │
│  │   ├── isLoggedIn: Bool                                      │
│  │   ├── currentUser: User?                                    │
│  │   └── accessToken: String?                                  │
│  │                                                              │
│  ├── ReaderState                                                │
│  │   ├── currentBook: Book?                                    │
│  │   ├── readingProgress: Double                               │
│  │   └── settings: ReaderSettings                              │
│  │                                                              │
│  ├── LibraryState                                               │
│  │   ├── books: [Book]                                         │
│  │   ├── categories: [Category]                                │
│  │   └── sortOrder: SortOrder                                  │
│  │                                                              │
│  └── SettingsState                                              │
│      ├── theme: Theme                                          │
│      ├── language: Language                                    │
│      └── notifications: Bool                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 状态注入

| 注入方式 | 适用场景 |
|----------|----------|
| Environment | 系统级配置 |
| EnvironmentObject | 共享状态 |
| 构造器注入 | 明确依赖 |
| 单例 | 全局服务 |

---

## 6. 阅读器状态

### 6.1 阅读器状态结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器状态                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ReaderViewModel                                                │
│  ├── 书籍状态                                                    │
│  │   ├── book: Book                                            │
│  │   ├── chapters: [Chapter]                                   │
│  │   └── currentChapterIndex: Int                              │
│  │                                                              │
│  ├── 阅读状态                                                    │
│  │   ├── currentPage: Int                                      │
│  │   ├── totalPages: Int                                       │
│  │   ├── progress: Double                                      │
│  │   └── readingTime: TimeInterval                             │
│  │                                                              │
│  ├── 显示状态                                                    │
│  │   ├── fontSize: CGFloat                                     │
│  │   ├── theme: ReaderTheme                                    │
│  │   ├── brightness: Double                                    │
│  │   └── isToolbarVisible: Bool                                │
│  │                                                              │
│  ├── 交互状态                                                    │
│  │   ├── selectedText: String?                                 │
│  │   ├── showDictionary: Bool                                  │
│  │   └── showNotes: Bool                                       │
│  │                                                              │
│  └── 加载状态                                                    │
│      ├── isLoading: Bool                                       │
│      ├── error: Error?                                         │
│      └── loadingProgress: Double                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 状态持久化

| 状态类型 | 存储位置 |
|----------|----------|
| 阅读进度 | SwiftData / CoreData |
| 阅读设置 | UserDefaults |
| 书签/笔记 | SwiftData / CoreData |
| 用户偏好 | UserDefaults |

---

## 7. 异步状态处理

### 7.1 加载状态模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    加载状态模式                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  enum LoadingState<T> {                                        │
│      case idle                                                  │
│      case loading                                               │
│      case success(T)                                            │
│      case failure(Error)                                        │
│  }                                                              │
│                                                                  │
│  使用示例                                                        │
│  ├── idle     → 显示初始 UI                                    │
│  ├── loading  → 显示加载指示器                                  │
│  ├── success  → 显示数据内容                                    │
│  └── failure  → 显示错误 UI + 重试按钮                         │
│                                                                  │
│  视图处理                                                        │
│  switch viewModel.booksState {                                 │
│  case .idle:                                                    │
│      EmptyView()                                                │
│  case .loading:                                                 │
│      ProgressView()                                             │
│  case .success(let books):                                     │
│      BookListView(books: books)                                │
│  case .failure(let error):                                     │
│      ErrorView(error: error, retry: viewModel.load)            │
│  }                                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 Task 生命周期管理

| 场景 | 处理方式 |
|------|----------|
| 视图出现 | .task { } |
| 值变化 | .task(id:) { } |
| 视图消失 | 自动取消 |
| 手动取消 | Task.cancel() |

---

## 8. 状态调试

### 8.1 调试工具

```
┌─────────────────────────────────────────────────────────────────┐
│                    状态调试工具                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SwiftUI 调试                                                    │
│  ├── Self._printChanges()                                      │
│  │   └── 打印视图重绘原因                                        │
│  │                                                              │
│  ├── Instruments: SwiftUI                                      │
│  │   └── 视图更新追踪                                            │
│  │                                                              │
│  └── View Hierarchy Debugger                                   │
│      └── 视图层级检查                                            │
│                                                                  │
│  Combine 调试                                                    │
│  ├── .print()                                                  │
│  │   └── 打印发布值                                              │
│  │                                                              │
│  ├── .handleEvents()                                           │
│  │   └── 生命周期事件                                            │
│  │                                                              │
│  └── .breakpoint()                                             │
│      └── 条件断点                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 常见问题排查

| 问题 | 排查方法 |
|------|----------|
| 视图不更新 | 检查 @Published / @Observable |
| 过度重绘 | 使用 _printChanges() |
| 内存泄漏 | 检查 [weak self] |
| 状态丢失 | 检查 @StateObject vs @ObservedObject |

---

## 9. 最佳实践

### 9.1 状态设计原则

```
┌─────────────────────────────────────────────────────────────────┐
│                    状态设计原则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  单一数据源                                                      │
│  ├── 每个状态只有一个来源                                        │
│  ├── 避免状态重复                                                │
│  └── 派生状态使用 computed property                             │
│                                                                  │
│  最小化状态                                                      │
│  ├── 只存储必要状态                                              │
│  ├── 可计算的不存储                                              │
│  └── 临时状态用 @State                                          │
│                                                                  │
│  状态提升                                                        │
│  ├── 共享状态提升到共同父视图                                    │
│  ├── 使用 @Binding 传递                                         │
│  └── 避免过度提升                                                │
│                                                                  │
│  不可变优先                                                      │
│  ├── 优先使用 struct                                            │
│  ├── 状态更新创建新实例                                          │
│  └── 便于 SwiftUI diff                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 性能优化

| 优化点 | 方法 |
|--------|------|
| 减少重绘 | 拆分小视图 |
| 精确更新 | 使用 @Observable |
| 避免阻塞 | 异步加载数据 |
| 内存优化 | 及时释放大对象 |

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [performance.md](./performance.md) | 性能优化 |
| [testing.md](./testing.md) | 测试策略 |

---

*最后更新: 2025-12-31*

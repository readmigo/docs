# iOS 测试策略

> XCTest + Quick/Nimble + XCUITest

---

## 1. 测试金字塔

```
┌─────────────────────────────────────────────────────────────────┐
│                      测试金字塔                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                         UI Tests                                │
│                        /         \                              │
│                       /  XCUITest  \                            │
│                      /   10% 占比   \                           │
│                     ─────────────────                           │
│                    /                   \                        │
│                   /  Integration Tests  \                       │
│                  /      20% 占比         \                      │
│                 ───────────────────────────                     │
│                /                           \                    │
│               /        Unit Tests           \                   │
│              /         70% 占比              \                  │
│             ─────────────────────────────────────               │
│                                                                  │
│  测试框架                                                        │
│  ├── XCTest          Apple 官方框架                             │
│  ├── Quick/Nimble    BDD 风格测试                              │
│  ├── Mockingbird     Mock 生成                                 │
│  └── SnapshotTesting 快照测试                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 测试工具

| 工具 | 用途 |
|------|------|
| XCTest | 单元测试框架 |
| XCUITest | UI 自动化测试 |
| Quick | BDD 测试框架 |
| Nimble | 断言库 |
| OHHTTPStubs | 网络请求 Mock |
| SnapshotTesting | UI 快照测试 |

---

## 3. 单元测试

### 3.1 ViewModel 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    ViewModel 测试                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  测试内容                                                        │
│  ├── 初始状态验证                                                │
│  ├── 用户操作响应                                                │
│  ├── 状态更新正确性                                              │
│  ├── 异步操作处理                                                │
│  └── 错误处理逻辑                                                │
│                                                                  │
│  Mock 依赖                                                       │
│  ├── Service Protocol Mock                                     │
│  ├── Repository Mock                                            │
│  └── 网络响应 Mock                                               │
│                                                                  │
│  异步测试                                                        │
│  ├── XCTestExpectation                                         │
│  ├── async/await 测试                                          │
│  └── Combine Publisher 测试                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Service 测试

| 测试点 | 说明 |
|--------|------|
| 业务逻辑 | 核心逻辑验证 |
| 数据转换 | 模型映射 |
| 缓存策略 | 缓存逻辑 |
| 错误处理 | 异常场景 |

---

## 4. 集成测试

### 4.1 网络测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    网络集成测试                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  OHHTTPStubs                                                    │
│  ├── 模拟 API 响应                                              │
│  ├── 验证请求格式                                                │
│  └── 测试错误处理                                                │
│                                                                  │
│  测试场景                                                        │
│  ├── 成功响应                                                    │
│  ├── 错误响应 (4xx, 5xx)                                        │
│  ├── 网络超时                                                    │
│  ├── 无网络                                                      │
│  └── 数据解析错误                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 存储测试

| 测试类型 | 说明 |
|----------|------|
| CoreData | 真实数据库测试 |
| UserDefaults | 偏好存储 |
| Keychain | 安全存储 |
| 文件系统 | 文件操作 |

---

## 5. UI 测试

### 5.1 XCUITest

```
┌─────────────────────────────────────────────────────────────────┐
│                    UI 测试结构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  测试步骤                                                        │
│  ├── 1. 启动应用                                                │
│  │   └── XCUIApplication().launch()                            │
│  │                                                              │
│  ├── 2. 查找元素                                                │
│  │   ├── app.buttons["Login"]                                  │
│  │   ├── app.textFields["Email"]                               │
│  │   └── app.staticTexts["Welcome"]                            │
│  │                                                              │
│  ├── 3. 执行操作                                                │
│  │   ├── element.tap()                                         │
│  │   ├── element.typeText("text")                              │
│  │   └── element.swipeUp()                                     │
│  │                                                              │
│  └── 4. 验证结果                                                │
│      ├── XCTAssertTrue(element.exists)                        │
│      └── XCTAssertEqual(element.label, "Expected")            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Accessibility ID

| 元素 | ID 规范 |
|------|---------|
| 按钮 | button_actionName |
| 输入框 | textField_fieldName |
| 标签 | label_labelName |
| 列表项 | cell_itemId |

---

## 6. 快照测试

### 6.1 SnapshotTesting

```
┌─────────────────────────────────────────────────────────────────┐
│                    快照测试                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  配置                                                            │
│  ├── 设备: iPhone 15 Pro                                        │
│  ├── 主题: Light / Dark                                         │
│  └── 尺寸: 固定 / 动态                                          │
│                                                                  │
│  测试视图                                                        │
│  ├── 组件快照                                                    │
│  ├── 屏幕快照                                                    │
│  └── 状态变化快照                                                │
│                                                                  │
│  策略                                                            │
│  ├── 首次运行生成基准                                            │
│  ├── 后续运行对比                                                │
│  └── 更新基准: 设置 record = true                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 快照配置

| 配置 | 说明 |
|------|------|
| 精度 | 0.99 (允许 1% 差异) |
| 设备 | iPhone 15 Pro |
| 方向 | Portrait |

---

## 7. 测试覆盖率

### 7.1 覆盖率目标

| 层级 | 目标 |
|------|------|
| ViewModel | 90%+ |
| Service | 85%+ |
| Utils | 80%+ |
| 整体 | 75%+ |

### 7.2 覆盖率报告

```
┌─────────────────────────────────────────────────────────────────┐
│                    覆盖率配置                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Xcode 配置                                                      │
│  ├── Edit Scheme → Test → Options                              │
│  ├── 勾选 "Gather coverage"                                    │
│  └── 选择目标 Target                                            │
│                                                                  │
│  排除项                                                          │
│  ├── App 入口文件                                               │
│  ├── SwiftUI Preview                                            │
│  ├── 生成的代码                                                  │
│  └── 第三方库                                                    │
│                                                                  │
│  报告查看                                                        │
│  └── Xcode → Report Navigator → Coverage                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. CI/CD 集成

### 8.1 测试流水线

```
┌─────────────────────────────────────────────────────────────────┐
│                    CI 测试流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PR 提交                                                         │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │   SwiftLint │  代码规范检查                                  │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │ Unit Tests  │  xcodebuild test                              │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  Coverage   │  生成覆盖率报告                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │    Build    │  xcodebuild build                             │
│  └─────────────┘                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 测试命令

| 命令 | 说明 |
|------|------|
| `xcodebuild test` | 运行所有测试 |
| `xcodebuild test-without-building` | 运行已构建测试 |
| `fastlane scan` | Fastlane 测试 |

---

## 9. 最佳实践

### 9.1 测试原则

```
┌─────────────────────────────────────────────────────────────────┐
│                    测试原则                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  FIRST 原则                                                      │
│  ├── Fast: 快速执行                                             │
│  ├── Independent: 相互独立                                      │
│  ├── Repeatable: 可重复                                         │
│  ├── Self-validating: 自验证                                   │
│  └── Timely: 及时编写                                           │
│                                                                  │
│  AAA 模式                                                        │
│  ├── Arrange: 准备数据                                          │
│  ├── Act: 执行操作                                              │
│  └── Assert: 验证结果                                           │
│                                                                  │
│  命名规范                                                        │
│  └── test_functionName_condition_expectedResult                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 常见问题

| 问题 | 解决方案 |
|------|----------|
| 异步测试超时 | 增加 timeout 时间 |
| 状态污染 | setUp/tearDown 清理 |
| 随机失败 | 避免依赖外部状态 |
| 执行慢 | 使用 Mock 替代真实调用 |

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [architecture.md](./architecture.md) | 架构设计 |
| [../shared/testing-strategy.md](../shared/testing-strategy.md) | 跨平台测试 |

---

*最后更新: 2025-12-31*

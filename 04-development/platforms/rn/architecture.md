# React Native 架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Presentation Layer                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Expo Router                           │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │ (auth)  │ │ (tabs)  │ │  book   │ │ modals  │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    UI Components                         │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │   ui/   │ │ layout/ │ │feedback/│ │  nav/   │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                        Feature Layer                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │  auth   │ │ reader  │ │audiobook│ │learning │ │   ai    │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ library │ │vocabulary│ │ social │ │settings │ │ search  │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                     State Management Layer                       │
│  ┌───────────────────────────┐ ┌───────────────────────────┐    │
│  │     Zustand Stores        │ │      React Query          │    │
│  │  ┌────────┐ ┌────────┐   │ │  ┌────────┐ ┌────────┐   │    │
│  │  │  auth  │ │settings│   │ │  │ books  │ │learning│   │    │
│  │  └────────┘ └────────┘   │ │  └────────┘ └────────┘   │    │
│  │  ┌────────┐ ┌────────┐   │ │  ┌────────┐ ┌────────┐   │    │
│  │  │ audio  │ │learning│   │ │  │  ai    │ │library │   │    │
│  │  └────────┘ └────────┘   │ │  └────────┘ └────────┘   │    │
│  └───────────────────────────┘ └───────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                       Services Layer                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │   API   │ │ Storage │ │   i18n  │ │RevenueCat│ │  Push   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                        Native Layer                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Expo SDK / React Native Core                │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## Feature 模块架构

每个 Feature 模块遵循统一结构：

```
features/
└── {feature-name}/
    ├── components/        # UI 组件
    │   ├── FeatureMain.tsx
    │   └── index.ts
    ├── stores/           # Zustand 状态
    │   └── featureStore.ts
    ├── services/         # API 服务
    │   └── featureApi.ts
    ├── hooks/            # 自定义 Hooks
    │   └── useFeature.ts
    ├── types/            # 类型定义
    │   └── index.ts
    └── index.ts          # Barrel Export
```

## 数据流架构

```
┌──────────────────────────────────────────────────────────────┐
│                        User Action                            │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                    Screen Component                           │
│                                                               │
│  ┌─────────────────┐    ┌─────────────────┐                  │
│  │   useQuery()    │    │  useStore()     │                  │
│  │ (Server State)  │    │ (Client State)  │                  │
│  └────────┬────────┘    └────────┬────────┘                  │
└───────────┼──────────────────────┼───────────────────────────┘
            │                      │
            ▼                      ▼
┌───────────────────────┐  ┌───────────────────────┐
│     React Query       │  │    Zustand Store      │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │  Query Cache    │  │  │  │    State        │  │
│  └─────────────────┘  │  │  └─────────────────┘  │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │   Mutations     │  │  │  │    Actions      │  │
│  └─────────────────┘  │  │  └─────────────────┘  │
└───────────┬───────────┘  │  ┌─────────────────┐  │
            │              │  │   Middleware    │  │
            ▼              │  │   (persist)     │  │
┌───────────────────────┐  │  └─────────────────┘  │
│      API Client       │  └───────────┬───────────┘
│  (Axios Instance)     │              │
└───────────┬───────────┘              ▼
            │              ┌───────────────────────┐
            ▼              │    AsyncStorage       │
┌───────────────────────┐  └───────────────────────┘
│    Backend API        │
│ api.readmigo.app      │
└───────────────────────┘
```

## Provider 层级

```
<QueryClientProvider>
  <ThemeProvider>
    <I18nextProvider>
      <AuthProvider>
        <GestureHandlerRootView>
          <BottomSheetModalProvider>
            <ExpoRouter />
          </BottomSheetModalProvider>
        </GestureHandlerRootView>
      </AuthProvider>
    </I18nextProvider>
  </ThemeProvider>
</QueryClientProvider>
```

## 模块依赖关系

```
                    ┌─────────────┐
                    │    auth     │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│    library    │  │   learning    │  │  subscriptions│
└───────┬───────┘  └───────┬───────┘  └───────────────┘
        │                  │
        ▼                  ▼
┌───────────────┐  ┌───────────────┐
│    reader     │  │  vocabulary   │
└───────┬───────┘  └───────────────┘
        │
        ▼
┌───────────────┐
│   audiobook   │
└───────────────┘
```

## 关键设计决策

### 1. Feature-First 架构

按功能域组织代码，而非技术类型：

| 优点 | 实现 |
|------|------|
| 高内聚 | 相关代码放在一起 |
| 低耦合 | 模块间依赖最小化 |
| 可扩展 | 新功能独立添加 |
| 可测试 | 模块可独立测试 |

### 2. 状态管理分离

| 状态类型 | 管理方案 | 示例 |
|----------|----------|------|
| Server State | React Query | 书籍列表、用户数据 |
| Client State | Zustand | 认证状态、设置 |
| UI State | useState | 表单、模态框 |

### 3. Expo Router 文件路由

| 路由模式 | 用途 | 示例 |
|----------|------|------|
| Group Routes | 逻辑分组 | `(auth)/`, `(tabs)/` |
| Dynamic Routes | 参数路由 | `book/[id].tsx` |
| Modal Routes | 全屏模态 | `book/reader.tsx` |

### 4. 持久化策略

| 数据类型 | 存储方案 | 原因 |
|----------|----------|------|
| 认证 Token | Secure Store | 安全性 |
| 用户设置 | AsyncStorage | 快速读写 |
| 复杂数据 | SQLite | 查询能力 |
| 缓存数据 | React Query | 自动管理 |

## 错误处理架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Error Boundary                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  App Root Error                        │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                      API Layer                               │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ Request Interceptor │  │ Response Interceptor│          │
│  │ (Token Injection)   │  │ (401 → Refresh)     │          │
│  └─────────────────────┘  └─────────────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    Query Layer                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  React Query Error Handling                          │    │
│  │  - onError callbacks                                 │    │
│  │  - Error states (isError, error)                     │    │
│  │  - Retry logic                                       │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│                     UI Layer                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Error UI Components                                 │    │
│  │  - Toast notifications                               │    │
│  │  - Error screens                                     │    │
│  │  - Retry buttons                                     │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Security Layers                           │
├─────────────────────────────────────────────────────────────┤
│  Transport Security                                          │
│  ├── HTTPS Only                                             │
│  └── Certificate Pinning (Recommended)                      │
├─────────────────────────────────────────────────────────────┤
│  Authentication                                              │
│  ├── JWT Token (Access + Refresh)                           │
│  ├── Token Storage (Expo Secure Store)                      │
│  └── Auto Token Refresh                                     │
├─────────────────────────────────────────────────────────────┤
│  Data Protection                                             │
│  ├── Sensitive Data → Secure Store                          │
│  ├── User Preferences → AsyncStorage                        │
│  └── No plaintext credentials                               │
├─────────────────────────────────────────────────────────────┤
│  OAuth Security                                              │
│  ├── PKCE Flow (Apple/Google)                               │
│  └── Secure Redirect Handling                               │
└─────────────────────────────────────────────────────────────┘
```

# 阅读器功能

## 功能概述

```
┌─────────────────────────────────────────────────────────────────┐
│                     Reader Feature                               │
├─────────────────────────────────────────────────────────────────┤
│  核心功能                                                        │
│  ├── EPUB 书籍阅读                                              │
│  ├── 阅读进度追踪                                                │
│  ├── 主题/字体定制                                               │
│  ├── 文本选择交互                                                │
│  └── 翻页/滚动浏览                                               │
└─────────────────────────────────────────────────────────────────┘
```

## 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                   Reader Architecture                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   ReaderScreen                             │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │                 EPUBReader                           │  │  │
│  │  │  ┌───────────────────────────────────────────────┐  │  │  │
│  │  │  │              WebView                           │  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  │         EPUB.js Rendering                     │  │  │  │
│  │  │  │                                               │  │  │  │
│  │  │  └───────────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              ReaderControls                         │  │  │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │  │  │
│  │  │  │ 章节   │ │  主题   │ │  字体   │ │  进度   │  │  │  │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 组件结构

```
┌─────────────────────────────────────────────────────────────────┐
│                   Component Structure                            │
├─────────────────────────────────────────────────────────────────┤
│  features/reader/                                                │
│  ├── components/                                                │
│  │   ├── EPUBReader.tsx         # WebView EPUB 渲染             │
│  │   ├── ReaderControls.tsx     # 控制面板                      │
│  │   ├── ChapterList.tsx        # 章节列表                      │
│  │   ├── ThemeSelector.tsx      # 主题选择                      │
│  │   ├── FontSettings.tsx       # 字体设置                      │
│  │   ├── ProgressBar.tsx        # 进度条                        │
│  │   └── SelectionMenu.tsx      # 文本选择菜单                   │
│  ├── hooks/                                                     │
│  │   ├── useReader.ts           # 阅读器状态                     │
│  │   └── useTextSelection.ts    # 文本选择                       │
│  ├── stores/                                                    │
│  │   └── readerStore.ts         # 阅读器状态管理                 │
│  └── types/                                                     │
│      └── index.ts               # 类型定义                       │
└─────────────────────────────────────────────────────────────────┘
```

## 状态管理

```
┌─────────────────────────────────────────────────────────────────┐
│                    Reader State                                  │
├─────────────────────────────────────────────────────────────────┤
│  readerStore                                                     │
│  ├── currentBook: Book | null                                   │
│  ├── currentChapter: number                                     │
│  ├── currentLocation: string (CFI)                              │
│  ├── progress: number (0-100)                                   │
│  ├── isLoading: boolean                                         │
│  ├── theme: ReaderTheme                                         │
│  ├── fontSize: number                                           │
│  ├── fontFamily: string                                         │
│  ├── lineSpacing: number                                        │
│  └── scrollMode: boolean                                        │
├─────────────────────────────────────────────────────────────────┤
│  Actions                                                         │
│  ├── loadBook(bookId)                                           │
│  ├── goToChapter(chapter)                                       │
│  ├── goToLocation(cfi)                                          │
│  ├── updateProgress(progress)                                   │
│  ├── setTheme(theme)                                            │
│  ├── setFontSize(size)                                          │
│  └── setFontFamily(family)                                      │
└─────────────────────────────────────────────────────────────────┘
```

## WebView 通信

```
┌─────────────────────────────────────────────────────────────────┐
│                WebView Communication                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  React Native                         WebView                    │
│  ┌─────────────┐                     ┌─────────────┐            │
│  │             │    postMessage      │             │            │
│  │  EPUBReader │ ─────────────────▶  │   EPUB.js   │            │
│  │             │                     │             │            │
│  │             │ ◀─────────────────  │             │            │
│  └─────────────┘    onMessage        └─────────────┘            │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│  RN → WebView Messages                                          │
│  ├── LOAD_BOOK: { url, location? }                              │
│  ├── GO_TO_CHAPTER: { chapter }                                 │
│  ├── GO_TO_LOCATION: { cfi }                                    │
│  ├── SET_THEME: { theme }                                       │
│  ├── SET_FONT_SIZE: { size }                                    │
│  └── SET_SCROLL_MODE: { enabled }                               │
├─────────────────────────────────────────────────────────────────┤
│  WebView → RN Messages                                          │
│  ├── BOOK_READY: { chapters, totalPages }                       │
│  ├── LOCATION_CHANGED: { cfi, progress }                        │
│  ├── TEXT_SELECTED: { text, cfi }                               │
│  ├── PAGE_CHANGED: { page, total }                              │
│  └── ERROR: { message }                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 阅读主题

```
┌─────────────────────────────────────────────────────────────────┐
│                    Reader Themes                                 │
├─────────────────────────────────────────────────────────────────┤
│  white (默认)                                                    │
│  ├── background: #FFFFFF                                        │
│  └── text: #1A1A1A                                              │
├─────────────────────────────────────────────────────────────────┤
│  sepia                                                           │
│  ├── background: #F4ECD8                                        │
│  └── text: #5B4636                                              │
├─────────────────────────────────────────────────────────────────┤
│  dark                                                            │
│  ├── background: #1C1C1E                                        │
│  └── text: #E5E5E5                                              │
├─────────────────────────────────────────────────────────────────┤
│  green                                                           │
│  ├── background: #E8F5E9                                        │
│  └── text: #2E7D32                                              │
├─────────────────────────────────────────────────────────────────┤
│  blue                                                            │
│  ├── background: #E3F2FD                                        │
│  └── text: #1565C0                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 字体设置

```
┌─────────────────────────────────────────────────────────────────┐
│                    Font Settings                                 │
├─────────────────────────────────────────────────────────────────┤
│  字号范围                                                        │
│  ├── 最小: 12                                                   │
│  ├── 默认: 16                                                   │
│  └── 最大: 28                                                   │
├─────────────────────────────────────────────────────────────────┤
│  字体选项                                                        │
│  ├── System (系统默认)                                          │
│  ├── Serif (衬线字体)                                           │
│  ├── Sans-Serif (无衬线)                                        │
│  └── Monospace (等宽)                                           │
├─────────────────────────────────────────────────────────────────┤
│  行距                                                            │
│  ├── 紧凑: 1.2                                                  │
│  ├── 标准: 1.5                                                  │
│  └── 宽松: 2.0                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 文本选择

```
┌─────────────────────────────────────────────────────────────────┐
│                   Text Selection                                 │
├─────────────────────────────────────────────────────────────────┤
│  选择流程                                                        │
│  1. 用户长按文本                                                 │
│  2. WebView 检测选择                                            │
│  3. 发送 TEXT_SELECTED 消息                                     │
│  4. 显示 SelectionMenu                                          │
├─────────────────────────────────────────────────────────────────┤
│  菜单选项                                                        │
│  ├── 查词 → AI 解释                                             │
│  ├── 翻译 → AI 翻译                                             │
│  ├── 保存 → 词汇本                                              │
│  ├── 高亮 → 添加标注                                            │
│  └── 复制 → 剪贴板                                              │
├─────────────────────────────────────────────────────────────────┤
│  选择数据                                                        │
│  {                                                              │
│    text: string,       // 选中文本                              │
│    cfi: string,        // 位置标识                              │
│    context: string,    // 上下文                                │
│    rect: Rect          // 位置信息                              │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 进度同步

```
┌─────────────────────────────────────────────────────────────────┐
│                   Progress Sync                                  │
├─────────────────────────────────────────────────────────────────┤
│  本地存储                                                        │
│  ├── 实时保存当前位置 (CFI)                                     │
│  ├── 保存进度百分比                                              │
│  └── 保存阅读时间                                                │
├─────────────────────────────────────────────────────────────────┤
│  服务器同步                                                      │
│  ├── 防抖处理 (5秒)                                             │
│  ├── 离线时本地存储                                              │
│  └── 联网时自动同步                                              │
├─────────────────────────────────────────────────────────────────┤
│  API                                                             │
│  PUT /library/books/:id/progress                                │
│  {                                                              │
│    location: string,    // CFI                                  │
│    progress: number,    // 0-100                                │
│    chapter: number,     // 章节号                               │
│    readingTime: number  // 本次阅读时间                          │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 阅读流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Reading Flow                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐                                                │
│  │ Book Detail │                                                │
│  └──────┬──────┘                                                │
│         │ 点击阅读                                               │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │ Load EPUB   │                                                │
│  │ URL/Content │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐     ┌─────────────┐                            │
│  │   WebView   │────▶│  Rendering  │                            │
│  │ Initialize  │     │   EPUB.js   │                            │
│  └──────┬──────┘     └──────┬──────┘                            │
│         │                   │                                    │
│         ▼                   │                                    │
│  ┌─────────────┐            │                                    │
│  │  Go To Last │◀───────────┘                                    │
│  │  Location   │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │   Reading   │                                                │
│  │   Session   │                                                │
│  └─────────────┘                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 手势交互

```
┌─────────────────────────────────────────────────────────────────┐
│                   Gesture Controls                               │
├─────────────────────────────────────────────────────────────────┤
│  翻页模式                                                        │
│  ├── 左滑: 下一页                                               │
│  ├── 右滑: 上一页                                               │
│  ├── 点击左侧: 上一页                                            │
│  └── 点击右侧: 下一页                                            │
├─────────────────────────────────────────────────────────────────┤
│  滚动模式                                                        │
│  ├── 上下滚动浏览                                                │
│  └── 惯性滚动                                                    │
├─────────────────────────────────────────────────────────────────┤
│  其他手势                                                        │
│  ├── 点击中央: 显示/隐藏控制栏                                   │
│  ├── 双击: 缩放 (可选)                                          │
│  └── 长按: 文本选择                                              │
└─────────────────────────────────────────────────────────────────┘
```

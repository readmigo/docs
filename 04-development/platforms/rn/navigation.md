# React Native 导航系统

## Expo Router 架构

Expo Router 基于文件系统的路由方案：

```
┌─────────────────────────────────────────────────────────────────┐
│                    File-based Routing                            │
├─────────────────────────────────────────────────────────────────┤
│  app/                                                            │
│  ├── _layout.tsx          → 根布局 (Providers)                   │
│  ├── index.tsx            → 入口重定向                           │
│  ├── (auth)/              → 认证路由组                           │
│  │   ├── _layout.tsx      → 认证布局                             │
│  │   ├── login.tsx        → /login                              │
│  │   └── onboarding.tsx   → /onboarding                         │
│  ├── (tabs)/              → Tab 路由组                           │
│  │   ├── _layout.tsx      → Tab 导航配置                         │
│  │   ├── library.tsx      → /library                            │
│  │   ├── discover.tsx     → /discover                           │
│  │   ├── learn.tsx        → /learn                              │
│  │   └── profile.tsx      → /profile                            │
│  ├── book/                                                       │
│  │   ├── [id].tsx         → /book/:id (动态路由)                 │
│  │   └── reader.tsx       → /book/reader (全屏模态)              │
│  ├── flashcard-review.tsx → /flashcard-review                   │
│  └── vocabulary-list.tsx  → /vocabulary-list                    │
└─────────────────────────────────────────────────────────────────┘
```

## 路由层级

```
┌─────────────────────────────────────────────────────────────────┐
│                        Root Layout                               │
│  (_layout.tsx)                                                   │
│  ├── QueryClientProvider                                        │
│  ├── ThemeProvider                                              │
│  ├── I18nextProvider                                            │
│  ├── AuthProvider                                               │
│  ├── GestureHandlerRootView                                     │
│  └── BottomSheetModalProvider                                   │
├─────────────────────────────────────────────────────────────────┤
│                       Route Groups                               │
│                                                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │
│  │    (auth)      │  │    (tabs)      │  │     book       │     │
│  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  │     │
│  │  │  login   │  │  │  │ library  │  │  │  │   [id]   │  │     │
│  │  └──────────┘  │  │  └──────────┘  │  │  └──────────┘  │     │
│  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  │     │
│  │  │onboarding│  │  │  │ discover │  │  │  │  reader  │  │     │
│  │  └──────────┘  │  │  └──────────┘  │  │  └──────────┘  │     │
│  └────────────────┘  │  ┌──────────┐  │  └────────────────┘     │
│                      │  │  learn   │  │                          │
│                      │  └──────────┘  │                          │
│                      │  ┌──────────┐  │                          │
│                      │  │ profile  │  │                          │
│                      │  └──────────┘  │                          │
│                      └────────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
```

## Tab 导航配置

```
┌─────────────────────────────────────────────────────────────────┐
│                      Bottom Tab Bar                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │  Library   │ │  Discover  │ │   Learn    │ │  Profile   │   │
│  │  library   │ │  compass   │ │  school    │ │  person    │   │
│  │  书架      │ │  发现       │ │  学习      │ │  我的      │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  配置项                                                          │
│  ├── tabBarActiveTintColor: primary                             │
│  ├── tabBarInactiveTintColor: gray                              │
│  ├── tabBarStyle: elevated                                      │
│  └── tabBarLabelStyle: size 12                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 路由类型

### 1. Group Routes (路由组)

```
(auth)/     → 认证相关页面分组
(tabs)/     → 主 Tab 页面分组

特点:
├── 括号内名称不出现在 URL
├── 共享布局和配置
└── 逻辑分组用途
```

### 2. Dynamic Routes (动态路由)

```
book/[id].tsx → /book/123, /book/456

特点:
├── 方括号表示动态参数
├── 通过 useLocalSearchParams 获取参数
└── 支持多个动态段
```

### 3. Modal Routes (模态路由)

```
book/reader.tsx → 全屏模态展示

配置:
├── presentation: 'modal' | 'fullScreenModal'
├── animation: 'slide_from_bottom'
└── gestureEnabled: true
```

## 导航流程

### 认证流程

```
┌───────────────┐
│   App Start   │
└───────┬───────┘
        │
        ▼
┌───────────────────────┐
│  Check Auth State     │
│  (Zustand Rehydrate)  │
└───────────┬───────────┘
            │
    ┌───────┴───────┐
    │               │
    ▼               ▼
┌────────┐     ┌────────┐
│ Guest  │     │ Authed │
└────┬───┘     └────┬───┘
     │              │
     ▼              ▼
┌────────────┐  ┌────────────┐
│  (tabs)/   │  │  (tabs)/   │
│  library   │  │  library   │
└────────────┘  └────────────┘
     │
     │ (需要完整功能)
     ▼
┌────────────┐
│  (auth)/   │
│  login     │
└────────────┘
```

### 阅读流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  Library   │────▶│Book Detail │────▶│   Reader   │
│  /library  │     │ /book/[id] │     │/book/reader│
└────────────┘     └────────────┘     └────────────┘
                        │
                        │ (返回)
                        ▼
                   ┌────────────┐
                   │  Library   │
                   └────────────┘
```

## 导航 API

### 路由跳转

```
方法                          用途
─────────────────────────────────────────────
router.push('/path')          推入新路由
router.replace('/path')       替换当前路由
router.back()                 返回上一页
router.canGoBack()            检查是否可返回
router.setParams({})          更新路由参数
```

### 参数传递

```
传递参数:
router.push({
  pathname: '/book/[id]',
  params: { id: '123' }
})

接收参数:
const { id } = useLocalSearchParams()
```

### Deep Linking

```
┌─────────────────────────────────────────────────────────────────┐
│                      Deep Link Schema                            │
├─────────────────────────────────────────────────────────────────┤
│  readmigo://                                                     │
│  ├── /book/:id           → 书籍详情                              │
│  ├── /book/reader        → 阅读器                                │
│  ├── /library            → 书架                                  │
│  ├── /discover           → 发现                                  │
│  └── /learn              → 学习                                  │
├─────────────────────────────────────────────────────────────────┤
│  Universal Links (iOS)                                           │
│  https://readmigo.app/book/:id                                  │
├─────────────────────────────────────────────────────────────────┤
│  App Links (Android)                                             │
│  https://readmigo.app/book/:id                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 页面配置

### Screen Options

```
┌─────────────────────────────────────────────────────────────────┐
│                      Screen Options                              │
├─────────────────────────────────────────────────────────────────┤
│  headerShown: boolean        → 显示/隐藏导航栏                   │
│  title: string               → 页面标题                          │
│  presentation: string        → 展示模式                          │
│  animation: string           → 转场动画                          │
│  gestureEnabled: boolean     → 手势返回                          │
│  headerStyle: object         → 导航栏样式                        │
│  headerTintColor: string     → 导航栏文字颜色                    │
│  headerBackVisible: boolean  → 返回按钮可见性                    │
└─────────────────────────────────────────────────────────────────┘
```

### 常用 Presentation 模式

```
模式                    效果
─────────────────────────────────────────────
card                    标准卡片推入
modal                   模态弹出 (iOS)
fullScreenModal         全屏模态
containedModal          容器内模态
containedTransparentModal  透明容器模态
transparentModal        透明模态
```

## 导航守卫

### 认证守卫

```
┌─────────────────────────────────────────────────────────────────┐
│                    Auth Guard Logic                              │
├─────────────────────────────────────────────────────────────────┤
│  1. _layout.tsx 中检查认证状态                                   │
│  2. 根据状态重定向:                                              │
│     ├── 已认证 → 允许访问受保护路由                              │
│     ├── 游客模式 → 部分功能受限                                  │
│     └── 未认证 → 重定向到登录                                    │
│  3. 使用 useSegments() 获取当前路由段                            │
│  4. 使用 router.replace() 进行重定向                             │
└─────────────────────────────────────────────────────────────────┘
```

### 重定向逻辑

```
检查点                        操作
─────────────────────────────────────────────────────
在 (auth) 组 + 已认证          → 重定向到 (tabs)
在 (tabs) 组 + 需要认证的功能   → 检查是否游客模式
在受保护页面 + 未认证          → 重定向到 login
```

## 转场动画

```
┌─────────────────────────────────────────────────────────────────┐
│                    Animation Types                               │
├─────────────────────────────────────────────────────────────────┤
│  default                 → 平台默认动画                          │
│  fade                    → 淡入淡出                              │
│  fade_from_bottom        → 从底部淡入                            │
│  flip                    → 翻转                                  │
│  simple_push             → 简单推入                              │
│  slide_from_bottom       → 从底部滑入                            │
│  slide_from_right        → 从右侧滑入                            │
│  slide_from_left         → 从左侧滑入                            │
│  none                    → 无动画                                │
└─────────────────────────────────────────────────────────────────┘
```

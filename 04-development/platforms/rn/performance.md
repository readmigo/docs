# React Native 性能优化

## 性能指标

```
┌─────────────────────────────────────────────────────────────────┐
│                   Performance Targets                            │
├─────────────────────────────────────────────────────────────────┤
│  启动性能                                                        │
│  ├── 冷启动: < 3s                                               │
│  ├── 热启动: < 1s                                               │
│  └── TTI (Time to Interactive): < 4s                            │
├─────────────────────────────────────────────────────────────────┤
│  运行时性能                                                      │
│  ├── 帧率: 60 FPS                                               │
│  ├── JS 线程: < 16ms/frame                                      │
│  └── UI 线程: < 16ms/frame                                      │
├─────────────────────────────────────────────────────────────────┤
│  内存                                                            │
│  ├── 初始内存: < 100MB                                          │
│  ├── 运行内存: < 200MB                                          │
│  └── 无内存泄漏                                                  │
├─────────────────────────────────────────────────────────────────┤
│  包大小                                                          │
│  ├── iOS: < 50MB                                                │
│  └── Android: < 30MB                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 性能架构

```
┌─────────────────────────────────────────────────────────────────┐
│                 React Native Threading                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────┐    Bridge    ┌───────────────┐               │
│  │   JS Thread   │◄────────────►│   UI Thread   │               │
│  │               │              │               │               │
│  │  React Logic  │              │  Native UI    │               │
│  │  State Mgmt   │              │  Animations   │               │
│  │  Business     │              │  Touch        │               │
│  └───────────────┘              └───────────────┘               │
│          │                              │                        │
│          │         ┌───────────────┐    │                        │
│          └────────►│ Shadow Thread │◄───┘                        │
│                    │   (Layout)    │                             │
│                    └───────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
```

## 渲染优化

### 避免不必要渲染

```
┌─────────────────────────────────────────────────────────────────┐
│               Render Optimization                                │
├─────────────────────────────────────────────────────────────────┤
│  React.memo                                                      │
│  ├── 用于纯展示组件                                              │
│  ├── 自定义比较函数 (可选)                                       │
│  └── 避免过度使用                                                │
├─────────────────────────────────────────────────────────────────┤
│  useMemo                                                         │
│  ├── 缓存计算结果                                                │
│  ├── 避免昂贵计算重复执行                                        │
│  └── 依赖数组必须准确                                            │
├─────────────────────────────────────────────────────────────────┤
│  useCallback                                                     │
│  ├── 缓存回调函数                                                │
│  ├── 传递给子组件时使用                                          │
│  └── 配合 React.memo 使用                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 列表优化

```
┌─────────────────────────────────────────────────────────────────┐
│                   List Optimization                              │
├─────────────────────────────────────────────────────────────────┤
│  FlashList (推荐)                                                │
│  ├── 替代 FlatList                                              │
│  ├── 更好的回收机制                                              │
│  └── 更高性能                                                    │
├─────────────────────────────────────────────────────────────────┤
│  FlatList 优化                                                   │
│  ├── keyExtractor: 唯一稳定 key                                 │
│  ├── getItemLayout: 固定高度时提供                              │
│  ├── initialNumToRender: 首屏数量                               │
│  ├── maxToRenderPerBatch: 批量渲染数                            │
│  ├── windowSize: 渲染窗口大小                                   │
│  ├── removeClippedSubviews: 移除不可见项                        │
│  └── renderItem 使用 memo                                       │
├─────────────────────────────────────────────────────────────────┤
│  参数推荐值                                                      │
│  ├── initialNumToRender: 10                                     │
│  ├── maxToRenderPerBatch: 10                                    │
│  ├── windowSize: 21                                             │
│  └── updateCellsBatchingPeriod: 50                              │
└─────────────────────────────────────────────────────────────────┘
```

## 动画优化

```
┌─────────────────────────────────────────────────────────────────┐
│                 Animation Optimization                           │
├─────────────────────────────────────────────────────────────────┤
│  Reanimated (推荐)                                               │
│  ├── 动画运行在 UI 线程                                          │
│  ├── 不阻塞 JS 线程                                             │
│  ├── 更流畅的动画                                                │
│  └── worklet 函数                                               │
├─────────────────────────────────────────────────────────────────┤
│  useAnimatedStyle                                                │
│  └── 在 UI 线程计算样式                                         │
├─────────────────────────────────────────────────────────────────┤
│  useSharedValue                                                  │
│  └── 跨线程共享动画值                                            │
├─────────────────────────────────────────────────────────────────┤
│  避免                                                            │
│  ├── Animated API (旧)                                          │
│  ├── useNativeDriver: false                                     │
│  └── 在动画中更新 state                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 图片优化

```
┌─────────────────────────────────────────────────────────────────┐
│                   Image Optimization                             │
├─────────────────────────────────────────────────────────────────┤
│  expo-image (推荐)                                               │
│  ├── 内置缓存                                                    │
│  ├── 占位符支持                                                  │
│  ├── 渐进式加载                                                  │
│  └── 更好的性能                                                  │
├─────────────────────────────────────────────────────────────────┤
│  优化策略                                                        │
│  ├── 使用适当尺寸                                                │
│  ├── 使用 WebP 格式                                             │
│  ├── 懒加载屏幕外图片                                            │
│  ├── 预加载关键图片                                              │
│  └── 设置 contentFit/resizeMode                                 │
├─────────────────────────────────────────────────────────────────┤
│  缓存策略                                                        │
│  ├── cachePolicy: 'memory-disk'                                 │
│  └── placeholder: 低分辨率占位图                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 状态管理优化

```
┌─────────────────────────────────────────────────────────────────┐
│              State Management Optimization                       │
├─────────────────────────────────────────────────────────────────┤
│  Zustand 优化                                                    │
│  ├── 使用 selector 订阅部分状态                                  │
│  ├── 避免订阅整个 store                                         │
│  ├── shallow 比较                                               │
│  └── Immer 不可变更新                                           │
├─────────────────────────────────────────────────────────────────┤
│  React Query 优化                                                │
│  ├── 合适的 staleTime                                           │
│  ├── 避免过度 refetch                                           │
│  ├── 使用 select 转换数据                                       │
│  └── 预取关键数据                                                │
├─────────────────────────────────────────────────────────────────┤
│  避免                                                            │
│  ├── 深层嵌套状态                                                │
│  ├── 频繁状态更新                                                │
│  └── 在 render 中创建新对象/数组                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 网络优化

```
┌─────────────────────────────────────────────────────────────────┐
│                  Network Optimization                            │
├─────────────────────────────────────────────────────────────────┤
│  请求优化                                                        │
│  ├── 请求合并                                                    │
│  ├── 数据预加载                                                  │
│  ├── 分页加载                                                    │
│  └── 请求取消                                                    │
├─────────────────────────────────────────────────────────────────┤
│  缓存策略                                                        │
│  ├── React Query 缓存                                           │
│  ├── AsyncStorage 持久化                                        │
│  ├── 离线优先策略                                                │
│  └── 后台同步                                                    │
├─────────────────────────────────────────────────────────────────┤
│  数据压缩                                                        │
│  ├── 服务端 gzip                                                │
│  └── 请求只需字段                                                │
└─────────────────────────────────────────────────────────────────┘
```

## 内存管理

```
┌─────────────────────────────────────────────────────────────────┐
│                  Memory Management                               │
├─────────────────────────────────────────────────────────────────┤
│  防止内存泄漏                                                    │
│  ├── useEffect 清理函数                                         │
│  ├── 取消未完成请求                                              │
│  ├── 移除事件监听                                                │
│  └── 清理定时器                                                  │
├─────────────────────────────────────────────────────────────────┤
│  内存优化                                                        │
│  ├── 图片按需加载                                                │
│  ├── 大列表虚拟化                                                │
│  ├── 及时释放资源                                                │
│  └── 避免闭包陷阱                                                │
├─────────────────────────────────────────────────────────────────┤
│  监控工具                                                        │
│  ├── React DevTools Profiler                                    │
│  ├── Xcode Instruments                                          │
│  └── Android Studio Profiler                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 启动优化

```
┌─────────────────────────────────────────────────────────────────┐
│                 Startup Optimization                             │
├─────────────────────────────────────────────────────────────────┤
│  JS Bundle 优化                                                  │
│  ├── 代码分割                                                    │
│  ├── 延迟加载非关键模块                                          │
│  ├── 减少依赖大小                                                │
│  └── Tree shaking                                               │
├─────────────────────────────────────────────────────────────────┤
│  初始化优化                                                      │
│  ├── 延迟非关键初始化                                            │
│  ├── 并行初始化                                                  │
│  └── 减少同步操作                                                │
├─────────────────────────────────────────────────────────────────┤
│  启动屏                                                          │
│  ├── expo-splash-screen                                         │
│  ├── 控制隐藏时机                                                │
│  └── 优化感知体验                                                │
└─────────────────────────────────────────────────────────────────┘
```

## 性能监控

```
┌─────────────────────────────────────────────────────────────────┐
│                Performance Monitoring                            │
├─────────────────────────────────────────────────────────────────┤
│  开发时                                                          │
│  ├── React DevTools Profiler                                    │
│  │   ├── 组件渲染次数                                           │
│  │   ├── 渲染耗时                                               │
│  │   └── 提交 (Commit) 分析                                     │
│  ├── Flipper                                                    │
│  │   ├── 性能面板                                               │
│  │   ├── 网络监控                                               │
│  │   └── 布局检查                                               │
│  └── __DEV__ 日志                                               │
├─────────────────────────────────────────────────────────────────┤
│  生产环境                                                        │
│  ├── Firebase Performance                                       │
│  ├── Sentry Performance                                         │
│  └── 自定义埋点                                                  │
├─────────────────────────────────────────────────────────────────┤
│  关键指标                                                        │
│  ├── App Start Time                                             │
│  ├── Screen Load Time                                           │
│  ├── API Response Time                                          │
│  └── Frame Rate                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 性能检查清单

```
┌─────────────────────────────────────────────────────────────────┐
│                 Performance Checklist                            │
├─────────────────────────────────────────────────────────────────┤
│  渲染                                                            │
│  □ 使用 React.memo 避免不必要渲染                                │
│  □ 使用 useMemo/useCallback                                     │
│  □ 避免在 render 中创建新引用                                    │
│  □ 列表使用 FlashList                                           │
├─────────────────────────────────────────────────────────────────┤
│  动画                                                            │
│  □ 使用 Reanimated                                              │
│  □ 动画运行在 UI 线程                                           │
│  □ 避免在动画中更新 state                                        │
├─────────────────────────────────────────────────────────────────┤
│  图片                                                            │
│  □ 使用正确尺寸                                                  │
│  □ 使用 expo-image                                              │
│  □ 启用缓存                                                      │
├─────────────────────────────────────────────────────────────────┤
│  状态                                                            │
│  □ 使用 selector 订阅                                           │
│  □ 合理的缓存策略                                                │
│  □ 避免过度更新                                                  │
├─────────────────────────────────────────────────────────────────┤
│  内存                                                            │
│  □ useEffect 清理                                               │
│  □ 取消请求                                                      │
│  □ 移除监听器                                                    │
└─────────────────────────────────────────────────────────────────┘
```

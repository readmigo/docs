# React Native 测试策略

## 测试架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Testing Pyramid                             │
├─────────────────────────────────────────────────────────────────┤
│                          ╱╲                                      │
│                         ╱  ╲                                     │
│                        ╱ E2E╲          10%                       │
│                       ╱──────╲                                   │
│                      ╱        ╲                                  │
│                     ╱Integration╲       20%                      │
│                    ╱────────────╲                                │
│                   ╱              ╲                               │
│                  ╱   Unit Tests   ╲      70%                     │
│                 ╱──────────────────╲                             │
└─────────────────────────────────────────────────────────────────┘
```

## 测试工具栈

```
┌─────────────────────────────────────────────────────────────────┐
│                    Testing Stack                                 │
├─────────────────────────────────────────────────────────────────┤
│  单元测试                                                        │
│  ├── Jest                        # 测试框架                      │
│  ├── @testing-library/react-native  # 组件测试                   │
│  └── jest-expo                   # Expo 集成                     │
├─────────────────────────────────────────────────────────────────┤
│  集成测试                                                        │
│  ├── @testing-library/react-native                              │
│  └── msw                         # API Mock                      │
├─────────────────────────────────────────────────────────────────┤
│  E2E 测试                                                        │
│  ├── Detox                       # React Native E2E              │
│  └── Maestro                     # 可选替代方案                   │
├─────────────────────────────────────────────────────────────────┤
│  其他工具                                                        │
│  ├── jest-mock                   # Mock 工具                     │
│  └── react-native-testing-library # 组件查询                     │
└─────────────────────────────────────────────────────────────────┘
```

## 测试文件结构

```
┌─────────────────────────────────────────────────────────────────┐
│                   Test File Structure                            │
├─────────────────────────────────────────────────────────────────┤
│  src/                                                            │
│  ├── components/                                                │
│  │   ├── Button.tsx                                             │
│  │   └── __tests__/                                             │
│  │       └── Button.test.tsx                                    │
│  ├── features/                                                  │
│  │   └── auth/                                                  │
│  │       ├── hooks/                                             │
│  │       │   ├── useAuth.ts                                     │
│  │       │   └── __tests__/                                     │
│  │       │       └── useAuth.test.ts                            │
│  │       └── stores/                                            │
│  │           ├── authStore.ts                                   │
│  │           └── __tests__/                                     │
│  │               └── authStore.test.ts                          │
│  └── utils/                                                     │
│      ├── format.ts                                              │
│      └── __tests__/                                             │
│          └── format.test.ts                                     │
├─────────────────────────────────────────────────────────────────┤
│  e2e/                                                            │
│  ├── auth.e2e.ts                                                │
│  ├── reader.e2e.ts                                              │
│  └── library.e2e.ts                                             │
└─────────────────────────────────────────────────────────────────┘
```

## Jest 配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    Jest Configuration                            │
├─────────────────────────────────────────────────────────────────┤
│  jest.config.js                                                  │
│  {                                                              │
│    preset: 'jest-expo',                                         │
│    setupFilesAfterEnv: [                                        │
│      '@testing-library/jest-native/extend-expect',              │
│      '<rootDir>/jest.setup.js'                                  │
│    ],                                                           │
│    transformIgnorePatterns: [                                   │
│      'node_modules/(?!((jest-)?react-native|                    │
│       @react-native(-community)?)|expo(nent)?|                  │
│       @expo(nent)?/.*|@expo-google-fonts/.*|                    │
│       react-navigation|@react-navigation/.*|                    │
│       @unimodules/.*|unimodules|sentry-expo|                    │
│       native-base|react-native-svg)'                            │
│    ],                                                           │
│    moduleNameMapper: {                                          │
│      '^@/(.*)$': '<rootDir>/src/$1',                            │
│      '^@components/(.*)$': '<rootDir>/src/components/$1',       │
│      // ... 其他别名                                             │
│    },                                                           │
│    collectCoverageFrom: [                                       │
│      'src/**/*.{ts,tsx}',                                       │
│      '!src/**/*.d.ts',                                          │
│      '!src/**/index.ts'                                         │
│    ],                                                           │
│    coverageThreshold: {                                         │
│      global: {                                                  │
│        branches: 70,                                            │
│        functions: 70,                                           │
│        lines: 70,                                               │
│        statements: 70                                           │
│      }                                                          │
│    }                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

## 单元测试

### 组件测试

```
┌─────────────────────────────────────────────────────────────────┐
│                   Component Testing                              │
├─────────────────────────────────────────────────────────────────┤
│  测试内容                                                        │
│  ├── 渲染正确性                                                  │
│  ├── Props 传递                                                 │
│  ├── 事件处理                                                    │
│  ├── 条件渲染                                                    │
│  └── 无障碍属性                                                  │
├─────────────────────────────────────────────────────────────────┤
│  常用 Queries                                                    │
│  ├── getByText          # 文本查询                              │
│  ├── getByTestId        # testID 查询                           │
│  ├── getByRole          # 角色查询                              │
│  ├── getByPlaceholder   # 占位符查询                            │
│  └── queryBy* / findBy* # 变体查询                              │
├─────────────────────────────────────────────────────────────────┤
│  常用 Actions                                                    │
│  ├── fireEvent.press()                                          │
│  ├── fireEvent.changeText()                                     │
│  ├── fireEvent.scroll()                                         │
│  └── waitFor()                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Hook 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                     Hook Testing                                 │
├─────────────────────────────────────────────────────────────────┤
│  使用 @testing-library/react-hooks                              │
│  ├── renderHook()       # 渲染 Hook                             │
│  ├── result.current     # 获取返回值                            │
│  ├── rerender()         # 重新渲染                              │
│  ├── waitFor()          # 等待异步                              │
│  └── act()              # 包装状态更新                          │
├─────────────────────────────────────────────────────────────────┤
│  测试场景                                                        │
│  ├── 初始状态                                                    │
│  ├── 状态更新                                                    │
│  ├── 异步操作                                                    │
│  ├── 错误处理                                                    │
│  └── 清理逻辑                                                    │
└─────────────────────────────────────────────────────────────────┘
```

### Store 测试

```
┌─────────────────────────────────────────────────────────────────┐
│                    Zustand Store Testing                         │
├─────────────────────────────────────────────────────────────────┤
│  测试模式                                                        │
│  ├── 直接调用 store actions                                     │
│  ├── 验证 state 变化                                            │
│  └── Mock 外部依赖                                              │
├─────────────────────────────────────────────────────────────────┤
│  重置 Store                                                      │
│  ├── beforeEach: store.setState(initialState)                   │
│  └── 或使用 store.getState().reset()                            │
├─────────────────────────────────────────────────────────────────┤
│  Mock 持久化                                                     │
│  └── jest.mock('@react-native-async-storage/async-storage')     │
└─────────────────────────────────────────────────────────────────┘
```

## 集成测试

```
┌─────────────────────────────────────────────────────────────────┐
│                   Integration Testing                            │
├─────────────────────────────────────────────────────────────────┤
│  测试范围                                                        │
│  ├── 屏幕完整流程                                                │
│  ├── 多组件交互                                                  │
│  ├── API 调用流程                                               │
│  └── 导航流程                                                    │
├─────────────────────────────────────────────────────────────────┤
│  MSW (Mock Service Worker)                                       │
│  ├── 拦截网络请求                                                │
│  ├── 返回模拟数据                                                │
│  └── 模拟错误场景                                                │
├─────────────────────────────────────────────────────────────────┤
│  Test Wrapper                                                    │
│  ├── QueryClientProvider                                        │
│  ├── NavigationContainer                                        │
│  └── 其他必要 Providers                                         │
└─────────────────────────────────────────────────────────────────┘
```

## E2E 测试 (Detox)

```
┌─────────────────────────────────────────────────────────────────┐
│                     Detox E2E Testing                            │
├─────────────────────────────────────────────────────────────────┤
│  配置                                                            │
│  ├── .detoxrc.js         # Detox 配置                           │
│  ├── Build 配置          # iOS/Android                          │
│  └── 测试设备配置                                                │
├─────────────────────────────────────────────────────────────────┤
│  常用 API                                                        │
│  ├── element(by.id('xxx'))       # 元素定位                     │
│  ├── element(by.text('xxx'))     # 文本定位                     │
│  ├── tap()                       # 点击                         │
│  ├── typeText()                  # 输入文本                     │
│  ├── scroll()                    # 滚动                         │
│  ├── waitFor().toBeVisible()     # 等待可见                     │
│  └── expect().toExist()          # 断言存在                     │
├─────────────────────────────────────────────────────────────────┤
│  测试场景                                                        │
│  ├── 登录流程                                                    │
│  ├── 书籍浏览                                                    │
│  ├── 阅读体验                                                    │
│  └── 词汇学习                                                    │
├─────────────────────────────────────────────────────────────────┤
│  运行命令                                                        │
│  ├── detox build --configuration ios.sim.debug                  │
│  └── detox test --configuration ios.sim.debug                   │
└─────────────────────────────────────────────────────────────────┘
```

## Mock 策略

```
┌─────────────────────────────────────────────────────────────────┐
│                     Mock Strategy                                │
├─────────────────────────────────────────────────────────────────┤
│  Native Modules                                                  │
│  ├── @react-native-async-storage/async-storage                  │
│  ├── expo-secure-store                                          │
│  ├── expo-av                                                    │
│  └── react-native-reanimated                                    │
├─────────────────────────────────────────────────────────────────┤
│  API Calls                                                       │
│  ├── jest.mock() for axios                                      │
│  └── MSW for integration tests                                  │
├─────────────────────────────────────────────────────────────────┤
│  Navigation                                                      │
│  └── jest.mock('@react-navigation/native')                      │
├─────────────────────────────────────────────────────────────────┤
│  jest.setup.js                                                   │
│  ├── Mock AsyncStorage                                          │
│  ├── Mock SecureStore                                           │
│  ├── Mock Reanimated                                            │
│  └── Silence console warnings                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 测试覆盖率

```
┌─────────────────────────────────────────────────────────────────┐
│                   Coverage Targets                               │
├─────────────────────────────────────────────────────────────────┤
│  整体目标                                                        │
│  ├── Statements: 70%                                            │
│  ├── Branches: 70%                                              │
│  ├── Functions: 70%                                             │
│  └── Lines: 70%                                                 │
├─────────────────────────────────────────────────────────────────┤
│  重点覆盖                                                        │
│  ├── Stores: 90%+                                               │
│  ├── Hooks: 80%+                                                │
│  ├── Utils: 90%+                                                │
│  └── UI Components: 70%+                                        │
├─────────────────────────────────────────────────────────────────┤
│  覆盖率报告                                                      │
│  ├── npm run test:coverage                                      │
│  └── coverage/lcov-report/index.html                            │
└─────────────────────────────────────────────────────────────────┘
```

## CI/CD 集成

```
┌─────────────────────────────────────────────────────────────────┐
│                    CI Test Pipeline                              │
├─────────────────────────────────────────────────────────────────┤
│  Pull Request                                                    │
│  ├── npm run lint                                               │
│  ├── npm run typecheck                                          │
│  ├── npm test -- --coverage                                     │
│  └── 覆盖率报告上传                                              │
├─────────────────────────────────────────────────────────────────┤
│  Main Branch                                                     │
│  ├── 所有 PR 检查                                               │
│  └── E2E 测试 (可选)                                            │
├─────────────────────────────────────────────────────────────────┤
│  Release                                                         │
│  ├── 完整测试套件                                                │
│  ├── E2E 测试                                                   │
│  └── 性能测试                                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 最佳实践

```
┌─────────────────────────────────────────────────────────────────┐
│                    Best Practices                                │
├─────────────────────────────────────────────────────────────────┤
│  命名                                                            │
│  ├── describe: 功能/组件名称                                    │
│  ├── it/test: should + 行为描述                                 │
│  └── 文件: *.test.ts(x)                                         │
├─────────────────────────────────────────────────────────────────┤
│  组织                                                            │
│  ├── Arrange: 准备数据和环境                                    │
│  ├── Act: 执行操作                                              │
│  └── Assert: 验证结果                                           │
├─────────────────────────────────────────────────────────────────┤
│  原则                                                            │
│  ├── 测试行为，不测实现                                          │
│  ├── 一个测试一个断言                                            │
│  ├── 测试独立，无依赖                                            │
│  ├── 使用 testID 而非内部属性                                   │
│  └── 避免测试第三方库                                            │
└─────────────────────────────────────────────────────────────────┘
```

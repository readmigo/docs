# Web 错误处理

> 分层错误边界 + 统一错误处理 + 用户友好提示

---

## 1. 错误处理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误处理层级                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Layer 1: 全局错误边界                                           │
│  └── app/error.tsx                                              │
│      ├── 捕获未处理的运行时错误                                   │
│      ├── 显示全局错误页面                                        │
│      └── 提供重试选项                                            │
│                                                                  │
│  Layer 2: 布局级错误边界                                         │
│  └── app/(main)/error.tsx                                       │
│      ├── 捕获特定布局组的错误                                    │
│      └── 保持全局导航可用                                        │
│                                                                  │
│  Layer 3: 功能级错误边界                                         │
│  └── features/*/components/ErrorBoundary.tsx                    │
│      ├── 捕获特定功能的错误                                      │
│      └── 显示功能级错误 UI                                       │
│                                                                  │
│  Layer 4: 组件级错误处理                                         │
│  └── try/catch + Error State                                    │
│      ├── 处理预期错误                                            │
│      └── 显示内联错误信息                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 错误类型

### 2.1 错误分类

| 类型 | 说明 | 处理方式 |
|------|------|----------|
| 网络错误 | 请求失败、超时 | 重试 + 离线提示 |
| 认证错误 | Token 过期、无权限 | 重定向登录 |
| 验证错误 | 表单输入无效 | 显示字段错误 |
| 业务错误 | 后端返回的业务错误 | 显示错误消息 |
| 运行时错误 | JS 运行时异常 | 错误边界捕获 |

### 2.2 HTTP 错误码处理

| 状态码 | 含义 | 处理 |
|--------|------|------|
| 400 | 请求无效 | 显示验证错误 |
| 401 | 未认证 | 重定向登录 |
| 403 | 无权限 | 显示权限提示 |
| 404 | 资源不存在 | 显示 404 页面 |
| 429 | 请求过多 | 显示限流提示 |
| 500 | 服务器错误 | 显示通用错误 |

---

## 3. API 错误处理

### 3.1 错误响应格式

```
┌─────────────────────────────────────────────────────────────────┐
│                    API 错误响应结构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  标准错误响应                                                    │
│  {                                                              │
│    "error": {                                                   │
│      "code": "BOOK_NOT_FOUND",                                 │
│      "message": "Book with ID xxx not found",                  │
│      "details": { ... }                                        │
│    }                                                            │
│  }                                                              │
│                                                                  │
│  验证错误响应                                                    │
│  {                                                              │
│    "error": {                                                   │
│      "code": "VALIDATION_ERROR",                               │
│      "message": "Validation failed",                           │
│      "details": {                                               │
│        "fields": {                                              │
│          "email": "Invalid email format",                      │
│          "password": "Password too short"                      │
│        }                                                        │
│      }                                                          │
│    }                                                            │
│  }                                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 拦截器错误处理

```
┌─────────────────────────────────────────────────────────────────┐
│                    Axios 拦截器流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  API 请求                                                        │
│       │                                                          │
│       ▼                                                          │
│  请求拦截器                                                      │
│  ├── 附加 Authorization Header                                  │
│  └── 添加请求 ID                                                │
│       │                                                          │
│       ▼                                                          │
│  发送请求                                                        │
│       │                                                          │
│       ▼                                                          │
│  响应拦截器                                                      │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 成功      失败                                                   │
│  │         │                                                    │
│  │    ┌────┴────┐                                               │
│  │    │         │                                               │
│  │    ▼         ▼                                               │
│  │   401       其他                                              │
│  │    │         │                                               │
│  │    ▼         ▼                                               │
│  │   刷新 Token  抛出错误                                        │
│  │    │                                                         │
│  │    ▼                                                         │
│  │   重试请求                                                    │
│  │                                                              │
│  └────────────────────────────────────────────────────────────┘
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. TanStack Query 错误处理

### 4.1 Query 错误处理

| 配置 | 说明 |
|------|------|
| retry | 自动重试次数 (默认 3) |
| retryDelay | 重试延迟 (指数退避) |
| useErrorBoundary | 是否抛给错误边界 |

### 4.2 Mutation 错误处理

```
┌─────────────────────────────────────────────────────────────────┐
│                    Mutation 错误处理模式                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  useMutation 配置                                               │
│                                                                  │
│  onError 回调                                                   │
│  ├── 记录错误日志                                                │
│  ├── 显示 Toast 提示                                            │
│  └── 回滚乐观更新                                                │
│                                                                  │
│  错误状态使用                                                    │
│  ├── isError: 是否出错                                          │
│  ├── error: 错误对象                                            │
│  └── reset: 重置错误状态                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 表单错误处理

### 5.1 Zod 验证错误

| 错误类型 | 处理 |
|----------|------|
| 字段验证失败 | 显示字段下方错误 |
| 自定义验证 | 显示自定义消息 |
| 异步验证 | 显示加载 + 错误 |

### 5.2 服务端验证错误

```
┌─────────────────────────────────────────────────────────────────┐
│                    表单错误映射                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  服务端返回验证错误                                              │
│       │                                                          │
│       ▼                                                          │
│  解析错误响应                                                    │
│       │                                                          │
│       ▼                                                          │
│  setError() 映射到表单字段                                       │
│       │                                                          │
│       ▼                                                          │
│  显示字段级错误                                                  │
│                                                                  │
│  通用错误 (非字段级)                                             │
│       │                                                          │
│       ▼                                                          │
│  显示表单顶部错误提示                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 用户反馈

### 6.1 Toast 通知

| 类型 | 用途 | 持续时间 |
|------|------|----------|
| success | 操作成功 | 3s |
| error | 操作失败 | 5s |
| warning | 警告提示 | 4s |
| info | 信息提示 | 3s |

### 6.2 错误页面内容

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误页面要素                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  必要元素                                                        │
│  ├── 错误图标/插图                                               │
│  ├── 友好的错误标题                                              │
│  ├── 简洁的错误描述                                              │
│  └── 操作按钮 (重试/返回首页)                                    │
│                                                                  │
│  可选元素                                                        │
│  ├── 错误代码 (便于排查)                                         │
│  ├── 帮助链接                                                    │
│  └── 联系支持入口                                                │
│                                                                  │
│  避免                                                            │
│  ├── 技术细节 (堆栈跟踪)                                         │
│  ├── 敏感信息                                                    │
│  └── 指责用户的措辞                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 错误监控

### 7.1 Sentry 集成

| 功能 | 说明 |
|------|------|
| 自动捕获 | 未处理异常自动上报 |
| 用户上下文 | 附加用户信息 |
| 面包屑 | 操作轨迹追踪 |
| 性能监控 | 事务追踪 |

### 7.2 错误上报内容

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误上报数据                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  基础信息                                                        │
│  ├── 错误类型                                                    │
│  ├── 错误消息                                                    │
│  ├── 堆栈跟踪                                                    │
│  └── 发生时间                                                    │
│                                                                  │
│  上下文信息                                                      │
│  ├── 用户 ID (脱敏)                                              │
│  ├── 当前页面                                                    │
│  ├── 浏览器/设备信息                                             │
│  └── 最近操作轨迹                                                │
│                                                                  │
│  业务信息                                                        │
│  ├── 功能模块                                                    │
│  ├── API 端点                                                   │
│  └── 请求参数 (脱敏)                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 离线错误处理

### 8.1 网络状态检测

| 状态 | 处理 |
|------|------|
| 离线 | 显示离线提示 + 使用缓存 |
| 恢复在线 | 同步离线操作队列 |
| 弱网络 | 显示加载状态 + 超时提示 |

### 8.2 离线队列

```
┌─────────────────────────────────────────────────────────────────┐
│                    离线操作队列                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  离线时                                                          │
│  ├── 保存操作到 IndexedDB                                        │
│  ├── 显示"已保存，待同步"提示                                    │
│  └── 本地状态乐观更新                                            │
│                                                                  │
│  恢复在线                                                        │
│  ├── 自动重试队列中的操作                                        │
│  ├── 按顺序执行                                                  │
│  ├── 冲突处理 (服务端优先)                                       │
│  └── 同步完成通知                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [monitoring.md](./monitoring.md) | 监控告警 |
| [testing.md](./testing.md) | 错误场景测试 |
| [../shared/error-codes.md](../shared/error-codes.md) | 错误码定义 |

---

*最后更新: 2025-12-31*

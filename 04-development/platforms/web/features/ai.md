# Web AI 功能模块

> 智能查词、翻译、问答、学习建议

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                      AI 模块架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  features/ai/                                                   │
│  ├── components/                                                │
│  │   ├── AIPanel.tsx          AI 面板容器                       │
│  │   ├── WordLookup.tsx       查词组件                          │
│  │   ├── Translator.tsx       翻译组件                          │
│  │   ├── QAChat.tsx           问答对话                          │
│  │   └── SentenceAnalysis.tsx 句子分析                          │
│  ├── hooks/                                                     │
│  │   ├── useAI.ts             AI 主 Hook                        │
│  │   ├── useLookup.ts         查词 Hook                         │
│  │   ├── useTranslate.ts      翻译 Hook                         │
│  │   └── useStreaming.ts      流式响应                          │
│  ├── stores/                                                    │
│  │   └── aiStore.ts           AI 状态                           │
│  └── types/                                                     │
│      └── index.ts             类型定义                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 功能矩阵

### 2.1 AI 功能列表

| 功能 | 说明 | 触发方式 |
|------|------|----------|
| 智能查词 | 单词解释+例句+发音 | 选中单词 |
| 智能翻译 | 段落翻译 | 选中文本 |
| 句子分析 | 语法结构分析 | 选中句子 |
| 问答对话 | 上下文问答 | 手动输入 |
| 摘要生成 | 章节/书籍摘要 | 手动触发 |
| 学习建议 | 个性化学习建议 | 自动推荐 |

### 2.2 功能详情

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 功能详情                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  智能查词                                                        │
│  ├── 基础释义 (词性、发音、中文)                                 │
│  ├── 语境释义 (基于上下文)                                       │
│  ├── 例句展示                                                    │
│  ├── 词根词缀分析                                                │
│  ├── 同义词/反义词                                               │
│  └── 发音播放 (TTS)                                             │
│                                                                  │
│  智能翻译                                                        │
│  ├── 段落级翻译                                                  │
│  ├── 保留原文对照                                                │
│  ├── 多语言支持                                                  │
│  └── 翻译质量评估                                                │
│                                                                  │
│  句子分析                                                        │
│  ├── 语法结构树                                                  │
│  ├── 主谓宾标注                                                  │
│  ├── 从句分析                                                    │
│  └── 难点解释                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 技术实现

### 3.1 API 调用流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI API 调用流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户选中文本                                                    │
│       │                                                          │
│       ▼                                                          │
│  客户端预处理                                                    │
│  ├── 提取上下文                                                  │
│  ├── 识别操作类型                                                │
│  └── 构建请求                                                    │
│       │                                                          │
│       ▼                                                          │
│  Server Action                                                  │
│  ├── 验证用户权限                                                │
│  ├── 检查配额                                                    │
│  └── 调用 AI 服务                                                │
│       │                                                          │
│       ▼                                                          │
│  AI 服务 (OpenAI/Claude)                                        │
│       │                                                          │
│       ▼                                                          │
│  流式响应返回                                                    │
│       │                                                          │
│       ▼                                                          │
│  客户端渲染结果                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 流式响应处理

| 状态 | UI 表现 |
|------|---------|
| 开始 | 显示加载动画 |
| 接收中 | 逐字显示内容 |
| 完成 | 显示完整结果 |
| 错误 | 显示错误提示 + 重试 |

---

## 4. 配额管理

### 4.1 配额规则

| 用户类型 | 每日配额 | 功能限制 |
|----------|----------|----------|
| 免费用户 | 20 次 | 基础查词/翻译 |
| 订阅用户 | 无限制 | 全部功能 |
| 试用用户 | 50 次 | 全部功能 (7天) |

### 4.2 配额计算

```
┌─────────────────────────────────────────────────────────────────┐
│                    配额计算规则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  单次调用消耗                                                    │
│  ├── 查词: 1 次                                                 │
│  ├── 翻译: 1 次 (≤100字) / 2 次 (>100字)                       │
│  ├── 句子分析: 1 次                                             │
│  ├── 问答: 2 次                                                 │
│  └── 摘要: 5 次                                                 │
│                                                                  │
│  配额重置                                                        │
│  └── 每日 UTC 0:00 重置                                         │
│                                                                  │
│  超额处理                                                        │
│  ├── 提示升级订阅                                                │
│  └── 显示剩余配额                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Prompt 工程

### 5.1 查词 Prompt 结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    查词 Prompt                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  System                                                         │
│  └── 角色设定: 英语教学专家                                      │
│                                                                  │
│  User                                                           │
│  ├── 单词: {word}                                               │
│  ├── 上下文: {context}                                          │
│  ├── 书籍: {book_title}                                         │
│  └── 用户水平: {level}                                          │
│                                                                  │
│  输出格式                                                        │
│  ├── 发音 (IPA)                                                 │
│  ├── 词性                                                        │
│  ├── 语境释义                                                    │
│  ├── 基础释义                                                    │
│  ├── 例句 (2-3个)                                               │
│  └── 相关词汇                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 翻译 Prompt 结构

| 元素 | 说明 |
|------|------|
| 源语言 | 自动检测 |
| 目标语言 | 用户设置 |
| 风格 | 保持原文风格 |
| 上下文 | 前后段落 |
| 术语 | 书籍领域术语 |

---

## 6. 缓存策略

### 6.1 缓存规则

| 内容类型 | 缓存时间 | 缓存位置 |
|----------|----------|----------|
| 单词查询 | 7 天 | 服务端 + IndexedDB |
| 翻译结果 | 7 天 | 服务端 + IndexedDB |
| 句子分析 | 3 天 | IndexedDB |
| 问答历史 | 不缓存 | - |

### 6.2 缓存键设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    缓存键设计                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  查词缓存                                                        │
│  └── lookup:{word}:{context_hash}:{level}                       │
│                                                                  │
│  翻译缓存                                                        │
│  └── translate:{text_hash}:{source_lang}:{target_lang}          │
│                                                                  │
│  句子分析缓存                                                    │
│  └── analysis:{sentence_hash}                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 错误处理

### 7.1 错误类型

| 错误 | 处理方式 |
|------|----------|
| 网络错误 | 重试 + 离线提示 |
| 配额超限 | 提示升级 |
| API 错误 | 降级处理 |
| 超时 | 重试 (最多 2 次) |

### 7.2 降级策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    降级策略                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  主服务不可用                                                    │
│       │                                                          │
│       ▼                                                          │
│  尝试备用服务                                                    │
│       │                                                          │
│       ▼                                                          │
│  备用服务不可用                                                  │
│       │                                                          │
│       ▼                                                          │
│  使用本地词典 (仅查词)                                           │
│       │                                                          │
│       ▼                                                          │
│  显示离线提示                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 隐私保护

### 8.1 数据处理原则

| 数据 | 处理方式 |
|------|----------|
| 选中文本 | 仅用于当次请求 |
| 上下文 | 最小化传输 |
| 查询历史 | 可选择不记录 |
| 学习数据 | 加密存储 |

### 8.2 敏感内容过滤

```
┌─────────────────────────────────────────────────────────────────┐
│                    内容过滤流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户输入                                                        │
│       │                                                          │
│       ▼                                                          │
│  敏感词检测                                                      │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 安全      不安全                                                 │
│  │         │                                                    │
│  │         ▼                                                    │
│  │    拒绝处理                                                   │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ AI 处理   显示提示                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [reader.md](./reader.md) | 阅读器集成 |
| [learning.md](./learning.md) | 学习功能 |
| [../state-management.md](../state-management.md) | 状态管理 |

---

*最后更新: 2025-12-31*

# Web 离线模块

> PWA 离线支持、书籍缓存、同步队列

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                      离线模块架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  features/offline/                                              │
│  ├── components/                                                │
│  │   ├── OfflineIndicator.tsx  离线状态指示                     │
│  │   ├── DownloadManager.tsx   下载管理器                       │
│  │   ├── SyncStatus.tsx        同步状态                         │
│  │   └── StorageInfo.tsx       存储信息                         │
│  ├── hooks/                                                     │
│  │   ├── useOffline.ts         离线状态 Hook                    │
│  │   ├── useDownload.ts        下载 Hook                        │
│  │   ├── useSync.ts            同步 Hook                        │
│  │   └── useStorage.ts         存储 Hook                        │
│  ├── stores/                                                    │
│  │   └── offlineStore.ts       离线状态                         │
│  └── utils/                                                     │
│      ├── idb.ts                IndexedDB 封装                   │
│      └── sync-queue.ts         同步队列                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 离线能力

### 2.1 功能支持矩阵

| 功能 | 离线支持 | 说明 |
|------|----------|------|
| 已下载书籍阅读 | ✅ | 完全支持 |
| 阅读进度保存 | ✅ | 本地保存，在线同步 |
| 书签管理 | ✅ | 本地保存，在线同步 |
| 高亮笔记 | ✅ | 本地保存，在线同步 |
| 词汇学习 | ✅ | 本地数据 |
| 书架浏览 | ⚠️ | 缓存数据 |
| 书籍搜索 | ❌ | 需联网 |
| AI 功能 | ❌ | 需联网 |
| 新书下载 | ❌ | 需联网 |

### 2.2 离线检测

```
┌─────────────────────────────────────────────────────────────────┐
│                    网络状态检测                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  检测方式                                                        │
│  ├── navigator.onLine                                           │
│  ├── online/offline 事件                                        │
│  └── 心跳检测 (API ping)                                        │
│                                                                  │
│  状态类型                                                        │
│  ├── online: 完全在线                                           │
│  ├── offline: 完全离线                                          │
│  └── limited: 弱网络                                            │
│                                                                  │
│  UI 反馈                                                        │
│  ├── 状态栏指示器                                                │
│  ├── Toast 提示                                                 │
│  └── 功能降级提示                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 书籍下载

### 3.1 下载流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    书籍下载流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  点击下载                                                        │
│       │                                                          │
│       ▼                                                          │
│  检查存储空间                                                    │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 充足      不足                                                   │
│  │         │                                                    │
│  │         ▼                                                    │
│  │    提示清理空间                                               │
│  │                                                              │
│  ▼                                                              │
│  添加到下载队列                                                  │
│       │                                                          │
│       ▼                                                          │
│  开始下载                                                        │
│  ├── 显示进度                                                    │
│  └── 支持暂停/取消                                               │
│       │                                                          │
│       ▼                                                          │
│  下载完成                                                        │
│  ├── 保存到 IndexedDB                                           │
│  ├── 更新书籍状态                                                │
│  └── 预缓存封面                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 下载管理

| 操作 | 说明 |
|------|------|
| 下载 | 添加到队列开始下载 |
| 暂停 | 暂停当前下载 |
| 恢复 | 继续下载 |
| 取消 | 取消并删除临时文件 |
| 删除 | 删除已下载书籍 |

---

## 4. 本地存储

### 4.1 IndexedDB 结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    IndexedDB 数据库结构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Database: readmigo                                             │
│                                                                  │
│  Object Stores:                                                 │
│  ├── books                                                      │
│  │   ├── id: string (主键)                                      │
│  │   ├── metadata: BookMetadata                                │
│  │   ├── content: Blob                                         │
│  │   └── downloadedAt: number                                  │
│  │                                                              │
│  ├── reading_progress                                           │
│  │   ├── bookId: string (主键)                                  │
│  │   ├── progress: number                                       │
│  │   ├── location: string                                       │
│  │   └── updatedAt: number                                     │
│  │                                                              │
│  ├── bookmarks                                                  │
│  │   ├── id: string (主键)                                      │
│  │   ├── bookId: string (索引)                                  │
│  │   └── data: BookmarkData                                    │
│  │                                                              │
│  ├── highlights                                                 │
│  │   ├── id: string (主键)                                      │
│  │   ├── bookId: string (索引)                                  │
│  │   └── data: HighlightData                                   │
│  │                                                              │
│  ├── vocabulary                                                 │
│  │   ├── word: string (主键)                                    │
│  │   └── data: VocabularyData                                  │
│  │                                                              │
│  └── sync_queue                                                 │
│      ├── id: string (主键)                                      │
│      ├── type: string                                           │
│      ├── payload: object                                       │
│      └── createdAt: number                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 存储配额

| 浏览器 | 配额 |
|--------|------|
| Chrome | 可用空间的 80% |
| Firefox | 可用空间的 50% |
| Safari | 1GB (可申请更多) |

---

## 5. 同步队列

### 5.1 队列机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    同步队列机制                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  离线操作                                                        │
│       │                                                          │
│       ▼                                                          │
│  添加到队列                                                      │
│  {                                                              │
│    id: uuid,                                                    │
│    type: 'UPDATE_PROGRESS',                                     │
│    payload: { bookId, progress },                               │
│    timestamp: Date.now()                                        │
│  }                                                              │
│       │                                                          │
│       ▼                                                          │
│  保存到 IndexedDB                                               │
│       │                                                          │
│       ▼                                                          │
│  等待网络恢复                                                    │
│       │                                                          │
│       ▼                                                          │
│  按序执行队列                                                    │
│       │                                                          │
│       ▼                                                          │
│  成功后删除队列项                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 操作类型

| 类型 | 说明 | 优先级 |
|------|------|--------|
| UPDATE_PROGRESS | 更新阅读进度 | 高 |
| ADD_BOOKMARK | 添加书签 | 中 |
| REMOVE_BOOKMARK | 删除书签 | 中 |
| ADD_HIGHLIGHT | 添加高亮 | 中 |
| ADD_VOCABULARY | 添加词汇 | 低 |
| UPDATE_SETTINGS | 更新设置 | 低 |

---

## 6. 冲突处理

### 6.1 冲突检测

```
┌─────────────────────────────────────────────────────────────────┐
│                    冲突检测逻辑                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  同步时                                                          │
│       │                                                          │
│       ▼                                                          │
│  比较本地和服务端时间戳                                          │
│       │                                                          │
│  ┌────┴────────────────────┐                                    │
│  │         │               │                                    │
│  ▼         ▼               ▼                                    │
│ 本地新    服务端新      同时修改                                  │
│  │         │               │                                    │
│  ▼         ▼               ▼                                    │
│ 上传      下载          冲突处理                                  │
│            │                                                    │
│            ▼                                                    │
│       覆盖本地                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 冲突策略

| 数据类型 | 策略 |
|----------|------|
| 阅读进度 | 时间戳最新 |
| 书签 | 合并 (ID 去重) |
| 高亮 | 合并 (位置去重) |
| 词汇 | 合并 |
| 设置 | 服务端优先 |

---

## 7. 存储管理

### 7.1 存储信息展示

| 信息 | 说明 |
|------|------|
| 已用空间 | 当前占用存储 |
| 可用空间 | 剩余可用存储 |
| 书籍数量 | 已下载书籍数 |
| 缓存大小 | 缓存占用空间 |

### 7.2 清理策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    存储清理策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  手动清理                                                        │
│  ├── 删除单本书籍                                                │
│  ├── 批量删除书籍                                                │
│  └── 清除所有缓存                                                │
│                                                                  │
│  自动清理 (空间不足时)                                           │
│  ├── 清除过期缓存                                                │
│  ├── 清除未读书籍 (可选)                                        │
│  └── 压缩图片缓存                                                │
│                                                                  │
│  智能推荐                                                        │
│  ├── 推荐删除长期未读                                            │
│  └── 推荐删除已读完成                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. Service Worker

### 8.1 缓存策略

| 资源 | 策略 |
|------|------|
| 静态资源 | Cache First |
| API 响应 | Network First |
| 书籍文件 | Cache First |
| 图片 | Stale While Revalidate |

### 8.2 更新机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    SW 更新机制                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  检测到新版本                                                    │
│       │                                                          │
│       ▼                                                          │
│  后台安装新 SW                                                   │
│       │                                                          │
│       ▼                                                          │
│  新 SW 进入 waiting                                             │
│       │                                                          │
│       ▼                                                          │
│  提示用户更新                                                    │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 立即更新  稍后                                                   │
│  │         │                                                    │
│  ▼         │                                                    │
│ skipWaiting + 刷新                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [../pwa.md](../pwa.md) | PWA 配置 |
| [reader.md](./reader.md) | 阅读器集成 |
| [library.md](./library.md) | 书架管理 |

---

*最后更新: 2025-12-31*

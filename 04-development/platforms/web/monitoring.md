# Web 监控与告警

> Vercel Analytics + Sentry + 自定义埋点

---

## 1. 监控体系概览

```
┌─────────────────────────────────────────────────────────────────┐
│                      监控体系架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  性能监控                                                        │
│  ├── Vercel Analytics                                           │
│  │   ├── Core Web Vitals (LCP, INP, CLS)                       │
│  │   ├── 路由级性能                                              │
│  │   └── 地域分布                                                │
│  └── Vercel Speed Insights                                      │
│      └── 真实用户性能数据                                        │
│                                                                  │
│  错误监控                                                        │
│  └── Sentry                                                     │
│      ├── 前端错误捕获                                            │
│      ├── 性能追踪                                                │
│      ├── 会话回放 (可选)                                         │
│      └── 用户反馈收集                                            │
│                                                                  │
│  业务监控                                                        │
│  └── PostHog / 自定义                                           │
│      ├── 用户行为分析                                            │
│      ├── 功能使用统计                                            │
│      └── 转化漏斗                                                │
│                                                                  │
│  基础设施监控                                                    │
│  └── Vercel Dashboard                                           │
│      ├── 部署状态                                                │
│      ├── 带宽使用                                                │
│      └── 函数执行                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 性能监控

### 2.1 Core Web Vitals

| 指标 | 良好 | 需改进 | 差 |
|------|------|--------|-----|
| LCP | ≤ 2.5s | 2.5s - 4s | > 4s |
| INP | ≤ 200ms | 200ms - 500ms | > 500ms |
| CLS | ≤ 0.1 | 0.1 - 0.25 | > 0.25 |
| FCP | ≤ 1.8s | 1.8s - 3s | > 3s |
| TTFB | ≤ 800ms | 800ms - 1.8s | > 1.8s |

### 2.2 自定义性能指标

```
┌─────────────────────────────────────────────────────────────────┐
│                    自定义性能埋点                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  阅读器性能                                                      │
│  ├── reader_open_time: 阅读器打开耗时                           │
│  ├── page_render_time: 页面渲染耗时                             │
│  ├── chapter_load_time: 章节加载耗时                            │
│  └── ai_response_time: AI 响应耗时                              │
│                                                                  │
│  交互性能                                                        │
│  ├── search_response_time: 搜索响应时间                         │
│  ├── bookmark_save_time: 书签保存时间                           │
│  └── vocabulary_lookup_time: 词汇查询时间                       │
│                                                                  │
│  资源性能                                                        │
│  ├── book_download_time: 书籍下载时间                           │
│  ├── cover_load_time: 封面加载时间                              │
│  └── api_latency: API 延迟                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 错误监控

### 3.1 Sentry 配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| dsn | 项目 DSN | 数据上报地址 |
| environment | production/staging | 环境标识 |
| release | 版本号 | 关联部署版本 |
| tracesSampleRate | 0.1 | 性能采样率 10% |
| replaysSessionSampleRate | 0.01 | 会话回放采样 1% |

### 3.2 错误分类与优先级

```
┌─────────────────────────────────────────────────────────────────┐
│                    错误优先级分类                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  P0 - 致命 (立即响应)                                            │
│  ├── 应用崩溃                                                    │
│  ├── 认证系统故障                                                │
│  ├── 支付流程异常                                                │
│  └── 数据丢失风险                                                │
│                                                                  │
│  P1 - 严重 (24 小时内)                                          │
│  ├── 核心功能不可用                                              │
│  ├── 阅读器无法打开                                              │
│  └── API 大面积 5xx                                             │
│                                                                  │
│  P2 - 一般 (本周内)                                             │
│  ├── 非核心功能异常                                              │
│  ├── UI 显示问题                                                │
│  └── 性能下降明显                                                │
│                                                                  │
│  P3 - 轻微 (下次迭代)                                           │
│  ├── 边缘场景问题                                                │
│  ├── 控制台警告                                                  │
│  └── 兼容性小问题                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 错误上下文

| 上下文 | 内容 |
|--------|------|
| User | 用户 ID (脱敏)、订阅状态 |
| Device | 浏览器、操作系统、设备类型 |
| Page | 当前路由、URL 参数 |
| Feature | 当前使用的功能模块 |
| Book | 当前阅读的书籍 (如有) |

---

## 4. 业务监控

### 4.1 核心业务指标

```
┌─────────────────────────────────────────────────────────────────┐
│                    业务指标体系                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户指标                                                        │
│  ├── DAU / WAU / MAU                                            │
│  ├── 新用户注册数                                                │
│  ├── 留存率 (Day 1/7/30)                                        │
│  └── 活跃时长                                                    │
│                                                                  │
│  阅读指标                                                        │
│  ├── 阅读书籍数                                                  │
│  ├── 阅读时长                                                    │
│  ├── 完成阅读率                                                  │
│  └── 阅读器使用频率                                              │
│                                                                  │
│  功能使用                                                        │
│  ├── AI 查词次数                                                │
│  ├── 书签创建数                                                  │
│  ├── 高亮创建数                                                  │
│  └── 词汇收藏数                                                  │
│                                                                  │
│  转化指标                                                        │
│  ├── 注册转化率                                                  │
│  ├── 订阅转化率                                                  │
│  └── 付费续费率                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 事件追踪

| 事件类型 | 事件名 | 参数 |
|----------|--------|------|
| 页面访问 | page_view | page_path |
| 用户注册 | user_signup | method |
| 开始阅读 | reading_start | book_id, format |
| AI 查词 | ai_lookup | word, context |
| 添加书签 | bookmark_add | book_id, position |
| 订阅购买 | subscription_start | plan_type |

---

## 5. 告警配置

### 5.1 告警规则

```
┌─────────────────────────────────────────────────────────────────┐
│                    告警规则配置                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  错误告警                                                        │
│  ├── 错误率 > 1%: 通知                                          │
│  ├── 错误率 > 5%: 告警                                          │
│  ├── P0 错误: 立即告警                                          │
│  └── 新错误类型: 通知                                            │
│                                                                  │
│  性能告警                                                        │
│  ├── LCP p75 > 4s: 告警                                         │
│  ├── CLS p75 > 0.25: 告警                                       │
│  └── API 延迟 p95 > 2s: 通知                                    │
│                                                                  │
│  业务告警                                                        │
│  ├── DAU 下降 > 20%: 告警                                       │
│  ├── 注册转化下降 > 30%: 告警                                   │
│  └── 付款失败率 > 5%: 立即告警                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 告警通道

| 优先级 | 通道 | 响应时间 |
|--------|------|----------|
| P0 | 电话 + Slack | 15 分钟 |
| P1 | Slack + 邮件 | 1 小时 |
| P2 | Slack | 24 小时 |
| P3 | 邮件 | 下次迭代 |

---

## 6. 日志管理

### 6.1 日志级别

| 级别 | 用途 | 示例 |
|------|------|------|
| ERROR | 异常错误 | API 调用失败 |
| WARN | 警告信息 | 降级处理触发 |
| INFO | 关键操作 | 用户登录成功 |
| DEBUG | 调试信息 | 仅开发环境 |

### 6.2 日志结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    日志结构规范                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  必要字段                                                        │
│  ├── timestamp: ISO 时间戳                                      │
│  ├── level: 日志级别                                            │
│  ├── message: 日志消息                                          │
│  └── context: 上下文信息                                        │
│                                                                  │
│  可选字段                                                        │
│  ├── userId: 用户 ID (脱敏)                                     │
│  ├── sessionId: 会话 ID                                         │
│  ├── requestId: 请求 ID                                         │
│  └── duration: 耗时                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. Dashboard 设计

### 7.1 实时监控面板

| 面板 | 内容 |
|------|------|
| 概览 | 在线用户、请求量、错误率 |
| 性能 | Core Web Vitals 实时数据 |
| 错误 | 最新错误、错误趋势 |
| 业务 | 注册、阅读、转化数据 |

### 7.2 关键图表

```
┌─────────────────────────────────────────────────────────────────┐
│                    Dashboard 布局                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  顶部 - 核心指标卡片                                             │
│  ├── 当前在线用户                                                │
│  ├── 今日 PV/UV                                                 │
│  ├── 错误率                                                      │
│  └── P95 延迟                                                   │
│                                                                  │
│  中部 - 趋势图表                                                 │
│  ├── 请求量趋势 (24h)                                           │
│  ├── 错误趋势 (24h)                                             │
│  └── 性能趋势 (7d)                                              │
│                                                                  │
│  底部 - 详细数据                                                 │
│  ├── 最新错误列表                                                │
│  ├── 慢请求 Top 10                                              │
│  └── 页面性能排名                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 隐私合规

### 8.1 数据采集原则

| 原则 | 说明 |
|------|------|
| 最小化 | 只采集必要数据 |
| 匿名化 | 用户 ID 脱敏处理 |
| 知情同意 | Cookie 同意弹窗 |
| 可删除 | 支持用户数据删除 |

### 8.2 敏感数据处理

```
┌─────────────────────────────────────────────────────────────────┐
│                    敏感数据处理规则                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  禁止采集                                                        │
│  ├── 密码                                                        │
│  ├── 支付信息                                                    │
│  ├── 精确位置                                                    │
│  └── 个人身份信息                                                │
│                                                                  │
│  需脱敏                                                          │
│  ├── 用户 ID → 哈希值                                           │
│  ├── 邮箱 → 部分隐藏                                             │
│  └── IP → 仅保留国家/城市                                        │
│                                                                  │
│  可直接采集                                                      │
│  ├── 设备类型                                                    │
│  ├── 浏览器版本                                                  │
│  ├── 页面路径                                                    │
│  └── 功能使用事件                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [error-handling.md](./error-handling.md) | 错误处理 |
| [performance.md](./performance.md) | 性能优化 |
| [../infrastructure/observability.md](../infrastructure/observability.md) | 全栈监控 |

---

*最后更新: 2025-12-31*

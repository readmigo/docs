# Web 性能优化

> Core Web Vitals + 资源优化 + 渲染性能

---

## 1. 性能目标

### 1.1 Core Web Vitals 目标

| 指标 | 目标 | 说明 |
|------|------|------|
| LCP | < 2.5s | 最大内容渲染 |
| INP | < 200ms | 交互响应 |
| CLS | < 0.1 | 累计布局偏移 |
| FCP | < 1.8s | 首次内容渲染 |
| TTFB | < 800ms | 首字节时间 |

### 1.2 自定义性能指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 首屏加载 | < 3s | 3G 网络 |
| 阅读器打开 | < 1s | 缓存命中 |
| 页面切换 | < 300ms | SPA 导航 |
| Bundle 大小 | < 200KB | 首屏 JS (gzip) |

---

## 2. 资源优化

### 2.1 代码分割策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    代码分割架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  入口 Bundle                                                     │
│  ├── framework (React, Next.js)     ~80KB                       │
│  ├── vendor (核心依赖)              ~50KB                       │
│  └── app (首屏代码)                 ~30KB                       │
│                                                                  │
│  按需加载                                                        │
│  ├── 阅读器模块                     ~100KB                      │
│  │   └── epubjs, react-pdf, 渲染逻辑                           │
│  ├── AI 功能模块                    ~40KB                       │
│  ├── 有声书模块                     ~30KB                       │
│  └── 设置页面                       ~20KB                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 动态导入规则

| 场景 | 策略 |
|------|------|
| 路由级别 | Next.js 自动分割 |
| 功能模块 | `next/dynamic` + Suspense |
| 大型库 | 按需导入 (tree-shaking) |
| 条件渲染组件 | `dynamic(() => import(...))` |

### 2.3 图片优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    图片优化策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  next/image 配置                                                 │
│  ├── 自动 WebP/AVIF 转换                                        │
│  ├── 响应式尺寸生成                                              │
│  ├── 懒加载 (默认)                                               │
│  └── 占位符 blur                                                │
│                                                                  │
│  封面图优化                                                      │
│  ├── 小尺寸: 80x120 (列表)                                      │
│  ├── 中尺寸: 160x240 (网格)                                     │
│  ├── 大尺寸: 320x480 (详情)                                     │
│  └── CDN: Cloudflare R2 + 图片转换                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 渲染优化

### 3.1 React 优化

| 技术 | 用途 |
|------|------|
| React.memo | 防止不必要重渲染 |
| useMemo | 缓存计算结果 |
| useCallback | 缓存函数引用 |
| React.lazy | 组件懒加载 |
| Suspense | 加载状态管理 |

### 3.2 优化检查清单

```
┌─────────────────────────────────────────────────────────────────┐
│                    渲染优化检查                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ 检查项                                                       │
│  ├── 长列表使用虚拟滚动                                          │
│  ├── 避免在 render 中创建对象/函数                               │
│  ├── 状态提升最小化                                              │
│  ├── 使用 key 优化列表渲染                                       │
│  ├── 避免 prop drilling (使用 Context/Store)                    │
│  └── 大数据使用分页/无限滚动                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 Server Components 优化

| 策略 | 说明 |
|------|------|
| 默认 RSC | 除非需要交互/状态 |
| 数据获取在服务端 | 减少 Client Bundle |
| Streaming | 大页面分块渲染 |
| Partial Prerendering | 混合静态/动态 |

---

## 4. 网络优化

### 4.1 预加载策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    预加载策略                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  prefetch (链接预取)                                             │
│  └── Next.js Link 自动 prefetch                                 │
│                                                                  │
│  preload (资源预加载)                                            │
│  ├── 字体文件                                                    │
│  ├── 关键 CSS                                                   │
│  └── 首屏图片                                                    │
│                                                                  │
│  preconnect (连接预热)                                           │
│  ├── API 服务器                                                  │
│  ├── CDN 域名                                                    │
│  └── 第三方服务                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 缓存策略

| 资源类型 | 策略 | TTL |
|----------|------|-----|
| 静态资源 | Cache-First | 1 年 |
| API 响应 | Network-First | 5 分钟 |
| 书籍内容 | Cache-First | 7 天 |
| 用户数据 | Network-Only | - |

---

## 5. 阅读器性能

### 5.1 EPUB 渲染优化

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读器性能优化                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  渲染优化                                                        │
│  ├── 分页预渲染 (前后各 1 页)                                    │
│  ├── 章节延迟加载                                                │
│  ├── 图片懒加载                                                  │
│  └── 虚拟化长文本                                                │
│                                                                  │
│  交互优化                                                        │
│  ├── 翻页动画 GPU 加速                                          │
│  ├── 手势识别优化 (passive listeners)                           │
│  ├── 防抖处理 (滚动、缩放)                                       │
│  └── 离屏 Canvas 预渲染                                          │
│                                                                  │
│  内存管理                                                        │
│  ├── 非可视页面销毁                                              │
│  ├── 图片解码按需                                                │
│  └── 大文件分块加载                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 PDF 渲染优化

| 策略 | 说明 |
|------|------|
| 分页加载 | 仅渲染可视页面 |
| Worker 线程 | PDF.js Worker |
| 缩放缓存 | 不同缩放级别缓存 |
| 文本层优化 | 按需生成文本层 |

---

## 6. 监控与分析

### 6.1 性能监控

```
┌─────────────────────────────────────────────────────────────────┐
│                    性能监控体系                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  实时监控                                                        │
│  ├── Vercel Analytics (Core Web Vitals)                        │
│  ├── Sentry Performance                                         │
│  └── 自定义 Performance API 埋点                                │
│                                                                  │
│  构建分析                                                        │
│  ├── Bundle Analyzer                                            │
│  ├── Lighthouse CI                                              │
│  └── Import Cost (VS Code)                                      │
│                                                                  │
│  关键指标                                                        │
│  ├── 首屏加载时间                                                │
│  ├── 阅读器打开时间                                              │
│  ├── 页面切换时间                                                │
│  └── JS 错误率                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 性能预算

| 指标 | 预算 | 告警阈值 |
|------|------|----------|
| 首屏 JS | 200KB | 250KB |
| 首屏 CSS | 50KB | 70KB |
| 首屏图片 | 300KB | 400KB |
| 总加载资源 | 1MB | 1.5MB |

---

## 7. PWA 优化

### 7.1 Service Worker 策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    PWA 缓存策略                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Static Assets (Cache First)                                    │
│  ├── /_next/static/**                                          │
│  ├── /fonts/**                                                  │
│  └── /icons/**                                                  │
│                                                                  │
│  API Requests (Network First)                                   │
│  ├── /api/**                                                    │
│  └── https://api.readmigo.app/**                               │
│                                                                  │
│  Book Content (Cache First + Network Update)                    │
│  ├── EPUB 文件                                                  │
│  └── 封面图片                                                    │
│                                                                  │
│  HTML Pages (Network First)                                     │
│  └── /**                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 离线功能

| 功能 | 离线支持 |
|------|----------|
| 已缓存书籍阅读 | ✅ 完全支持 |
| 书架浏览 | ✅ 缓存数据 |
| 词汇学习 | ✅ 本地数据 |
| 搜索 | ❌ 需联网 |
| AI 功能 | ❌ 需联网 |

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [pwa.md](./pwa.md) | PWA 详细配置 |
| [architecture.md](./architecture.md) | 前端架构 |
| [../infrastructure/performance-optimization.md](../infrastructure/performance-optimization.md) | 全栈性能优化 |

---

*最后更新: 2025-12-31*

# Web PWA 配置

> Progressive Web App 离线支持与安装体验

---

## 1. PWA 概述

```
┌─────────────────────────────────────────────────────────────────┐
│                      PWA 功能矩阵                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  安装体验                                                        │
│  ├── 添加到主屏幕                                                │
│  ├── 独立窗口运行                                                │
│  ├── 启动画面                                                    │
│  └── 应用图标                                                    │
│                                                                  │
│  离线能力                                                        │
│  ├── 静态资源缓存                                                │
│  ├── API 响应缓存                                                │
│  ├── 已下载书籍离线阅读                                          │
│  └── 离线队列同步                                                │
│                                                                  │
│  原生功能                                                        │
│  ├── 推送通知 (计划中)                                           │
│  ├── 后台同步                                                    │
│  └── 分享目标                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Manifest 配置

### 2.1 基本配置

| 字段 | 值 | 说明 |
|------|-----|------|
| name | ReadMigo | 完整名称 |
| short_name | ReadMigo | 短名称 (主屏幕) |
| description | 智能英文阅读助手 | 应用描述 |
| start_url | / | 启动 URL |
| display | standalone | 显示模式 |
| orientation | any | 屏幕方向 |
| theme_color | #3B82F6 | 主题色 |
| background_color | #FFFFFF | 背景色 |

### 2.2 图标配置

| 尺寸 | 用途 |
|------|------|
| 48x48 | Android 应用列表 |
| 72x72 | Android 启动器 |
| 96x96 | 桌面快捷方式 |
| 144x144 | Android 启动画面 |
| 192x192 | Android 主屏幕 |
| 512x512 | PWA 安装 |

### 2.3 Maskable 图标

```
┌─────────────────────────────────────────────────────────────────┐
│                    图标安全区域                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────┐                        │
│  │                                     │                        │
│  │   ┌─────────────────────────────┐   │                        │
│  │   │                             │   │                        │
│  │   │     ┌─────────────────┐     │   │                        │
│  │   │     │                 │     │   │                        │
│  │   │     │   Safe Zone     │     │   │                        │
│  │   │     │    (80%)        │     │   │                        │
│  │   │     │                 │     │   │                        │
│  │   │     └─────────────────┘     │   │                        │
│  │   │                             │   │                        │
│  │   └─────────────────────────────┘   │                        │
│  │           Maskable Area             │                        │
│  └─────────────────────────────────────┘                        │
│                                                                  │
│  purpose: "maskable any"                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Service Worker 策略

### 3.1 缓存策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    缓存策略分类                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Cache First (缓存优先)                                          │
│  └── 适用: 静态资源、字体、图标                                   │
│      ├── /_next/static/**                                       │
│      ├── /fonts/**                                              │
│      └── /icons/**                                              │
│                                                                  │
│  Network First (网络优先)                                        │
│  └── 适用: API 请求、HTML 页面                                   │
│      ├── /api/**                                                │
│      └── HTML 文档                                              │
│                                                                  │
│  Stale While Revalidate (过期重验证)                             │
│  └── 适用: 书籍内容、封面图片                                    │
│      ├── EPUB/PDF 文件                                          │
│      └── 书籍封面                                                │
│                                                                  │
│  Network Only (仅网络)                                           │
│  └── 适用: 认证相关、实时数据                                    │
│      ├── /api/auth/**                                           │
│      └── AI 请求                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 缓存名称空间

| 缓存名 | 内容 | TTL |
|--------|------|-----|
| static-v1 | JS/CSS/字体 | 永久 (版本更新时清理) |
| pages-v1 | HTML 页面 | 24 小时 |
| api-v1 | API 响应 | 5 分钟 |
| books-v1 | 书籍文件 | 7 天 |
| images-v1 | 封面图片 | 30 天 |

---

## 4. 离线功能

### 4.1 离线支持矩阵

| 功能 | 离线支持 | 说明 |
|------|----------|------|
| 已缓存书籍阅读 | ✅ | 完全支持 |
| 书架浏览 | ✅ | 缓存数据 |
| 阅读进度保存 | ✅ | 本地存储 + 恢复同步 |
| 书签/高亮 | ✅ | 本地存储 + 恢复同步 |
| 词汇学习 | ✅ | 本地数据 |
| 新书搜索 | ❌ | 需联网 |
| AI 查词/翻译 | ❌ | 需联网 |
| 用户设置同步 | ❌ | 需联网 |

### 4.2 离线数据存储

```
┌─────────────────────────────────────────────────────────────────┐
│                    离线存储架构                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  IndexedDB                                                      │
│  ├── books                                                      │
│  │   ├── 书籍元数据                                              │
│  │   └── 书籍文件 (Blob)                                        │
│  ├── reading_progress                                           │
│  │   └── 阅读进度记录                                            │
│  ├── bookmarks                                                  │
│  │   └── 书签数据                                                │
│  ├── highlights                                                 │
│  │   └── 高亮数据                                                │
│  ├── vocabulary                                                 │
│  │   └── 词汇学习数据                                            │
│  └── sync_queue                                                 │
│      └── 待同步操作                                              │
│                                                                  │
│  localStorage                                                   │
│  ├── 用户偏好设置                                                │
│  ├── UI 状态                                                    │
│  └── 认证 Token (加密)                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 书籍下载

### 5.1 下载流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    书籍下载流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户点击下载                                                    │
│       │                                                          │
│       ▼                                                          │
│  检查存储空间                                                    │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 充足      不足                                                   │
│  │         │                                                    │
│  │         ▼                                                    │
│  │    提示清理空间                                               │
│  │                                                              │
│  ▼                                                              │
│  获取书籍文件 URL                                                │
│       │                                                          │
│       ▼                                                          │
│  Fetch + 进度监听                                               │
│       │                                                          │
│       ▼                                                          │
│  存储到 IndexedDB                                               │
│       │                                                          │
│       ▼                                                          │
│  更新书籍状态为"已下载"                                          │
│       │                                                          │
│       ▼                                                          │
│  预缓存封面图片                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 下载管理

| 功能 | 说明 |
|------|------|
| 下载进度 | 显示百分比 + 进度条 |
| 暂停/恢复 | 支持断点续传 |
| 取消下载 | 清理部分下载 |
| 批量下载 | 队列管理 |
| 删除下载 | 释放存储空间 |

---

## 6. 同步队列

### 6.1 同步机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    同步队列机制                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  离线操作                                                        │
│       │                                                          │
│       ▼                                                          │
│  记录到 sync_queue                                              │
│  {                                                              │
│    type: 'UPDATE_PROGRESS',                                     │
│    payload: { bookId, progress },                               │
│    timestamp: Date.now()                                        │
│  }                                                              │
│       │                                                          │
│       ▼                                                          │
│  检测网络恢复                                                    │
│       │                                                          │
│       ▼                                                          │
│  按时间顺序执行队列                                              │
│       │                                                          │
│       ▼                                                          │
│  冲突检测                                                        │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 无冲突   有冲突                                                  │
│  │         │                                                    │
│  │         ▼                                                    │
│  │    服务端时间戳较新 → 使用服务端数据                          │
│  │    本地时间戳较新 → 使用本地数据                               │
│  │                                                              │
│  └────────────────────────────────────────────────────────────┘
│       │                                                          │
│       ▼                                                          │
│  清理已同步队列                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 同步操作类型

| 类型 | 优先级 | 冲突策略 |
|------|--------|----------|
| 阅读进度 | 高 | 最新时间戳 |
| 书签 | 中 | 合并 |
| 高亮 | 中 | 合并 |
| 词汇收藏 | 低 | 合并 |

---

## 7. 安装提示

### 7.1 安装提示策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    安装提示策略                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  显示时机                                                        │
│  ├── 用户访问 3 次以上                                           │
│  ├── 距上次提示超过 7 天                                         │
│  └── 用户完成一次阅读                                            │
│                                                                  │
│  不显示时机                                                      │
│  ├── 用户已拒绝                                                  │
│  ├── 已安装为 PWA                                                │
│  └── 不支持安装的浏览器                                          │
│                                                                  │
│  提示内容                                                        │
│  ├── 安装的好处说明                                              │
│  ├── 安装按钮                                                    │
│  ├── "稍后提醒"选项                                              │
│  └── "不再提示"选项                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 平台安装支持

| 平台 | 支持情况 |
|------|----------|
| Chrome (Android) | ✅ 完全支持 |
| Chrome (Desktop) | ✅ 完全支持 |
| Safari (iOS) | ⚠️ 手动添加到主屏幕 |
| Safari (macOS) | ⚠️ 有限支持 |
| Firefox | ⚠️ 有限支持 |
| Edge | ✅ 完全支持 |

---

## 8. 更新策略

### 8.1 版本更新流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    SW 更新流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  检测到新版本 SW                                                 │
│       │                                                          │
│       ▼                                                          │
│  新 SW 进入 waiting 状态                                         │
│       │                                                          │
│       ▼                                                          │
│  显示更新提示                                                    │
│  "新版本可用，立即更新？"                                         │
│       │                                                          │
│  ┌────┴────┐                                                    │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ 立即更新  稍后                                                   │
│  │         │                                                    │
│  ▼         ▼                                                    │
│ skipWaiting  下次访问时更新                                      │
│  │                                                              │
│  ▼                                                              │
│ 页面刷新                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 缓存清理

| 场景 | 策略 |
|------|------|
| 版本更新 | 清理旧版本缓存 |
| 存储空间不足 | 清理过期缓存 |
| 用户手动清理 | 保留核心数据 |

---

## 9. 相关文档

| 文档 | 说明 |
|------|------|
| [performance.md](./performance.md) | 缓存性能优化 |
| [features/offline.md](./features/offline.md) | 离线功能详情 |
| [../infrastructure/cdn.md](../infrastructure/cdn.md) | CDN 配置 |

---

*最后更新: 2025-12-31*

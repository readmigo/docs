# Web 测试策略

> Vitest + React Testing Library + Playwright

---

## 1. 测试金字塔

```
┌─────────────────────────────────────────────────────────────────┐
│                      测试金字塔                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                         E2E Tests                               │
│                        /         \                              │
│                       /  Playwright \                           │
│                      /   (关键流程)   \                          │
│                     ─────────────────                           │
│                    /                   \                        │
│                   /  Integration Tests  \                       │
│                  /   React Testing Lib   \                      │
│                 /     (组件 + Hook)       \                     │
│                ───────────────────────────                      │
│               /                           \                     │
│              /       Unit Tests            \                    │
│             /         Vitest                \                   │
│            /     (工具函数、Store)           \                  │
│           ─────────────────────────────────────                 │
│                                                                  │
│  比例建议: Unit 60% | Integration 30% | E2E 10%                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 测试工具栈

| 工具 | 用途 | 配置文件 |
|------|------|----------|
| Vitest | 单元测试运行器 | `vitest.config.ts` |
| React Testing Library | 组件测试 | - |
| MSW | API Mock | `mocks/handlers.ts` |
| Playwright | E2E 测试 | `playwright.config.ts` |
| Testing Library Jest DOM | 断言扩展 | - |

---

## 3. 单元测试

### 3.1 工具函数测试

```
测试目标: lib/utils/, features/*/utils/
覆盖率目标: 90%+

测试内容:
├── 输入输出验证
├── 边界条件
├── 错误处理
└── 类型安全
```

### 3.2 Zustand Store 测试

```
测试目标: features/*/stores/
覆盖率目标: 85%+

测试内容:
├── 初始状态
├── Action 执行后状态变化
├── Selector 返回值
└── 异步 Action
```

### 3.3 测试文件位置

| 模式 | 说明 |
|------|------|
| `*.test.ts` | 与源文件同目录 |
| `__tests__/*.test.ts` | 集中测试目录 |

---

## 4. 组件测试

### 4.1 测试原则

```
┌─────────────────────────────────────────────────────────────────┐
│                    组件测试原则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ DO                                                          │
│  ├── 测试用户可见的行为                                          │
│  ├── 使用 accessible queries (getByRole, getByLabelText)       │
│  ├── 测试异步状态 (loading, error, success)                     │
│  └── 模拟用户交互 (click, type, select)                         │
│                                                                  │
│  ❌ DON'T                                                       │
│  ├── 测试实现细节 (内部状态)                                     │
│  ├── 直接测试 CSS 样式                                          │
│  ├── 使用快照测试 (易碎)                                         │
│  └── 测试第三方库内部                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 测试覆盖范围

| 组件类型 | 覆盖率目标 | 测试重点 |
|----------|------------|----------|
| UI 组件 | 80%+ | Props 变化、交互事件 |
| Feature 组件 | 85%+ | 业务逻辑、状态变化 |
| Page 组件 | 70%+ | 数据获取、路由行为 |

---

## 5. API Mock (MSW)

### 5.1 Mock 架构

```
mocks/
├── browser.ts          # 浏览器环境 Service Worker
├── server.ts           # 测试环境 Mock Server
├── handlers/
│   ├── index.ts        # Handler 聚合
│   ├── auth.ts         # 认证相关 Mock
│   ├── books.ts        # 书籍相关 Mock
│   └── ai.ts           # AI 相关 Mock
└── fixtures/
    ├── books.json      # 书籍测试数据
    └── users.json      # 用户测试数据
```

### 5.2 Mock 策略

| 场景 | 策略 |
|------|------|
| 开发环境 | 可选启用 MSW |
| 单元测试 | 完全 Mock |
| 集成测试 | 部分 Mock (非关键 API) |
| E2E 测试 | 真实 API 或专用测试服务器 |

---

## 6. E2E 测试 (Playwright)

### 6.1 测试范围

```
┌─────────────────────────────────────────────────────────────────┐
│                    E2E 测试覆盖                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  关键用户流程                                                    │
│  ├── 登录/注册流程                                               │
│  ├── 书籍浏览 → 开始阅读                                         │
│  ├── 阅读器核心功能 (翻页、书签、高亮)                            │
│  ├── 词汇学习流程                                                │
│  └── 设置修改                                                    │
│                                                                  │
│  回归测试                                                        │
│  ├── 跨浏览器兼容性 (Chrome, Firefox, Safari)                   │
│  ├── 响应式布局 (Mobile, Tablet, Desktop)                       │
│  └── 性能基准                                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 测试文件组织

```
e2e/
├── fixtures/
│   └── auth.fixture.ts     # 认证 Fixture
├── pages/
│   ├── login.page.ts       # Page Object: 登录页
│   ├── library.page.ts     # Page Object: 书架页
│   └── reader.page.ts      # Page Object: 阅读器
├── tests/
│   ├── auth.spec.ts        # 认证流程测试
│   ├── reading.spec.ts     # 阅读流程测试
│   └── learning.spec.ts    # 学习流程测试
└── playwright.config.ts
```

---

## 7. 测试覆盖率

### 7.1 覆盖率目标

| 指标 | 目标 | 当前 |
|------|------|------|
| 语句覆盖 | 80% | - |
| 分支覆盖 | 75% | - |
| 函数覆盖 | 85% | - |
| 行覆盖 | 80% | - |

### 7.2 覆盖率排除

```
# vitest.config.ts 排除配置
coverage:
  exclude:
    - '**/*.d.ts'
    - '**/types/**'
    - '**/mocks/**'
    - '**/__tests__/**'
    - '**/node_modules/**'
```

---

## 8. CI 集成

### 8.1 测试流水线

```
┌─────────────────────────────────────────────────────────────────┐
│                    CI 测试流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PR 提交                                                         │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │   Lint      │  ESLint + TypeScript 检查                      │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │ Unit Tests  │  Vitest (并行)                                 │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │ Integration │  React Testing Library                         │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  Coverage   │  覆盖率报告上传                                 │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────┐                                                │
│  │  E2E (可选) │  仅 main 分支或手动触发                        │
│  └─────────────┘                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 测试命令

| 命令 | 说明 |
|------|------|
| `pnpm test` | 运行所有单元测试 |
| `pnpm test:watch` | 监听模式 |
| `pnpm test:coverage` | 生成覆盖率报告 |
| `pnpm test:e2e` | 运行 E2E 测试 |
| `pnpm test:e2e:ui` | Playwright UI 模式 |

---

## 9. 测试最佳实践

### 9.1 测试命名

| 模式 | 示例 |
|------|------|
| 行为描述 | `should display loading state when fetching` |
| Given-When-Then | `given logged in user, when clicking logout, then redirects to login` |

### 9.2 测试隔离

```
┌─────────────────────────────────────────────────────────────────┐
│                    测试隔离原则                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  每个测试                                                        │
│  ├── 独立运行，不依赖其他测试                                     │
│  ├── 清理副作用 (Store reset, Mock clear)                       │
│  ├── 使用独立测试数据                                            │
│  └── 可重复执行                                                  │
│                                                                  │
│  beforeEach / afterEach                                         │
│  ├── 重置 Zustand Store                                         │
│  ├── 清理 MSW handlers                                          │
│  └── 清理 localStorage/sessionStorage                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 相关文档

| 文档 | 说明 |
|------|------|
| [error-handling.md](./error-handling.md) | 错误处理规范 |
| [../shared/testing-strategy.md](../shared/testing-strategy.md) | 跨平台测试策略 |

---

*最后更新: 2025-12-31*

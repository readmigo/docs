# API 契约规范

## 概述

```
┌─────────────────────────────────────────────────────────────────┐
│                     API Contract                                 │
├─────────────────────────────────────────────────────────────────┤
│  核心原则                                                        │
│  ├── RESTful 设计                                               │
│  ├── JSON 数据格式                                              │
│  ├── 统一响应结构                                               │
│  └── 版本化 API                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 基础 URL

```
┌─────────────────────────────────────────────────────────────────┐
│                      Base URLs                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  生产环境                                                        │
│  └── https://api.readmigo.app/api/v1                            │
│                                                                  │
│  调试环境                                                        │
│  └── https://readmigo-debug.fly.dev/api/v1                      │
│                                                                  │
│  版本策略                                                        │
│  └── /api/v{version}                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 请求规范

### 请求头

```
┌─────────────────────────────────────────────────────────────────┐
│                    Request Headers                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  必需请求头                                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Header              │ Value                             │   │
│  ├──────────────────────┼───────────────────────────────────┤   │
│  │  Content-Type        │ application/json                  │   │
│  │  Accept              │ application/json                  │   │
│  │  Accept-Language     │ en / zh-Hans / zh-Hant / ja / ko  │   │
│  └──────────────────────┴───────────────────────────────────┘   │
│                                                                  │
│  认证请求头                                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Header              │ Value                             │   │
│  ├──────────────────────┼───────────────────────────────────┤   │
│  │  Authorization       │ Bearer {access_token}             │   │
│  └──────────────────────┴───────────────────────────────────┘   │
│                                                                  │
│  追踪请求头                                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Header              │ Value                             │   │
│  ├──────────────────────┼───────────────────────────────────┤   │
│  │  X-Platform          │ ios / android / web / mobile      │   │
│  │  X-Bundle-Id         │ com.readmigo.app                  │   │
│  │  X-App-Version       │ 1.0.0                             │   │
│  │  X-Correlation-Id    │ {uuid}                            │   │
│  └──────────────────────┴───────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### HTTP 方法

```
┌─────────────────────────────────────────────────────────────────┐
│                     HTTP Methods                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┬────────────────────────────────────────────────┐  │
│  │  Method  │  用途                                           │  │
│  ├──────────┼────────────────────────────────────────────────┤  │
│  │  GET     │  获取资源                                       │  │
│  │  POST    │  创建资源 / 执行操作                            │  │
│  │  PUT     │  完整更新资源                                   │  │
│  │  PATCH   │  部分更新资源                                   │  │
│  │  DELETE  │  删除资源                                       │  │
│  └──────────┴────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 响应规范

### 标准响应结构

```
┌─────────────────────────────────────────────────────────────────┐
│                 Standard Response Structure                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  成功响应                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  {                                                       │    │
│  │    "success": true,                                      │    │
│  │    "data": { ... },                                      │    │
│  │    "message": "Operation successful"                     │    │
│  │  }                                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  错误响应                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  {                                                       │    │
│  │    "success": false,                                     │    │
│  │    "error": {                                            │    │
│  │      "code": "VALIDATION_ERROR",                         │    │
│  │      "message": "Invalid email format",                  │    │
│  │      "details": { ... }                                  │    │
│  │    }                                                     │    │
│  │  }                                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 分页响应结构

```
┌─────────────────────────────────────────────────────────────────┐
│                 Paginated Response Structure                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  {                                                       │    │
│  │    "success": true,                                      │    │
│  │    "data": [ ... ],                                      │    │
│  │    "pagination": {                                       │    │
│  │      "total": 100,                                       │    │
│  │      "page": 1,                                          │    │
│  │      "pageSize": 20,                                     │    │
│  │      "totalPages": 5,                                    │    │
│  │      "hasMore": true                                     │    │
│  │    }                                                     │    │
│  │  }                                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  分页参数                                                        │
│  ┌──────────────┬─────────────────────────────────────────┐     │
│  │  参数        │  说明                                    │     │
│  ├──────────────┼─────────────────────────────────────────┤     │
│  │  page        │  页码 (从 1 开始)                        │     │
│  │  pageSize    │  每页数量 (默认 20, 最大 100)           │     │
│  │  sort        │  排序字段                                │     │
│  │  order       │  排序方向 (asc / desc)                  │     │
│  └──────────────┴─────────────────────────────────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## HTTP 状态码

```
┌─────────────────────────────────────────────────────────────────┐
│                    HTTP Status Codes                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  成功状态码                                                      │
│  ┌──────────┬────────────────────────────────────────────────┐  │
│  │  Code    │  含义                                           │  │
│  ├──────────┼────────────────────────────────────────────────┤  │
│  │  200     │  请求成功                                       │  │
│  │  201     │  资源创建成功                                   │  │
│  │  204     │  删除成功 (无内容返回)                          │  │
│  └──────────┴────────────────────────────────────────────────┘  │
│                                                                  │
│  客户端错误                                                      │
│  ┌──────────┬────────────────────────────────────────────────┐  │
│  │  Code    │  含义                                           │  │
│  ├──────────┼────────────────────────────────────────────────┤  │
│  │  400     │  请求参数错误                                   │  │
│  │  401     │  未认证 / Token 过期                            │  │
│  │  403     │  权限不足                                       │  │
│  │  404     │  资源不存在                                     │  │
│  │  409     │  资源冲突                                       │  │
│  │  422     │  业务验证失败                                   │  │
│  │  429     │  请求频率超限                                   │  │
│  └──────────┴────────────────────────────────────────────────┘  │
│                                                                  │
│  服务端错误                                                      │
│  ┌──────────┬────────────────────────────────────────────────┐  │
│  │  Code    │  含义                                           │  │
│  ├──────────┼────────────────────────────────────────────────┤  │
│  │  500     │  服务器内部错误                                 │  │
│  │  502     │  网关错误                                       │  │
│  │  503     │  服务暂不可用                                   │  │
│  │  504     │  网关超时                                       │  │
│  └──────────┴────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 错误代码

```
┌─────────────────────────────────────────────────────────────────┐
│                      Error Codes                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  认证错误                                                        │
│  ┌────────────────────────┬──────────────────────────────────┐  │
│  │  Code                  │  说明                            │  │
│  ├────────────────────────┼──────────────────────────────────┤  │
│  │  AUTH_INVALID_TOKEN    │  无效的访问令牌                  │  │
│  │  AUTH_TOKEN_EXPIRED    │  访问令牌已过期                  │  │
│  │  AUTH_REFRESH_EXPIRED  │  刷新令牌已过期                  │  │
│  │  AUTH_INVALID_CREDS    │  用户名或密码错误                │  │
│  │  AUTH_USER_NOT_FOUND   │  用户不存在                      │  │
│  │  AUTH_EMAIL_EXISTS     │  邮箱已被注册                    │  │
│  └────────────────────────┴──────────────────────────────────┘  │
│                                                                  │
│  业务错误                                                        │
│  ┌────────────────────────┬──────────────────────────────────┐  │
│  │  Code                  │  说明                            │  │
│  ├────────────────────────┼──────────────────────────────────┤  │
│  │  VALIDATION_ERROR      │  参数验证失败                    │  │
│  │  RESOURCE_NOT_FOUND    │  资源不存在                      │  │
│  │  QUOTA_EXCEEDED        │  配额超限                        │  │
│  │  SUBSCRIPTION_REQUIRED │  需要订阅                        │  │
│  │  FEATURE_LOCKED        │  功能未解锁                      │  │
│  └────────────────────────┴──────────────────────────────────┘  │
│                                                                  │
│  AI 相关错误                                                     │
│  ┌────────────────────────┬──────────────────────────────────┐  │
│  │  Code                  │  说明                            │  │
│  ├────────────────────────┼──────────────────────────────────┤  │
│  │  AI_QUOTA_EXCEEDED     │  AI 功能配额用尽                 │  │
│  │  AI_TEXT_TOO_LONG      │  文本过长                        │  │
│  │  AI_SERVICE_ERROR      │  AI 服务暂时不可用               │  │
│  └────────────────────────┴──────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据格式

```
┌─────────────────────────────────────────────────────────────────┐
│                     Data Formats                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  日期时间                                                        │
│  ├── 格式: ISO 8601                                             │
│  ├── 示例: 2024-01-15T08:30:00.000Z                             │
│  └── 时区: UTC                                                  │
│                                                                  │
│  UUID                                                            │
│  ├── 格式: UUID v4                                              │
│  └── 示例: 550e8400-e29b-41d4-a716-446655440000                 │
│                                                                  │
│  金额                                                            │
│  ├── 格式: 整数 (分)                                            │
│  └── 示例: 999 表示 $9.99                                       │
│                                                                  │
│  百分比                                                          │
│  ├── 格式: 0-100 整数                                           │
│  └── 示例: 75 表示 75%                                          │
│                                                                  │
│  语言代码                                                        │
│  ├── 格式: BCP 47                                               │
│  └── 示例: en, zh-Hans, zh-Hant, ja, ko                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 版本控制

```
┌─────────────────────────────────────────────────────────────────┐
│                    API Versioning                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  版本策略                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  URL 路径版本: /api/v1/...                               │    │
│  │                                                          │    │
│  │  版本生命周期:                                           │    │
│  │  ├── 当前版本: v1 (稳定)                                 │    │
│  │  ├── 新版本发布后旧版本维护 6 个月                       │    │
│  │  └── 废弃版本返回 sunset 响应头                          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  废弃通知                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Response Headers:                                       │    │
│  │  ├── Sunset: Sat, 01 Jan 2025 00:00:00 GMT              │    │
│  │  └── Deprecation: true                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 速率限制

```
┌─────────────────────────────────────────────────────────────────┐
│                     Rate Limiting                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  限制规则                                                        │
│  ┌────────────────────┬─────────────────────────────────────┐   │
│  │  端点类型          │  限制                                │   │
│  ├────────────────────┼─────────────────────────────────────┤   │
│  │  通用 API          │  1000 次/分钟                        │   │
│  │  认证 API          │  20 次/分钟                          │   │
│  │  AI API            │  60 次/分钟                          │   │
│  │  上传 API          │  10 次/分钟                          │   │
│  └────────────────────┴─────────────────────────────────────┘   │
│                                                                  │
│  响应头                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  X-RateLimit-Limit: 1000                                 │    │
│  │  X-RateLimit-Remaining: 999                              │    │
│  │  X-RateLimit-Reset: 1640000000                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  超限响应                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  HTTP 429 Too Many Requests                              │    │
│  │  {                                                       │    │
│  │    "error": {                                            │    │
│  │      "code": "RATE_LIMIT_EXCEEDED",                      │    │
│  │      "message": "Too many requests",                     │    │
│  │      "retryAfter": 60                                    │    │
│  │    }                                                     │    │
│  │  }                                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 请求/响应流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  Request/Response Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐                                    ┌─────────┐     │
│  │  Client │                                    │  Server │     │
│  └────┬────┘                                    └────┬────┘     │
│       │                                              │          │
│       │  1. 构建请求                                 │          │
│       │     ├── 设置 Headers                        │          │
│       │     ├── 添加 Token                          │          │
│       │     └── 序列化 Body                         │          │
│       │                                              │          │
│       │ ─────────── HTTP Request ──────────────────▶│          │
│       │                                              │          │
│       │                                 2. 服务端处理│          │
│       │                                    ├── 验证 Token       │
│       │                                    ├── 验证参数         │
│       │                                    ├── 执行业务         │
│       │                                    └── 构建响应         │
│       │                                              │          │
│       │◀─────────── HTTP Response ──────────────────│          │
│       │                                              │          │
│       │  3. 处理响应                                 │          │
│       │     ├── 检查状态码                          │          │
│       │     ├── 解析 JSON                           │          │
│       │     ├── 处理错误                            │          │
│       │     └── 更新 UI                             │          │
│       │                                              │          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

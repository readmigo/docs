# 认证授权流程

## 概述

```
┌─────────────────────────────────────────────────────────────────┐
│                    Authentication System                         │
├─────────────────────────────────────────────────────────────────┤
│  支持方式                                                        │
│  ├── 邮箱/密码登录                                               │
│  ├── Apple Sign In                                               │
│  ├── Google Sign In                                              │
│  └── 访客模式                                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 认证架构

```
┌─────────────────────────────────────────────────────────────────┐
│                 Authentication Architecture                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                        ┌───────────────┐                        │
│                        │    Client     │                        │
│                        │  Application  │                        │
│                        └───────┬───────┘                        │
│                                │                                 │
│         ┌──────────────────────┼──────────────────────┐         │
│         │                      │                      │         │
│         ▼                      ▼                      ▼         │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │    Email    │      │    Apple    │      │   Google    │     │
│  │   Password  │      │   Sign In   │      │   Sign In   │     │
│  └──────┬──────┘      └──────┬──────┘      └──────┬──────┘     │
│         │                    │                    │             │
│         └────────────────────┼────────────────────┘             │
│                              │                                   │
│                              ▼                                   │
│                    ┌─────────────────┐                          │
│                    │   Auth Server   │                          │
│                    │    (NestJS)     │                          │
│                    └────────┬────────┘                          │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              │               │               │                  │
│              ▼               ▼               ▼                  │
│       ┌───────────┐   ┌───────────┐   ┌───────────┐           │
│       │  Access   │   │  Refresh  │   │   User    │           │
│       │   Token   │   │   Token   │   │ Database  │           │
│       └───────────┘   └───────────┘   └───────────┘           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Token 机制

```
┌─────────────────────────────────────────────────────────────────┐
│                      Token Mechanism                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Access Token                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  类型: JWT (JSON Web Token)                              │    │
│  │  有效期: 1 小时                                          │    │
│  │  用途: API 请求认证                                      │    │
│  │  存储: 内存 / Secure Storage                             │    │
│  │  Payload:                                                │    │
│  │  ├── sub: 用户 ID                                        │    │
│  │  ├── email: 用户邮箱                                     │    │
│  │  ├── iat: 签发时间                                       │    │
│  │  └── exp: 过期时间                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Refresh Token                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  类型: Opaque Token                                      │    │
│  │  有效期: 30 天                                           │    │
│  │  用途: 刷新 Access Token                                 │    │
│  │  存储: Secure Storage / Keychain                         │    │
│  │  特性:                                                   │    │
│  │  ├── 一次性使用 (Rotation)                               │    │
│  │  └── 服务端存储，支持撤销                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 邮箱密码登录

```
┌─────────────────────────────────────────────────────────────────┐
│                 Email/Password Login Flow                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐                              ┌─────────┐           │
│  │  Client │                              │  Server │           │
│  └────┬────┘                              └────┬────┘           │
│       │                                        │                │
│       │  1. POST /auth/login                   │                │
│       │     { email, password }                │                │
│       │───────────────────────────────────────▶│                │
│       │                                        │                │
│       │                           2. 验证凭据  │                │
│       │                              ├── 查找用户               │
│       │                              ├── 验证密码               │
│       │                              └── 生成 Token             │
│       │                                        │                │
│       │  3. Response                           │                │
│       │     { accessToken, refreshToken, user }│                │
│       │◀───────────────────────────────────────│                │
│       │                                        │                │
│       │  4. 存储 Token                         │                │
│       │     ├── accessToken → Memory           │                │
│       │     └── refreshToken → SecureStorage   │                │
│       │                                        │                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Apple Sign In

```
┌─────────────────────────────────────────────────────────────────┐
│                   Apple Sign In Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐   │
│  │  Client │     │  Apple  │     │  Server │     │   DB    │   │
│  └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘   │
│       │               │               │               │         │
│       │  1. 请求 Apple 登录           │               │         │
│       │──────────────▶│               │               │         │
│       │               │               │               │         │
│       │  2. 用户授权  │               │               │         │
│       │◀──────────────│               │               │         │
│       │  identityToken│               │               │         │
│       │  authCode     │               │               │         │
│       │               │               │               │         │
│       │  3. POST /auth/social/apple   │               │         │
│       │     { identityToken, user? }  │               │         │
│       │──────────────────────────────▶│               │         │
│       │               │               │               │         │
│       │               │  4. 验证 Apple Token          │         │
│       │               │◀──────────────│               │         │
│       │               │               │               │         │
│       │               │               │  5. 查找/创建用户       │
│       │               │               │──────────────▶│         │
│       │               │               │               │         │
│       │  6. Response  │               │               │         │
│       │     { accessToken, refreshToken, user }       │         │
│       │◀──────────────────────────────│               │         │
│       │               │               │               │         │
│                                                                  │
│  首次登录时 Apple 返回的 user 信息只传递一次                     │
│  ├── 包含: email, fullName                                      │
│  └── 需要在客户端传递给服务器保存                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Google Sign In

```
┌─────────────────────────────────────────────────────────────────┐
│                   Google Sign In Flow                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐   │
│  │  Client │     │  Google │     │  Server │     │   DB    │   │
│  └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘   │
│       │               │               │               │         │
│       │  1. 请求 Google 登录          │               │         │
│       │──────────────▶│               │               │         │
│       │               │               │               │         │
│       │  2. OAuth 授权│               │               │         │
│       │◀──────────────│               │               │         │
│       │  idToken      │               │               │         │
│       │               │               │               │         │
│       │  3. POST /auth/social/google  │               │         │
│       │     { idToken }               │               │         │
│       │──────────────────────────────▶│               │         │
│       │               │               │               │         │
│       │               │  4. 验证 Google Token         │         │
│       │               │◀──────────────│               │         │
│       │               │               │               │         │
│       │               │               │  5. 查找/创建用户       │
│       │               │               │──────────────▶│         │
│       │               │               │               │         │
│       │  6. Response  │               │               │         │
│       │     { accessToken, refreshToken, user }       │         │
│       │◀──────────────────────────────│               │         │
│       │               │               │               │         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Token 刷新流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   Token Refresh Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐                              ┌─────────┐           │
│  │  Client │                              │  Server │           │
│  └────┬────┘                              └────┬────┘           │
│       │                                        │                │
│       │  1. API 请求                           │                │
│       │     Authorization: Bearer {token}      │                │
│       │───────────────────────────────────────▶│                │
│       │                                        │                │
│       │  2. 401 Unauthorized                   │                │
│       │     { error: "AUTH_TOKEN_EXPIRED" }    │                │
│       │◀───────────────────────────────────────│                │
│       │                                        │                │
│       │  3. POST /auth/refresh                 │                │
│       │     { refreshToken }                   │                │
│       │───────────────────────────────────────▶│                │
│       │                                        │                │
│       │                           4. 验证 Refresh Token         │
│       │                              ├── 检查有效性             │
│       │                              ├── 生成新 Token           │
│       │                              └── 废弃旧 Token           │
│       │                                        │                │
│       │  5. Response                           │                │
│       │     { accessToken, refreshToken }      │                │
│       │◀───────────────────────────────────────│                │
│       │                                        │                │
│       │  6. 重试原请求                         │                │
│       │───────────────────────────────────────▶│                │
│       │                                        │                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 访客模式

```
┌─────────────────────────────────────────────────────────────────┐
│                      Guest Mode                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  访客账户                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  特点                                                    │    │
│  │  ├── 无需注册即可体验                                    │    │
│  │  ├── 数据存储在本地                                      │    │
│  │  ├── 功能受限                                            │    │
│  │  └── 可升级为正式账户                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  访客 → 正式账户升级流程                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌─────────────┐                                        │    │
│  │  │  Guest User │                                        │    │
│  │  │  (Local)    │                                        │    │
│  │  └──────┬──────┘                                        │    │
│  │         │                                                │    │
│  │         ▼ 选择注册方式                                   │    │
│  │  ┌─────────────────────────────────────────┐            │    │
│  │  │  Email/Password │ Apple │ Google        │            │    │
│  │  └────────┬────────────────────────────────┘            │    │
│  │           │                                              │    │
│  │           ▼                                              │    │
│  │  ┌─────────────────────────────────────────┐            │    │
│  │  │           迁移本地数据                    │            │    │
│  │  │  ├── 阅读进度                            │            │    │
│  │  │  ├── 词汇列表                            │            │    │
│  │  │  └── 学习统计                            │            │    │
│  │  └────────┬────────────────────────────────┘            │    │
│  │           │                                              │    │
│  │           ▼                                              │    │
│  │  ┌─────────────────┐                                    │    │
│  │  │ Registered User │                                    │    │
│  │  │   (Synced)      │                                    │    │
│  │  └─────────────────┘                                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 多设备支持

```
┌─────────────────────────────────────────────────────────────────┐
│                   Multi-Device Support                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  设备管理                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Device Record                                           │    │
│  │  ├── deviceId: 设备唯一标识                              │    │
│  │  ├── platform: ios / android / web                       │    │
│  │  ├── model: 设备型号                                     │    │
│  │  ├── appVersion: 应用版本                                │    │
│  │  ├── lastActive: 最后活跃时间                            │    │
│  │  └── refreshToken: 关联的刷新令牌                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  同步策略                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                       Server                             │    │
│  │                         │                                │    │
│  │    ┌────────────────────┼────────────────────┐          │    │
│  │    │                    │                    │          │    │
│  │    ▼                    ▼                    ▼          │    │
│  │  ┌──────┐          ┌──────┐          ┌──────┐          │    │
│  │  │iPhone│          │ iPad │          │ Web  │          │    │
│  │  └──────┘          └──────┘          └──────┘          │    │
│  │                                                          │    │
│  │  同步数据:                                               │    │
│  │  ├── 阅读进度 (基于时间戳冲突解决)                       │    │
│  │  ├── 词汇列表                                            │    │
│  │  └── 用户设置                                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 登出流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      Logout Flow                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  单设备登出                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. POST /auth/logout                                    │    │
│  │  2. 服务端废弃 Refresh Token                             │    │
│  │  3. 客户端清除本地 Token                                 │    │
│  │  4. 重定向到登录页                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  全设备登出                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. POST /auth/logout-all                                │    │
│  │  2. 服务端废弃所有 Refresh Token                         │    │
│  │  3. 所有设备强制重新登录                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 安全措施

```
┌─────────────────────────────────────────────────────────────────┐
│                    Security Measures                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  传输安全                                                        │
│  ├── HTTPS 强制                                                 │
│  ├── TLS 1.2+                                                   │
│  └── Certificate Pinning (Mobile)                               │
│                                                                  │
│  存储安全                                                        │
│  ├── iOS: Keychain                                              │
│  ├── Android: EncryptedSharedPreferences                        │
│  ├── Web: HttpOnly Cookie / Secure Storage                      │
│  └── React Native: expo-secure-store                            │
│                                                                  │
│  Token 安全                                                      │
│  ├── 短期 Access Token (1h)                                     │
│  ├── Refresh Token Rotation                                     │
│  ├── 可撤销的 Token                                             │
│  └── 异常检测 (地理位置、设备指纹)                               │
│                                                                  │
│  密码策略                                                        │
│  ├── 最小长度: 8 字符                                           │
│  ├── 复杂度要求: 字母 + 数字                                    │
│  ├── bcrypt 加密存储                                            │
│  └── 防暴力破解 (速率限制)                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## API 端点

```
┌─────────────────────────────────────────────────────────────────┐
│                    Auth API Endpoints                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Endpoint                │ Method │ Description            │ │
│  ├──────────────────────────┼────────┼────────────────────────┤ │
│  │  /auth/register          │ POST   │ 邮箱注册               │ │
│  │  /auth/login             │ POST   │ 邮箱登录               │ │
│  │  /auth/social/apple      │ POST   │ Apple 登录             │ │
│  │  /auth/social/google     │ POST   │ Google 登录            │ │
│  │  /auth/refresh           │ POST   │ 刷新 Token             │ │
│  │  /auth/logout            │ POST   │ 登出                   │ │
│  │  /auth/logout-all        │ POST   │ 全设备登出             │ │
│  │  /auth/profile           │ GET    │ 获取用户信息           │ │
│  │  /auth/profile           │ PATCH  │ 更新用户信息           │ │
│  │  /auth/password          │ PATCH  │ 修改密码               │ │
│  │  /auth/forgot-password   │ POST   │ 忘记密码               │ │
│  │  /auth/reset-password    │ POST   │ 重置密码               │ │
│  │  /auth/verify-email      │ POST   │ 验证邮箱               │ │
│  │  /auth/devices           │ GET    │ 获取设备列表           │ │
│  │  /auth/devices/:id       │ DELETE │ 移除设备               │ │
│  └──────────────────────────┴────────┴────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 各平台实现

```
┌─────────────────────────────────────────────────────────────────┐
│                Platform Implementations                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  iOS                                                             │
│  ├── Apple Sign In: AuthenticationServices                      │
│  ├── Google Sign In: GoogleSignIn SDK                           │
│  ├── Token 存储: Keychain                                       │
│  └── 认证管理: AuthManager (Singleton)                          │
│                                                                  │
│  Android                                                         │
│  ├── Google Sign In: Credential Manager                         │
│  ├── Token 存储: EncryptedSharedPreferences                     │
│  └── 认证管理: AuthRepository                                   │
│                                                                  │
│  React Native                                                    │
│  ├── Apple Sign In: expo-apple-authentication                   │
│  ├── Google Sign In: expo-auth-session                          │
│  ├── Token 存储: expo-secure-store                              │
│  └── 认证管理: authStore (Zustand)                              │
│                                                                  │
│  Web                                                             │
│  ├── Google Sign In: @react-oauth/google                        │
│  ├── Token 存储: HttpOnly Cookie                                │
│  └── 认证管理: NextAuth.js                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

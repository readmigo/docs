# 客户端集成指南

## 概述

```
┌─────────────────────────────────────────────────────────────────┐
│                  Client Integration Guide                        │
├─────────────────────────────────────────────────────────────────┤
│  本文档描述各平台如何集成后端 API                                │
│  ├── API 客户端配置                                             │
│  ├── Token 管理                                                 │
│  ├── 错误处理                                                   │
│  └── 通用模式                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## API 客户端架构

```
┌─────────────────────────────────────────────────────────────────┐
│                 API Client Architecture                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Application Layer                     │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │               Feature Modules                    │    │    │
│  │  │  (Auth, Books, Vocabulary, Learning, etc.)      │    │    │
│  │  └──────────────────────┬──────────────────────────┘    │    │
│  └─────────────────────────┼────────────────────────────────┘    │
│                            │                                     │
│                            ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     API Service Layer                    │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │              API Module Services                 │    │    │
│  │  │  (authApi, booksApi, vocabularyApi, etc.)       │    │    │
│  │  └──────────────────────┬──────────────────────────┘    │    │
│  └─────────────────────────┼────────────────────────────────┘    │
│                            │                                     │
│                            ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      API Client                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  ├── Base URL Configuration                     │    │    │
│  │  │  ├── Request Interceptors                       │    │    │
│  │  │  │   ├── Auth Token Injection                   │    │    │
│  │  │  │   ├── Accept-Language Header                 │    │    │
│  │  │  │   └── Correlation ID                         │    │    │
│  │  │  ├── Response Interceptors                      │    │    │
│  │  │  │   ├── Error Handling                         │    │    │
│  │  │  │   └── Token Refresh (on 401)                 │    │    │
│  │  │  └── Timeout Configuration                      │    │    │
│  │  └──────────────────────┬──────────────────────────┘    │    │
│  └─────────────────────────┼────────────────────────────────┘    │
│                            │                                     │
│                            ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    HTTP Library                          │    │
│  │  iOS: URLSession    Android: OkHttp    Web/RN: Axios    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 平台特定配置

```
┌─────────────────────────────────────────────────────────────────┐
│               Platform-Specific Configuration                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  iOS (Swift)                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  HTTP 库: URLSession (原生)                              │    │
│  │  JSON 解析: Codable                                      │    │
│  │  Token 存储: Keychain                                    │    │
│  │  并发: async/await                                       │    │
│  │                                                          │    │
│  │  核心文件:                                               │    │
│  │  ├── APIClient.swift        API 客户端                   │    │
│  │  ├── APIEndpoint.swift      端点定义                     │    │
│  │  ├── AuthManager.swift      认证管理                     │    │
│  │  └── KeychainService.swift  Token 存储                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Android (Kotlin)                                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  HTTP 库: OkHttp + Retrofit                              │    │
│  │  JSON 解析: Moshi / Gson                                 │    │
│  │  Token 存储: EncryptedSharedPreferences                  │    │
│  │  并发: Coroutines + Flow                                 │    │
│  │                                                          │    │
│  │  核心文件:                                               │    │
│  │  ├── ApiClient.kt           API 客户端                   │    │
│  │  ├── ApiService.kt          Retrofit 接口                │    │
│  │  ├── AuthInterceptor.kt     Token 注入                   │    │
│  │  └── TokenManager.kt        Token 管理                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  React Native                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  HTTP 库: Axios                                          │    │
│  │  JSON 解析: 原生 JSON                                    │    │
│  │  Token 存储: expo-secure-store                           │    │
│  │  状态管理: Zustand + React Query                         │    │
│  │                                                          │    │
│  │  核心文件:                                               │    │
│  │  ├── apiClient.ts           Axios 实例                   │    │
│  │  ├── api/*.ts               各模块 API                   │    │
│  │  └── authStore.ts           认证状态                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Web (Next.js)                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  HTTP 库: Axios / fetch                                  │    │
│  │  JSON 解析: 原生 JSON                                    │    │
│  │  Token 存储: HttpOnly Cookie                             │    │
│  │  状态管理: React Query                                   │    │
│  │                                                          │    │
│  │  核心文件:                                               │    │
│  │  ├── apiClient.ts           API 客户端                   │    │
│  │  ├── api/*.ts               各模块 API                   │    │
│  │  └── auth.ts                NextAuth 配置                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 请求拦截器

```
┌─────────────────────────────────────────────────────────────────┐
│                   Request Interceptors                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  请求拦截流程                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌───────────────┐                                      │    │
│  │  │ Original Req  │                                      │    │
│  │  └───────┬───────┘                                      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 1. Add Auth Header                             │      │    │
│  │  │    Authorization: Bearer {accessToken}        │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 2. Add Language Header                         │      │    │
│  │  │    Accept-Language: {userLanguage}            │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 3. Add Platform Headers                        │      │    │
│  │  │    X-Platform: ios/android/web/mobile         │      │    │
│  │  │    X-App-Version: {version}                   │      │    │
│  │  │    X-Bundle-Id: com.readmigo.app              │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 4. Add Correlation ID                          │      │    │
│  │  │    X-Correlation-Id: {uuid}                   │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────┐                                      │    │
│  │  │ Final Request │                                      │    │
│  │  └───────────────┘                                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 响应拦截器

```
┌─────────────────────────────────────────────────────────────────┐
│                   Response Interceptors                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  响应拦截流程                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌───────────────┐                                      │    │
│  │  │   Response    │                                      │    │
│  │  └───────┬───────┘                                      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │            Check Status Code                   │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │    ┌─────┴─────┬─────────────┬─────────────┐            │    │
│  │    │           │             │             │            │    │
│  │    ▼           ▼             ▼             ▼            │    │
│  │  2xx         401           4xx           5xx            │    │
│  │  成功      未认证         客户端错误     服务器错误      │    │
│  │    │           │             │             │            │    │
│  │    │           ▼             │             │            │    │
│  │    │   ┌───────────────┐    │             │            │    │
│  │    │   │ Try Refresh   │    │             │            │    │
│  │    │   │ Token         │    │             │            │    │
│  │    │   └───────┬───────┘    │             │            │    │
│  │    │           │             │             │            │    │
│  │    │     ┌─────┴─────┐      │             │            │    │
│  │    │     │           │      │             │            │    │
│  │    │     ▼           ▼      │             │            │    │
│  │    │   成功        失败     │             │            │    │
│  │    │     │           │      │             │            │    │
│  │    │     │           ▼      ▼             ▼            │    │
│  │    │     │   ┌─────────────────────────────────┐       │    │
│  │    │     │   │       Throw Error               │       │    │
│  │    │     │   │  ├── Parse Error Response      │       │    │
│  │    │     │   │  ├── Extract Error Code        │       │    │
│  │    │     │   │  └── Create Typed Error        │       │    │
│  │    │     │   └─────────────────────────────────┘       │    │
│  │    │     │                                              │    │
│  │    │     ▼                                              │    │
│  │    │   Retry Original Request                          │    │
│  │    │     │                                              │    │
│  │    ▼     ▼                                              │    │
│  │  ┌─────────────┐                                        │    │
│  │  │   Return    │                                        │    │
│  │  │   Data      │                                        │    │
│  │  └─────────────┘                                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Token 刷新流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  Token Refresh Flow                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌───────────────┐                                      │    │
│  │  │ 401 Response  │                                      │    │
│  │  └───────┬───────┘                                      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ Check if refresh already in progress          │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │    ┌─────┴─────┐                                        │    │
│  │    │           │                                         │    │
│  │    ▼           ▼                                         │    │
│  │  进行中       否                                         │    │
│  │    │           │                                         │    │
│  │    │           ▼                                         │    │
│  │    │   ┌───────────────────────────────────────┐        │    │
│  │    │   │ Set refreshing = true                  │        │    │
│  │    │   │ POST /auth/refresh                     │        │    │
│  │    │   │ { refreshToken }                       │        │    │
│  │    │   └───────────────────────────────────────┘        │    │
│  │    │           │                                         │    │
│  │    │     ┌─────┴─────┐                                  │    │
│  │    │     │           │                                   │    │
│  │    │     ▼           ▼                                   │    │
│  │    │   成功        失败                                  │    │
│  │    │     │           │                                   │    │
│  │    │     │           ▼                                   │    │
│  │    │     │   ┌───────────────────────────────┐          │    │
│  │    │     │   │ Clear tokens                   │          │    │
│  │    │     │   │ Navigate to login              │          │    │
│  │    │     │   │ Reject pending requests        │          │    │
│  │    │     │   └───────────────────────────────┘          │    │
│  │    │     │                                               │    │
│  │    │     ▼                                               │    │
│  │    │   ┌───────────────────────────────────────┐        │    │
│  │    │   │ Store new tokens                       │        │    │
│  │    │   │ Set refreshing = false                 │        │    │
│  │    │   │ Retry queued requests                  │        │    │
│  │    │   └───────────────────────────────────────┘        │    │
│  │    │     │                                               │    │
│  │    ▼     ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ Wait for refresh completion                    │      │    │
│  │  │ Retry original request with new token          │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  关键点:                                                         │
│  ├── 使用锁/标志防止并发刷新                                    │
│  ├── 队列化等待中的请求                                          │
│  ├── 刷新成功后重试所有排队请求                                  │
│  └── 刷新失败时清除状态并跳转登录                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 错误处理

```
┌─────────────────────────────────────────────────────────────────┐
│                     Error Handling                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  错误类型                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  APIError                                                │    │
│  │  ├── NetworkError        网络连接失败                    │    │
│  │  ├── TimeoutError        请求超时                        │    │
│  │  ├── UnauthorizedError   401 未认证                      │    │
│  │  ├── ForbiddenError      403 权限不足                    │    │
│  │  ├── NotFoundError       404 资源不存在                  │    │
│  │  ├── ValidationError     422 参数验证失败                │    │
│  │  ├── ServerError         500 服务器错误                  │    │
│  │  └── UnknownError        未知错误                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  错误处理策略                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  错误类型            处理方式                            │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  NetworkError        显示重试按钮                        │    │
│  │  TimeoutError        显示重试按钮                        │    │
│  │  UnauthorizedError   尝试刷新 Token / 跳转登录           │    │
│  │  ForbiddenError      显示无权限提示                      │    │
│  │  NotFoundError       显示 404 页面                       │    │
│  │  ValidationError     表单字段显示错误                    │    │
│  │  ServerError         显示服务器错误提示                  │    │
│  │  QuotaExceeded       显示升级提示                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  用户提示                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  错误码                 用户提示                         │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  AUTH_INVALID_TOKEN     请重新登录                       │    │
│  │  AUTH_EMAIL_EXISTS      该邮箱已被注册                   │    │
│  │  VALIDATION_ERROR       请检查输入内容                   │    │
│  │  QUOTA_EXCEEDED         今日次数已用完                   │    │
│  │  NETWORK_ERROR          网络连接失败，请重试             │    │
│  │  SERVER_ERROR           服务暂时不可用，请稍后重试       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 缓存策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    Caching Strategy                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  React Query 缓存配置                                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  数据类型          staleTime     cacheTime     说明      │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  用户信息          5 min         30 min       较少变化  │    │
│  │  书籍列表          1 min         10 min       可能更新  │    │
│  │  书籍详情          10 min        1 hour       相对稳定  │    │
│  │  阅读进度          30 sec        5 min        频繁更新  │    │
│  │  词汇列表          1 min         10 min       用户操作  │    │
│  │  学习统计          1 min         10 min       频繁更新  │    │
│  │  AI 解释           30 min        24 hour      稳定数据  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  离线缓存                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  iOS:    URLCache + Core Data                            │    │
│  │  Android: Room + OkHttp Cache                            │    │
│  │  RN:     AsyncStorage + React Query Persist              │    │
│  │                                                          │    │
│  │  离线优先数据:                                           │    │
│  │  ├── 用户书架                                            │    │
│  │  ├── 已下载书籍内容                                      │    │
│  │  ├── 词汇列表                                            │    │
│  │  └── 阅读进度 (同步队列)                                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据同步

```
┌─────────────────────────────────────────────────────────────────┐
│                     Data Synchronization                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  同步策略                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  阅读进度同步                                            │    │
│  │  ├── 本地优先: 立即更新 UI                               │    │
│  │  ├── 后台同步: 防抖 3 秒后上传                           │    │
│  │  ├── 冲突解决: 以较新的 lastReadAt 为准                  │    │
│  │  └── 离线队列: 存储待同步变更                            │    │
│  │                                                          │    │
│  │  词汇同步                                                │    │
│  │  ├── 创建/删除: 立即同步                                 │    │
│  │  ├── 复习结果: 实时上传                                  │    │
│  │  └── 冲突: 合并 (取最新)                                 │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  同步流程                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌───────────────┐                                      │    │
│  │  │ Local Change  │                                      │    │
│  │  └───────┬───────┘                                      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 1. Update Local State (Optimistic)             │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 2. Add to Sync Queue                           │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │          ▼                                               │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 3. Check Network                               │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │    ┌─────┴─────┐                                        │    │
│  │    │           │                                         │    │
│  │    ▼           ▼                                         │    │
│  │  Online      Offline                                     │    │
│  │    │           │                                         │    │
│  │    │           ▼                                         │    │
│  │    │   ┌───────────────────────────────────────┐        │    │
│  │    │   │ Wait for connectivity                  │        │    │
│  │    │   └───────────────────────────────────────┘        │    │
│  │    │           │                                         │    │
│  │    ▼           ▼                                         │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 4. Sync to Server                              │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │          │                                               │    │
│  │    ┌─────┴─────┐                                        │    │
│  │    │           │                                         │    │
│  │    ▼           ▼                                         │    │
│  │  成功        失败                                        │    │
│  │    │           │                                         │    │
│  │    │           ▼                                         │    │
│  │    │   ┌───────────────────────────────────────┐        │    │
│  │    │   │ Retry with exponential backoff         │        │    │
│  │    │   └───────────────────────────────────────┘        │    │
│  │    │                                                     │    │
│  │    ▼                                                     │    │
│  │  ┌───────────────────────────────────────────────┐      │    │
│  │  │ 5. Remove from Queue                           │      │    │
│  │  └───────────────────────────────────────────────┘      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 环境配置

```
┌─────────────────────────────────────────────────────────────────┐
│                 Environment Configuration                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  环境变量                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  变量名                   开发                 生产      │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  API_BASE_URL             debug.fly.dev      api.readmigo│   │
│  │  ENABLE_LOGS              true               false       │    │
│  │  REVENUECAT_KEY           rc_test_xxx        rc_prod_xxx │    │
│  │  SENTRY_DSN               -                  sentry.io/x │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  平台配置文件                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  iOS:       Info.plist, .xcconfig                        │    │
│  │  Android:   BuildConfig, gradle.properties               │    │
│  │  RN:        .env, app.config.ts                          │    │
│  │  Web:       .env.local, .env.production                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

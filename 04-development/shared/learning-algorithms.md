# 学习算法文档

## 概述

```
┌─────────────────────────────────────────────────────────────────┐
│                   Learning Algorithms                            │
├─────────────────────────────────────────────────────────────────┤
│  核心算法                                                        │
│  ├── 间隔重复 (Spaced Repetition)                               │
│  ├── 掌握度计算 (Mastery Calculation)                           │
│  ├── 连续天数 (Streak)                                          │
│  ├── 难度评估 (Difficulty Assessment)                           │
│  └── 推荐算法 (Recommendation)                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 间隔重复算法 (SM-2)

```
┌─────────────────────────────────────────────────────────────────┐
│                 Spaced Repetition (SM-2)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  算法原理                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  基于 SuperMemo 2 (SM-2) 算法                            │    │
│  │  核心: 根据回答质量动态调整复习间隔                      │    │
│  │                                                          │    │
│  │  关键参数:                                               │    │
│  │  ├── EF (Easiness Factor): 简易度因子 (1.3 - 2.5)        │    │
│  │  ├── n: 复习次数                                         │    │
│  │  ├── I(n): 第 n 次复习的间隔天数                         │    │
│  │  └── q: 回答质量 (0-5)                                   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  间隔计算                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  I(1) = 1 天                                             │    │
│  │  I(2) = 6 天                                             │    │
│  │  I(n) = I(n-1) × EF    (n > 2)                          │    │
│  │                                                          │    │
│  │  EF 更新公式:                                            │    │
│  │  EF' = EF + (0.1 - (5-q) × (0.08 + (5-q) × 0.02))       │    │
│  │                                                          │    │
│  │  约束: EF ≥ 1.3                                          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  回答质量映射                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  用户操作            质量评分 (q)    间隔影响            │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  完全正确 (Easy)         5          大幅延长             │    │
│  │  正确 (Good)             4          正常延长             │    │
│  │  勉强正确 (Hard)         3          小幅延长             │    │
│  │  错误 (Wrong)            2          重置间隔             │    │
│  │  完全忘记 (Forgot)       1          重新开始             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 间隔重复流程

```
┌─────────────────────────────────────────────────────────────────┐
│              Spaced Repetition Flow                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────┐                                              │
│  │  新词添加     │                                              │
│  │  EF = 2.5     │                                              │
│  │  n = 0        │                                              │
│  └───────┬───────┘                                              │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    复习队列                                │  │
│  │  按 nextReviewAt 排序                                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────┐                                              │
│  │  显示词汇卡片 │                                              │
│  │  (隐藏释义)   │                                              │
│  └───────┬───────┘                                              │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────┐                                              │
│  │  用户回忆     │                                              │
│  └───────┬───────┘                                              │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────┐                                              │
│  │  显示正确答案 │                                              │
│  └───────┬───────┘                                              │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              用户评价自己的回答                            │  │
│  │                                                            │  │
│  │   [Again]    [Hard]    [Good]    [Easy]                   │  │
│  │    1 min     10 min     1 day     4 days                  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│          │                                                       │
│          ▼                                                       │
│  ┌───────────────┐                                              │
│  │  计算新间隔   │                                              │
│  │  更新 EF      │                                              │
│  │  设置下次复习 │                                              │
│  └───────────────┘                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 间隔示例

```
┌─────────────────────────────────────────────────────────────────┐
│                   Interval Examples                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  假设 EF = 2.5，连续回答 "Good"                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  复习次数     间隔        累计天数                       │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │     1         1 天         1                            │    │
│  │     2         6 天         7                            │    │
│  │     3        15 天        22                            │    │
│  │     4        38 天        60                            │    │
│  │     5        95 天       155                            │    │
│  │     6       238 天       393                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  时间线可视化                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Day 0    Day 1    Day 7     Day 22    Day 60   Day 155 │    │
│  │    │        │        │          │         │        │    │    │
│  │    ●────────●────────●──────────●─────────●────────●    │    │
│  │   新词    复习1    复习2      复习3     复习4    复习5  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 掌握度计算

```
┌─────────────────────────────────────────────────────────────────┐
│                  Mastery Calculation                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  掌握度公式                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  mastery = (correctCount / reviewCount) × 100           │    │
│  │           × stabilityFactor                              │    │
│  │                                                          │    │
│  │  stabilityFactor = min(1, n / 5)                        │    │
│  │  (复习 5 次以上才达到稳定)                               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  掌握度等级                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  0-20%    ████░░░░░░░░░░░░░░░░   新词 / 完全不熟        │    │
│  │  21-40%   ████████░░░░░░░░░░░░   模糊认识               │    │
│  │  41-60%   ████████████░░░░░░░░   基本掌握               │    │
│  │  61-80%   ████████████████░░░░   较好掌握               │    │
│  │  81-100%  ████████████████████   完全掌握               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  掌握度影响                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ├── 影响复习优先级 (低掌握度优先)                       │    │
│  │  ├── 影响每日目标计算                                    │    │
│  │  ├── 影响学习统计展示                                    │    │
│  │  └── 影响词汇卡片排序                                    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 连续天数算法

```
┌─────────────────────────────────────────────────────────────────┐
│                    Streak Algorithm                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  连续计算规则                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  条件: 每日至少完成 1 个学习活动                         │    │
│  │                                                          │    │
│  │  学习活动包括:                                           │    │
│  │  ├── 阅读达到每日目标 (分钟数)                           │    │
│  │  ├── 完成词汇复习                                        │    │
│  │  └── 学习新词汇                                          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  连续更新逻辑                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  每日首次学习活动时检查:                                 │    │
│  │                                                          │    │
│  │  if (lastActiveDate == today) {                         │    │
│  │    // 今天已学习，不更新                                 │    │
│  │  } else if (lastActiveDate == yesterday) {              │    │
│  │    // 连续，增加天数                                     │    │
│  │    currentStreak++                                       │    │
│  │    lastActiveDate = today                                │    │
│  │  } else {                                                │    │
│  │    // 断连，重置                                         │    │
│  │    currentStreak = 1                                     │    │
│  │    streakStartDate = today                               │    │
│  │    lastActiveDate = today                                │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  │  // 更新最长记录                                         │    │
│  │  longestStreak = max(longestStreak, currentStreak)      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  时区处理                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ├── 使用用户本地时区判断"今天"                          │    │
│  │  ├── 服务端存储 UTC 时间                                 │    │
│  │  └── 连续计算基于用户时区的日期边界                      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  连续保护机制 (可选)                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Streak Freeze: 允许跳过一天不断连                       │    │
│  │  ├── Premium 用户每月 2 次                               │    │
│  │  └── 需手动激活或自动激活                                │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 难度评估算法

```
┌─────────────────────────────────────────────────────────────────┐
│                 Difficulty Assessment                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  书籍难度评估                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  基于 Flesch-Kincaid 可读性公式                          │    │
│  │                                                          │    │
│  │  Flesch Reading Ease = 206.835                           │    │
│  │                      - 1.015 × (words / sentences)       │    │
│  │                      - 84.6 × (syllables / words)        │    │
│  │                                                          │    │
│  │  分数范围: 0-100 (越高越简单)                            │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  难度分数映射                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  Flesch Score    难度分数    难度等级    适合水平        │    │
│  │  ────────────────────────────────────────────────────── │    │
│  │  90-100           10-20      非常简单    Beginner       │    │
│  │  80-89            21-35      简单        Elementary     │    │
│  │  70-79            36-50      较简单      Elementary+    │    │
│  │  60-69            51-65      标准        Intermediate   │    │
│  │  50-59            66-75      较难        Intermediate+  │    │
│  │  30-49            76-85      困难        Upper-Inter    │    │
│  │  0-29             86-100     非常困难    Advanced       │    │
│  │                                                          │    │
│  │  难度分数 = 100 - Flesch Score                          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  用户水平与难度匹配                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  用户水平         推荐难度范围                           │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  BEGINNER         0-30                                   │    │
│  │  ELEMENTARY       20-50                                  │    │
│  │  INTERMEDIATE     40-70                                  │    │
│  │  UPPER_INTER      60-85                                  │    │
│  │  ADVANCED         75-100                                 │    │
│  │                                                          │    │
│  │  推荐书籍时优先选择用户水平范围内的书籍                  │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 每日目标算法

```
┌─────────────────────────────────────────────────────────────────┐
│                   Daily Goal Algorithm                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  目标设置                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  可配置目标:                                             │    │
│  │  ├── 每日阅读时长: 5 / 10 / 15 / 20 / 30 分钟           │    │
│  │  └── 每日词汇目标: 5 / 10 / 15 / 20 个                  │    │
│  │                                                          │    │
│  │  默认目标:                                               │    │
│  │  ├── 阅读: 15 分钟                                       │    │
│  │  └── 词汇: 10 个                                         │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  目标完成计算                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  readingProgress = currentReadingMinutes / goalMinutes   │    │
│  │  vocabularyProgress = (wordsLearned + wordsReviewed)     │    │
│  │                       / goalWords                         │    │
│  │                                                          │    │
│  │  goalAchieved = readingProgress >= 1                     │    │
│  │                 OR vocabularyProgress >= 1               │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  目标进度可视化                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌──────────────────────────────────────────────────┐   │    │
│  │  │                                                   │   │    │
│  │  │  Today's Goal                                     │   │    │
│  │  │                                                   │   │    │
│  │  │  阅读  ████████████░░░░░░░░  12/15 min  80%      │   │    │
│  │  │                                                   │   │    │
│  │  │  词汇  ██████████████████░░   9/10     90%       │   │    │
│  │  │                                                   │   │    │
│  │  │                        [继续学习]                 │   │    │
│  │  │                                                   │   │    │
│  │  └──────────────────────────────────────────────────┘   │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 学习统计算法

```
┌─────────────────────────────────────────────────────────────────┐
│                Learning Statistics Algorithm                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  每日统计聚合                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  每日 UTC 00:00 创建新的 DailyStats 记录                 │    │
│  │                                                          │    │
│  │  聚合数据:                                               │    │
│  │  ├── readingMinutes: 所有阅读会话时长之和                │    │
│  │  ├── pagesRead: 所有阅读会话页数之和                     │    │
│  │  ├── wordsLearned: 当日新增词汇数                        │    │
│  │  ├── wordsReviewed: 当日复习词汇数                       │    │
│  │  └── sessionsCount: 阅读会话次数                         │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  周统计计算                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  weeklyStats = {                                         │    │
│  │    totalReadingMinutes: sum(daily.readingMinutes),       │    │
│  │    totalWordsLearned: sum(daily.wordsLearned),           │    │
│  │    totalWordsReviewed: sum(daily.wordsReviewed),         │    │
│  │    activeDays: count(daily where goalAchieved),          │    │
│  │    avgDailyMinutes: avg(daily.readingMinutes),           │    │
│  │    weekStartDate: Monday                                 │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  月统计计算                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  monthlyStats = {                                        │    │
│  │    totalReadingMinutes: sum(daily.readingMinutes),       │    │
│  │    totalWordsLearned: sum(daily.wordsLearned),           │    │
│  │    booksCompleted: count(books where progress == 100),   │    │
│  │    averageStreak: avg(weekly.activeDays),                │    │
│  │    monthStartDate: 1st of month                          │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 年度报告算法

```
┌─────────────────────────────────────────────────────────────────┐
│                  Annual Report Algorithm                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  报告数据聚合                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  annualReport = {                                        │    │
│  │    // 阅读统计                                           │    │
│  │    totalReadingMinutes: sum(monthly.readingMinutes),     │    │
│  │    totalBooksStarted: count(distinct userBooks),         │    │
│  │    totalBooksCompleted: count(completed books),          │    │
│  │    totalPagesRead: sum(monthly.pagesRead),               │    │
│  │                                                          │    │
│  │    // 词汇统计                                           │    │
│  │    totalWordsLearned: count(vocabulary created in year), │    │
│  │    totalWordsMastered: count(vocabulary mastery >= 80),  │    │
│  │                                                          │    │
│  │    // 连续统计                                           │    │
│  │    longestStreak: max(streak during year),               │    │
│  │    totalActiveDays: count(days with activity),           │    │
│  │                                                          │    │
│  │    // 阅读偏好                                           │    │
│  │    topGenres: top 3 genres by reading time,              │    │
│  │    favoriteBook: book with most reading time,            │    │
│  │    readingPattern: most active time of day               │    │
│  │  }                                                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  报告生成时机                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ├── 年末自动生成 (12月31日)                             │    │
│  │  ├── 用户手动请求生成                                    │    │
│  │  └── 仅 Premium Annual 用户可访问                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 推荐算法

```
┌─────────────────────────────────────────────────────────────────┐
│                 Recommendation Algorithm                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  推荐因素                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  难度匹配 (权重: 40%)                                    │    │
│  │  ├── 用户英语水平 → 推荐难度范围                         │    │
│  │  └── 渐进式难度提升 (当前+10%)                           │    │
│  │                                                          │    │
│  │  兴趣匹配 (权重: 35%)                                    │    │
│  │  ├── 历史阅读类型偏好                                    │    │
│  │  ├── 显式用户兴趣标签                                    │    │
│  │  └── 相似用户协同过滤                                    │    │
│  │                                                          │    │
│  │  新鲜度 (权重: 15%)                                      │    │
│  │  ├── 新上架书籍加成                                      │    │
│  │  └── 未读过的作者加成                                    │    │
│  │                                                          │    │
│  │  热门度 (权重: 10%)                                      │    │
│  │  ├── 全局阅读人数                                        │    │
│  │  └── 近期阅读趋势                                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  推荐公式                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  score = difficultyScore × 0.4                           │    │
│  │        + interestScore × 0.35                            │    │
│  │        + freshnessScore × 0.15                           │    │
│  │        + popularityScore × 0.1                           │    │
│  │                                                          │    │
│  │  过滤条件:                                               │    │
│  │  ├── 排除已在用户书架中的书籍                            │    │
│  │  ├── 排除已完成的书籍                                    │    │
│  │  └── 难度在用户可接受范围内 (±20)                        │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

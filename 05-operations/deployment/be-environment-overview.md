# Backend 环境隔离概述

> 四层环境架构设计与核心原则

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────────┐
│                    环境隔离设计                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  四层环境架构                                                    │
│  ├── Local      - 本地开发测试                                  │
│  ├── Debugging  - 功能调试验证                                  │
│  ├── Staging    - 预发布验证                                    │
│  └── Production - 生产服务                                      │
│                                                                  │
│  核心原则                                                        │
│  ├── 完全隔离 - 各环境数据库、缓存、存储独立                    │
│  ├── 生产保护 - 生产环境禁止调试功能                            │
│  ├── 数据安全 - 非生产环境使用匿名化数据                        │
│  ├── 渐进发布 - Local → Debugging → Staging → Production       │
│  └── 可观测性 - 所有日志、指标按环境标记                        │
│                                                                  │
│  相关文档                                                        │
│  ├── be-environment-configs.md (详细配置)                       │
│  └── environment-operations/backend-environment-operations.md (运维手册) │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 四层环境架构

### 2.1 架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            READMIGO ENVIRONMENT ISOLATION                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐    │
│  │    LOCAL      │  │   DEBUGGING   │  │    STAGING    │  │  PRODUCTION   │    │
│  │               │  │               │  │               │  │               │    │
│  │  开发者本机    │  │  远程调试环境  │  │  预发布环境    │  │   生产环境    │    │
│  │               │  │               │  │               │  │               │    │
│  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │    │
│  │ │ Local DB  │ │  │ │ Debug DB  │ │  │ │Staging DB │ │  │ │  Prod DB  │ │    │
│  │ │ (Docker)  │ │  │ │  (Neon)   │ │  │ │  (Neon)   │ │  │ │  (Neon)   │ │    │
│  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │    │
│  │               │  │               │  │               │  │               │    │
│  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │    │
│  │ │Local Redis│ │  │ │Debug Redis│ │  │ │  Staging  │ │  │ │Prod Redis │ │    │
│  │ │ (Docker)  │ │  │ │ (Upstash) │ │  │ │  Redis    │ │  │ │ (Upstash) │ │    │
│  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │    │
│  │               │  │               │  │               │  │               │    │
│  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌───────────┐ │    │
│  │ │ Local R2  │ │  │ │ Debug R2  │ │  │ │Staging R2 │ │  │ │  Prod R2  │ │    │
│  │ │  (MinIO)  │ │  │ │ (Bucket)  │ │  │ │ (Bucket)  │ │  │ │ (Bucket)  │ │    │
│  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │  │ └───────────┘ │    │
│  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘    │
│         │                  │                  │                  │              │
│         ▼                  ▼                  ▼                  ▼              │
│  localhost:3000   debug-api.readmigo.app  staging-api.readmigo.app  api.readmigo.app │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 环境定义

| 环境 | 用途 | API Base URL | 数据特点 | 适用场景 |
|------|------|--------------|----------|----------|
| **Local** | 本地开发测试 | `http://localhost:3000` | 种子数据/Mock数据 | 全栈本地开发、自动化测试、快速迭代 |
| **Debugging** | 功能调试验证 | `https://debug-api.readmigo.app` | 生产数据快照 | 特定功能调试、阅读器测试、设置验证 |
| **Staging** | 预发布验证 | `https://staging-api.readmigo.app` | 生产数据同步 | 全链路测试、上线前验证、回归测试 |
| **Production** | 生产服务 | `https://api.readmigo.app` | 真实用户数据 | 正式对外服务 |

---

## 3. 环境对比

| 特性 | Local | Debugging | Staging | Production |
|------|-------|-----------|---------|------------|
| **部署位置** | 本地 Docker | Fly.io | Fly.io | Fly.io |
| **数据库** | 本地 PostgreSQL | 云端独立实例 | 云端独立实例 | 云端主实例 |
| **数据来源** | Debug Snapshot | 生产快照(匿名) | 生产快照(匿名) | 真实数据 |
| **AI 服务** | Mock/真实 | 真实 API | 真实 API | 真实 API |
| **日志级别** | debug | debug | info | warn |
| **Sentry** | 禁用 | 启用 | 启用 | 启用 |
| **访问控制** | 无限制 | 开发团队 | 开发团队 | 正式客户端 |
| **调试端点** | 启用 | 启用 | 禁用 | 禁用 |
| **数据保护** | 无 | 匿名化 | 匿名化 | 加密+备份 |

---

## 4. 数据流向

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DATA FLOW BETWEEN ENVIRONMENTS                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                            PRODUCTION                                    │
│                         (Source of Truth)                                │
│                               │                                          │
│          ┌────────────────────┼────────────────────┐                    │
│          │                    │                    │                    │
│          ▼                    ▼                    ▼                    │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│   │   Daily     │      │   Weekly    │      │  On-Demand  │            │
│   │   Backup    │      │    Sync     │      │    Sync     │            │
│   └─────────────┘      └─────────────┘      └─────────────┘            │
│          │                    │                    │                    │
│          ▼                    ▼                    ▼                    │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│   │  Disaster   │      │   STAGING   │      │  DEBUGGING  │            │
│   │  Recovery   │      │  (Full Sync)│      │(Partial Sync│            │
│   └─────────────┘      └─────────────┘      └─────────────┘            │
│                               │                    │                    │
│                               ▼                    ▼                    │
│                        ┌─────────────┐      ┌─────────────┐            │
│                        │ Anonymizer  │      │ Anonymizer  │            │
│                        │   Script    │      │   Script    │            │
│                        └─────────────┘      └─────────────┘            │
│                                                                          │
│                          LOCAL (Optional)                                │
│                      Debugging Snapshot                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 核心原则

### 5.1 完全隔离

- 各环境数据库、缓存、存储完全独立
- 无交叉连接可能性
- 独立的 API 密钥和认证配置

### 5.2 生产保护

- 生产环境禁止调试功能和调试端点
- 严格的访问控制和 IP 白名单
- 审计日志记录敏感操作

### 5.3 数据安全

- 非生产环境使用匿名化数据
- 用户 PII 数据哈希处理
- 敏感表（订阅、支付）完全排除

### 5.4 渐进发布

```
Local → Debugging → Staging → Production
  │         │          │          │
  └─ 功能开发  └─ 功能验证  └─ 全链路测试  └─ 正式发布
```

### 5.5 可观测性

- 所有日志、指标、错误按环境标记
- Correlation ID 包含环境前缀
- Sentry 按环境分项目追踪

---

## 6. 相关文档

| 文档 | 说明 |
|------|------|
| [be-environment-configs.md](be-environment-configs.md) | 各环境详细配置、客户端切换 |
| [backend-environment-operations.md](./environment-operations/backend-environment-operations.md) | 数据同步、运维命令、监控 |
| [QUICK-START.md](../../QUICK-START.md) | 本地开发快速开始 |
| [fly-io.md](./services/fly-io.md) | Fly.io 部署与架构 |

---

*最后更新: 2025-12-31*

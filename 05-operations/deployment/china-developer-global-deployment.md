# 中国开发者全球部署策略

## 背景

作为中国大陆开发者，面临以下挑战：

| 维度 | 现状 |
|------|------|
| 开发者位置 | 中国大陆 |
| 后端服务 | fly.dev (海外) |
| 目标市场 | 全球用户 |
| App Store 账号 | 中国开发者账号 |
| 核心问题 | 开发时无法直接访问海外 API |

---

## 当前架构

```
┌─────────────────────────────────────────────────────────────┐
│                      服务端点配置                            │
├─────────────────┬───────────────────────────────────────────┤
│ 环境            │ API 地址                                   │
├─────────────────┼───────────────────────────────────────────┤
│ Local           │ http://localhost:3000/api/v1              │
│ Debugging       │ https://readmigo-debug.fly.dev/api/v1     │
│ Staging         │ https://staging-api.readmigo.app/api/v1   │
│ Production      │ https://api.readmigo.app/api/v1           │
└─────────────────┴───────────────────────────────────────────┘
```

---

## 策略一：App Store 上架策略

### 推荐方案：仅上架海外地区

```
┌─────────────────────────────────────────────────────────────┐
│                   App Store Connect 配置                     │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  可用地区设置                                         │   │
│   │                                                      │   │
│   │  [✓] 美国          [✓] 日本          [✓] 英国       │   │
│   │  [✓] 德国          [✓] 法国          [✓] 加拿大     │   │
│   │  [✓] 澳大利亚      [✓] 韩国          [✓] 新加坡     │   │
│   │  [ ] 中国大陆      [✓] 香港          [✓] 台湾       │   │
│   │  ...其他地区...                                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   说明：中国开发者账号可以选择任意地区上架                     │
└─────────────────────────────────────────────────────────────┘
```

### 方案对比

| 方案 | 合规要求 | 网络访问 | 适用场景 |
|------|----------|----------|----------|
| **仅海外上架** | 无需 ICP 备案 | 直接访问海外 API | 初期推荐 |
| 含中国上架 | 需 ICP 备案 | 需国内服务器 | 有中国用户需求时 |
| 全球上架 | 需双重部署 | 需智能路由 | 成熟阶段 |

### 操作步骤

```
App Store Connect
      │
      ▼
┌─────────────────┐
│ 选择 App        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 价格与销售范围   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ App 可用性      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 取消勾选"中国"  │
└─────────────────┘
```

---

## 策略二：开发调试方案

### 方案 A：本地后端开发（推荐日常开发）

```
┌─────────────────────────────────────────────────────────────┐
│                      本地开发环境                            │
│                                                              │
│   ┌───────────────┐         ┌───────────────┐              │
│   │   iOS App     │ ──────→ │  localhost    │              │
│   │   (模拟器)    │         │  :3000        │              │
│   └───────────────┘         └───────────────┘              │
│                                     │                       │
│                                     ▼                       │
│                             ┌───────────────┐              │
│                             │  本地数据库    │              │
│                             │  PostgreSQL   │              │
│                             └───────────────┘              │
│                                                              │
│   优点：无网络限制，开发速度快                                │
│   缺点：需要本地运行后端服务                                  │
└─────────────────────────────────────────────────────────────┘
```

### 方案 B：代理访问海外服务（集成测试）

```
┌─────────────────────────────────────────────────────────────┐
│                      代理访问模式                            │
│                                                              │
│   ┌───────────────┐    代理    ┌───────────────┐           │
│   │   iOS App     │ ─────────→ │  fly.dev     │            │
│   │   (真机/模拟器) │           │  API         │            │
│   └───────────────┘            └───────────────┘           │
│                                                              │
│   配置方式：                                                 │
│   - 系统级代理（macOS 网络设置）                             │
│   - 模拟器自动继承 Mac 代理设置                              │
│   - 真机需单独配置 Wi-Fi 代理                                │
│                                                              │
│   适用场景：需要测试与生产环境一致的数据                       │
└─────────────────────────────────────────────────────────────┘
```

### 环境切换矩阵

| 开发场景 | 推荐环境 | 网络要求 |
|----------|----------|----------|
| 功能开发 | Local | 无 |
| UI 调试 | Local | 无 |
| API 集成测试 | Debugging | 代理 |
| 预发布测试 | Staging | 代理 |
| 线上问题排查 | Production | 代理 |

---

## 策略三：未来扩展 - 智能路由架构

当需要进入中国市场时，采用智能路由架构：

```
┌─────────────────────────────────────────────────────────────┐
│                      智能路由架构                            │
│                                                              │
│                      ┌─────────────┐                        │
│                      │   用户设备   │                        │
│                      └──────┬──────┘                        │
│                             │                               │
│                      ┌──────▼──────┐                        │
│                      │  App 启动   │                        │
│                      │  地区检测   │                        │
│                      └──────┬──────┘                        │
│                             │                               │
│              ┌──────────────┼──────────────┐                │
│              │              │              │                │
│              ▼              ▼              ▼                │
│       ┌────────────┐ ┌────────────┐ ┌────────────┐         │
│       │  中国大陆   │ │   港澳台    │ │   海外     │         │
│       └─────┬──────┘ └─────┬──────┘ └─────┬──────┘         │
│             │              │              │                 │
│             ▼              ▼              ▼                 │
│       ┌────────────┐ ┌────────────┐ ┌────────────┐         │
│       │ 阿里云/腾讯 │ │  香港节点   │ │  fly.dev   │         │
│       │ (已备案)   │ │            │ │            │         │
│       └────────────┘ └────────────┘ └────────────┘         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 地区检测方式

| 方式 | 准确度 | 实现复杂度 | 说明 |
|------|--------|------------|------|
| SIM 卡运营商 | 高 | 低 | 需用户授权 |
| 系统地区设置 | 中 | 低 | 用户可修改 |
| IP 地理位置 | 高 | 中 | 需首次网络请求 |
| App Store 地区 | 高 | 低 | 基于下载来源 |

---

## 合规要求对照表

| 要求 | 仅海外上架 | 含中国上架 |
|------|------------|------------|
| ICP 备案 | 不需要 | 需要 |
| 国内服务器 | 不需要 | 需要 |
| 网络安全等级保护 | 不需要 | 可能需要 |
| 数据本地化 | 不需要 | 可能需要 |
| App Store 审核 | 常规 | 额外审核 |

---

## 实施路线图

```
┌─────────────────────────────────────────────────────────────┐
│                        阶段规划                              │
│                                                              │
│  阶段一（当前）                                              │
│  ────────────────────────────────────────────────────       │
│  • App Store 仅上架海外地区                                  │
│  • 开发使用 Local 环境                                       │
│  • 测试时使用代理访问 Debugging/Staging                      │
│  • TestFlight 测试需代理环境                                 │
│                                                              │
│                         │                                    │
│                         ▼                                    │
│                                                              │
│  阶段二（有用户基础后）                                       │
│  ────────────────────────────────────────────────────       │
│  • 评估中国市场需求                                          │
│  • 如需进入中国：启动 ICP 备案                               │
│  • 部署国内边缘节点                                          │
│  • 实现智能路由                                              │
│                                                              │
│                         │                                    │
│                         ▼                                    │
│                                                              │
│  阶段三（全球覆盖）                                          │
│  ────────────────────────────────────────────────────       │
│  • 全球 CDN 加速                                             │
│  • 多区域数据同步                                            │
│  • 完整的数据合规方案                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键决策点

### 何时考虑进入中国市场？

| 指标 | 阈值 | 说明 |
|------|------|------|
| 中国 IP 访问占比 | > 10% | 通过 Analytics 监控 |
| 用户反馈需求 | 持续收到 | 用户主动询问中国区上架 |
| 商业价值 | 明确 ROI | 备案成本 vs 预期收入 |

### 风险评估

| 风险 | 仅海外上架 | 含中国上架 |
|------|------------|------------|
| 合规风险 | 低 | 中-高 |
| 运维复杂度 | 低 | 高 |
| 成本 | 低 | 高 |
| 用户覆盖 | 海外用户 | 全球用户 |

---

## 附录：中国区上架完整流程

当决定进入中国市场时，需完成以下步骤：

### 第一步：企业资质准备

```
┌─────────────────────────────────────────────────────────────┐
│                      资质准备清单                            │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  必需材料                                            │   │
│   │                                                      │   │
│   │  [  ] 企业营业执照（已年检）                          │   │
│   │  [  ] 法人身份证正反面                               │   │
│   │  [  ] 网站负责人身份证正反面                         │   │
│   │  [  ] 网站负责人手机号（已实名）                      │   │
│   │  [  ] 域名证书（域名需在国内注册商处）               │   │
│   │  [  ] 备案专用幕布照片（部分地区需要）               │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   注意事项：                                                 │
│   • 域名持有者需与备案主体一致                              │
│   • 建议使用 .com / .cn / .net 等常见后缀                  │
│   • 提前 3-4 周准备，预留审核时间                          │
└─────────────────────────────────────────────────────────────┘
```

### 第二步：ICP 备案流程

```
┌─────────────────────────────────────────────────────────────┐
│                       ICP 备案流程                           │
│                                                              │
│   ┌──────────────┐                                          │
│   │ 选择云服务商  │ ← 阿里云 / 腾讯云 / 华为云              │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 购买国内服务器│ ← 备案需要有服务器                       │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 登录备案系统  │ ← 云服务商提供                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 填写主体信息  │ ← 企业/法人信息                         │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 填写网站信息  │ ← 域名/网站名称/用途                    │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 上传材料     │ ← 身份证/营业执照/承诺书                 │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 云服务商初审  │ ← 1-2 个工作日                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 管局终审     │ ← 5-20 个工作日（各省不同）              │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 获取备案号   │ ← 如：沪ICP备XXXXXXXX号                  │
│   └──────────────┘                                          │
│                                                              │
│   总计周期：2-4 周                                          │
└─────────────────────────────────────────────────────────────┘
```

### 第三步：国内服务器部署

```
┌─────────────────────────────────────────────────────────────┐
│                    国内服务器选型                            │
│                                                              │
│   推荐方案对比：                                             │
│                                                              │
│   ┌──────────────┬──────────────┬──────────────┐           │
│   │    阿里云     │    腾讯云     │    华为云    │           │
│   ├──────────────┼──────────────┼──────────────┤           │
│   │ 备案速度快    │ 价格较优惠    │ 政企资源丰富  │           │
│   │ 文档完善      │ 与微信生态通  │ 安全性高     │           │
│   │ 生态成熟      │ CDN 性能好   │ 国产化要求   │           │
│   └──────────────┴──────────────┴──────────────┘           │
│                                                              │
│   推荐配置：                                                 │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  初期（< 1万 DAU）                                   │   │
│   │  • 2核 4G 云服务器 × 1                               │   │
│   │  • RDS MySQL 基础版                                  │   │
│   │  • Redis 1G                                          │   │
│   │  • OSS 对象存储                                      │   │
│   │  • CDN 按量付费                                      │   │
│   │  预算：约 ¥500-800/月                                │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 第四步：App 端智能路由实现

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端路由逻辑                            │
│                                                              │
│   App 启动                                                   │
│       │                                                      │
│       ▼                                                      │
│   ┌─────────────────────┐                                   │
│   │  检测 SIM 卡运营商   │                                   │
│   └──────────┬──────────┘                                   │
│              │                                               │
│       ┌──────┴──────┐                                       │
│       │              │                                       │
│       ▼              ▼                                       │
│   中国运营商      非中国运营商                                │
│   (46000/46001    (其他MCC)                                  │
│    46002/46003)                                              │
│       │              │                                       │
│       ▼              ▼                                       │
│   ┌────────────┐  ┌────────────┐                            │
│   │ 国内 API    │  │ 海外 API   │                            │
│   │ cn-api...  │  │ api...    │                            │
│   └────────────┘  └────────────┘                            │
│                                                              │
│   备用检测（无 SIM 卡时）：                                   │
│   • 检测系统语言 + 地区设置                                  │
│   • 首次启动 IP 地理位置检测                                 │
│   • 用户手动选择服务器区域                                   │
└─────────────────────────────────────────────────────────────┘
```

### 第五步：数据同步策略

```
┌─────────────────────────────────────────────────────────────┐
│                    数据同步架构                              │
│                                                              │
│                    ┌────────────────┐                       │
│                    │  主数据库       │                       │
│                    │  (海外 fly.dev) │                       │
│                    └────────┬───────┘                       │
│                             │                                │
│                    ┌────────▼───────┐                       │
│                    │  数据同步服务   │                       │
│                    │  (定时/实时)   │                       │
│                    └────────┬───────┘                       │
│                             │                                │
│              ┌──────────────┼──────────────┐                │
│              │              │              │                │
│              ▼              ▼              ▼                │
│       ┌────────────┐ ┌────────────┐ ┌────────────┐         │
│       │  国内副本   │ │  书籍内容   │ │  用户数据   │         │
│       │  (只读)    │ │  (CDN缓存) │ │  (按用户)  │         │
│       └────────────┘ └────────────┘ └────────────┘         │
│                                                              │
│   同步策略：                                                 │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  数据类型      │  同步方式     │  同步频率           │   │
│   ├─────────────────────────────────────────────────────┤   │
│   │  书籍元数据    │  全量同步     │  每日 1 次          │   │
│   │  书籍内容      │  CDN 预热     │  新书上架时         │   │
│   │  用户阅读进度  │  双向实时     │  实时              │   │
│   │  用户词汇表    │  双向实时     │  实时              │   │
│   │  AI 对话记录   │  单向（到主库）│  实时              │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 第六步：App Store 中国区上架

```
┌─────────────────────────────────────────────────────────────┐
│                 App Store 中国区上架流程                     │
│                                                              │
│   ┌──────────────┐                                          │
│   │ 准备材料      │                                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  • ICP 备案号（必须）                                 │   │
│   │  • 软件著作权登记证书（部分类别需要）                 │   │
│   │  • 网络文化经营许可证（如有UGC内容）                 │   │
│   │  • 出版物经营许可证（如有电子书销售）                │   │
│   └─────────────────────────────────────────────────────┘   │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 更新 App 信息 │                                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  • 在 App Store Connect 添加备案号                   │   │
│   │  • 更新隐私政策（需符合《个保法》）                   │   │
│   │  • 添加中文截图和描述                                │   │
│   │  • 设置中国区定价                                    │   │
│   └─────────────────────────────────────────────────────┘   │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 勾选中国区    │                                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 提交审核      │ ← 中国区审核通常需要额外时间            │
│   └──────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│   ┌──────────────┐                                          │
│   │ 审核通过      │ ← 预计 3-7 个工作日                     │
│   └──────────────┘                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 合规检查清单

```
┌─────────────────────────────────────────────────────────────┐
│                     中国区合规检查清单                       │
│                                                              │
│   法规合规                                                   │
│   [  ] ICP 备案完成并在网站底部展示                          │
│   [  ] 隐私政策符合《个人信息保护法》                        │
│   [  ] 用户协议符合《网络安全法》                            │
│   [  ] 实名认证（如涉及支付/发布内容）                       │
│   [  ] 内容审核机制（如有 UGC）                              │
│                                                              │
│   技术合规                                                   │
│   [  ] 用户数据存储在中国境内服务器                          │
│   [  ] 跨境数据传输已评估或申报                              │
│   [  ] SDK 合规（第三方 SDK 需备案）                         │
│   [  ] 日志保存 6 个月以上                                   │
│                                                              │
│   运营合规                                                   │
│   [  ] 内容不涉及敏感话题                                    │
│   [  ] 地图使用符合规定                                      │
│   [  ] 支付接入正规渠道                                      │
│   [  ] 客服渠道畅通                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 预算估算

| 项目 | 一次性费用 | 月度费用 | 备注 |
|------|------------|----------|------|
| ICP 备案 | ¥0 | - | 免费，需时间成本 |
| 云服务器 | - | ¥300-800 | 按配置浮动 |
| 数据库 | - | ¥200-500 | RDS MySQL |
| 对象存储 | - | ¥50-200 | 按用量 |
| CDN | - | ¥100-500 | 按流量 |
| 域名 | ¥50-100/年 | - | .cn 域名 |
| 软著登记 | ¥300-500 | - | 可选 |
| **总计** | **¥350-600** | **¥650-2000** | 初期预算 |

---

## 相关文档

- [环境配置](./environment-setup/debug-staging-setup-plan.md)
- [数据本地化设计](../../04-development/backend/localization/data-localization-design.md)
- [网络服务架构](../infrastructure/network-services.md)

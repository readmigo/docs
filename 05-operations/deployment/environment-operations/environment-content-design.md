# Environment & Content System Design

## 1. æ ¸å¿ƒæ¦‚å¿µå®šä¹‰

### 1.1 Environment (ç¯å¢ƒ)

**å®šä¹‰**: åº”ç”¨è¿è¡Œçš„åŸºç¡€è®¾æ–½ç¯å¢ƒï¼Œå†³å®šè¿æ¥å“ªä¸ªåç«¯æœåŠ¡å’Œæ•°æ®åº“ã€‚

| Environment | ç”¨é€” | æ•°æ®åº“ | R2 Bucket | API Base URL |
|-------------|------|--------|-----------|--------------|
| `local` | æœ¬åœ°å¼€å‘ | `readmigo_local` | `readmigo-local` | `http://localhost:3000` |
| `debug` | å®Œæ•´æµ‹è¯•æ•°æ® | `readmigo_debug` | `readmigo-debug` | `http://localhost:3000` |
| `staging` | æµ‹è¯•éªŒè¯ | `readmigo_staging` | `readmigo-staging` | `https://staging-api.readmigo.app` |
| `production` | ç”Ÿäº§ç¯å¢ƒ | `readmigo_production` | `readmigo-production` | `https://api.readmigo.app` |

**ç‰¹ç‚¹**:
- ç¯å¢ƒä¹‹é—´**æ•°æ®å®Œå…¨éš”ç¦»**ï¼ˆæ•°æ®åº“ + R2 å­˜å‚¨ï¼‰
- æ¯ä¸ªç¯å¢ƒæœ‰ç‹¬ç«‹çš„ Feature Flags é…ç½®
- åˆ‡æ¢ç¯å¢ƒ = åˆ‡æ¢ API ç«¯ç‚¹ = åˆ‡æ¢æ•°æ®æºï¼ˆDB + R2ï¼‰
- R2 Bucket æŒ‰ç¯å¢ƒéš”ç¦»ï¼Œé¿å…æµ‹è¯•æ•°æ®æ±¡æŸ“ç”Ÿäº§ç¯å¢ƒ

### 1.2 Content Language (å†…å®¹è¯­è¨€)

**å®šä¹‰**: æ˜¾ç¤ºå†…å®¹çš„è¯­è¨€èŒƒå›´ï¼Œç”± Feature Flag æ§åˆ¶ã€‚

| Content Mode | æ˜¾ç¤ºå†…å®¹ | ä½¿ç”¨åœºæ™¯ |
|--------------|----------|----------|
| `en` | ä»…è‹±æ–‡å†…å®¹ | å›½é™…ç‰ˆã€æœªå¼€æ”¾ä¸­æ–‡å¸‚åœº |
| `zh` | ä»…ä¸­æ–‡å†…å®¹ | ä¸­æ–‡ä¸“åŒº |
| `all` | æ‰€æœ‰è¯­è¨€å†…å®¹ | Dashboard ç®¡ç†ã€å¼€å‘æµ‹è¯• |

**ç‰¹ç‚¹**:
- ç”± `chinese_content` Feature Flag æ§åˆ¶
- å¯ä»¥æŒ‰ç”¨æˆ·/å…¨å±€å¯ç”¨
- Dashboard ç®¡ç†å‘˜é»˜è®¤å¯è§æ‰€æœ‰å†…å®¹

---

## 2. Environment ä¸ Content çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ENVIRONMENT                                             â”‚
â”‚                         (Infrastructure Layer)                                       â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     LOCAL       â”‚  â”‚     DEBUG       â”‚  â”‚    STAGING      â”‚  â”‚  PRODUCTION  â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ DB: local       â”‚  â”‚ DB: debug       â”‚  â”‚ DB: staging     â”‚  â”‚ DB: prod     â”‚  â”‚
â”‚  â”‚ R2: local       â”‚  â”‚ R2: debug       â”‚  â”‚ R2: staging     â”‚  â”‚ R2: prod     â”‚  â”‚
â”‚  â”‚ Redis: 0        â”‚  â”‚ Redis: 1        â”‚  â”‚ Redis: 2        â”‚  â”‚ Redis: 3     â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚  Features   â”‚ â”‚  â”‚ â”‚  Features   â”‚ â”‚  â”‚ â”‚  Features   â”‚ â”‚  â”‚ â”‚ Features â”‚ â”‚  â”‚
â”‚  â”‚ â”‚             â”‚ â”‚  â”‚ â”‚             â”‚ â”‚  â”‚ â”‚             â”‚ â”‚  â”‚ â”‚          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ chinese_    â”‚ â”‚  â”‚ â”‚ chinese_    â”‚ â”‚  â”‚ â”‚ chinese_    â”‚ â”‚  â”‚ â”‚ chinese_ â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ content:    â”‚ â”‚  â”‚ â”‚ content:    â”‚ â”‚  â”‚ â”‚ content:    â”‚ â”‚  â”‚ â”‚ content: â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   TRUE      â”‚ â”‚  â”‚ â”‚   TRUE      â”‚ â”‚  â”‚ â”‚   TRUE      â”‚ â”‚  â”‚ â”‚  FALSE   â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ Data: 10æœ¬ä¹¦    â”‚  â”‚ Data: 100æœ¬ä¹¦   â”‚  â”‚ Data: ç”Ÿäº§å¿«ç…§  â”‚  â”‚ Data: çœŸå®   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                     â”‚                    â”‚                   â”‚          â”‚
â”‚          â–¼                     â–¼                    â–¼                   â–¼          â”‚
â”‚   Content: en,zh        Content: en,zh       Content: en,zh      Content: en only â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

R2 Bucket éš”ç¦»ç­–ç•¥ï¼š
â”œâ”€ readmigo-local:      æœ€å°æµ‹è¯•é›† (~10 æœ¬ä¹¦, ~50MB)
â”œâ”€ readmigo-debug:      å®Œæ•´ Top 100 æµ‹è¯•æ•°æ® (~100 æœ¬ä¹¦, ~550MB) â† é‡ç‚¹
â”œâ”€ readmigo-staging:    ç”Ÿäº§æ•°æ®å¿«ç…§ï¼Œç”¨äºé¢„å‘å¸ƒæµ‹è¯•
â””â”€ readmigo-production: çœŸå®ç”¨æˆ·æ•°æ®ï¼Œä»…æ–°å¢ä¸åˆ é™¤
```

### 2.1 åˆ¶çº¦å…³ç³»

```
Environment â”€â”€å†³å®šâ”€â”€> å¯ç”¨çš„ Feature Flags é…ç½®
     â”‚
     â””â”€â”€> Feature Flag (chinese_content) â”€â”€å†³å®šâ”€â”€> Content å¯è§æ€§
```

**è§„åˆ™**:
1. **Environment ä¼˜å…ˆ**: å¿…é¡»å…ˆç¡®å®šç¯å¢ƒï¼Œæ‰èƒ½è·å–è¯¥ç¯å¢ƒçš„ Feature Flags
2. **Content å—é™äº Environment**: æ¯ä¸ªç¯å¢ƒçš„ Content ç­–ç•¥ç‹¬ç«‹é…ç½®
3. **ä¸å¯è·¨ç¯å¢ƒ**: ä¸èƒ½åœ¨ Production ç¯å¢ƒä½¿ç”¨ Local çš„ Feature Flag é…ç½®

### 2.2 å…¸å‹é…ç½®ç­–ç•¥

| Environment | chinese_content | æ•ˆæœ |
|-------------|-----------------|------|
| Local | `enabled: true` | å¼€å‘æ—¶å¯æµ‹è¯•æ‰€æœ‰è¯­è¨€å†…å®¹ |
| Staging | `enabled: true` | QA æµ‹è¯•ä¸­æ–‡åŠŸèƒ½ |
| Production | `enabled: false` | æš‚ä¸å¼€æ”¾ä¸­æ–‡å†…å®¹ç»™ç”¨æˆ· |

---

## 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 Dashboard æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DASHBOARD                                 â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      App Bar                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚
â”‚  â”‚  â”‚ Environment     â”‚  â”‚ Content Filter  â”‚                  â”‚ â”‚
â”‚  â”‚  â”‚ Selector        â”‚  â”‚ (å¯é€‰)          â”‚                  â”‚ â”‚
â”‚  â”‚  â”‚ [Production â–¼]  â”‚  â”‚ [All â–¼]         â”‚                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   API Client                                â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  baseURL = getApiUrl(selectedEnvironment)                  â”‚ â”‚
â”‚  â”‚  headers = { 'X-Content-Filter': contentFilter }           â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â–¼                    â–¼                    â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Local API   â”‚     â”‚ Staging API â”‚     â”‚ Prod API    â”‚       â”‚
â”‚  â”‚ :3000       â”‚     â”‚ staging.xxx â”‚     â”‚ api.xxx     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Context è®¾è®¡

```typescript
// EnvironmentContext - æ§åˆ¶è¿æ¥å“ªä¸ªåç«¯
interface EnvironmentContextType {
  environment: Environment;           // å½“å‰é€‰æ‹©çš„ç¯å¢ƒ
  setEnvironment: (env) => void;      // åˆ‡æ¢ç¯å¢ƒ
  apiBaseUrl: string;                 // å½“å‰ç¯å¢ƒçš„ API URL
  isConnected: boolean;               // è¿æ¥çŠ¶æ€
}

// ContentContext - æ§åˆ¶æ˜¾ç¤ºä»€ä¹ˆå†…å®¹ (Dashboard ä¸“ç”¨)
interface ContentContextType {
  contentFilter: ContentFilter;       // 'all' | 'en' | 'zh'
  setContentFilter: (filter) => void;
  availableLanguages: string[];       // å½“å‰ç¯å¢ƒå…è®¸çš„è¯­è¨€
}
```

### 3.3 æ•°æ®æµ

```
User selects Environment
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EnvironmentContext updates  â”‚
â”‚ - Save to localStorage      â”‚
â”‚ - Update apiBaseUrl         â”‚
â”‚ - Trigger API client reset  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fetch /config/client        â”‚
â”‚ - Get feature flags         â”‚
â”‚ - Get allowed languages     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ContentContext updates      â”‚
â”‚ - Set availableLanguages    â”‚
â”‚ - Reset contentFilter       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ All pages re-fetch data     â”‚
â”‚ - With new API base URL     â”‚
â”‚ - With content filter param â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 R2 å­˜å‚¨ç¯å¢ƒéš”ç¦»æ¶æ„

#### å½“å‰çŠ¶æ€ï¼ˆéœ€è¦é‡æ„ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Cloudflare R2                          â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚         readmigo (å…±äº« bucket)                 â”‚     â”‚
â”‚  â”‚                                                 â”‚     â”‚
â”‚  â”‚  âŒ é—®é¢˜ï¼šæ‰€æœ‰ç¯å¢ƒæ··ç”¨                           â”‚     â”‚
â”‚  â”‚  - local æµ‹è¯•æ•°æ®                               â”‚     â”‚
â”‚  â”‚  - debug æµ‹è¯•æ•°æ®                               â”‚     â”‚
â”‚  â”‚  - staging æµ‹è¯•æ•°æ®                             â”‚     â”‚
â”‚  â”‚  - production çœŸå®æ•°æ®ï¼ˆé£é™©ï¼ï¼‰                â”‚     â”‚
â”‚  â”‚                                                 â”‚     â”‚
â”‚  â”‚  æ–‡ä»¶ç»“æ„æ··ä¹±ï¼š                                  â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€ books/                                     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€ covers/                                    â”‚     â”‚
â”‚  â”‚  â””â”€â”€ authors/                                   â”‚     â”‚
â”‚  â”‚     â””â”€ æ— æ³•åŒºåˆ†å“ªäº›æ–‡ä»¶å±äºå“ªä¸ªç¯å¢ƒ               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é£é™©ï¼š
1. è¯¯åˆ æµ‹è¯•æ•°æ®æ—¶å¯èƒ½åˆ é™¤ç”Ÿäº§æ•°æ®
2. æµ‹è¯•æ—¶ä¸Šä¼ æ–‡ä»¶å¯èƒ½è¦†ç›–ç”Ÿäº§æ–‡ä»¶
3. æ— æ³•ç‹¬ç«‹æ¸…ç©ºæŸä¸ªç¯å¢ƒçš„æ•°æ®
4. éš¾ä»¥è¿½è¸ªå­˜å‚¨æˆæœ¬å’Œä½¿ç”¨é‡
```

#### ç›®æ ‡æ¶æ„ï¼ˆå®Œå…¨éš”ç¦»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Cloudflare R2                                    â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ readmigo-local     â”‚  â”‚ readmigo-debug     â”‚  â”‚ readmigo-staging â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ Size: ~50MB        â”‚  â”‚ Size: ~550MB       â”‚  â”‚ Size: ~5GB       â”‚  â”‚
â”‚  â”‚ Files: ~20         â”‚  â”‚ Files: ~200        â”‚  â”‚ Files: ~1000     â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ books/             â”‚  â”‚ books/             â”‚  â”‚ books/           â”‚  â”‚
â”‚  â”‚   pg1342.epub      â”‚  â”‚   pg1342.epub      â”‚  â”‚   pg1342.epub    â”‚  â”‚
â”‚  â”‚   pg11.epub        â”‚  â”‚   pg11.epub        â”‚  â”‚   ...            â”‚  â”‚
â”‚  â”‚   ... (10 æœ¬)      â”‚  â”‚   ... (100 æœ¬)     â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ covers/            â”‚  â”‚ covers/            â”‚  â”‚ covers/          â”‚  â”‚
â”‚  â”‚   pg1342.jpg       â”‚  â”‚   pg1342.jpg       â”‚  â”‚   pg1342.jpg     â”‚  â”‚
â”‚  â”‚   ... (10 å¼ )      â”‚  â”‚   ... (100 å¼ )     â”‚  â”‚   ...            â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ authors/           â”‚  â”‚ authors/           â”‚  â”‚ authors/         â”‚  â”‚
â”‚  â”‚   jane-austen.jpg  â”‚  â”‚   jane-austen.jpg  â”‚  â”‚   ...            â”‚  â”‚
â”‚  â”‚   ... (10 äºº)      â”‚  â”‚   ... (100 äºº)     â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ readmigo-productionâ”‚  â”‚ readmigo (æ—§ bucket - å¾…è¿ç§»/åˆ é™¤)       â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚ Size: TBD          â”‚  â”‚ âš ï¸  ä¿ç•™ 7 å¤©ä½œä¸ºå¤‡ä»½                      â”‚  â”‚
â”‚  â”‚ Files: TBD         â”‚  â”‚ ğŸ“… 2026-01-01 åˆ é™¤                         â”‚  â”‚
â”‚  â”‚                    â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚ books/             â”‚  â”‚ åŒ…å« >100 ä¸ªæ–‡ä»¶                           â”‚  â”‚
â”‚  â”‚ covers/            â”‚  â”‚ éœ€è¦åˆ†æå¹¶é€‰æ‹©æ€§è¿ç§»åˆ° debug/staging       â”‚  â”‚
â”‚  â”‚ authors/           â”‚  â”‚                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… å®Œå…¨éš”ç¦»ï¼Œæ— äº¤å‰æ±¡æŸ“é£é™©
âœ… å¯ç‹¬ç«‹æ¸…ç©º debug ç¯å¢ƒ
âœ… ç²¾ç¡®çš„æˆæœ¬è¿½è¸ª
âœ… æ”¯æŒç‹¬ç«‹å¤‡ä»½ç­–ç•¥
```

#### ç¯å¢ƒé…ç½®æ˜ å°„

| Environment | Database | R2 Bucket | Public URL | ç”¨é€” |
|-------------|----------|-----------|------------|------|
| **local** | `readmigo_local` | `readmigo-local` | `https://pub-xxx-local.r2.dev` | æœ€å°åŒ–å¼€å‘æ•°æ® |
| **debug** | `readmigo_debug` | `readmigo-debug` | `https://pub-xxx-debug.r2.dev` | **å®Œæ•´ Top 100 æµ‹è¯•æ•°æ®** |
| **staging** | `readmigo_staging` | `readmigo-staging` | `https://pub-xxx-staging.r2.dev` | é¢„å‘å¸ƒç¯å¢ƒ |
| **production** | `readmigo_production` | `readmigo-production` | `https://pub-xxx.r2.dev` | ç”Ÿäº§ç¯å¢ƒ |

#### åç«¯é…ç½®æ–‡ä»¶ç»“æ„

```bash
apps/backend/
â”œâ”€â”€ .env                      # å½“å‰ä½¿ç”¨ï¼ˆæŒ‡å‘ localï¼‰
â”œâ”€â”€ .env.local                # æœ¬åœ°å¼€å‘é…ç½®
â”œâ”€â”€ .env.debug                # Debug ç¯å¢ƒé…ç½® â† æ–°å¢
â”œâ”€â”€ .env.staging              # Staging ç¯å¢ƒé…ç½®
â”œâ”€â”€ .env.production           # Production ç¯å¢ƒé…ç½®
â””â”€â”€ .env.example              # æ¨¡æ¿æ–‡ä»¶
```

**`.env.debug` ç¤ºä¾‹**:

```env
# Environment
NODE_ENV=development
PORT=3000

# Database
DATABASE_URL=postgresql://HONGBGU@localhost:5432/readmigo_debug?schema=public

# Redis (ä½¿ç”¨ä¸åŒçš„ DB)
REDIS_URL=redis://localhost:6379/1

# Cloudflare R2 - Debug Environment
R2_ACCOUNT_ID=cbda5dcfa2fa6852a5d58673de8cd1e8
R2_ACCESS_KEY_ID=<debug-specific-key>
R2_SECRET_ACCESS_KEY=<debug-specific-secret>
R2_BUCKET_NAME=readmigo-debug  â† å…³é”®é…ç½®
R2_ENDPOINT=https://cbda5dcfa2fa6852a5d58673de8cd1e8.r2.cloudflarestorage.com
R2_PUBLIC_URL=https://pub-debug-xxx.r2.dev

# AI Services
DEEPSEEK_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx

# Feature Flags (Debug é»˜è®¤å…¨å¼€)
ENABLE_CHINESE_CONTENT=true
ENABLE_AI_FEATURES=true
```

#### æ•°æ®è¿ç§»ç­–ç•¥

**ä»æ—§ `readmigo` bucket è¿ç§»åˆ°æ–°ç¯å¢ƒ**:

```bash
# æ­¥éª¤ 1: åˆ†æç°æœ‰æ•°æ®
wrangler r2 object list readmigo > r2-inventory.txt
# è¾“å‡º: >100 ä¸ªæ–‡ä»¶åˆ—è¡¨

# æ­¥éª¤ 2: æŒ‰æ–‡ä»¶ä»·å€¼åˆ†ç±»
# - æœ‰ä»·å€¼çš„å°é¢å›¾ â†’ è¿ç§»åˆ° debug
# - æµ‹è¯• EPUB æ–‡ä»¶ â†’ ä¸è¿ç§»ï¼ˆé‡æ–°ä» Gutenberg ä¸‹è½½ï¼‰
# - ä½œè€…å¤´åƒ â†’ è¿ç§»åˆ° debug

# æ­¥éª¤ 3: é€‰æ‹©æ€§è¿ç§»ï¼ˆä½¿ç”¨è„šæœ¬ï¼‰
node scripts/migrate-r2-data.ts \
  --from=readmigo \
  --to=readmigo-debug \
  --filter=covers/*.jpg,authors/*.jpg

# æ­¥éª¤ 4: éªŒè¯è¿ç§»ç»“æœ
wrangler r2 object list readmigo-debug

# æ­¥éª¤ 5: ä¿ç•™æ—§ bucket 7 å¤©
# åœ¨ Cloudflare Dashboard æ·»åŠ æé†’ï¼š2026-01-01 åˆ é™¤ readmigo bucket

# æ­¥éª¤ 6: ä½¿ç”¨æ–° bucket
# æ›´æ–° .env.debug ä¸­çš„ R2_BUCKET_NAME=readmigo-debug
```

#### R2 ä½¿ç”¨æˆæœ¬ä¼°ç®—

**Cloudflare R2 å®šä»·**ï¼ˆ2024ï¼‰:
- å­˜å‚¨: $0.015/GB/æœˆï¼ˆå‰ 10GB å…è´¹ï¼‰
- Class A æ“ä½œï¼ˆå†™å…¥ï¼‰: $4.50/ç™¾ä¸‡æ¬¡ï¼ˆå‰ 100 ä¸‡æ¬¡å…è´¹ï¼‰
- Class B æ“ä½œï¼ˆè¯»å–ï¼‰: $0.36/ç™¾ä¸‡æ¬¡ï¼ˆå‰ 1000 ä¸‡æ¬¡å…è´¹ï¼‰
- å‡ºç«™æµé‡: å®Œå…¨å…è´¹ âœ…

**4 ä¸ªç¯å¢ƒæˆæœ¬ä¼°ç®—**:

| Bucket | å¤§å° | æœˆæˆæœ¬ | å¹´æˆæœ¬ | è¯´æ˜ |
|--------|------|--------|--------|------|
| `readmigo-local` | 50MB | $0 | $0 | åœ¨å…è´¹é¢åº¦å†… |
| `readmigo-debug` | 550MB | $0.01 | $0.12 | æµ‹è¯•æ•°æ® |
| `readmigo-staging` | 5GB | $0.08 | $0.96 | ç”Ÿäº§å¿«ç…§ |
| `readmigo-production` | 50GB | $0.75 | $9.00 | çœŸå®ç”¨æˆ·æ•°æ® |
| **æ€»è®¡** | 55.6GB | **$0.84** | **$10.08** | æä½æˆæœ¬ |

**ç»“è®º**: R2 å­˜å‚¨æˆæœ¬æä½ï¼Œç¯å¢ƒéš”ç¦»å‡ ä¹ä¸å¢åŠ æˆæœ¬ï¼Œå¼ºçƒˆå»ºè®®å®æ–½ã€‚

---

## 4. Dashboard é¡µé¢è¡Œä¸ºè§„èŒƒ

### 4.1 é¡µé¢åˆ†ç±»

| ç±»å‹ | é¡µé¢ | Environment æ•æ„Ÿ | Content æ•æ„Ÿ |
|------|------|------------------|--------------|
| é…ç½®ç®¡ç† | Feature Flags | âœ… æ˜¾ç¤ºæ‰€é€‰ç¯å¢ƒçš„é…ç½® | âŒ |
| å†…å®¹ç®¡ç† | Books, Categories, Authors, Quotes, BookLists | âœ… æ“ä½œæ‰€é€‰ç¯å¢ƒçš„æ•°æ® | âœ… å¯æŒ‰è¯­è¨€è¿‡æ»¤ |
| ç”¨æˆ·ç®¡ç† | Users | âœ… æ“ä½œæ‰€é€‰ç¯å¢ƒçš„æ•°æ® | âŒ |
| è¿è¥æ•°æ® | Dashboard, AI Stats | âœ… æ˜¾ç¤ºæ‰€é€‰ç¯å¢ƒçš„ç»Ÿè®¡ | âŒ |
| èµ„æºç®¡ç† | Postcards, Templates | âœ… æ“ä½œæ‰€é€‰ç¯å¢ƒçš„æ•°æ® | âŒ |

### 4.2 å†…å®¹ç®¡ç†é¡µé¢è¡Œä¸º

**Categories é¡µé¢ç¤ºä¾‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Categories                                    [All â–¼] å†…å®¹è¿‡æ»¤  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  å½“ Content Filter = "All":                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ID    â”‚ Name (ä¸­æ–‡) â”‚ Name (EN)    â”‚ Language â”‚ Active   â”‚  â”‚
â”‚  â”‚ cat1  â”‚ æ–‡å­¦        â”‚ Literature   â”‚ all      â”‚ âœ“        â”‚  â”‚
â”‚  â”‚ cat2  â”‚ å†å²        â”‚ History      â”‚ all      â”‚ âœ“        â”‚  â”‚
â”‚  â”‚ cat3  â”‚ å›½å­¦        â”‚ -            â”‚ zh       â”‚ âœ“        â”‚  â”‚
â”‚  â”‚ cat4  â”‚ -           â”‚ Science      â”‚ en       â”‚ âœ“        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  å½“ Content Filter = "en":                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ID    â”‚ Name (ä¸­æ–‡) â”‚ Name (EN)    â”‚ Language â”‚ Active   â”‚  â”‚
â”‚  â”‚ cat1  â”‚ æ–‡å­¦        â”‚ Literature   â”‚ all      â”‚ âœ“        â”‚  â”‚
â”‚  â”‚ cat2  â”‚ å†å²        â”‚ History      â”‚ all      â”‚ âœ“        â”‚  â”‚
â”‚  â”‚ cat4  â”‚ -           â”‚ Science      â”‚ en       â”‚ âœ“        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  (cat3 è¢«è¿‡æ»¤æ‰ï¼Œå› ä¸ºå®ƒæ˜¯ zh-only)                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Content Filter ä¸ Feature Flag çš„å…³ç³»

```
Dashboard Content Filter (UIé€‰æ‹©)     Feature Flag (åç«¯é…ç½®)
         â”‚                                    â”‚
         â”‚                                    â”‚
         â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»…ç”¨äº Dashboard â”‚                 â”‚ ç”¨äº Client App â”‚
â”‚ ç®¡ç†å‘˜é¢„è§ˆæ•ˆæœ   â”‚                 â”‚ æ§åˆ¶ç”¨æˆ·å¯è§æ€§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard ç®¡ç†å‘˜å§‹ç»ˆå¯ä»¥:
- çœ‹åˆ°æ‰€æœ‰è¯­è¨€çš„å†…å®¹ (ç”¨äºç®¡ç†)
- ä½¿ç”¨ Content Filter é¢„è§ˆç”¨æˆ·è§†è§’
- ç¼–è¾‘ä»»ä½•è¯­è¨€çš„å†…å®¹

Client App ç”¨æˆ·åªèƒ½:
- çœ‹åˆ° Feature Flag å…è®¸çš„è¯­è¨€å†…å®¹
- æ— æ³•åˆ‡æ¢ Content Filter
```

---

## 5. API è®¾è®¡

### 5.1 è¯·æ±‚å¤´è§„èŒƒ

```typescript
// Dashboard è¯·æ±‚
headers: {
  'Authorization': 'Bearer <token>',
  'X-Environment': 'production',           // æ˜ç¡®æŒ‡å®šç¯å¢ƒ (å¯é€‰ï¼Œç”¨äºè·¨ç¯å¢ƒç®¡ç†)
  'X-Content-Filter': 'all' | 'en' | 'zh', // Dashboard å†…å®¹è¿‡æ»¤ (å¯é€‰)
  'X-Admin-Mode': 'true',                  // ç®¡ç†å‘˜æ¨¡å¼ï¼Œç»•è¿‡ Feature Flag é™åˆ¶
}

// Client App è¯·æ±‚
headers: {
  'Authorization': 'Bearer <token>',
  // ä¸éœ€è¦ X-Environment (ç”±åç«¯éƒ¨ç½²ç¯å¢ƒå†³å®š)
  // ä¸éœ€è¦ X-Content-Filter (ç”± Feature Flag å†³å®š)
}
```

### 5.2 API ç«¯ç‚¹è¡Œä¸º

```typescript
// GET /categories
// Dashboard è°ƒç”¨ (æœ‰ X-Admin-Mode)
{
  items: [...æ‰€æœ‰åˆ†ç±»...],
  meta: {
    contentFilter: 'all',
    totalByLanguage: { en: 50, zh: 30, all: 20 }
  }
}

// Client App è°ƒç”¨ (æ—  X-Admin-Mode)
{
  items: [...æ ¹æ® Feature Flag è¿‡æ»¤åçš„åˆ†ç±»...],
  meta: {
    allowedLanguages: ['en']  // ç”± chinese_content flag å†³å®š
  }
}
```

### 5.3 Environment-Aware ç«¯ç‚¹

```typescript
// Dashboard ä¸“ç”¨ç«¯ç‚¹ - æ”¯æŒè·¨ç¯å¢ƒæ“ä½œ
GET  /admin/feature-flags?environment=staging
POST /admin/feature-flags/:key/copy?from=local&to=staging

// æ™®é€šç«¯ç‚¹ - ä½¿ç”¨å½“å‰éƒ¨ç½²ç¯å¢ƒ
GET  /categories
GET  /books
POST /categories
```

---

## 6. å®ç°æ¸…å•

### 6.1 Backend æ”¹åŠ¨

- [x] EnvironmentService æ”¯æŒ 4 ç§ç¯å¢ƒ (local/debug/staging/production)
- [x] EnvironmentService æä¾›ç¯å¢ƒéš”ç¦»é…ç½®æ˜ å°„ (R2 Bucket, Redis DB)
- [ ] æ·»åŠ  `X-Admin-Mode` è¯·æ±‚å¤´å¤„ç†
- [ ] æ·»åŠ  `X-Content-Filter` è¯·æ±‚å¤´å¤„ç†
- [ ] ä¿®æ”¹æ•°æ®æŸ¥è¯¢é€»è¾‘æ”¯æŒè¯­è¨€è¿‡æ»¤
- [x] Category æ¨¡å‹å·²æœ‰ `language` å­—æ®µ
- [x] Book æ¨¡å‹å·²æœ‰ `language` å­—æ®µ

### 6.2 R2 Bucket éš”ç¦»

- [x] StorageService ä»ç¯å¢ƒå˜é‡è¯»å– bucket åç§°
- [ ] åˆ›å»º 4 ä¸ªç‹¬ç«‹çš„ R2 Bucket (local/debug/staging/production)
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬ migrate-r2-data.ts
- [ ] æ›´æ–°å„ç¯å¢ƒçš„ .env æ–‡ä»¶é…ç½®

### 6.3 Dashboard æ”¹åŠ¨

- [ ] é‡æ„ `EnvironmentContext` æ”¯æŒåˆ‡æ¢ API ç«¯ç‚¹
- [ ] æ·»åŠ  `ContentContext` ç®¡ç†å†…å®¹è¿‡æ»¤
- [ ] æ·»åŠ  `ContentFilterSelector` ç»„ä»¶
- [ ] æ›´æ–°æ‰€æœ‰æ•°æ®é¡µé¢ä½¿ç”¨ Context
- [ ] API Client è‡ªåŠ¨é™„åŠ è¯·æ±‚å¤´

### 6.4 iOS Client æ”¹åŠ¨

- [ ] æ— éœ€æ”¹åŠ¨ (å·²ç”± Feature Flag æ§åˆ¶)

---

## 7. é…ç½®ç¤ºä¾‹

### 7.1 Feature Flag: chinese_content

```json
{
  "key": "chinese_content",
  "environment": "production",
  "isEnabled": false,
  "value": {
    "allowedLanguages": ["en"],
    "enabledForUserIds": ["admin-user-1"],
    "globalEnabled": false,
    "rolloutPercentage": 0
  },
  "description": "Controls Chinese content visibility for users"
}
```

### 7.2 Dashboard ç¯å¢ƒé…ç½®

```typescript
// apps/dashboard/src/config/environments.ts
export const environments = {
  local: {
    name: 'Local',
    apiUrl: 'http://localhost:3000',
    color: 'warning',
    description: 'æœ¬åœ°å¼€å‘ç¯å¢ƒ',
  },
  staging: {
    name: 'Staging',
    apiUrl: 'https://staging-api.readmigo.app',
    color: 'info',
    description: 'æµ‹è¯•ç¯å¢ƒ',
  },
  production: {
    name: 'Production',
    apiUrl: 'https://api.readmigo.app',
    color: 'success',
    description: 'ç”Ÿäº§ç¯å¢ƒ - è°¨æ…æ“ä½œ',
    requireConfirmation: true,
  },
};
```

---

## 8. ç”¨æˆ·åœºæ™¯

### åœºæ™¯ 1: ç®¡ç†å‘˜æ·»åŠ ä¸­æ–‡åˆ†ç±»

1. æ‰“å¼€ Dashboardï¼ŒEnvironment é€‰æ‹© `Staging`
2. è¿›å…¥ Categories é¡µé¢
3. Content Filter é€‰æ‹© `All` (æ˜¾ç¤ºæ‰€æœ‰è¯­è¨€)
4. ç‚¹å‡» Createï¼Œå¡«å†™ä¸­æ–‡åç§°ï¼ŒLanguage é€‰æ‹© `zh`
5. ä¿å­˜ååœ¨ Staging ç¯å¢ƒå¯è§
6. æµ‹è¯•å®Œæˆåï¼Œä½¿ç”¨æ•°æ®åŒæ­¥å·¥å…·å¤åˆ¶åˆ° Production

### åœºæ™¯ 2: æŸ¥çœ‹ç”¨æˆ·è§†è§’

1. Environment é€‰æ‹© `Production`
2. Content Filter é€‰æ‹© `en` (æ¨¡æ‹Ÿç”¨æˆ·)
3. ç¡®è®¤ä¸­æ–‡åˆ†ç±»è¢«æ­£ç¡®è¿‡æ»¤
4. åˆ‡æ¢ Content Filter åˆ° `All` ç»§ç»­ç®¡ç†

### åœºæ™¯ 3: ç°åº¦å‘å¸ƒä¸­æ–‡å†…å®¹

1. è¿›å…¥ Feature Flags é¡µé¢
2. Environment é€‰æ‹© `Production`
3. ç¼–è¾‘ `chinese_content` flag:
   ```json
   {
     "allowedLanguages": ["en", "zh"],
     "enabledForUserIds": ["beta-user-1", "beta-user-2"],
     "globalEnabled": false
   }
   ```
4. æŒ‡å®šç”¨æˆ·å¯ä»¥çœ‹åˆ°ä¸­æ–‡å†…å®¹
5. éªŒè¯åè®¾ç½® `globalEnabled: true` å…¨é‡å‘å¸ƒ

---

## 9. Client App (iOS) è¡Œä¸ºè§„èŒƒ

### 9.1 ç¯å¢ƒåˆ‡æ¢

```swift
// iOS ç¯å¢ƒé…ç½®
enum AppEnvironment {
    case local      // å¼€å‘è°ƒè¯•
    case staging    // æµ‹è¯•éªŒè¯
    case production // æ­£å¼å‘å¸ƒ

    var apiBaseURL: String {
        switch self {
        case .local: return "http://localhost:3000"
        case .staging: return "https://staging-api.readmigo.app"
        case .production: return "https://api.readmigo.app"
        }
    }
}
```

**è¡Œä¸ºè§„åˆ™**:
- Release ç‰ˆæœ¬: å›ºå®š `production`ï¼Œä¸å¯åˆ‡æ¢
- Debug ç‰ˆæœ¬: æ”¯æŒé€šè¿‡è®¾ç½®é¡µåˆ‡æ¢ç¯å¢ƒ
- åˆ‡æ¢ç¯å¢ƒåéœ€è¦é‡æ–°ç™»å½•ã€æ¸…é™¤æœ¬åœ°ç¼“å­˜

### 9.2 Content æ§åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     iOS Client å¯åŠ¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /config/client                                               â”‚
â”‚                                                                  â”‚
â”‚ Response:                                                        â”‚
â”‚ {                                                                â”‚
â”‚   "environment": "production",                                   â”‚
â”‚   "features": {                                                  â”‚
â”‚     "chineseContent": false,                                     â”‚
â”‚     "allowedLanguages": ["en"]                                  â”‚
â”‚   }                                                              â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AppConfigManager ç¼“å­˜é…ç½®                                        â”‚
â”‚                                                                  â”‚
â”‚ - å­˜å‚¨ allowedLanguages                                         â”‚
â”‚ - æ‰€æœ‰æ•°æ®è¯·æ±‚è‡ªåŠ¨è¿‡æ»¤                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /categories/cascade                                          â”‚
â”‚                                                                  â”‚
â”‚ åç«¯è‡ªåŠ¨æ ¹æ®:                                                     â”‚
â”‚ 1. å½“å‰éƒ¨ç½²ç¯å¢ƒçš„ chinese_content flag                           â”‚
â”‚ 2. ç”¨æˆ· ID (å¯é€‰çš„ç™½åå•)                                        â”‚
â”‚                                                                  â”‚
â”‚ è¿”å›è¿‡æ»¤åçš„åˆ†ç±»æ•°æ®                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 iOS ä¸åŒç¯å¢ƒè¡¨ç°

| ç¯å¢ƒ | chinese_content | ç”¨æˆ·çœ‹åˆ° |
|------|-----------------|----------|
| Local | `enabled: true` | æ‰€æœ‰ä¸­è‹±æ–‡åˆ†ç±»ã€ä¹¦ç± |
| Staging | `enabled: true` | æ‰€æœ‰ä¸­è‹±æ–‡åˆ†ç±»ã€ä¹¦ç± |
| Production | `enabled: false` | ä»…è‹±æ–‡åˆ†ç±»ã€ä¹¦ç± |
| Production (ç™½åå•ç”¨æˆ·) | ç‰¹æ®Šé…ç½® | å¯çœ‹åˆ°ä¸­æ–‡å†…å®¹ |

---

## 10. API ç«¯ç‚¹å®Œæ•´è¡Œä¸º

### 10.1 å…¬å¼€ç«¯ç‚¹ (æ— éœ€ç™»å½•)

| ç«¯ç‚¹ | ç¯å¢ƒå½±å“ | å†…å®¹è¿‡æ»¤ | è¯´æ˜ |
|------|----------|----------|------|
| `GET /config/client` | âœ… è¿”å›å½“å‰ç¯å¢ƒé…ç½® | âŒ | å®¢æˆ·ç«¯è·å–é…ç½® |
| `GET /books` | âœ… å½“å‰ç¯å¢ƒæ•°æ® | âœ… æŒ‰ Feature Flag | ä¹¦ç±åˆ—è¡¨ |
| `GET /categories/cascade` | âœ… å½“å‰ç¯å¢ƒæ•°æ® | âœ… æŒ‰ Feature Flag | çº§è”åˆ†ç±» |

### 10.2 è®¤è¯ç«¯ç‚¹ (éœ€ç™»å½•)

| ç«¯ç‚¹ | ç¯å¢ƒå½±å“ | å†…å®¹è¿‡æ»¤ | è¯´æ˜ |
|------|----------|----------|------|
| `GET /reading/library` | âœ… å½“å‰ç¯å¢ƒæ•°æ® | âŒ ç”¨æˆ·è‡ªå·±çš„æ•°æ® | ç”¨æˆ·ä¹¦æ¶ |
| `GET /vocabulary` | âœ… å½“å‰ç¯å¢ƒæ•°æ® | âŒ ç”¨æˆ·è‡ªå·±çš„æ•°æ® | ç”¨æˆ·è¯æ±‡ |
| `POST /ai/explain` | âœ… å½“å‰ç¯å¢ƒ | âŒ | AI è§£é‡Š |

### 10.3 ç®¡ç†ç«¯ç‚¹ (Dashboard ä¸“ç”¨)

| ç«¯ç‚¹ | ç¯å¢ƒå½±å“ | å†…å®¹è¿‡æ»¤ | è¯´æ˜ |
|------|----------|----------|------|
| `GET /admin/feature-flags` | âœ… å¯æŸ¥è¯¢ä»»æ„ç¯å¢ƒ | âŒ | ç®¡ç† Feature Flags |
| `GET /categories` (Admin) | âœ… å½“å‰è¿æ¥ç¯å¢ƒ | å¯é€‰ (X-Content-Filter) | ç®¡ç†åˆ†ç±» |
| `POST /categories` | âœ… å½“å‰è¿æ¥ç¯å¢ƒ | âŒ åˆ›å»ºä»»æ„è¯­è¨€ | åˆ›å»ºåˆ†ç±» |

### 10.4 è¯·æ±‚å¤´å¤„ç†é€»è¾‘

```typescript
// Backend Middleware
@Injectable()
export class ContentFilterMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const isAdminMode = req.headers['x-admin-mode'] === 'true';
    const contentFilter = req.headers['x-content-filter'] as string;

    if (isAdminMode) {
      // Dashboard è¯·æ±‚
      req.contentFilter = contentFilter || 'all';
      req.bypassFeatureFlag = true;
    } else {
      // Client App è¯·æ±‚
      req.contentFilter = null; // ç”± Feature Flag å†³å®š
      req.bypassFeatureFlag = false;
    }

    next();
  }
}

// Service å±‚ä½¿ç”¨
async getCategories(userId?: string, contentFilter?: string) {
  let languageFilter: string[];

  if (contentFilter) {
    // Dashboard æŒ‡å®šäº†è¿‡æ»¤å™¨
    languageFilter = contentFilter === 'all'
      ? ['en', 'zh', 'all']
      : [contentFilter, 'all'];
  } else {
    // Client Appï¼Œä½¿ç”¨ Feature Flag
    languageFilter = await this.featureFlags.getAllowedLanguages(userId);
    languageFilter.push('all'); // 'all' è¯­è¨€çš„å†…å®¹å§‹ç»ˆå¯è§
  }

  return this.prisma.category.findMany({
    where: {
      OR: [
        { language: { in: languageFilter } },
        { language: null }, // å…¼å®¹æ—§æ•°æ®
      ]
    }
  });
}
```

---

## 11. æ•°æ®æ¨¡å‹æ›´æ–°

### 11.1 Category æ¨¡å‹

```prisma
model Category {
  id          String   @id @default(uuid())
  name        String   // ä¸­æ–‡å
  nameEn      String   // è‹±æ–‡å
  slug        String   @unique
  language    String?  @default("all") // 'en' | 'zh' | 'all'
  // ... å…¶ä»–å­—æ®µ
}
```

### 11.2 Book æ¨¡å‹

```prisma
model Book {
  id          String   @id @default(uuid())
  title       String
  titleEn     String?
  language    String   @default("en") // ä¹¦ç±åŸæ–‡è¯­è¨€
  // ... å…¶ä»–å­—æ®µ
}
```

### 11.3 è¯­è¨€å­—æ®µå«ä¹‰

| language å€¼ | å«ä¹‰ | å¯è§æ€§ |
|-------------|------|--------|
| `en` | ä»…è‹±æ–‡å†…å®¹ | è‹±æ–‡ç”¨æˆ·å¯è§ |
| `zh` | ä»…ä¸­æ–‡å†…å®¹ | ä¸­æ–‡ç”¨æˆ·å¯è§ (éœ€ Feature Flag) |
| `all` | é€šç”¨å†…å®¹ | æ‰€æœ‰ç”¨æˆ·å¯è§ |
| `null` | æ—§æ•°æ®ï¼Œæœªæ ‡è®° | æ‰€æœ‰ç”¨æˆ·å¯è§ (å…¼å®¹) |

---

## 12. æ€»ç»“

| æ¦‚å¿µ | ä½œç”¨åŸŸ | æ§åˆ¶æ–¹å¼ | å½±å“èŒƒå›´ |
|------|--------|----------|----------|
| Environment | åŸºç¡€è®¾æ–½ | Dashboard é€‰æ‹©å™¨ | API ç«¯ç‚¹ã€æ•°æ®åº“ |
| Feature Flag | ç¯å¢ƒå†… | åç«¯é…ç½® | åŠŸèƒ½å¼€å…³ã€å†…å®¹ç­–ç•¥ |
| Content Filter | Dashboard UI | å‰ç«¯é€‰æ‹©å™¨ | ç®¡ç†å‘˜é¢„è§ˆè§†è§’ |

**æ ¸å¿ƒåŸåˆ™**:
1. Environment å†³å®š"åœ¨å“ªé‡Œæ“ä½œ"
2. Feature Flag å†³å®š"ç”¨æˆ·èƒ½çœ‹åˆ°ä»€ä¹ˆ"
3. Content Filter å†³å®š"ç®¡ç†å‘˜æƒ³çœ‹ä»€ä¹ˆ"

# Neon PostgreSQL 服务

> Serverless PostgreSQL - Readmigo 核心数据存储

---

## 1. 服务概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Neon Platform                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  服务类型      Serverless PostgreSQL 数据库                     │
│  官网          https://neon.tech                                │
│  定价模式      按使用量计费 + 免费套餐                          │
│                                                                  │
│  核心特性                                                        │
│  ├── Serverless 架构 - 按需自动扩缩容                           │
│  ├── 数据库分支 - 类似 Git 的版本管理                           │
│  ├── 自动扩展 - 计算资源动态调整                                │
│  ├── 时间点恢复 - Point-in-Time Recovery                        │
│  ├── 内置连接池 - PgBouncer 集成                                │
│  └── 即时启动 - 冷启动 < 500ms                                  │
│                                                                  │
│  Readmigo 使用                                                  │
│  ├── 主数据库 - 用户数据、书籍内容                              │
│  ├── 多环境隔离 - Production/Staging/Debug                      │
│  └── Prisma ORM 集成                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 架构设计

```mermaid
graph TD
    A["应用请求<br>(Prisma)"] --> B["Connection Pooler<br>(PgBouncer)<br>连接复用，减少连接开销"]
    B --> C["Compute Layer<br>(PostgreSQL)<br>可独立扩展的计算节点"]
    C --> D["Storage Layer<br>(分布式存储)<br>分离存储，支持分支和恢复"]
```

---

## 3. 项目配置

### 3.1 Readmigo Neon 项目

| 项目 | 区域 | 用途 | PostgreSQL 版本 |
|------|------|------|-----------------|
| readmigo-production | ap-southeast-1 (新加坡) | 生产环境 | 15 |
| readmigo-staging | ap-southeast-1 (新加坡) | 预发布环境 | 15 |
| readmigo-debug | ap-southeast-1 (新加坡) | 调试环境 | 15 |

### 3.2 分支策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据库分支策略                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Production Project                                             │
│  │                                                               │
│  ├── main (主分支)                                              │
│  │   └── 生产数据                                               │
│  │                                                               │
│  └── feature-xxx (功能分支)                                     │
│      └── 用于测试数据库迁移                                     │
│                                                                  │
│  分支使用场景:                                                  │
│  ├── Schema 迁移测试 - 先在分支验证，再合并到主分支             │
│  ├── 数据恢复 - 从任意时间点创建分支恢复数据                    │
│  └── 性能测试 - 复制生产数据进行压力测试                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 连接配置

### 4.1 连接类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    连接方式对比                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Pooled Connection (推荐)                                       │
│  ├── 端点: xxx-pooler.ap-southeast-1.aws.neon.tech              │
│  ├── 端口: 5432                                                 │
│  ├── 特点: 连接池化，适合高并发                                 │
│  └── 用途: 应用运行时连接                                       │
│                                                                  │
│  Direct Connection                                              │
│  ├── 端点: xxx.ap-southeast-1.aws.neon.tech                     │
│  ├── 端口: 5432                                                 │
│  ├── 特点: 直连数据库，无连接池                                 │
│  └── 用途: 数据库迁移、管理操作                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Prisma 连接配置

| 环境 | 连接类型 | 连接池大小 | 超时时间 |
|------|----------|------------|----------|
| Production | Pooled | 20 | 10s |
| Staging | Pooled | 10 | 10s |
| Debug | Pooled | 5 | 10s |
| Local (迁移) | Direct | 5 | 30s |

### 4.3 连接字符串格式

```
┌─────────────────────────────────────────────────────────────────┐
│                    连接字符串示例                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  DATABASE_URL (Pooled):                                         │
│  postgresql://user:pass@ep-xxx-pooler.ap-southeast-1.aws.neon.  │
│  tech/neondb?sslmode=require                                    │
│                                                                  │
│  DIRECT_URL (Direct):                                           │
│  postgresql://user:pass@ep-xxx.ap-southeast-1.aws.neon.tech/    │
│  neondb?sslmode=require                                         │
│                                                                  │
│  关键参数:                                                      │
│  ├── sslmode=require    SSL 强制开启                           │
│  ├── connection_limit   连接数限制                              │
│  └── pool_timeout       连接池超时                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据库规模

### 5.1 数据统计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Readmigo 数据库规模                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Prisma Models: 87+                                             │
│                                                                  │
│  模型分布:                                                      │
│  ├── 用户域      6 个模型                                       │
│  ├── 书籍域     12 个模型                                       │
│  ├── 阅读域      6 个模型                                       │
│  ├── 词汇域      4 个模型                                       │
│  ├── AI 域       3 个模型                                       │
│  ├── 作者域      9 个模型                                       │
│  ├── 角色域      4 个模型                                       │
│  ├── 时间线域    3 个模型                                       │
│  ├── 社区域      9 个模型                                       │
│  ├── 有声书域    3 个模型                                       │
│  ├── 年报域      5 个模型                                       │
│  ├── 徽章域      4 个模型                                       │
│  ├── 客服域      8 个模型                                       │
│  ├── 日志域      4 个模型                                       │
│  └── 任务域      2 个模型                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 主要数据表

| 数据域 | 核心表 | 说明 |
|--------|--------|------|
| 用户 | User, Device, Subscription | 用户账号与订阅 |
| 书籍 | Book, Chapter, BookScore | 书籍内容与评分 |
| 阅读 | ReadingSession, Highlight, Annotation | 阅读记录与标注 |
| 词汇 | Vocabulary, UserVocabulary | 全局词库与生词本 |
| 作者 | Author, AuthorChatSession | 作者信息与 AI 对话 |
| 社区 | Quote, AgoraPost | 金句与城邦内容 |

---

## 6. 自动扩展

### 6.1 Autoscaling 配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    计算资源自动扩展                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Compute Units (CU):                                            │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  0.25 CU ◀──────────────────────────────────▶ 4 CU        │ │
│  │  (最小)                                        (最大)       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Production:                                                    │
│  ├── 最小 CU: 0.25                                              │
│  ├── 最大 CU: 4                                                 │
│  └── 空闲超时: 5 分钟                                           │
│                                                                  │
│  Staging/Debug:                                                 │
│  ├── 最小 CU: 0.25                                              │
│  ├── 最大 CU: 1                                                 │
│  └── 空闲超时: 5 分钟                                           │
│                                                                  │
│  1 CU = 1 vCPU + 4GB RAM                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 冷启动优化

| 场景 | 启动时间 | 说明 |
|------|----------|------|
| 热实例 | < 50ms | 已有活跃连接 |
| 冷启动 | < 500ms | 从暂停状态恢复 |
| 分支创建 | < 1s | 基于 Copy-on-Write |

---

## 7. 备份与恢复

### 7.1 自动备份

```mermaid
graph TD
    A["1. 选择恢复时间点"] --> B["2. 创建恢复分支"]
    B --> C["3. 验证恢复数据"]
    C --> D["4. 切换应用连接"]
```

### 7.2 灾难恢复指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| RTO (恢复时间目标) | < 1 小时 | 从分支创建到切换 |
| RPO (恢复点目标) | < 5 分钟 | 最大数据丢失窗口 |

---

## 8. 安全配置

### 8.1 访问控制

```
┌─────────────────────────────────────────────────────────────────┐
│                    安全配置                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  连接安全                                                       │
│  ├── SSL/TLS 强制开启                                           │
│  ├── IP 白名单 (可选)                                           │
│  └── 密码复杂度要求                                             │
│                                                                  │
│  数据安全                                                       │
│  ├── 静态加密 (AES-256)                                         │
│  ├── 传输加密 (TLS 1.3)                                         │
│  └── 自动密钥轮换                                               │
│                                                                  │
│  访问控制                                                       │
│  ├── 角色分离 (Admin/Developer/Viewer)                          │
│  ├── API Key 管理                                               │
│  └── 审计日志                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 敏感数据处理

| 数据类型 | 处理方式 |
|----------|----------|
| 用户邮箱 | AES-256 加密存储 |
| Apple ID | 单向哈希存储 |
| 设备 Token | 加密存储 |
| 支付信息 | 外部托管 (Apple/Google) |

---

## 9. 监控与指标

### 9.1 Neon Console 指标

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控指标                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  计算指标                                                       │
│  ├── Active Time - 计算活跃时间                                 │
│  ├── Compute Hours - 计算时长统计                               │
│  └── CPU Usage - CPU 使用率                                     │
│                                                                  │
│  存储指标                                                       │
│  ├── Storage Size - 数据存储大小                                │
│  ├── Written Data - 写入数据量                                  │
│  └── Branch Size - 分支存储大小                                 │
│                                                                  │
│  连接指标                                                       │
│  ├── Active Connections - 活跃连接数                            │
│  ├── Connection Errors - 连接错误数                             │
│  └── Query Latency - 查询延迟                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Prisma 查询优化

| 优化策略 | 说明 |
|----------|------|
| select | 限制返回字段，减少数据传输 |
| include | 预加载关联数据，避免 N+1 查询 |
| cursor | 游标分页，大数据集高效翻页 |
| createMany | 批量插入，减少往返次数 |

---

## 10. 成本估算

### 10.1 定价模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    Neon 定价结构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  计费项目:                                                      │
│  ├── Compute: $0.102/CU-hour                                    │
│  ├── Storage: $0.000164/GiB-hour (~$0.12/GiB-month)            │
│  └── Written Data: $0.096/GiB                                   │
│                                                                  │
│  Free Tier 包含:                                                │
│  ├── 0.5 GB 存储                                                │
│  ├── 191.9 compute hours/月                                     │
│  └── 1 个项目                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 Readmigo 月度成本

| 资源 | 用量 | 单价 | 费用/月 |
|------|------|------|---------|
| Production Compute | ~200 hours | $0.102/h | ~$20 |
| Staging Compute | ~50 hours | $0.102/h | ~$5 |
| Debug Compute | ~30 hours | $0.102/h | ~$3 |
| 存储 (总计) | ~5 GB | $0.12/GB | ~$0.60 |
| Written Data | ~10 GB | $0.096/GB | ~$0.96 |
| **总计** | - | - | **~$30** |

---

## 11. 故障排查

### 11.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 连接超时 | 数据库暂停中 | 等待冷启动完成或增加超时 |
| 连接数满 | 连接池耗尽 | 增加连接池大小或优化连接复用 |
| 查询慢 | 缺少索引 | 使用 EXPLAIN 分析并添加索引 |
| 迁移失败 | 使用 Pooled 连接 | 切换到 Direct 连接执行迁移 |

### 11.2 排查命令

```
┌─────────────────────────────────────────────────────────────────┐
│                    常用诊断 SQL                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  查看活跃连接                                                   │
│  SELECT * FROM pg_stat_activity;                                │
│                                                                  │
│  查看数据库大小                                                 │
│  SELECT pg_size_pretty(pg_database_size('neondb'));             │
│                                                                  │
│  查看表大小                                                     │
│  SELECT relname, pg_size_pretty(pg_total_relation_size(oid))    │
│  FROM pg_class ORDER BY pg_total_relation_size(oid) DESC        │
│  LIMIT 10;                                                      │
│                                                                  │
│  慢查询分析                                                     │
│  SELECT * FROM pg_stat_statements                               │
│  ORDER BY total_exec_time DESC LIMIT 10;                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 12. 相关文档

| 文档 | 说明 |
|------|------|
| [database.md](../../infrastructure/database.md) | 数据库架构详解 |
| [fly-io.md](./fly-io.md) | Fly.io 部署服务 |
| [upstash.md](./upstash.md) | Upstash Redis 服务 |
| [be-environment-configs.md](../be-environment-configs.md) | 环境配置详情 |

---

*最后更新: 2025-12-31*

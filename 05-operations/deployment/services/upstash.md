# Upstash Redis 服务

> Serverless Redis - Readmigo 缓存与任务队列

---

## 1. 服务概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Upstash Platform                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  服务类型      Serverless Redis                                 │
│  官网          https://upstash.com                              │
│  定价模式      按请求量计费 + 免费套餐                          │
│                                                                  │
│  核心特性                                                        │
│  ├── Serverless 架构 - 无需运维                                 │
│  ├── 全球边缘 - 多区域低延迟                                    │
│  ├── 按需付费 - Pay-per-request                                 │
│  ├── REST API - HTTP 访问支持                                   │
│  ├── TLS 加密 - 安全连接                                        │
│  └── 持久存储 - 数据持久化                                      │
│                                                                  │
│  Readmigo 使用                                                  │
│  ├── 缓存层 - AI 响应、书籍数据                                 │
│  ├── 任务队列 - BullMQ 后台任务                                 │
│  ├── 会话管理 - 阅读会话状态                                    │
│  ├── 限流控制 - API 请求限制                                    │
│  └── 实时统计 - 搜索热度、排行榜                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Upstash 在系统中的位置                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                    ┌─────────────────┐                          │
│                    │  Fly.io API     │                          │
│                    │   Instances     │                          │
│                    └────────┬────────┘                          │
│                             │                                    │
│           ┌─────────────────┼─────────────────┐                 │
│           │                 │                 │                 │
│           ▼                 ▼                 ▼                 │
│    ┌────────────┐    ┌────────────┐    ┌────────────┐          │
│    │   缓存     │    │  任务队列  │    │  会话管理  │          │
│    │  查询      │    │   (BullMQ) │    │            │          │
│    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘          │
│          │                 │                 │                  │
│          └─────────────────┼─────────────────┘                  │
│                            │                                    │
│                            ▼                                    │
│                   ┌─────────────────┐                          │
│                   │  Upstash Redis  │                          │
│                   │  (ap-southeast) │                          │
│                   └─────────────────┘                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 项目配置

### 3.1 Readmigo Redis 实例

| 实例名称 | 区域 | 用途 | Key 前缀 |
|----------|------|------|----------|
| readmigo-redis-production | ap-southeast-1 | 生产环境 | `prod:` |
| readmigo-redis-staging | ap-southeast-1 | 预发布环境 | `stg:` |
| readmigo-redis-debugging | ap-southeast-1 | 调试环境 | `debug:` |

### 3.2 连接配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    连接字符串格式                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  标准 Redis 协议 (TLS):                                         │
│  rediss://default:{password}@{endpoint}.upstash.io:6379         │
│                                                                  │
│  REST API:                                                      │
│  https://{endpoint}.upstash.io                                  │
│  Header: Authorization: Bearer {token}                          │
│                                                                  │
│  环境变量:                                                      │
│  ├── REDIS_URL - 完整连接字符串                                 │
│  ├── REDIS_HOST - 主机地址                                      │
│  ├── REDIS_PORT - 端口 (6379)                                   │
│  └── REDIS_PASSWORD - 认证密码                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 使用场景

### 4.1 缓存层

```
┌─────────────────────────────────────────────────────────────────┐
│                    多级缓存架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L1: 内存缓存 (应用内)                                      ││
│  │  └── 热点数据，TTL: 5分钟                                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L2: Redis 缓存 (Upstash)                                   ││
│  │  ├── AI 响应缓存    TTL: 7天                                ││
│  │  ├── 书籍信息缓存   TTL: 1小时                              ││
│  │  ├── 用户配置缓存   TTL: 30分钟                             ││
│  │  └── 章节内容缓存   TTL: 1小时                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  L3: 持久存储 (Neon PostgreSQL)                             ││
│  │  └── 完整数据                                               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 缓存 Key 设计

| 数据类型 | Key 格式 | TTL | 说明 |
|----------|----------|-----|------|
| AI 响应 | `ai:{taskType}:{hash}` | 7天 | 词义、翻译等 |
| 书籍信息 | `book:{bookId}` | 1小时 | 书籍元数据 |
| 章节内容 | `chapter:{chapterId}` | 1小时 | 章节正文 |
| 用户配置 | `user:config:{userId}` | 30分钟 | 阅读偏好 |
| 热门搜索 | `search:hot:{date}` | 24小时 | 搜索统计 |
| 阅读会话 | `reading:session:active:{id}` | 1小时 | 实时会话 |

### 4.3 BullMQ 任务队列

```
┌─────────────────────────────────────────────────────────────────┐
│                    BullMQ 队列架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                        Redis                                 ││
│  │                      (Upstash)                               ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│         ┌────────────────────┼────────────────────┐             │
│         │                    │                    │             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │  book-import│     │  ai-tasks   │     │  email-send │       │
│  │    Queue    │     │    Queue    │     │    Queue    │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                  │
│  队列类型:                                                      │
│  ├── book-import    书籍导入处理                                │
│  ├── ai-tasks       AI 批量任务                                 │
│  ├── email-send     邮件发送                                    │
│  ├── stats-update   统计更新                                    │
│  └── cleanup        数据清理                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.4 阅读会话管理

```
┌─────────────────────────────────────────────────────────────────┐
│                    阅读会话状态存储                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Hash 结构: reading:session:active:{sessionId}                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Field             Value                                    ││
│  │  ─────────────────────────────────────────────────────────  ││
│  │  userId            "user_xxx"                               ││
│  │  bookId            "book_xxx"                               ││
│  │  chapterId         "chapter_xxx"                            ││
│  │  startedAt         "2025-01-01T10:00:00Z"                   ││
│  │  lastHeartbeat     "2025-01-01T10:15:00Z"                   ││
│  │  heartbeatCount    "15"                                     ││
│  │  progress          "0.45"                                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  用途:                                                          │
│  ├── 实时阅读进度追踪                                           │
│  ├── 心跳检测活跃状态                                           │
│  ├── 异常中断数据恢复                                           │
│  └── 阅读时长反作弊                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据结构

### 5.1 常用数据类型

| 类型 | 用途 | 示例 |
|------|------|------|
| String | 简单缓存 | 书籍信息、用户配置 |
| Hash | 结构化数据 | 阅读会话、用户状态 |
| Sorted Set | 排行榜 | 热门搜索、阅读排名 |
| List | 队列数据 | BullMQ 任务队列 |
| Set | 去重集合 | 用户已读书籍 |

### 5.2 热门搜索统计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Sorted Set 用法                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Key: search:hot:2025-01-01                                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Score    Member                                            ││
│  │  ─────────────────────────────────────────────────────────  ││
│  │  1500     "pride and prejudice"                             ││
│  │  1200     "sherlock holmes"                                 ││
│  │  980      "great expectations"                              ││
│  │  750      "jane austen"                                     ││
│  │  650      "adventure"                                       ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  操作:                                                          │
│  ├── ZINCRBY - 搜索时增加计数                                   │
│  └── ZREVRANGE - 获取热门搜索                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 限流控制

### 6.1 API 限流策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    滑动窗口限流                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  限流维度:                                                      │
│  ├── 用户级别 - ratelimit:user:{userId}                         │
│  ├── IP 级别 - ratelimit:ip:{ip}                                │
│  └── 全局级别 - ratelimit:global:{endpoint}                     │
│                                                                  │
│  限流规则:                                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  API 类型        限制             窗口                      ││
│  │  ─────────────────────────────────────────────────────────  ││
│  │  AI 请求         100次/分钟       滑动窗口                   ││
│  │  搜索请求        60次/分钟        滑动窗口                   ││
│  │  书籍请求        200次/分钟       滑动窗口                   ││
│  │  认证请求        10次/分钟        滑动窗口                   ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 免费用户配额

| 功能 | 免费限额 | 重置周期 | Key 格式 |
|------|----------|----------|----------|
| AI 查词 | 50次/天 | 每日 | `quota:ai:lookup:{userId}:{date}` |
| AI 翻译 | 30次/天 | 每日 | `quota:ai:translate:{userId}:{date}` |
| 书籍下载 | 5本/天 | 每日 | `quota:download:{userId}:{date}` |

---

## 7. 性能配置

### 7.1 连接池配置

```
┌─────────────────────────────────────────────────────────────────┐
│                    ioredis 连接配置                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  配置项:                                                        │
│  ├── maxRetriesPerRequest: 3        重试次数                   │
│  ├── retryStrategy: exponential     重试策略                   │
│  ├── connectTimeout: 10000          连接超时 (ms)              │
│  ├── commandTimeout: 5000           命令超时 (ms)              │
│  ├── enableReadyCheck: true         就绪检查                   │
│  └── lazyConnect: false             立即连接                   │
│                                                                  │
│  TLS 配置:                                                      │
│  ├── tls: { rejectUnauthorized: true }                         │
│  └── URL 协议: rediss:// (带 TLS)                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 性能优化建议

| 优化点 | 建议 | 说明 |
|--------|------|------|
| Pipeline | 批量命令合并 | 减少网络往返 |
| 合理 TTL | 按数据特性设置 | 避免内存浪费 |
| Key 命名 | 短且有意义 | 节省内存 |
| 序列化 | JSON/MessagePack | 平衡大小与性能 |

---

## 8. 监控指标

### 8.1 Upstash Console

```
┌─────────────────────────────────────────────────────────────────┐
│                    监控面板指标                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  请求指标                                                       │
│  ├── Daily Commands - 每日命令数                                │
│  ├── Commands/sec - 每秒命令数                                  │
│  └── Request Latency - 请求延迟                                 │
│                                                                  │
│  存储指标                                                       │
│  ├── Data Size - 数据大小                                       │
│  ├── Key Count - Key 数量                                       │
│  └── Memory Usage - 内存使用                                    │
│                                                                  │
│  连接指标                                                       │
│  ├── Active Connections - 活跃连接数                            │
│  └── Rejected Connections - 拒绝连接数                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 健康检查

| 检查项 | 方法 | 预期结果 |
|--------|------|----------|
| 连接状态 | PING | PONG |
| 延迟 | 计时 PING | < 100ms |
| 内存 | INFO memory | < 80% 使用率 |

---

## 9. 成本估算

### 9.1 定价模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    Upstash 定价结构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Pay-per-request:                                               │
│  ├── 命令: $0.2 / 100K 命令                                    │
│  └── 存储: $0.25 / GB-月                                       │
│                                                                  │
│  Free Tier 包含:                                                │
│  ├── 10,000 命令/天                                             │
│  ├── 256MB 存储                                                 │
│  └── 1 个数据库                                                 │
│                                                                  │
│  Pro Plan ($10/月):                                             │
│  ├── 无限命令 (按量计费)                                        │
│  ├── 1GB 存储                                                   │
│  └── 多区域复制                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Readmigo 月度成本

| 实例 | 命令数/月 | 存储 | 费用/月 |
|------|-----------|------|---------|
| Production | ~50M | ~500MB | ~$15 |
| Staging | ~5M | ~100MB | ~$2 |
| Debug | ~2M | ~50MB | ~$1 |
| **总计** | - | - | **~$18** |

---

## 10. 故障排查

### 10.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 连接超时 | TLS 配置错误 | 使用 `rediss://` 协议 |
| 命令执行慢 | 网络延迟 | 检查区域配置 |
| 内存不足 | Key 过多/TTL 过长 | 清理过期数据 |
| 限流触发 | 请求突增 | 升级套餐或优化代码 |

### 10.2 调试命令

```
┌─────────────────────────────────────────────────────────────────┐
│                    常用诊断命令                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  连接测试                                                       │
│  PING                                                           │
│                                                                  │
│  查看数据库信息                                                 │
│  INFO                                                           │
│                                                                  │
│  查看内存使用                                                   │
│  INFO memory                                                    │
│                                                                  │
│  查看客户端连接                                                 │
│  CLIENT LIST                                                    │
│                                                                  │
│  查看 Key 统计                                                  │
│  DBSIZE                                                         │
│                                                                  │
│  查看慢查询日志                                                 │
│  SLOWLOG GET 10                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. 最佳实践

### 11.1 Key 命名规范

```
┌─────────────────────────────────────────────────────────────────┐
│                    Key 命名规范                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  格式: {prefix}:{domain}:{type}:{id}                            │
│                                                                  │
│  示例:                                                          │
│  ├── prod:cache:book:12345                                      │
│  ├── prod:session:reading:session_xxx                           │
│  ├── prod:queue:book-import:job_xxx                             │
│  └── prod:stats:search:2025-01-01                               │
│                                                                  │
│  规则:                                                          │
│  ├── 使用冒号分隔层级                                           │
│  ├── 环境前缀区分实例                                           │
│  ├── 语义化命名便于理解                                         │
│  └── 避免特殊字符                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 11.2 TTL 设置建议

| 数据类型 | 推荐 TTL | 说明 |
|----------|----------|------|
| 热点缓存 | 5-30分钟 | 频繁访问 |
| AI 响应 | 7天 | 稳定内容 |
| 会话数据 | 1小时 | 自动清理 |
| 统计数据 | 24小时 | 每日重置 |
| 配置缓存 | 30分钟 | 及时更新 |

---

## 12. 相关文档

| 文档 | 说明 |
|------|------|
| [fly-io.md](./fly-io.md) | Fly.io 部署服务 |
| [neon.md](./neon.md) | Neon 数据库服务 |
| [jobs.md](../../../04-development/backend/modules/jobs.md) | BullMQ 任务队列详解 |
| [data-flow.md](../../../04-development/backend/data-flow.md) | 数据流与缓存架构 |

---

*最后更新: 2025-12-31*

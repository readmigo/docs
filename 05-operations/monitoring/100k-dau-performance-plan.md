# 10万日活用户性能优化技术方案

## 1. 流量分析与容量规划

### 1.1 用户分布

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          日活用户分布                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   总日活用户: 100,000                                                   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │                                                              │      │
│   │   客户端 (iOS/Android)     ████████████████████████  90,000 │      │
│   │   Web App                  ███                       10,000 │      │
│   │                                                              │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
│   峰值系数: 3x (假设峰值时段集中在晚间19:00-22:00)                      │
│   峰值同时在线: ~15,000 用户                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 API请求量估算

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        每日API请求量估算                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  假设条件:                                                              │
│  • 用户平均每日使用时长: 30分钟                                         │
│  • 平均每分钟API请求: 3次                                               │
│  • 单次阅读会话: 15-20分钟                                              │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  指标                      │  计算                  │  结果      │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  日均API请求总量           │  100K × 30 × 3        │  9,000,000 │   │
│  │  日均QPS                   │  9M / 86400           │  ~104 QPS  │   │
│  │  峰值QPS (3x)              │  104 × 3              │  ~312 QPS  │   │
│  │  设计容量 (2x安全余量)     │  312 × 2              │  ~625 QPS  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 主要流量入口分析

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       流量入口权重分析                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  入口                │  流量占比  │  特点                        │  │
│   │  ────────────────────────────────────────────────────────────── │  │
│   │  发现Tab             │  35%      │  高频浏览、列表查询多         │  │
│   │  城邦Tab             │  25%      │  UGC内容、需要实时性          │  │
│   │  书籍详情页          │  20%      │  详情查询、可缓存             │  │
│   │  作者详情页          │  10%      │  详情查询、可缓存             │  │
│   │  阅读器文件下载      │  10%      │  大文件、带宽密集             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   流量特征:                                                             │
│   • 发现Tab/城邦Tab: 高频但数据量小，适合缓存                           │
│   • 详情页: 中频中量，静态内容多                                        │
│   • 文件下载: 低频但大量，CDN关键                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构优化

### 2.1 目标架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    10万DAU目标架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                              用户请求                                    │
│      📱 iOS/Android (90K)          💻 Web App (10K)                     │
│              │                           │                              │
│              └───────────┬───────────────┘                              │
│                          │                                              │
│                          ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Cloudflare (CDN + WAF)                        │   │
│  │  ┌──────────────────────────────────────────────────────────┐   │   │
│  │  │  • 全球300+ PoP节点                                       │   │   │
│  │  │  • 静态资源缓存 (封面、章节HTML、字体)                    │   │   │
│  │  │  • DDoS防护 + 速率限制                                    │   │   │
│  │  │  • Argo智能路由 (可选)                                    │   │   │
│  │  └──────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────┬──────────────────────────────────────┘   │
│                              │                                          │
│         ┌────────────────────┼────────────────────┐                    │
│         │                    │                    │                    │
│         ▼                    ▼                    ▼                    │
│   ┌──────────┐        ┌──────────┐        ┌──────────┐                │
│   │ Fly.io   │        │ Fly.io   │        │ Fly.io   │                │
│   │ NRT      │        │ HKG      │        │ SJC      │                │
│   │ (Tokyo)  │        │ (HongKong)│       │ (美西)   │                │
│   │ 主区域   │        │ 中国优化 │        │ 美国优化 │                │
│   │ 2实例    │        │ 1实例    │        │ 1实例    │                │
│   └────┬─────┘        └────┬─────┘        └────┬─────┘                │
│        │                   │                   │                       │
│        └───────────────────┼───────────────────┘                       │
│                            │                                           │
│                            ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        数据层                                    │  │
│   │                                                                  │  │
│   │  ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐    │  │
│   │  │ PostgreSQL   │  │ Redis        │  │ Cloudflare R2      │    │  │
│   │  │ (Fly.io)     │  │ (Upstash)    │  │ (静态存储)         │    │  │
│   │  │              │  │              │  │                    │    │  │
│   │  │ 主库 + 只读  │  │ 集群模式     │  │ 封面 + 章节HTML    │    │  │
│   │  │ 副本         │  │ 全球边缘     │  │ EPUB文件           │    │  │
│   │  └──────────────┘  └──────────────┘  └────────────────────┘    │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 实例规格规划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Fly.io 实例配置                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  区域      │  实例数  │  规格              │  用途               │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  NRT       │  2      │  shared-cpu-2x     │  主区域             │   │
│  │  (Tokyo)   │         │  1GB RAM           │  亚太用户           │   │
│  │            │         │                    │  数据库同区域       │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  HKG       │  1      │  shared-cpu-1x     │  中国优化           │   │
│  │  (HongKong)│         │  512MB RAM         │  低延迟接入         │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  SJC       │  1      │  shared-cpu-1x     │  美洲用户           │   │
│  │  (San Jose)│         │  512MB RAM         │                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  自动扩缩容配置:                                                        │
│  • min_machines_running: 1 (每区域)                                     │
│  • auto_stop_machines: true                                             │
│  • auto_start_machines: true                                            │
│  • soft_limit: 200 connections                                          │
│  • hard_limit: 250 connections                                          │
│                                                                         │
│  预估能力:                                                              │
│  • 单实例: ~150-200 QPS                                                 │
│  • 总容量: 4实例 × 150 = 600 QPS (满足625 QPS设计目标)                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Worker进程配置

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     后台Worker架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   API请求处理与后台任务分离:                                            │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                  │  │
│   │  ┌──────────────────┐       ┌──────────────────┐               │  │
│   │  │   API Server     │       │   Worker Server   │               │  │
│   │  │   (Fly.io)       │       │   (Fly.io)        │               │  │
│   │  │                  │       │                   │               │  │
│   │  │  • HTTP请求处理  │       │  • AI数据生成     │               │  │
│   │  │  • 用户认证      │       │  • 书籍导入       │               │  │
│   │  │  • 数据查询      │       │  • 统计计算       │               │  │
│   │  └────────┬─────────┘       └─────────┬─────────┘               │  │
│   │           │                           │                         │  │
│   │           └───────────┬───────────────┘                         │  │
│   │                       │                                         │  │
│   │                       ▼                                         │  │
│   │              ┌────────────────┐                                 │  │
│   │              │  Redis Queue   │                                 │  │
│   │              │  (BullMQ)      │                                 │  │
│   │              └────────────────┘                                 │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   Worker配置:                                                           │
│   • 实例数: 1-2                                                         │
│   • 规格: shared-cpu-2x, 1GB RAM                                        │
│   • 并发: WORKER_CONCURRENCY=3                                          │
│   • 队列: author-data, book-data, quote-data, batch-orchestrator       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据库优化

### 3.1 PostgreSQL优化策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      PostgreSQL 配置优化                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前状态: Fly.io托管PostgreSQL (shared)                                │
│  目标配置: 独立PostgreSQL实例 + 只读副本                                │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        读写分离架构                              │   │
│  │                                                                  │   │
│  │             ┌─────────────────────────────┐                     │   │
│  │             │         写请求              │                     │   │
│  │             │   (INSERT/UPDATE/DELETE)    │                     │   │
│  │             └─────────────┬───────────────┘                     │   │
│  │                           │                                      │   │
│  │                           ▼                                      │   │
│  │                    ┌──────────────┐                             │   │
│  │                    │   主库       │                             │   │
│  │                    │   (NRT)      │                             │   │
│  │                    │              │                             │   │
│  │                    │  dedicated   │                             │   │
│  │                    │  1CPU / 2GB  │                             │   │
│  │                    └──────┬───────┘                             │   │
│  │                           │ 异步复制                            │   │
│  │                           ▼                                      │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │                      只读副本                            │    │   │
│  │  │  ┌──────────────┐    ┌──────────────┐                   │    │   │
│  │  │  │ 副本1 (NRT)  │    │ 副本2 (NRT)  │                   │    │   │
│  │  │  │ shared 1x    │    │ shared 1x    │                   │    │   │
│  │  │  └──────────────┘    └──────────────┘                   │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  │                           ▲                                      │   │
│  │                           │                                      │   │
│  │             ┌─────────────┴───────────────┐                     │   │
│  │             │         读请求              │                     │   │
│  │             │        (SELECT)             │                     │   │
│  │             └─────────────────────────────┘                     │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 关键索引优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        关键索引优化清单                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  高频查询表索引:                                                        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  表名              │  索引字段                   │  类型         │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  books             │  (language, is_active)     │  复合索引     │   │
│  │  books             │  (category_id, created_at) │  复合索引     │   │
│  │  books             │  source                    │  单列索引     │   │
│  │  books             │  difficulty_score          │  单列索引     │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  chapters          │  (book_id, order)          │  复合索引     │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  agora_posts       │  (author_id, created_at)   │  复合索引     │   │
│  │  agora_posts       │  (is_hidden, created_at)   │  复合索引     │   │
│  │  agora_comments    │  (post_id, created_at)     │  复合索引     │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  user_books        │  (user_id, status)         │  复合索引     │   │
│  │  user_books        │  (user_id, added_at)       │  复合索引     │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  authors           │  (name)                    │  全文索引     │   │
│  │  authors           │  (is_active)               │  单列索引     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  查询优化建议:                                                          │
│  • 使用 EXPLAIN ANALYZE 分析慢查询                                      │
│  • 对分页查询使用 cursor-based 而非 offset-based                        │
│  • 避免 SELECT * ，只查询需要的字段                                     │
│  • 定期执行 VACUUM ANALYZE 更新统计信息                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 连接池配置

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        连接池优化                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前问题: 多实例直连数据库可能导致连接数过多                           │
│                                                                         │
│  解决方案: 引入连接池代理 (PgBouncer)                                   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │   API实例 (4个)                                                  │   │
│  │   │                                                              │   │
│  │   │  每实例连接数: 10                                            │   │
│  │   │  总连接需求: 40                                              │   │
│  │   │                                                              │   │
│  │   └──────────────────────┬───────────────────────────────────── │   │
│  │                          │                                       │   │
│  │                          ▼                                       │   │
│  │              ┌─────────────────────────┐                        │   │
│  │              │      PgBouncer          │                        │   │
│  │              │                         │                        │   │
│  │              │  • 连接复用             │                        │   │
│  │              │  • 连接池: 50           │                        │   │
│  │              │  • 模式: transaction    │                        │   │
│  │              └───────────┬─────────────┘                        │   │
│  │                          │                                       │   │
│  │                          ▼                                       │   │
│  │              ┌─────────────────────────┐                        │   │
│  │              │      PostgreSQL         │                        │   │
│  │              │   max_connections: 100  │                        │   │
│  │              └─────────────────────────┘                        │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Prisma连接池配置:                                                      │
│  • connection_limit: 10                                                 │
│  • pool_timeout: 10 (秒)                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 缓存策略

### 4.1 多级缓存架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       三级缓存架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                  │  │
│   │  L1: 应用内存缓存 (Node.js)                                      │  │
│   │  ──────────────────────────                                      │  │
│   │  • 用途: 极热点数据                                              │  │
│   │  • 容量: 50-100MB                                                │  │
│   │  • TTL: 1-5分钟                                                  │  │
│   │  • 数据: 分类树、热门书籍、配置项                                │  │
│   │  • 实现: node-cache / lru-cache                                  │  │
│   │                                                                  │  │
│   │             │ 未命中                                             │  │
│   │             ▼                                                    │  │
│   │                                                                  │  │
│   │  L2: Redis分布式缓存                                             │  │
│   │  ──────────────────────                                          │  │
│   │  • 用途: 共享热点数据                                            │  │
│   │  • 容量: 500MB - 1GB                                             │  │
│   │  • TTL: 5分钟 - 24小时                                           │  │
│   │  • 数据: 书籍详情、作者信息、推荐列表、AI响应                    │  │
│   │  • 实现: Upstash Redis (全球边缘)                                │  │
│   │                                                                  │  │
│   │             │ 未命中                                             │  │
│   │             ▼                                                    │  │
│   │                                                                  │  │
│   │  L3: CDN边缘缓存                                                 │  │
│   │  ─────────────────                                               │  │
│   │  • 用途: 静态资源                                                │  │
│   │  • 容量: 无限                                                    │  │
│   │  • TTL: 1天 - 1年                                                │  │
│   │  • 数据: 封面图片、章节HTML、EPUB文件、字体                      │  │
│   │  • 实现: Cloudflare R2 + CDN                                     │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 各入口缓存策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     入口级缓存策略                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  入口           │  数据类型        │  缓存层  │  TTL    │  策略  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  发现Tab        │  分类树          │  L1+L2   │  1小时  │  预热  │   │
│  │                 │  书籍列表        │  L2      │  10分钟 │  惰性  │   │
│  │                 │  封面图片        │  L3      │  7天    │  永久  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  城邦Tab        │  帖子列表        │  L2      │  2分钟  │  惰性  │   │
│  │                 │  用户头像        │  L3      │  1天    │  永久  │   │
│  │                 │  媒体文件        │  L3      │  7天    │  永久  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  书籍详情页     │  书籍元数据      │  L2      │  1小时  │  惰性  │   │
│  │                 │  章节列表        │  L2      │  1小时  │  惰性  │   │
│  │                 │  封面大图        │  L3      │  30天   │  永久  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  作者详情页     │  作者信息        │  L2      │  1小时  │  惰性  │   │
│  │                 │  时间线/语录     │  L2      │  6小时  │  惰性  │   │
│  │                 │  作者书籍列表    │  L2      │  1小时  │  惰性  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  阅读器下载     │  章节HTML        │  L3      │  7天    │  预取  │   │
│  │                 │  EPUB文件        │  L3      │  30天   │  永久  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  缓存策略说明:                                                          │
│  • 预热: 应用启动时主动加载                                             │
│  • 惰性: 首次访问时缓存                                                 │
│  • 永久: 使用版本化URL，内容更新时换URL                                 │
│  • 预取: 基于用户行为预测预先加载                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Redis配置升级

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Redis配置升级方案                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前: Fly.io Redis (单区域)                                            │
│  目标: Upstash Redis (全球边缘)                                         │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Upstash Global Redis                         │   │
│  │                                                                  │   │
│  │      ┌─────────┐      ┌─────────┐      ┌─────────┐             │   │
│  │      │  亚太   │      │  美洲   │      │  欧洲   │             │   │
│  │      │ 边缘节点│      │ 边缘节点│      │ 边缘节点│             │   │
│  │      └────┬────┘      └────┬────┘      └────┬────┘             │   │
│  │           │                │                │                   │   │
│  │           └────────────────┼────────────────┘                   │   │
│  │                            │                                     │   │
│  │                            ▼                                     │   │
│  │                    ┌──────────────┐                             │   │
│  │                    │   主节点     │                             │   │
│  │                    │   (Tokyo)    │                             │   │
│  │                    └──────────────┘                             │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Upstash配置:                                                           │
│  • 计划: Pro ($120/月)                                                  │
│  • 容量: 3GB                                                            │
│  • 区域: 全球边缘 (读取延迟 < 10ms)                                     │
│  • 特性: 自动持久化、自动备份                                           │
│                                                                         │
│  迁移步骤:                                                              │
│  1. 创建Upstash实例                                                     │
│  2. 配置环境变量指向新实例                                              │
│  3. 灰度切换流量                                                        │
│  4. 监控性能指标                                                        │
│  5. 完全切换后下线旧实例                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. CDN与静态资源优化

### 5.1 Cloudflare R2 + CDN配置

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Cloudflare R2 + CDN优化                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  存储结构:                                                              │
│                                                                         │
│  readmigo-bucket/                                                       │
│  ├── books/                                                             │
│  │   ├── {bookId}/                                                     │
│  │   │   ├── cover.jpg              (原图, 1-3MB)                      │
│  │   │   ├── cover_medium.jpg       (中图, 200KB)                      │
│  │   │   ├── cover_thumb.jpg        (缩略图, 50KB)                     │
│  │   │   └── chapters/                                                 │
│  │   │       ├── {chapterId}.html   (章节HTML)                         │
│  │   │       └── ...                                                   │
│  │   └── ...                                                           │
│  ├── agora/                                                             │
│  │   └── {userId}/                                                      │
│  │       └── {mediaId}.{ext}        (用户上传媒体)                      │
│  └── fonts/                                                             │
│      └── {fontName}.woff2           (字体文件)                          │
│                                                                         │
│  CDN缓存配置:                                                           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  资源类型          │  Cache-Control                  │  说明    │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  封面图片          │  public, max-age=2592000,       │  30天    │   │
│  │                    │  immutable                      │  永久    │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  章节HTML          │  public, max-age=604800,        │  7天     │   │
│  │                    │  stale-while-revalidate=86400   │  +1天    │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  EPUB文件          │  public, max-age=604800         │  7天     │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  字体文件          │  public, max-age=31536000,      │  1年     │   │
│  │                    │  immutable                      │  永久    │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  用户媒体          │  public, max-age=86400          │  1天     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 图片优化策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        图片优化策略                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  多尺寸图片生成 (上传时处理):                                           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  尺寸名称      │  分辨率        │  质量  │  用途                 │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  original      │  原始尺寸      │  100%  │  高清查看             │   │
│  │  medium        │  600×900       │  80%   │  详情页               │   │
│  │  thumb         │  150×225       │  70%   │  列表/书架            │   │
│  │  blur          │  30×45         │  50%   │  占位图               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  格式选择:                                                              │
│  • 现代浏览器: WebP (节省30-40%体积)                                    │
│  • 降级方案: JPEG (兼容性)                                              │
│  • 透明背景: PNG → WebP                                                 │
│                                                                         │
│  响应式图片加载:                                                        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │  用户请求图片                                                    │   │
│  │       │                                                          │   │
│  │       ▼                                                          │   │
│  │  ┌──────────────────────────┐                                   │   │
│  │  │  检测设备/网络           │                                   │   │
│  │  │  • 屏幕DPR               │                                   │   │
│  │  │  • 网络类型              │                                   │   │
│  │  │  • 视口大小              │                                   │   │
│  │  └──────────────┬───────────┘                                   │   │
│  │                 │                                                │   │
│  │      ┌──────────┼──────────┬──────────┐                         │   │
│  │      ▼          ▼          ▼          ▼                         │   │
│  │   WiFi+高DPR  WiFi+低DPR  4G/LTE    3G/慢速                     │   │
│  │   original    medium     medium    thumb                        │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 阅读器文件下载优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    阅读器文件下载优化                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前问题:                                                              │
│  • 章节HTML通过API返回，增加后端负载                                    │
│  • EPUB文件较大，下载时间长                                             │
│  • 离线下载时一次性获取所有章节                                         │
│                                                                         │
│  优化方案:                                                              │
│                                                                         │
│  1. 章节HTML直接从CDN获取                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │   当前:  客户端 → API → 数据库 → 返回章节                        │   │
│  │                                                                  │   │
│  │   优化后: 客户端 → CDN → R2 (直接获取预渲染HTML)                 │   │
│  │                                                                  │   │
│  │   API只返回:                                                     │   │
│  │   {                                                              │   │
│  │     chapterId: "xxx",                                            │   │
│  │     contentUrl: "https://cdn.readmigo.com/books/.../ch1.html",   │   │
│  │     version: "v2"                                                │   │
│  │   }                                                              │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  2. 分批下载策略                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │   阶段          │  下载内容            │  触发时机              │   │
│  │   ───────────────────────────────────────────────────────────── │   │
│  │   即时加载      │  当前章节+前后1章    │  打开书籍              │   │
│  │   预加载        │  前后各2章           │  阅读时后台加载        │   │
│  │   离线下载      │  全部章节            │  用户主动触发          │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  3. 断点续传支持                                                        │
│  • HTTP Range请求支持                                                   │
│  • 下载进度持久化                                                       │
│  • 网络恢复自动继续                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. API性能优化

### 6.1 各入口API优化方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        发现Tab API优化                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  API端点: GET /api/v1/categories/tree                                   │
│          GET /api/v1/categories/:id/books                               │
│          GET /api/v1/recommendation/discover                            │
│                                                                         │
│  优化措施:                                                              │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 分类树预热缓存                                               │   │
│  │     • 应用启动时加载到L1内存                                     │   │
│  │     • 分类变更时主动失效                                         │   │
│  │     • TTL: 1小时 (L1) / 6小时 (L2)                               │   │
│  │                                                                  │   │
│  │  2. 书籍列表分页优化                                             │   │
│  │     • 使用cursor分页 (基于created_at + id)                       │   │
│  │     • 默认limit: 20, 最大: 50                                    │   │
│  │     • 只返回列表必需字段                                         │   │
│  │                                                                  │   │
│  │  3. 响应压缩                                                     │   │
│  │     • 启用Brotli压缩 (优先)                                      │   │
│  │     • Gzip降级                                                   │   │
│  │     • 压缩阈值: 1KB                                              │   │
│  │                                                                  │   │
│  │  4. 条件请求                                                     │   │
│  │     • 支持ETag                                                   │   │
│  │     • 支持If-None-Match → 304 Not Modified                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        城邦Tab API优化                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  API端点: GET /api/v1/agora/posts                                       │
│          POST /api/v1/agora/posts/:id/like                              │
│          GET /api/v1/agora/posts/:id/comments                           │
│                                                                         │
│  特点: UGC内容，需要实时性，不适合长时间缓存                            │
│                                                                         │
│  优化措施:                                                              │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 短时间缓存 + 增量更新                                        │   │
│  │     • 帖子列表缓存2分钟                                          │   │
│  │     • 新帖子通过WebSocket推送 (未来)                             │   │
│  │     • 当前方案: 客户端定时轮询 (30秒间隔)                        │   │
│  │                                                                  │   │
│  │  2. 点赞计数异步更新                                             │   │
│  │     • 点赞操作立即返回                                           │   │
│  │     • 计数通过Redis INCR更新                                     │   │
│  │     • 定期批量同步到数据库 (每5分钟)                             │   │
│  │                                                                  │   │
│  │  3. 媒体文件分离                                                 │   │
│  │     • 帖子API只返回媒体URL                                       │   │
│  │     • 媒体通过CDN直接加载                                        │   │
│  │     • 图片懒加载                                                 │   │
│  │                                                                  │   │
│  │  4. 分页与Feed优化                                               │   │
│  │     • 基于时间戳的cursor分页                                     │   │
│  │     • 首屏只加载10条                                             │   │
│  │     • 滚动加载更多                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                     书籍/作者详情页 API优化                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  API端点: GET /api/v1/books/:id                                         │
│          GET /api/v1/authors/:id                                        │
│                                                                         │
│  特点: 数据变化少，适合长时间缓存                                       │
│                                                                         │
│  优化措施:                                                              │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 激进缓存策略                                                 │   │
│  │     • Redis缓存: 1小时                                           │   │
│  │     • HTTP Cache-Control: max-age=300                            │   │
│  │     • 数据更新时主动失效缓存                                     │   │
│  │                                                                  │   │
│  │  2. 数据预加载                                                   │   │
│  │     • 书籍详情预加载前3章摘要                                    │   │
│  │     • 作者详情预加载书籍列表(前10本)                             │   │
│  │     • 减少后续请求数                                             │   │
│  │                                                                  │   │
│  │  3. 关联数据按需加载                                             │   │
│  │     • 基础信息立即返回                                           │   │
│  │     • 评论/评分延迟加载                                          │   │
│  │     • 相关推荐延迟加载                                           │   │
│  │                                                                  │   │
│  │  4. GraphQL考虑 (未来)                                           │   │
│  │     • 客户端按需查询字段                                         │   │
│  │     • 减少过度获取                                               │   │
│  │     • 单次请求多资源                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 API响应格式优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     API响应格式优化                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  精简响应字段:                                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  场景             │  当前大小  │  优化后   │  减少比例          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  书籍列表 (20条)  │  ~50KB    │  ~15KB   │  70%               │   │
│  │  帖子列表 (10条)  │  ~30KB    │  ~12KB   │  60%               │   │
│  │  书籍详情         │  ~20KB    │  ~8KB    │  60%               │   │
│  │  作者详情         │  ~15KB    │  ~6KB    │  60%               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  优化方法:                                                              │
│                                                                         │
│  1. 字段过滤                                                            │
│     • 列表只返回展示必需字段                                            │
│     • 详情页按需加载扩展数据                                            │
│     • 移除null/空字段                                                   │
│                                                                         │
│  2. 数据格式优化                                                        │
│     • 日期使用Unix时间戳 (数字替代字符串)                               │
│     • ID使用短格式                                                      │
│     • 布尔值使用0/1                                                     │
│                                                                         │
│  3. 嵌套数据扁平化                                                      │
│     • 减少JSON嵌套层级                                                  │
│     • 关联数据使用ID引用                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.3 速率限制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        速率限制配置                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  分层速率限制:                                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  层级          │  限制                  │  窗口  │  策略          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  全局          │  10000 req/min         │  1分钟 │  滑动窗口      │   │
│  │  IP            │  100 req/min           │  1分钟 │  滑动窗口      │   │
│  │  用户          │  300 req/min           │  1分钟 │  令牌桶        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  AI接口        │  30 req/min/user       │  1分钟 │  令牌桶        │   │
│  │  文件上传      │  10 req/min/user       │  1分钟 │  固定窗口      │   │
│  │  登录/注册     │  5 req/min/IP          │  1分钟 │  固定窗口      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  超限响应:                                                              │
│  • HTTP 429 Too Many Requests                                           │
│  • Retry-After 头部                                                     │
│  • 客户端指数退避                                                       │
│                                                                         │
│  实现: Redis + 滑动窗口算法                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 监控与告警

### 7.1 监控指标体系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        核心监控指标                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  类别        │  指标                    │  阈值       │  优先级  │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  可用性      │  API成功率               │  > 99.5%    │  P0      │   │
│  │              │  服务健康检查            │  100%       │  P0      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  延迟        │  API P50响应时间         │  < 100ms    │  P1      │   │
│  │              │  API P95响应时间         │  < 500ms    │  P1      │   │
│  │              │  API P99响应时间         │  < 1000ms   │  P1      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  吞吐量      │  QPS                     │  监控趋势   │  P1      │   │
│  │              │  并发连接数              │  < 80%容量  │  P1      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  资源        │  CPU使用率               │  < 80%      │  P2      │   │
│  │              │  内存使用率              │  < 85%      │  P2      │   │
│  │              │  磁盘使用率              │  < 80%      │  P2      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  数据库      │  连接池使用率            │  < 80%      │  P1      │   │
│  │              │  查询响应时间            │  < 50ms     │  P1      │   │
│  │              │  慢查询数量              │  < 10/min   │  P2      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  缓存        │  Redis命中率             │  > 90%      │  P2      │   │
│  │              │  Redis内存使用           │  < 80%      │  P2      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  业务        │  DAU/MAU                 │  监控趋势   │  P2      │   │
│  │              │  错误率                  │  < 1%       │  P1      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 监控架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        监控系统架构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        数据采集层                                │  │
│   │                                                                  │  │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │  │
│   │  │ Fly.io     │ │ Sentry      │ │ Cloudflare  │               │  │
│   │  │ Metrics    │ │ APM         │ │ Analytics   │               │  │
│   │  │            │ │             │ │             │               │  │
│   │  │ • CPU/内存 │ │ • 错误追踪  │ │ • 流量统计  │               │  │
│   │  │ • 网络     │ │ • 性能监控  │ │ • 安全事件  │               │  │
│   │  │ • 请求量   │ │ • 会话回放  │ │ • 边缘延迟  │               │  │
│   │  └─────────────┘ └─────────────┘ └─────────────┘               │  │
│   │                                                                  │  │
│   └─────────────────────────────┬───────────────────────────────────┘  │
│                                 │                                       │
│                                 ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        可视化层                                  │  │
│   │                                                                  │  │
│   │  ┌─────────────────────────────────────────────────────────┐   │  │
│   │  │                   Grafana Dashboard                      │   │  │
│   │  │                                                          │   │  │
│   │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │  │
│   │  │  │ 概览    │ │ API     │ │ 数据库  │ │ 业务    │       │   │  │
│   │  │  │ 面板    │ │ 性能    │ │ 监控    │ │ 指标    │       │   │  │
│   │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │  │
│   │  │                                                          │   │  │
│   │  └─────────────────────────────────────────────────────────┘   │  │
│   │                                                                  │  │
│   └─────────────────────────────┬───────────────────────────────────┘  │
│                                 │                                       │
│                                 ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        告警通道                                  │  │
│   │                                                                  │  │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │  │
│   │  │ Slack      │ │ Email       │ │ PagerDuty   │               │  │
│   │  │ (P2/P3)    │ │ (日报)      │ │ (P0/P1)     │               │  │
│   │  └─────────────┘ └─────────────┘ └─────────────┘               │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.3 告警规则

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        告警规则配置                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  告警名称              │  条件                    │  级别 │ 通道│   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  服务不可用            │  健康检查失败 > 3次      │  P0   │ 电话│   │
│  │  API错误率飙升         │  5xx > 5% 持续 5分钟     │  P0   │ 电话│   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  响应延迟高            │  P95 > 1s 持续 10分钟    │  P1   │ Slack│  │
│  │  数据库连接池满        │  使用率 > 90%            │  P1   │ Slack│  │
│  │  Redis内存告警         │  使用率 > 80%            │  P1   │ Slack│  │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  CPU使用率高           │  > 80% 持续 15分钟       │  P2   │ Slack│  │
│  │  内存使用率高          │  > 85% 持续 15分钟       │  P2   │ Slack│  │
│  │  缓存命中率低          │  < 80% 持续 30分钟       │  P2   │ Email│  │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  慢查询增多            │  > 50/小时               │  P3   │ Email│  │
│  │  磁盘空间低            │  > 70%                   │  P3   │ Email│  │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  告警降噪:                                                              │
│  • 相同告警5分钟内不重复发送                                            │
│  • 恢复通知只发送一次                                                   │
│  • 夜间(23:00-08:00) P2/P3降级处理                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 成本估算

### 8.1 基础设施成本

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     月度成本估算 (10万DAU)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  服务                  │  配置                   │  月费用(USD) │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Fly.io API           │  4实例 × shared-cpu     │  ~$80        │   │
│  │                       │  (多区域)               │              │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Fly.io Worker        │  2实例 × shared-cpu-2x  │  ~$40        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  PostgreSQL           │  dedicated-1x (2GB)     │  ~$50        │   │
│  │  (Fly.io)             │  + 只读副本             │  + $30       │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Upstash Redis        │  Pro (3GB, 全球边缘)    │  ~$120       │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Cloudflare R2        │  50GB存储 + 带宽        │  ~$20        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Cloudflare CDN       │  Pro计划                │  ~$20        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Sentry               │  Team计划               │  ~$26        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  域名+SSL             │  -                      │  ~$5         │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │                       │                         │              │   │
│  │  合计                  │                         │  ~$391       │   │
│  │  预留buffer (20%)     │                         │  ~$78        │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  总预算                │                         │  ~$470/月    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  单用户成本: ~$0.0047/DAU/月 (约¥0.034)                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 成本优化建议

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        成本优化策略                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. Fly.io实例优化                                                      │
│     • 启用 auto_stop_machines: 低流量时自动停止实例                     │
│     • 非峰值时段自动缩容                                                │
│     • 预估节省: 20-30%                                                  │
│                                                                         │
│  2. 缓存优化减少数据库负载                                              │
│     • 提高缓存命中率 (目标 >95%)                                        │
│     • 减少数据库实例规格需求                                            │
│     • 预估节省: 10-20%                                                  │
│                                                                         │
│  3. CDN带宽优化                                                         │
│     • 优化图片格式和尺寸                                                │
│     • 启用Brotli压缩                                                    │
│     • 预估节省: 15-25%                                                  │
│                                                                         │
│  4. 阶段性扩容                                                          │
│     • 根据实际流量逐步扩容                                              │
│     • 避免过度预置资源                                                  │
│     • 设置自动扩缩容策略                                                │
│                                                                         │
│  成本随用户增长曲线:                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  DAU        │  月成本      │  单用户成本                       │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  10K        │  ~$150       │  $0.015                           │   │
│  │  50K        │  ~$300       │  $0.006                           │   │
│  │  100K       │  ~$470       │  $0.0047                          │   │
│  │  200K       │  ~$800       │  $0.004                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  规模效应: 用户越多，单用户成本越低                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 实施路线图

### 9.1 分阶段实施计划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        实施阶段规划                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase 1: 基础优化 (立即执行)                                           │
│  ═══════════════════════════                                            │
│  目标: 处理当前流量 + 为增长做准备                                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  任务                              │  优先级  │  复杂度          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  添加关键数据库索引                │  高      │  低              │   │
│  │  优化API响应字段 (精简)            │  高      │  低              │   │
│  │  配置Cloudflare CDN基础规则        │  高      │  低              │   │
│  │  升级Redis到Upstash               │  高      │  中              │   │
│  │  实现三级缓存策略                  │  高      │  中              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 2: 架构扩展 (DAU > 30K时)                                        │
│  ═══════════════════════════════                                        │
│  目标: 支持多区域访问 + 提高可用性                                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  任务                              │  优先级  │  复杂度          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Fly.io多区域部署 (HKG, SJC)       │  高      │  低              │   │
│  │  添加PostgreSQL只读副本            │  高      │  中              │   │
│  │  实现读写分离                      │  高      │  中              │   │
│  │  Worker进程分离部署                │  中      │  低              │   │
│  │  配置完整监控告警                  │  中      │  中              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 3: 性能深度优化 (DAU > 70K时)                                    │
│  ══════════════════════════════════                                     │
│  目标: 优化用户体验 + 降低成本                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  任务                              │  优先级  │  复杂度          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  章节HTML直接从CDN获取             │  高      │  中              │   │
│  │  实现cursor分页                    │  中      │  中              │   │
│  │  添加PgBouncer连接池               │  中      │  中              │   │
│  │  图片多尺寸自动生成                │  中      │  中              │   │
│  │  API响应压缩优化 (Brotli)          │  低      │  低              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 4: 高可用增强 (DAU接近100K时)                                    │
│  ═══════════════════════════════════                                    │
│  目标: 确保稳定性 + 准备下一阶段增长                                    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  任务                              │  优先级  │  复杂度          │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  自动扩缩容策略精调                │  高      │  中              │   │
│  │  故障转移机制完善                  │  高      │  中              │   │
│  │  备份和恢复策略验证                │  高      │  低              │   │
│  │  性能压测和调优                    │  中      │  高              │   │
│  │  评估下一阶段架构需求              │  中      │  低              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.2 关键里程碑

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          关键里程碑                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                  │  │
│   │  M1: 基础优化完成                                                │  │
│   │  ──────────────────                                              │  │
│   │  • 索引优化生效                                                  │  │
│   │  • 缓存命中率 > 80%                                              │  │
│   │  • API P95 < 300ms                                               │  │
│   │                                                                  │  │
│   │       │                                                          │  │
│   │       ▼                                                          │  │
│   │                                                                  │  │
│   │  M2: 多区域部署完成                                              │  │
│   │  ──────────────────                                              │  │
│   │  • 3区域运行稳定                                                 │  │
│   │  • 全球延迟 < 200ms                                              │  │
│   │  • 读写分离生效                                                  │  │
│   │                                                                  │  │
│   │       │                                                          │  │
│   │       ▼                                                          │  │
│   │                                                                  │  │
│   │  M3: 深度优化完成                                                │  │
│   │  ──────────────────                                              │  │
│   │  • 缓存命中率 > 95%                                              │  │
│   │  • API P95 < 200ms                                               │  │
│   │  • 单用户成本 < $0.005                                           │  │
│   │                                                                  │  │
│   │       │                                                          │  │
│   │       ▼                                                          │  │
│   │                                                                  │  │
│   │  M4: 10万DAU稳定运行                                             │  │
│   │  ──────────────────                                              │  │
│   │  • 可用性 > 99.9%                                                │  │
│   │  • 无重大故障                                                    │  │
│   │  • 成本在预算内                                                  │  │
│   │                                                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 风险与应对

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        风险评估与应对                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  风险                  │  影响  │  概率  │  应对措施             │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  流量突增 (病毒传播)   │  高    │  中    │  自动扩缩容           │   │
│  │                        │        │        │  流量限流             │   │
│  │                        │        │        │  CDN吸收静态流量      │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  数据库性能瓶颈        │  高    │  中    │  读写分离             │   │
│  │                        │        │        │  查询优化             │   │
│  │                        │        │        │  缓存兜底             │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Redis故障             │  中    │  低    │  Upstash高可用        │   │
│  │                        │        │        │  L1缓存降级           │   │
│  │                        │        │        │  数据库直读           │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  CDN故障               │  中    │  低    │  Cloudflare SLA保障   │   │
│  │                        │        │        │  源站直接访问         │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  Fly.io区域故障        │  中    │  低    │  多区域部署           │   │
│  │                        │        │        │  自动故障转移         │   │
│  │  ────────────────────────────────────────────────────────────── │   │
│  │  成本超支              │  低    │  中    │  成本监控告警         │   │
│  │                        │        │        │  自动缩容策略         │   │
│  │                        │        │        │  资源使用审计         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  应急预案:                                                              │
│  1. 建立On-Call机制，确保问题快速响应                                   │
│  2. 准备回滚方案，任何变更可快速回退                                    │
│  3. 定期演练故障恢复流程                                                │
│  4. 保持与云服务商的沟通渠道                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 附录: 关键配置参考

### A. Fly.io多区域配置

```toml
# fly.production.toml
app = "readmigo-api"
primary_region = "nrt"

[build]
  dockerfile = "Dockerfile"

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1

[http_service.concurrency]
  type = "connections"
  hard_limit = 250
  soft_limit = 200

[[http_service.checks]]
  grace_period = "10s"
  interval = "30s"
  method = "GET"
  path = "/api/v1/health"
  timeout = "5s"

[[vm]]
  memory = "1gb"
  cpu_kind = "shared"
  cpus = 2
```

### B. 监控Dashboard查询示例

| 指标 | 查询/数据源 |
|-----|-------------|
| QPS | Fly.io Metrics: `fly_edge_http_responses_count` |
| P95延迟 | Sentry Performance: Transaction duration P95 |
| 错误率 | Sentry Issues: Error count / Total transactions |
| 缓存命中率 | Upstash Dashboard: Hit Rate % |
| 连接池使用 | Prisma Metrics: `prisma_pool_connections_busy` |

---

*文档版本: 1.0*
*最后更新: 2025-12-28*

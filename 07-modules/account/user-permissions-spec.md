# Readmigo 用户身份与权限系统技术方案

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | 1.0 |
| 创建日期 | 2025-12-21 |
| 状态 | 待审核 |

---

## 1. 概述

### 1.1 目标

建立完整的用户身份与权限控制系统，确保：
1. 不同层级用户获得对应的功能和资源访问权限
2. 权限控制在前端和后端双重验证
3. 超出限制时提供友好的升级引导
4. 系统具备良好的扩展性以支持未来 Premium 层级

### 1.2 用户层级定义

| 层级 | 定价 | 状态 |
|------|------|------|
| **Free** | 免费 | 当前实现 |
| **Pro** | $7.99/月 或 $49.99/年 | 当前实现 |
| **Premium** | 预留 | 未来扩展 |

---

## 2. 用户身份与权限矩阵

### 2.1 完整权限矩阵

| 功能模块 | 功能点 | Free | Pro | Premium (预留) |
|----------|--------|------|-----|----------------|
| **书籍访问** | 免费书籍阅读 | ✅ 10本 | ✅ 全部 | ✅ 全部 |
| | Pro书籍阅读 | ❌ | ✅ 全部 | ✅ 全部 |
| | 书籍搜索 | ✅ | ✅ | ✅ |
| | 阅读进度同步 | ✅ | ✅ | ✅ |
| **AI 功能** | 单词解释 | ✅ 5次/天 | ✅ 无限 | ✅ 无限 |
| | 句子简化 | ✅ 5次/天 | ✅ 无限 | ✅ 无限 |
| | 段落翻译 | ✅ 5次/天 | ✅ 无限 | ✅ 无限 |
| | 语法分析 | ❌ | ✅ | ✅ |
| | AI 模型 | GPT-3.5 | GPT-3.5 | GPT-4/Claude |
| **词汇学习** | 保存单词 | ✅ 50个 | ✅ 无限 | ✅ 无限 |
| | 间隔重复复习 | ❌ | ✅ | ✅ |
| | 词汇导出 | ❌ | ✅ | ✅ |
| **离线功能** | 书籍下载 | ❌ | ✅ | ✅ |
| | 离线阅读 | ❌ | ✅ | ✅ |
| | 下载数量 | - | 10本 | 无限 |
| **阅读统计** | 基础统计 | ✅ | ✅ | ✅ |
| | 详细报告 | ❌ | ✅ | ✅ |
| | 学习趋势 | ❌ | ✅ | ✅ |
| **社交功能** | 明信片模板 | 基础3个 | 全部 | 全部 |
| | 社区浏览 | ✅ | ✅ | ✅ |
| | 社区发帖 | ✅ | ✅ | ✅ |
| **AI 对话** | 语音聊天 | ❌ | ✅ 30分钟/月 | ✅ 无限 |
| | 视频聊天 | ❌ | ❌ | ✅ |
| **客服支持** | 邮件支持 | ✅ | ✅ | ✅ |
| | 优先响应 | ❌ | ❌ | ✅ 24小时内 |
| **其他** | 徽章系统 | 基础徽章 | 全部徽章 | 全部徽章 |
| | 新功能抢先 | ❌ | ❌ | ✅ |

### 2.2 限制数值定义

---

## 3. 技术架构

### 3.1 权限检查架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         iOS App                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │   Feature    │───▶│  FeatureGate │───▶│ Subscription │       │
│  │    Views     │    │   Service    │    │   Manager    │       │
│  └──────────────┘    └──────────────┘    └──────────────┘       │
│         │                   │                    │               │
│         │                   │                    │               │
│         ▼                   ▼                    ▼               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │   Paywall    │    │    Usage     │    │   StoreKit   │       │
│  │    View      │    │   Tracker    │    │   Manager    │       │
│  └──────────────┘    └──────────────┘    └──────────────┘       │
│                             │                                    │
└─────────────────────────────│────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Backend API                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │ Subscription │    │    Usage     │    │   Feature    │       │
│  │   Service    │    │   Service    │    │    Flags     │       │
│  └──────────────┘    └──────────────┘    └──────────────┘       │
│         │                   │                    │               │
│         └───────────────────┼────────────────────┘               │
│                             ▼                                    │
│                    ┌──────────────┐                              │
│                    │   Database   │                              │
│                    └──────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心组件

#### 3.2.1 FeatureGate Service (新增)

负责集中管理所有功能的权限检查。

#### 3.2.2 UsageTracker (新增)

追踪用户使用情况。

#### 3.2.3 FeatureLimit View Modifier (新增)

用于在 UI 中显示使用限制的修饰器。

---

## 4. 各功能模块实现

### 4.1 书籍访问控制

#### 4.1.1 Book 模型更新

#### 4.1.2 BookDetailView 权限检查

### 4.2 AI 功能权限控制

#### 4.2.1 AIService 更新

#### 4.2.2 AI 使用限制 UI

### 4.3 词汇保存权限控制

#### 4.3.1 VocabularyManager 更新

### 4.4 离线下载权限控制

#### 4.4.1 OfflineManager 更新

#### 4.4.2 下载按钮 UI

### 4.5 间隔重复权限控制

---

## 5. 后端 API 设计

### 5.1 权限验证中间件

### 5.2 使用限制中间件

### 5.3 API 端点权限配置

### 5.4 Usage Service

---

## 6. 数据库设计

### 6.1 用户订阅表

### 6.2 使用量日志表

### 6.3 书籍访问层级

---

## 7. 错误处理与用户体验

### 7.1 统一错误响应

### 7.2 全局错误处理器

### 7.3 用户友好提示

| 场景 | 提示内容 | 操作 |
|------|----------|------|
| AI 调用达到限制 | "You've used all 5 AI explanations today" | 显示升级按钮 |
| 词汇保存达到限制 | "You've saved 50 words. Upgrade for unlimited" | 显示升级按钮 |
| 尝试访问 Pro 书籍 | "This book requires Pro subscription" | 显示书籍预览 + 升级按钮 |
| 尝试下载离线内容 | "Offline reading is a Pro feature" | 显示功能介绍 + 升级按钮 |
| 尝试使用间隔重复 | "Spaced repetition is a Pro feature" | 显示功能演示 + 升级按钮 |

---

## 8. 测试方案

### 8.1 单元测试

### 8.2 集成测试

---

## 9. 监控与分析

### 9.1 关键指标

| 指标 | 描述 | 告警阈值 |
|------|------|----------|
| `free_to_pro_conversion` | 免费转 Pro 转化率 | < 2% |
| `limit_hit_rate` | 用户触及限制比率 | > 50% |
| `paywall_show_rate` | 付费墙展示频率 | - |
| `paywall_conversion` | 付费墙转化率 | < 5% |
| `feature_usage_by_tier` | 各层级功能使用 | - |

### 9.2 事件追踪

---

## 10. 实现优先级

### Phase 1 - 核心权限系统 (Week 1)

1. [x] 创建 FeatureGateService
2. [x] 创建 UsageTracker
3. [ ] 实现 AI 调用限制 (前端 + 后端)
4. [ ] 实现词汇保存限制
5. [ ] 实现书籍访问控制

### Phase 2 - 功能限制 (Week 2)

1. [ ] 实现离线下载限制
2. [ ] 实现间隔重复限制
3. [ ] 实现语音聊天限制
4. [ ] 更新所有相关 UI

### Phase 3 - 完善与测试 (Week 3)

1. [ ] 添加单元测试
2. [ ] 添加集成测试
3. [ ] 实现监控告警
4. [ ] 优化用户体验

---

## 11. 待确认事项

1. **AI 模型选择**: Free/Pro 用户是否都使用 GPT-3.5？
2. **语音聊天**: Pro 用户每月 30 分钟是否合适？
3. **离线下载**: Pro 用户 10 本下载限制是否合适？
4. **徽章系统**: 是否需要按层级限制徽章？

---

## 12. 审批签字

| 角色 | 姓名 | 日期 | 签字 |
|------|------|------|------|
| 产品负责人 | | | |
| 技术负责人 | | | |
| 后端负责人 | | | |
| iOS 负责人 | | | |

---

*文档版本: 1.0*
*创建日期: 2025-12-21*

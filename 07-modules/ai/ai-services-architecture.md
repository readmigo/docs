# AI服务架构

### 5.1 AI服务分层

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        AI Service Architecture                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Layer 1: 本地处理 (无成本)                                             │
│  ═══════════════════════════                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  本地词典                                                        │    │
│  │  • 离线词库 (10万+词条)                                          │    │
│  │  • 基础释义、音标、词性                                          │    │
│  │  • 简单例句                                                      │    │
│  │                                                                  │    │
│  │  适用：80%的单词查询                                             │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  Layer 2: 缓存命中 (近零成本)                                           │
│  ═══════════════════════════════                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Redis缓存                                                       │    │
│  │  • 热门查询缓存                                                  │    │
│  │  • 相同词汇+上下文的解释                                         │    │
│  │  • TTL: 7天                                                      │    │
│  │                                                                  │    │
│  │  预期命中率：30-40%                                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  Layer 3: 低成本AI (主力)                                               │
│  ═══════════════════════════                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  DeepSeek / GPT-4o-mini                                          │    │
│  │  • 词汇上下文解释                                                │    │
│  │  • 句子简化                                                      │    │
│  │  • 基础问答                                                      │    │
│  │  • 段落翻译                                                      │    │
│  │                                                                  │    │
│  │  成本：$0.08-0.11/用户/月                                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  Layer 4: 高端AI (付费专属)                                             │
│  ═══════════════════════════════                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  GPT-4o / Claude Sonnet                                          │    │
│  │  • 深度文学分析                                                  │    │
│  │  • 复杂问题回答                                                  │    │
│  │  • 写作风格分析                                                  │    │
│  │                                                                  │    │
│  │  限制：付费用户，每月50次                                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Prompt模板管理

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Prompt Template System                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  模板结构：                                                              │
│  ──────────                                                              │
│                                                                         │
│  prompts/                                                               │
│  ├── word_explain.yaml                                                  │
│  │   ├── system_prompt                                                  │
│  │   ├── user_template                                                  │
│  │   └── examples (few-shot)                                            │
│  │                                                                      │
│  ├── sentence_simplify.yaml                                             │
│  ├── paragraph_translate.yaml                                           │
│  ├── content_qa.yaml                                                    │
│  ├── chapter_summary.yaml                                               │
│  └── literary_analysis.yaml                                             │
│                                                                         │
│  示例 - word_explain.yaml：                                             │
│  ─────────────────────────                                               │
│                                                                         │
│  system_prompt: |                                                       │
│    You are a helpful English learning assistant. Explain words          │
│    in simple English that a learner can understand. Consider the        │
│    context when providing explanations.                                 │
│                                                                         │
│  user_template: |                                                       │
│    Word: {{word}}                                                       │
│    Context: "{{context}}"                                               │
│    User's English level: {{level}}                                      │
│                                                                         │
│    Please explain this word in simple English, considering the          │
│    specific meaning in this context.                                    │
│                                                                         │
│  variables:                                                             │
│    - word: string                                                       │
│    - context: string (surrounding text, ~100 chars)                     │
│    - level: enum [beginner, intermediate, advanced]                     │
│                                                                         │
│  output_format:                                                         │
│    explanation: string                                                  │
│    part_of_speech: string                                               │
│    example: string (optional)                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 成本控制机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Cost Control System                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 用户级别配额                                                        │
│  ──────────────────                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  用户类型        AI调用限制                                      │    │
│  │  ─────────────────────────────────────────────────────────────   │    │
│  │  免费用户        10次/天                                         │    │
│  │  付费用户        无限制 (Layer 1-3)                              │    │
│  │  付费用户        50次/月 (Layer 4 高端AI)                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  2. 全局成本监控                                                        │
│  ────────────────                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  监控指标                                                        │    │
│  │  • 每小时API调用量                                               │    │
│  │  • 每小时成本                                                    │    │
│  │  • 成本/用户趋势                                                 │    │
│  │                                                                  │    │
│  │  告警阈值                                                        │    │
│  │  • 单小时成本 > $50 → 告警                                       │    │
│  │  • 单日成本 > $500 → 告警 + 自动降级                             │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  3. 智能降级策略                                                        │
│  ────────────────                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  触发条件                    降级动作                            │    │
│  │  ─────────────────────────────────────────────────────────────   │    │
│  │  API错误率 > 10%           切换备用模型                          │    │
│  │  响应时间 > 5s             切换更快模型                          │    │
│  │  成本超预算                 限制高端AI，本地词典兜底             │    │
│  │  服务不可用                 返回本地词典结果 + 稍后重试          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---


# 自建 TTS 系统详细设计文档

> 目标：构建支持多音色、边读边听、交互式跳转的高质量 TTS 朗读系统

---

## 1. 功能概述

### 1.1 核心功能矩阵

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **多音色支持** | 用户可选择不同声音风格朗读 | P0 |
| **文本朗读** | 将电子书文本转为语音播放 | P0 |
| **边看边读** | 朗读时实时高亮当前句子/段落 | P0 |
| **点击跳转** | 点击任意文本位置开始朗读 | P0 |
| **文本快进** | 选择文本内容直接跳转到该位置 | P1 |
| **多角色朗读** | 对话场景自动切换不同声音 | P2 |
| **个性化声音** | 用户自定义/克隆声音 | P3 |

### 1.2 目标体验

```text
┌─────────────────────────────────────────────────────────────┐
│                      阅读器界面                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Chapter 1: A Long-expected Party                           │
│                                                             │
│  When Mr. Bilbo Baggins of Bag End announced that he        │
│  would shortly be celebrating his eleventy-first birthday   │
│  with a party of special magnificence, there was much       │
│  talk and excitement in Hobbiton.                           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Bilbo was very rich and very peculiar, and had been │   │
│  │ the wonder of the Shire for sixty years, ever since │ ◄─┤ 当前朗读高亮
│  │ his remarkable disappearance and unexpected return. │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  The riches he had brought back from his travels had        │
│  now become a local legend...                    [点击跳转] │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🎧 TTS 朗读中                                        │   │
│  │                                                     │   │
│  │  🔊 Emma (British Female)  ▼    ⚡ 1.0x  ▼          │   │
│  │                                                     │   │
│  │  ⏮ 上句    ⏸ 暂停    ⏭ 下句    📍 跳转选中文本    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构

### 2.1 整体架构图

```text
┌─────────────────────────────────────────────────────────────────────┐
│                         TTS 系统架构                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      客户端层 (Client)                        │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                │   │
│  │  │    iOS    │  │  Android  │  │    Web    │                │   │
│  │  │  Reader   │  │  Reader   │  │  Reader   │                │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘                │   │
│  │        │              │              │                       │   │
│  │        └──────────────┼──────────────┘                       │   │
│  │                       ▼                                      │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              TTS 播放引擎 (TTSEngine)                 │    │   │
│  │  │  • 音频播放控制    • 高亮同步管理                      │    │   │
│  │  │  • 文本分段处理    • 交互事件处理                      │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                │                                    │
│                                ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      服务端层 (Server)                        │   │
│  │                                                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │
│  │  │  TTS API    │  │  音色管理   │  │  缓存服务   │          │   │
│  │  │  Gateway    │  │  Service    │  │  Cache      │          │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │   │
│  │         │                │                │                  │   │
│  │         └────────────────┼────────────────┘                  │   │
│  │                          ▼                                   │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              TTS 提供商适配层 (Adapters)              │    │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │    │   │
│  │  │  │ OpenAI  │  │ Eleven  │  │  Azure  │  │  Fish   │ │    │   │
│  │  │  │   TTS   │  │  Labs   │  │   TTS   │  │  Audio  │ │    │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                │                                    │
│                                ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      存储层 (Storage)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │   │
│  │  │ PostgreSQL  │  │    Redis    │  │ Cloudflare  │          │   │
│  │  │  元数据     │  │   热缓存    │  │  R2 音频    │          │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块说明

| 模块 | 职责 | 技术选型 |
|------|------|----------|
| **TTSEngine** | 客户端播放引擎，管理音频播放和高亮同步 | Swift/Kotlin/TypeScript |
| **TTS Gateway** | 统一 API 入口，路由到不同 TTS 提供商 | NestJS |
| **Voice Service** | 音色管理，声音配置和权限控制 | NestJS |
| **Cache Service** | 音频缓存，避免重复生成 | Redis + R2 |
| **TTS Adapters** | 对接各 TTS 服务商的适配器 | NestJS |

---

## 3. 数据模型设计

### 3.1 数据库模型

### 3.2 时间戳数据结构

---

## 4. 多音色系统设计

### 4.1 预置音色库

```text
┌─────────────────────────────────────────────────────────────┐
│                      预置音色库                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  英语音色 (English Voices)                                   │
│  ─────────────────────────                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 女声 (Female)                                        │   │
│  │ • Emma      - British, Warm, Narrative              │   │
│  │ • Olivia    - American, Clear, Professional         │   │
│  │ • Sophie    - Australian, Friendly, Casual          │   │
│  │ • Charlotte - British, Elegant, Classic             │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 男声 (Male)                                          │   │
│  │ • James     - British, Deep, Authoritative          │   │
│  │ • Michael   - American, Warm, Conversational        │   │
│  │ • Daniel    - British, Young, Energetic             │   │
│  │ • William   - British, Classic, Dramatic            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  中文音色 (Chinese Voices)                                   │
│  ─────────────────────────                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 晓晓      - 女声, 温柔, 叙述                        │   │
│  │ • 云扬      - 男声, 浑厚, 专业                        │   │
│  │ • 晓萱      - 女声, 活泼, 年轻                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  特色音色 (Special Voices)                                   │
│  ─────────────────────────                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • Storyteller  - 故事讲述者风格                       │   │
│  │ • Dramatic     - 戏剧朗读风格                         │   │
│  │ • Meditation   - 冥想/舒缓风格                        │   │
│  │ • Children     - 儿童故事风格                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 音色选择器 UI

```text
┌─────────────────────────────────────────────────────────────┐
│                     选择朗读音色                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  当前: Emma (British Female)                       [▶ 试听] │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  推荐音色                                                    │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│  │  👩 Emma │  │ 👨 James │  │👩 Olivia│  │👨 Michael│       │
│  │ British │  │ British │  │American │  │American │       │
│  │  ▶ 试听 │  │  ▶ 试听 │  │  ▶ 试听 │  │  ▶ 试听 │       │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘       │
│                                                             │
│  全部音色                                          筛选 ▼   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ○ Emma        British Female, Warm         ▶ 试听  │   │
│  │ ● James       British Male, Deep           ▶ 试听  │   │
│  │ ○ Olivia      American Female, Clear       ▶ 试听  │   │
│  │ ○ Michael     American Male, Warm          ▶ 试听  │   │
│  │ ○ Storyteller Special, Narrative           ▶ 试听  │   │
│  │ ...                                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  语速调节                                                    │
│  🐢 ─────────●───────────── 🐇                            │
│              1.0x                                           │
│                                                             │
│                              [ 取消 ]  [ 确认选择 ]         │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 音色映射配置（多角色）

---

## 5. 边看边读实现

### 5.1 高亮同步流程

```text
┌─────────────────────────────────────────────────────────────┐
│                    高亮同步流程                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐                                           │
│  │  音频播放器   │                                           │
│  │  AudioPlayer │                                           │
│  └──────┬───────┘                                           │
│         │ currentTime (每 50ms 更新)                        │
│         ▼                                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │               时间戳查找器 (TimestampFinder)           │  │
│  │                                                      │  │
│  │  输入: currentTime = 12.34s                          │  │
│  │  查找: 二分搜索 timestamps 数组                       │  │
│  │  输出: charOffset = 1234                             │  │
│  └──────────────────────────────────────────────────────┘  │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │               句子定位器 (SentenceLocator)            │  │
│  │                                                      │  │
│  │  输入: charOffset = 1234                             │  │
│  │  计算: 找到包含该位置的句子边界                       │  │
│  │  输出: sentenceStart = 1200, sentenceEnd = 1280      │  │
│  └──────────────────────────────────────────────────────┘  │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │               高亮渲染器 (HighlightRenderer)          │  │
│  │                                                      │  │
│  │  输入: range = {start: 1200, end: 1280}              │  │
│  │  动作: 1. 移除旧高亮                                  │  │
│  │        2. 添加新高亮 CSS 类                          │  │
│  │        3. 滚动到可视区域                             │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 高亮模式选项

```text
┌─────────────────────────────────────────────────────────────┐
│                      高亮模式对比                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  模式 1: 单词级高亮 (Word)                                   │
│  ─────────────────────────                                  │
│  "It is a [truth] universally acknowledged..."              │
│           ▲                                                 │
│        当前单词                                              │
│  优点: 精确跟踪                                              │
│  缺点: 视觉干扰大，需要精确时间戳                            │
│                                                             │
│  模式 2: 句子级高亮 (Sentence) ← 推荐默认                    │
│  ─────────────────────────────                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ It is a truth universally acknowledged, that a      │   │
│  │ single man in possession of a good fortune, must    │   │
│  │ be in want of a wife.                               │   │
│  └─────────────────────────────────────────────────────┘   │
│  优点: 阅读体验好，实现简单                                  │
│  缺点: 长句子时定位不够精确                                  │
│                                                             │
│  模式 3: 段落级高亮 (Paragraph)                              │
│  ─────────────────────────────                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [整个段落高亮...]                                    │   │
│  │                                                     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│  优点: 最简单，视觉干扰最小                                  │
│  缺点: 定位粗糙                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 高亮同步代码示例

---

## 6. 交互式跳转实现

### 6.1 点击文本跳转

```text
┌─────────────────────────────────────────────────────────────┐
│                   点击跳转交互流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户操作                                                    │
│  ────────                                                   │
│  1. 用户点击文本 "The riches he had brought back..."        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │         点击位置                                     │   │
│  │             ▼                                       │   │
│  │  The riches he had brought back from his travels    │   │
│  │  had now become a local legend...                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  系统处理                                                    │
│  ────────                                                   │
│  2. 获取点击位置的字符偏移量 charOffset = 2456              │
│  3. 定位到包含该位置的句子起始 sentenceStart = 2420         │
│  4. 查找句子起始对应的时间戳 time = 45.6s                   │
│  5. 跳转音频到该时间点 audioPlayer.seek(45.6)               │
│  6. 更新高亮到该句子                                        │
│                                                             │
│  结果                                                        │
│  ────                                                       │
│  从点击位置的句子开始朗读                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 选择文本快进

```text
┌─────────────────────────────────────────────────────────────┐
│                   选择文本快进交互                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户操作                                                    │
│  ────────                                                   │
│  1. 用户长按并选择一段文本                                   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ...talk and excitement in Hobbiton.                │   │
│  │                                                     │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ Bilbo was very rich and very peculiar, and    │ │   │
│  │  │ had been the wonder of the Shire for sixty    │ │   │ ← 选中
│  │  │ years, ever since his remarkable              │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  disappearance and unexpected return.               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  2. 显示快捷菜单                                             │
│  ┌────────────────────────────────────────┐                │
│  │  📖 查词  │  📍 跳转朗读  │  📋 复制  │                │
│  └────────────────────────────────────────┘                │
│                                                             │
│  3. 点击"跳转朗读"                                          │
│                                                             │
│  系统处理                                                    │
│  ────────                                                   │
│  • 获取选中文本起始位置 selectionStart = 1580               │
│  • 查找对应时间戳 time = 32.1s                              │
│  • 音频跳转到该时间点                                        │
│  • 开始朗读                                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 快进交互代码

---

## 7. API 设计

### 7.1 TTS 生成 API

### 7.2 音频流式播放 API

### 7.3 音色管理 API

---

## 8. 客户端实现

### 8.1 iOS TTSEngine 核心类

### 8.2 高亮渲染组件

---

## 9. 性能优化

### 9.1 音频预加载策略

```text
┌─────────────────────────────────────────────────────────────┐
│                    音频预加载策略                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  策略 1: 分片预加载                                          │
│  ─────────────────                                          │
│                                                             │
│  当前播放: Segment 5                                         │
│           ▼                                                 │
│  [1][2][3][4][5][6][7][8][9][10]...                        │
│              └──┬──┘                                        │
│           已缓存 Segment 6-7                                 │
│                                                             │
│  规则:                                                       │
│  • 预加载当前片段后 2 个片段                                 │
│  • 释放当前片段前 3 个片段的缓存                            │
│  • 保持内存占用 < 50MB                                       │
│                                                             │
│  策略 2: 章节预生成                                          │
│  ─────────────────                                          │
│                                                             │
│  用户打开书籍时:                                             │
│  • 后台队列生成当前章节 TTS                                  │
│  • 优先生成用户最可能阅读的章节                              │
│  • 使用用户默认音色预生成                                    │
│                                                             │
│  策略 3: 缓存复用                                            │
│  ─────────────────                                          │
│                                                             │
│  缓存 Key: hash(bookId + chapterId + segmentIndex +         │
│                 voiceId + speed + textHash)                 │
│                                                             │
│  • 相同内容 + 相同配置 = 复用已生成音频                     │
│  • 热门书籍预生成多种音色版本                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 时间戳索引优化

---

## 10. 成本控制

### 10.1 TTS 生成成本优化

```text
┌─────────────────────────────────────────────────────────────┐
│                    成本优化策略                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  策略 1: 按需生成                                            │
│  ─────────────────                                          │
│  • 用户首次播放章节时才生成 TTS                              │
│  • 不预生成所有书籍的所有章节                                │
│  • 热门书籍除外（预生成提升体验）                            │
│                                                             │
│  策略 2: 分层服务商                                          │
│  ─────────────────                                          │
│                                                             │
│  免费用户:                                                   │
│  ├── 使用 OpenAI TTS ($0.015/1K字符)                        │
│  └── 限制可选音色数量 (3个)                                 │
│                                                             │
│  付费用户:                                                   │
│  ├── 可选 ElevenLabs 高质量音色                             │
│  ├── 解锁所有预置音色                                        │
│  └── 支持个性化声音克隆                                      │
│                                                             │
│  策略 3: 缓存复用                                            │
│  ─────────────────                                          │
│  • 相同文本 + 相同配置 = 100% 复用                          │
│  • 热门章节预生成，服务所有用户                              │
│  • 缓存命中率目标: > 60%                                    │
│                                                             │
│  策略 4: 文本优化                                            │
│  ─────────────────                                          │
│  • 去除重复空白字符                                          │
│  • 标点符号不计费处理                                        │
│  • 长静音段落跳过                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 成本估算模型

---

## 11. 实施计划

### 11.1 分阶段实施

```text
┌─────────────────────────────────────────────────────────────┐
│                      实施路线图                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: 基础 TTS 播放                                      │
│  ────────────────────────                                   │
│  • 集成 OpenAI TTS API                                      │
│  • 实现文本分段和音频生成                                    │
│  • 基础播放控制 (播放/暂停/语速)                            │
│  • 句子级高亮同步                                            │
│                                                             │
│  Phase 2: 多音色支持                                         │
│  ────────────────────                                       │
│  • 音色管理系统                                              │
│  • 用户音色偏好                                              │
│  • 音色预览功能                                              │
│  • 集成 ElevenLabs (Premium)                                │
│                                                             │
│  Phase 3: 交互式跳转                                         │
│  ────────────────────                                       │
│  • 点击文本跳转朗读                                          │
│  • 选择文本快进                                              │
│  • 单词级高亮支持                                            │
│  • 性能优化                                                  │
│                                                             │
│  Phase 4: 高级功能                                           │
│  ─────────────────                                          │
│  • 多角色对话朗读                                            │
│  • 个性化声音克隆                                            │
│  • 离线 TTS 支持                                             │
│  • Android/Web 平台支持                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.2 开发工时估算

| 模块 | 任务 | 工时 |
|------|------|------|
| **后端** | TTS Gateway + Adapters | 24h |
| **后端** | 音色管理服务 | 16h |
| **后端** | 缓存服务 | 12h |
| **iOS** | TTSEngine 核心 | 32h |
| **iOS** | 高亮同步组件 | 24h |
| **iOS** | 交互跳转功能 | 16h |
| **iOS** | 音色选择 UI | 12h |
| **测试** | 单元测试 + 集成测试 | 24h |
| **总计** | | ~160h |

---

## 12. 参考资料

| 资源 | 说明 |
|------|------|
| [OpenAI TTS API](https://platform.openai.com/docs/guides/text-to-speech) | 官方文档 |
| [ElevenLabs API](https://docs.elevenlabs.io/) | 高质量 TTS |
| [Azure Speech Service](https://learn.microsoft.com/en-us/azure/ai-services/speech-service/) | 企业级 TTS |
| [AVFoundation](https://developer.apple.com/av-foundation/) | iOS 音频框架 |
| [Web Speech API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API) | 浏览器 TTS |

---

*文档创建日期: 2025-12-31*
*版本: v1.0*
*状态: 设计完成*

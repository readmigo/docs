# 生词本功能详细设计文档

> 版本: 1.0 | 更新日期: 2025-12-28

---

## 目录

1. [系统架构](#1-系统架构)
2. [数据模型](#2-数据模型)
3. [SM-2 间隔重复算法](#3-sm-2-间隔重复算法)
4. [API 接口设计](#4-api-接口设计)
5. [客户端实现](#5-客户端实现)
6. [交互流程](#6-交互流程)
7. [性能优化](#7-性能优化)

---

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端层                                   │
├─────────────────────────────┬───────────────────────────────────────┤
│         iOS (SwiftUI)       │         Android (Compose)             │
│  ┌───────────────────────┐  │  ┌───────────────────────────────┐   │
│  │   VocabularyManager   │  │  │     VocabularyViewModel       │   │
│  │   (Observable)        │  │  │     (MVVM + StateFlow)        │   │
│  └───────────────────────┘  │  └───────────────────────────────┘   │
│            │                │              │                        │
│  ┌───────────────────────┐  │  ┌───────────────────────────────┐   │
│  │   VocabularyView      │  │  │   VocabularyRepository        │   │
│  │   ReviewSessionView   │  │  │   (Local + Remote)            │   │
│  └───────────────────────┘  │  └───────────────────────────────┘   │
└─────────────────────────────┴───────────────────────────────────────┘
                                    │
                                    ▼ HTTPS
┌─────────────────────────────────────────────────────────────────────┐
│                           后端服务层                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                  NestJS Application                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │   │
│  │  │ VocabularyCtrl  │  │ VocabularyService│  │  SM-2 Algo  │  │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                    │                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Prisma ORM                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           数据存储层                                 │
│  ┌─────────────────────┐  ┌─────────────────────────────────────┐  │
│  │    PostgreSQL       │  │           Redis (缓存)              │  │
│  │  - Vocabulary       │  │  - 统计数据缓存                      │  │
│  │  - UserVocabulary   │  │  - 会话缓存                          │  │
│  │  - ReviewRecord     │  │                                     │  │
│  └─────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块职责

| 模块 | 职责 |
|------|------|
| VocabularyController | 处理 HTTP 请求，参数校验，权限控制 |
| VocabularyService | 业务逻辑，SM-2 算法计算，数据转换 |
| VocabularyRepository | 数据访问，CRUD 操作，查询优化 |
| VocabularyManager (客户端) | 状态管理，API 调用，本地缓存 |

---

## 2. 数据模型

### 2.1 数据库 ER 图

```
┌─────────────────────┐       ┌─────────────────────────────┐
│     Vocabulary      │       │       UserVocabulary        │
│  (全局词库)         │       │    (用户学习记录)           │
├─────────────────────┤       ├─────────────────────────────┤
│ id (PK, UUID)       │◄──────│ vocabularyId (FK)           │
│ word (UNIQUE)       │       │ id (PK, UUID)               │
│ phonetic            │       │ userId (FK)                 │
│ definition          │       │ sourceBookId                │
│ simpleDefinition    │       │ sourceContext               │
│ examples (JSON)     │       │ status                      │
│ frequencyRank       │       │ easeFactor                  │
│ source              │       │ intervalDays                │
│ createdAt           │       │ repetitions                 │
│ updatedAt           │       │ nextReviewAt                │
└─────────────────────┘       │ timesReviewed               │
                              │ timesCorrect                │
                              │ timesWrong                  │
┌─────────────────────┐       │ createdAt                   │
│        User         │       │ updatedAt                   │
├─────────────────────┤       └─────────────────────────────┘
│ id (PK, UUID)       │◄──────         │
│ email               │                │
│ ...                 │                ▼
└─────────────────────┘       ┌─────────────────────────────┐
                              │      ReviewRecord           │
                              │    (复习历史记录)           │
                              ├─────────────────────────────┤
                              │ id (PK, UUID)               │
                              │ userId (FK)                 │
                              │ userVocabularyId (FK)       │
                              │ rating (0-5)                │
                              │ responseTimeMs              │
                              │ intervalBefore              │
                              │ intervalAfter               │
                              │ easeBefore                  │
                              │ easeAfter                   │
                              │ createdAt                   │
                              └─────────────────────────────┘
```

### 2.2 核心字段说明

#### UserVocabulary 表

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| status | Enum | NEW | NEW / LEARNING / REVIEWING / MASTERED |
| easeFactor | Float | 2.5 | SM-2 难度因子，最小值 1.3 |
| intervalDays | Int | 1 | 下次复习间隔（天） |
| repetitions | Int | 0 | 连续正确次数 |
| nextReviewAt | DateTime | NULL | 下次复习时间 |
| timesReviewed | Int | 0 | 累计复习次数 |
| timesCorrect | Int | 0 | 正确次数 |
| timesWrong | Int | 0 | 错误次数 |

### 2.3 状态转换图

```
                    ┌───────────────────────────────────────┐
                    │                                       │
                    ▼                                       │
    ┌─────────┐  添加词汇   ┌─────────┐  q≥3, rep≥2  ┌─────────────┐
    │   NEW   │ ─────────► │LEARNING │ ────────────► │  REVIEWING  │
    └─────────┘            └─────────┘               └─────────────┘
         │                      │                          │
         │                      │ q<3                      │ q≥3, interval≥21
         │                      │ (重置)                   │
         │                      ▼                          ▼
         │                 重置 repetitions=0         ┌─────────┐
         │                 interval=1天               │MASTERED │
         │                      │                    └─────────┘
         │                      │                          │
         └──────────────────────┴──────────────────────────┘
                            (失败时回退)
```

---

## 3. SM-2 间隔重复算法

### 3.1 算法原理

SM-2 (SuperMemo 2) 基于艾宾浩斯遗忘曲线，核心思想：
- 记忆越牢固，复习间隔越长
- 每次复习后根据反馈调整难度因子
- 失败时重置学习进度

### 3.2 核心参数

| 参数 | 符号 | 范围 | 说明 |
|------|------|------|------|
| 评分 | q | 0-5 | 用户对记忆程度的自我评估 |
| 难度因子 | EF | ≥1.3 | 词汇难度，影响间隔增长速度 |
| 间隔 | I | ≥1 | 下次复习间隔（天） |
| 重复次数 | n | ≥0 | 连续正确次数 |

### 3.3 评分标准

| 评分 | 按钮 | 含义 | 下次间隔 |
|------|------|------|----------|
| 0 | Again | 完全忘记 | 1 天 |
| 2 | Hard | 想起但困难 | 当前 × 1.2 |
| 3 | Good | 正确回忆 | 当前 × EF |
| 5 | Easy | 轻松记住 | 当前 × EF × 1.3 |

### 3.4 算法流程图

```
                    ┌─────────────────────┐
                    │   用户提交评分 (q)   │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │      q >= 3 ?       │
                    └──────────┬──────────┘
                               │
              ┌────────────────┴────────────────┐
              │ YES                             │ NO
              ▼                                 ▼
    ┌─────────────────────┐          ┌─────────────────────┐
    │   计算新 EF 值       │          │   重置学习          │
    │                     │          │   n = 0             │
    │ EF' = EF + (0.1 -   │          │   I = 1 天          │
    │   (5-q)*(0.08 +     │          │   status = LEARNING │
    │   (5-q)*0.02))      │          └─────────────────────┘
    │                     │
    │ EF' = max(1.3, EF') │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │   计算新间隔         │
    │                     │
    │   n=1: I = 1 天     │
    │   n=2: I = 6 天     │
    │   n>2: I = I × EF'  │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │   更新状态          │
    │                     │
    │ I >= 21 天 →        │
    │   status = MASTERED │
    └─────────────────────┘
```

### 3.5 EF 计算公式

```
EF' = EF + (0.1 - (5 - q) × (0.08 + (5 - q) × 0.02))

展开：
q = 5: EF' = EF + 0.1
q = 4: EF' = EF + 0.0
q = 3: EF' = EF - 0.14
q = 2: EF' = EF - 0.32
q = 1: EF' = EF - 0.54
q = 0: EF' = EF - 0.80

约束：EF' = max(1.3, EF')
```

### 3.6 间隔计算示例

| 复习次数 | 评分 | EF 值 | 间隔 (天) |
|---------|------|-------|----------|
| 1 | 4 | 2.5 | 1 |
| 2 | 4 | 2.5 | 6 |
| 3 | 4 | 2.5 | 15 |
| 4 | 4 | 2.5 | 38 |
| 5 | 3 | 2.36 | 90 |

---

## 4. API 接口设计

### 4.1 接口总览

| 方法 | 端点 | 认证 | 说明 |
|------|------|------|------|
| GET | /vocabulary | JWT | 获取词汇列表 |
| POST | /vocabulary | JWT | 添加词汇 |
| PATCH | /vocabulary/:id | JWT | 更新词汇 |
| DELETE | /vocabulary/:id | JWT | 删除词汇 |
| GET | /vocabulary/review | JWT+PRO | 获取待复习词汇 |
| POST | /vocabulary/:id/review | JWT+PRO | 提交复习结果 |
| POST | /vocabulary/review/batch | JWT+PRO | 批量复习 |
| GET | /vocabulary/stats | JWT | 获取统计信息 |
| POST | /vocabulary/auto-batch | JWT | 批量添加词汇 |

### 4.2 接口详情

#### 获取词汇列表

```
GET /vocabulary?status=LEARNING&bookId=uuid&search=word&page=1&limit=20

Response 200:
{
  "items": [
    {
      "id": "uuid",
      "word": "ephemeral",
      "context": "The beauty is ephemeral.",
      "definition": "Lasting for a short time",
      "status": "LEARNING",
      "easeFactor": 2.5,
      "intervalDays": 6,
      "repetitions": 2,
      "nextReviewAt": "2025-01-03T10:00:00Z",
      "createdAt": "2025-12-28T10:00:00Z",
      "bookTitle": "The Great Gatsby"
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20,
  "totalPages": 8
}
```

#### 添加词汇

```
POST /vocabulary
Content-Type: application/json

{
  "word": "ephemeral",
  "context": "The beauty is ephemeral.",
  "definition": "Lasting for a short time",
  "translation": "短暂的",
  "bookId": "uuid",
  "chapterId": "uuid"
}

Response 201:
{
  "id": "uuid",
  "word": "ephemeral",
  "status": "NEW",
  "createdAt": "2025-12-28T10:00:00Z"
}
```

#### 获取待复习词汇

```
GET /vocabulary/review?limit=20

Response 200:
{
  "words": [...],
  "totalDue": 15,
  "newWords": 10,
  "reviewWords": 5
}
```

#### 提交复习结果

```
POST /vocabulary/:id/review
Content-Type: application/json

{
  "quality": 4
}

Response 200:
{
  "success": true,
  "nextReviewAt": "2025-01-03T10:00:00Z",
  "intervalDays": 6,
  "newStatus": "LEARNING"
}
```

#### 获取统计信息

```
GET /vocabulary/stats

Response 200:
{
  "total": 150,
  "new": 30,
  "learning": 80,
  "reviewing": 25,
  "mastered": 15,
  "dueToday": 12,
  "studiedToday": 8,
  "currentStreak": 5
}
```

### 4.3 错误响应

| 状态码 | 场景 | 响应体 |
|--------|------|--------|
| 400 | 参数校验失败 | `{ "message": "Invalid quality value" }` |
| 401 | 未认证 | `{ "message": "Unauthorized" }` |
| 403 | 订阅级别不足 | `{ "message": "PRO subscription required" }` |
| 404 | 词汇不存在 | `{ "message": "Vocabulary not found" }` |
| 409 | 词汇已存在 | `{ "message": "Word already exists" }` |

---

## 5. 客户端实现

### 5.1 iOS 架构

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer                             │
│  ┌─────────────┐  ┌─────────────────┐  ┌────────────────┐  │
│  │LearningView │  │VocabularyView   │  │ReviewSessionView│  │
│  └──────┬──────┘  └────────┬────────┘  └───────┬────────┘  │
│         │                  │                    │           │
│         └──────────────────┴────────────────────┘           │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              VocabularyManager (@Observable)         │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ @Published words: [VocabularyWord]          │    │   │
│  │  │ @Published reviewWords: [VocabularyWord]    │    │   │
│  │  │ @Published stats: VocabularyStats?          │    │   │
│  │  │ @Published isLoading: Bool                  │    │   │
│  │  │ @Published error: String?                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    APIClient                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Android 架构

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer                             │
│  ┌─────────────────┐  ┌───────────────────────────────┐    │
│  │VocabularyScreen │  │     ReviewSessionScreen       │    │
│  └────────┬────────┘  └──────────────┬────────────────┘    │
│           │                          │                      │
│           └──────────────────────────┘                      │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              VocabularyViewModel                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ listState: StateFlow<VocabularyListState>   │    │   │
│  │  │ reviewState: StateFlow<ReviewSessionState>  │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              VocabularyRepository                    │   │
│  │  ┌──────────────────┐  ┌─────────────────────────┐  │   │
│  │  │  VocabularyDao   │  │      ApiService         │  │   │
│  │  │  (Room 本地存储)  │  │    (Retrofit 远程)      │  │   │
│  │  └──────────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 UI 界面结构

#### 词汇列表页

```
┌─────────────────────────────────────┐
│  📚 我的生词本              🔍      │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ 总计: 150 │ 掌握: 15 │ 今日: 12 │
│  └─────────────────────────────┘    │
├─────────────────────────────────────┤
│  🔎 搜索词汇...                     │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ ephemeral                   │    │
│  │ "The beauty is ephemeral."  │    │
│  │ ●●●○○ LEARNING              │    │
│  └─────────────────────────────┘    │
│  ┌─────────────────────────────┐    │
│  │ serendipity                 │    │
│  │ "It was pure serendipity."  │    │
│  │ ●●●●● MASTERED              │    │
│  └─────────────────────────────┘    │
│  ...                                │
├─────────────────────────────────────┤
│        [ 开始复习 (12) ]            │
└─────────────────────────────────────┘
```

#### 复习会话页

```
┌─────────────────────────────────────┐
│  ✕                    3/15          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│           ephemeral                 │
│           /ɪˈfem(ə)rəl/            │
│                                     │
│     "The beauty of cherry          │
│      blossoms is ephemeral."       │
│                                     │
│                                     │
├─────────────────────────────────────┤
│        [ 显示答案 ]                 │
└─────────────────────────────────────┘

           ▼ 点击显示答案后

┌─────────────────────────────────────┐
│  ✕                    3/15          │
├─────────────────────────────────────┤
│           ephemeral                 │
│           /ɪˈfem(ə)rəl/            │
│     ─────────────────────          │
│     短暂的，瞬息的                  │
│     Lasting for a very short time  │
│                                     │
│     "The beauty of cherry          │
│      blossoms is ephemeral."       │
├─────────────────────────────────────┤
│ [Again] [Hard]  [Good]  [Easy]     │
│  <1min   1d      6d      15d       │
└─────────────────────────────────────┘
```

---

## 6. 交互流程

### 6.1 添加生词流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   阅读器     │     │   客户端     │     │    后端      │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       │ 用户选中单词       │                    │
       │ ──────────────────►│                    │
       │                    │                    │
       │                    │ POST /vocabulary   │
       │                    │ ──────────────────►│
       │                    │                    │
       │                    │                    │ 检查词汇是否存在
       │                    │                    │ 创建 UserVocabulary
       │                    │                    │ 设置 status=NEW
       │                    │                    │ 设置 nextReviewAt
       │                    │                    │
       │                    │     201 Created    │
       │                    │ ◄──────────────────│
       │                    │                    │
       │    显示添加成功    │                    │
       │ ◄──────────────────│                    │
       │                    │                    │
```

### 6.2 复习会话流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   用户       │     │   客户端     │     │    后端      │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       │ 点击"开始复习"    │                    │
       │ ──────────────────►│                    │
       │                    │                    │
       │                    │ GET /vocabulary/review
       │                    │ ──────────────────►│
       │                    │                    │
       │                    │                    │ 查询待复习词汇
       │                    │                    │ nextReviewAt <= NOW
       │                    │                    │
       │                    │   ReviewSession    │
       │                    │ ◄──────────────────│
       │                    │                    │
       │   显示第一张卡片   │                    │
       │ ◄──────────────────│                    │
       │                    │                    │
       │ 点击"显示答案"    │                    │
       │ ──────────────────►│                    │
       │                    │                    │
       │   显示释义+按钮    │                    │
       │ ◄──────────────────│                    │
       │                    │                    │
       │ 点击 [Good]       │                    │
       │ ──────────────────►│                    │
       │                    │                    │
       │                    │ POST /:id/review   │
       │                    │ { quality: 3 }     │
       │                    │ ──────────────────►│
       │                    │                    │
       │                    │                    │ 执行 SM-2 算法
       │                    │                    │ 更新 EF, interval
       │                    │                    │ 记录 ReviewRecord
       │                    │                    │
       │                    │   { nextReviewAt } │
       │                    │ ◄──────────────────│
       │                    │                    │
       │   显示下一张卡片   │                    │
       │ ◄──────────────────│                    │
       │                    │                    │
       │        ...         │        ...         │
       │                    │                    │
       │   显示完成界面     │                    │
       │ ◄──────────────────│                    │
```

### 6.3 离线同步流程 (Android)

```
┌──────────────────────────────────────────────────────────────┐
│                      离线状态                                 │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  用户添加词汇 ──► 保存到本地 Room ──► 标记 syncStatus=PENDING │
│                                                              │
│  用户复习词汇 ──► 本地 SM-2 计算 ──► 更新本地数据            │
│                   ──► 保存 ReviewRecord (pending)            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼ 网络恢复
┌──────────────────────────────────────────────────────────────┐
│                      同步流程                                 │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 查询所有 syncStatus=PENDING 的记录                       │
│  2. 批量上传到服务器                                         │
│  3. 服务器返回最新数据                                       │
│  4. 合并冲突 (使用 updatedAt 判断)                          │
│  5. 更新本地 syncStatus=SYNCED                               │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 7. 性能优化

### 7.1 数据库索引

### 7.2 缓存策略

| 数据类型 | 缓存位置 | TTL | 失效条件 |
|---------|---------|-----|---------|
| 统计数据 | Redis | 5 分钟 | 复习提交后 |
| 词汇列表 | 客户端内存 | 会话内 | 添加/删除词汇 |
| 待复习词汇 | 客户端内存 | 10 分钟 | 复习完成 |

### 7.3 查询优化

| 操作 | 优化前 | 优化后 | 提升 |
|------|-------|-------|------|
| 获取待复习词汇 | 全表扫描 | 索引查询 | 10x |
| 统计各状态数量 | 多次查询 | 单次 GROUP BY | 3x |
| 批量复习提交 | 逐条更新 | 批量事务 | 5x |

### 7.4 客户端优化

| 优化项 | 实现方式 |
|-------|---------|
| 乐观更新 | 本地立即更新 UI，后台异步同步 |
| 预加载 | 进入复习前预加载下一批词汇 |
| 分页加载 | 词汇列表分页，每次 20 条 |
| 图片懒加载 | 仅加载可视区域内的图片 |

---

## 附录

### A. 文件路径参考

| 模块 | 路径 |
|------|------|
| 后端 Controller | `src/modules/vocabulary/vocabulary.controller.ts` |
| 后端 Service | `src/modules/vocabulary/vocabulary.service.ts` |
| iOS Manager | `ios/Readmigo/Features/Learning/VocabularyManager.swift` |
| iOS View | `ios/Readmigo/Features/Learning/VocabularyView.swift` |
| Android ViewModel | `android/app/.../features/vocabulary/presentation/VocabularyViewModel.kt` |
| Android Repository | `android/app/.../features/vocabulary/data/VocabularyRepository.kt` |

### B. 相关文档

- [iOS 客户端规格](../ios/client-spec.md)
- [Android 实现方案](../android/client-implementation-plan.md)
- [AI 缓存策略](../ai/cache-strategy.md)

---

*最后更新: 2025-12-28*

# 书架数据同步 V1: 本地同步

## 概述

V1 版本实现本地同步策略，游客数据仅本地存储，登录用户数据同步到服务器。

---

## 核心原则

| 用户类型 | 数据存储 | 同步行为 |
|---------|---------|---------|
| **游客** | 仅本地 | 不请求服务器 |
| **登录用户** | 云端 + 本地 | 同步到服务器 |

**关键点**:
- 游客数据仅保存本地，不请求服务器
- 登录用户新增数据同步到服务器
- 切换时展示合并后的数据 (local + remote)
- 切换到登录用户时，合并后的数据同步到服务器

---

## 场景处理

### 场景1: 游客 → 登录

```
┌─────────────────────────────────────────────────────────────────┐
│  游客本地数据              登录账户云端数据                        │
│       │                        │                                │
│       └──────────► 合并 ◄──────┘                                │
│                     │                                           │
│                     ▼                                           │
│              展示合并后的数据                                     │
│              (local + remote)                                   │
│                     │                                           │
│                     ▼                                           │
│              同步到服务器                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 场景2: 登录 → 退出 (变游客)

```
┌─────────────────────────────────────────────────────────────────┐
│  登录账户云端数据           游客本地数据                          │
│       │                        │                                │
│       └──────────► 合并 ◄──────┘                                │
│                     │                                           │
│                     ▼                                           │
│              展示合并后的数据                                     │
│              (local + remote 缓存)                              │
└─────────────────────────────────────────────────────────────────┘
```

### 场景3: 登录状态清空数据

```
┌─────────────────────────────────────────────────────────────────┐
│  登录状态                                                        │
│     │                                                           │
│  用户清空数据                                                     │
│     │                                                           │
│     ▼                                                           │
│  服务器数据被清空                                                 │
│     │                                                           │
│  切换到未登录                                                     │
│     │                                                           │
│     ▼                                                           │
│  展示游客本地数据 + 空的云端缓存 = 游客本地数据                     │
└─────────────────────────────────────────────────────────────────┘
```

### 场景4: 未登录状态清空数据

```
┌─────────────────────────────────────────────────────────────────┐
│  未登录状态 (游客)                                               │
│     │                                                           │
│  用户清空数据                                                     │
│     │                                                           │
│     ▼                                                           │
│  本地游客数据被清空 (不请求服务器)                                 │
│     │                                                           │
│  登录账户                                                        │
│     │                                                           │
│     ▼                                                           │
│  展示空的本地数据 + 云端数据 = 云端数据                            │
└─────────────────────────────────────────────────────────────────┘
```

### 场景5: 新增内容

| 用户类型 | 新增行为 |
|---------|---------|
| 游客 | 仅保存到本地 |
| 登录用户 | 同步到服务器 |

---

## 数据存储架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          本地存储                                │
├─────────────────────────────┬───────────────────────────────────┤
│       游客数据               │       登录用户云端缓存             │
├─────────────────────────────┼───────────────────────────────────┤
│  localBrowsingHistory       │  cloudBrowsingHistory             │
│  localReadingProgress       │  cloudReadingProgress             │
│  (收藏不支持)                │  cloudFavorites                   │
└─────────────────────────────┴───────────────────────────────────┘
                │                             │
                └──────────► 合并 ◄───────────┘
                              │
                              ▼
                      展示合并后的数据
```

---

## 合并策略

| 数据类型 | 合并方式 |
|---------|---------|
| 浏览历史 | 去重合并，按 browsedAt 排序 |
| 阅读进度 | 同一本书取 lastReadAt 较新的 |
| 收藏 | 仅云端 (游客不支持收藏) |

---

## 实现状态

| 数据类型 | 游客本地 | 登录云端 | 合并展示 | 状态 |
|---------|---------|---------|---------|------|
| 浏览历史 | ✓ | ✓ | ✓ | 已实现 |
| 阅读进度 | ✓ | ✓ | ✓ | 已实现 |
| 收藏 | ✗ | ✓ | - | 已实现 |

---

## 已完成清单

| 优先级 | 任务 | 说明 | 状态 |
|-------|------|------|------|
| P0 | 浏览历史合并展示 | local + cloud 合并后展示 | ✓ 已完成 |
| P0 | 阅读进度合并展示 | local + cloud 合并后展示 | ✓ 已完成 |
| P1 | 阅读进度云同步 | 登录用户的阅读进度同步到服务器 | ✓ 已完成 |

---

## 关键文件

| 文件 | 路径 |
|------|------|
| BrowsingHistoryManager | `ios/Readmigo/Core/Services/BrowsingHistoryManager.swift` |
| ReadingProgressStore | `ios/Readmigo/Core/Services/ReadingProgressStore.swift` |
| FavoritesManager | `ios/Readmigo/Core/Services/FavoritesManager.swift` |
| EnhancedReaderView | `ios/Readmigo/Features/Reader/EnhancedReaderView.swift` |
| AuthManager | `ios/Readmigo/Core/Auth/AuthManager.swift` |

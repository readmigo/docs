# Books 模块

> 书籍目录、元数据管理、章节内容

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────┐
│                       Books 模块                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心功能                                                   │
│  ├── 书籍列表 - 分页、筛选、搜索                           │
│  ├── 书籍详情 - 元数据、章节列表                           │
│  ├── 章节内容 - 获取章节、批量下载                         │
│  ├── 书内搜索 - 全文检索                                   │
│  └── 管理功能 - 创建/更新/发布                             │
│                                                             │
│  性能优化                                                   │
│  ├── Redis 缓存 - 书籍和章节 (1小时 TTL)                   │
│  └── 本地化支持 - Accept-Language 头                       │
│                                                             │
│  依赖模块                                                   │
│  ├── PrismaModule (数据库)                                 │
│  ├── RedisModule (缓存)                                    │
│  └── LogsModule (日志)                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型

### 2.1 书籍核心字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 书籍 ID |
| `title` | string | 书名 |
| `author` | string | 作者 |
| `description` | string | 简介 |
| `coverUrl` | string | 封面图片 |
| `language` | string | 语言代码 |
| `difficulty` | number | 难度分数 (0-100) |
| `wordCount` | number | 字数 |
| `source` | string | 来源平台 |
| `status` | enum | 发布状态 |

### 2.2 多语言支持

```
┌─────────────────────────────────────────────────────────────┐
│                    语言与难度体系                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  英语 (en)                                                 │
│  └── CEFR 等级: A1, A2, B1, B2, C1, C2                     │
│                                                             │
│  中文 (zh-Hans, zh-Hant)                                   │
│  ├── HSK 等级: 1-9                                         │
│  ├── 朝代分类: 先秦、汉、唐、宋...                         │
│  └── 拼音支持                                              │
│                                                             │
│  难度映射:                                                  │
│  ├── A1/HSK1-2:   0-20                                     │
│  ├── A2/HSK3:     20-35                                    │
│  ├── B1/HSK4-5:   35-50                                    │
│  ├── B2/HSK6:     50-65                                    │
│  ├── C1/HSK7-8:   65-80                                    │
│  └── C2/HSK9:     80-100                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 书籍来源

| 来源 | 说明 |
|------|------|
| `STANDARD_EBOOKS` | 高质量精排版 |
| `PROJECT_GUTENBERG` | 最大公版书库 |
| `INTERNET_ARCHIVE` | 互联网档案馆 |
| `CTEXT` | 中国哲学书电子化计划 |
| `WIKISOURCE_ZH` | 中文维基文库 |
| `USER_IMPORT` | 用户导入 |

---

## 3. API 端点

### 3.1 书籍列表与详情

| 方法 | 端点 | 说明 | 认证 |
|------|------|------|------|
| `GET` | `/books` | 书籍列表 | 否 |
| `GET` | `/books/:id` | 书籍详情 | 否 |
| `GET` | `/books/genres` | 获取所有类型 | 否 |
| `GET` | `/books/recommendations` | 个性化推荐 | 是 |

### 3.2 章节内容

| 方法 | 端点 | 说明 |
|------|------|------|
| `GET` | `/books/:id/content/:chapterId` | 获取章节内容 |
| `GET` | `/books/:id/chapters/batch` | 批量下载章节 |
| `GET` | `/books/:id/search` | 书内全文搜索 |

### 3.3 管理功能 (需认证)

| 方法 | 端点 | 说明 |
|------|------|------|
| `POST` | `/books` | 创建书籍 |
| `PATCH` | `/books/:id` | 更新书籍 |
| `POST` | `/books/:id/chapters` | 添加章节 |
| `POST` | `/books/:id/publish` | 发布书籍 |
| `POST` | `/books/:id/unpublish` | 下架书籍 |
| `POST` | `/books/import` | 导入书籍 |

---

## 4. 查询参数

### 4.1 BookListQueryDto

| 参数 | 类型 | 说明 |
|------|------|------|
| `page` | number | 页码 (默认 1) |
| `size` | number | 每页数量 (默认 20, 最大 100) |
| `language` | string | 语言筛选 (en, zh-Hans, zh-Hant) |
| `minDifficulty` | number | 最小难度 |
| `maxDifficulty` | number | 最大难度 |
| `genres` | string[] | 类型筛选 |
| `subjects` | string[] | 主题筛选 |
| `search` | string | 搜索关键词 |

### 4.2 移动端内容过滤

```
┌─────────────────────────────────────────────────────────────┐
│                    移动端内容过滤                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  iOS 客户端请求时:                                         │
│  - User-Agent 包含 "Readmigo" 且 "iOS"                     │
│  - 自动排除中文内容                                        │
│  - 原因: App Store 合规要求                                │
│                                                             │
│  Web/Android 请求时:                                       │
│  - 返回所有语言内容                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 缓存策略

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis 缓存策略                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  缓存键格式:                                               │
│  ├── book:{id}:{locale}        - 书籍详情                  │
│  ├── chapter:{bookId}:{chapterId} - 章节内容               │
│  ├── genres                     - 类型列表                 │
│  └── subjects                   - 主题列表                 │
│                                                             │
│  TTL 设置:                                                 │
│  └── 1 小时 (3600 秒)                                      │
│                                                             │
│  缓存流程:                                                 │
│  1. 检查 Redis 缓存                                        │
│  2. 命中 → 直接返回                                        │
│  3. 未命中 → 查询数据库 → 存入缓存 → 返回                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 章节数据结构

### 6.1 章节列表

| 字段 | 说明 |
|------|------|
| `id` | 章节 ID |
| `title` | 章节标题 |
| `order` | 排序序号 |
| `wordCount` | 章节字数 |

### 6.2 章节内容响应

| 字段 | 说明 |
|------|------|
| `id` | 章节 ID |
| `title` | 章节标题 |
| `content` | HTML 内容 |
| `prevChapterId` | 上一章 ID |
| `nextChapterId` | 下一章 ID |
| `progress` | 在书中的位置百分比 |

---

## 7. 书内搜索

```
┌─────────────────────────────────────────────────────────────┐
│                    书内搜索功能                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  请求:                                                      │
│  GET /books/:id/search?q=keyword&contextLength=100         │
│                                                             │
│  处理流程:                                                  │
│  1. 获取书籍所有章节                                       │
│  2. 遍历章节内容搜索关键词                                 │
│  3. 提取匹配位置的上下文                                   │
│  4. 返回匹配结果列表                                       │
│                                                             │
│  响应:                                                      │
│  {                                                          │
│    "results": [                                            │
│      {                                                      │
│        "chapterId": "xxx",                                 │
│        "chapterTitle": "Chapter 1",                        │
│        "context": "...keyword...",                         │
│        "position": 1234                                    │
│      }                                                      │
│    ],                                                       │
│    "totalMatches": 15                                      │
│  }                                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 批量下载

### 8.1 请求参数

| 参数 | 类型 | 说明 |
|------|------|------|
| `startChapter` | number | 起始章节序号 |
| `endChapter` | number | 结束章节序号 |
| `chapterIds` | string[] | 指定章节 ID 列表 |

### 8.2 使用场景

```
┌─────────────────────────────────────────────────────────────┐
│                    批量下载场景                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  离线阅读准备:                                             │
│  - 用户选择下载书籍                                        │
│  - 客户端调用批量接口                                      │
│  - 一次获取多章节内容                                      │
│  - 存储到本地数据库                                        │
│                                                             │
│  优化效果:                                                  │
│  - 减少网络请求次数                                        │
│  - 提高下载效率                                            │
│  - 支持后台下载                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. 本地化支持

### 9.1 Accept-Language 处理

| Header 值 | 返回语言 |
|-----------|----------|
| `zh-Hans` | 简体中文 |
| `zh-Hant` | 繁体中文 |
| `en` / 其他 | 英文 (默认) |

### 9.2 本地化内容

| 字段 | 说明 |
|------|------|
| `title` | 书名 (可能有翻译版) |
| `description` | 简介 (可能有翻译版) |
| `authorName` | 作者名 (可能有翻译版) |

---

## 10. 实现位置

| 组件 | 路径 |
|------|------|
| **模块** | `apps/backend/src/modules/books/books.module.ts` |
| **服务** | `apps/backend/src/modules/books/books.service.ts` |
| **控制器** | `apps/backend/src/modules/books/books.controller.ts` |
| **DTO** | `apps/backend/src/modules/books/dto/` |

---

## 11. 相关文档

| 文档 | 说明 |
|------|------|
| [sources/README.md](../sources/) | 数据来源概览 |
| [content/classification-system.md](../content/classification-system.md) | 分类系统 |
| [modules/recommendation.md](recommendation.md) | 推荐算法 |
| [reader/README.md](../reader/) | 阅读器模块 |

---

*最后更新: 2025-12-31*

# i18n æ¨¡å—

> å›½é™…åŒ–ç³»ç»Ÿ - è·¨å¹³å°ç»Ÿä¸€æ–‡æ¡£

---

## 1. æ¦‚è¿°

### 1.1 åŠŸèƒ½èŒƒå›´

| åŠŸèƒ½ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å¤šè¯­è¨€ç•Œé¢ | UI æ–‡æœ¬æœ¬åœ°åŒ– | P0 |
| è¯­è¨€åˆ‡æ¢ | è¿è¡Œæ—¶è¯­è¨€åˆ‡æ¢ | P0 |
| æ—¥æœŸæœ¬åœ°åŒ– | æ—¥æœŸ/æ—¶é—´æ ¼å¼åŒ– | P0 |
| æ•°å­—æ ¼å¼åŒ– | æ•°å­—/è´§å¸/ç™¾åˆ†æ¯” | P1 |
| å¤æ•°è§„åˆ™ | å¤æ•°å½¢å¼å¤„ç† | P1 |
| RTL æ”¯æŒ | ä»å³åˆ°å·¦è¯­è¨€ | P2 |

### 1.2 æ”¯æŒè¯­è¨€

| è¯­è¨€ | ä»£ç  | åç§° | æ ‡è¯† |
|------|------|------|------|
| ç®€ä½“ä¸­æ–‡ | `zh-CN` | ç®€ä½“ä¸­æ–‡ | ğŸ‡¨ğŸ‡³ |
| ç¹ä½“ä¸­æ–‡ | `zh-TW` | ç¹é«”ä¸­æ–‡ | ğŸ‡¹ğŸ‡¼ |
| è‹±è¯­ | `en` | English | ğŸ‡ºğŸ‡¸ |
| æ—¥è¯­ | `ja` | æ—¥æœ¬èª | ğŸ‡¯ğŸ‡µ |
| éŸ©è¯­ | `ko` | í•œêµ­ì–´ | ğŸ‡°ğŸ‡· |

### 1.3 å¹³å°å®ç°å¯¹æ¯”

| åŠŸèƒ½ | Android | React Native | Web |
|------|---------|--------------|-----|
| æ¡†æ¶ | Android Resources | i18next | next-intl |
| ç¿»è¯‘æ–‡ä»¶ | strings.xml | JSON | JSON |
| è¯­è¨€æ£€æµ‹ | Locale.getDefault() | expo-localization | Accept-Language |
| æ—¥æœŸæ ¼å¼ | SimpleDateFormat | date-fns | Intl.DateTimeFormat |
| å¤æ•°å¤„ç† | quantity strings | i18next-icu | ICU MessageFormat |
| å­˜å‚¨ | DataStore | AsyncStorage | Cookie |

---

## 2. æ•°æ®æ¨¡å‹

```typescript
// æ”¯æŒçš„è¯­è¨€
type SupportedLanguage = 'zh-CN' | 'zh-TW' | 'en' | 'ja' | 'ko';

// è¯­è¨€é…ç½®
interface LanguageConfig {
  code: SupportedLanguage;
  name: string;                      // æœ¬åœ°åŒ–åç§°
  englishName: string;               // è‹±æ–‡åç§°
  flag: string;                      // å›½æ—— emoji
  isRTL: boolean;                    // æ˜¯å¦ RTL è¯­è¨€
  dateFormat: string;                // æ—¥æœŸæ ¼å¼
  timeFormat: string;                // æ—¶é—´æ ¼å¼
}

// ç¿»è¯‘å‘½åç©ºé—´
type TranslationNamespace =
  | 'common'           // é€šç”¨æ–‡æœ¬
  | 'auth'             // è®¤è¯ç›¸å…³
  | 'reader'           // é˜…è¯»å™¨
  | 'library'          // ä¹¦æ¶
  | 'settings'         // è®¾ç½®
  | 'learning'         // å­¦ä¹ 
  | 'errors';          // é”™è¯¯æ¶ˆæ¯

// æ ¼å¼åŒ–é€‰é¡¹
interface FormatOptions {
  date?: Intl.DateTimeFormatOptions;
  number?: Intl.NumberFormatOptions;
  currency?: {
    currency: string;
    style?: 'currency' | 'decimal';
  };
}
```

### è¯­è¨€é…ç½®

```typescript
const SUPPORTED_LANGUAGES: Record<SupportedLanguage, LanguageConfig> = {
  'zh-CN': {
    code: 'zh-CN',
    name: 'ç®€ä½“ä¸­æ–‡',
    englishName: 'Simplified Chinese',
    flag: 'ğŸ‡¨ğŸ‡³',
    isRTL: false,
    dateFormat: 'yyyyå¹´Mæœˆdæ—¥',
    timeFormat: 'HH:mm',
  },
  'zh-TW': {
    code: 'zh-TW',
    name: 'ç¹é«”ä¸­æ–‡',
    englishName: 'Traditional Chinese',
    flag: 'ğŸ‡¹ğŸ‡¼',
    isRTL: false,
    dateFormat: 'yyyyå¹´Mæœˆdæ—¥',
    timeFormat: 'HH:mm',
  },
  'en': {
    code: 'en',
    name: 'English',
    englishName: 'English',
    flag: 'ğŸ‡ºğŸ‡¸',
    isRTL: false,
    dateFormat: 'MMM d, yyyy',
    timeFormat: 'h:mm a',
  },
  'ja': {
    code: 'ja',
    name: 'æ—¥æœ¬èª',
    englishName: 'Japanese',
    flag: 'ğŸ‡¯ğŸ‡µ',
    isRTL: false,
    dateFormat: 'yyyyå¹´Mæœˆdæ—¥',
    timeFormat: 'HH:mm',
  },
  'ko': {
    code: 'ko',
    name: 'í•œêµ­ì–´',
    englishName: 'Korean',
    flag: 'ğŸ‡°ğŸ‡·',
    isRTL: false,
    dateFormat: 'yyyyë…„ Mì›” dì¼',
    timeFormat: 'a h:mm',
  },
};

const DEFAULT_LANGUAGE: SupportedLanguage = 'zh-CN';
const FALLBACK_LANGUAGE: SupportedLanguage = 'en';
```

---

## 3. ç¿»è¯‘èµ„æºç»“æ„

### ç›®å½•ç»“æ„

```
locales/
â”œâ”€â”€ zh-CN/
â”‚   â”œâ”€â”€ common.json
â”‚   â”œâ”€â”€ auth.json
â”‚   â”œâ”€â”€ reader.json
â”‚   â”œâ”€â”€ library.json
â”‚   â”œâ”€â”€ settings.json
â”‚   â”œâ”€â”€ learning.json
â”‚   â””â”€â”€ errors.json
â”œâ”€â”€ zh-TW/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ en/
â”‚   â””â”€â”€ ...
â””â”€â”€ ja/
    â””â”€â”€ ...
```

### ç¿»è¯‘æ–‡ä»¶ç¤ºä¾‹

**common.json (zh-CN)**:
```json
{
  "app": {
    "name": "Readmigo",
    "tagline": "æ™ºèƒ½è‹±è¯­é˜…è¯»åŠ©æ‰‹"
  },
  "actions": {
    "confirm": "ç¡®è®¤",
    "cancel": "å–æ¶ˆ",
    "save": "ä¿å­˜",
    "delete": "åˆ é™¤",
    "edit": "ç¼–è¾‘",
    "done": "å®Œæˆ",
    "next": "ä¸‹ä¸€æ­¥",
    "back": "è¿”å›",
    "retry": "é‡è¯•",
    "loading": "åŠ è½½ä¸­...",
    "search": "æœç´¢"
  },
  "time": {
    "now": "åˆšåˆš",
    "minutesAgo": "{{count}} åˆ†é’Ÿå‰",
    "hoursAgo": "{{count}} å°æ—¶å‰",
    "daysAgo": "{{count}} å¤©å‰",
    "today": "ä»Šå¤©",
    "yesterday": "æ˜¨å¤©"
  }
}
```

**common.json (en)**:
```json
{
  "app": {
    "name": "Readmigo",
    "tagline": "Smart English Reading Assistant"
  },
  "actions": {
    "confirm": "Confirm",
    "cancel": "Cancel",
    "save": "Save",
    "delete": "Delete",
    "edit": "Edit",
    "done": "Done",
    "next": "Next",
    "back": "Back",
    "retry": "Retry",
    "loading": "Loading...",
    "search": "Search"
  },
  "time": {
    "now": "Just now",
    "minutesAgo_one": "{{count}} minute ago",
    "minutesAgo_other": "{{count}} minutes ago",
    "hoursAgo_one": "{{count}} hour ago",
    "hoursAgo_other": "{{count}} hours ago",
    "daysAgo_one": "{{count}} day ago",
    "daysAgo_other": "{{count}} days ago",
    "today": "Today",
    "yesterday": "Yesterday"
  }
}
```

### Key å‘½åè§„èŒƒ

é‡‡ç”¨ç‚¹åˆ†éš”çš„å±‚çº§ç»“æ„ï¼š`{namespace}.{section}.{key}`

| Key | è‹±æ–‡ | ä¸­æ–‡ |
|-----|------|------|
| `common.actions.confirm` | Confirm | ç¡®è®¤ |
| `common.actions.cancel` | Cancel | å–æ¶ˆ |
| `auth.login.title` | Log in | ç™»å½• |
| `reader.settings.fontSize` | Font Size | å­—å· |
| `library.empty.title` | Your library is empty | ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ |
| `errors.network` | Network error | ç½‘ç»œé”™è¯¯ |

---

## 4. Android å®ç°

### 4.1 LocalizationManager

```kotlin
@Singleton
class LocalizationManager @Inject constructor(
    @ApplicationContext private val context: Context,
    private val userPreferences: DataStore<Preferences>
) {
    companion object {
        private val LANGUAGE_KEY = stringPreferencesKey("selected_language")

        val SUPPORTED_LANGUAGES = listOf(
            Language("en", "English"),
            Language("zh-CN", "ç®€ä½“ä¸­æ–‡"),
            Language("zh-TW", "ç¹é«”ä¸­æ–‡")
        )
    }

    data class Language(
        val code: String,
        val displayName: String
    )

    val currentLanguage: Flow<String> = userPreferences.data.map { preferences ->
        preferences[LANGUAGE_KEY] ?: Locale.getDefault().toLanguageTag()
    }

    suspend fun setLanguage(languageCode: String) {
        userPreferences.edit { preferences ->
            preferences[LANGUAGE_KEY] = languageCode
        }
    }

    fun getLocalizedContext(baseContext: Context, languageCode: String): Context {
        val locale = when (languageCode) {
            "zh-CN" -> Locale.SIMPLIFIED_CHINESE
            "zh-TW" -> Locale.TRADITIONAL_CHINESE
            else -> Locale.ENGLISH
        }

        val config = Configuration(baseContext.resources.configuration).apply {
            setLocale(locale)
        }

        return baseContext.createConfigurationContext(config)
    }
}
```

### 4.2 ä½¿ç”¨æ–¹å¼

```kotlin
// Composable ä¸­ä½¿ç”¨
Text(text = stringResource(R.string.reader_settings_title))

// å¸¦å‚æ•°
Text(text = stringResource(R.string.reader_progress, currentChapter, totalChapters))

// é Composable ä¸­ä½¿ç”¨
val title = context.getString(R.string.reader_settings_title)

// å¤æ•°å½¢å¼
val text = pluralStringResource(R.plurals.library_book_count, bookCount, bookCount)
```

### 4.3 strings.xml ç»“æ„

```xml
<!-- values/strings.xml (English) -->
<resources>
    <string name="reader_settings_title">Settings</string>
    <string name="reader_settings_speed">Speed</string>
    <string name="common_cancel">Cancel</string>

    <plurals name="library_book_count">
        <item quantity="one">%d book</item>
        <item quantity="other">%d books</item>
    </plurals>
</resources>

<!-- values-zh-rCN/strings.xml (ç®€ä½“ä¸­æ–‡) -->
<resources>
    <string name="reader_settings_title">è®¾ç½®</string>
    <string name="reader_settings_speed">è¯­é€Ÿ</string>
    <string name="common_cancel">å–æ¶ˆ</string>

    <plurals name="library_book_count">
        <item quantity="other">%d æœ¬ä¹¦</item>
    </plurals>
</resources>
```

---

## 5. React Native å®ç°

### 5.1 i18next é…ç½®

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as Localization from 'expo-localization';
import AsyncStorage from '@react-native-async-storage/async-storage';

const LANGUAGE_STORAGE_KEY = 'user_language';

async function getInitialLanguage(): Promise<string> {
  // 1. æ£€æŸ¥ç”¨æˆ·ä¿å­˜çš„è¯­è¨€åå¥½
  const savedLanguage = await AsyncStorage.getItem(LANGUAGE_STORAGE_KEY);
  if (savedLanguage && savedLanguage in SUPPORTED_LANGUAGES) {
    return savedLanguage;
  }

  // 2. ä½¿ç”¨ç³»ç»Ÿè¯­è¨€
  const systemLocale = Localization.locale;
  const languageCode = systemLocale.split('-')[0];

  if (languageCode === 'zh') {
    return systemLocale.includes('TW') || systemLocale.includes('HK')
      ? 'zh-TW'
      : 'zh-CN';
  }

  // 3. ä½¿ç”¨é»˜è®¤è¯­è¨€
  return DEFAULT_LANGUAGE;
}

export async function initializeI18n(): Promise<void> {
  const initialLanguage = await getInitialLanguage();

  await i18n
    .use(initReactI18next)
    .init({
      resources,
      lng: initialLanguage,
      fallbackLng: FALLBACK_LANGUAGE,
      defaultNS: 'common',
      ns: ['common', 'auth', 'reader', 'library', 'settings', 'learning', 'errors'],
      interpolation: { escapeValue: false },
      react: { useSuspense: false },
    });
}

export async function changeLanguage(language: SupportedLanguage): Promise<void> {
  await i18n.changeLanguage(language);
  await AsyncStorage.setItem(LANGUAGE_STORAGE_KEY, language);
}
```

### 5.2 useI18n Hook

```typescript
import { useTranslation } from 'react-i18next';
import { format as formatDate, formatDistanceToNow } from 'date-fns';
import { zhCN, zhTW, enUS, ja } from 'date-fns/locale';

const DATE_FNS_LOCALES = {
  'zh-CN': zhCN,
  'zh-TW': zhTW,
  'en': enUS,
  'ja': ja,
};

export function useI18n(ns: TranslationNamespace = 'common') {
  const { t, i18n } = useTranslation(ns);
  const currentLanguage = i18n.language as SupportedLanguage;
  const languageConfig = SUPPORTED_LANGUAGES[currentLanguage];

  const formatLocalDate = useCallback((
    date: Date | number,
    formatStr?: string
  ): string => {
    const locale = DATE_FNS_LOCALES[currentLanguage];
    return formatDate(date, formatStr || languageConfig.dateFormat, { locale });
  }, [currentLanguage]);

  const formatNumber = useCallback((
    value: number,
    options?: Intl.NumberFormatOptions
  ): string => {
    return new Intl.NumberFormat(currentLanguage, options).format(value);
  }, [currentLanguage]);

  const formatCurrency = useCallback((
    value: number,
    currency: string = 'CNY'
  ): string => {
    return new Intl.NumberFormat(currentLanguage, {
      style: 'currency',
      currency,
    }).format(value);
  }, [currentLanguage]);

  return {
    t,
    currentLanguage,
    languageConfig,
    formatDate: formatLocalDate,
    formatNumber,
    formatCurrency,
    setLanguage: changeLanguage,
  };
}
```

### 5.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
import { useI18n } from '@/features/i18n';

function BookCard({ book }) {
  const { t, formatDate, formatNumber } = useI18n('library');

  return (
    <View>
      <Text>{book.title}</Text>
      <Text>
        {t('progress.percentage', { percentage: formatNumber(book.progress * 100) })}
      </Text>
      <Text>{formatDate(book.lastReadAt)}</Text>
    </View>
  );
}
```

---

## 6. Web å®ç°

### 6.1 next-intl é…ç½®

```typescript
// src/features/i18n/lib/i18n.ts
import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';

const locales = ['en', 'zh-CN', 'zh-TW', 'ja', 'ko'];

export default getRequestConfig(async ({ locale }) => {
  if (!locales.includes(locale)) {
    notFound();
  }

  return {
    messages: (await import(`../messages/${locale}.json`)).default,
    timeZone: 'Asia/Shanghai',
    now: new Date(),
  };
});
```

```typescript
// middleware.ts
import createMiddleware from 'next-intl/middleware';

export default createMiddleware({
  locales: ['en', 'zh-CN', 'zh-TW', 'ja', 'ko'],
  localePrefix: 'as-needed',
  defaultLocale: 'zh-CN',
});

export const config = {
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)'],
};
```

### 6.2 useLocale Hook

```typescript
'use client';

import { useLocale as useNextIntlLocale, useTranslations } from 'next-intl';
import { useRouter, usePathname } from '@/features/i18n/lib/navigation';

export function useLocale() {
  const locale = useNextIntlLocale() as Locale;
  const router = useRouter();
  const pathname = usePathname();

  const currentLocale = LOCALES.find((l) => l.code === locale);

  const changeLocale = useCallback((newLocale: Locale) => {
    router.replace(pathname, { locale: newLocale });
  }, [router, pathname]);

  return {
    locale,
    locales: LOCALES,
    currentLocale,
    changeLocale,
    isDefault: locale === DEFAULT_LOCALE,
  };
}
```

### 6.3 ä½¿ç”¨ç¤ºä¾‹

```tsx
import { useTranslations } from 'next-intl';
import { useLocale } from '@/features/i18n';

function Header() {
  const t = useTranslations('common');
  const { locale, changeLocale } = useLocale();

  return (
    <header>
      <button>{t('actions.search')}</button>
      <LanguageSwitcher />
    </header>
  );
}
```

---

## 7. UI ç»„ä»¶

### è¯­è¨€é€‰æ‹©å™¨ (React Native)

```typescript
export function LanguageSelector({ onSelect }: Props) {
  const { currentLanguage, supportedLanguages, setLanguage, t } = useI18n('settings');

  const handleSelect = async (language: SupportedLanguage) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    await setLanguage(language);
    onSelect?.(language);
  };

  return (
    <View style={styles.container}>
      <Text style={styles.title}>{t('language.title')}</Text>
      {Object.values(supportedLanguages).map((lang) => (
        <Pressable
          key={lang.code}
          style={[styles.item, lang.code === currentLanguage && styles.itemSelected]}
          onPress={() => handleSelect(lang.code)}
        >
          <Text style={styles.flag}>{lang.flag}</Text>
          <Text style={styles.name}>{lang.name}</Text>
          {lang.code === currentLanguage && (
            <Ionicons name="checkmark" size={20} color="#2D5A7B" />
          )}
        </Pressable>
      ))}
    </View>
  );
}
```

### è¯­è¨€é€‰æ‹©å™¨ (Web)

```tsx
export function LanguageSwitcher() {
  const { locale, locales, changeLocale } = useLocale();

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" className="gap-2">
          <Globe className="w-4 h-4" />
          <span>{locales.find(l => l.code === locale)?.nativeName}</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent>
        {locales.map((l) => (
          <DropdownMenuItem key={l.code} onClick={() => changeLocale(l.code)}>
            <span>{l.flag}</span>
            <span>{l.nativeName}</span>
            {locale === l.code && <Check className="w-4 h-4 ml-auto" />}
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

---

## 8. æ ¼å¼åŒ–ç»„ä»¶

```tsx
// æ—¥æœŸæ ¼å¼åŒ–
export function FormattedDate({ date, format = 'medium' }: Props) {
  const formatter = useFormatter();
  return <>{formatter.dateTime(new Date(date), { dateStyle: format })}</>;
}

// ç›¸å¯¹æ—¶é—´
export function RelativeTime({ date }: { date: Date }) {
  const t = useTranslations('time');
  const diffMins = Math.floor((Date.now() - date.getTime()) / 60000);

  if (diffMins < 1) return <>{t('justNow')}</>;
  if (diffMins < 60) return <>{t('minutesAgo', { count: diffMins })}</>;
  // ...
}

// æ•°å­—æ ¼å¼åŒ–
export function FormattedNumber({ value, style = 'decimal', currency = 'CNY' }: Props) {
  const formatter = useFormatter();
  return <>{formatter.number(value, style === 'currency' ? { style, currency } : { style })}</>;
}
```

---

## 9. API Accept-Language Header

```kotlin
// Android
class AcceptLanguageInterceptor @Inject constructor(
    private val localizationManager: LocalizationManager
) : Interceptor {
    override fun intercept(chain: Interceptor.Chain): Response {
        val languageCode = runBlocking {
            localizationManager.currentLanguage.first()
        }

        val acceptLanguage = when (languageCode) {
            "zh-CN" -> "zh-Hans,zh;q=0.9,en;q=0.8"
            "zh-TW" -> "zh-Hant,zh;q=0.9,en;q=0.8"
            else -> "en,zh-Hans;q=0.9,zh-Hant;q=0.8"
        }

        val request = chain.request().newBuilder()
            .header("Accept-Language", acceptLanguage)
            .build()

        return chain.proceed(request)
    }
}
```

---

## 10. æµ‹è¯•

```typescript
describe('i18n', () => {
  beforeAll(async () => {
    await initializeI18n();
  });

  test('should translate common keys', () => {
    expect(i18n.t('common:actions.confirm')).toBe('ç¡®è®¤');
  });

  test('should handle pluralization', () => {
    i18n.changeLanguage('en');
    expect(i18n.t('common:units.book', { count: 1 })).toBe('book');
    expect(i18n.t('common:units.book', { count: 2 })).toBe('books');
  });

  test('should change language', async () => {
    await i18n.changeLanguage('en');
    expect(i18n.t('common:actions.confirm')).toBe('Confirm');
  });
});
```

---

## 11. å¯¼å‡º

```typescript
// src/features/i18n/index.ts
export { I18nProvider } from './components/I18nProvider';
export { LanguageSelector } from './components/LanguageSelector';

export { useI18n, useTranslate } from './hooks/useI18n';

export { initializeI18n, changeLanguage, getCurrentLanguage } from './config/i18n';
export { SUPPORTED_LANGUAGES, DEFAULT_LANGUAGE, FALLBACK_LANGUAGE } from './config/languages';

export type { SupportedLanguage, LanguageConfig, TranslationNamespace } from './types';
```

---

*æœ€åæ›´æ–°: 2025-12-28*

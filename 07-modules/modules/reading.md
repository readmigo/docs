# Reading 模块

> 阅读会话、进度跟踪、统计分析

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────┐
│                      Reading 模块                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心功能                                                   │
│  ├── 书架管理 - 添加/移除/状态更新                         │
│  ├── 进度跟踪 - 章节、位置、百分比                         │
│  ├── 会话记录 - 阅读时长、页数、查词数                     │
│  ├── 统计分析 - 日/周/月统计、时间分布                     │
│  └── 离线同步 - 离线数据上传                               │
│                                                             │
│  依赖模块                                                   │
│  ├── PrismaModule (数据库)                                 │
│  ├── UsersModule (用户)                                    │
│  ├── MedalsModule (勋章触发)                               │
│  └── RecommendationModule (书籍统计)                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型

### 2.1 阅读状态枚举

| 状态 | 说明 |
|------|------|
| `WANT_TO_READ` | 想读 |
| `READING` | 在读 |
| `FINISHED` | 已读完 |
| `ABANDONED` | 已放弃 |

### 2.2 核心数据结构

```
┌─────────────────────────────────────────────────────────────┐
│                      数据关系                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  User                                                       │
│   │                                                         │
│   ├── UserBook (书架)                                       │
│   │    ├── bookId                                          │
│   │    ├── status (阅读状态)                               │
│   │    ├── currentChapter                                  │
│   │    ├── currentPosition                                 │
│   │    └── progress (百分比)                               │
│   │                                                         │
│   └── ReadingSession (会话)                                │
│        ├── bookId                                          │
│        ├── duration (分钟)                                 │
│        ├── pagesRead                                       │
│        └── wordsLookedUp                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. API 端点

### 3.1 书架管理

| 方法 | 端点 | 说明 |
|------|------|------|
| `GET` | `/reading/library` | 获取用户书架 |
| `POST` | `/reading/library` | 添加书籍到书架 |
| `DELETE` | `/reading/library/:bookId` | 从书架移除 |
| `PATCH` | `/reading/library/:bookId/status` | 更新阅读状态 |

### 3.2 进度与会话

| 方法 | 端点 | 说明 |
|------|------|------|
| `PATCH` | `/reading/progress/:bookId` | 更新阅读进度 |
| `POST` | `/reading/sessions` | 创建阅读会话 |
| `GET` | `/reading/current` | 获取当前阅读书籍 |
| `GET` | `/reading/sessions/history` | 会话历史 |

### 3.3 统计分析

| 方法 | 端点 | 说明 |
|------|------|------|
| `GET` | `/reading/stats` | 综合统计 |
| `GET` | `/reading/stats/today` | 今日详细统计 |
| `GET` | `/reading/stats/weekly` | 周统计 |
| `GET` | `/reading/stats/monthly` | 月统计 |
| `GET` | `/reading/stats/time-distribution` | 时间分布分析 |

### 3.4 离线同步

| 方法 | 端点 | 说明 |
|------|------|------|
| `POST` | `/reading/offline/sync` | 同步离线数据 |

---

## 4. 核心功能流程

### 4.1 阅读会话流程

```
┌─────────────────────────────────────────────────────────────┐
│                    阅读会话流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户开始阅读                                               │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────┐                                           │
│  │ 创建会话    │                                           │
│  │ POST /sessions                                          │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ├────────────────────────────────────┐              │
│         │                                    │              │
│         ▼                                    ▼              │
│  ┌─────────────┐                    ┌─────────────┐        │
│  │ 更新日统计  │                    │ 触发勋章检查│        │
│  │ (异步)      │                    │ (异步)      │        │
│  └─────────────┘                    └─────────────┘        │
│                                                             │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │ 更新书籍统计│                                           │
│  │ (Recommendation)                                        │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 连续阅读天数计算

```
┌─────────────────────────────────────────────────────────────┐
│                    Streak 计算逻辑                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 获取用户所有阅读日期 (去重)                            │
│  2. 从今天开始倒序遍历                                     │
│  3. 检查每天是否有阅读记录                                 │
│  4. 连续天数累加，断开则停止                               │
│                                                             │
│  示例:                                                      │
│  ┌───┬───┬───┬───┬───┬───┬───┐                            │
│  │ 今│ 昨│ 前│ 大│ 大│ 大│ 大│                            │
│  │ 天│ 天│ 天│前天│前天│前天│前天│                            │
│  ├───┼───┼───┼───┼───┼───┼───┤                            │
│  │ ✓ │ ✓ │ ✓ │ ✗ │ ✓ │ ✓ │ ✓ │                            │
│  └───┴───┴───┴───┴───┴───┴───┘                            │
│       Streak = 3 天                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 统计数据结构

### 5.1 综合统计 (ReadingStatsDto)

| 字段 | 类型 | 说明 |
|------|------|------|
| `totalMinutes` | number | 总阅读分钟数 |
| `streak` | number | 连续阅读天数 |
| `booksRead` | number | 已读完书籍数 |
| `wordsLearned` | number | 学习词汇数 |

### 5.2 周统计 (WeeklyStatsDto)

| 字段 | 类型 | 说明 |
|------|------|------|
| `weekStart` | Date | 周起始日期 |
| `totalMinutes` | number | 周总分钟数 |
| `averageDaily` | number | 日均分钟数 |
| `dailyBreakdown` | array | 每日详情 |

### 5.3 时间分布 (TimeDistributionDto)

| 时段 | 时间范围 |
|------|----------|
| `morning` | 05:00-12:00 |
| `afternoon` | 12:00-18:00 |
| `evening` | 18:00-22:00 |
| `night` | 22:00-05:00 |

---

## 6. 模块交互

### 6.1 与推荐模块交互

```
Reading Module                    Recommendation Module
      │                                    │
      │  addToLibrary()                    │
      ├──────────────────────────────────→ │
      │                 incrementBookshelf()
      │                                    │
      │  createSession()                   │
      ├──────────────────────────────────→ │
      │                 addReadingMinutes()
      │                                    │
      │  updateProgress() (完成时)          │
      ├──────────────────────────────────→ │
      │                 incrementReadComplete()
      │                                    │
```

### 6.2 与勋章模块交互

| 触发时机 | 检查类型 |
|----------|----------|
| 创建会话后 | 阅读时长勋章 |
| 完成书籍后 | 完读数量勋章 |
| 更新进度后 | 连续阅读勋章 |

---

## 7. 实现位置

| 组件 | 路径 |
|------|------|
| **模块** | `apps/backend/src/modules/reading/reading.module.ts` |
| **服务** | `apps/backend/src/modules/reading/reading.service.ts` |
| **控制器** | `apps/backend/src/modules/reading/reading.controller.ts` |
| **DTO** | `apps/backend/src/modules/reading/dto/` |

---

## 8. 相关文档

| 文档 | 说明 |
|------|------|
| [infrastructure/reading-duration-system.md](../infrastructure/reading-duration-system.md) | 阅读时长统计系统 |
| [modules/medals.md](medals.md) | 勋章系统 |
| [modules/recommendation.md](recommendation.md) | 推荐算法 |

---

*最后更新: 2025-12-31*

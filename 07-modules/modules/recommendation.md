# Recommendation 模块

> 书籍推荐算法、发现页、相关书籍

---

## 1. 模块概述

```
┌─────────────────────────────────────────────────────────────┐
│                   Recommendation 模块                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心功能                                                   │
│  ├── 发现页 - 分类浏览、排序筛选                           │
│  ├── 首页推荐 - 个性化推荐列表                             │
│  ├── 相关书籍 - 类似难度/分类                              │
│  └── 动态标签 - 发现页 Tab 配置                            │
│                                                             │
│  推荐算法                                                   │
│  ├── 质量分数 (35%)                                        │
│  ├── 热度分数 (50%)                                        │
│  └── 新鲜度分数 (15%)                                      │
│                                                             │
│  依赖模块                                                   │
│  ├── PrismaModule (数据库)                                 │
│  └── RedisModule (缓存)                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 推荐算法

### 2.1 评分权重

```
┌─────────────────────────────────────────────────────────────┐
│                    推荐评分公式                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Final Score = Quality×0.35 + Popularity×0.50 + Fresh×0.15 │
│                                                             │
│  所有分数归一化到 0-1 范围                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 质量分数 (35%)

| 维度 | 权重 | 说明 |
|------|------|------|
| 经典程度 | 30% | 是否为文学经典 |
| 获奖情况 | 20% | 是否获得文学奖 |
| 编辑评分 | 25% | 人工评分 (0-5) |
| 完读率 | 15% | 读者完成比例 |
| 阅读深度 | 10% | 平均阅读时长/总时长 |

### 2.3 热度分数 (50%)

```
┌─────────────────────────────────────────────────────────────┐
│                    热度分数计算                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  原始指标 (Log 归一化):                                    │
│  ├── 浏览量 - log(views + 1)                               │
│  ├── 收藏量 - log(shelves + 1)                             │
│  ├── 阅读量 - log(reads + 1)                               │
│  ├── 互动量 - log(highlights + notes + ai_uses + 1)        │
│  └── 增长趋势 - 7日/30日增长比                             │
│                                                             │
│  权重分配:                                                  │
│  ├── 浏览量: 15%                                           │
│  ├── 收藏量: 25%                                           │
│  ├── 阅读量: 30%                                           │
│  ├── 互动量: 20%                                           │
│  └── 增长趋势: 10%                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 新鲜度分数 (15%)

```
┌─────────────────────────────────────────────────────────────┐
│                    新鲜度衰减曲线                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Score                                                      │
│    │                                                        │
│  1.0├──●                                                   │
│    │    ╲                                                   │
│  0.5├─────●──────                                          │
│    │          ╲                                             │
│  0.1├───────────●────────────────                          │
│    │                                                        │
│    └───┬───────┬───────────────┬───→ Days                  │
│        0      30              90                            │
│                                                             │
│  计算公式:                                                  │
│  - Day 0-30:  线性衰减 1.0 → 0.5                           │
│  - Day 30-90: 线性衰减 0.5 → 0.1                           │
│  - Day 90+:   固定 0.1                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 服务架构

### 3.1 服务组件

```
┌─────────────────────────────────────────────────────────────┐
│                    服务组件结构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  RecommendationService (主服务)                            │
│       │                                                     │
│       ├── getDiscoverBooks()   - 发现页书籍                │
│       ├── getHomeRecommendations() - 首页推荐              │
│       ├── getRelatedBooks()    - 相关书籍                  │
│       └── getDiscoverTabs()    - 动态标签                  │
│                                                             │
│  BookStatsService (统计服务)                               │
│       │                                                     │
│       ├── incrementView()      - 浏览量+1                  │
│       ├── incrementBookshelf() - 收藏量+1                  │
│       ├── incrementReadStart() - 开读量+1                  │
│       ├── incrementReadComplete() - 完读量+1               │
│       ├── addReadingMinutes()  - 累加阅读时长              │
│       └── incrementHighlight() - 互动量+1                  │
│                                                             │
│  BookScoreService (评分服务)                               │
│       │                                                     │
│       ├── updateBookScore()    - 更新单本评分              │
│       ├── updateAllBookScores() - 批量更新评分             │
│       └── getBookScore()       - 获取评分                  │
│                                                             │
│  ScoreCalculator (评分计算器)                              │
│       │                                                     │
│       ├── calculateQualityScore()    - 质量分              │
│       ├── calculatePopularityScore() - 热度分              │
│       ├── calculateFreshnessScore()  - 新鲜度分            │
│       └── calculateAllScores()       - 综合分              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. API 端点

### 4.1 发现页

| 方法 | 端点 | 说明 | 认证 |
|------|------|------|------|
| `GET` | `/recommendation/discover/tabs` | 获取动态标签 | 否 |
| `GET` | `/recommendation/discover` | 发现页书籍列表 | 否 |

### 4.2 个性化推荐

| 方法 | 端点 | 说明 | 认证 |
|------|------|------|------|
| `GET` | `/recommendation/home` | 首页推荐 | 是 |
| `GET` | `/recommendation/related/:bookId` | 相关书籍 | 否 |

---

## 5. 查询参数

### 5.1 DiscoverBooksQueryDto

| 参数 | 类型 | 说明 |
|------|------|------|
| `page` | number | 页码 |
| `size` | number | 每页数量 |
| `language` | string | 语言筛选 |
| `category` | string | 分类筛选 |
| `sort` | enum | 排序方式 |

### 5.2 排序方式

| 值 | 说明 |
|------|------|
| `recommended` | 综合推荐分 (默认) |
| `popular` | 热度分数 |
| `new` | 新鲜度分数 |
| `quality` | 质量分数 |

---

## 6. 首页推荐结构

```
┌─────────────────────────────────────────────────────────────┐
│                    首页推荐响应                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  HomeRecommendationsResponseDto:                           │
│  {                                                          │
│    "forYou": [...],      // 为你推荐 (基于用户等级)        │
│    "popular": [...],     // 热门书籍                       │
│    "newArrivals": [...], // 新书推荐                       │
│    "editorsPicks": [...]  // 编辑精选 (来自 Booklist)      │
│  }                                                          │
│                                                             │
│  每个分类包含 10-20 本书籍                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.1 个性化推荐逻辑

| 用户等级 | 难度范围 | 说明 |
|----------|----------|------|
| `BEGINNER` | 0-35 | A1-A2 |
| `INTERMEDIATE` | 30-65 | B1-B2 |
| `ADVANCED` | 60-100 | C1-C2 |

---

## 7. 相关书籍算法

```
┌─────────────────────────────────────────────────────────────┐
│                    相关书籍算法                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入: bookId                                               │
│                                                             │
│  筛选条件:                                                  │
│  1. 相同分类                                               │
│  2. 难度差异 ≤ 15                                          │
│  3. 排除当前书籍                                           │
│  4. 排除用户已读书籍 (如已登录)                            │
│                                                             │
│  排序: 综合推荐分 DESC                                     │
│                                                             │
│  返回: 最多 10 本                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 书籍统计数据流

```
┌─────────────────────────────────────────────────────────────┐
│                    统计数据流                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户行为               触发统计                           │
│  ─────────────────────────────────────────────             │
│  浏览书籍详情    →    incrementView()                      │
│  添加到书架      →    incrementBookshelf()                 │
│  开始阅读        →    incrementReadStart()                 │
│  完成阅读        →    incrementReadComplete()              │
│  阅读 N 分钟     →    addReadingMinutes(N)                 │
│  添加高亮/笔记   →    incrementHighlight()                 │
│  使用 AI 功能    →    incrementAIInteraction()             │
│                                                             │
│  统计表: BookStats                                         │
│  ├── 总量统计 (累计)                                       │
│  └── 日统计 (BookDailyStats)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. 评分更新策略

### 9.1 实时更新

| 触发时机 | 更新范围 |
|----------|----------|
| 用户行为后 | 单本书籍评分 |
| 书籍发布后 | 单本书籍评分 |

### 9.2 批量更新

| 触发方式 | 更新范围 |
|----------|----------|
| 定时任务 | 所有活跃书籍 |
| 管理员触发 | 指定书籍列表 |

---

## 10. 缓存策略

| 缓存键 | TTL | 说明 |
|--------|-----|------|
| `discover:tabs` | 1 小时 | 发现页标签 |
| `book:score:{id}` | 实时 | 书籍评分 (数据库) |

---

## 11. 实现位置

| 组件 | 路径 |
|------|------|
| **模块** | `apps/backend/src/modules/recommendation/recommendation.module.ts` |
| **主服务** | `apps/backend/src/modules/recommendation/recommendation.service.ts` |
| **统计服务** | `apps/backend/src/modules/recommendation/book-stats.service.ts` |
| **评分服务** | `apps/backend/src/modules/recommendation/book-score.service.ts` |
| **评分计算** | `apps/backend/src/modules/recommendation/score-calculator.ts` |
| **控制器** | `apps/backend/src/modules/recommendation/recommendation.controller.ts` |

---

## 12. 相关文档

| 文档 | 说明 |
|------|------|
| [algorithm/book-ranking-algorithm.md](../algorithm/book-ranking-algorithm.md) | 排名算法详细设计 |
| [algorithm/book-ranking-implementation.md](../algorithm/book-ranking-implementation.md) | 算法实现文档 |
| [modules/books.md](books.md) | 书籍模块 |
| [modules/reading.md](reading.md) | 阅读模块 (统计触发) |

---

*最后更新: 2025-12-31*

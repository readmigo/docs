# R2 文件版本管理策略

> 解决多版本间文件重复问题，以 V1→V2（新增有声书）为例

---

## 一、问题分析

### 1.1 简单方案的问题

```
❌ 每版本一套完整文件（不推荐）

readmigo-v1/                    readmigo-v2/
├── epubs/ (300本, ~150MB)      ├── epubs/ (300本, ~150MB)  ← 完全重复!
├── covers/ (300张, ~60MB)      ├── covers/ (300张, ~60MB)  ← 完全重复!
└── authors/ (100位, ~20MB)     ├── authors/ (100位, ~20MB) ← 完全重复!
                                └── audiobooks/ (150本, ~15GB) ← 新增

问题:
├── 存储浪费: 230MB × 2 = 460MB 重复数据
├── 同步复杂: 修复一本书需要更新多个版本
└── 成本增加: 存储和操作费用翻倍
```

### 1.2 V1 与 V2 的内容差异

| 内容类型 | V1 | V2 | 差异 |
|----------|-----|-----|------|
| 电子书 | 300 本 | 300 本 | 相同 |
| 作者 | 100 位 | 100 位 | 相同 |
| 封面图 | 300 张 | 300 张 | 相同 |
| 有声书 | 0 本 | 150 本 | **新增** |
| 音频文件 | 0 | ~15GB | **新增** |

---

## 二、推荐方案：共享存储 + 版本清单

### 2.1 核心思路

```
┌─────────────────────────────────────────────────────────────────┐
│                   共享存储 + 版本清单架构                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              R2 Bucket (readmigo)                        │   │
│   │                   单一存储源                              │   │
│   ├─────────────────────────────────────────────────────────┤   │
│   │                                                           │   │
│   │   /epubs/           ← 所有版本共享                        │   │
│   │   /covers/          ← 所有版本共享                        │   │
│   │   /authors/         ← 所有版本共享                        │   │
│   │   /audiobooks/      ← V2+ 使用                           │   │
│   │                                                           │   │
│   │   /manifests/       ← 版本清单文件                        │   │
│   │     ├── v1.0.0.json                                      │   │
│   │     ├── v1.1.0.json                                      │   │
│   │     └── v2.0.0.json                                      │   │
│   │                                                           │   │
│   └─────────────────────────────────────────────────────────┘   │
│                            │                                      │
│            ┌───────────────┼───────────────┐                     │
│            ▼               ▼               ▼                     │
│       ┌────────┐     ┌────────┐     ┌────────┐                  │
│       │ iOS    │     │ iOS    │     │ iOS    │                  │
│       │ v1.0.x │     │ v1.1.x │     │ v2.0.x │                  │
│       └────────┘     └────────┘     └────────┘                  │
│            │               │               │                     │
│            ▼               ▼               ▼                     │
│       读取 v1.0.0     读取 v1.1.0     读取 v2.0.0                │
│       manifest        manifest        manifest                   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构设计

```
readmigo/                              # 单一 Production Bucket
│
├── manifests/                         # 版本清单目录
│   ├── v1.0.0.json                   # V1.0.0 包含的所有内容 ID
│   ├── v1.1.0.json                   # V1.1.0 包含的所有内容 ID
│   └── v2.0.0.json                   # V2.0.0 包含的所有内容 ID
│
├── epubs/                             # 电子书文件 (共享)
│   ├── {content-hash-1}.epub         # 内容寻址命名
│   ├── {content-hash-2}.epub
│   └── ...
│
├── covers/                            # 封面图片 (共享)
│   ├── books/
│   │   ├── {book-id}.jpg
│   │   └── {book-id}-thumb.jpg
│   └── audiobooks/
│       └── {audiobook-id}.jpg
│
├── authors/                           # 作者资源 (共享)
│   └── {author-id}/
│       ├── portrait.jpg
│       └── portrait-thumb.jpg
│
└── audiobooks/                        # 有声书音频 (V2+)
    └── {audiobook-id}/
        ├── chapter-01.mp3
        ├── chapter-02.mp3
        └── ...
```

### 2.3 版本清单文件结构

```json
// manifests/v1.0.0.json
{
  "version": "1.0.0",
  "releaseDate": "2025-01-15",
  "minAppVersion": "1.0.0",
  "content": {
    "ebooks": {
      "count": 300,
      "ids": ["book-001", "book-002", "..."],
      "lastUpdated": "2025-01-15T00:00:00Z"
    },
    "authors": {
      "count": 100,
      "ids": ["author-001", "author-002", "..."],
      "lastUpdated": "2025-01-15T00:00:00Z"
    },
    "audiobooks": {
      "count": 0,
      "ids": [],
      "enabled": false
    }
  },
  "files": {
    "epubs": [
      {"id": "book-001", "key": "epubs/abc123.epub", "size": 524288},
      {"id": "book-002", "key": "epubs/def456.epub", "size": 612000}
    ],
    "covers": [
      {"id": "book-001", "key": "covers/books/book-001.jpg"},
      {"id": "book-001-thumb", "key": "covers/books/book-001-thumb.jpg"}
    ],
    "authors": [
      {"id": "author-001", "key": "authors/author-001/portrait.jpg"}
    ]
  },
  "checksum": "sha256:abcdef123456..."
}
```

```json
// manifests/v2.0.0.json
{
  "version": "2.0.0",
  "releaseDate": "2025-06-01",
  "minAppVersion": "2.0.0",
  "content": {
    "ebooks": {
      "count": 300,
      "ids": ["book-001", "book-002", "..."],  // 与 V1 相同
      "lastUpdated": "2025-01-15T00:00:00Z"
    },
    "authors": {
      "count": 100,
      "ids": ["author-001", "author-002", "..."],  // 与 V1 相同
      "lastUpdated": "2025-01-15T00:00:00Z"
    },
    "audiobooks": {
      "count": 150,
      "ids": ["audiobook-001", "audiobook-002", "..."],  // 新增
      "enabled": true,
      "lastUpdated": "2025-06-01T00:00:00Z"
    }
  },
  "files": {
    "epubs": [...],      // 复用 V1 的文件引用
    "covers": [...],     // 复用 V1 的文件引用
    "authors": [...],    // 复用 V1 的文件引用
    "audiobooks": [      // 新增音频文件
      {"id": "audiobook-001", "key": "audiobooks/audiobook-001/chapter-01.mp3", "size": 52428800},
      {"id": "audiobook-001", "key": "audiobooks/audiobook-001/chapter-02.mp3", "size": 48576000}
    ]
  },
  "checksum": "sha256:789xyz..."
}
```

---

## 三、版本控制流程

### 3.1 数据流向

```
┌─────────────────────────────────────────────────────────────────┐
│                       数据发布流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                    Debug 环境                             │  │
│   │  readmigo-debug bucket                                    │  │
│   │  ├── epubs/ (所有测试书籍)                                │  │
│   │  ├── audiobooks/ (所有测试音频)                           │  │
│   │  └── 无版本控制，自由添加/删除                            │  │
│   └──────────────────────────────────────────────────────────┘  │
│                            │                                      │
│                            │  sync-to-staging.ts                  │
│                            │  (按书单同步指定内容)                 │
│                            ▼                                      │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                   Staging 环境                            │  │
│   │  readmigo-staging bucket                                  │  │
│   │  ├── 与 Production 结构相同                               │  │
│   │  ├── manifests/v1.0.0-rc1.json (候选版本)                │  │
│   │  └── 验证通过后升级为 release                             │  │
│   └──────────────────────────────────────────────────────────┘  │
│                            │                                      │
│                            │  promote-to-production.ts            │
│                            │  (仅复制新增/变更文件)               │
│                            ▼                                      │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                  Production 环境                          │  │
│   │  readmigo bucket                                          │  │
│   │  ├── manifests/v1.0.0.json (正式版本)                    │  │
│   │  ├── 文件一旦写入，只增不删                               │  │
│   │  └── 通过 manifest 控制可见性                             │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 客户端版本绑定

```
┌─────────────────────────────────────────────────────────────────┐
│                    客户端版本绑定逻辑                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   iOS App 启动                                                   │
│        │                                                          │
│        ▼                                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  GET /api/v1/version/check                               │   │
│   │  Request: { appVersion: "1.0.0", platform: "ios" }       │   │
│   └─────────────────────────────────────────────────────────┘   │
│        │                                                          │
│        ▼                                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  服务端返回对应的 manifest 版本                          │   │
│   │  Response: {                                              │   │
│   │    manifestVersion: "v1.0.0",                            │   │
│   │    manifestUrl: "https://cdn.../manifests/v1.0.0.json", │   │
│   │    features: { audiobooks: false }                       │   │
│   │  }                                                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│        │                                                          │
│        ▼                                                          │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  客户端根据 manifest 决定：                              │   │
│   │  ├── 可显示的书籍列表                                    │   │
│   │  ├── 是否显示有声书入口                                  │   │
│   │  └── 文件访问路径                                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、V1 → V2 升级推演（新增有声书）

### 4.1 升级前状态 (V1.0.0)

| 资源类型 | R2 文件 | 大小 | 状态 |
|----------|---------|------|------|
| EPUB 文件 | 300 个 | ~150MB | 已发布 |
| 书籍封面 | 300 张 | ~60MB | 已发布 |
| 作者头像 | 100 张 | ~20MB | 已发布 |
| 有声书音频 | 0 | 0 | 不存在 |
| **总计** | | **~230MB** | |

### 4.2 升级目标 (V2.0.0)

| 资源类型 | R2 文件 | 大小 | 变化 |
|----------|---------|------|------|
| EPUB 文件 | 300 个 | ~150MB | **复用** |
| 书籍封面 | 300 张 | ~60MB | **复用** |
| 作者头像 | 100 张 | ~20MB | **复用** |
| 有声书音频 | 150 本 × 10章 | ~15GB | **新增** |
| 有声书封面 | 150 张 | ~30MB | **新增** |
| **总计** | | **~15.26GB** | |

### 4.3 执行计划

```
┌─────────────────────────────────────────────────────────────────┐
│                   V2.0.0 发布执行计划                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  阶段 1: 音频文件准备 (Debug 环境)                               │
│  ├── 1.1 下载 150 本有声书音频到 Debug R2                       │
│  │       └── 脚本: loyalbooks-ingestion/download-all.ts         │
│  ├── 1.2 处理音频文件 (格式转换、标准化)                        │
│  ├── 1.3 下载有声书封面                                         │
│  └── 1.4 验证音频播放和元数据                                   │
│                                                                   │
│  阶段 2: 数据库准备                                              │
│  ├── 2.1 导入 Audiobook 记录到 Debug 数据库                     │
│  ├── 2.2 建立 Book ↔ Audiobook 关联                             │
│  ├── 2.3 导入 AudiobookChapter 章节信息                         │
│  └── 2.4 验证数据完整性                                         │
│                                                                   │
│  阶段 3: Staging 同步与验证                                      │
│  ├── 3.1 同步音频文件到 Staging R2                              │
│  │       └── 仅同步新增的 audiobooks/ 目录                      │
│  ├── 3.2 同步数据库记录到 Staging                               │
│  ├── 3.3 生成 v2.0.0-rc1.json manifest                         │
│  ├── 3.4 iOS v2.0.0 连接 Staging 测试                           │
│  │       ├── 电子书功能 (应与 v1 完全一致)                      │
│  │       ├── 有声书列表加载                                     │
│  │       ├── 音频播放功能                                       │
│  │       └── 书电关联跳转                                       │
│  └── 3.5 验证通过，标记为 v2.0.0-release                        │
│                                                                   │
│  阶段 4: Production 部署                                         │
│  ├── 4.1 同步新增文件到 Production R2                           │
│  │       ├── audiobooks/ 目录 (~15GB)                           │
│  │       └── 不触碰现有 epubs/covers/authors/                   │
│  ├── 4.2 同步数据库记录                                         │
│  ├── 4.3 上传 manifests/v2.0.0.json                            │
│  └── 4.4 更新版本检查 API 配置                                  │
│                                                                   │
│  阶段 5: iOS v2.0.0 发布                                         │
│  ├── 5.1 启用有声书 Tab                                         │
│  ├── 5.2 指向 Production + manifest v2.0.0                      │
│  ├── 5.3 TestFlight 测试                                        │
│  └── 5.4 App Store 提审                                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 4.4 文件同步详情

```
┌─────────────────────────────────────────────────────────────────┐
│              V1 → V2 文件同步详情                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Production R2 Bucket 变化:                                      │
│                                                                   │
│  V1.0.0 状态                     V2.0.0 状态                     │
│  ─────────────                   ─────────────                   │
│  manifests/                      manifests/                      │
│    └── v1.0.0.json               ├── v1.0.0.json  (保留)        │
│                                  └── v2.0.0.json  (新增)        │
│                                                                   │
│  epubs/                          epubs/                          │
│    └── (300 files)               └── (300 files)  (不变)        │
│                                                                   │
│  covers/                         covers/                         │
│    └── books/ (300 files)        ├── books/ (300 files) (不变)  │
│                                  └── audiobooks/ (150 新增)      │
│                                                                   │
│  authors/                        authors/                        │
│    └── (100 dirs)                └── (100 dirs)  (不变)         │
│                                                                   │
│  (不存在)                        audiobooks/  (新增 ~15GB)       │
│                                    └── {id}/chapter-xx.mp3       │
│                                                                   │
│  ─────────────────────────────────────────────────────────────  │
│  新增数据量: ~15GB (仅有声书相关)                                │
│  复用数据量: ~230MB (电子书、作者资源)                           │
│  存储节省: 100% 复用 V1 资源                                     │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、向后兼容保证

### 5.1 多版本客户端并存

```
┌─────────────────────────────────────────────────────────────────┐
│                   多版本客户端并存策略                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   Production R2 + API                                            │
│        │                                                          │
│        ├──────────────────────────────────────────────────────   │
│        │                                                          │
│        ▼                         ▼                               │
│   ┌──────────┐             ┌──────────┐                         │
│   │ iOS 1.x  │             │ iOS 2.x  │                         │
│   └────┬─────┘             └────┬─────┘                         │
│        │                        │                                │
│        ▼                        ▼                                │
│   读取 manifest             读取 manifest                        │
│   v1.0.0.json               v2.0.0.json                         │
│        │                        │                                │
│        ▼                        ▼                                │
│   ┌──────────────────┐    ┌──────────────────┐                  │
│   │ 可访问内容:       │    │ 可访问内容:       │                  │
│   │ ├── 300 电子书   │    │ ├── 300 电子书   │                  │
│   │ ├── 100 作者     │    │ ├── 100 作者     │                  │
│   │ └── 0 有声书     │    │ └── 150 有声书   │                  │
│   │                   │    │                   │                  │
│   │ 访问的 R2 文件:   │    │ 访问的 R2 文件:   │                  │
│   │ ├── epubs/*      │    │ ├── epubs/*      │                  │
│   │ ├── covers/*     │    │ ├── covers/*     │                  │
│   │ └── authors/*    │    │ ├── authors/*    │                  │
│   │                   │    │ └── audiobooks/* │                  │
│   └──────────────────┘    └──────────────────┘                  │
│                                                                   │
│   关键点:                                                        │
│   ├── 两个版本访问同一套 epubs/covers/authors 文件              │
│   ├── iOS 1.x 不知道 audiobooks/ 的存在                         │
│   ├── API 根据客户端版本返回对应的 manifest                     │
│   └── 文件级别无版本区分，由 manifest 控制可见性                │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 API 版本映射

| 客户端版本 | API 版本 | Manifest 版本 | 有声书功能 |
|------------|----------|---------------|------------|
| iOS 1.0.x | /api/v1 | v1.0.0.json | 禁用 |
| iOS 1.1.x | /api/v1 | v1.1.0.json | 禁用 |
| iOS 2.0.x | /api/v1 | v2.0.0.json | 启用 |
| iOS 2.1.x | /api/v1 | v2.1.0.json | 启用 |

### 5.3 功能开关配置

```
┌─────────────────────────────────────────────────────────────────┐
│                     功能开关配置表                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  版本检查 API 返回的 features 字段:                              │
│                                                                   │
│  iOS 1.x:                        iOS 2.x:                        │
│  {                               {                               │
│    "features": {                   "features": {                 │
│      "audiobooks": false,           "audiobooks": true,          │
│      "agora": false,                "agora": false,              │
│      "authorChat": false            "authorChat": false          │
│    }                               }                              │
│  }                               }                               │
│                                                                   │
│  客户端根据 features 决定:                                       │
│  ├── 是否显示有声书 Tab                                         │
│  ├── 是否显示社区入口                                           │
│  └── 是否显示作者聊天功能                                       │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、文件修复与热更新

### 6.1 单文件修复流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    单文件修复流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  场景: 发现某本书的 EPUB 文件有问题需要修复                      │
│                                                                   │
│  ┌──────────┐                                                    │
│   │ 发现问题 │ (book-042.epub 章节解析错误)                      │
│   └────┬─────┘                                                   │
│        │                                                          │
│        ▼                                                          │
│   ┌──────────┐                                                   │
│   │ Debug    │ 修复 EPUB 文件                                    │
│   │ 环境修复 │ 重新解析章节                                      │
│   └────┬─────┘                                                   │
│        │                                                          │
│        ▼                                                          │
│   ┌──────────┐                                                   │
│   │ 直接更新 │ 覆盖 Production R2 的单个文件                     │
│   │ Prod     │ epubs/{hash}.epub                                │
│   └────┬─────┘                                                   │
│        │                                                          │
│        │  文件 key 不变，内容更新                                 │
│        │  CDN 缓存: 等待过期或手动 purge                         │
│        │                                                          │
│        ▼                                                          │
│   ┌──────────┐                                                   │
│   │ 无需更新 │ manifest 文件引用的 key 不变                      │
│   │ manifest │ 客户端自动获取新文件                              │
│   └──────────┘                                                   │
│                                                                   │
│  优点:                                                           │
│  ├── 快速修复，无需发版                                         │
│  ├── 所有版本客户端同时受益                                     │
│  └── 不需要用户更新 App                                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 批量更新与版本升级

| 场景 | 处理方式 | 是否需要新 manifest |
|------|----------|-------------------|
| 修复单个 EPUB | 直接覆盖文件 | 否 |
| 修复多个封面 | 直接覆盖文件 | 否 |
| 新增 50 本书 | 添加文件 + 更新 manifest | 是 (v1.1.0) |
| 新增有声书功能 | 添加文件 + 新 manifest | 是 (v2.0.0) |
| 删除某本书 | 更新 manifest 移除引用 | 是 |

---

## 七、存储成本优化

### 7.1 各版本存储占用

| 版本 | 新增内容 | 新增存储 | 累计存储 |
|------|----------|----------|----------|
| V1.0.0 | 300 电子书 + 100 作者 | ~230MB | ~230MB |
| V1.1.0 | +200 电子书 | ~150MB | ~380MB |
| V2.0.0 | +150 有声书 | ~15GB | ~15.4GB |
| V2.1.0 | +50 有声书 | ~5GB | ~20.4GB |

### 7.2 成本对比

```
┌─────────────────────────────────────────────────────────────────┐
│                    存储成本对比                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  方案 A: 每版本独立存储 (不推荐)                                 │
│  ├── V1: 230MB                                                   │
│  ├── V2: 230MB + 15GB = 15.2GB                                  │
│  ├── 总计: 15.43GB                                              │
│  └── 重复: 230MB (电子书资源重复一次)                           │
│                                                                   │
│  方案 B: 共享存储 + manifest (推荐) ✅                           │
│  ├── 共享资源: 230MB                                            │
│  ├── V2 新增: 15GB                                              │
│  ├── 总计: 15.23GB                                              │
│  └── 重复: 0                                                    │
│                                                                   │
│  节省: 230MB (1.5%)                                              │
│  注: 电子书场景节省比例较小，但有声书场景会放大                  │
│                                                                   │
│  如果 V3 新增另一套内容:                                         │
│  方案 A: 15.43GB + 15.2GB = 30.63GB                             │
│  方案 B: 15.23GB + 15GB = 30.23GB                               │
│  节省: 400MB (1.3%)                                              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 月度成本估算

| 阶段 | 存储量 | 存储费用 | 出站流量 | 流量费用 | 总计 |
|------|--------|----------|----------|----------|------|
| V1 发布 | 1GB | $0.015 | 50GB | $0 | ~$0.02 |
| V2 发布 | 20GB | $0.30 | 500GB | $0 | ~$0.35 |
| V2 成熟 | 50GB | $0.75 | 2TB | $0 | ~$0.80 |

> R2 出站流量免费是核心优势

---

## 八、执行检查清单

### 8.1 V2 发布前检查

```
□ Debug 环境
  □ 150 本有声书音频已下载
  □ 音频文件格式统一 (MP3, 128kbps)
  □ 有声书封面已下载
  □ Audiobook 数据库记录完整
  □ Book ↔ Audiobook 关联正确
  □ AudiobookChapter 章节信息正确

□ Staging 环境
  □ 音频文件同步完成 (~15GB)
  □ 数据库同步完成
  □ v2.0.0-rc1.json manifest 生成
  □ iOS v2.0.0 测试通过
    □ 电子书功能正常 (回归测试)
    □ 有声书列表正常
    □ 音频播放正常
    □ 进度同步正常

□ Production 环境
  □ audiobooks/ 目录同步完成
  □ covers/audiobooks/ 封面同步完成
  □ 数据库记录同步完成
  □ v2.0.0.json manifest 上传
  □ 版本 API 配置更新

□ iOS 发布
  □ 有声书 Tab 启用
  □ 指向 Production 环境
  □ manifest 版本正确 (v2.0.0)
  □ TestFlight 测试通过
  □ App Store 提审
```

---

*文档版本: 1.0*
*创建日期: 2025-12-31*
*关联文档: v1-fullstack-release-plan.md*

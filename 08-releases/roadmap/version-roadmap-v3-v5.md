# 版本演进路线图 V1-V5

> V1: iOS首发 | V2: Android+有声书 | V3: Web+智能阅读 | V4: 内容导入 | V5: 社区与创作

---

## 版本全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           版本功能演进全景                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  V1.0 ────► V2.0 ────► V3.0 ────► V4.0 ────► V5.0                           │
│    │         │         │         │         │                                 │
│    ▼         ▼         ▼         ▼         ▼                                 │
│  电子书    有声书    智能阅读   内容导入   社区创作                            │
│  作者      音频      TTS        用户上传   博客                               │
│  阅读      播放      人声朗读   EPUB导入   划线分享                            │
│  发现      同步      热词标注   PDF支持    想法/评论                           │
│                      段落解析              个人日志                            │
│                      边读边听                                                 │
│                                                                               │
│  平台支持:                                                                    │
│  iOS      +Android  +Web App   全平台     全平台                              │
│                                                                               │
│  存储增量:                                                                    │
│  +230MB   +15GB    +1GB       用户驱动    用户驱动                            │
│                    /300书                                                     │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 平台支持矩阵

| 版本 | iOS | Android | Web App | 新增功能 |
|------|-----|---------|---------|----------|
| V1.0 | ✅ | ❌ | ❌ | 电子书/作者/阅读/发现 |
| V2.0 | ✅ | ✅ | ❌ | 有声书 |
| V3.0 | ✅ | ✅ | ✅ | 智能阅读增强 |
| V4.0 | ✅ | ✅ | ✅ | 内容导入 |
| V5.0 | ✅ | ✅ | ✅ | 社区与创作 |

---

## V3: 智能阅读增强

### 功能清单

| 功能 | 描述 | 数据需求 |
|------|------|----------|
| **TTS 朗读** | 系统 TTS 实时朗读 | 无需预存储 |
| **人声朗读** | 预录制高质量人声 | 需要音频文件 |
| **边读边听** | 阅读时高亮当前朗读位置 | 需要时间戳数据 |
| **热词标注** | 重要词汇预先标记 | 需要词汇元数据 |
| **段落解析** | 点击段落显示翻译/解析 | 需要段落元数据 |

### 核心问题：是否修改原 EPUB？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     原则：EPUB 文件保持不变                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ❌ 不推荐：修改 EPUB 嵌入标注                                               │
│  ├── 破坏原文件完整性                                                        │
│  ├── 无法回滚                                                                │
│  ├── 版本管理复杂                                                            │
│  └── 多客户端同步困难                                                        │
│                                                                               │
│  ✅ 推荐：Overlay 叠加层方案                                                 │
│  ├── 原 EPUB 文件不变                                                        │
│  ├── 增强数据存储在独立文件                                                  │
│  ├── 客户端运行时叠加渲染                                                    │
│  └── 版本独立，易于升级                                                      │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V3 新增存储结构

```
readmigo/
├── manifests/
│   └── v3.0.0.json
│
├── epubs/                    ← 不变，复用
├── covers/                   ← 不变，复用
├── authors/                  ← 不变，复用
├── audiobooks/               ← V2 有声书，复用
│
└── enhancements/             ← V3 新增：增强数据目录
    └── {book-id}/
        ├── meta.json         # 增强数据元信息
        ├── timestamps.json   # 时间戳数据 (边读边听)
        ├── hotwords.json     # 热词标注数据
        ├── paragraphs.json   # 段落解析数据
        └── tts/              # 人声朗读音频 (可选)
            ├── chapter-01.mp3
            └── chapter-02.mp3
```

### 各增强数据详细设计

#### 1. 时间戳数据 (timestamps.json)

```
用途：边读边听时，高亮当前朗读的句子/单词

┌─────────────────────────────────────────────────────────────────┐
│                    时间戳数据结构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  {                                                               │
│    "bookId": "book-042",                                        │
│    "version": "1.0",                                            │
│    "generatedAt": "2025-06-01T00:00:00Z",                      │
│    "source": "whisper-v3",  // 生成工具                         │
│    "chapters": [                                                │
│      {                                                          │
│        "chapterId": "chapter-01",                              │
│        "sentences": [                                          │
│          {                                                      │
│            "index": 0,                                         │
│            "text": "It was the best of times...",              │
│            "startTime": 0.0,      // 秒                        │
│            "endTime": 3.5,                                     │
│            "startOffset": 0,      // 章节内字符偏移            │
│            "endOffset": 28,                                    │
│            "words": [             // 可选：单词级时间戳         │
│              { "word": "It", "start": 0.0, "end": 0.2 },      │
│              { "word": "was", "start": 0.25, "end": 0.5 },    │
│              ...                                               │
│            ]                                                   │
│          }                                                     │
│        ]                                                       │
│      }                                                         │
│    ]                                                           │
│  }                                                             │
│                                                                   │
│  大小估算: ~50KB/章节, ~500KB/书                                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

#### 2. 热词标注数据 (hotwords.json)

```
用途：预先标记重要词汇，点击显示释义

┌─────────────────────────────────────────────────────────────────┐
│                     热词数据结构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  {                                                               │
│    "bookId": "book-042",                                        │
│    "version": "1.0",                                            │
│    "generatedAt": "2025-06-01T00:00:00Z",                      │
│    "wordCount": 1523,                                          │
│    "categories": {                                              │
│      "vocabulary": 800,    // 重要词汇                          │
│      "person": 120,        // 人名                              │
│      "place": 85,          // 地名                              │
│      "concept": 200,       // 概念/术语                         │
│      "literary": 318       // 文学手法/典故                     │
│    },                                                           │
│    "chapters": [                                                │
│      {                                                          │
│        "chapterId": "chapter-01",                              │
│        "hotwords": [                                           │
│          {                                                      │
│            "word": "epoch",                                    │
│            "category": "vocabulary",                           │
│            "cefrLevel": "C1",                                  │
│            "positions": [                                      │
│              { "startOffset": 15, "endOffset": 20 },          │
│              { "startOffset": 1520, "endOffset": 1525 }       │
│            ],                                                  │
│            "definition": {                                     │
│              "en": "a period of time in history",             │
│              "zh": "时代，纪元"                                │
│            },                                                  │
│            "pronunciation": "/ˈiːpɒk/",                       │
│            "examples": [                                       │
│              "the Victorian epoch"                            │
│            ]                                                   │
│          },                                                    │
│          {                                                      │
│            "word": "Mr. Lorry",                                │
│            "category": "person",                               │
│            "positions": [...],                                 │
│            "description": {                                    │
│              "en": "A banker at Tellson's Bank...",           │
│              "zh": "台尔森银行的银行家..."                     │
│            },                                                  │
│            "firstAppearance": "chapter-01",                   │
│            "role": "supporting"                               │
│          }                                                     │
│        ]                                                       │
│      }                                                         │
│    ]                                                           │
│  }                                                             │
│                                                                   │
│  大小估算: ~100KB/章节, ~1MB/书                                  │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

#### 3. 段落解析数据 (paragraphs.json)

```
用途：点击段落显示翻译、解析、背景知识

┌─────────────────────────────────────────────────────────────────┐
│                    段落解析数据结构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  {                                                               │
│    "bookId": "book-042",                                        │
│    "version": "1.0",                                            │
│    "generatedAt": "2025-06-01T00:00:00Z",                      │
│    "chapters": [                                                │
│      {                                                          │
│        "chapterId": "chapter-01",                              │
│        "paragraphs": [                                         │
│          {                                                      │
│            "index": 0,                                         │
│            "startOffset": 0,                                   │
│            "endOffset": 450,                                   │
│            "originalText": "It was the best of times...",      │
│            "translation": {                                    │
│              "zh": "那是最美好的时代..."                       │
│            },                                                  │
│            "analysis": {                                       │
│              "summary": "Opening parallelism...",              │
│              "literaryDevices": ["antithesis", "anaphora"],   │
│              "themes": ["duality", "revolution"],             │
│              "difficulty": "intermediate"                     │
│            },                                                  │
│            "context": {                                        │
│              "historicalNote": "Refers to the period...",     │
│              "authorIntent": "Dickens establishes..."         │
│            }                                                   │
│          }                                                     │
│        ]                                                       │
│      }                                                         │
│    ]                                                           │
│  }                                                             │
│                                                                   │
│  大小估算: ~200KB/章节, ~2MB/书                                  │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### V3 数据生成流水线

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        V3 数据预处理流水线                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   输入: EPUB 文件 + 有声书音频 (V2)                                          │
│                                                                               │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 1: 文本提取与分割                                              │  │
│   │  ├── EPUB → 纯文本                                                   │  │
│   │  ├── 句子分割 (NLP)                                                  │  │
│   │  └── 段落识别                                                        │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                            │                                                  │
│                            ▼                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 2: 时间戳生成 (需要音频)                                       │  │
│   │  ├── Whisper ASR 转录音频                                            │  │
│   │  ├── 音频文本与 EPUB 文本对齐                                        │  │
│   │  ├── 生成句子级时间戳                                                │  │
│   │  └── 可选: 生成单词级时间戳                                          │  │
│   │  工具: OpenAI Whisper / whisper.cpp                                  │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                            │                                                  │
│                            ▼                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 3: 热词提取与标注                                              │  │
│   │  ├── NLP 实体识别 (人名/地名/组织)                                   │  │
│   │  ├── 词汇难度分析 (CEFR 等级)                                        │  │
│   │  ├── 文学术语/典故识别                                               │  │
│   │  ├── AI 生成释义和翻译                                               │  │
│   │  └── 去重与位置映射                                                  │  │
│   │  工具: spaCy / GPT-4 / DeepSeek                                      │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                            │                                                  │
│                            ▼                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 4: 段落解析生成                                                │  │
│   │  ├── AI 翻译每个段落                                                 │  │
│   │  ├── AI 分析文学手法                                                 │  │
│   │  ├── AI 生成背景知识                                                 │  │
│   │  └── 难度评估                                                        │  │
│   │  工具: GPT-4 / DeepSeek / Claude                                     │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                            │                                                  │
│                            ▼                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 5: 人声音频生成 (可选)                                         │  │
│   │  ├── 高质量 TTS 生成 (OpenAI TTS / ElevenLabs)                       │  │
│   │  ├── 或: 人工录制                                                    │  │
│   │  └── 分章节存储                                                      │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                            │                                                  │
│                            ▼                                                  │
│   输出: enhancements/{book-id}/ 目录                                         │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V3 存储估算

| 数据类型 | 单书大小 | 300 书总量 | 说明 |
|----------|----------|------------|------|
| timestamps.json | ~500KB | ~150MB | 句子级时间戳 |
| hotwords.json | ~1MB | ~300MB | 热词标注 |
| paragraphs.json | ~2MB | ~600MB | 段落解析 |
| TTS 音频 (可选) | ~50MB | ~15GB | 高质量人声 |
| **总计 (无音频)** | ~3.5MB | **~1GB** | 纯元数据 |
| **总计 (含音频)** | ~53MB | **~16GB** | 含人声朗读 |

### V3 客户端渲染流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      V3 客户端渲染流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   用户打开书籍                                                               │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  1. 加载 EPUB 原文件 (与 V1/V2 相同)                                  │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  2. 检查并加载增强数据                                                │  │
│   │     GET /api/v1/books/{id}/enhancements                              │  │
│   │     → 返回 timestamps.json, hotwords.json, paragraphs.json URL       │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  3. 渲染 EPUB + 叠加增强层                                           │  │
│   │     ├── 热词: 添加下划线样式 + 点击事件                              │  │
│   │     ├── 段落: 添加点击事件                                           │  │
│   │     └── TTS: 绑定时间戳到句子元素                                    │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  4. 用户交互                                                          │  │
│   │     ├── 点击热词 → 显示弹窗 (释义/翻译/发音)                         │  │
│   │     ├── 点击段落 → 显示弹窗 (翻译/解析/背景)                         │  │
│   │     └── 播放朗读 → 高亮当前句子/单词                                 │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## V4: 内容导入

### 功能清单

| 功能 | 描述 | 技术挑战 |
|------|------|----------|
| **EPUB 导入** | 用户上传自有 EPUB | 格式验证、存储 |
| **PDF 导入** | 用户上传 PDF 文档 | PDF 解析、转换 |
| **网页导入** | 保存网页文章 | 内容提取、清洗 |
| **导入书籍阅读** | 与平台书籍相同体验 | 统一阅读器 |
| **可选增强** | 对导入内容生成增强数据 | 按需处理 |

### V4 存储架构

```
readmigo/
├── manifests/
│   └── v4.0.0.json
│
├── epubs/                    ← 平台内容，复用
├── enhancements/             ← 平台增强数据，复用
│
└── user-content/             ← V4 新增：用户内容目录
    └── {user-id}/
        ├── imports/          # 导入的原文件
        │   ├── {import-id}.epub
        │   ├── {import-id}.pdf
        │   └── {import-id}.html
        │
        ├── processed/        # 处理后的统一格式
        │   └── {import-id}/
        │       ├── content.json    # 统一内容格式
        │       ├── chapters/       # 章节内容
        │       └── cover.jpg       # 提取的封面
        │
        └── enhancements/     # 用户内容的增强数据 (可选)
            └── {import-id}/
                ├── timestamps.json
                ├── hotwords.json
                └── paragraphs.json
```

### V4 数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        V4 用户导入数据模型                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  UserImport (数据库表)                                                       │
│  ├── id: UUID                                                                │
│  ├── userId: String                                                          │
│  ├── type: EPUB | PDF | WEB                                                  │
│  ├── title: String                                                           │
│  ├── author: String?                                                         │
│  ├── originalUrl: String?          # 网页来源                               │
│  ├── originalFileName: String?     # 原文件名                               │
│  ├── fileSize: Int                                                          │
│  ├── pageCount: Int?               # PDF 页数                               │
│  ├── wordCount: Int                                                          │
│  ├── language: String                                                        │
│  │                                                                           │
│  ├── storageKey: String            # R2 存储路径                            │
│  ├── processedKey: String?         # 处理后路径                             │
│  ├── coverKey: String?             # 封面路径                               │
│  │                                                                           │
│  ├── status: PENDING | PROCESSING | READY | FAILED                          │
│  ├── enhancementStatus: NONE | GENERATING | READY                           │
│  │                                                                           │
│  ├── isPublic: Boolean             # 是否公开分享                           │
│  ├── createdAt: DateTime                                                     │
│  └── updatedAt: DateTime                                                     │
│                                                                               │
│  关联:                                                                       │
│  ├── UserImportProgress (阅读进度)                                          │
│  ├── UserImportHighlight (高亮)                                             │
│  └── UserImportAnnotation (标注)                                            │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V4 导入处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         V4 内容导入处理流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│   用户上传文件                                                               │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  1. 文件验证                                                          │  │
│   │     ├── 格式检查 (EPUB/PDF/HTML)                                     │  │
│   │     ├── 大小限制 (50MB)                                              │  │
│   │     ├── 病毒扫描                                                     │  │
│   │     └── 版权声明确认                                                 │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  2. 存储原文件                                                        │  │
│   │     R2: user-content/{userId}/imports/{importId}.{ext}               │  │
│   │     状态: PENDING → PROCESSING                                        │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  3. 异步处理 (Worker)                                                 │  │
│   │     ├── EPUB: 解析章节、提取元数据                                   │  │
│   │     ├── PDF: 转换为文本、识别章节                                    │  │
│   │     └── Web: 提取正文、清理 HTML                                     │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  4. 生成统一格式                                                      │  │
│   │     R2: user-content/{userId}/processed/{importId}/                  │  │
│   │     ├── content.json (元数据)                                        │  │
│   │     ├── chapters/chapter-01.html                                     │  │
│   │     └── cover.jpg (如有)                                             │  │
│   │     状态: PROCESSING → READY                                          │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                      │
│        ▼                                                                      │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │  5. 可选: 生成增强数据                                                │  │
│   │     (用户触发，付费功能)                                              │  │
│   │     ├── 热词标注                                                     │  │
│   │     ├── 段落翻译                                                     │  │
│   │     └── TTS 音频                                                     │  │
│   │     状态: enhancementStatus NONE → GENERATING → READY                 │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V4 存储配额

| 用户等级 | 导入数量 | 总存储 | 增强数据 |
|----------|----------|--------|----------|
| 免费用户 | 5 本 | 100MB | 不支持 |
| 订阅用户 | 50 本 | 1GB | 5 本/月 |
| 高级用户 | 无限 | 10GB | 无限 |

---

## V5: 社区与创作

### 功能清单

| 功能 | 描述 | 数据需求 |
|------|------|----------|
| **博客** | 用户发布读书笔记/文章 | 富文本+图片 |
| **划线分享** | 分享书中精彩段落 | 引用+评论 |
| **想法** | 简短的读书感想 | 短文本+标签 |
| **评论** | 对书籍/文章的评论 | 文字+图片+回复 |
| **个人日志** | 私密的阅读日记 | 富文本+日期 |

### V5 存储架构

```
readmigo/
├── manifests/
│   └── v5.0.0.json
│
├── epubs/                    ← 复用
├── enhancements/             ← 复用
├── user-content/             ← V4 用户导入，复用
│
└── community/                ← V5 新增：社区内容
    │
    ├── posts/                # 博客文章
    │   └── {post-id}/
    │       ├── content.json  # 文章内容 (JSON 富文本)
    │       └── images/       # 文章图片
    │           ├── {image-id}.jpg
    │           └── {image-id}.jpg
    │
    ├── highlights/           # 划线分享
    │   └── {share-id}.json   # 分享数据
    │
    ├── thoughts/             # 想法
    │   └── {thought-id}.json
    │
    └── journals/             # 个人日志 (私密)
        └── {user-id}/
            └── {date}/
                ├── entry.json
                └── images/
```

### V5 数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         V5 社区数据模型                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Post (博客文章)                                                     │    │
│  │  ├── id: UUID                                                        │    │
│  │  ├── userId: String                                                  │    │
│  │  ├── title: String                                                   │    │
│  │  ├── content: JSON (富文本)                                         │    │
│  │  ├── excerpt: String (摘要)                                         │    │
│  │  ├── coverImage: String?                                            │    │
│  │  ├── tags: String[]                                                 │    │
│  │  ├── bookId: String? (关联书籍)                                     │    │
│  │  ├── status: DRAFT | PUBLISHED | ARCHIVED                           │    │
│  │  ├── visibility: PUBLIC | FOLLOWERS | PRIVATE                       │    │
│  │  ├── likeCount: Int                                                 │    │
│  │  ├── commentCount: Int                                              │    │
│  │  ├── viewCount: Int                                                 │    │
│  │  ├── publishedAt: DateTime?                                         │    │
│  │  └── createdAt: DateTime                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HighlightShare (划线分享)                                           │    │
│  │  ├── id: UUID                                                        │    │
│  │  ├── userId: String                                                  │    │
│  │  ├── highlightId: String (原始高亮)                                 │    │
│  │  ├── bookId: String                                                 │    │
│  │  ├── chapterId: String                                              │    │
│  │  ├── selectedText: String                                           │    │
│  │  ├── comment: String? (分享评论)                                    │    │
│  │  ├── tags: String[]                                                 │    │
│  │  ├── likeCount: Int                                                 │    │
│  │  └── createdAt: DateTime                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Thought (想法)                                                      │    │
│  │  ├── id: UUID                                                        │    │
│  │  ├── userId: String                                                  │    │
│  │  ├── content: String (限500字)                                      │    │
│  │  ├── bookId: String?                                                │    │
│  │  ├── tags: String[]                                                 │    │
│  │  ├── images: String[] (最多4张)                                     │    │
│  │  ├── likeCount: Int                                                 │    │
│  │  ├── commentCount: Int                                              │    │
│  │  └── createdAt: DateTime                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Comment (评论)                                                      │    │
│  │  ├── id: UUID                                                        │    │
│  │  ├── userId: String                                                  │    │
│  │  ├── targetType: POST | THOUGHT | HIGHLIGHT | BOOK | COMMENT        │    │
│  │  ├── targetId: String                                               │    │
│  │  ├── content: String                                                │    │
│  │  ├── images: String[] (最多2张)                                     │    │
│  │  ├── parentId: String? (回复)                                       │    │
│  │  ├── likeCount: Int                                                 │    │
│  │  └── createdAt: DateTime                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Journal (个人日志) - 私密                                           │    │
│  │  ├── id: UUID                                                        │    │
│  │  ├── userId: String                                                  │    │
│  │  ├── date: Date                                                     │    │
│  │  ├── content: JSON (富文本)                                         │    │
│  │  ├── mood: String? (心情标签)                                       │    │
│  │  ├── readingTime: Int? (当日阅读时长)                               │    │
│  │  ├── booksRead: String[] (关联书籍)                                 │    │
│  │  ├── images: String[]                                               │    │
│  │  ├── isEncrypted: Boolean (是否加密)                                │    │
│  │  └── createdAt: DateTime                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V5 富文本内容格式

```json
// Post/Journal content 字段格式 (基于 ProseMirror/TipTap)
{
  "type": "doc",
  "content": [
    {
      "type": "heading",
      "attrs": { "level": 1 },
      "content": [{ "type": "text", "text": "我的读书笔记" }]
    },
    {
      "type": "paragraph",
      "content": [
        { "type": "text", "text": "这是一段普通文字，" },
        { "type": "text", "marks": [{ "type": "bold" }], "text": "这是加粗" },
        { "type": "text", "text": "。" }
      ]
    },
    {
      "type": "blockquote",
      "content": [
        {
          "type": "paragraph",
          "content": [{ "type": "text", "text": "书中的引用..." }]
        }
      ],
      "attrs": {
        "bookId": "book-042",
        "chapterId": "chapter-01",
        "highlightId": "highlight-123"
      }
    },
    {
      "type": "image",
      "attrs": {
        "src": "community/posts/{post-id}/images/{image-id}.jpg",
        "alt": "图片描述",
        "width": 800
      }
    }
  ]
}
```

---

## 版本间存储对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         各版本存储增量对比                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  版本     内容类型              存储位置             增量大小    累计        │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                               │
│  V1.0.0   电子书 EPUB           /epubs/              150MB                   │
│           书籍封面              /covers/books/        60MB                   │
│           作者头像              /authors/             20MB                   │
│           ─────────────────────────────────────────────────                 │
│           小计                                       230MB      230MB       │
│                                                                               │
│  V2.0.0   有声书音频            /audiobooks/          15GB                   │
│           有声书封面            /covers/audiobooks/   30MB                   │
│           ─────────────────────────────────────────────────                 │
│           小计                                       ~15GB      ~15.2GB     │
│                                                                               │
│  V3.0.0   时间戳数据            /enhancements/        150MB                  │
│           热词数据              /enhancements/        300MB                  │
│           段落解析              /enhancements/        600MB                  │
│           人声音频 (可选)       /enhancements/tts/    15GB                   │
│           ─────────────────────────────────────────────────                 │
│           小计 (无音频)                              ~1GB       ~16.2GB     │
│           小计 (含音频)                              ~16GB      ~31.2GB     │
│                                                                               │
│  V4.0.0   用户导入内容          /user-content/        用户驱动               │
│           ─────────────────────────────────────────────────                 │
│           估算 (1000用户×100MB)                      ~100GB     ~131GB      │
│                                                                               │
│  V5.0.0   博客文章+图片         /community/posts/     用户驱动               │
│           划线分享              /community/highlights/ 极小                  │
│           想法+图片             /community/thoughts/  用户驱动               │
│           个人日志              /community/journals/  用户驱动               │
│           ─────────────────────────────────────────────────                 │
│           估算 (1000用户×50MB)                       ~50GB      ~181GB      │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Manifest 版本演进

```json
// v3.0.0.json
{
  "version": "3.0.0",
  "content": {
    "ebooks": { "count": 300, "ids": [...] },
    "authors": { "count": 100, "ids": [...] },
    "audiobooks": { "count": 150, "ids": [...], "enabled": true },
    "enhancements": {
      "enabled": true,
      "features": ["timestamps", "hotwords", "paragraphs", "tts"],
      "booksWithEnhancements": ["book-001", "book-002", ...]
    }
  },
  "features": {
    "audiobooks": true,
    "smartReading": true,
    "hotwords": true,
    "paragraphAnalysis": true,
    "readAlongHighlight": true
  }
}

// v4.0.0.json
{
  "version": "4.0.0",
  "content": { ... },
  "features": {
    ...v3Features,
    "userImport": true,
    "importEnhancement": true,
    "supportedFormats": ["epub", "pdf", "web"]
  }
}

// v5.0.0.json
{
  "version": "5.0.0",
  "content": { ... },
  "features": {
    ...v4Features,
    "blog": true,
    "highlightShare": true,
    "thoughts": true,
    "comments": true,
    "journal": true,
    "socialFeed": true
  }
}
```

---

## API 版本策略

| 版本 | API 路径 | 新增端点 |
|------|----------|----------|
| V1-V2 | /api/v1 | 基础 + 有声书 |
| V3 | /api/v1 | /books/{id}/enhancements |
| V4 | /api/v1 | /imports, /imports/{id}/enhance |
| V5 | /api/v1 | /posts, /thoughts, /journals, /feed |

> 所有版本共用 /api/v1，通过 manifest features 控制客户端功能

---

## 执行优先级建议

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         V3-V5 执行优先级                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  V3 智能阅读 (建议分阶段)                                                    │
│  ├── V3.0: 系统 TTS (无需预处理，即时可用)                                  │
│  ├── V3.1: 热词标注 (批量预处理 300 书)                                     │
│  ├── V3.2: 段落解析 (批量预处理 300 书)                                     │
│  └── V3.3: 边读边听 (需要有声书时间戳对齐)                                  │
│                                                                               │
│  V4 内容导入 (核心功能)                                                      │
│  ├── V4.0: EPUB 导入 (最常见格式)                                           │
│  ├── V4.1: PDF 导入 (技术复杂度高)                                          │
│  └── V4.2: 网页保存 (需要内容提取)                                          │
│                                                                               │
│  V5 社区创作 (社交功能)                                                      │
│  ├── V5.0: 划线分享 + 想法 (轻量)                                           │
│  ├── V5.1: 评论系统                                                         │
│  ├── V5.2: 博客功能 (富文本编辑器)                                          │
│  └── V5.3: 个人日志                                                         │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*文档版本: 1.0*
*创建日期: 2025-12-31*
*关联文档: v1-fullstack-release-plan.md, r2-versioning-strategy.md*

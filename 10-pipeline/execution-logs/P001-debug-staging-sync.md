# P001: Debug → Staging 同步流水线

> 将书单内容从 Debug 环境同步到 Staging 环境的完整流水线

---

## 一、流水线概述

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           P001 流水线全景                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌───────────────┐                                                                  │
│   │    输入       │                                                                  │
│   │   书单文件    │                                                                  │
│   │ (电子书+有声书)│                                                                  │
│   └───────┬───────┘                                                                  │
│           │                                                                          │
│           ▼                                                                          │
│   ┌───────────────────────────────────────────────────────────────────────────────┐ │
│   │                              处理流水线                                         │ │
│   │                                                                                 │ │
│   │   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌────────┐ ┌────────┐ ┌────────┐│ │
│   │   │Stage 1 │►│Stage 2 │►│Stage 3 │►│Stage 4 │►│ 4.5   │►│ 4.6   │►│ 4.7   │►│ 4.8   │►│ 4.9   │►│ 4.10  │►│Stage 5 │►│Stage 6 │►│Stage 7 ││ │
│   │   │输入验证│ │表结构  │ │文件上传│ │数据填充│ │分类   │ │Tab    │ │头像   │ │推荐   │ │标题   │ │翻译   │ │元数据  │ │API验证 │ │部署    ││ │
│   │   └────────┘ └────────┘ └────────┘ └────────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └────────┘ └────────┘ └────────┘│ │
│   │                                                                                            │ │
│   └────────────────────────────────────────────────────────────────────────────────────────────┘ │
│           │                                                                          │
│           ▼                                                                          │
│   ┌───────────────┐                                                                  │
│   │    输出       │                                                                  │
│   │ Staging 环境  │                                                                  │
│   │   完整数据    │                                                                  │
│   └───────────────┘                                                                  │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.1 基本信息

| 属性 | 值 |
|------|-----|
| 流水线编号 | P001 |
| 名称 | Debug → Staging 同步 |
| 输入来源 | `data/booklists/v1/phase1-ebooks.json`, `data/booklists/v1/phase1-authors.json` |
| 输出目标 | Staging 环境 (数据库 + R2 存储) |
| 数据来源 | Debug 环境 (优先) + Standard Ebooks (备选) |
| 执行模式 | 手动触发 (Droplet PM2) |

### 1.2 使用场景

| 场景 | 描述 |
|------|------|
| 新书上架 | 将验证过的新书从 Debug 同步到 Staging |
| 版本发布准备 | 发布前将完整书单同步到 Staging |
| 内容更新 | 更新现有书籍的元数据或文件 |

### 1.3 Phase 1 同步流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Phase 1 Staging 同步流程                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐                         ┌─────────────────────┐
│   SOURCE: Debug     │                         │  TARGET: Staging    │
│      环境           │                         │       环境          │
└─────────────────────┘                         └─────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1. 数据源: Phase 1 书单 JSON                                                     │
│                                                                                  │
│    data/booklists/v1/                                                            │
│    ├── phase1-ebooks.json   ← 248 本唯一电子书 (去重后，原始300条含52条重复)        │
│    └── phase1-authors.json  ← 100 位作者                                         │
│                                                                                  │
│    生成脚本: scripts/extract-phase1-lists.ts                                     │
│    原始数据: docs/06-content/staging-phase1-booklist.md                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 2. 作者同步 (100位)                                                              │
│                                                                                  │
│    ┌──────────────────────┐         ┌──────────────────────┐                    │
│    │ Debug Neon DB        │ ──────▶ │ Staging Neon DB      │                    │
│    │ (authors 表)         │  SQL    │ (authors 表)         │                    │
│    │ 606 authors          │ INSERT  │ → ~75-100 authors    │                    │
│    └──────────────────────┘         └──────────────────────┘                    │
│                                                                                  │
│    匹配方式: 按作者名称在 Debug DB 中查找                                          │
│    注意: 约 25 位作者在 Debug DB 中不存在                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 3. 书籍同步 (248本)                                                              │
│                                                                                  │
│    ┌──────────────────────┐         ┌──────────────────────┐                    │
│    │ Debug Neon DB        │ ──────▶ │ Staging Neon DB      │                    │
│    │ (books 表)           │  SQL    │ (books 表)           │                    │
│    │ 65,208 books         │ INSERT  │ → ~205 books         │                    │
│    └──────────────────────┘         └──────────────────────┘                    │
│                                                                                  │
│    匹配方式: 按书名在 Debug DB 中查找 (模糊匹配)                                    │
│    注意: 约 48 本书在 Debug DB 中找不到                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 4. 文件同步 (EPUB/封面)                                                          │
│                                                                                  │
│    ┌──────────────────────┐         ┌──────────────────────┐                    │
│    │ Debug R2 Bucket      │ ──────▶ │ Staging R2 Bucket    │                    │
│    │ readmigo-debug       │  COPY   │ readmigo-staging     │                    │
│    │                      │         │                      │                    │
│    │ epubs/               │         │ epubs/               │                    │
│    │   ├── standard-ebooks│         │   ├── standard-ebooks│                    │
│    │   │   └── {slug}.epub│         │   │   └── {slug}.epub│                    │
│    │   └── misc/          │         │   └── misc/          │                    │
│    │       └── {hash}.epub│         │       └── {hash}.epub│                    │
│    │                      │         │                      │                    │
│    │ covers/              │         │ covers/              │                    │
│    │   ├── standard-ebooks│         │   ├── standard-ebooks│                    │
│    │   │   └── {slug}.jpg │         │   │   └── {slug}.jpg │                    │
│    │   └── misc/          │         │   └── misc/          │                    │
│    │       └── {hash}.jpg │         │       └── {hash}.jpg │                    │
│    └──────────────────────┘         └──────────────────────┘                    │
│                                                                                  │
│    如果 Debug R2 没有文件，则从 Standard Ebooks 下载                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 5. 章节同步                                                                      │
│                                                                                  │
│    ┌──────────────────────┐         ┌──────────────────────┐                    │
│    │ Debug Neon DB        │ ──────▶ │ Staging Neon DB      │                    │
│    │ (chapters 表)        │  SQL    │ (chapters 表)        │                    │
│    └──────────────────────┘ INSERT  └──────────────────────┘                    │
│                                                                                  │
│    关联书籍的章节数据                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              环境配置                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│ Debug 环境:                                                                      │
│   DB: ep-old-credit-a1l7vifg.ap-southeast-1.aws.neon.tech                       │
│   R2: readmigo-debug bucket                                                      │
│                                                                                  │
│ Staging 环境:                                                                    │
│   DB: ep-shy-cloud-a1depd3i.ap-southeast-1.aws.neon.tech                        │
│   R2: readmigo-staging bucket                                                    │
│                                                                                  │
│ 运行位置: Droplet (mcloud88.com / 159.65.143.131)                                │
│   用户: readmigo                                                                 │
│   使用 PM2 管理任务                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              预期结果                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│ Staging DB:                                                                      │
│   ├── authors: ~75-100 条记录 (部分作者可能在 Debug 中找不到)                      │
│   ├── books: ~205 条记录 (约 48 本在 Debug 中找不到)                              │
│   └── chapters: 关联章节数据                                                     │
│                                                                                  │
│ Staging R2:                                                                      │
│   ├── epubs/standard-ebooks/{slug}.epub                                          │
│   ├── epubs/misc/{hash}.epub                                                     │
│   ├── covers/standard-ebooks/{slug}.jpg                                          │
│   └── covers/misc/{hash}.jpg                                                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、输入规范

### 2.1 书单文件格式

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              书单输入格式                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   书单文件位置: data/booklists/{version}/                                             │
│                                                                                       │
│   Phase 1 文件:                                                                       │
│   ├── phase1-ebooks.json    - 电子书列表                                             │
│   └── phase1-authors.json   - 作者列表                                               │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  phase1-ebooks.json 结构                                                     │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  {                                                                           │   │
│   │    "totalInDocument": 300,        // 原始文档中的书籍数                       │   │
│   │    "totalUnique": 248,            // 去重后的唯一书籍数                       │   │
│   │    "note": "...",                 // 重复说明                                 │   │
│   │    "generatedAt": "...",          // 生成时间                                 │   │
│   │    "books": [                                                                 │   │
│   │      {                                                                        │   │
│   │        "title": "Pride and Prejudice",                                       │   │
│   │        "author": "Jane Austen",                                              │   │
│   │        "chineseTitle": "傲慢与偏见",                                          │   │
│   │        "section": "1.1 P0 核心必选..."                                        │   │
│   │      }                                                                        │   │
│   │    ]                                                                          │   │
│   │  }                                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  phase1-authors.json 结构                                                    │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  {                                                                           │   │
│   │    "total": 100,                  // 作者总数                                 │   │
│   │    "generatedAt": "...",          // 生成时间                                 │   │
│   │    "authors": [                                                               │   │
│   │      {                                                                        │   │
│   │        "name": "William Shakespeare",                                        │   │
│   │        "nationality": "英国 UK",                                              │   │
│   │        "era": "16-17世纪 16-17th C",                                         │   │
│   │        "representativeWork": "37"                                             │   │
│   │      }                                                                        │   │
│   │    ]                                                                          │   │
│   │  }                                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   生成命令: npx tsx scripts/extract-phase1-lists.ts                                  │
│   原始数据: docs/06-content/staging-phase1-booklist.md                               │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 输入验证规则

| 字段 | 验证规则 |
|------|----------|
| identifier | 必填，唯一，格式符合来源规范 |
| source | 必填，在允许的来源列表内 |
| title | 必填，非空字符串 |
| priority | 必填，P0/P1/P2 之一 |
| language | 必填，支持的语言代码 |

---

## 三、阶段定义

### 3.1 Stage 1: 输入验证

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 1: 输入验证                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │  读取书单   │───►│  格式校验   │───►│  重复检测   │───►│  依赖检查   │         │
│   │             │    │             │    │             │    │             │         │
│   │ • JSON 解析 │    │ • 必填字段  │    │ • Staging中 │    │ • 作者存在  │         │
│   │ • 编码验证  │    │ • 类型检查  │    │ • 已存在书  │    │ • 分类存在  │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   输出:                                                                               │
│   ├── validated_ebooks[]    - 验证通过的电子书列表                                    │
│   ├── validated_audiobooks[] - 验证通过的有声书列表                                   │
│   ├── skipped[]             - 跳过的条目 (已存在/重复)                                │
│   └── errors[]              - 验证失败的条目                                          │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 检查项 | 说明 | 失败处理 |
|--------|------|----------|
| JSON 格式 | 文件必须是有效 JSON | 终止流水线 |
| 必填字段 | 所有必填字段存在 | 记录错误，跳过条目 |
| ID 唯一性 | 书单内无重复 ID | 记录警告，保留第一个 |
| Staging 查重 | 检查 Staging 是否已有 | 跳过，记录日志 |
| 依赖检查 | 作者/分类是否存在 | 记录警告，后续自动创建 |

### 3.2 Stage 2: 表结构同步

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 2: 表结构同步                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          Debug 环境                                          │   │
│   │                                                                               │   │
│   │   books ──┐                                                                   │   │
│   │   authors ├── 读取 Schema 和数据                                             │   │
│   │   audiobooks                                                                  │   │
│   └──────────────────────────────────────┬──────────────────────────────────────┘   │
│                                          │                                           │
│                                          ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Schema 比对                                          │   │
│   │                                                                               │   │
│   │   • 检查表结构是否一致                                                        │   │
│   │   • 识别新增/修改的字段                                                       │   │
│   │   • 生成迁移脚本 (如需要)                                                     │   │
│   └──────────────────────────────────────┬──────────────────────────────────────┘   │
│                                          │                                           │
│                                          ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Staging 环境                                         │   │
│   │                                                                               │   │
│   │   • 执行必要的迁移                                                            │   │
│   │   • 验证表结构一致                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 操作 | 说明 |
|------|------|
| Schema 读取 | 读取 Debug 环境的表结构 |
| Schema 比对 | 与 Staging 环境比对差异 |
| 迁移生成 | 生成必要的 ALTER 语句 |
| 迁移执行 | 在 Staging 执行迁移 |
| 验证确认 | 确认表结构一致 |

### 3.3 Stage 3: 文件上传

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 3: 文件上传                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌────────────────────────────────┐       ┌────────────────────────────────┐       │
│   │       Debug R2 Bucket          │       │      Staging R2 Bucket         │       │
│   │                                │       │                                │       │
│   │   readmigo-debug/              │  ───► │   readmigo-staging/            │       │
│   │   ├── epubs/                   │       │   ├── epubs/                   │       │
│   │   │   └── {book-id}.epub       │       │   │   └── {book-id}.epub       │       │
│   │   ├── covers/                  │       │   ├── covers/                  │       │
│   │   │   └── books/               │       │   │   └── books/               │       │
│   │   ├── audiobooks/              │       │   ├── audiobooks/              │       │
│   │   │   └── {book-id}/           │       │   │   └── {book-id}/           │       │
│   │   │       └── chapters/        │       │   │       └── chapters/        │       │
│   │   └── authors/                 │       │   └── authors/                 │       │
│   │                                │       │                                │       │
│   └────────────────────────────────┘       └────────────────────────────────┘       │
│                                                                                       │
│   处理流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │  清单生成   │───►│  存在检查   │───►│  文件复制   │───►│  完整性验证  │         │
│   │             │    │             │    │             │    │             │         │
│   │ • 列出需要  │    │ • 检查目标  │    │ • R2 复制   │    │ • 大小校验  │         │
│   │   的文件    │    │   是否已有  │    │ • 进度追踪  │    │ • 哈希对比  │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 文件类型 | 来源路径 | 目标路径 | 处理方式 |
|----------|----------|----------|----------|
| EPUB 文件 | epubs/{id}.epub | epubs/{id}.epub | 直接复制 |
| 书籍封面 | covers/books/{id}.jpg | covers/books/{id}.jpg | 直接复制 |
| 封面缩略图 | covers/books/{id}-thumb.jpg | covers/books/{id}-thumb.jpg | 直接复制 |
| 音频文件 | audiobooks/{id}/chapters/*.mp3 | audiobooks/{id}/chapters/*.mp3 | 直接复制 |
| 作者头像 | authors/{id}/*.jpg | authors/{id}/*.jpg | 直接复制 |

### 3.4 Stage 4: 数据填充

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 4: 数据填充                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   数据来源:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          公开渠道 (非 Seed)                                   │   │
│   │                                                                               │   │
│   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               │   │
│   │   │ Gutenberg │  │ Standard  │  │  Wikidata │  │ LibriVox  │               │   │
│   │   │           │  │  Ebooks   │  │           │  │           │               │   │
│   │   │ • 元数据  │  │ • 元数据  │  │ • 作者信息│  │ • 音频    │               │   │
│   │   │ • 章节    │  │ • 章节    │  │ • 链接    │  │ • 朗读者  │               │   │
│   │   └───────────┘  └───────────┘  └───────────┘  └───────────┘               │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   填充流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │  作者处理   │───►│  书籍填充   │───►│  章节解析   │───►│  关联建立   │         │
│   │             │    │             │    │             │    │             │         │
│   │ • 新作者创建│    │ • 元数据   │    │ • EPUB 解析│    │ • 书-作者   │         │
│   │ • 信息增强  │    │ • 分类映射 │    │ • 目录提取 │    │ • 电子-有声 │         │
│   │ (Wikidata)  │    │ • 难度分析 │    │             │    │             │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   数据表填充顺序:                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                               │   │
│   │   1. authors     ──►  2. books       ──►  3. chapters                        │   │
│   │                           │                                                   │   │
│   │                           ▼                                                   │   │
│   │                      4. audiobooks   ──►  5. audio_chapters                  │   │
│   │                           │                                                   │   │
│   │                           ▼                                                   │   │
│   │                      6. book_audiobook_links                                 │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 数据表 | 数据来源 | 填充内容 |
|--------|----------|----------|
| authors | Wikidata / 手动 | 姓名、生卒年、简介、头像URL |
| books | Gutenberg / Standard Ebooks | 书名、描述、分类、难度、封面URL |
| chapters | EPUB 解析 | 章节标题、顺序、内容路径 |
| audiobooks | LibriVox | 书名、朗读者、时长、音频URL |
| audio_chapters | LibriVox | 章节音频、时长、顺序 |
| book_audiobook_links | 关联逻辑 | 电子书-有声书对应关系 |

### 3.5 Stage 4.5: 分类数据生成 (Category Generation)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.5: 分类数据生成 (从书籍计算)                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ⚠️ 核心原则: 禁止 Seed，所有分类数据必须从实际书籍数据计算生成                        │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          数据来源: 书籍 genres 字段                          │   │
│   │                                                                               │   │
│   │   Book Table                                                                  │   │
│   │   ├── genres: ["Fiction", "Historical Fiction", "Romance"]                   │   │
│   │   ├── genres: ["Mystery", "Detective Fiction"]                               │   │
│   │   └── genres: ["Classic Literature", "Drama"]                                │   │
│   │                                        │                                      │   │
│   │                                        ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Genre 归一化 & 层级映射                            │   │   │
│   │   │                                                                       │   │   │
│   │   │   "fiction" → "Fiction"                                              │   │   │
│   │   │   "classics" → "Classics"                                            │   │   │
│   │   │   "childrens" → "Children's Literature"                              │   │   │
│   │   │   "classic literature" → "Classics"                                  │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                        │                                      │   │
│   │                                        ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                    层级分类结构                                       │   │   │
│   │   │                                                                       │   │   │
│   │   │   Root Categories (level=0)          Child Categories (level=1)      │   │   │
│   │   │   ├── Fiction ────────────────────► Literary Fiction                 │   │   │
│   │   │   │                                  Historical Fiction              │   │   │
│   │   │   │                                  Gothic Fiction                  │   │   │
│   │   │   │                                                                  │   │   │
│   │   │   ├── Mystery & Thriller ─────────► Mystery                         │   │   │
│   │   │   │                                  Detective Fiction              │   │   │
│   │   │   │                                  Horror                         │   │   │
│   │   │   │                                                                  │   │   │
│   │   │   ├── Adventure & Fantasy ────────► Adventure                       │   │   │
│   │   │   │                                  Fantasy                        │   │   │
│   │   │   │                                  Science Fiction                │   │   │
│   │   │   │                                                                  │   │   │
│   │   │   ├── Classics ───────────────────► Classic Literature              │   │   │
│   │   │   │                                  Epic                           │   │   │
│   │   │   │                                                                  │   │   │
│   │   │   ├── Drama & Poetry ─────────────► Drama, Poetry, Comedy           │   │   │
│   │   │   ├── Children's & Young Adult ───► Children's Literature           │   │   │
│   │   │   ├── Romance & Family ───────────► Romance, Family                 │   │   │
│   │   │   └── Nonfiction ─────────────────► Biography, Philosophy           │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   处理流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │  清理旧数据  │───►│  读取书籍   │───►│  生成分类   │───►│  创建关联   │         │
│   │  (可选)     │    │  genres     │    │  层级结构   │    │  更新计数   │         │
│   │             │    │             │    │             │    │             │         │
│   │ --clean 模式│    │ • 归一化    │    │ • Root 分类 │    │ • BookCategory │      │
│   │ 删除旧分类  │    │ • 去重统计  │    │ • Child 分类│    │ • bookCount    │      │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   输出表:                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                               │   │
│   │   categories (分类表)                  book_categories (关联表)              │   │
│   │   ├── id                               ├── bookId                            │   │
│   │   ├── name / nameEn                    ├── categoryId                        │   │
│   │   ├── slug (唯一)                      ├── isPrimary                         │   │
│   │   ├── level (0=root, 1=child)          └── createdAt                         │   │
│   │   ├── parentId (指向 root)                                                   │   │
│   │   ├── bookCount (直接关联数)                                                 │   │
│   │   └── isActive                                                               │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   执行脚本: scripts/generate-categories-from-books.ts                               │
│                                                                                       │
│   命令:                                                                               │
│   npx tsx scripts/generate-categories-from-books.ts --db=staging           # 增量    │
│   npx tsx scripts/generate-categories-from-books.ts --db=staging --clean   # 重建    │
│   npx tsx scripts/generate-categories-from-books.ts --dry-run              # 预览    │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 Stage 4.6: 发现页 Tab 生成 (Discover Tabs)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.6: 发现页 Tab 生成                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   依赖: Stage 4.5 完成后执行                                                          │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          数据来源: categories 表                             │   │
│   │                                                                               │   │
│   │   categories (level=0, isActive=true)                                        │   │
│   │   ├── Fiction          ──► 直接关联书籍数 + 子分类关联书籍数 = 总数           │   │
│   │   ├── Classics         ──► 207 books                                         │   │
│   │   ├── Adventure        ──► 49 books                                          │   │
│   │   └── ...                                                                     │   │
│   │                                                                               │   │
│   │   ⚠️ 注意: bookCount 需要包含:                                                │   │
│   │      1. 直接关联到 Root 分类的书籍 (book.genres 包含 "Classics")             │   │
│   │      2. 关联到 Child 分类的书籍 (book.genres 包含 "Classic Literature")      │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   输出表: discover_tabs                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                               │   │
│   │   discover_tabs                                                              │   │
│   │   ├── id                                                                      │   │
│   │   ├── slug            (来自 category.slug)                                   │   │
│   │   ├── name / nameEn   (来自 category)                                        │   │
│   │   ├── type = "category"                                                       │   │
│   │   ├── categoryId      (关联 category)                                        │   │
│   │   ├── icon            (根据 slug 映射)                                        │   │
│   │   ├── sortOrder       (按书籍数量降序)                                        │   │
│   │   └── isActive                                                                │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   执行脚本: scripts/sync-discover-tabs.ts                                           │
│                                                                                       │
│   命令:                                                                               │
│   DATABASE_URL='staging-url' npx tsx scripts/sync-discover-tabs.ts                  │
│                                                                                       │
│   ⚠️ 缓存注意: API 返回的 discover/tabs 数据会被 Redis 缓存 1 小时                   │
│               更新数据库后需等待缓存过期或手动清理                                     │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 Stage 4.7: 作者头像修复 (Author Avatar Fix)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.7: 作者头像修复                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题背景:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   作者数据可能存在重复记录:                                                    │   │
│   │                                                                               │   │
│   │   作者 A (主记录)              作者 A' (重复记录)                              │   │
│   │   ├── name: "Shakespeare"      ├── name: "William Shakespeare"               │   │
│   │   ├── books: 9 本              ├── books: 1 本                                │   │
│   │   ├── avatarUrl: null ❌       ├── avatarUrl: "https://..." ✓                │   │
│   │   └── wikidataId: ...          └── wikidataId: ...                            │   │
│   │                                                                               │   │
│   │   原因: 不同书籍来源使用不同的作者名格式                                        │   │
│   │   - Standard Ebooks: "William Shakespeare"                                    │   │
│   │   - Gutenberg: "Shakespeare, William"                                         │   │
│   │   - 作者头像可能只关联到其中一个记录                                            │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   修复流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │ 查询有头像  │───►│ 归一化名称  │───►│ 查询无头像  │───►│ 匹配并更新  │         │
│   │ 的作者      │    │ 建立映射    │    │ 的作者      │    │             │         │
│   │             │    │             │    │             │    │             │         │
│   │ avatarUrl   │    │ normalize() │    │ avatarUrl   │    │ UPDATE      │         │
│   │ IS NOT NULL │    │ name→avatar │    │ IS NULL     │    │ SET avatar  │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   归一化规则:                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   1. 转小写: "William Shakespeare" → "william shakespeare"                   │   │
│   │   2. 移除逗号: "Shakespeare, William" → "shakespeare william"                │   │
│   │   3. 移除年份: "Mark Twain 1835-1910" → "mark twain"                         │   │
│   │   4. 合并空格: "jane   austen" → "jane austen"                               │   │
│   │                                                                               │   │
│   │   示例匹配:                                                                    │   │
│   │   "William Shakespeare" ─┐                                                    │   │
│   │   "Shakespeare, William" ├──► normalize() ──► "shakespeare william" ✓        │   │
│   │   "shakespeare william"  ─┘                                                   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   执行脚本: scripts/fix-author-avatars.ts                                            │
│                                                                                       │
│   命令:                                                                               │
│   DATABASE_URL='staging-url' npx tsx scripts/fix-author-avatars.ts                  │
│                                                                                       │
│   预期输出:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   Avatar sources: 82                                                         │   │
│   │   Fixed: William Shakespeare                                                 │   │
│   │   Fixed: Dante Alighieri                                                     │   │
│   │   Fixed: Mark Twain                                                          │   │
│   │   Fixed: Jane Austen                                                         │   │
│   │   ...                                                                         │   │
│   │   Total fixed: 7                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.8 Stage 4.8: 推荐服务验证 (Recommendation Service Validation)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.8: 推荐服务验证                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题背景:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   推荐服务按分类筛选时需要包含子分类的书籍                                       │   │
│   │                                                                               │   │
│   │   错误实现 ❌:                                                                 │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │   where: {                                                           │   │   │
│   │   │     categories: { some: { categoryId: parentCategoryId } }          │   │   │
│   │   │   }                                                                  │   │   │
│   │   │   // 只查询直接关联到父分类的书籍                                      │   │   │
│   │   │   // 漏掉关联到子分类的书籍!                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                               │   │
│   │   正确实现 ✓:                                                                 │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │   // 先查询子分类                                                     │   │   │
│   │   │   const childCategories = await prisma.category.findMany({          │   │   │
│   │   │     where: { parentId: categoryId, isActive: true },                │   │   │
│   │   │   });                                                                │   │   │
│   │   │   const categoryIds = [categoryId, ...childCategories.map(c=>c.id)];│   │   │
│   │   │                                                                      │   │   │
│   │   │   where: {                                                           │   │   │
│   │   │     categories: { some: { categoryId: { in: categoryIds } } }       │   │   │
│   │   │   }                                                                  │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   验证流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │ 获取所有    │───►│ 逐个分类    │───►│ 验证返回    │───►│ 记录结果    │         │
│   │ 父分类      │    │ 调用 API    │    │ 书籍数量    │    │             │         │
│   │             │    │             │    │             │    │             │         │
│   │ level = 0   │    │ categoryId  │    │ total > 0   │    │ 成功/失败   │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   验证命令:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   # 获取所有分类的书籍数量                                                     │   │
│   │   for tab in $(curl -s $API/discover/tabs | jq -r '.[].categoryId'); do      │   │
│   │     count=$(curl -s "$API/discover/books?categoryId=$tab" | jq '.total')     │   │
│   │     echo "$tab: $count books"                                                 │   │
│   │   done                                                                        │   │
│   │                                                                               │   │
│   │   预期结果 (每个分类都应有书籍):                                                │   │
│   │   classics: 199                                                               │   │
│   │   fiction: 61                                                                 │   │
│   │   adventure-fantasy: 49                                                       │   │
│   │   drama-poetry: 27                                                            │   │
│   │   mystery-thriller: 31                                                        │   │
│   │   ...                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   关键文件:                                                                           │
│   apps/backend/src/modules/recommendation/recommendation.service.ts:73-84           │
│                                                                                       │
│   ⚠️ 注意: 此验证必须在 Stage 4.5 (分类生成) 和 Stage 4.6 (Tab生成) 之后执行         │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.9 Stage 4.9: 标题清洗 (Title Cleaning)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.9: 标题清洗                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题背景:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   Standard Ebooks 导入的书籍标题包含作者后缀                                     │   │
│   │                                                                               │   │
│   │   原始格式:  "The Age of Innocence by Edith Wharton"                         │   │
│   │   期望格式:  "The Age of Innocence"                                           │   │
│   │                                                                               │   │
│   │   问题影响:                                                                    │   │
│   │   • 标题显示冗余信息                                                           │   │
│   │   • 搜索体验受影响                                                             │   │
│   │   • 多语言翻译复杂度增加                                                        │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   处理流程:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   1. 查找包含 " by " 的标题                                                    │   │
│   │   2. 提取 " by " 后的内容                                                       │   │
│   │   3. 与 author 字段对比 (智能匹配处理各种格式差异)                              │   │
│   │   4. 匹配成功则移除后缀                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   作者名匹配规则:                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   标题后缀: "Charles Dickens"                                                  │   │
│   │   作者字段: "Dickens, Charles, 1812-1870"                                      │   │
│   │                                                                               │   │
│   │   匹配过程:                                                                    │   │
│   │   1. 移除年份: "Dickens, Charles"                                              │   │
│   │   2. 移除括号内容                                                              │   │
│   │   3. 分词: ["dickens", "charles"]                                              │   │
│   │   4. 交叉匹配: 至少2个词匹配                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   执行命令:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   npx ts-node -r tsconfig-paths/register \                                    │   │
│   │     src/scripts/data-enrichment/clean-book-titles.ts                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   关键文件:                                                                           │
│   apps/backend/src/scripts/data-enrichment/clean-book-titles.ts                     │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.10 Stage 4.10: 翻译数据填充 (Translation Enrichment)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Stage 4.10: 翻译数据填充                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   目的:                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   为中文用户提供本地化的书名和作者名                                             │   │
│   │                                                                               │   │
│   │   原始 (英文):  "Pride and Prejudice" by "Jane Austen"                        │   │
│   │   翻译 (中文):  "傲慢与偏见" by "简·奥斯汀"                                    │   │
│   │                                                                               │   │
│   │   技术架构:                                                                    │   │
│   │   ┌─────────┐     ┌─────────────┐     ┌──────────────────────┐              │   │
│   │   │   API   │────►│ Locale中间件 │────►│ LocalizationService │              │   │
│   │   │ Request │     │Accept-Language│    │ (查询translations表) │              │   │
│   │   └─────────┘     └─────────────┘     └──────────────────────┘              │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   数据来源:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   优先级 1: Wikidata                                                          │   │
│   │   ├── 使用 SPARQL 查询书籍/作者的中文标签                                       │   │
│   │   ├── 直接获取 zh-Hans 和 zh-Hant 版本                                         │   │
│   │   └── API 延迟: 500ms                                                         │   │
│   │                                                                               │   │
│   │   优先级 2: 豆瓣 Douban (Fallback)                                              │   │
│   │   ├── 搜索书籍获取中文书名/作者                                                 │   │
│   │   ├── 搜索结果验证匹配度                                                        │   │
│   │   └── API 延迟: 2000ms (受限)                                                  │   │
│   │                                                                               │   │
│   │   补充: OpenCC 繁简转换                                                         │   │
│   │   ├── 从 zh-Hans 自动生成 zh-Hant                                              │   │
│   │   └── 配置: s2twp (简体到台湾繁体带词汇转换)                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   translations 表结构:                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   entityType  │ entityId  │ fieldName │ locale   │ value     │ source      │   │
│   │   ───────────┼───────────┼───────────┼──────────┼───────────┼─────────────│   │
│   │   book        │ uuid      │ title     │ zh-Hans  │ 傲慢与偏见 │ wikidata    │   │
│   │   book        │ uuid      │ title     │ zh-Hant  │ 傲慢與偏見 │ opencc      │   │
│   │   book        │ uuid      │ author    │ zh-Hans  │ 简·奥斯汀  │ wikidata    │   │
│   │   author      │ uuid      │ name      │ zh-Hans  │ 简·奥斯汀  │ wikidata    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   执行命令:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   # 快速模式 (仅 Wikidata)                                                     │   │
│   │   npx ts-node -r tsconfig-paths/register \                                    │   │
│   │     src/scripts/data-enrichment/wikidata-book-enrichment.ts 500              │   │
│   │                                                                               │   │
│   │   # 完整模式 (Douban + Wikidata + OpenCC)                                      │   │
│   │   npx ts-node -r tsconfig-paths/register \                                    │   │
│   │     src/scripts/data-enrichment/batch-enrichment.ts \                        │   │
│   │     --entity=all --limit=500                                                  │   │
│   │                                                                               │   │
│   │   # 验证覆盖率                                                                 │   │
│   │   psql $DATABASE_URL -c "SELECT locale, COUNT(*) FROM translations \          │   │
│   │     WHERE entity_type='book' GROUP BY locale"                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   关键文件:                                                                           │
│   ├── apps/backend/src/scripts/data-enrichment/wikidata-book-enrichment.ts        │
│   ├── apps/backend/src/scripts/data-enrichment/batch-enrichment.ts                │
│   ├── apps/backend/src/scripts/data-enrichment/wikidata-client.ts                 │
│   ├── apps/backend/src/scripts/data-enrichment/douban-client.ts                   │
│   ├── apps/backend/src/scripts/data-enrichment/opencc-converter.ts                │
│   ├── apps/backend/src/scripts/data-enrichment/seed-category-translations.ts     │
│   ├── apps/backend/src/scripts/data-enrichment/enrich-author-translations.ts     │
│   └── apps/backend/src/common/localization/localization.service.ts                │
│                                                                                       │
│   ⚠️ 重要: RecommendationController 已集成 LocalizationService                       │
│   ⚠️ iOS 客户端已发送 Accept-Language header                                         │
│   ⚠️ 此步骤必须在 Stage 4.9 (标题清洗) 之后执行                                       │
│                                                                                       │
│   📊 当前翻译覆盖率 (2026-01-01):                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   实体类型    │ 已翻译  │ 总数   │ 覆盖率  │ 数据来源                         │   │
│   │   ──────────┼─────────┼────────┼─────────┼──────────────────────────────────│   │
│   │   Categories │ 58/58   │ 100%   │  ✅     │ seed-category-translations.ts    │   │
│   │   Authors    │ 216/216 │ 100%   │  ✅     │ enrich-author-translations.ts    │   │
│   │   Books      │ 346/346 │ 100%   │  ✅     │ seed-book-translations.ts        │   │
│   │   ──────────┼─────────┼────────┼─────────┼──────────────────────────────────│   │
│   │   总体评估: 分类、作者、书籍翻译全部完成 (100%)                                │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.11 Stage 5: 元数据生成与验证

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 5: 元数据生成与验证                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           元数据分类                                          │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  📚 书籍核心元数据 (Book)                                                     │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  基础信息:                                                                    │   │
│   │  • title / titlePinyin / titleNormalized                                     │   │
│   │  • author / authorNormalized / authorId                                      │   │
│   │  • description                                                                │   │
│   │  • language / languageVariant                                                 │   │
│   │                                                                               │   │
│   │  分类与标签:                                                                  │   │
│   │  • subjects[] / genres[]                                                      │   │
│   │  • categories (关联表)                                                        │   │
│   │                                                                               │   │
│   │  文件引用:                                                                    │   │
│   │  • epubUrl / coverUrl / coverThumbUrl                                        │   │
│   │                                                                               │   │
│   │  统计信息:                                                                    │   │
│   │  • wordCount / chapterCount / estimatedReadingMinutes                        │   │
│   │                                                                               │   │
│   │  难度评估:                                                                    │   │
│   │  • difficultyScore / fleschScore / cefrLevel                                 │   │
│   │  • (中文) hskLevel / avgStrokeCount / characterCount                         │   │
│   │                                                                               │   │
│   │  来源追溯:                                                                    │   │
│   │  • source / sourceId / sourceUrl                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  👤 作者元数据 (Author)                                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  基础信息:                                                                    │   │
│   │  • name / aliases[] / avatarUrl                                              │   │
│   │  • bio / era / nationality / birthPlace                                      │   │
│   │                                                                               │   │
│   │  文学特征:                                                                    │   │
│   │  • writingStyle / famousWorks[] / literaryPeriod                             │   │
│   │  • literaryMovement / historicalPeriod                                       │   │
│   │  • primaryGenres[] / themes[]                                                │   │
│   │                                                                               │   │
│   │  AI 人设:                                                                     │   │
│   │  • aiPersonaPrompt / voiceStyle                                              │   │
│   │                                                                               │   │
│   │  外部链接:                                                                    │   │
│   │  • wikipediaUrl / wikidataId                                                 │   │
│   │                                                                               │   │
│   │  统计:                                                                        │   │
│   │  • bookCount / quoteCount / followerCount                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  🎧 有声书元数据 (Audiobook)                                                  │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  基础信息:                                                                    │   │
│   │  • title / author / narrator / description                                   │   │
│   │  • coverUrl / totalDuration                                                  │   │
│   │                                                                               │   │
│   │  来源信息:                                                                    │   │
│   │  • source / sourceId / sourceUrl                                             │   │
│   │  • archiveUrl / zipUrl / rssUrl                                              │   │
│   │                                                                               │   │
│   │  质量信息:                                                                    │   │
│   │  • quality / language / genres[] / publishYear                               │   │
│   │                                                                               │   │
│   │  热度数据:                                                                    │   │
│   │  • archiveDownloads / avgRating / numReviews                                 │   │
│   │                                                                               │   │
│   │  匹配字段:                                                                    │   │
│   │  • titleNormalized / authorNormalized                                        │   │
│   │  • bookId (关联电子书)                                                        │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  📖 章节元数据 (Chapter / AudiobookChapter)                                   │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  电子书章节:                                                                  │   │
│   │  • order / title / href / wordCount                                          │   │
│   │  • content / htmlContent                                                     │   │
│   │                                                                               │   │
│   │  有声书章节:                                                                  │   │
│   │  • chapterNumber / title / duration                                          │   │
│   │  • audioUrl / fileName / readerName                                          │   │
│   │  • timestamps (听读同步)                                                      │   │
│   │  • bookChapterId (关联电子书章节)                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  🌐 多语言翻译 (Translation)                                                  │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  • entityType / entityId / fieldName / locale / value                        │   │
│   │  • source: manual / douban / wikidata / wikipedia / ai / opencc              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   验证流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │  完整性检查  │───►│  格式验证   │───►│  关联验证   │───►│  质量评估   │         │
│   │             │    │             │    │             │    │             │         │
│   │ • 必填字段  │    │ • URL格式   │    │ • 作者关联  │    │ • 描述长度  │         │
│   │ • 非空检查  │    │ • 时长格式  │    │ • 分类关联  │    │ • 封面质量  │         │
│   │             │    │ • ID格式    │    │ • 书籍关联  │    │ • 数据完整度│         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 元数据类别 | 必填字段 | 可选但推荐 | 验证规则 |
|-----------|---------|-----------|---------|
| 书籍基础 | title, author, epubUrl, source | description, coverUrl | title 非空, epubUrl 格式正确 |
| 书籍难度 | - | difficultyScore, cefrLevel | 分数范围 0-1, CEFR 等级有效 |
| 作者基础 | name | bio, avatarUrl, era | name 非空 |
| 有声书 | title, totalDuration, source | narrator, coverUrl | duration > 0 |
| 章节 | order, title | wordCount | order >= 0 |

**📊 Stage 5 执行状态 (2026-01-01):**

| 指标 | 数量 | 状态 | 说明 |
|------|------|------|------|
| 活跃书籍 | 346 | ✅ | 全部 ACTIVE 状态 |
| 有章节书籍 | 206/346 | ⚠️ 60% | 140 本需要章节数据 |
| Feature Flags | 3 | ✅ | chinese_content, maintenance_mode, new_reader_ui |
| 翻译覆盖率 | 见 4.10 | ✅ | 分类、作者、书籍全部 100% |

**📌 章节解析状态 (2026-01-01 05:54):**

章节解析脚本已执行，但由于 EPUB URL 失效导致全部失败：

| URL 类型 | 数量 | 失败原因 |
|----------|------|----------|
| Gutenberg R2 | ~30 | Access Denied (存储桶未公开) |
| Standard Ebooks | ~100 | 404 (URL 格式已更改) |
| Debug R2 | ~10 | 需要认证或文件不存在 |

**后续计划：**
1. 修复 Gutenberg R2 存储桶公开访问配置
2. 更新 Standard Ebooks URL 抓取逻辑
3. 或从 Debug 本地数据库直接同步章节数据

**待处理:**
- 140 本书籍需要 EPUB 章节解析 (在 Droplet 运行 `BookEnrichmentService.enrichBatch()`)
- Debug 环境仅 1 本可同步，其余需要下载解析

### 3.6 Stage 6: API 验证 (客户端请求)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 6: API 验证                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      模拟客户端请求验证                                       │   │
│   │                                                                               │   │
│   │   Droplet ─────────────────────────────────────────────► Staging API         │   │
│   │     │                                                      │                 │   │
│   │     │   模拟 iOS/Android 客户端请求                         │                 │   │
│   │     │   (附带正确的 Headers 和认证)                         │                 │   │
│   │     │                                                      │                 │   │
│   │     └──────────────────────────────────────────────────────┘                 │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   验证场景:                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  1. 书籍列表 API                                                             │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  GET /api/v1/books                                                           │   │
│   │  GET /api/v1/books?category={id}                                             │   │
│   │  GET /api/v1/books?language=en                                               │   │
│   │  GET /api/v1/books?search={keyword}                                          │   │
│   │                                                                               │   │
│   │  验证: 新增书籍出现在列表中，分页正常，排序正确                                │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  2. 书籍详情 API                                                             │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  GET /api/v1/books/{id}                                                      │   │
│   │  GET /api/v1/books/{id}/chapters                                             │   │
│   │                                                                               │   │
│   │  验证: 书籍详情完整，章节列表正确，EPUB URL 可访问                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  3. 作者 API                                                                 │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  GET /api/v1/authors                                                         │   │
│   │  GET /api/v1/authors/{id}                                                    │   │
│   │  GET /api/v1/authors/{id}/books                                              │   │
│   │                                                                               │   │
│   │  验证: 作者信息完整，关联书籍正确                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  4. 有声书 API                                                               │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  GET /api/v1/audiobooks                                                      │   │
│   │  GET /api/v1/audiobooks/{id}                                                 │   │
│   │  GET /api/v1/audiobooks/{id}/chapters                                        │   │
│   │                                                                               │   │
│   │  验证: 有声书列表正确，章节音频 URL 可访问，时长正确                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  5. 资源文件验证                                                             │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  HEAD {epubUrl}        - EPUB 文件可访问                                     │   │
│   │  HEAD {coverUrl}       - 封面图片可访问                                       │   │
│   │  HEAD {audioUrl}       - 音频文件可访问                                       │   │
│   │                                                                               │   │
│   │  验证: HTTP 200, Content-Type 正确, Content-Length 合理                      │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  6. 发现页 API                                                               │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  GET /api/v1/discover/tabs                                                   │   │
│   │  GET /api/v1/discover/sections                                               │   │
│   │  GET /api/v1/book-lists                                                      │   │
│   │                                                                               │   │
│   │  验证: 新书出现在相应推荐位置                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| API 类别 | 验证项 | 预期结果 | 失败处理 |
|---------|--------|---------|---------|
| 书籍列表 | 新书可见性 | 新增书籍出现在列表 | 警告 + 继续 |
| 书籍详情 | 数据完整性 | 所有字段正确返回 | 错误 + 记录 |
| 文件访问 | URL 可达性 | HTTP 200 | 错误 + 重试上传 |
| 章节内容 | 章节数量 | 与 DB 一致 | 错误 + 记录 |
| 有声书 | 音频可播放 | HEAD 200, 时长 > 0 | 错误 + 记录 |

### 3.7 Stage 7: 部署确认

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Stage 7: 部署确认                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         部署前检查                                            │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                               │   │
│   │   □ Stage 1-6 全部通过                                                        │   │
│   │   □ 错误数量在可接受范围内                                                    │   │
│   │   □ 关键书籍全部成功                                                          │   │
│   │   □ API 验证通过率 > 95%                                                      │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   部署流程:                                                                           │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│   │ 缓存清理    │───►│ 服务重启    │───►│ 健康检查    │───►│ 通知完成    │         │
│   │             │    │ (可选)      │    │             │    │             │         │
│   │ • Redis     │    │ • Staging   │    │ • API 健康  │    │ • Slack     │         │
│   │ • CDN       │    │   服务      │    │ • DB 连接   │    │ • 邮件      │         │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         缓存清理操作                                          │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                               │   │
│   │   Redis 缓存:                                                                 │   │
│   │   • books:list:*         - 书籍列表缓存                                       │   │
│   │   • books:detail:{id}    - 书籍详情缓存                                       │   │
│   │   • authors:list:*       - 作者列表缓存                                       │   │
│   │   • audiobooks:*         - 有声书相关缓存                                     │   │
│   │   • discover:*           - 发现页缓存                                         │   │
│   │                                                                               │   │
│   │   CDN 缓存 (Cloudflare):                                                      │   │
│   │   • 清理新增封面 URL                                                          │   │
│   │   • 清理 API 响应缓存 (如有)                                                  │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         健康检查                                              │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                               │   │
│   │   GET https://staging-api.readmigo.app/api/v1/health                         │   │
│   │                                                                               │   │
│   │   验证响应:                                                                   │   │
│   │   • status: "ok"                                                              │   │
│   │   • database: "connected"                                                     │   │
│   │   • redis: "connected"                                                        │   │
│   │   • r2: "accessible"                                                          │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         完成通知                                              │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                               │   │
│   │   通知内容:                                                                   │   │
│   │   • 流水线运行 ID                                                             │   │
│   │   • 执行时长                                                                  │   │
│   │   • 成功/失败统计                                                             │   │
│   │   • 新增书籍/有声书数量                                                       │   │
│   │   • 失败条目列表 (如有)                                                       │   │
│   │   • 日志文件链接                                                              │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

| 步骤 | 操作 | 触发条件 | 失败处理 |
|------|------|---------|---------|
| 缓存清理 | 清除 Redis + CDN | 始终执行 | 警告 + 继续 |
| 服务重启 | 重启 Staging 服务 | 有 Schema 变更时 | 回滚 |
| 健康检查 | API 健康检查 | 缓存清理后 | 终止 + 告警 |
| 通知 | 发送完成通知 | 始终执行 | 记录日志 |

---

## 四、执行流程

### 4.1 完整执行流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           P001 执行流程详图                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────┐                                                                │
│   │ 输入: 书单文件   │                                                                │
│   └────────┬────────┘                                                                │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 1: 验证   │────►│ 验证失败条目    │──► 记录到错误日志                       │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │ 验证通过                                                                 │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 2: Schema │────►│ 需要迁移?       │                                        │
│   └────────┬────────┘     └────────┬────────┘                                        │
│            │                       │                                                  │
│            │ ◄─────────────────────┘ 执行迁移                                        │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 3: 上传   │────►│ 并行上传文件    │                                        │
│   │                 │     │ • EPUBs         │                                        │
│   │                 │     │ • Covers        │                                        │
│   │                 │     │ • Audio Files   │                                        │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 4: 填充   │────►│ 公开渠道抓取    │                                        │
│   │                 │     │ • 元数据增强    │                                        │
│   │                 │     │ • 章节解析      │                                        │
│   │                 │     │ • 关联建立      │                                        │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 5: 元数据 │────►│ 元数据验证      │                                        │
│   │                 │     │ • 完整性检查    │                                        │
│   │                 │     │ • 格式验证      │                                        │
│   │                 │     │ • 关联验证      │                                        │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 6: API    │────►│ 客户端请求模拟  │                                        │
│   │                 │     │ • 书籍/作者 API │                                        │
│   │                 │     │ • 有声书 API    │                                        │
│   │                 │     │ • 文件可访问性  │                                        │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐                                        │
│   │ Stage 7: 部署   │────►│ 部署确认        │                                        │
│   │                 │     │ • 缓存清理      │                                        │
│   │                 │     │ • 健康检查      │                                        │
│   │                 │     │ • 完成通知      │                                        │
│   └────────┬────────┘     └─────────────────┘                                        │
│            │                                                                          │
│            ▼                                                                          │
│   ┌─────────────────┐                                                                │
│   │ 完成: 生成报告   │                                                                │
│   │ • 成功数量      │                                                                │
│   │ • 失败条目      │                                                                │
│   │ • 警告信息      │                                                                │
│   └─────────────────┘                                                                │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 执行命令

| 命令 | 说明 |
|------|------|
| `pnpm pipeline:p001 --input=<booklist.json>` | 执行完整流水线 |
| `pnpm pipeline:p001 --input=<booklist.json> --dry-run` | 预演模式，不实际执行 |
| `pnpm pipeline:p001 --input=<booklist.json> --stage=1` | 仅执行 Stage 1 |
| `pnpm pipeline:p001 --resume=<run-id>` | 从中断点恢复执行 |

---

## 五、错误处理

### 5.1 错误分类

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           错误处理策略                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  致命错误 (Fatal) - 终止流水线                                                │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  • 书单文件不存在或无法解析                                                   │   │
│   │  • 数据库连接失败                                                             │   │
│   │  • R2 存储无法访问                                                            │   │
│   │  • 关键配置缺失                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  可恢复错误 (Recoverable) - 跳过条目继续                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  • 单本书籍验证失败                                                           │   │
│   │  • 单个文件上传失败 (重试3次后跳过)                                           │   │
│   │  • 公开渠道抓取超时 (使用缓存/默认值)                                         │   │
│   │  • 章节解析部分失败                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  警告 (Warning) - 记录日志继续                                                │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  • 书籍已存在于 Staging (跳过)                                                │   │
│   │  • 封面图片质量低                                                             │   │
│   │  • 作者信息不完整                                                             │   │
│   │  • 音频文件比特率低于标准                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 重试策略

| 操作 | 重试次数 | 重试间隔 | 失败后处理 |
|------|:--------:|----------|------------|
| 数据库写入 | 3 | 指数退避 | 终止流水线 |
| R2 文件上传 | 3 | 2s, 5s, 10s | 跳过，记录失败 |
| 公开渠道请求 | 2 | 5s | 使用默认值/缓存 |
| EPUB 解析 | 1 | - | 标记为解析失败 |

---

## 六、输出规范

### 6.1 执行报告

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           执行报告结构                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   报告文件: logs/pipeline/P001/{timestamp}-report.json                               │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  总览                                                                        │   │
│   │  • 执行时间                                                                   │   │
│   │  • 总耗时                                                                     │   │
│   │  • 输入书单                                                                   │   │
│   │  • 目标环境                                                                   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  统计                                                                        │   │
│   │  • 电子书: 成功 / 失败 / 跳过                                                 │   │
│   │  • 有声书: 成功 / 失败 / 跳过                                                 │   │
│   │  • 文件上传: 成功 / 失败                                                      │   │
│   │  • 数据填充: 成功 / 失败                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  详细记录                                                                    │   │
│   │  • 每个 Stage 的详细日志                                                      │   │
│   │  • 失败条目清单和原因                                                         │   │
│   │  • 警告信息汇总                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、运行环境

### 7.1 Droplet 服务器

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Droplet 运行架构                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      Digital Ocean Droplet                                   │   │
│   │                      (流水线执行服务器)                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                               │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │   │
│   │   │   tmux /    │    │   Node.js   │    │   本地存储   │                     │   │
│   │   │   screen    │    │   Runtime   │    │   (状态)     │                     │   │
│   │   │             │    │             │    │             │                     │   │
│   │   │ • 会话保持  │    │ • 流水线    │    │ • 检查点    │                     │   │
│   │   │ • 断开续跑  │    │   执行      │    │ • 日志文件  │                     │   │
│   │   └─────────────┘    └─────────────┘    └─────────────┘                     │   │
│   │         │                   │                  │                             │   │
│   │         └───────────────────┼──────────────────┘                             │   │
│   │                             │                                                 │   │
│   └─────────────────────────────┼─────────────────────────────────────────────────┘   │
│                                 │                                                     │
│           ┌─────────────────────┼─────────────────────┐                              │
│           │                     │                     │                              │
│           ▼                     ▼                     ▼                              │
│   ┌─────────────┐       ┌─────────────┐       ┌─────────────┐                       │
│   │ Debug 环境  │       │ Staging 环境│       │ 公开渠道    │                       │
│   │ (Fly.io)   │       │ (Fly.io)   │       │ (Internet)  │                       │
│   └─────────────┘       └─────────────┘       └─────────────┘                       │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 长时间运行支持

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           长时间执行机制                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      会话管理 (tmux/screen)                                  │   │
│   │                                                                               │   │
│   │   • 使用 tmux 或 screen 创建持久会话                                          │   │
│   │   • SSH 断开后进程继续运行                                                    │   │
│   │   • 可随时重新连接查看进度                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      检查点机制 (Checkpoint)                                  │   │
│   │                                                                               │   │
│   │   checkpoint/                                                                 │   │
│   │   └── P001-{run-id}/                                                         │   │
│   │       ├── state.json         # 当前执行状态                                   │   │
│   │       ├── stage1-complete    # Stage 1 完成标记                              │   │
│   │       ├── stage2-complete    # Stage 2 完成标记                              │   │
│   │       ├── processed-books.json    # 已处理书籍列表                           │   │
│   │       └── pending-books.json      # 待处理书籍列表                           │   │
│   │                                                                               │   │
│   │   恢复执行: pnpm pipeline:p001 --resume={run-id}                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                      进度追踪 & 通知                                          │   │
│   │                                                                               │   │
│   │   实时日志:                                                                   │   │
│   │   logs/pipeline/P001/{run-id}/                                               │   │
│   │   ├── progress.log           # 进度日志 (tail -f 查看)                       │   │
│   │   ├── error.log              # 错误日志                                       │   │
│   │   └── complete.log           # 完成的条目                                     │   │
│   │                                                                               │   │
│   │   进度查看命令:                                                               │   │
│   │   • pnpm pipeline:status {run-id}                                            │   │
│   │   • tail -f logs/pipeline/P001/{run-id}/progress.log                         │   │
│   │                                                                               │   │
│   │   完成通知 (可选):                                                            │   │
│   │   • 邮件通知                                                                  │   │
│   │   • Slack Webhook                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 执行时间预估

| 内容规模 | 预估时间 | 主要耗时环节 |
|----------|----------|--------------|
| 50 本电子书 | 30-60 分钟 | 文件上传、元数据抓取 |
| 100 本电子书 | 1-2 小时 | 文件上传、EPUB 解析 |
| 300 本电子书 + 50 有声书 | 4-8 小时 | 音频文件上传 |
| 500 本混合内容 | 8-16 小时 | 全流程 |

### 7.4 资源使用

| 资源 | 推荐配置 | 说明 |
|------|----------|------|
| Droplet 规格 | 2 vCPU / 4GB RAM | 基础规格，可扩展 |
| 磁盘空间 | 50GB+ | 用于临时文件和日志 |
| 网络带宽 | 无限制 | DO 带宽免费 |

---

## 八、依赖与前置条件

### 8.1 环境依赖

| 依赖项 | 要求 | 说明 |
|--------|------|------|
| Droplet 服务器 | 运行中 | 流水线执行环境 |
| Debug 环境 | 已部署运行 | 作为数据源 |
| Staging 环境 | 已部署运行 | 作为目标 |
| Debug R2 Bucket | 可访问 | 文件来源 |
| Staging R2 Bucket | 可写入 | 文件目标 |
| 公开渠道网络 | 可访问 | Gutenberg, Wikidata 等 |
| tmux/screen | 已安装 | 会话持久化 |
| Node.js 20+ | 已安装 | 运行时环境 |

### 8.2 配置要求

| 配置项 | 说明 |
|--------|------|
| DEBUG_DATABASE_URL | Debug 环境数据库连接 |
| STAGING_DATABASE_URL | Staging 环境数据库连接 |
| DEBUG_R2_* | Debug R2 存储配置 |
| STAGING_R2_* | Staging R2 存储配置 |
| PIPELINE_CHECKPOINT_DIR | 检查点存储目录 |
| PIPELINE_LOG_DIR | 日志存储目录 |

---

## 九、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2025-12-31 | 初始设计 |
| 1.1 | 2025-12-31 | 添加 Droplet 运行环境和长时间执行支持 |
| 1.2 | 2025-12-31 | 添加 Stage 5 (元数据)、Stage 6 (API验证)、Stage 7 (部署) |
| 1.3 | 2026-01-01 | 添加 Stage 4.5 (分类生成)、Stage 4.6 (发现页Tab)、经验总结 |
| 1.4 | 2026-01-01 | 添加 Stage 4.7 (作者头像修复)、Stage 4.8 (推荐服务验证)、一键部署脚本 |
| 1.5 | 2026-01-01 | 添加 Stage 4.9 (标题清洗)、Stage 4.10 (翻译数据填充)、多语言本地化支持 |
| 1.6 | 2026-01-01 | Stage 4.10 执行完成: 分类 100%、作者 85%、书籍 91%；添加新脚本 seed-category-translations.ts、enrich-author-translations.ts、seed-book-translations.ts |
| 1.7 | 2026-01-01 | Stage 5 进度: 修复 6 本 PROCESSING 书籍、填充 3 个 Feature Flags、识别 141 本待解析书籍 |
| 1.8 | 2026-01-01 | 翻译覆盖率达 100%: 分类 58/58、作者 216/216、书籍 346/346；同步 1 本 Debug 章节 |
| 1.9 | 2026-01-01 | 章节解析脚本执行: 140 本书 EPUB 下载失败 (URL 失效)；需修复 R2 公开访问或更新 URL 抓取逻辑 |
| 1.10 | 2026-01-01 | Stage 6 API 连接诊断: iOS 客户端无法连接 Staging API，详见下方诊断报告 |
| 1.11 | 2026-01-01 | Stage 6 API 连接已修复: 重新部署 Fly.io，Health/Redis/Database/Storage 全部正常，8 个分类 Tab 正常返回 |
| 1.12 | 2026-01-01 | iOS 客户端本地化修复: 移除客户端数据翻译表，改用服务端本地化，详见 九-C 章节 |
| 1.13 | 2026-01-01 | 作者头像问题修复: 18 个 Agora 作者头像从字母占位符更新为真实肖像；添加 10.6 作者头像处理经验总结 |
| 1.14 | 2026-01-02 | Prisma 数据库连接问题: packages/database/.env 指向旧数据库导致 iOS 显示错误的 5 个 Tab；添加 10.8 数据库连接排查经验 |
| 1.15 | 2026-01-02 | Fly.io 环境同步问题: Fly.io secrets 独立于 Droplet 配置导致 iOS 仍显示旧数据；书籍从 Debug 同步到 Staging (153本)；添加 10.9 Fly.io 部署环境同步经验、10.10 书籍同步与分类关联经验 |

---

## 九-B、Stage 6 API 连接问题诊断 (2026-01-01)

### 诊断结果

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           iOS → Staging API 连接问题诊断                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   症状: iOS 客户端请求 /recommendation/discover/tabs 无响应                          │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  iOS 配置                                                                     │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  环境: Staging                                                                │   │
│   │  URL:  https://readmigo-staging.fly.dev/api/v1                               │   │
│   │  配置文件: ios/Readmigo/Core/Config/Environment.swift:20                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  Fly.io Staging 状态                                                          │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  App:      readmigo-staging                                                   │   │
│   │  Region:   nrt (Tokyo)                                                        │   │
│   │  State:    started                                                            │   │
│   │  TCP:      ✅ passing                                                          │   │
│   │  HTTP:     ❌ critical (health check /api/v1/health 无响应)                    │   │
│   │  原因:     应用启动后挂起，可能 Redis 连接问题                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  Droplet Staging 状态                                                         │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  服务:     PM2 - readmigo-staging                                             │   │
│   │  端口:     8081                                                               │   │
│   │  本地测试: ✅ HTTP 200 (curl localhost:8081)                                   │   │
│   │  外部访问: ❌ 无 Nginx 配置，无法外部访问                                       │   │
│   │  Redis:    ❌ 未安装 (日志显示连接错误)                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 根本原因

| 问题 | 详情 | 影响 |
|------|------|------|
| Fly.io HTTP 健康检查失败 | 应用 TCP 监听正常但 HTTP 请求无响应 | iOS 无法连接 |
| 可能的 Redis 问题 | REDIS_URL 配置了但可能连接失败导致应用挂起 | API 无响应 |
| Droplet 无外部访问 | staging.readmigo.com DNS 不存在，无 Nginx 代理 | 备选方案不可用 |

### 修复选项

| 选项 | 步骤 | 优先级 |
|------|------|--------|
| A: 修复 Fly.io | 1. 检查 Redis 连接配置 2. 检查应用启动日志 3. 重新部署 | P0 |
| B: 配置 Droplet | 1. 安装 Redis 2. 配置 Nginx 3. 添加 DNS 记录 | P1 |
| C: 临时绕过 | 在 iOS 添加 Droplet IP 直连选项 (仅供测试) | P2 |

### 解决方案 (已完成)

**执行选项 A: 重新部署 Fly.io**

```bash
# 1. 更新 REDIS_URL (确保使用正确的私有网络地址)
flyctl secrets set REDIS_URL='redis://default:xxx@fly-readmigo-staging-redis.upstash.io:6379' -a readmigo-staging

# 2. 销毁旧机器并重新部署
flyctl machine destroy <machine-id> -a readmigo-staging --force
flyctl deploy -a readmigo-staging --now
```

**结果验证 (2026-01-01 14:46 UTC+8)**

| 检查项 | 状态 |
|--------|------|
| Health API | ✅ HTTP 200 |
| Database | ✅ ok (latency: 69ms) |
| Redis | ✅ ok (latency: 2ms) |
| Storage | ✅ ok (configured: true) |
| Discover Tabs | ✅ 返回 8 个分类 |

**修复后的机器配置**

- 机器数量: 2 (高可用)
- 区域: nrt (Tokyo)
- 镜像: `readmigo-staging:deployment-01KDW4RE47PFGDE8JEK418A0BS`

---

## 九-C、iOS 客户端本地化修复 (2026-01-01)

### 问题现象

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           iOS 发现页中文显示问题                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   症状: 发现页部分内容显示英文而非中文                                                   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  问题 1: 分类标签显示英文                                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  现象: Classics, Fiction, Adventure & Fantasy                               │   │
│   │  期望: 经典, 小说, 冒险奇幻                                                    │   │
│   │  原因: API 返回的 name 字段值是英文 (服务端翻译表未正确应用)                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  问题 2: 书籍流派显示英文                                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  现象: Satire, Classic Literature                                            │   │
│   │  期望: 讽刺, 经典文学                                                          │   │
│   │  原因: API 返回的 genres 字段值是英文 (服务端翻译表未正确应用)                   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  问题 3: 作者信息显示英文                                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │  现象: Aesop, 621? BCE-565? BCE                                              │   │
│   │  期望: 伊索, 公元前621年?-公元前565年?                                         │   │
│   │  原因: API 返回的 author 字段值是英文 (服务端翻译表未正确应用)                   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 解决方案：遵循设计原则

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          正确的本地化架构 (服务端负责)                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   核心原则: 数据本地化由服务端负责，客户端直接使用服务端返回的数据                        │
│            参考: docs/04-development/backend/localization/data-localization-design.md (第十二章) │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                        职责分工                                               │   │
│   ├───────────────────────────────┬─────────────────────────────────────────────┤   │
│   │          服务端               │              客户端                          │   │
│   ├───────────────────────────────┼─────────────────────────────────────────────┤   │
│   │  ✅ 数据本地化                │  ✅ UI 本地化                                 │   │
│   │  - 书籍标题、作者名           │  - 按钮文字、导航标签                         │   │
│   │  - 分类名称 (Tab name)        │  - 提示/错误消息                             │   │
│   │  - 流派名称 (genres)          │  - 设置选项、状态文字                         │   │
│   │  - 书籍简介等                 │                                              │   │
│   ├───────────────────────────────┼─────────────────────────────────────────────┤   │
│   │  📍 translations 表           │  📍 Localizable.xcstrings                    │   │
│   │  🔄 Accept-Language header    │  🔄 系统语言自动匹配                          │   │
│   └───────────────────────────────┴─────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### iOS 客户端修复内容

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        客户端代码修正                                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ❌ 错误做法 (已移除):                                                               │
│   - 在 Localizable.xcstrings 中添加 discoverTab.*, genre.* 等数据翻译条目             │
│   - 在客户端代码中使用翻译键查询本地翻译表                                             │
│                                                                                       │
│   ✅ 正确做法 (已实现):                                                               │
│   - 客户端直接使用服务端返回的 name 字段                                               │
│   - 客户端直接使用服务端返回的 genres 数组                                             │
│   - Localizable.xcstrings 只存储 UI 文案                                              │
│                                                                                       │
│   代码示例:                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  // DiscoverTab.swift                                                        │   │
│   │  var displayName: String {                                                   │   │
│   │      name  // 直接使用服务端返回的 name，不查本地翻译表                         │   │
│   │  }                                                                           │   │
│   │                                                                               │   │
│   │  // Book.swift                                                               │   │
│   │  var localizedGenres: [String] {                                             │   │
│   │      genres  // 直接使用服务端返回的 genres，不做客户端翻译                     │   │
│   │  }                                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `ios/Readmigo/Core/Models/DiscoverTab.swift` | displayName 直接返回 name 字段 |
| `ios/Readmigo/Core/Models/Book.swift` | 移除 GenreHelper，localizedGenres 直接返回 genres |
| `ios/Readmigo/Localizable.xcstrings` | 移除 53 条数据翻译条目 (discoverTab.*, genre.*) |
| `docs/04-development/backend/localization/data-localization-design.md` | 新增第十二章：客户端本地化原则 |

### 待解决问题 (服务端)

| 问题 | 根本原因 | 解决方案 |
|------|----------|----------|
| 分类 Tab 显示英文 | discover_tabs 表的 name 字段未本地化 | 服务端根据 Accept-Language 查询 translations 表 |
| 书籍流派显示英文 | books 表的 genres 字段未本地化 | 服务端根据 Accept-Language 查询 translations 表 |
| 作者名显示英文 | books 表的 author 字段未本地化 | 服务端根据 Accept-Language 查询 translations 表 |

### 服务端修复方向

服务端需要确保 API 返回的数据已根据 `Accept-Language` header 进行本地化：

1. **分类 Tab API** (`/api/discover/tabs`): 返回的 `name` 字段应是本地化后的值
2. **书籍列表 API** (`/api/books`, `/api/discover/books`): 返回的 `title`, `author`, `genres` 应是本地化后的值
3. **书籍详情 API** (`/api/books/:id`): 同上

---

## 十、经验总结与最佳实践

### 10.1 核心原则: 禁止 Seed

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ⚠️ 全栈禁止 Seed 原则                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ❌ 禁止的做法:                                                                       │
│   ├── 在代码中硬编码分类、Tab、配置等数据                                              │
│   ├── 使用 prisma db seed 填充业务数据                                                │
│   ├── 从 Debug 环境直接复制预定义的分类数据                                            │
│   └── 在 API 返回中硬编码 "All"、"For You" 等 Tab                                     │
│                                                                                       │
│   ✅ 正确的做法:                                                                       │
│   ├── 所有业务数据必须从实际数据源计算生成                                              │
│   ├── 分类数据从书籍的 genres 字段动态生成                                             │
│   ├── Tab 数据从分类表动态查询并缓存                                                   │
│   └── 使用可复用脚本，支持增量更新和重建                                               │
│                                                                                       │
│   原因:                                                                                │
│   ├── 数据一致性: Seed 数据与实际内容可能不匹配                                        │
│   ├── 可维护性: 硬编码数据难以追踪和更新                                               │
│   └── 可扩展性: 新书导入时需要自动更新分类                                             │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 分类生成经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           分类生成踩坑与解决方案                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题 1: Genre 命名不一致                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: 同一分类有多种写法                                                     │   │
│   │   - "fiction" vs "Fiction"                                                    │   │
│   │   - "classics" vs "Classic Literature" vs "Classics"                          │   │
│   │   - "childrens" vs "Children's Literature"                                    │   │
│   │                                                                               │   │
│   │   解决: 使用归一化映射表                                                        │   │
│   │   GENRE_NORMALIZE_MAP = {                                                     │   │
│   │     'fiction': 'Fiction',                                                     │   │
│   │     'classics': 'Classics',                                                   │   │
│   │     'classic literature': 'Classics',                                         │   │
│   │     ...                                                                       │   │
│   │   }                                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 2: bookCount 统计不完整                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: Root 分类显示的书籍数远少于实际                                         │   │
│   │                                                                               │   │
│   │   原因: 只统计了子分类的书籍，漏掉直接关联到 Root 的书籍                        │   │
│   │   - 书籍 genres: ["Classics"] → 直接关联 Root "Classics"                      │   │
│   │   - 书籍 genres: ["Classic Literature"] → 关联 Child，再归属 Root            │   │
│   │                                                                               │   │
│   │   解决: 统计时合并两种来源                                                      │   │
│   │   totalBooks = directBooks + childBooks                                       │   │
│   │   directBooks = root._count.books                                             │   │
│   │   childBooks = root.children.reduce((sum, c) => sum + c._count.books, 0)     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 3: 脚本可复用性                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   需求: 后续新书导入时需要重复执行分类更新                                       │   │
│   │                                                                               │   │
│   │   解决: 脚本设计支持多种模式                                                     │   │
│   │   - 增量模式 (默认): 只添加新分类和关联，不删除                                 │   │
│   │   - 重建模式 (--clean): 删除所有分类后重新生成                                  │   │
│   │   - 预览模式 (--dry-run): 只输出将要执行的操作                                  │   │
│   │   - 多环境支持 (--db=staging/debug): 支持不同目标环境                          │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 缓存处理经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              缓存相关注意事项                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题: 更新数据库后 API 仍返回旧数据                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: discover_tabs 表已更新，但 /api/v1/recommendation/discover/tabs     │   │
│   │         接口仍返回旧的 Tab 列表                                               │   │
│   │                                                                               │   │
│   │   原因: RecommendationService.getDiscoverTabs() 使用 Redis 缓存               │   │
│   │         缓存 Key: "discover:tabs"                                             │   │
│   │         缓存 TTL: 3600 秒 (1 小时)                                            │   │
│   │                                                                               │   │
│   │   解决方案:                                                                    │   │
│   │   1. 等待缓存自动过期 (最多 1 小时)                                            │   │
│   │   2. 重启 Staging 后端服务 (清空 Redis 连接)                                   │   │
│   │   3. 手动清除缓存 (需要 Redis 访问权限):                                       │   │
│   │      redis-cli DEL discover:tabs                                              │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   其他缓存相关 Key (供参考):                                                           │
│   ├── books:list:*       - 书籍列表缓存                                              │
│   ├── books:detail:{id}  - 书籍详情缓存                                              │
│   ├── authors:list:*     - 作者列表缓存                                              │
│   └── discover:*         - 发现页相关缓存                                            │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.4 新书导入后的标准操作流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           新书导入后标准操作                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   当有新书导入到 Staging 后，执行以下步骤更新分类和发现页:                              │
│                                                                                       │
│   Step 1: 生成/更新分类                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   # 增量更新 (推荐，保留现有分类)                                              │   │
│   │   npx tsx scripts/generate-categories-from-books.ts --db=staging             │   │
│   │                                                                               │   │
│   │   # 或完全重建 (适用于大规模变更)                                               │   │
│   │   npx tsx scripts/generate-categories-from-books.ts --db=staging --clean     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   Step 2: 更新发现页 Tab                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   DATABASE_URL='postgresql://...' npx tsx scripts/sync-discover-tabs.ts      │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   Step 3: 等待或清除缓存                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   # 选项 A: 等待 1 小时缓存自动过期                                            │   │
│   │   # 选项 B: 重启 Staging 后端                                                  │   │
│   │   fly apps restart readmigo-staging                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   Step 4: 验证                                                                        │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   curl -s https://readmigo-staging.fly.dev/api/v1/recommendation/discover/tabs │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.5 相关脚本清单

| 脚本 | 用途 | 执行环境 |
|------|------|----------|
| `scripts/generate-categories-from-books.ts` | 从书籍 genres 生成分类 | 本地/Droplet |
| `scripts/sync-discover-tabs.ts` | 从分类表生成发现页 Tab | 本地/Droplet |
| `scripts/sync-booklist-to-staging.ts` | 按书单同步书籍/作者到 Staging | Droplet |
| `scripts/sync-debug-to-staging.ts` | 批量同步 Debug 数据到 Staging | Droplet |
| `scripts/fix-author-avatars.ts` | 修复作者头像重复记录问题 | 本地/Droplet |
| `scripts/staging-deploy.sh` | 一键部署脚本 (Stage 4.5 - 4.8) | Droplet |

### 10.6 作者头像处理经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           作者头像处理踩坑与解决方案                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ⚠️ 核心原则: 禁止使用字母占位符头像                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   ❌ 禁止: 使用 DiceBear API 生成字母占位符 (如 "SJ", "MT")                    │   │
│   │   ❌ 禁止: 使用 ui-avatars.com 等服务生成字母头像                               │   │
│   │   ✅ 正确: 找不到真实头像时必须报错，由人工处理                                   │   │
│   │                                                                               │   │
│   │   原因:                                                                        │   │
│   │   - 字母头像在 App 中显示效果差，用户体验不佳                                   │   │
│   │   - 字母头像容易与真实头像混淆，难以发现问题                                     │   │
│   │   - R2 URL 指向字母图片时，iOS 客户端会显示字母而非使用本地占位符               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 1: 字母头像被上传到 R2                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: Agora 页面作者头像显示字母 (如 "SJ") 而非真实照片                       │   │
│   │                                                                               │   │
│   │   原因: import-authors.ts 脚本逻辑:                                           │   │
│   │   1. 尝试从 Wikipedia 下载头像                                                │   │
│   │   2. 如果失败 → 使用 DiceBear API 生成字母占位符                               │   │
│   │   3. 把占位符图片上传到 R2                                                     │   │
│   │   4. 数据库 avatarUrl 指向 R2 链接 (但内容是字母图片)                          │   │
│   │                                                                               │   │
│   │   解决: 使用 Wikidata SPARQL 查询 P18 (图片) 属性                              │   │
│   │   - 比 Wikipedia pageimages API 更可靠                                        │   │
│   │   - 覆盖率更高，历史人物图片更全                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 2: Wikidata 返回错误的人                                                        │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: "Shaw, Bernard" 搜索返回了现代的 Bernard Shaw，而非萧伯纳              │   │
│   │                                                                               │   │
│   │   原因: Wikidata 搜索 API 返回最相关结果，但同名人物会混淆                      │   │
│   │                                                                               │   │
│   │   解决方案:                                                                    │   │
│   │   1. 优先使用作者的 wikidataId (如果数据库中已有)                              │   │
│   │   2. 搜索时使用完整名称 + 生卒年 (如 "George Bernard Shaw 1856-1950")          │   │
│   │   3. 对重要作者维护手动映射表 KNOWN_AUTHORS                                    │   │
│   │   4. 上传后人工抽检验证图片是否正确                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 3: CDN 缓存导致图片不更新                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: R2 已上传新图片，但浏览器/App 仍显示旧图片                              │   │
│   │                                                                               │   │
│   │   原因: Cloudflare R2 public bucket 使用 CDN 边缘缓存                          │   │
│   │   - 不同地理位置的 CDN 节点缓存不同版本                                        │   │
│   │   - 即使源文件更新，边缘节点可能仍返回旧缓存                                    │   │
│   │                                                                               │   │
│   │   解决方案:                                                                    │   │
│   │   1. 上传时设置 Cache-Control: no-cache, max-age=0                            │   │
│   │   2. 更新数据库 URL 添加缓存刷新参数: ?v={timestamp}                           │   │
│   │   3. 客户端强制刷新或清除图片缓存                                              │   │
│   │                                                                               │   │
│   │   预防措施:                                                                    │   │
│   │   - 初次上传时就在 URL 中包含版本号                                            │   │
│   │   - 更新头像时同时更新数据库 URL 的版本参数                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 4: 作者 ID 重复                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: 同一作者在数据库中有多条记录 (不同 ID)                                  │   │
│   │   - "F. Scott Fitzgerald" (ID: ac11f567...)                                   │   │
│   │   - "Fitzgerald, F. Scott (Francis Scott), 1896-1940" (ID: fe4c8179...)      │   │
│   │                                                                               │   │
│   │   影响:                                                                        │   │
│   │   - 修复头像时可能修复错误的 ID                                                │   │
│   │   - Agora 使用的作者 ID 与其他地方不一致                                       │   │
│   │                                                                               │   │
│   │   解决: 修复前先查询确认正确的作者 ID                                           │   │
│   │   SELECT * FROM Author WHERE name LIKE '%Fitzgerald%';                        │   │
│   │   SELECT authorId FROM AgoraPost WHERE author.name LIKE '%Fitzgerald%';       │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   头像修复标准流程:                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   Step 1: 查询需要修复的作者                                                   │   │
│   │   - 确认正确的作者 ID (特别是 Agora 使用的 ID)                                 │   │
│   │                                                                               │   │
│   │   Step 2: 获取真实头像                                                         │   │
│   │   - 优先: Wikidata SPARQL 查询 P18 属性                                       │   │
│   │   - 备选: Wikipedia API (pageimages)                                          │   │
│   │   - 手动: 直接使用 Wikimedia Commons URL                                      │   │
│   │                                                                               │   │
│   │   Step 3: 处理并上传                                                           │   │
│   │   - 使用 sharp 处理: resize(400, 400), jpeg({ quality: 85 })                  │   │
│   │   - 上传到 R2: authors/{authorId}/avatar.jpg                                  │   │
│   │   - 设置 Cache-Control: no-cache, max-age=0                                   │   │
│   │                                                                               │   │
│   │   Step 4: 更新数据库                                                           │   │
│   │   - 更新 avatarUrl 并添加缓存刷新参数 ?v={timestamp}                           │   │
│   │                                                                               │   │
│   │   Step 5: 验证                                                                 │   │
│   │   - 下载图片并目视确认是否为正确的人物肖像                                      │   │
│   │   - 检查 API 返回的 avatarUrl 是否正确                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.7 相关脚本说明

| 脚本 | 用途 | 关键点 |
|------|------|--------|
| `scripts/fix-author-avatars.ts` | 批量修复作者头像 | 使用多数据源: Wikidata → Wikipedia → Open Library → LoC |
| `scripts/fetch-real-avatars.ts` | 为 Agora 作者获取真实头像 | 使用 Wikidata SPARQL 查询 P18 属性 |
| `scripts/fix-fitzgerald-agora.ts` | 手动修复特定作者 | 直接使用 Wikimedia Commons URL |

### 10.8 数据库连接排查经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         Prisma 连接错误数据库排查流程                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题现象                                                                            │
│   ─────────                                                                           │
│   • iOS 客户端显示 5 个旧 Tab (Literature & Fiction, Philosophy & Ethics...)         │
│   • API 返回的数据与数据库查询结果不一致                                               │
│   • 刷新 Redis 缓存后问题依然存在                                                      │
│                                                                                       │
│   排查步骤                                                                            │
│   ─────────                                                                           │
│                                                                                       │
│   1. 验证 Redis 缓存                                                                  │
│      curl https://readmigo-staging.fly.dev/api/v1/recommendation/cache/status        │
│      → 缓存显示正常 (tabs: 5)                                                         │
│                                                                                       │
│   2. 验证数据库数据                                                                   │
│      psql $DATABASE_URL -c "SELECT * FROM discover_tabs WHERE is_active=true"        │
│      → 返回 8 个新 Tab ✓                                                              │
│                                                                                       │
│   3. 关键发现: Prisma 与 psql 返回不同数据                                            │
│      ┌──────────────────────────────────────────────────────────────────────┐        │
│      │  psql $DATABASE_URL      → 8 个新 Tab (Classics, Fiction...)        │        │
│      │  Prisma $queryRaw       → 5 个旧 Tab (Literature & Fiction...)      │        │
│      └──────────────────────────────────────────────────────────────────────┘        │
│                                                                                       │
│   4. 检查 .env 文件                                                                   │
│      • /apps/backend/.env.staging     → ep-shy-cloud-a1depd3i (新数据库) ✓           │
│      • /packages/database/.env        → ep-small-queen-a1du4xmc (旧数据库) ✗         │
│                                                                                       │
│   根本原因                                                                            │
│   ─────────                                                                           │
│   Prisma Client 从 packages/database/.env 加载 DATABASE_URL                          │
│   该文件指向旧的 Neon 数据库项目，与 apps/backend/.env.staging 不一致                  │
│                                                                                       │
│   修复方案                                                                            │
│   ─────────                                                                           │
│   1. 更新 /packages/database/.env 中的 DATABASE_URL                                   │
│      DATABASE_URL=postgresql://...@ep-shy-cloud-a1depd3i.ap-southeast-1...           │
│                                                                                       │
│   2. 重新生成 Prisma Client                                                          │
│      cd packages/database && npx prisma generate                                     │
│                                                                                       │
│   3. 重启服务                                                                         │
│      pm2 restart readmigo-staging                                                    │
│                                                                                       │
│   4. 刷新 Redis 缓存                                                                  │
│      curl -X POST https://readmigo-staging.fly.dev/api/v1/recommendation/cache/refresh │
│                                                                                       │
│   预防措施                                                                            │
│   ─────────                                                                           │
│   • Monorepo 中所有 .env 文件必须指向同一个数据库实例                                  │
│   • 切换数据库时，检查以下位置:                                                        │
│     - apps/backend/.env, .env.staging, .env.production                               │
│     - packages/database/.env                                                         │
│   • 使用 grep -r "neon.tech" 查找所有数据库连接字符串                                  │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.9 Fly.io 部署环境同步经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         Fly.io 与 Droplet 环境不同步问题                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   问题现象                                                                            │
│   ─────────                                                                           │
│   • Droplet 已修复 packages/database/.env，重启 PM2 后本地 API 正常                   │
│   • iOS 客户端请求 Fly.io (readmigo-staging.fly.dev) 仍返回旧数据                     │
│   • 5 个旧 Tab 而非 8 个新 Tab                                                        │
│                                                                                       │
│   根本原因                                                                            │
│   ─────────                                                                           │
│   Fly.io 有独立的 secrets 配置，与 Droplet .env 文件相互独立:                          │
│                                                                                       │
│   ┌──────────────────────────────────────────────────────────────────────────────┐   │
│   │  环境              │  配置位置                  │  DATABASE_URL              │   │
│   ├──────────────────────────────────────────────────────────────────────────────┤   │
│   │  Droplet PM2       │  packages/database/.env   │  ep-shy-cloud (新) ✓        │   │
│   │  Fly.io Staging    │  fly secrets             │  ep-small-queen (旧) ✗       │   │
│   └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   修复步骤                                                                            │
│   ─────────                                                                           │
│                                                                                       │
│   1. 更新 Fly.io secrets                                                             │
│      fly secrets set DATABASE_URL="postgresql://...@ep-shy-cloud..." -a readmigo-staging │
│                                                                                       │
│   2. 重启 Fly.io 机器                                                                 │
│      fly apps restart readmigo-staging                                               │
│                                                                                       │
│   3. 清理 Redis 缓存 (必须在 Fly.io 容器内执行)                                        │
│      fly ssh console -a readmigo-staging                                             │
│      > 使用 node 连接 Redis 删除 discover:v2:* 键                                     │
│                                                                                       │
│   4. 刷新缓存                                                                         │
│      curl -X POST https://readmigo-staging.fly.dev/api/v1/recommendation/cache/refresh │
│                                                                                       │
│   5. 验证 API 返回                                                                    │
│      curl https://readmigo-staging.fly.dev/api/v1/recommendation/discover/tabs        │
│                                                                                       │
│   ⚠️ 关键提醒                                                                         │
│   ─────────                                                                           │
│   • Fly.io secrets 独立于代码仓库和 Droplet 配置                                      │
│   • 切换数据库时，必须同时更新:                                                        │
│     1. Droplet: packages/database/.env + apps/backend/.env.staging                   │
│     2. Fly.io: fly secrets set DATABASE_URL=... -a readmigo-staging                  │
│   • Redis 缓存在 Fly.io 容器内，Droplet 的 redis-cli 无法访问                          │
│   • 缓存刷新 API 在 Fly.io 上运行，会自动使用 Fly.io 的 Redis 连接                     │
│                                                                                       │
│   检查清单 (切换数据库时)                                                              │
│   ─────────────────────                                                               │
│   □ packages/database/.env 更新                                                       │
│   □ apps/backend/.env.staging 更新                                                    │
│   □ Droplet PM2 重启: pm2 restart readmigo-staging                                   │
│   □ Fly.io secrets 更新: fly secrets set DATABASE_URL=...                            │
│   □ Fly.io 重启: fly apps restart readmigo-staging                                   │
│   □ Redis 缓存清理 (通过 fly ssh 或 cache/refresh API)                                │
│   □ API 验证: curl /recommendation/discover/tabs                                      │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.10 书籍同步与分类关联经验

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         书籍导入与分类关联踩坑记录                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   场景: 新数据库只有分类结构，需要从 Debug 导入书籍并关联分类                            │
│                                                                                       │
│   问题 1: 部分书籍导入失败 (外键约束)                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: "Hound of the Baskervilles" 等书籍创建失败                            │   │
│   │   错误: Foreign key constraint failed on the field: author_id               │   │
│   │                                                                               │   │
│   │   原因: 书籍的 authorId 指向的作者未同步到 staging                             │   │
│   │                                                                               │   │
│   │   解决: 同步脚本应先同步 authors 再同步 books                                   │   │
│   │   - 从书单解析作者列表                                                         │   │
│   │   - 按作者名匹配 Debug 中的作者记录                                            │   │
│   │   - 先创建作者，再创建书籍                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 2: 书籍未关联到 Discover Tab 分类                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: 书籍已导入，但 Tab 显示 0 本书                                          │   │
│   │                                                                               │   │
│   │   原因: book_categories 表链接到子分类 ID，而非 discover_tabs 的 categoryId    │   │
│   │   - Discover Tab 的 categoryId 指向 Level 0 (Root) 分类                       │   │
│   │   - 书籍可能只链接到 Level 1 (Child) 分类                                      │   │
│   │                                                                               │   │
│   │   解决: 分类过滤时需要包含子分类                                                │   │
│   │   discover-cache.service.ts 中的 buildBooksCache():                           │   │
│   │   const childCategories = await prisma.category.findMany({                    │   │
│   │     where: { parentId: categoryId, isActive: true }                           │   │
│   │   });                                                                          │   │
│   │   const categoryIds = [categoryId, ...childCategories.map(c => c.id)];        │   │
│   │   where.categories = { some: { categoryId: { in: categoryIds } } };           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   问题 3: genres 未正确映射到 Root 分类                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │   现象: 书籍 genres 是 "Classic Literature"，但 Tab 是 "Classics"             │   │
│   │                                                                               │   │
│   │   原因: generate-categories-from-books.ts 的 GENRE_GROUPS 映射                 │   │
│   │   需要把 "Classic Literature" 作为 "Classics" 的子分类                          │   │
│   │                                                                               │   │
│   │   正确配置:                                                                    │   │
│   │   GENRE_GROUPS = {                                                            │   │
│   │     'Classics': ['Classic Literature', 'American Classics', ...],            │   │
│   │     'Fiction': ['Literary Fiction', 'Historical Fiction', ...],              │   │
│   │     ...                                                                        │   │
│   │   }                                                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
│   书籍同步后的标准验证步骤                                                             │
│   ─────────────────────────                                                           │
│   1. 验证书籍总数                                                                     │
│      psql -c "SELECT COUNT(*) FROM books WHERE status='ACTIVE'"                      │
│                                                                                       │
│   2. 验证分类链接                                                                     │
│      psql -c "SELECT COUNT(*) FROM book_categories"                                  │
│                                                                                       │
│   3. 验证每个 Tab 的书籍数                                                            │
│      for catId in $(discover_tab_category_ids); do                                   │
│        curl ".../discover?categoryId=$catId" | jq '.total'                           │
│      done                                                                             │
│                                                                                       │
│   4. 刷新缓存                                                                         │
│      curl -X POST .../recommendation/cache/refresh                                   │
│                                                                                       │
│   5. iOS 客户端验证                                                                   │
│      - Force quit App                                                                │
│      - 重新打开检查 Discover Tab                                                     │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、一键部署脚本

> **重要**: 一键部署脚本必须在 **Droplet** 服务器上执行，不支持本地运行。
>
> 原因:
> - Droplet 已配置好数据库连接和环境变量
> - 避免本地网络延迟影响数据库操作
> - 统一执行环境，确保脚本行为一致

### 11.1 脚本概述

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           一键部署脚本架构                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   脚本位置: scripts/staging-deploy.sh                                                 │
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         执行流程                                              │   │
│   │                                                                               │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ 环境检查    │ ──► 验证 DATABASE_URL, Node.js, 依赖包                     │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.5   │ ──► 分类生成 (generate-categories-from-books.ts)           │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.6   │ ──► Tab 生成 (sync-discover-tabs.ts)                       │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.7   │ ──► 作者头像修复 (fix-author-avatars.ts)                   │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.8   │ ──► 推荐服务验证 (curl 验证每个分类)                        │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.9   │ ──► 标题清洗 (clean-book-titles.ts)                        │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ Stage 4.10  │ ──► 翻译填充 (wikidata-book-enrichment.ts)                 │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ 清除缓存    │ ──► 重启 Fly.io 应用 (清除 Redis 缓存)                      │   │
│   │   └──────┬──────┘                                                            │   │
│   │          ▼                                                                    │   │
│   │   ┌─────────────┐                                                            │   │
│   │   │ 验证结果    │ ──► 调用 API 确认更新生效                                   │   │
│   │   └─────────────┘                                                            │   │
│   │                                                                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 脚本内容

```bash
#!/bin/bash
# scripts/staging-deploy.sh
# Staging 环境一键部署脚本 (Stage 4.5 - 4.10)

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 配置
STAGING_API="https://readmigo-staging.fly.dev/api/v1"
FLY_APP="readmigo-staging"

echo "================================================"
echo "Staging 环境一键部署 (Stage 4.5 - 4.10)"
echo "================================================"

# 环境检查
echo -e "\n${YELLOW}[Step 0] 环境检查...${NC}"
if [ -z "$DATABASE_URL" ]; then
    echo -e "${RED}错误: DATABASE_URL 未设置${NC}"
    exit 1
fi
echo -e "${GREEN}✓ DATABASE_URL 已设置${NC}"

# Stage 4.5: 分类生成
echo -e "\n${YELLOW}[Stage 4.5] 生成分类数据...${NC}"
npx tsx scripts/generate-categories-from-books.ts
echo -e "${GREEN}✓ 分类生成完成${NC}"

# Stage 4.6: Tab 生成
echo -e "\n${YELLOW}[Stage 4.6] 生成发现页 Tab...${NC}"
npx tsx scripts/sync-discover-tabs.ts
echo -e "${GREEN}✓ Tab 生成完成${NC}"

# Stage 4.7: 作者头像修复
echo -e "\n${YELLOW}[Stage 4.7] 修复作者头像...${NC}"
npx tsx scripts/fix-author-avatars.ts
echo -e "${GREEN}✓ 头像修复完成${NC}"

# Stage 4.8: 推荐服务验证 (在清除缓存前先验证)
echo -e "\n${YELLOW}[Stage 4.8] 验证推荐服务...${NC}"
TABS_PRE=$(curl -s "$STAGING_API/recommendation/discover/tabs")
echo "发现 $(echo $TABS_PRE | jq '.tabs | length') 个分类 (预检)"

# Stage 4.9: 标题清洗
echo -e "\n${YELLOW}[Stage 4.9] 清洗书籍标题...${NC}"
npx ts-node -r tsconfig-paths/register src/scripts/data-enrichment/clean-book-titles.ts
echo -e "${GREEN}✓ 标题清洗完成${NC}"

# Stage 4.10: 翻译数据填充
echo -e "\n${YELLOW}[Stage 4.10] 填充翻译数据...${NC}"
npx ts-node -r tsconfig-paths/register src/scripts/data-enrichment/wikidata-book-enrichment.ts 500
echo -e "${GREEN}✓ 翻译填充完成${NC}"

# 清除缓存 (重启应用)
echo -e "\n${YELLOW}[Cache] 重启应用清除缓存...${NC}"
fly apps restart $FLY_APP --yes 2>/dev/null || echo "跳过重启 (需要 fly CLI)"
sleep 10

# Stage 4.8 验证: 推荐服务完整验证
echo -e "\n${YELLOW}[Stage 4.8] 验证推荐服务...${NC}"
TABS=$(curl -s "$STAGING_API/recommendation/discover/tabs")
echo "发现 $(echo $TABS | jq 'length') 个分类"

FAILED=0
for row in $(echo $TABS | jq -r '.[] | @base64'); do
    _jq() { echo ${row} | base64 -d | jq -r ${1}; }
    NAME=$(_jq '.name')
    CAT_ID=$(_jq '.categoryId')

    if [ "$CAT_ID" != "null" ]; then
        COUNT=$(curl -s "$STAGING_API/recommendation/discover/books?categoryId=$CAT_ID" | jq '.total')
        if [ "$COUNT" -gt 0 ]; then
            echo -e "  ${GREEN}✓${NC} $NAME: $COUNT 本书"
        else
            echo -e "  ${RED}✗${NC} $NAME: 0 本书"
            FAILED=$((FAILED + 1))
        fi
    fi
done

# 结果汇总
echo -e "\n================================================"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}部署成功! 所有分类验证通过${NC}"
else
    echo -e "${RED}警告: $FAILED 个分类无书籍数据${NC}"
fi
echo "================================================"
```

### 11.3 使用方法

```bash
# 1. SSH 到 Droplet
ssh root@mcloud88.com

# 2. 进入项目目录
cd ~/readmigo

# 3. 设置环境变量
export DATABASE_URL='postgresql://user:pass@host/staging_db'

# 4. 执行一键部署
bash scripts/staging-deploy.sh

# 或者使用 npm 脚本
npm run deploy:staging
```

### 11.4 添加到 package.json

```json
{
  "scripts": {
    "deploy:staging": "bash scripts/staging-deploy.sh",
    "deploy:staging:dry-run": "bash scripts/staging-deploy.sh --dry-run"
  }
}
```

---

## 十二、问题修复记录

### 12.1 本地化数据修复 (2026-01-03)

#### 问题描述

iOS 客户端部分内容未正确本地化：
1. 书籍分类标签（genres）显示英文，如 "Fiction"、"Poetry" 而非 "小说"、"诗歌"
2. 部分书籍未关联作者，导致作者名无法本地化
3. 部分作者缺少中文翻译

#### 根本原因

| 问题 | 原因 |
|------|------|
| Genre 未本地化 | `translations` 表中缺少 `entityType='genre'` 的翻译记录 |
| 书籍无作者名 | `books.authorId` 为 NULL，未关联到 `authors` 表 |
| 作者无翻译 | `translations` 表中缺少对应作者的中文翻译 |

#### 修复内容

**1. Genre 翻译 (85条)**

```
scripts/seed-genre-translations.ts
```

| 英文 | 中文 |
|------|------|
| Fiction | 小说 |
| Poetry | 诗歌 |
| Drama | 戏剧 |
| Philosophy | 哲学 |
| Classics | 经典文学 |
| Science Fiction | 科幻小说 |
| Historical Fiction | 历史小说 |
| ... | (共85条) |

**2. 书籍作者关联 (91本)**

将 91 本书籍的 `authorId` 关联到已存在的作者记录。

**3. 作者翻译 (24位)**

| 英文 | 中文 |
|------|------|
| William Shakespeare | 威廉·莎士比亚 |
| Charles Dickens | 查尔斯·狄更斯 |
| Jane Austen | 简·奥斯汀 |
| Leo Tolstoy | 列夫·托尔斯泰 |
| Victor Hugo | 维克多·雨果 |
| Fyodor Dostoevsky | 费奥多尔·陀思妥耶夫斯基 |
| Jules Verne | 儒勒·凡尔纳 |
| Mark Twain | 马克·吐温 |
| Oscar Wilde | 奥斯卡·王尔德 |
| Dante Alighieri | 但丁·阿利吉耶里 |
| ... | (共24位) |

**4. 新建作者 (4位)**

| 作者 | 中文 | 关联书籍 |
|------|------|----------|
| Karl Marx | 卡尔·马克思 | The Communist Manifesto |
| Adam Smith | 亚当·斯密 | An Inquiry into the Nature and Causes of the Wealth of Nations |
| H. G. Wells | H·G·威尔斯 | The Invisible Man |
| L. M. Montgomery | L·M·蒙哥马利 | Anne of Green Gables |

**5. 特殊书籍修复**

| 书籍 | 问题 | 修复 |
|------|------|------|
| Faust (浮士德) | authorId=NULL, 标题/描述未翻译 | 关联歌德, 更新翻译 |
| The Analects (论语) | authorId=NULL | 关联孔子 |
| Aesop's Fables (伊索寓言) | 作者翻译缺失 | 添加"伊索" |
| Sindbad the Sailor (辛巴达航海历险记) | author=Anonymous, authorId=NULL | 创建"佚名（一千零一夜）"并关联 |

#### 修复结果

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| Genre 翻译 | 0 | 85 |
| 书籍无作者ID | 103 | 9 |
| 作者无翻译 | 61 | 0 |
| 总书籍数 | 222 | 222 |

#### 相关脚本

| 脚本 | 用途 |
|------|------|
| `scripts/seed-genre-translations.ts` | 填充 genre 翻译数据 |

#### 验证方法

```bash
# 1. 检查 genre 翻译
SELECT * FROM translations WHERE entity_type = 'genre' AND locale = 'zh' LIMIT 10;

# 2. 检查书籍作者关联
SELECT COUNT(*) FROM books WHERE author_id IS NULL;

# 3. 重启后端清除缓存
ssh readmigo@mcloud88.com "pm2 restart readmigo-staging"

# 4. iOS 客户端验证
# - 打开发现 Tab
# - 查看书籍详情页的分类标签和作者名
```

---

### 2025-01-03: 书籍详情页作者名未本地化

#### 问题描述

iOS 客户端书籍详情页作者名显示英文，而非中文翻译。例如：
- 《大街》(Main Street) - 作者显示 "Sinclair Lewis" 而非 "辛克莱·刘易斯"
- 《美国的悲剧》- 作者显示 "Theodore Dreiser" 而非 "西奥多·德莱塞"
- 《鲁滨逊漂流记》- 作者显示 "Daniel Defoe" 而非 "丹尼尔·笛福"
- 《密探》(The Secret Agent) - 作者显示 "展开" (UI 文字泄漏)

#### 根本原因

| 端点 | 问题 |
|------|------|
| `/api/v1/recommendation/discover` | ✅ 已本地化 `authorRef`，但未更新 `book.author` 字段 |
| `/api/v1/books/:id` | ❌ 完全未本地化作者名 |

iOS 客户端读取 `book.author` 字段显示作者名，而后端只本地化了 `authorRef` 对象，未同步更新 `book.author` 字符串字段。

#### 修复内容

**1. Discover 端点修复**

文件: `apps/backend/src/modules/recommendation/recommendation.service.ts` (Lines 253-258)
文件: `apps/backend/src/modules/recommendation/services/discover-cache.service.ts` (Lines 284-289)

```typescript
// Update book.author field with localized author name for iOS client
if (localizedAuthors[i].name) {
  books[authorsToLocalize[i].index].book.author = localizedAuthors[i].name;
}
```

**2. 书籍详情端点修复**

文件: `apps/backend/src/modules/books/books.service.ts` (Lines 158-171, 222-235)

```typescript
// Localize author name if authorId exists
if (localizedCached.authorId && locale !== 'en') {
  const authorTranslation = await this.prisma.translation.findFirst({
    where: {
      entityType: 'author',
      entityId: localizedCached.authorId as string,
      fieldName: 'name',
      locale: locale.startsWith('zh') ? 'zh' : locale,
    },
  });
  if (authorTranslation) {
    localizedCached.author = authorTranslation.value;
  }
}
```

**3. 作者翻译补充 (94位)**

| 作者 (英文) | 中文翻译 |
|-------------|----------|
| Theodore Dreiser | 西奥多·德莱塞 |
| Sinclair Lewis | 辛克莱·刘易斯 |
| Daniel Defoe | 丹尼尔·笛福 |
| Joseph Conrad | 约瑟夫·康拉德 |
| Thomas Hardy | 托马斯·哈代 |
| Herman Melville | 赫尔曼·麦尔维尔 |
| Nathaniel Hawthorne | 纳撒尼尔·霍桑 |
| Edgar Allan Poe | 埃德加·爱伦·坡 |
| ... | (共94位作者) |

#### 修复结果

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 作者翻译数 | 24 | 94+ |
| book.author 本地化 | ❌ 不支持 | ✅ 支持 |
| 书籍详情页本地化 | ❌ | ✅ |

#### 验证方法

```bash
# 1. 验证 API 返回本地化作者名
curl -s -H 'Accept-Language: zh-Hans' \
  'https://staging-api.readmigo.app/api/v1/books/836d5b75-7b8e-4461-80b9-baa124c2cf93' | jq '.author'
# 预期输出: "辛克莱·刘易斯"

# 2. 刷新缓存
curl -X POST https://staging-api.readmigo.app/api/v1/recommendation/cache/refresh

# 3. iOS 客户端验证
# - 完全关闭 App 后重新打开
# - 进入书籍详情页查看作者名
```

# P006: V2.0 数据清洗执行记录

> 清洗非 SE 数据，重建 100% Standard Ebooks 内容库

---

## 执行概要

| 项目 | 值 |
|------|-----|
| 执行日期 | TBD |
| 执行人 | TBD |
| 目标 | 清洗所有非 SE 数据，重新导入 SE 书籍 |
| 状态 | ⏳ 待执行 |

---

## 一、执行前状态

### 1.1 数据库统计

| 表 | 记录数 | SE 来源 | 非 SE 来源 |
|----|--------|---------|-----------|
| Book | - | - | - |
| Chapter | - | - | - |
| Author | - | - | - |
| ReadingProgress | - | - | - |
| Highlight | - | - | - |
| Vocabulary | - | - | - |

### 1.2 R2 存储统计

| 目录 | 文件数 | 大小 |
|------|--------|------|
| epubs/ | - | - |
| covers/books/ | - | - |
| authors/ | - | - |

---

## 二、备份记录

### 2.1 数据库备份

| 备份项 | 时间 | 位置 | 状态 |
|--------|------|------|:----:|
| Neon Snapshot | - | - | ☐ |
| SQL Dump | - | - | ☐ |

### 2.2 R2 备份

| 备份项 | 时间 | 位置 | 状态 |
|--------|------|------|:----:|
| epubs/ 目录 | - | - | ☐ |
| covers/ 目录 | - | - | ☐ |

### 2.3 用户数据导出

| 数据类型 | 记录数 | 导出文件 | 状态 |
|----------|--------|----------|:----:|
| ReadingProgress | - | - | ☐ |
| Highlight | - | - | ☐ |
| Vocabulary | - | - | ☐ |

---

## 三、清洗执行

### 3.1 识别非 SE 书籍

```
执行查询：
SELECT id, title, source FROM Book WHERE source != 'standard-ebooks'

结果：
- 非 SE 书籍数量：-
- 书籍 ID 列表：-
```

### 3.2 数据库清洗

| 步骤 | SQL/操作 | 影响行数 | 执行时间 | 状态 |
|------|----------|----------|----------|:----:|
| 删除非 SE 章节 | DELETE FROM Chapter WHERE bookId IN (...) | - | - | ☐ |
| 删除非 SE 阅读进度 | DELETE FROM ReadingProgress WHERE bookId IN (...) | - | - | ☐ |
| 删除非 SE 高亮 | DELETE FROM Highlight WHERE bookId IN (...) | - | - | ☐ |
| 删除非 SE 书籍 | DELETE FROM Book WHERE source != 'standard-ebooks' | - | - | ☐ |
| 清理孤立作者 | DELETE FROM Author WHERE id NOT IN (SELECT authorId FROM Book) | - | - | ☐ |

### 3.3 R2 清洗

| 步骤 | 操作 | 文件数 | 执行时间 | 状态 |
|------|------|--------|----------|:----:|
| 列出保留的 book-id | 从数据库获取 | - | - | ☐ |
| 删除非 SE EPUB | 对比并删除 epubs/ 中不在列表的文件 | - | - | ☐ |
| 删除非 SE 封面 | 对比并删除 covers/books/ 中不在列表的文件 | - | - | ☐ |

---

## 四、SE 书籍导入

### 4.1 导入配置

| 配置项 | 值 |
|--------|-----|
| 来源 | Standard Ebooks |
| 目标数量 | 1000+ 本 |
| 导入脚本 | SE Content Pipeline |
| 目标环境 | Production |

### 4.2 导入进度

| 阶段 | 开始时间 | 结束时间 | 处理数量 | 状态 |
|------|----------|----------|----------|:----:|
| 抓取 SE 书籍列表 | - | - | - | ☐ |
| 下载 EPUB 文件 | - | - | - | ☐ |
| 解析元数据 | - | - | - | ☐ |
| 写入数据库 | - | - | - | ☐ |
| 上传 R2 | - | - | - | ☐ |

### 4.3 导入结果

| 指标 | 数量 |
|------|------|
| 成功导入书籍 | - |
| 成功导入作者 | - |
| 成功导入章节 | - |
| 失败/跳过 | - |

---

## 五、验证检查

### 5.1 数据一致性

| 检查项 | 期望值 | 实际值 | 状态 |
|--------|--------|--------|:----:|
| Book 表记录数 | ≥1000 | - | ☐ |
| 每本书有封面 | 100% | - | ☐ |
| 每本书有章节 | 100% | - | ☐ |
| R2 EPUB 数量 = Book 数量 | 一致 | - | ☐ |
| R2 封面数量 = Book 数量 | 一致 | - | ☐ |

### 5.2 功能验证

| 检查项 | 结果 | 状态 |
|--------|------|:----:|
| API 书籍列表正常返回 | - | ☐ |
| API 书籍详情正常返回 | - | ☐ |
| API 章节内容正常返回 | - | ☐ |
| 客户端加载书籍正常 | - | ☐ |
| 客户端阅读器正常 | - | ☐ |

### 5.3 抽样验证

| 书籍 | 封面 | 章节数 | 内容渲染 | 状态 |
|------|:----:|--------|:--------:|:----:|
| Pride and Prejudice | ☐ | - | ☐ | ☐ |
| The Great Gatsby | ☐ | - | ☐ | ☐ |
| 1984 | ☐ | - | ☐ | ☐ |
| Jane Eyre | ☐ | - | ☐ | ☐ |
| Moby Dick | ☐ | - | ☐ | ☐ |

---

## 六、执行后状态

### 6.1 数据库统计

| 表 | 清洗前 | 清洗后 | 变化 |
|----|--------|--------|------|
| Book | - | - | - |
| Chapter | - | - | - |
| Author | - | - | - |

### 6.2 R2 存储统计

| 目录 | 清洗前 | 清洗后 | 变化 |
|------|--------|--------|------|
| epubs/ | - | - | - |
| covers/books/ | - | - | - |

### 6.3 数据源分布

| 来源 | 书籍数量 | 占比 |
|------|----------|------|
| Standard Ebooks | - | 100% |
| 其他 | 0 | 0% |

---

## 七、问题与解决

| 序号 | 问题描述 | 解决方案 | 状态 |
|------|----------|----------|:----:|
| 1 | - | - | ☐ |

---

## 八、后续行动

| 行动项 | 负责人 | 截止日期 | 状态 |
|--------|--------|----------|:----:|
| 更新 v2.0.0 manifest | - | - | ☐ |
| 通知用户数据迁移 | - | - | ☐ |
| 部署后端 2.0 | - | - | ☐ |
| iOS 2.0 提审 | - | - | ☐ |

---

## 九、相关文档

| 文档 | 描述 |
|------|------|
| [V2.0.0 Release Notes](../../08-releases/notes/v2.0.0.md) | 版本说明 |
| [V2 全栈发布计划](../../08-releases/roadmap/v2-fullstack-release-plan.md) | 发布计划 |
| [SE Content Pipeline](../../plans/2026-01-26-se-content-pipeline-design.md) | 导入设计 |

---

*文档创建日期: 2026-01-26*

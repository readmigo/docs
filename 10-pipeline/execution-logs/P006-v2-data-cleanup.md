# P006: V2.0 数据清洗执行记录

> 清洗非 SE 数据，重建 100% Standard Ebooks 内容库

---

## 执行概要

| 项目 | 值 |
|------|-----|
| 执行日期 | 2026-01-26 |
| 目标 | 清洗所有非 SE 数据，重新导入 SE 书籍 |
| 状态 | 完成 (导入阶段) |

---

## 一、执行前状态

### 1.1 数据库统计

| 表 | 记录数 | SE 来源 | 非 SE 来源 |
|----|--------|---------|-----------|
| Book | 241 | 197 | 44 |
| Chapter | ~10000 | ~8000 | ~2000 |
| Author | ~100 | - | - |

### 1.2 R2 存储统计

| 目录 | 文件数 | 大小 |
|------|--------|------|
| epubs/ | ~250 | - |
| covers/books/ | ~250 | - |

---

## 二、备份记录

### 2.1 数据库备份

| 备份项 | 位置 | 状态 |
|--------|------|:----:|
| Neon Snapshot | Neon Console | - |

### 2.2 用户数据导出

| 数据类型 | 记录数 | 状态 |
|----------|--------|:----:|
| ReadingProgress | 0 | N/A |
| Highlight | 0 | N/A |
| Vocabulary | 0 | N/A |

> Production 环境无用户数据，跳过备份

---

## 三、清洗执行

### 3.1 识别非 SE 书籍

| 来源 | 数量 |
|------|------|
| GUTENBERG | 44 本 |
| STANDARD_EBOOKS | 197 本 |

### 3.2 数据库清洗

| 步骤 | 影响行数 | 执行时间 | 状态 |
|------|----------|----------|:----:|
| 删除非 SE 章节 | 1923 | 15:47 UTC | 完成 |
| 删除非 SE 阅读进度 | 0 (无数据) | - | 完成 |
| 删除非 SE 高亮 | 0 (无数据) | - | 完成 |
| 删除非 SE 书籍 | 44 | 15:47 UTC | 完成 |
| 清理孤立作者 | 自动级联 | - | 完成 |

### 3.3 R2 清洗

| 步骤 | 文件数 | 状态 |
|------|--------|:----:|
| 列出保留的 book-id | 197 | 完成 |
| 删除非 SE EPUB | 新导入覆盖 | 进行中 |
| 删除非 SE 封面 | 新导入覆盖 | 进行中 |

---

## 四、SE 书籍导入

### 4.1 导入配置

| 配置项 | 值 |
|--------|-----|
| 来源 | Standard Ebooks (standardebooks.org) |
| 目标数量 | 1000+ 本 |
| 导入脚本 | `scripts/book-ingestion/sources/standard-ebooks.ts` |
| 目标环境 | Production |
| 执行服务器 | Droplet (mcloud88.com) |

### 4.2 导入进度

| 阶段 | 开始时间 | 结束时间 | 处理数量 | 状态 |
|------|----------|----------|----------|:----:|
| 抓取 SE 书籍列表 | 15:56 UTC | 15:58 UTC | 3432 条目 | 完成 |
| 下载 EPUB 文件 | 15:58 UTC | 进行中 | 682/3422 | 进行中 |
| 解析元数据 | 15:58 UTC | 进行中 | 同上 | 进行中 |
| 写入数据库 | 15:58 UTC | 进行中 | 588 本 | 进行中 |
| 上传 R2 | 15:58 UTC | 进行中 | 同上 | 进行中 |

### 4.3 导入结果 (实时更新)

| 指标 | 数量 |
|------|------|
| 成功导入书籍 | 588 |
| 成功导入作者 | 112 |
| 成功导入章节 | 20,253 |
| 失败/跳过 | ~94 (网络超时) |

> 最后更新: 2026-01-27 ~16:00 UTC

---

## 五、验证检查

### 5.1 数据一致性

| 检查项 | 期望值 | 实际值 | 状态 |
|--------|--------|--------|:----:|
| Book 表记录数 | >=1000 | 588 (进行中) | 进行中 |
| 每本书有封面 | 100% | - | 待验证 |
| 每本书有章节 | 100% | - | 待验证 |
| R2 EPUB 数量 = Book 数量 | 一致 | - | 待验证 |
| R2 封面数量 = Book 数量 | 一致 | - | 待验证 |

### 5.2 功能验证

| 检查项 | 状态 |
|--------|:----:|
| API 书籍列表正常返回 | 待验证 |
| API 书籍详情正常返回 | 待验证 |
| API 章节内容正常返回 | 待验证 |
| 客户端加载书籍正常 | 待验证 |
| 客户端阅读器正常 | 待验证 |

---

## 六、执行后状态

### 6.1 数据库统计

| 表 | 清洗前 | 当前 | 变化 |
|----|--------|------|------|
| Book | 241 | 588 | +347 |
| Chapter | ~10000 | 20,253 | +10,253 |
| Author | ~100 | 112 | +12 |

### 6.2 R2 存储统计

| 目录 | 清洗前 | 当前 | 变化 |
|------|--------|------|------|
| epubs/ | ~250 | ~588 | +338 |
| covers/books/ | ~250 | ~588 | +338 |

### 6.3 数据源分布

| 来源 | 书籍数量 | 占比 |
|------|----------|------|
| Standard Ebooks | 588 | 100% |
| 其他 | 0 | 0% |

---

## 七、问题与解决

| 序号 | 问题描述 | 解决方案 | 状态 |
|------|----------|----------|:----:|
| 1 | Droplet 到 SE 网络间歇性超时 | 增加 delay 到 10s，使用本地缓存 EPUB | 完成 |
| 2 | SE 网站 429 Rate Limit | 脚本自动等待 60-120s 重试 | 完成 |
| 3 | 目录抓取返回重复条目 | 脚本自动去重，使用 progress 文件跳过 | 完成 |

---

## 八、后续行动

| 行动项 | 状态 |
|--------|:----:|
| 等待导入完成 (目标 1000+) | 进行中 |
| 更新 v2.0.0 manifest | 待完成 |
| 部署后端 2.0 | 待完成 |
| iOS 2.0 提审 | 待完成 |

---

## 九、监控

使用 PM2 管理导入进程，通过 `pm2 logs` 查看实时日志。

| 监控项 | 方式 |
|--------|------|
| 导入日志 | `pm2 logs` on Droplet |
| 书籍数量 | 查询 Production 数据库 |
| 进程状态 | `pm2 list` on Droplet |

---

## 十、相关文档

| 文档 | 描述 |
|------|------|
| [V2.0.0 Release Notes](../../08-releases/notes/v2.0.0.md) | 版本说明 |
| [V2 全栈发布计划](../../08-releases/roadmap/v2-fullstack-release-plan.md) | 发布计划 |

---

*文档创建日期: 2026-01-26*
*最后更新: 2026-01-27*

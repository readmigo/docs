# 基础设施改造计划

> 环境缩减 + 全球化评估 + AI 服务废弃

---

## 一、改造概述

| 改造项 | 当前状态 | 目标状态 |
|--------|----------|----------|
| 环境数量 | 4 (Local/Debug/Staging/Production) | 2 (Local/Production) |
| AI 服务 | 深度集成 (查词/翻译/问答/推荐) | 100% 废弃 |
| 基础设施 | 单区域 (Tokyo) | 待评估全球化方案 |

---

## 二、环境缩减

### 2.1 当前 4 环境架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          当前环境架构 (4 环境)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Local     │  │  Debugging  │  │   Staging   │  │ Production  │    │
│  │             │  │             │  │             │  │             │    │
│  │ localhost   │  │ Fly.io nrt  │  │ Fly.io nrt  │  │ Fly.io nrt  │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │                │            │
│         ▼                ▼                ▼                ▼            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 本地 PG     │  │ Neon Debug  │  │Neon Staging │  │ Neon Prod   │    │
│  │ 本地 Redis  │  │ Upstash     │  │ Upstash     │  │ Upstash     │    │
│  │ R2 debug    │  │ R2 debug    │  │ R2 staging  │  │ R2 prod     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│                                                                         │
│  问题: Debug/Staging 使用率低，维护成本高，资源浪费                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 目标 2 环境架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          目标环境架构 (2 环境)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│        ┌─────────────────────┐          ┌─────────────────────┐        │
│        │       Local         │          │     Production      │        │
│        │                     │          │                     │        │
│        │   开发者本地环境     │          │    生产环境          │        │
│        │   localhost:3000    │          │   api.readmigo.app  │        │
│        └──────────┬──────────┘          └──────────┬──────────┘        │
│                   │                                │                    │
│                   ▼                                ▼                    │
│        ┌─────────────────────┐          ┌─────────────────────┐        │
│        │  本地 PostgreSQL    │          │  Neon PostgreSQL    │        │
│        │  本地 Redis         │          │  Upstash Redis      │        │
│        │  R2 readmigo-dev    │          │  R2 readmigo-prod   │        │
│        └─────────────────────┘          └─────────────────────┘        │
│                                                                         │
│  优势: 简化运维、降低成本、减少配置错误                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 资源清理清单

| 资源类型 | 资源名称 | 操作 | 优先级 |
|----------|----------|------|--------|
| Fly.io App | readmigo-debug | 删除 | P1 |
| Fly.io App | readmigo-staging | 删除 | P1 |
| Neon 数据库 | ep-debug-xxx | 删除 | P2 |
| Neon 数据库 | ep-shy-cloud-a1depd3i (staging) | 删除 | P2 |
| Upstash Redis | fly-readmigo-debug-redis | 删除 | P2 |
| Upstash Redis | fly-readmigo-staging-redis | 删除 | P2 |
| R2 Bucket | readmigo-debug | 清空后删除 | P3 |
| R2 Bucket | readmigo-staging | 清空后删除 | P3 |

### 2.4 配置文件清理

| 文件 | 操作 |
|------|------|
| fly.debugging.toml | 删除 |
| fly.staging.toml | 删除 |
| .env.debugging | 归档后删除 |
| .env.staging | 归档后删除 |

---

## 三、基础设施全球化评估

### 3.1 当前架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          当前部署架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌─────────────────┐                             │
│                         │   Cloudflare    │                             │
│                         │   (CDN/DNS)     │                             │
│                         └────────┬────────┘                             │
│                                  │                                      │
│                                  ▼                                      │
│                         ┌─────────────────┐                             │
│                         │   Fly.io API    │                             │
│                         │   Tokyo (nrt)   │                             │
│                         │   512MB × 1+    │                             │
│                         └────────┬────────┘                             │
│                                  │                                      │
│                    ┌─────────────┼─────────────┐                        │
│                    ▼             ▼             ▼                        │
│           ┌──────────────┐ ┌──────────┐ ┌──────────────┐               │
│           │    Neon      │ │ Upstash  │ │ Cloudflare   │               │
│           │  PostgreSQL  │ │  Redis   │ │     R2       │               │
│           │  Singapore   │ │  Global  │ │   Global     │               │
│           └──────────────┘ └──────────┘ └──────────────┘               │
│                                                                         │
│  延迟分析:                                                              │
│  • 亚洲用户 → API (东京): 20-50ms ✓                                    │
│  • 欧美用户 → API (东京): 150-250ms ✗                                  │
│  • API → DB (东京→新加坡): 50-80ms                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 全球化方案对比

| 方案 | 架构 | 延迟 | 成本 | 复杂度 | 推荐度 |
|------|------|------|------|--------|--------|
| A. 维持现状 | Fly.io Tokyo 单点 | 欧美高 | $ | ★☆☆ | MVP 阶段 |
| B. Fly.io 多区域 | Tokyo + US + EU | 全球低 | $$$ | ★★★ | 用户增长后 |
| C. Cloudflare Workers | 边缘计算 | 极低 | $$ | ★★★★ | 读多写少 |
| D. 混合方案 | Workers + Fly.io | 极低 | $$ | ★★★★★ | 最终形态 |

### 3.3 推荐路径

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          全球化演进路径                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段 1: 当前 (MVP)                                                     │
│  ════════════════════                                                   │
│  • 维持 Fly.io Tokyo 单点                                               │
│  • 重点服务亚洲用户                                                      │
│  • 成本最低                                                             │
│                                                                         │
│           │                                                             │
│           ▼                                                             │
│                                                                         │
│  阶段 2: 用户增长后                                                      │
│  ════════════════════                                                   │
│  • 添加 Fly.io US-West 节点                                             │
│  • 数据库读副本                                                          │
│  • 静态资源 CDN 优化                                                     │
│                                                                         │
│           │                                                             │
│           ▼                                                             │
│                                                                         │
│  阶段 3: 规模化                                                          │
│  ════════════════════                                                   │
│  • Cloudflare Workers 边缘 API                                          │
│  • 数据库多区域同步                                                      │
│  • 完整的全球化架构                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、AI 服务 100% 废弃

### 4.1 当前 AI 服务清单

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          当前 AI 服务架构                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        阅读场景 AI                               │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
│  │  │  AI 查词  │  │  AI 翻译  │  │  AI 解释  │  │  AI 总结  │    │   │
│  │  │ DeepSeek  │  │ GPT-4o-m  │  │ GPT-4o-m  │  │ GPT-4o    │    │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        对话场景 AI                               │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                   │   │
│  │  │  书籍问答  │  │  角色对话  │  │  文学分析  │                   │   │
│  │  │ GPT-4o    │  │ Claude    │  │ GPT-4o    │                   │   │
│  │  └───────────┘  └───────────┘  └───────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        推荐场景 AI                               │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                   │   │
│  │  │  书籍推荐  │  │  词汇推荐  │  │  阅读计划  │                   │   │
│  │  │ Embedding │  │ ML Model  │  │ GPT-4o-m  │                   │   │
│  │  └───────────┘  └───────────┘  └───────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  所有以上服务将被 100% 废弃                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 废弃后替代方案

| 原 AI 功能 | 废弃后方案 | 用户体验变化 |
|------------|-----------|-------------|
| AI 查词 (上下文释义) | 本地词典 ECDICT (340万词条) | 无上下文，仅标准释义 |
| AI 翻译 (实时翻译) | 预处理双语数据 | 仅支持已处理书籍 |
| AI 解释 | 移除功能 | 功能不可用 |
| AI 问答 | 移除功能 | 功能不可用 |
| AI 总结 | 移除功能 | 功能不可用 |
| AI 角色对话 | 移除功能 | 功能不可用 |
| AI 书籍推荐 | 基于规则的推荐 | 推荐精准度下降 |
| AI 阅读计划 | 移除功能 | 功能不可用 |

### 4.3 废弃后产品形态

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        废弃 AI 后的产品形态                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  核心功能 (保留)                                                        │
│  ════════════════                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
│  │  │ EPUB阅读器│  │ 双语对照  │  │ 本地词典  │  │ 词汇本    │    │   │
│  │  │ ReadiumKit│  │ 预处理数据│  │ ECDICT    │  │ CoreData  │    │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  辅助功能 (保留)                                                        │
│  ════════════════                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │   │
│  │  │ 阅读统计  │  │ 进度同步  │  │ 书架管理  │  │ 热门推荐  │    │   │
│  │  │ 无需AI    │  │ 无需AI    │  │ 无需AI    │  │ 规则算法  │    │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  移除功能                                                               │
│  ════════════════                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ✗ AI 查词 (上下文)    ✗ AI 问答         ✗ AI 角色对话         │   │
│  │  ✗ AI 实时翻译         ✗ AI 总结         ✗ AI 阅读计划         │   │
│  │  ✗ AI 文学分析         ✗ AI 智能推荐                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 代码/配置清理清单

| 类别 | 清理项 | 位置 |
|------|--------|------|
| API Keys | OPENAI_API_KEY | Fly.io Secrets |
| API Keys | DEEPSEEK_API_KEY | Fly.io Secrets |
| API Keys | ANTHROPIC_API_KEY | Fly.io Secrets |
| 后端代码 | AI Service 模块 | apps/backend/src/ai/ |
| 后端代码 | AI 相关 API endpoints | apps/backend/src/api/ |
| 后端代码 | Prompt 模板 | apps/backend/prompts/ |
| 客户端代码 | AI 功能 UI | iOS/Android/Web |
| 客户端代码 | AI 配额管理 | 客户端设置页 |
| 数据库 | ai_usage_logs 表 | PostgreSQL |
| 数据库 | ai_cache 表 | PostgreSQL |
| Redis | AI 响应缓存 | Upstash |

### 4.5 成本节省

| 成本项 | 当前月度成本 | 废弃后成本 | 节省 |
|--------|-------------|-----------|------|
| OpenAI API | ~$50-200 | $0 | 100% |
| DeepSeek API | ~$20-50 | $0 | 100% |
| Anthropic API | ~$20-50 | $0 | 100% |
| AI 缓存存储 | ~$5 | $0 | 100% |
| **总计** | **~$95-305** | **$0** | **100%** |

---

## 五、执行计划

### 5.1 执行阶段

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          执行阶段规划                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase 1: 准备 (1周)                                                    │
│  ═══════════════════                                                    │
│  □ 备份所有环境配置和数据                                                │
│  □ 文档更新（本文档）                                                    │
│  □ 通知相关人员                                                         │
│                                                                         │
│  Phase 2: AI 服务废弃 (2周)                                             │
│  ═══════════════════════════                                            │
│  □ 后端移除 AI 相关 endpoints                                           │
│  □ 客户端移除 AI 功能 UI                                                │
│  □ 删除 AI API Keys                                                     │
│  □ 清理 AI 相关数据表                                                   │
│                                                                         │
│  Phase 3: 环境缩减 (1周)                                                │
│  ═══════════════════════                                                │
│  □ 停止 Debug/Staging Fly.io Apps                                       │
│  □ 删除 Debug/Staging Neon 数据库                                       │
│  □ 删除 Debug/Staging Upstash Redis                                     │
│  □ 清空并删除 Debug/Staging R2 Buckets                                  │
│  □ 删除配置文件                                                         │
│                                                                         │
│  Phase 4: 验证 (1周)                                                    │
│  ═══════════════════                                                    │
│  □ 全面测试 Production 环境                                             │
│  □ 监控错误率和性能                                                      │
│  □ 确认成本下降                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 用户依赖 AI 功能 | 用户流失 | 提前公告、渐进式移除 |
| 数据丢失 | 无法恢复 | 完整备份后再删除 |
| 配置遗漏 | 服务异常 | Checklist 逐项确认 |
| 成本计算错误 | 预算超支 | 先停止再删除，观察账单 |

---

## 六、相关文档

| 文档 | 说明 |
|------|------|
| [environments.md](../05-operations/deployment/environments.md) | 环境配置（待更新） |
| [ai-services-architecture.md](../07-modules/ai/ai-services-architecture.md) | AI 架构（标记废弃） |
| [ai-services-migration.md](../09-reference/deprecated/ai-services-migration.md) | AI 废弃迁移指南 |

---

*创建日期: 2026-01-26*

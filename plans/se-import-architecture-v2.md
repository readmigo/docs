# SE 内容导入架构 V2

> 职责清晰分离的新架构设计

---

## 一、架构概览

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              架构总览                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Droplet (PM2)                      R2 Storage                                │
│   ┌──────────────┐                   ┌──────────────┐                          │
│   │  SE Download │ ──── EPUB ────▶   │ raw-epubs/   │                          │
│   │  - 断点续传   │                   │ {slug}.epub  │                          │
│   │  - 文件去重   │                   └──────┬───────┘                          │
│   └──────────────┘                          │                                  │
│                                              │                                  │
│   ──────────────────────────────────────────────────────────────────────────── │
│                                              │                                  │
│   Dashboard Pipeline                         ▼                                  │
│   ┌────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                          │   │
│   │  Node 1         Node 2           Node 3              Node 4             │   │
│   │  ┌─────────┐   ┌─────────┐      ┌──────────────┐    ┌──────────────┐   │   │
│   │  │ 增量计算 │──▶│ 解析修正 │────▶ │ 数据填充      │───▶│ Discover Tab │   │   │
│   │  │         │   │         │      │              │    │              │   │   │
│   │  │ R2 raw  │   │ EPUB    │      │ ✓ DB: Book   │    │ ✓ BookList   │   │   │
│   │  │   vs    │   │ 解析    │      │ ✓ DB: Author │    │ ✓ Category   │   │   │
│   │  │ DB Book │   │ CSS保留 │      │ ✓ DB: Chapter│    │ ✓ Featured   │   │   │
│   │  │         │   │ HTML修正│      │ ✓ R2: covers │    │ ✓ 自动分类   │   │   │
│   │  └─────────┘   └─────────┘      └──────────────┘    └──────────────┘   │   │
│   │                                                                          │   │
│   └────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、职责划分

### 2.1 Droplet 下载器

| 项目 | 说明 |
|------|------|
| 职责 | 仅负责从 SE 网站下载 EPUB 源文件 |
| 运行方式 | PM2 管理，支持自动重启 |
| 输出位置 | R2 `raw-epubs/` 目录 |

**核心功能：**

| 功能 | 实现方式 |
|------|----------|
| 断点续传 | 本地 `progress.json` 记录已处理位置 |
| 文件去重 | 上传前检查 R2 是否已存在 |
| 错误重试 | 单书失败记录日志，继续下一本 |
| 进度报告 | 定期输出处理进度到日志 |

**数据流：**

```
SE 网站
   │
   ▼ HTTP 下载
Droplet 本地缓存 (/tmp/)
   │
   ▼ wrangler r2 put
R2 raw-epubs/{slug}.epub
```

**不负责：**
- ❌ 数据库操作
- ❌ 封面提取
- ❌ 章节解析
- ❌ 内容转换

---

### 2.2 Pipeline 处理器

运行于 Dashboard 后端，手动触发执行。

#### Node 1: 增量计算

| 项目 | 说明 |
|------|------|
| 输入 | R2 `raw-epubs/` 目录文件列表 |
| 输出 | 待处理 EPUB slug 列表 |
| 逻辑 | R2 存在但 DB 不存在 = 增量 |

```
┌─────────────────────────────────────────────────────────────┐
│                      增量计算逻辑                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   R2 raw-epubs/                    DB Book 表                │
│   ┌─────────────────┐              ┌─────────────────┐       │
│   │ pride-and-prej  │              │ pride-and-prej  │       │
│   │ great-gatsby    │              │ great-gatsby    │       │
│   │ moby-dick       │  ──比较──▶   │                 │       │
│   │ 1984            │              │                 │       │
│   └─────────────────┘              └─────────────────┘       │
│                                                               │
│   结果: moby-dick, 1984 为增量                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

#### Node 2: 解析修正

| 项目 | 说明 |
|------|------|
| 输入 | 增量 EPUB 文件 (从 R2 下载) |
| 输出 | 解析后的结构化数据 |

**处理内容：**

| 步骤 | 说明 |
|------|------|
| 元数据提取 | title, author, description, language |
| 封面提取 | 从 EPUB 中提取封面图片 |
| 章节解析 | 按 spine 顺序提取各章节 |
| HTML 清理 | 移除无效标签，修正结构 |
| CSS 保留 | 保留原始样式 (V2 内容) |

**输出结构：**

```
{
  metadata: {
    slug: "moby-dick",
    title: "Moby Dick",
    author: { name: "Herman Melville", ... },
    description: "...",
    language: "en",
    wordCount: 215000,
    readingTime: 720
  },
  cover: {
    data: Buffer,
    mimeType: "image/jpeg"
  },
  chapters: [
    {
      order: 1,
      title: "Chapter 1: Loomings",
      href: "chapter-1.xhtml",
      htmlContent: "<html>...",      // V2: CSS 保留版
      wordCount: 2500
    },
    ...
  ]
}
```

> **注**: 仅生成 V2 内容 (CSS 保留版)

#### Node 3: 数据填充

| 项目 | 说明 |
|------|------|
| 输入 | Node 2 输出的结构化数据 |
| 输出 | DB 记录 + R2 文件 |

**写入目标：**

| 目标 | 内容 |
|------|------|
| DB: Author | 作者信息 (upsert) |
| DB: Book | 书籍元数据 |
| DB: Chapter | 章节记录 (含 contentUrl, contentV2Url) |
| R2: covers/ | 封面图片 |
| R2: thumbnails/ | 缩略图 (可选) |
| R2: chapters/ | 章节 HTML 内容 |

**R2 目录结构：**

```
readmigo-prod/
├── raw-epubs/              # Droplet 写入
│   ├── pride-and-prejudice.epub
│   ├── moby-dick.epub
│   └── ...
├── epubs/                  # Node 3 写入 (原始 EPUB 副本)
│   └── {bookId}.epub
├── covers/
│   └── books/
│       └── {bookId}.jpg
└── chapters/
    └── {bookId}/
        └── {chapterId}.html      # V2 内容 (CSS 保留)
```

> **注**: 不生成缩略图，不生成 V1 内容

#### Node 4: Discover Tab

| 项目 | 说明 |
|------|------|
| 输入 | Node 3 新导入的书籍列表 |
| 输出 | 更新后的 Discover Tab 数据 |

**处理内容：**

| 步骤 | 说明 |
|------|------|
| 分类关联 | 根据 Genre/Subject 关联到 Category |
| 书单更新 | 将新书添加到对应 BookList |
| Featured 推荐 | 高质量书籍加入 AI_FEATURED 书单 |
| Tab 刷新 | 更新 DiscoverTab 的展示内容 |

**书单自动分类规则：**

```
┌─────────────────────────────────────────────────────────────┐
│                   自动分类逻辑                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   新导入书籍                     目标书单                     │
│   ┌─────────────────┐            ┌─────────────────┐         │
│   │ Genre: Fiction  │ ────────▶  │ "经典小说" 书单  │         │
│   │ Genre: Drama    │ ────────▶  │ "戏剧" 书单      │         │
│   │ Genre: Poetry   │ ────────▶  │ "诗歌" 书单      │         │
│   │ Author: Famous  │ ────────▶  │ "大师作品" 书单  │         │
│   │ WordCount > 100k│ ────────▶  │ "长篇巨著" 书单  │         │
│   └─────────────────┘            └─────────────────┘         │
│                                                               │
│   规则引擎：基于 metadata 匹配预定义书单规则                  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**写入目标：**

| 目标 | 内容 |
|------|------|
| DB: BookListItem | 书籍与书单关联 |
| DB: Book.categoryId | 书籍分类 (可选) |
| DB: DiscoverTab | Tab 配置更新 (如需) |

**Featured 推荐逻辑：**

| 条件 | 权重 |
|------|------|
| 作者知名度 (Shakespeare, Dickens 等) | +3 |
| 书籍词汇数 > 50,000 | +1 |
| SE 封面质量 (有专业封面) | +1 |
| 已有评分/阅读数据 | +2 |
| 总分 ≥ 4 进入 Featured | - |

---

## 三、数据模型适配

### 3.1 Chapter 表字段使用

| 字段 | 用途 | Node 3 写入 |
|------|------|-------------|
| htmlContent | 直接存储 HTML | ❌ 不写入 (节省 DB 空间) |
| contentUrl | V1 章节内容 R2 URL | ❌ 不写入 (仅 V2) |
| contentV2Url | V2 章节内容 R2 URL | ✅ 写入 |
| hasV2Content | V2 内容标记 | ✅ 设为 true |

> **决策**:
> - htmlContent 不写入 DB，所有章节内容仅存储于 R2
> - 仅生成 V2 内容，不再生成 V1 内容

### 3.2 iOS 客户端兼容

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端内容获取逻辑                         │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   iOS 2.0+                         iOS 1.x                   │
│   ┌─────────────────┐              ┌─────────────────┐       │
│   │ X-App-Version   │              │ X-App-Version   │       │
│   │ >= 2.0.0        │              │ < 2.0.0         │       │
│   │                 │              │                 │       │
│   │ 使用 contentV2  │              │ Fallback 到     │       │
│   │ URL             │              │ contentV2Url    │       │
│   └─────────────────┘              └─────────────────┘       │
│                                                               │
│   books.service.ts 已支持 fallback 逻辑 ✅                    │
│   (contentUrl 为空时自动使用 contentV2Url)                    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

> **注**: 新导入书籍仅有 V2 内容，iOS 1.x 将 fallback 使用 V2 内容

---

## 四、执行流程

### 4.1 阶段一：Droplet 下载 (独立运行)

```bash
# PM2 启动下载脚本
pm2 start se-downloader.ts --name "se-download"

# 脚本持续运行，下载所有 SE EPUB 到 R2
# 进度记录在 progress.json，支持断点续传
```

**产出：** R2 `raw-epubs/` 中积累 EPUB 文件

### 4.2 阶段二：Pipeline 处理 (手动触发)

```
Dashboard 操作:
1. 进入 Pipeline 管理页面
2. 选择 "SE 增量导入" 任务
3. 选择目标环境 (Production / Staging)
4. 点击 "执行"
5. 监控进度

或 API 调用:
POST /api/pipeline/se-incremental
Body: { "environment": "production" }
```

**Dashboard 改造：**

| 改造前 | 改造后 |
|--------|--------|
| 需选择书单 | ❌ 移除书单选择 |
| 手动关联书籍到书单 | ❌ 移除 |
| - | ✅ 仅选择目标环境 |
| - | ✅ 书单由 Node 4 自动分配 |

**Dashboard 交互流程：**

```
┌─────────────────────────────────────────────────────────────┐
│                  SE 增量导入页面                             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   ┌─────────────────────────────────────────┐               │
│   │  目标环境:  [Production ▼]              │               │
│   └─────────────────────────────────────────┘               │
│                                                               │
│   ┌─────────────────────────────────────────┐               │
│   │           [ 开始导入 ]                   │               │
│   └─────────────────────────────────────────┘               │
│                                                               │
│   点击 "开始导入" 后:                                        │
│   → 自动触发完整 Pipeline (Node 1→2→3→4)                    │
│   → 显示实时进度                                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**执行顺序：**

```
Node 1 (增量计算)
   │
   │ 输出增量列表:
   │ ["moby-dick", "1984", ...]
   ▼
Node 2 (解析修正)
   │
   │ 逐本处理，输出结构化数据
   ▼
Node 3 (数据填充)
   │
   │ 写入 DB + R2
   │ 返回新导入书籍 ID 列表
   ▼
Node 4 (Discover Tab)
   │
   │ 自动分类 + 书单关联
   ▼
完成
```

---

## 五、进度管理与去重

### 5.1 Droplet 层去重

| 检查点 | 方式 |
|--------|------|
| 下载前 | 检查 R2 `raw-epubs/{slug}.epub` 是否存在 |
| 进度记录 | `progress.json` 记录已处理 URL 位置 |

### 5.2 Pipeline 层去重

| 检查点 | 方式 |
|--------|------|
| Node 1 | R2 文件 vs DB Book.slug 比较 |
| 结果 | 仅返回未导入的增量列表 |

### 5.3 进度文件格式

**Droplet progress.json:**

```json
{
  "lastProcessedIndex": 726,
  "totalItems": 3422,
  "lastUpdated": "2026-01-27T10:00:00Z",
  "errors": [
    { "slug": "some-book", "error": "timeout", "retries": 3 }
  ]
}
```

**Pipeline 执行记录:** 使用现有 PipelineTask 表

---

## 六、实现计划

### 6.1 Droplet 下载器改造

| 任务 | 说明 |
|------|------|
| 简化职责 | 移除所有 DB 操作，仅保留下载+上传 R2 |
| 输出目录 | 改为 `raw-epubs/` |
| 文件命名 | 使用 slug (如 `moby-dick.epub`) |

### 6.2 Pipeline Node 实现

| Node | 实现文件 | 状态 |
|------|----------|------|
| Node 1 | `pipeline/nodes/incremental-calc.ts` | 新建 |
| Node 2 | `pipeline/nodes/epub-parse.ts` | 改造现有 |
| Node 3 | `pipeline/nodes/data-populate.ts` | 改造现有 |
| Node 4 | `pipeline/nodes/discover-tab.ts` | 新建 |

### 6.4 Dashboard 改造

| 改造项 | 说明 |
|--------|------|
| 移除书单选择 | SE 增量导入不再需要手动选择书单 |
| 新增环境选择 | 下拉选择 Production / Staging |
| 简化 UI | 仅保留：环境选择 + 执行按钮 + 进度监控 |

### 6.3 关键改造点

**epub-parser.service.ts 改造：**

| 当前 | 改造后 |
|------|--------|
| 只生成 htmlContent (存 DB) | 生成 V2 内容 (CSS 保留) |
| 不上传 R2 | 上传章节内容到 R2 |
| 返回 Chapter[] | 返回带 contentV2Url 的 Chapter[] |

**books.service.ts 确认：**

| 检查项 | 状态 |
|--------|------|
| contentUrl 为空时 fallback 到 contentV2Url | ✅ 已支持 |

---

## 七、与现有系统关系

### 7.1 现有 Pipeline 保留

Dashboard 现有 Pipeline (8 阶段) 继续保留，用于：
- 单本书手动导入
- 书单关联
- 数据修正

### 7.2 新增 SE 增量 Pipeline

专门用于批量 SE 内容导入，与现有系统并行。

```
┌─────────────────────────────────────────────────────────────┐
│                    Pipeline 系统                             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│   现有 Pipeline                    新增 SE Pipeline          │
│   ┌─────────────────┐              ┌─────────────────┐       │
│   │ 8 阶段流程       │              │ 4 Node 流程     │       │
│   │ 单本导入        │              │ 批量增量导入    │       │
│   │ 书单管理        │              │ SE 专用         │       │
│   └─────────────────┘              │ + Discover 集成 │       │
│                                     └─────────────────┘       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、决策记录

| 序号 | 问题 | 决定 |
|------|------|------|
| 1 | htmlContent 字段是否还需要写入？ | ❌ 不写入 (节省 DB 空间) |
| 2 | 是否生成缩略图？ | A: 仅封面 (不生成缩略图) |
| 3 | Pipeline 触发方式 | B: 定时+手动 |
| 4 | V1 内容是否还需要？ | B: 仅 V2 (不再生成 V1 内容) |
| 5 | Node 4 书单分类规则如何配置？ | B: 基于 DB 数据动态计算 |
| 6 | Featured 推荐是否需要人工审核？ | A: 全自动 |

---

## 九、相关文档

| 文档 | 说明 |
|------|------|
| [P006 数据清洗记录](../10-pipeline/execution-logs/P006-v2-data-cleanup.md) | 当前执行状态 |
| [全球版权安全评估](../06-content/sources/standard-ebooks/global-copyright-safety.md) | 内容筛选标准 |
| [V2 全栈发布计划](../08-releases/roadmap/v2-fullstack-release-plan.md) | 发布规划 |

---

*文档创建日期: 2026-01-27*
*最后更新: 2026-01-27 (新增 Node 4: Discover Tab)*

---

**请输入 1 或 2：**
- **1**: 确认方案，继续实现
- **2**: 驳回，需要修改
